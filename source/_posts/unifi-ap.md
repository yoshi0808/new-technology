---
title: UniFi Wi-Fiシステム
date: 2022-12-31T09:00:01+09:00
tags:
- UniFi
categories:
- [Hardware]
- [Network]
---

{% asset_img title.png 1024 alt %}
<p class="onepoint">この記事で実現すること</p>

この記事ではホームユーザー向けにUniFi AP(Wi-Fiアクセスポイント）の設定ができるようになることを目的としています。
<!-- more -->

## 最近のWi-Fi事情

2022年9月にWi-Fiで6GHzも利用できるよう法律が変更されました（Wi-Fi6E）。国内のメーカーはこの6GHzとメッシュを謳い文句にWi-Fiルータの販売強化を図っているようです。しかしながら、端末側は今年に発売するiPhoneで6Eの対応が見送られた事であまり盛り上がってはいないようです。

Wi-Fiの難しいところはその住居の形や家の周りの電波状態に大きく左右されてしまう点で、これがベストという構成を見出せません。私の例で言えば、凡庸な建売の木造2階建であり、無線APが1つだけでも、それなりに無難にWi-Fiが使えるという環境です。

最近販売され始めた無線ルーターは、メッシュ対応のものが多く出てきました。メッシュは複数台のAPと無線でデータをやり取りできる機能です。無線の中継機は常に親機に集約されていましたが、メッシュは複数台のAPと相互に接続します。一般的には中継専用のSSIDを用いお互いにデータを中継します。

最近のメッシュWi-Fiルーターでは高速ローミング（802.11k、802.11r、802.11v）に対応している製品も出てきており、端末を持ちながら移動した場合に、アクセスポイント（AP）間を高速ローミングすることで切断時間を短くし、近くのAPに接続できます。また、それぞれのAPがメッシュ（無線）ではなく、有線接続して互いの情報を交換できる**イーサネットバックホール（有線バックホール）**という機能に対応している製品を複数の部屋に設置することでずいぶん快適になるでしょう。

なお、6EはDFSの影響を受けないチャンネルなので、自宅の間取りで6GHzが効率よく使える環境下であれば利便性は増します。私は6GHzの無線APは保有していないので、どのくらい電波が届くものなのかは今後機会があれば評価してみたいと考えています。周波数が上がるにつれて障害物によって遠くに届きづらくなるとは考えられます。各部屋に有線がなく、イーサネットバックホールが使えないケースでは、AP同士を6Eの独立チャンネルで接続する事で中継機能が改善することが期待されます（これまでは親機と中継機が同一のチャンネルを使うことで効率が大幅に落ちるケースがありました）。

また、端末側の6E対応状況が進捗するまではしばらくはWi-Fi6（5GHz）のままというのが現状でしょうか。

## UniFi APのスペック

日本国内で販売されているUniFi APはルーター機能を持たず、アクセスポイントに特化したハードウェアです。今のところ日本国内で販売されている機器にはメッシュ機能はなく、複数のAPは有線接続が前提となっており、UniFiネットワークアプリケーションまたはUniFiコンソールを介して情報連携が行われます。

| 機種                 | U6 Pro            | U6 Lite           |
| -------------------- | ----------------- | ----------------- |
| 有線                 | GbE RJ45ポート x1 | GbE RJ45ポート x1 |
| 給電方法             | PoE               | PoE               |
| 最大消費電力         | 13W               | 13.5W             |
| 最大送信パワー2.4GHz | 22dBm             | 23dBm             |
| 最大送信パワー5GHz   | 26dBm             | 23dBm             |
| MIMO 2.4GHz          | 2x2               | 2x2               |
| MIMO 5GHz            | 4x4               | 2x2               |

Wi-FiのスペックとしてはU6 Proで日本国内のやや高性能モデルに相当するでしょうか。アンテナ数を見ても、国内のWi-Fi機器と比較して特段優れている項目はありません。U6 Liteも一般的なスペックです。

Ubiquitの日本のWebストアではU6 Extender Wi-Fi中継機という製品が発売されました。これは廊下などのコンセントに挿して使うタイプのもので、メッシュではなさそうです。UniFi製品は米国で使われている3ピンのコンセントですので日本のコンセントには直接挿せません。変換プラグを嚙ますのは美観を損ねる事になるのでこのまま日本で発売してしまったのはちょっと違和感があります。

## UniFi APの実速度

iPhone11を使ってAPに1mの距離まで近づけて、iperf3を実行した時の結果は以下の通りです。

> U6 Pro
 {% asset_img u6-pro3.png 360 alt %}

> U6 Lite
 {% asset_img u6-lite3.png 360 alt %}

参考までに、Aterm WX6000HPの場合は以下です。
> {% asset_img aterm.png 360 alt %}

U6 Proの個性として、iperf3の起動直後は少しスロースタートに見えます。省電力の最適化に重きを置いているのでしょうか。

また、私の自宅の1階において、macOSのWi-Fi Explorerで電波の強さを計測してみました。1階にはU6 ProとAterm、2階にはU6 Liteが配置されています。

{% asset_img wifi-explorer.png 1024 alt %}

電波の強さだけであればAtermのWX6000HPが素晴らしい結果を出しています。しかしiperf3の最高速度という観点についてはU6 Proの方が良いスコアです。

pingのレイテンシも見てみましょう。iPhoneからNASへのping応答速度です。iOSやmacOSはpingのレイテンシ数値が高く出てしまう傾向にあります。実は上記のiperf3を含めてL3スイッチ経由でルーティングしてNASのiperf3サーバーに接続しており、1ホップあります。

-  Aterm pingレイテンシ
 {% asset_img aterm4.png 360 alt %}

-  U6 Pro pingレイテンシ
 {% asset_img u6-pro4.png 360 alt %}

> PingPlotterによる計測
 <https://www.pingman.com>

U6 Proの方が電波の出力は低いものの、レイテンシは15msあたりで上限が整っています。一方、Atermは時々、20msを超えるスパイクが発生しています。U6 Proの速度が出る理由はレイテンシが低い事と想定されます。スマホやノートPCの一般的な操作では100Mbpsを超えたあたりから殆どその差については分からなくなってきますが、リモートワークのビデオ会議の安定性を考えるとレイテンシは意識したいところです。

UniFi APはWi-Fi設定が非常に詳細まで行えることがメリットであり、電波が届かないなどの対策としての購入用途には向いていません。

## UniFi APの設置

電源を取るのはPoEアダプタまたはPoEスイッチからというのが独特です。これによってLANケーブルのみでデータ送受信と送電が行え、美観を損ねる事なく、壁の上部にAPを配置し、障害物を避けた効率の良い電波の発信が行えます。Wi-Fiはハードウェアスペックも関係ありますが、こういった物理的な配置も重要です。

（U6 Liteを2階に設置）
{% asset_img u6-lite.png 640 alt %}

コアスイッチから2階のこの部屋までは光で通し、SFP+スイッチ（usw-Aggregation)から1GbEでAPに接続しています。このスイッチにはPoE機能はないため、別途PoEアダプタを使ってAPに給電しています。

{% asset_img poe.png 640 alt %}
PoEアダプタを電源に繋ぎ、LANをusw-AggregationにRJ45で接続し、POEをU6 LiteにRJ45で接続します。

（私の環境の場合）電波の弱い階段のエリアにまで電波を届かせるために出来るだけ障害物を避けるAPの配置の工夫をしました。階を移動した時にスムーズなローミングができ、ビデオ会議で相手の声がなるべく途切れない事を目的としています。
{% asset_img u6-lite2.png 640 alt %}

2階の各部屋に電波を届けつつ、立体的に見て、壁と2階の床を抜ける箇所を想定し、試行錯誤しながら配置を決めていきます。

## UniFi Wi-Fi設定

ここでは、UniFiコンソールやUniFiネットワークアプリケーションが既にセットアップされている事を前提に説明します。
UniFiネットワークアプリケーションを最初からセットアップされる方は以下の記事を参照してください。

- 「{% post_link ubiquiti-unifi %}」
- 「{% post_link ubuntu22-04lts %}」
- 「{% post_link unifi-network-application %}」
- 「{% post_link unifi-network-application2 %}」

ネットワークアプリケーションの{% label primary @SETTINGS %}から{% label primary @WiFi %}の画面を開くと以下の表示となります。

{% asset_img wifi1.png 800 alt %}

画面上部のWiFiについては、既存のSSID一覧が表示されます。画面下部の{% label primary @Global AP Settings %}では、複数台のAPに共通設定を指定します。

メインとなる5GHzの無線設定では、一般的には80MHzを指定します。日本の製品ではアンテナ数で上り2、下り2として2x2という表現がされている事が多いでしょうか。スマホなど多くは80MHzになります。高機能なWiFiクライアントをお持ちの場合は160MHzも設定可能です（U6 Liteは80MHzが上限です）。

{% label primary @Transmit Power %}は環境に応じて、Auto、High、Medium、Low、Custom（固定数値指定）と設定できます。

続いて、SSIDの設定です。

{% asset_img wifi2.png 800 alt %}

SSIDの名前、パスワード、ネットワーク、そのSSIDにどのAPを参加させるかを決めます。ここでは個人向けのWi-Fiとして一般的なWPA2パーソナルまたはWPA3パーソナルを前提としています。

続いて、マニュアル設定でSSIDの詳細を設定していきます。
{% asset_img wifi3.png 480 alt %}
{% asset_img wifi4.png 480 alt %}


| 項目名                    | 説明                                                                                                                                                                                                                                                         |
| ------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| WiFi Band                 | 2.4GHz/5GHzを選択します。両方を有効にもできます。                                                                                                                                                                                                            |
| WiFi Type                 | 通常はStandardです。カフェのように外部にWiFiを解放する場合はGuest Hotspotを選択します。                                                                                                                                                                      |
| Band Steering             | バンドステアリング。Bandで2.4GHz、5GHzを指定した場合に設定でき、電波状態によって自動で切り替わります。                                                                                                                                                       |
| Bandwidth Profile         | 帯域制限を指定します。                                                                                                                                                                                                                                       |
| Multicast Management      | 通常必要ありませんので説明は割愛します。                                                                                                                                                                                                                     |
| Client Device Isolation   | クライアントをお互いに接続できないようにします。Guest扱い。                                                                                                                                                                                                  |
| Proxy ARP                 | 混雑している環境ではWiFiデバイスの代わりにAPが代理応答します。                                                                                                                                                                                               |
| BSS Transition            | AP同士でクライアントの状況を共有します。デフォルト有効。                                                                                                                                                                                                     |
| UAPSD                     | 省電力に関するパラメータです。古いデバイスでは問題が出る場合があります。                                                                                                                                                                                     |
| Fast Roaming              | Fast Roamingに対応している端末であれば有効にすべきです。逆に言えば、Fast Roamingに対応した端末専用のSSIDにすべきです。                                                                                                                                       |
| 802.11 DTIM Period        | デフォルト有効。Autoを推奨。説明は割愛します。                                                                                                                                                                                                               |
| Minimum Data Rate Control | デフォルト有効。最低通信量を定め、それを下回る場合クライアントにAP切り替えを促すはずですが、私の環境ではあまり有効に機能しません。                                                                                                                           |
| Security Protocol         | WPA2、WPA3の指定をします。WPA Enterpriseを指定することでRADIUS認証（ユーザー認証）が可能です。子供が友達にWi-Fiパスワード共有することに対策したいというこだわりのある方などチャレンジされてはいかがでしょうか。QNAPのNASなどでRADIUSサーバを稼働させられます |
| PMF                       | 保護された管理フレーム。WPA3では必須。WPA2では任意にすることも可能。必須にすると古い端末は繋がらない可能性があリます。                                                                                                                                       |
| Group Rekey Interval      | 暗号化キーの交換を定期的に行います。デフォルトは3600秒（＝1時間）です。                                                                                                                                                                                      |
| Hide WiFi Name            | 使うメリットはありません。説明は割愛します。                                                                                                                                                                                                                 |
| MAC Address Filter        | MACアドレスのホワイトリスト、ブラックリストを指定します。                                                                                                                                                                                                    |
| RADIUS MAC Authentication | 説明は割愛します。                                                                                                                                                                                                                                           |

WiFi Schedulerは夜間など使わない時の時間を設定できます。私は夜間は弱い2.4GHzのみ利用し、日中使っている5GHzは止めています。

## AP単位の設定

AP本体の設定を変更します。主にはIPアドレス、無線のチャンネルを指定します。
{% asset_img u6-pro5-1.png 360 alt %}

APを2つ設置するならば、メインはDFSを受けないチャネル、サブは別のチャネルにするとお互い競合せずに安定した電波の受信ができます。

IPアドレスはDHCP、固定が選べます。
{% asset_img u6-pro5-2.png 360 alt %}

このAP自体が属するマネジメント用のVLANを指定します。上記のグローバル設定ではSSID毎にVLANを設定できるので、APに接続するスイッチは、マネジメントVLANを含む全てのVLAN IDを含めるようにトランクポートとして設定する必要があります。

設定の一例です。
{% asset_img network.drawio.png 1024 alt %}

マネジメントVLANはDefault（VLAN ID＝1）をネイティブVLAN（タグ無し）としています。自宅のPCやスマホなど一般端末はVLAN ID＝100、会社のPCやIoTなどのゲスト用端末はVLAN ID＝500とし、さらにClient Device IsolationをEnableにして互いの機器の通信を拒否します。スイッチ間のトランクポートは必ず通信するVLAN IDのタグを含めてあげる必要があります。

## APのファームウェア

UniFi APのファームウェアは現在、6E対応について過渡期のようです。6Eを使わないにしても最新のファームウェアは、ローミングの切り替わりが安定しないように見えます。個人的にはU6 Liteは6.0.21、U6 Proは6.0.19が安定しているように見えます。もしお使いの端末でローミングが安定しないようであれば過去のファームウェアを確認してみてください。過去のファームウェアを適用するには過去記事「{% post_link unifi-network-application2 %}」を参照してください。

## 通知機能

通知はUniFiコンソールまたはUniFiネットワークアプリケーションの機能ですが、APに関して通知機能は以下の通りです。

{% asset_img wifi5.png 800 alt %}

DFSを受信した時にアラートが受けられるのと、自宅付近に同じSSIDを持つAPを発見した場合通知してくれます。特に後者はセキュリティ上有用です。これは試験的にUniFi以外のAPを同じSSIDで起動して検知させています。

{% asset_img wifi6.png 360 alt %}

通知はメールとスマホアプリと2種類あり、選択できます。{% label primary @Hotspot Client Connection Change %}は、端末の接続/切断を検知したり、ローミングの切り替わり状況を通知してくれます。家族の自宅への出入りも把握できます。ただし、通知数が多くなるので、メール通知は避け、アプリ通知にした方が良さそうです。本来の趣旨は知らないMACアドレスからの接続があった時に検知するものです。

これらの機能はハイブリッドクラウド機能を持つUniFi製品の特徴ですが、これらが無償で利用できるというのは本当にありがたい存在です。

