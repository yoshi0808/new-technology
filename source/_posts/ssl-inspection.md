---
title: XG Firewall v18のSSLインスペクションについて
tags:
  - XG Firewall
categories:
  - Security
date: 2020-03-20 14:23:53
---

{% note success  %}

## この記事で実現する内容について

　XG Firewall v18で利用されているSSL/TLSインスペクションについて、PCやiPhone等（Windows/macOS/iOS）を防御する仕組み、および必要となる対応概要を学びます。

{% endnote %}
<!-- more -->

{% note primary no-icon %}

## SSLインスペクションとは

{% endnote %}

　XGで設定の難易度が高くなるのはこの部分です。上記までの基本ルールとは別に、SSLを解読して検査する設定を行う事になります。今日でもSSLという呼び方は定着していますが、TLS（Transport Layer Security）とも呼ばれます。XGの最も素晴らしい機能の1つがSSLを解読する安全装置です。この安全装置の事を、「IPS」（Intrusion Prevension System）と呼びます。そして、その解読方法として「SSLインスペクション」という方式が採用されています。
　このSSLインスペクションについては、解りやすい文献がありますので紹介します。セキュリティベンダーの（株）ラック社から提供されているドキュメントです。

>出典：株式会社ラック[【「常時SSL化」時代に向けたセキュリティ対策指南書】](https://www.lac.co.jp/library/pdf/ssl_guidebook.pdf)

　特にP13に記載されているSSLインペクションゾーンの仕事をしてくれるのがXGの役割です。

{% note primary no-icon %}

## XGが処理するSSLインスペクションのシーケンス

{% endnote %}

　実際にhttpsの通信を開始するシーケンスは以下の通りです。XGはクライアントとWebサーバーとの間に入り、SSLの解読を行います。クライアントはXGが暗号化したデータを解読する事になります。

{% mermaid sequenceDiagram %}

      participant cl as クライアント<br>（ブラウザ）
      participant xg as XG
      participant sv as Webサーバー

      cl ->>+ xg : 1.Webサーバーへの接続
      xg ->>+ sv : 2.Webサーバーへの接続
      sv -->>- xg : 3.サーバー証明書と<br>公開鍵を送付
      Note right of xg: 4.サーバー証明書に紐づくルート証明書で<br>サーバー証明書の正当性を検証
      xg -->>- cl : 5.XGのサーバー証明書と公開鍵を送付
      Note right of cl: 6.XGのルート証明書でXGの証明書の正当性を検証
      Note right of cl: 7.一時的な共通鍵を作成し、XGの公開鍵で暗号化
      cl ->>+ xg : 8.暗号化された共通鍵を送信
      Note right of xg: 9.XGの秘密鍵で複合化、共通鍵を取得
      Note right of xg : 10.共通鍵をWebサーバーの公開鍵で暗号化
      xg ->>+ sv : 11.暗号化された共通鍵を送信
      sv -->>- xg : 12.共通鍵で暗号化されたデータの送信
      Note right of xg: 13.共通鍵で複合
      Note right of xg: 14.コンテンツの中身の検証
      xg -->>- cl : 15.共通鍵で暗号化されたデータの送信
      Note right of cl: 16.共通鍵で複合

{% endmermaid %}

### このシーケンスが必要な理由

　XGが間に入らない通常のシーケンスにおいては、クライアントが生成する公開鍵はWebサーバーの公開鍵で暗号化します。従い、{% label info @間にXGが割り込んで共通鍵を取得しようとしてもWebサーバーの秘密鍵を持っていないXGでは取得できません %}。

　共通鍵を取得するためにXGがXG自身の公開鍵をクライアントへ渡しますが、{% label info @XGの独自証明書がルート証明機関に認められるものではない %}ので、クライアントでは不正な証明書と判断されてしまいます。

　従いこのシーケンスによってエラーなく成り立つためには、{% label info @クライアントにXGのルート証明書をインストール %}し、クライアント自身がXGの証明書は適切であると判断できるようにする必要があります。

### コンテンツの中身の検証について

　上記シーケンスの14番目がXGの大きな役割です。暗号化されたhttpsのデータを解読し、流れるデータの中にさまざまな脅威が無いか検証を行います。

{% note primary no-icon %}

## XG Firewall V18利用のメリット

{% endnote %}

　XGでは暗号化された通信を高速に解読し、ウィルスやマルウェアのダウンロードをPCやスマホが受信する前に防ぐ事が可能となります。また、利用を認めていないアプリケーションのデータのやりとりを未然に防ぐ事も可能です。V18では、全く新しい{% label info @XStreamアーキテクチャ %}によって、この解読（SSLインスペクション）の速度が大幅に向上しました。

{% note primary no-icon %}

## SSLインスペクションの設定にあたって

{% endnote %}
　上述した通り、SSLインスペクションを行うためには、XGのルート証明書をクライアントにインストールしなくてはなりません。復号化については、以下の端末で検証をしています。

- Windows
- macOS
- iOS
  
　なお、Linuxでも可能なようですが、私の方で検証は出来ていません。またAndroidには証明書はインストール出来ますが、Chrome以外のアプリで証明書を信頼する事が出来ず、実質SSLインスペクションは使えません。他の家電TVなども難しいと考えてください。httpsの復号化が出来ずともドメインやIP単位での制限は可能なので、家電のネット利用であっても、Firewallの利用価値は高いです。

　SSLインスペクションを設定後、ブラウザのURLの鍵マークにカーソルを合わせるとそのサイトで利用している本来の認証局ではなく、以下のようにXGの認証局が有効となっている事が分かります。

{% asset_img ssl-inspection.png alt %}

　クライアントに、XGのルート証明書が登録されていない状態でSSLインスペクションを行うと、ブラウザは「信頼されないサイト」として警告を発します。
