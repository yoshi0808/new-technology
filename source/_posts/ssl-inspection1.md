---
title: XG Firewall v18のSSLインスペクションの設定
tags:
  - XG Firewall
categories:
  - Security
date: 2020-03-20 21:32:29
---

{% note success  %}

## この記事で実現する内容について

XG Firewall v18のSSL/TLSインスペクションを使い、暗号化されたSSL通信を解読します。これにより、ウィルスやマルウェアなどの脅威を通信中に検出し、PCやiPhone等（Windows、macOS、iOS）が攻撃を受ける前に防御する事が出来るようになります。

{% endnote %}
<!-- more -->

{% note primary no-icon %}

## SSL/TLSインスペクションの対象とするホストの明確化

{% endnote %}

　SSLインスペクションの設定にあたり、PC等にXGのルート証明書をインストールする事が前提となります。SSLインスペクションの対象となる機器のみSSLの複合化を行う必要があるため、当該機器のIPアドレス群をXGに認識させておく必要があります。いつも固定IPアドレスにするためには、IPをスタティックに割り振るか、DHCPのIP割り振りを常に固定にする方法の2通りがあります。DHCPによって固定IPを割り振るために、クライアントのMACアドレスを調べておく必要があります。

{% note primary no-icon %}

## SSL/TLSインスペクションの対象とするホストをDHCPで登録する

{% endnote %}

　左ペインのネットワークからDHCPのタブをクリックし、「Default DHCP Server」をクリックします。そこには、「スタティックIP_MACマッピング」があるので、DHCPで自動リースをしている以外のIPアドレスをスタティックに割り振って登録してください。管理の一例としては以下の通りです。

- 動的なDHCPを192.168.2.101〜192.168.2.128
- 証明書が登録可能なIPをstaticで192.168.2.129〜192.168.2.192

　ここは完全に個人の「決め」です。さて、上記で証明書がインストール出来る端末群を「IPホスト」としてXGに登録しましょう。左ペインの「ホストとサービス」から、IPホストのタブをクリックし追加ボタンをクリックします。以下の通り、ホストのIPの範囲を示す名前を入力し、IPの範囲を入力して保存ボタンをクリックします。

{% asset_img host.png alt %}

{% note primary no-icon %}

## ファイアウォールルールの設定（確認）

{% endnote %}

　左ペインのルールとポリシーからルールとポリシーを選択します。以前の記事「XG Firewall v18のOutboundルールを新規作成する」で、デフォルトのルール「To_Internet」を作成しました。
 {% post_link rule-policy2 %}
Traffic to WANのグループ配下にルールがある事を確認してください。この設定は今回修正しません。

{% note primary no-icon %}

## SSL/TLSインスペクションルールの設定

{% endnote %}

　左ペインのルールとポリシーからSSL/TLSインスペクションルールをクリックします。

1. 画面右側の追加ボタンをクリックします
2. ルール名を入力します。ここでは「Catch_SSL」とします
3. ルールの位置は「最下位」のままにします
4. 処理は「復号化」を選択します
5. 復号化のプロファイルは{% label info@Strict Compliance %}を選択します
6. 送信元の送信ゾーンは、LANとVPNを選択します
7. 送信元ネットワークとデバイスは、任意を外し、先ほどの「CA_Client_IPv4」を選択します
8. 宛先とサービスの宛先ゾーンは、WANを選択します
9. 最後に保存ボタンをクリックします

　暗号化のプロファイルの{% label info@Strict Compliance %}は一番厳しいものです。左ペインのプロファイルの「復号化のプロファイル」を見てもらうと分かりますが、TLS1.0と1.1を認めないという事です。主要なブラウザは2020年上半期にTLS1.0と1.1を無効化するので、この設定が主流になるとおもいます。そうはいっても色々不便であれば、他のプロファイルに変更するか、該当のサイトが安全と分かっている場合は除外する等の対応が可能となります。なお、TLSの無効化については、[サイバートラスト社の記事](https://www.cybertrust.co.jp/blog/ssl/regulations/disable-tls10.html)が参考になります。
　これでSSLの復号化の設定は完了です。

{% note primary no-icon %}

## XGのルート証明書をクライアントにインストールする

{% endnote %}

　左ペインの一番下の証明書から、認証局（CA）をクリックします。この中に{% label info@Security Appliance_SSL_CA %}という名前の証明書があります。今回これをクライアントに配布していく事になります。右の下向きの矢印があるダウンロードを選択してクライアントにルート証明書をダウンロードします。{% label info@Security Appliance_SSL_CA.pem %}という名前になります。

{% asset_img certificate.png alt %}

　ルート証明書をダウンロードした後のクライアントインストールについては、Sophosのサイトにある[Sophos XG Firewall: SSL CA 証明書のインストールガイド](https://community.sophos.com/kb/ja-jp/123048)を参照ください。OSへの登録が必須となります。以下はWindowsの画面ですが、インストール後は、ブラウザの鍵マークをクリックする事でXGの証明書によって再署名されている事が確認出来ます。XGのログイン後のコントロールセンターの左上にライセンスナンバーが記載されていますが、実際の証明書でもそのナンバーが確認出来ます。

{% asset_img installed_cert.png alt %}

　なお、macOSの場合は以下のようにキーチェーンアクセスから証明書を「常に信頼する」設定を加えます。こちらもブラウザ毎に設定の必要は無さそうです。

{% asset_img mac_ca.png alt %}

{% asset_img mac_ca1.png alt %}

 なお、iOSについては、「ファイル」アプリを使います。

 1. iCloud Driveに証明書を配置します
 2. 「ファイル」アプリを起動します。iCloud Driveから証明書ファイルをタップしダウンロードします
 3. 「プロファイルがダウンロードされました」と表示されます
 4. 設定アプリを起動します
 5. 「設定」→「一般」→「プロファイル」と進みます
 6. ダウンロード済プロファイルに、{% label info@Sophos SSL CA_xxxx %}が表示されているので、タップします
 7. 画面右上の「インストール」をタップします
 8. iOSのパスコードを入力します
 9. 右上のインストールを再度タップし、インストールを完了します
 10. 「設定」→「一般」→「情報」と進みます
 11. 画面の一番下の「証明書信頼設定」をタップします
 12. {% label info@Sophos SSL CA_xxxx %}が表示されているので、スイッチを右側に移動させオン（緑色点灯）します

　これで一旦は証明書のインストールは完了です。この証明書のインストールがXG Firewallの設定で一番大切、かつ面倒なところになります。しかし、まだ微調整など必要なケースがあり設定は続きます。
