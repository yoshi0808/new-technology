---
title: XG Firewall v18のSSLインスペクションの設定
tags:
  - XG Firewall
categories:
  - Security
date: 2020-03-20 21:32:29
---

{% note success  %}

## この記事で実現すること

XG Firewall v18のSSL/TLSインスペクションを使い、暗号化されたSSL通信を解読します。これにより、ウィルスやマルウェアなどの脅威を通信中に検出し、PCやiPhone等（Windows、macOS、iOS）が攻撃を受ける前に防御する事が出来るようになります。

{% endnote %}
<!-- more -->

## SSLインスペクションの対象とするホストの明確化

前回の記事、{% post_link ssl-inspection %}に記載した通り、SSLインスペクションを行うためには、PC等のクライアントにXGのCA証明書をインストールする事が必須となります。従いSSLインスペクションの対象のグループ、家電やAndroidなどのSSLインスペクションを使えないグループとに分類します。この2つのグループはIPアドレスの範囲で分割するのが最も簡単な方法です。例えば、SSLインスペクショングループはスタティックでIPを割り当て、非SSLインスペクショングループはDHCPで動的なIPアドレスを配布する方法があります。XGのDHCPサーバーはMACアドレスを元に固定IPをスタティックに割り振る事が可能です。

## SSLインスペクションの対象をDHCPに登録する

左ペインのネットワークからDHCPのタブをクリックし、{% label @Default DHCP Server %}をクリックします。そこには、"スタティックIP_MACマッピング"があるので、DHCPで自動リースをしている以外のIPアドレスをスタティックに割り振って登録してください。管理の一例としては以下の通りです。

- 証明書を登録できないIoTなどをDHCPで`192.168.2.101`〜`192.168.2.128`を割り当て
- 証明書が登録可能なホストをスタティックで`192.168.2.129`〜`192.168.2.192`を割り当て

ここはユーザーの「決め」ですが、上記で証明書がインストール出来るグループを"IPホスト"としてXGに登録しましょう。左ペインの{% label @ホストとサービス %}から、IPホストのタブをクリックし追加ボタンをクリックします。以下の通り、ホストのIPの範囲を示す名前を入力し、IPの範囲を入力して保存ボタンをクリックします。ここでは、{% label @CA_Client_IPv4 %}として登録する事にします。

{% asset_img host1.png alt %}

## ファイアウォールルールの設定（確認）

左ペインのルールとポリシーからルールとポリシーを選択します。以前の記事、{% post_link rule-policy2 %}で、デフォルトのルール"To_Internet"を作成しました。{% label @Traffic to WAN %}のグループ配下に"To_Internet"ルールがある事を確認してください。このファイアウォールルールはLANおよびVPNからWANへの接続を許可するシンプルなものですが、今回これは修正しません。XG v18では、SSLインスペクションとファイアウォールルールは互いに独立していて、別メニューで設定を行う事になります。

## SSL/TLSインスペクションルールの設定

ここで、SSLインスペクショングループと非SSLインスペクショングループとの明確化を行います。左ペインのルールとポリシーからSSL/TLSインスペクションルールをクリックします。

1. 画面右側の追加ボタンをクリックします
2. ルール名を入力します。ここでは"Catch_SSL"とします
3. ルールの位置は"最下位"のままにします
4. 処理は{% label @復号化 %}を選択します
5. 復号化のプロファイルは{% label @Strict Compliance %}を選択します
6. 送信元の送信ゾーンは、"LAN"と"VPN"を選択します
7. 送信元ネットワークとデバイスは、"任意"を外し、SSLインスペクショングループとして作成した"CA_Client_IPv4"を選択します
8. 宛先とサービスの宛先ゾーンは、"WAN"を選択します
9. 最後に保存ボタンをクリックします

暗号化のプロファイルの{% label @Strict Compliance %}は一番厳しいものです。左ペインのプロファイルの"復号化のプロファイル"を見てもらうと分かりますが、TLS1.0と1.1を認めないという事です。主要なブラウザは2020年上半期にTLS1.0と1.1を無効化するので、この設定が主流になるとおもいます。そうはいっても色々不便であれば、他のプロファイルに変更するか、該当のサイトが安全と分かっている場合は除外する等の対応が可能となります。なお、TLSの無効化については、[サイバートラスト社の記事](https://www.cybertrust.co.jp/blog/ssl/regulations/disable-tls10.html)が参考になります。これでSSLの復号化の設定は完了です。

## XGのCA証明書をクライアントにインストールする

左ペインの一番下の証明書から、認証局（CA）をクリックします。この中に{% label @Security Appliance_SSL_CA %}という名前の証明書があります。今回これをクライアントに配布していく事になります。右の下向きの矢印があるダウンロードを選択してクライアントにルート証明書をダウンロードします。{% label @Security Appliance_SSL_CA.pem %}という名前になります。

{% asset_img certificate1.png alt %}

ルート証明書をダウンロードした後、クライアントへのインストールについては、OS毎に以下の3種類の手順をそれぞれ確認し設定します。

{% tabs One unique name %}
<!-- tab Windows -->
**Windowsにルート証明書をインストールする方法**

1. {% label  @プログラムとファイル名の検索 %}のボックスに{% label  @MMC %}と入力して{% label  @Microsoft Management Console %}を開きます。
2. {% label  @ファイル %}-{% label  @スナップインの追加と削除 %}を選択して"スナップインの追加と削除"を開きます。

{% asset_img win1.png alt %}

3. 一覧から{% label  @証明書 %} を選択して、{% label  @追加 %}をクリックすると"スナップインの追加と削除"のウィンドウが開かれます。
4. {% label  @コンピュータアカウント %}を選択して、{% label  @次へ %}をクリックします。
5. ローカルコンピューターがラジオボタンで選択されている事を確認し{% label  @完了 %}をクリックします。
6. "OK"をクリックして証明書をスナップインに追加すると"スナップインの追加と削除"のウィンドウに{% label  @証明書（ローカルコンピューター） %}が表示されます。

{% asset_img win2.png alt %}

7. 証明書（ローカルコンピューター）のコンテナを展開して、{% label  @信頼されたルート証明機関 %}を右クリックして、"すべてのタスク > インポート"を選択して証明書インポートのウィザードを開始します。
8. 証明書インポートのウィザードでは、{% label  @参照 %}ボタンをクリックして、拡張子pemを読み込むため{% label  @すべてのファイル(＊.＊) %}を選び、XGからダウンロードした、{% label  @Security Appliance_SSL_CA.pem %}を選択します。

{% asset_img win3.png alt %}

{% asset_img win4.png alt %}

9.{% label  @信頼されたルート証明機関 %}としてXGの証明書を登録し完了です。
<!-- endtab -->

<!-- tab <i class="fab fa-apple"></i>macOS -->
**macOSにルート証明書をインストールする方法**

1. iCloud Driveに証明書を配置します
2. ローカルドライブに証明書をコピーします
3. 証明書を開きます。キーチェーンアクセスが起動するので、以下のようにキーチェーンアクセスから証明書を"常に信頼する"設定を加えます

{% asset_img mac_ca2.png alt %}

{% asset_img mac_ca3.png alt %}

<!-- endtab -->

<!-- tab iOS@mobile-alt -->
**iOSにルート証明書をインストールする方法**

iOSで「ファイル」アプリを使います。

 1. iCloud Driveに証明書を配置します
 2. "ファイル"アプリを起動します。iCloud Driveから証明書ファイルをタップしダウンロードします
 3. "プロファイルがダウンロードされました"と表示されます
 4. 設定アプリを起動します
 5. "設定"→"一般"→"プロファイル"と進みます
 6. ダウンロード済プロファイルに、{% label @Sophos SSL CA_xxxx %}が表示されているので、タップします
 7. 画面右上の"インストール"をタップします
 8. iOSのパスコードを入力します
 9.  右上のインストールを再度タップし、インストールを完了します
 10. "設定"→"一般"→"情報"と進みます
 11. 画面の一番下の"証明書信頼設定"をタップします
 12. {% label @Sophos SSL CA_xxxx %}が表示されているので、スイッチを右側に移動させオン（緑色点灯）します
<!-- endtab -->
{% endtabs %}

## ルート証明書が取り込まれた事を確認する

ブラウザの鍵マークをクリックする事でXGの証明書によって再署名されている事が確認出来ます。XGのログイン後のコントロールセンターの左上にライセンスナンバーが記載されていますが、実際の証明書でもそのナンバーが確認出来ます。

{% asset_img installed_cert1.png alt %}

これで証明書のインストールは完了です。この証明書のインストールがXG Firewallの設定で一番大切な部分です。
