---
title: XG Firewall v18のSSLインスペクションの設定
tags:
  - XG Firewall
categories:
  - Security
date: 2020-03-20 21:32:29
---
<p class="onepoint">この記事で実現すること</p>
XG Firewall v18のSSL/TLSインスペクションを使い、暗号化されたSSL通信を解読します。これにより、ウィルスやマルウェアなどの脅威を通信中に検出し、PCやiPhone等（Windows、macOS、iOS）が攻撃を受ける前に防御できるようになります。
<!-- more -->

## XG Firewall v18のメリット

XGでは暗号化された通信を高速に解読し、ウィルスやマルウェアのダウンロードをPCやスマホが受信する前に防ぐ事が可能となります。また、利用を認めていないアプリケーションのデータのやりとりを未然に防ぐ事も可能です。v18では、全く新しい{% label primary@XStreamアーキテクチャ %}によって、この解読（SSLインスペクション）の速度が大幅に向上しました。

## SSLインスペクションの対象ホストを決める

「{% post_link ssl-inspection %}」に記載した通り、SSLインスペクションを行うためには、PC等のクライアントにXGのCA証明書をインストールする事が必須となります。従いSSLインスペクションの対象のグループ、家電やAndroidなどのSSLインスペクションを使えないグループとに分類します。この2つのグループはIPアドレスの範囲で分割するのが最も簡単な方法です。例えば、SSLインスペクショングループはスタティックでIPを割り当て、非SSLインスペクショングループはDHCPで動的なIPアドレスを配布する方法があります。**XGのDHCPサーバーはMACアドレスを元に固定IPをスタティックに割り振る事が可能です**。

### SSLインスペクションの対象をDHCPに登録する

左ペインのネットワークからDHCPのタブをクリックし、{% label primary@Default DHCP Server %}をクリックします。そこには、"スタティックIP_MACマッピング"があるので、DHCPで自動リースをしている以外のIPアドレスをスタティックに割り振って登録してください。管理の一例としては以下の通りです。

- 証明書を登録できないIoTなどをDHCPで`192.168.2.101`〜`192.168.2.128`を動的割り当て
- 証明書が登録可能なホストをスタティックIPマッピングで`192.168.2.129`〜`192.168.2.192`を固定割り当て

ここはユーザーの「決め」ですが、上記で証明書がインストール出来るグループを"IPホスト"としてXGに登録しましょう。左ペインの{% label primary@ホストとサービス %}から、IPホストのタブをクリックし追加ボタンをクリックします。以下の通り、ホストのIPの範囲を示す名前を入力し、IPの範囲を入力して保存ボタンをクリックします。ここでは、{% label primary@CA_Client_IPv4 %}として登録する事にします。

{% asset_img host1.png alt %}

## ファイアウォールルールの設定

左ペインのルールとポリシーからルールとポリシーを選択します。「{% post_link rule-policy2 %}」にて、デフォルトのルール"To_Internet"を作成しました。{% label primary@Traffic to WAN %}のグループ配下に"To_Internet"ルールがある事を確認してください。このファイアウォールルールはLANおよびVPNからWANへの接続を許可するシンプルなものですが、今回これは修正しません。XG v18では、SSLインスペクションとファイアウォールルールは互いに独立していて、別メニューで設定する事になります。

## SSL/TLSインスペクションルールの設定

ここで、SSLインスペクショングループと非SSLインスペクショングループとの明確化を行います。左ペインのルールとポリシーからSSL/TLSインスペクションルールをクリックします。

1. 画面右側の追加ボタンをクリックします
2. ルール名を入力します。ここでは"Catch_SSL"とします
3. ルールの位置は"最下位"のままにします
4. 処理は{% label primary@復号化 %}を選択します
5. 復号化のプロファイルは{% label primary@Strict Compliance %}を選択します
6. 送信元の送信ゾーンは、"LAN"と"VPN"を選択します
7. 送信元ネットワークとデバイスは、"任意"を外し、SSLインスペクショングループとして作成した"CA_Client_IPv4"を選択します
8. 宛先とサービスの宛先ゾーンは、"WAN"を選択します
9. 最後に保存ボタンをクリックします

暗号化のプロファイルの{% label primary@Strict Compliance %}は一番厳しいものです。左ペインのプロファイルの"復号化のプロファイル"を見てもらうと分かりますが、TLS1.0と1.1を認めないという事です。主要なブラウザは2020年上半期にTLS1.0と1.1を無効化するので、この設定が主流になると予想されます。もちろん、該当のサイトが安全と分かっている場合は除外する等の対応が可能となります。なお、TLSの無効化については、サイバートラスト社の記事が参考になります。詳細は[こちらの記事](https://www.cybertrust.co.jp/blog/ssl/regulations/disable-tls10.html)を参照してください。

## XGのCA証明書をクライアントにインストール

左ペインの一番下の証明書から、認証局（CA）をクリックします。この中に{% label primary@Security Appliance_SSL_CA %}という名前の証明書があります。今回これをクライアントに配布していく事になります。右の下向きの矢印があるダウンロードを選択してクライアントにルート証明書をダウンロードします。{% label primary@Security Appliance_SSL_CA.pem %}という名前になります。

{% asset_img certificate1.png alt %}

ルート証明書をダウンロードした後、クライアントへのインストールについては、OS毎に手順をそれぞれ確認し設定します。

### Windowsにルート証明書をインストール

1. {% label primary@プログラムとファイル名の検索 %}のボックスに{% label primary@MMC %}と入力して{% label primary@Microsoft Management Console %}を開きます。
2. {% label primary@ファイル %}-{% label primary@スナップインの追加と削除 %}を選択して"スナップインの追加と削除"を開きます。

{% asset_img win1.png alt %}

3. 一覧から{% label primary@証明書 %} を選択して、{% label primary@追加 %}をクリックすると"スナップインの追加と削除"のウィンドウが開かれます。
4. {% label primary@コンピュータアカウント %}を選択して、{% label primary@次へ %}をクリックします。
5. ローカルコンピューターがラジオボタンで選択されている事を確認し{% label primary@完了 %}をクリックします。
6. "OK"をクリックして証明書をスナップインに追加すると"スナップインの追加と削除"のウィンドウに{% label primary@証明書（ローカルコンピューター） %}が表示されます。

{% asset_img win2.png alt %}

7. 証明書（ローカルコンピューター）のコンテナを展開して、{% label primary@信頼されたルート証明機関 %}を右クリックして、"すべてのタスク > インポート"を選択して証明書インポートのウィザードを開始します。
8. 証明書インポートのウィザードでは、{% label primary@参照 %}ボタンをクリックして、拡張子pemを読み込むため{% label primary@すべてのファイル(＊.＊) %}を選び、XGからダウンロードした、{% label primary@Security Appliance_SSL_CA.pem %}を選択します。

{% asset_img win3.png alt %}

{% asset_img win4.png alt %}

9.{% label primary@信頼されたルート証明機関 %}としてXGの証明書を登録し完了です。

### macOSにルート証明書をインストール

1. iCloud Driveに証明書を配置します
2. ローカルドライブに証明書をコピーします
3. 証明書を開きます。キーチェーンアクセスが起動するので、以下のようにキーチェーンアクセスから証明書を"常に信頼する"設定を加えます

{% asset_img mac_ca2.png alt %}

{% asset_img mac_ca3.png alt %}

### iOSにルート証明書をインストール

iOSで「ファイル」アプリを使います。

 1. iCloud Driveに証明書を配置します
 2. "ファイル"アプリを起動します。iCloud Driveから証明書ファイルをタップしダウンロードします
 3. "プロファイルがダウンロードされました"と表示されます
 4. 設定アプリを起動します
 5. "設定"→"一般"→"プロファイル"と進みます
 6. ダウンロード済プロファイルに、{% label primary@Sophos SSL CA_xxxx %}が表示されているので、タップします
 7. 画面右上の"インストール"をタップします
 8. iOSのパスコードを入力します
 9. 右上のインストールを再度タップし、インストールを完了します
 10. "設定"→"一般"→"情報"と進みます
 11. 画面の一番下の"証明書信頼設定"をタップします
 12. {% label primary@Sophos SSL CA_xxxx %}が表示されているので、スイッチを右側に移動させオン（緑色点灯）します

## 動作確認

ブラウザの鍵マークをクリックする事でXGの証明書によって再署名されている事が確認出来ます。XGのログイン後のコントロールセンターの左上にライセンスナンバーが記載されていますが、実際の証明書でもそのナンバーが確認出来ます。

{% asset_img installed_cert1.png alt %}

これで証明書のインストールは完了です。この証明書のインストールがXG Firewallの設定で一番大切な部分です。

{% note warning %}

XGのCA証明書がインストールできないIoT機器をSSLインスペクションの対象とすると、証明書エラーとなり機器が正しく動作しなくなる可能性があります。

{% endnote %}

（2020-09-30追記）
iOS14より、Wi-Fiの設定に{% label primary@プライベートアドレス %}という項目が追加されています。これはWi-Fiネットワーク毎にMACアドレスを自動的に変更し、匿名性を保つ機能になります。このページでXGのSSL/TLSインスペクションを利用する際は、MACアドレスを元にDHCPでいつも同じIPアドレスが配布される仕組みを推奨しています。つまり、このMACアドレスが毎回変わるようだと固定IPを割り当て出来ません。対策としては、自宅のWi-Fiについては{% label primary@プライベートアドレス %}をオフにする（推奨）、或いはiOSに最初からスタティックのIPアドレスを割り振る方法があります。Apple社からのプライベートアドレスに関する説明が「iOS 14、iPadOS 14、watchOS 7 でプライベート Wi-Fi アドレスを使う」で説明されています。この機能の目的は以下のようです。
{% cq %}

デバイスがすべてのネットワークで常に同じ Wi-Fi MAC アドレスを使っていると、時間の経過に伴い、ネットワークの事業者やその他のネットワーク観測者がそのアドレスをデバイスのネットワーク活動や位置情報に紐付けることがたやすくなります

{% endcq %} 

詳細は[こちらの記事](https://support.apple.com/ja-jp/HT211227)を参照してください。

自宅での利用の場合は見知らぬMACアドレスがあると、知らない端末からの接続があったのかとちょっとびっくりしますので、自宅では使用しない選択が良いでしょう。
