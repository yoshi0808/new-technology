---
title: XG Firewall v18でLAN内のホストをインターネットに公開する
tags:
  - XG Firewall
categories:
  - Security
  - ホスト公開
date: 2020-04-11 10:07:59
---

<p class="onepoint">この記事で実現すること</p>
XG Firewall v18において、LAN内のホストをインターネットへ公開できます。また日本国内からのアクセスに限るなど、防御を高めます。

<!-- more -->

## 今回の説明の環境について

インターネットから宅内の環境に対し、VPNを使わず直接アクセスするケースを説明します。ネットワークストレージ（NAS）へのアクセスやWebサーバーのコンテンツ公開を対象としています。この記事ではインターネット側にホームゲートウェイ、その内側にXG Firewallがあり、さらに内側にLANがある事を前提とします。XG Firewallでは、一般的なルーターと同じように内部のホストをインターネットに公開するためには設定が必要となります。一般的な用語でもありますが、Sophosでは、このような外から内へのパブリックIPとプライベートIPとの変換を伴う接続形態をDNAT（Destination NAT）と呼んでいます。

{% asset_img XG.drawio.png alt %}

設定においては、上記の2つのサブネット（XGのWAN側、LAN側）があり、ホームゲートウェイ側からXGのWANインタフェースに対するポートフォワード、そしてXGからLAN内にあるホストへのポートフォワードとの2段階のポート転送が必要です。

{% note danger %}

{% emoji heavy_exclamation_mark %}ご注意{% emoji heavy_exclamation_mark %}

この記事はあくまで技術的にホストを公開する方法について記述していますが、昨今のサイバー攻撃はランサムウェアが猛威を奮っています。個人が行うサイバー攻撃対策ではとうてい太刀打ちできませんので、リスクを認識の上で設定してください。なお、インターネットから自宅のリソースへのアクセスは2要素認証付きのVPNによる接続をお勧めします。「{% post_link vpn %}」の記事を参照してください。

{% endnote %}


### サーバーアクセスアシスタント

v18では、{% label primary@サーバーアクセスアシスタント %}というウィザード形式で設定できる仕組みが導入されています。もちろん、このウィザードを使わなくてもDNATの設定は可能ですが、今回はウィザードを利用し設定します。

## ホスト公開設定

一般的な設定例として、内部にあるWebサーバーのhttpsアクセス（Port443）をインターネットから接続するケースで説明します。{% label primary@パブリックIPのPort443 %}→{% label primary@プライベートIPのPort443 %}に着信させる実例です。

### ホームゲートウェイの事前設定

VPNの導入の記事でも書きましたが、まずはインターネットから内部のホストにデータを届けるためには、ホームゲートウェイとXGそれぞれに設定する必要があります。以下のように、ホームゲートウェイでPort443のトラフィックをXGのWAN側IPアドレスに転送します。

{% asset_img rule6.png alt %}

この画面はホームゲートウェイの画面であり、契約しているインターネット回線業者により、提供される機器は異なりますのであくまで設定例という事で参考までに掲載しています。

### サーバーアクセスアシスタントの設定

サーバーアクセスアシスタントを使ったDNATを設定します。まずXGの左ペインメニューから、ルールとポリシーを選択します。ルールの上にある{% label primary@ファイアウォールルールの追加 %}をクリックし、{% label primary@サーバーアクセスアシスタントDNAT %}をクリックします。そうすると以下のウィザード画面が表示されます。

{% asset_img rule1.png alt %}

ここでは、LANに設置してある、公開したいサーバーのIPとそのホストの名前を入力します。ここで入力したホストの名前とIPアドレスの組みは自動的にXGのIPホストとして登録されます。今回のケースではWebサーバーとそのIPアドレスを入力しています。入力後、{% label primary@次へ %}をクリックします。

2画面目では、以下のように公開したいパブリックIPアドレスを入力する画面となります。
{% asset_img rule2.png alt %}
これはパブリックIPアドレスからプライベートIPへ変換するためのマッピング情報の元となるものです。但し、注意点として、ここでの構成はあくまでホームゲートウェイによってプライベートIPに変換された後のXGのWAN側IPアドレス（つまりプライベートIPアドレス）を入力する事になります。XGのWAN側インターフェースのIPアドレスである、{% label primary@#Port2 %}を選択し、{% label primary@次へ %}をクリックします。

3画面目では、内部に転送するサービスを選択します。Port443のHTTPSを選択しています。
{% asset_img rule3.png alt %}

選択後、{% label primary@次へ %}をクリックします。
4画面目では、{% label primary@外部の送信元ネットワークとデバイス %}を選択します。
{% asset_img rule4.png alt %}

表現が難しいのですが、WAN側のネットワークに制約を加える場合はここにネットワークの追加を行い、{% label primary@任意 %}の設定を外す事になります。今回は、一旦はこのまま{% label primary@次へ %}をクリックします。

5画面目では、これまで設定してきた内容の確認画面となります。画面の後半に{% label primary@NATルールを3つ作成します %}という記述があります。DNAT以外の2つは不要なので後から削除する事になりますが、これは後ほど説明します。

{% asset_img rule5.png alt %}

{% label primary@保存して完了する %}をクリックしてください。これで、DNATの設定が完了しました。{% label primary@ルールとポリシー %}では、作成されたルールは以下のようになっています。

{% asset_img rule7.png alt %}

{% label primary@ファイアウォールルール %}の一番上に新しいルール{% label primary@DNAT to QNAPxxxx %}が追加されています。引き続き、{% label primary@NATルール %}を見てみます。以下のように3つのルールが作成され、1番上にDNATルールが表示されています。

{% asset_img rule8.png alt %}

これでひとまず設定は完了しています。これでインターネットから内部ホストへアクセス出来るようになりました。

## DNSにプライベートIPを登録

さて、インターネットからパブリックIPを使って内部ホストへアクセス出来るようになりました。一般的にはダイナミックDNSなどを用いてURLでアクセスする事になります。しかし宅内のLAN環境に入り当該サーバーへ同じURLを使って接続する場合は、わざわざパブリックIPにする事はなく、直接LANのプライベートIPに対してアクセスする事になります。この場合は、XGのDNSでスタティックとしてプライベートIPを登録します。左ペインの{% label primary@ネットワーク %}から{% label primary@DNS %}を選び、{% label primary@DNSホストエントリ %}で、サーバーのURLとプライベートIPの組み合わせを登録してください。クライアントはXGのDHCPによってDNSがXG自身である事を指定されているため、当該ホストについてはプライベートIPでアクセス可能となります。

## DNATのウィザードで作成されるルールの詳細

ウィザードでは、シンプルにまずは繋がる事を優先に最低限度の設定を行いました。まずDNATの理解を深めるために、ウィザードで作成されたファイアウォールルールのDNATについて見てみましょう。

{% asset_img rule9.png alt %}

- {% label primary@送信元とゾーン %}は、WAN
- {% label primary@宛先ゾーン %}は、LAN
- {% label primary@サービス %}は、HTTPS

以上のように、それなりに理解出来るものが記載されています。しかし理解が進まないのは、{% label primary@宛先ネットワーク %}の{% label primary@#Port2 %}、つまりXGのWAN側IPアドレスが記述されている点です。宛先として直感ではLAN側のインタフェースである、{% label primary@#Port1 %}のように感じます。まして、転送したいWebサーバーのホスト名が記載されている項目はここにはありません。実際のHTTPSのアクセスである、Webサーバーに転送するという項目は{% label primary@NATルール %}で記載されています。XG Firewll v18におけるDNATはポリシールールとNAT変換ルールはそれぞれ独立しているのです。

- Loopback NAT（不要）
 これはヘアピンNATとも呼ばれますが、内部ネットワークからパブリックIPアドレスを用いて再び内部ネットワークにある公開サーバーへアクセスしたい場合に使います。XGがWANの外に出ていこうとするトラフィックを無理やり内部の公開サーバーに振り向ける動作です。前述したとおり内部のホストには、DNSに登録したプライベートIPでアクセスするので不要です。
- Reflexiv NAT（不要）
 これは普通に内部ホストからWAN向けのNATを伴う変換ルールです。インストール直後のSNAT（ソースNAT　※送信元アドレスを書き換える一般的なNAT）のルールが最初から存在している事、「{% post_link rule-policy2 %}」において、{% label primary@To Internet %}というSNATのルールを作成しているので改めての作成は不要です。

## インターネットの接続可能な範囲を絞る

公開するホストが国内からのアクセス用途に限定できるならば、少しFirewallらしい設定を加えてみましょう。ウィザードの4画面目で、任意とした外部の送信元ネットワークを活用します。もし、このWebサーバに対して日本国内からのアクセスに限れば、海外からの攻撃を防ぐ事ができます。この場合は、作成済みのDNATルールの{% label primary@送信元ネットワークとデバイス %}の{% label primary@任意 %}を外し、{% label primary@Japan %}を加えてください。

## DNATに関するSophosCommunityでの投稿

「[Server Access Assistant (DNAT) Request](https://community.sophos.com/products/xg-firewall/sfos-eap/sfos-v18-early-access-program/f/feedback-and-issues/118045/server-access-assistant-dnat-request)」の記事を参照してください。DNATの設定方法について、色々な議論がなされています。

## ご注意（2021-4-29追記）

2021年4月22日より、NASのQNAPを対象としたランサムウェアによる被害が大きくなっています。アプリケーションの脆弱性を突かれ、ファイルがパスワード付き7z圧縮処理をされてしまい、暗号化解除にはbitcoinを要求されるというものです。特にNASはランサムウェアのターゲットになりやすい事、脆弱性を狙うため、2要素認証やFirewallなど一般的な管理策がいくらしっかりとしていても、それら管理策が回避されて被害を受けます。
NASに限らず、LAN内のホストをInternetに公開する事は現代においてはかなりリスクが大きい事ですので、情報資産の重要度などを鑑み、理解の上設定される事をお勧めします。

特に有志がメンテナンスしているオープンソースをベースにプロダクトが構築されているものは悪意を持った人間がコントリビューター（貢献者）としてマルウェアを仕込むなど、人の善意を悪用するケースがあります。例えばPHPなどは多くの脆弱性が発見されており、メーカー側がその修正を取り込むまでの間に攻撃されるケースが多いように感じています。

私も以前はいくつかのサービスを公開していましたが、昨今のサイバー攻撃の状況を鑑み、オンプレミスでのポート解放は一切行わず、外出先からは全てVPN（＋2要素認証）からのアクセスに変更しています。

そういう意味ではこのブログもそうですが、読み手の安全性確保のため、GitHubに静的コンテンツとして提供しており、サイバー攻撃のリスクを可能な限り排除しています。情報資産の管理はクラウドかオンプレかは意見が別れるところでしょうが、個人における情報公開はクラウドが中心になりつつあると感じています。
