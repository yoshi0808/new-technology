---
title: XG Firewall v18のルールを作成する
date: 2020-03-14 11:12:50
tags:
  - XG Firewall
categories:
  - Security
---

{% note success  %}

## この記事で実現すること

XG Firewall v18を使ったインターネットアクセスのための、デフォルトのルールを作成します。この際にリスクの大きい通信を止めたり、Webのポリシー（閲覧が好ましくないサイト）の設定が出来るようになります。また、v18のNATについての概要を学びます。

{% endnote %}
<!-- more -->

## Traffic to Wanルールの作成

いよいよ、実際の基本的なルールを作成します。ルールとポリシーのメニューから、{% label @ファイアウォールルールの追加 %}ボタンを押し、"新しいファイアウォールルール"を選択します。ルール名にはここでは"To_Internet"とします。ルールグループは"自動"のままで構いません。アクションは"許可する"のままです。ファイアウォールのログは出力するようにチェックしておきます。現時点で"選択した条件に一致しないため、ルールを既存のグループに追加できません"との表示がありますが、その下のルール設定に進みます。

{% asset_img rule1.png alt %}

 送信元ゾーンには、"LAN"を設定します。今後、VPNを使う方は"VPN"も加えてください。宛先ゾーンは"WAN"を指定します。その他は変更しません。これを設定した段階で上部に表示されていた注意メッセージが"このルールは自動的にルールグループTraffic to WANに追加されます"という表記に変わります。
 
 続いて、アプリケーションファイアウォールの設定です。

{% asset_img rule2.png alt %}

セキュリティ機能の{% label @Webフィルタリング %}をクリックし、詳細メニューをオープンします。今回は初期設定の位置付けでスタンダードな内容を設定していきます。

- Webポリシーは"Default Policy"を選択します
- "HTTPおよび復号化したHTTPSをスキャン"をチェックします
- "FTPのマルウェアをスキャン"をチェックします
- QUICプロトコルのブロックは任意選択です
 Googleのサービスで利用されています。私はチェックしています。Google自体は問題ないですがそのプロトコルを利用した悪質なサイトがFirewallを回避するリスクを減らすという意味で選択しています
- その他のセキュリティ機能でアプリケーションコントロールを選択します
 最もリスクが高いアプリケーションを拒否する"Block very high risk(Risk Level 5) apps"を選択します
- IPSは一般的なルール"lantowan_general"を選択します

保存ボタンをクリックするとルールの追加が行われます。Webポリシーが"Default Policy"で広告が禁止されていればブラウザではエラー画面が表示されます。またサイトのカテゴリ（ギャンブル、アダルト）などもDefault Policyの設定内容によって、どのようにアクセスが止まるのか確認をして下さい。XG画面の右上に{% label @ログビューア %}があるので、"ファイアウォールルール"、"アプリケーションフィルタ"、"Webフィルタ"のログを確認し、何が許可され、何が拒否されているのかを確認しながらさらに新しいルールを加えるなど、カスタマイズを進めてください。Webフィルタについての解説は、{% post_link customize-policy %}および{% post_link web-application-filter %}を参照してください。なお、SSL/TLSインスペクションの設定が有効になるまでは、アプリケーションフィルタやWebフィルタも完全には動作しません。Windows、macOS、iOSにはSSL/TLSインスペクションを設定されるお勧めします。SSLインスペクションについては、こちらの記事、{% post_link ssl-inspection %}を参照してください。

## 3つのルール

ルールとポリシーのメニューには、"ファイアウォールルール"と"SSL/TLSインスペクションルール"、NATに関する"NATルール"の3つの設定があります。最初からビルトインされている"Default SNAT IPv4"というNATルールは、LAN側のプライベートIPアドレスからWANへ出ていく時に、パブリックIPへと変換するためのNATの仕組みが記述されています。LANのIPアドレスは、XGのWAN側IPアドレスに変換されて、インターネットに出ていきます。

XG V17まではファイアウォールのルール1つ1つに対して、NATを行うか否かを設定していました。V18では、ファイアウォールルールとNATルールとは切り離されました。V18ではLANからWAN、VPNからWANなどのインタフェースやIPアドレス単位でNATの設定を行います。V17からV18にバージョンアップした際はマイグレーションプロセスによって、ルールとリンクされたNATが1つづつ作成されます。ホームユーザーにおいては、よほど複雑な環境でなければNATのルールはVPN+LANからWANへの1つで十分です。ルールの1つ1つにNATルールがあると、NATルールが解りづらくなってしまいます。このブログにおけるXG V18の設定では、リンクNATの利用は最低限に留め設定を行っていきます。

**3つのルールの関係**

| ルールとポリシー              | 内容                                                                                                                                                                                                       |
| ----------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ファイアウォールルール        | インタフェース、接続元ホスト、接続先ホスト、プロトコル単位に許可、拒否のルールを決定します。今回は"To Internet"というLAN（VPN）からWANに対して全てのトラフィックを通過させるルールを追加しました。         |
| NATルール                     | インターフェース、IPアドレス単位にNATを行うか否かを決定します。最初からNATルール"Default SNAT IPv4"が登録されており、LANからWANへのトラフィックはファイアウォールルールの種類に関わらず、原則NATされます。 |
| SSL/TLSインスペクションルール | SSL/TLSインスペクションを行う端末か対象外の端末かを決定します。また検査除外するドメインもここで決定します。                                                                                                |
