---
title: XG FirewallのWebとアプリケーションフィルタについて
tags:
  - XG Firewall
categories:
  - Security
date: 2020-05-06 14:54:00
---

{% note success  %}

## この記事で実現する内容について

　XG Firewallのレイヤ7ファイアウォールとしてのメインでもある、Webフィルター、アプリケーションフィルターについてそれぞれの違い、および活用方法について理解を深めます。

{% endnote %}

<!-- more -->

## XGのWebフィルターについて

XGの左ペインメニューでは、{% label @Web %}、{% label @アプリケーション %}とそれぞれ分かれています。{% label @Web %}ではサイトのカテゴリが分かれていて、そのサイトのカテゴリによっては閲覧させないという使い方が一般的な使い方のように見えます。これらのポリシーは、[Sophosのサイト「Sophos XG Firewall: Web カテゴリ」](https://community.sophos.com/kb/ja-jp/134155)にも日本語の解説があります。サイトのカテゴリについては、ビジネス、ギャンブル、ゲーム、アダルト、ファイナンス等多岐に渡ります。ホームユーザーとしてはいわゆる怪しいサイトや過度な広告をフィルタする事が主目的になります。上記サイトのポリシーを眺めていると疑問に感じるところがあります。「ActiveX」、「Applets」、「SpamURLs」です。サイトのポリシーで判断しているのかと思いきや、ActiveXやAppletは単純にサーバー名とも関係ありません。企業やサイトの目的ではなく、そこに配置したコンテンツの内容まで判断するように見えます。サイトのカテゴリに関係なく、そこにSpamがある場合は排除される事のようですから、そのあとのフォルダ構成を含めたURLまで対象としているよです。

上記の”Sophos XG Firewall:Webカテゴリ”には記載がないものの、XGの左ペインメニューの{% label @Web %}の{% label @ファイルタイプ %}の内容には、ファイル拡張子、MIMEヘッダーの情報が並びます。そしてここにはZIPファイルなどの{% label @Compressed Files %}、Windowsの実行ファイルである{% label @Executable File %}などの項目が並んでいます。

ホームユーザーとしては、ZIPファイルやEXEファイルが使えないと不便なのでフィルタする事は考えにくいですが、何らかのMIMEタイプを拒否するポリシーを作成する場合は有効に機能しそうです。最終的には、Webフィルターは以下の種類の分類となります。

- Webカテゴリ
- URLグループ（自身で作成したURLの集まり）、280blockerなどのURLデータベースもこのグループ
- ファイルタイプ
- ダイナミックカテゴリ（ActiveX・Applets・Cookies・HTTP Upload

これらの事から、Webフィルターはカテゴリの分類という主目的はあるものの、ブラウザを対象としたフィルターの機能である事がわかります。

## SNIとWebフィルターについて

SNIとは、Server Name Indicationの略です。SSL/TLS通信において、クライアントからサーバ証明書を要求する時に{% label @暗号化せず %}情報がサーバーに渡されます。XGはこのSNIを見てWebフィルターを行っていますので、SSLインスペクションが行えなくともURLでアクセス許可・不可の判断は可能になります。全てのWebサーバーがSNIに対応しているわけではありませんが、SSLインスペクションが行えないAndroid端末であってもある程度の許可・不可の制御は可能となります。しかし、以前の記事、{% post_link ssl-inspection2 %} で記載した通り、ZIP化されたマルウェアは検知できないなどSSLインスペクションを使わないと完全ではありません。

## XGのアプリケーションフィルターについて

XGのアプリケーションフィルターは、XGの左ペインメニューの{% label @アプリケーション %}から確認できます。ブラウザーではないインターネットに接続するアプリケーションを対象にしています。ここの挙動の確認は非常に難しいものがあります。例えば、MicrosoftのOneDriveを題材にテストしてみましょう。

OneDriveのURLは、現時点で、{% label @https://onedrive.live.com/ %}です。Webフィルターで当該ドメインのフィルターを行うと、想定通りブラウザーからOneDriveにはアクセス出来ませんでした。

{% asset_img onedrive.png alt %}

しかし、”Android端末にインストールしてあるOneDriveアプリ経由で画像をコピーできる”こと、”WindowsPCのエクスプローラーのOneDriveフォルダからこの画像は削除出来る”事実があります。検証のためにWebフィルターは削除、アプリケーションフィルターにOneDriveの項目があるので、そちらをフィルターしてみます（これは検証作業なのでこのブログをご覧の方が実施する作業ではありません）。

XGの左ペインメニューの{% label @アプリケーション %}からファイアウォールルールで選択されているポリシーの先頭で{% label @追加 %}ボタンをクリックし、{% label @スマートフィルタ %}に{% label @onedrive %}と入力し、Enterキーを押します。

{% asset_img appfilter2.png alt %}

OneDriveのルールがいくつか表示されるため、{% label @アクション %}は、{% label @拒否 %}を選択して最後に{% label @保存 %}をクリックします。この作業の結果は以下の通りの挙動でした。

- ブラウザからOneDriveに接続出来ない
- WindowsエクスプローラーからOneDriveのツール上ではファイルの追加、削除は行えない
- AndroidからOneDriveのファイル追加は行えないが、**削除は可能**

これらの事から、アプリケーションフィルタは、アプリが利用しているAPIのURLやデータの中身を見て挙動の制限を行っている事がわかります。OneDriveはファイルのアップロード・ダウンロードと目的によって分かれていましたが、他のアプリケーションであるAppleのiCloudDriveに関しては、アプリケーションフィルタは1種類だけです。このようにアプリケーションフィルターは、アプリの作り方に左右されるものとなります。AndroidはSSLインスペクションが行えないため、URL（SNI）の検証は行えますが、データの中身はhttpsで暗号化されておりファイル削除については制御出来ません。アプリケーションフィルターの中には、{% label @EXE File Download %}というフィルタも存在しますが、あくまで汎用的なものです。全てのいかなるアプリケーションからのEXEファイルのダウンロードを禁止できるものではありません。ホームユーザーとしてリスクを抑制しつつ利便性を高めるには、どのようなフィルターを作っていくべきでしょうか。たくさん存在するアプリケーションを都度設定するのは管理も非常に大変で現実的ではありません。

Webのカテゴリについては、個人の考え方でいろいろなフィルタの組み合わせがあるでしょうから、ご自身のポリシーでカスタマイズして下さい。但し攻撃から身を守るという課題については、ある程度のスタンダードはありますので、Sophos Communityの情報を頼りにホームユーザーのためのお勧め設定について次回に記載します。
