---
title: XG FirewallのWebとアプリケーションフィルタについて
tags:
  - XG Firewall
categories:
  - Security
date: 2020-05-06 14:54:00
---

{% note success  %}

## この記事で実現すること

XG Firewallのレイヤ7ファイアウォールとしてのWebフィルタ・アプリケーションフィルタについて、それぞれの違いと活用方法について解説します。

{% endnote %}

<!-- more -->

## Webフィルタについて

XGの左ペインメニューでは、{% label @Web %}、{% label @アプリケーション %}とそれぞれ分かれています。{% label @Web %}ではサイトのカテゴリが分かれていて、そのサイトのカテゴリによっては閲覧を制限する事が一般的な使い方です。これらのポリシーは、[Sophosのサイト「Sophos XG Firewall: Web カテゴリ」](https://community.sophos.com/kb/ja-jp/134155)にも日本語の解説があります。サイトのカテゴリについては、ビジネス、ギャンブル、ゲーム、アダルト、ファイナンス等多岐に渡ります。ホームユーザーとしてはいわゆる怪しいサイトや過度な広告をフィルタする事が主目的になります。しかし、上記サイトのポリシーを眺めていると疑問に感じるところがあります。"ActiveX"、"Applets"、"SpamURLs"です。ActiveXやAppletは単純にサーバー名とも関係ありません。サイトのカテゴリに加え、URLまでを対象としているようです。

上記の”Sophos XG Firewall:Webカテゴリ”には記載がないものの、XGの左ペインメニューの{% label @Web %}の{% label @ファイルタイプ %}の内容には、ファイル拡張子、MIMEヘッダーの情報が並びます。そしてここにはZIPファイルなどの"Compressed Files"、Windowsの実行ファイルである"Executable File"などの項目が並んでいます。

ホームユーザーとしては、ZIPファイルやEXEファイルが使えないと不便なのでフィルタする事は考えにくいですが、何らかのMIMEタイプを拒否するポリシーを作成する場合は有効に機能しそうです。最終的には、Webフィルタは以下の種類の分類となります。

- Webカテゴリ
- URLグループ（自身で作成したURLの集まり）、280blockerなどのURLデータベースもこのグループ
- ファイルタイプ
- ダイナミックカテゴリ（ActiveX・Applets・Cookies・HTTP Upload

これらの事から、Webフィルタはカテゴリの分類という主目的はあるものの、ブラウザを対象としたフィルタの機能である事がわかります。

## SNIとフィルタとの関係

SNIとは、Server Name Indicationの略です。SSL/TLS通信において、クライアントからサーバ証明書を要求する時に**サーバ名（SNI）を暗号化せずサーバーに渡します**。XGはこのSNIを見てWebフィルタを行っていますので、接続しようとしているドメインやサーバー単位にアクセス許可・不許可の判断が可能になります。しかし**フォルダ構成やMIMEタイプ、引数やダウンロードするデータを検査するには、SSL/TLSインスペクションが必要です**。もちろん、ドメイン単位の制御でIoT機器はある程度の防御が可能と言えますが、防御を最大限に高めるにはSSLインスペクションが必要です。以前の記事、{% post_link ssl-inspection2 %} で記載した通り、ZIP化されたマルウェアはSSLインスペクションが行えなければ検知は出来ません。

## アプリケーションフィルタについて

XGのアプリケーションフィルタは、XGの左ペインメニューの{% label @アプリケーション %}から確認できます。ブラウザーではないインターネットに接続するアプリケーションを対象にしています。ここの挙動の確認は非常に難しいものがあります。例えば、MicrosoftのOneDriveを題材にテストしてみましょう。

OneDriveのURLは、現時点で、`https://onedrive.live.com/`です。Webフィルタで当該ドメインのフィルタを行うと、想定通りブラウザーからOneDriveにはアクセス出来ません。

{% asset_img onedrive.png alt %}

しかし、Android端末のOneDriveアプリ経由では制御が効かず画像をコピーできてしまうこと、WindowsPCのエクスプローラーのOneDriveフォルダからこの画像は削除出来てしまいます。これはアプリが使うWebAPIのURLとブラウザが使うURLとは異なるためにこういった事象が発生します。検証のためにWebフィルタは削除、アプリケーションフィルタにOneDriveの項目があるので、そちらをフィルタしてみます（これは検証作業なのでこのブログをご覧の方が実施する作業ではありません）。

XGの左ペインメニューの{% label @アプリケーション %}からファイアウォールルールで選択されているポリシーの先頭で{% label @追加 %}ボタンをクリックし、{% label @スマートフィルタ %}に`onedrive`と入力し、Enterキーを押します。

{% asset_img appfilter2.png alt %}

OneDriveのルールがいくつか表示されるため、{% label @アクション %}は、"拒否"を選択して最後に"保存"をクリックします。この作業の結果は以下の通りの挙動でした。

- ブラウザからOneDriveに接続不可
- WindowsエクスプローラーからOneDriveのツール上ではファイルの追加および削除不可
- AndroidからOneDriveのファイル追加不可だが、**削除可能**

これらの事から、アプリケーションフィルタは、アプリが利用しているAPIのURLやデータの中身を見て挙動の制限を行っている事がわかります。OneDriveはファイルのアップロード・ダウンロードと目的によって分かれていましたが、他のアプリケーションであるAppleのiCloudDriveに関しては、アプリケーションフィルタは1種類だけです。このようにアプリケーションフィルタは、アプリの作り方に左右されるものとなります。AndroidはSSLインスペクションが行えないため、URL（SNI）の検証は行えますが、データの中身はhttpsで暗号化されておりファイル削除については制御出来ません。アプリケーションフィルタの中には、"EXE File Download"というフィルタも存在しますが、あくまで汎用的なものです。全てのいかなるアプリケーションからのEXEファイルのダウンロードを禁止できるものではありません。

{% note info  %}

Webフィルタ・アプリケーションフィルタを完全に動作させるには、SSL/TLSインスペクションが必要です。

{% endnote %}

このアプリケーションは止めておきたいというニーズに対して、都度メンテナンスしていくのはとても大変です。従い、高リスクのアプリケーションを拒否するという設定を行う事になります。具体的な設定については、こちらの記事、{% post_link best-practice %}を参照してください。

