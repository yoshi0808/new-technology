---
title: XG FirewallのWebフィルターとアプリケーションフィルタについて
tags:
  - XG Firewall
categories:
  - Security
date: 2020-05-06 14:54:00
---

{% note success  %}

## この記事で実現する内容について

　XG Firewallのレイヤ7ファイアウォールとしてのメインでもある、Webフィルター、アプリケーションフィルターについてそれぞれの違い、および活用方法について理解を深めます。

{% endnote %}

<!-- more -->

{% note primary no-icon %}

## XGのWebフィルターについて

{% endnote %}

　XGの左ペインメニューでは、{% label info @Web %}、{% label info @アプリケーション %}とそれぞれ分かれています。{% label info @Web %}ではサイトのカテゴリが分かれていて、そのサイトのカテゴリによっては閲覧させないという使い方が一般的な使い方のように見えます。これらのポリシーは、[Sophosのサイト「Sophos XG Firewall: Web カテゴリ」](https://community.sophos.com/kb/ja-jp/134155)にも日本語の解説があります。サイトのカテゴリについては、ビジネス、ギャンブル、ゲーム、アダルト、ファイナンス等多岐に渡ります。ホームユーザーとしてはいわゆる怪しいサイトや過度な広告をフィルタする事が主目的になるかとおもいます。

　上記サイトのポリシーを眺めていると疑問に感じるところがあります。「ActiveX」、「Applets」、「SpamURLs」です。サイトのポリシーで判断しているのかと思いきや、ActiveXやAppletは単純にサーバー名とも関係ありません。企業やサイトの目的ではなく、そこに配置したコンテンツの内容まで判断するように見えます。サイトのカテゴリに関係なく、そこにSpamがある場合は排除される事のようですから、そのあとのフォルダ構成を含めたURLまで対象としているように見えます。

　上記サイトの{% label info @Sophos XG Firewall:Webカテゴリ %}には記載がないものの、XGの左ペインメニューの{% label info @Web %}の{% label info @ファイルタイプ %}の内容には、ファイル拡張子、MIMEヘッダーの情報が並びます。そしてここにはZIPファイルなどの{% label info @Compressed Files %}、Windowsの実行ファイルである{% label info @Executable File %}などの項目が並んでいます。

　ホームユーザーとしては、ZIPファイルやEXEファイルが使えないと不便なのでフィルタする事は考えにくいですが、何らかのMIMEタイプを拒否するポリシーを作成する場合は有効に機能しそうです。最終的には、Webフィルターは以下の種類の分類となります。

- Webカテゴリ
- URLグループ（自身で作成したURLの集まり）、280blockerなどのURLデータベースもこのグループ
- ファイルタイプ
- ダイナミックカテゴリ（ActiveX・Applets・Cookies・HTTP Upload

　これらの事から、Webフィルターはカテゴリの分類という主目的はあるものの、ブラウザを対象としたフィルタの機能である事がわかります。

{% note primary no-icon %}

## SNIとWebフィルターについて

{% endnote %}

　SNIとは、Server Name Indicationの略です。SSL/TLS通信において、クライアントからサーバ証明書を要求する時に{% label info @暗号化せず %}情報がサーバーに渡されます。XGはこのSNIを見てWebフィルターを行っていますので、SSLインスペクションが行えなくともURLでアクセス許可・不可の判断は可能になります。全てのWebサーバーがSNIに対応しているわけではありませんが、SSLインスペクションが行えないAndroid端末であってもある程度の許可・不可の制御は可能となります。しかし、以前の記事、{% post_link ssl-inspection2 %} で記載した通り、ZIP化されたマルウェアは検知できないなどSSLインスペクションを使わないと完全ではありません。

{% note primary no-icon %}

## XGのアプリケーションフィルターについて

{% endnote %}

　XGのアプリケーションフィルターは、XGの左ペインメニューの{% label info @アプリケーション %}から確認できます。ブラウザーではないインターネットに接続するアプリケーションを対象にしています。ここの挙動の確認は非常に難しいものがあります。

　例えば、MicrosoftのOneDriveを題材にテストしてみましょう。

　OneDriveのURLは、現時点で、{% label info @https://onedrive.live.com/ %}です。Webフィルターで当該ドメインのフィルターを行うと、想定通りブラウザーからOneDriveにはアクセス出来ません。たまにはAndroid端末でやってみます。設定通り、Android版FireFoxからは接続出来ませんでしたので、その画面をキャプチャしています。

{% asset_img onedrive.png alt %}

　次にキャプチャ画像を、{% label info @Android端末にインストールしてあるOneDriveアプリ経由で画像をコピーし %}、このブログに掲載しています。最後に、{% label info @WindowsPCのエクスプローラーのOneDriveフォルダからこの画像は削除出来てしまいました %}。

　え？という話なんですが、OneDriveのアプリからはURL制限とは無関係にアクセス出来ています。

　今度は別の検証のために、Webフィルターは削除、アプリケーションフィルターにOneDriveの項目があるので、そちらをフィルターしてみます。

　XGの左ペインメニューの{% label info @アプリケーション %}からファイアウォールルールで選択されているポリシーの先頭で{% label info @追加 %}ボタンをクリックし、{% label info @スマートフィルタ %}に{% label info @onedrive %}と入力し、Enterキーを押します。

{% asset_img appfilter2.png alt %}

　そうすると、OneDriveのルールがいくつか表示されるため、{% label info @アクション %}は、{% label info @拒否 %}を選択して最後に{% label info @保存 %}をクリックします（これは検証作業なのでこのブログをご覧の方が実施する作業ではありません）。

　この作業の結果は以下の通りの挙動でした。

- ブラウザからOneDriveに接続出来ない
- WindowsからOneDriveのツール上（エクスプローラー上のファイル）ではファイルの追加、削除は行えない
- AndroidからOneDriveのファイル削除は可能だが、追加は行えない

　これらの事から、アプリケーションフィルタは、アプリが利用しているAPIのURLやデータの中身を見て挙動の制限を行っている事がわかります。また、OneDriveはファイルのアップロード、ダウンロードと目的によって分かれていましたが、AppleのiCloudDriveに関してはアプリケーションフィルタは1種類だけです。このようにアプリケーションフィルターは、アプリの作り方に左右されるものとなります。そして、SSLインスペクションが行えないAndroidはファイル削除について制御出来ていません。

　アプリケーションフィルターの中には、{% label info @EXE File Download %}というフィルタも存在しますが、あくまで汎用的なものであって、全てのいかなるアプリケーションからのEXEファイルのダウンロードを禁止できるものではありません。

　これらを理解できても、それを実践するのは難しいものです。ホームユーザーとしてリスクを抑制しつつ利便性を高めるには、どのようなフィルターを作っていくべきでしょうか。たくさん存在するアプリケーションを都度設定するのは管理も非常に大変で現実的ではありません。

　Webのカテゴリについては、個人の考え方でいろいろなフィルタの組み合わせがあるでしょう。そちらについてはご自身のポリシーでカスタマイズいただければとおもいます。

　但し攻撃から身を守るという課題については、ある程度のスタンダードはあるかとおもいますので、Sophos Communityなどの情報を頼りにホームユーザーのためのお勧め設定について次回に記載したいとおもいます。
