---
title: 無償版ESXiのVMをQNAP NASにバックアップ
tags:
  - ESXi
  - QNAP
categories:
  - Software
date: 2021-12-04 08:00:00
---


{% asset_img title.png 1024 alt %}

<p class="onepoint">この記事で実現すること</p>

QNAPより無償版ESXiの仮想マシン（VM）バックアップが可能なHyper Data Protector(HDP)という無償ソフトウェアが提供されています。Windows Server2016および2019のHyper-Vにも対応しています（Windows10のHyper-Vには対応しません）。無償版ESXiのバックアップソフトは「{% post_link esxi-nakivo %}」で書いた有償のもの（1年期限の無償版）は存在します。無償バックアップソフトは無償版ESXiに対応していないという難しい状況でしたが、NASが必須という前提はあるものの、無償ESXi×無償バックアップソフトウェアが登場してきました。エージェントレスで、ESXi本体やVMには何もインストールする必要はありません。まだ製品として安定していませんが、この記事ではESXiのVMをQNAPのNAS上にバックアップする方法をまとめています。なお、別のNASメーカーであるSynologyからもActive Backup for Businessという製品が提供されています。

> QNAP
 <https://www.qnap.com/ja-jp/software/hyper-data-protector>
> Synology
 <https://www.synology.com/ja-jp/dsm/feature/active_backup_business>

<!-- more -->

## 稼働条件

1. HDPは現在x86ベース（IntelまたはAMD）のNAS QTS 4.4.3（またはそれ以降）のみ対応しています、またはQuTS hero h4.5.0（以降）を搭載したQuTS hero NASのみ対応しています。
2. VMware ESXiは6.5、6.7、7.0が対象です

## 直近のHDPのアップデート

アップデートのリストは以下を参照してください。

> QNAP Hyper Data Protector リリースノーツ（英語）
 <https://www.qnap.com/ja-jp/app_releasenotes/list.php?app_choose=HyperDataProtector>

## HDPの主要な機能について

1. VMのバックアップを複数世代管理
2. ジョブスケジューリング機能
 ワンタイム、定期、日次、週次、月次を利用できます。
3. 重複排除（データ圧縮）
 ストレージレベルの重複排除ではありません。VMに対してのデータ圧縮を重複排除と表現しています。
4. 暗号化転送
5. バックアップデータの暗号化

## QNAP NASの事前準備

### HDPのインストール

QNAPのWeb画面に管理者としてログインし、AppCenterから"Hyper Data Protector"をインストールします。なおContainerStationが合わせてインストールされます。
{% asset_img install.png 1024 alt %}

上記はインストール済みの状態ですが、{% label primary@「＋ インストール」ボタン %}をクリックしてインストールします。
必須要件のContainerStationがインストールされると物理ネットワークカードに対し仮想ネットワークが自動構築されます。既存端末から手動でのルーティング設定は不要でQNAP自身がProxyのように振る舞います。QNAPのQuFirewallを利用している場合は追加設定が必要となる場合があります。


### 共有フォルダの設定

バックアップデータを保存する共有フォルダを作成します。{% label primary@コントロールパネル %}を起動し、{% label primary@権限設定 %}-{% label primary@共有フォルダ %}へと進み、{% label primary@作成 %}ボタンをクリックします。

{% note info  %}
#### 可用性および機密性向上のために

- バックアップデータが肥大化して他のファイル共有サービスなどに影響を与えないよう、バックアップ計画に基づいたデータ容量を計算の上で、HDP専用のディスクボリュームを作成される事をお勧めします。
- HDPの運用には管理者権限を持ったユーザーが必要です。セキュリティ向上のため、HDP専用ユーザーを新規作成しフォルダへのアクセス権を最小限にし、各種ネットワークサービスを無効化される事をお勧めします。また、HDP管理画面へのログインは2要素認証に対応しています。
{% endnote %}

1. バックアップデータを保存したいディスクボリュームを選択し、フォルダ名を指定します。私の例では事前にディスクボリュームを作成しています（次項で説明します）。
 {% asset_img share-folder1.png 640 alt %}
 バックアップ領域を暗号化するのであれば、このタイミングで暗号化を選択（チェック）し、パスワードを設定、暗号化キーの保存を選択（チェック）します。

2. 共有フォルダにアクセス可能な管理者ユーザーを指定します。この例ではhdpという管理者アカウントを作成しており、そのアカウントに共有フォルダのアクセス権を加えています（この手順ではユーザーの作成は省略しています）。
 {% asset_img share-folder2.png 640 alt %}
3. フォルダのオプションを設定します。
 {% asset_img share-folder3.png 640 alt %}

この記事の後半で暗号化有無によってバックアップのパフォーマンスの検証を載せますが、バックアップ速度は殆ど変わりません。

### 専用ディスクボリュームの設定（任意）

前述したとおり、バックアップ計画に基づき割り当てるディスクボリュームを設定します。

1. {% label primary@ストレージ＆スナップショット %}を起動し、左ペインメニューの{% label primary@ストレージ＆スナップショット %}から{% label primary@作成 %}ボタンをクリックし、ディスクボリュームを作成するストレージプールを選択します。
 {% asset_img volume1.png 800 alt %}

2. ボリュームのエイリアス名を指定し、ボリューム容量を決定します。
 {% asset_img volume2.png 640 alt %}

3. {% label primary@次へ %}ボタン、続いて{% label primary@完了 %}ボタンをクリックしてボリュームを作成します。

HDPはバックアップ時の圧縮が可能ですので、目安としてはVMのシンプロビジョニングの容量×世代数で圧縮率が50％〜70％程度を目標にするのがよろしいかと思います。シックプロビジョニングであれば圧縮率が高い事が期待されます。私の環境では64GBのWin10、40GBのSophos Firewall、256GBのUbuntuと合計360GBのVMが最終的に62.73GBまで圧縮されています。Ubuntuの実態はおそらく数GBしかなく、シック プロビジョニング (Lazy Zeroed)は相当に圧縮率が高くなると思われます。一旦テストでバックアップを取得され、圧縮結果を確認のうえ、世代数を乗じたものをボリューム容量とされるのが1つの方法かとも思われます。

私の場合、最低半年の月毎のバックアップを6世代、直近月内の週毎のバックアップを4世代と考え、合計10世代としています。計算上は640GB、もちろん今後アプリケーションやデータを追加していけばVMは膨らんでいくので、目安として1TBを確保しています。

## ESXiの事前準備

ESXiには以下の設定が必要です。

1. HDPからESXiに対しHTTPS(Port443)、SSH(Port22)を使って接続可能なように設定します。
2. HDPがバックアップするVMはCBT(Changed Block Tracking)を有効にしなければなりません。
3. （任意）セキュリティ向上のため、ESXi上に管理者アカウントを作成します。
4. （任意）セキュリティ向上のため、接続可能なIPアドレスをESXi上のFirewall設定で絞ります。

### ESXi上でHTTPS、SSHの解放

無償版ESXiを使う場合はブラウザから基本はvSphere Web Clientを使いますので、HTTPS(Pprt443)の解放は特に意識する必要はありません。ESXiのファイアウォールで接続可能なIPアドレスを絞っている場合はQNAP NASのIPアドレスから接続できるようにしておきます。

SSH(Port22)についてはESXiはデフォルトでサービス停止されている状態ですので、シェルおよびSSHのサービスを起動します。
左ペインメニューの{% label primary@ホスト %}ー{% label primary@管理 %}の{% label primary@サービスタブ %}から{% label primary@TSM %}および{% label primary@TSM-SSH %}を起動します。
 {% asset_img esxi1.png 800 alt %}
この2つのサービスは右クリックメニューの{% label primary@ポリシー %}から{% label primary@ホストと連動して起動および停止します %}をチェックしておく事でESXiの起動時に自動的にサービスが起動するようになります。

### VMのChanged Block Trackingの設定

事前にVMのデータを退避することをお勧めします。VMを停止のうえで、データストアブラウザからVMの入っているフォルダ毎別の場所にコピーしてください。もし、設定の変更でVMを壊してしまった場合は、当該フォルダの`VM名.vmx`を右クリックから「VMの登録」で再登録できます。{% post_link esxi-backup %}を参考にghettoVCBなど無償ツールでバックアップを取る事も可能です。

ESXiの機能であるChanged Block Tracking(CBT)はVMが稼働していて前回バックアップしたものから未更新のディスクブロックをスキップして差分のみバックアップする機能です。途中で別のバックアップ製品によるバックアップ、例えばghettoVCBなどでバックアップされると、次回のバックアップはフルバックアップを行います。

最初にVMがインストールされているディスクを調べ、そのSCSI-IDを確認します。
ESXi管理画面のVMを選択し右クリックして{% label primary @設定の編集 %}をクリックします。
{% asset_img esxi2.png 640 alt %}

{% label primary @ハードディスク %}の詳細を開き、{% label primary @コントローラの場所 %}でSCSI-IDを確認します（SCSI(0:0)など）。

1. VMを停止します。
2. ESXi管理画面のVMを右クリックして、{% label primary @設定の編集 %}をクリックします。
3. {% label primary @VMオプション %}タブをクリックします。
4. {% label primary @詳細 %}セクションを開き {% label primary @設定パラメータ %}の{% label primary @設定の編集 %}をクリックします。{% label primary @設定パラメータ %}ダイアログが開きます。
5. {% label primary @パラメータの追加 %}をクリックします。
6. `ctkEnabled`パラメータを追加して、その値を`true`に設定します。
7. さらに{% label primary @パラメータの追加 %}をクリックし、`scsi0:0.ctkEnabled`を追加して、その値を`true`に設定します（環境に合わせて`scsi0:0`の内容は変更してください）。
8. OKボタンをクリックし設定を完了させます。
9. VMを起動します。
10. SSHでESXiに入り、VMが配置されているディレクトリで、`VM名-ctk.vmdk`ファイルがあることを確認します。

CBTを無効にする場合はこの逆の手順、ctkEnabledの値をfalseに設定します。
VMWareによるCBTの説明は以下を参照してください。
> VMware VM上の変更ブロックのトラッキング（CBT） (1020128)
 <https://kb.vmware.com/s/article/1031873?lang=ja&queryTerm=changed+block+tracking>

### （任意）管理者アカウントの作成

セキュリティの観点からrootはできるだけ使わない事をお勧めします。これは一般論でありrootがよく知られたユーザー名だからです。例えばQNAP-NASからESXiのrootユーザーの情報が漏洩しないようにrootを使う機会を減らすべきです。以下の手順で管理者アカウントを作成します。

1. 管理メニューの左ペイン{% label primary @ホスト %}ー{% label primary @管理 %}から{% label primary @セキュリティとユーザー %}に進み、{% label primary @ユーザー %}から{% label primary @ユーザーの追加 %}をクリックします。
{% asset_img esxi5.png 800 alt %}
2. HDPから接続する専用のユーザー名とパスワードを登録してユーザーの作成を終えます。
3. 管理メニューの左ペイン{% label primary @ホスト %}から{% label primary @アクション %}を選択し、プルダウンの{% label primary @権限 %}をクリックします。
4. さらに{% label primary @ユーザーの追加 %}を選択します。実際には上記で作成したユーザーと同一名のユーザー名を入力します。ロールについては"システム管理者"を選択します。
{% asset_img esxi4.png 800 alt %}

これで新しいユーザーが作成できたので、Web管理画面からログイン可能か確認してください。rootユーザーは長めのパスワードを再設定し、パスワード管理ソフトに登録し普段は使わないようにします。普段から使わずにパスワードを封印しておけばより安全になります。

### （任意）SSH、Web Clientのために接続可能なIPアドレスを絞る

この機能はESXiではファイアウォールと呼ばれ、Linuxのiptablesやufwと同様にシンプルなものです。ホームユーザーはシンプルなLANで閉じられたアクセスですが、安全のために特にSSHは設定を検討すべきです。
Web管理画面の左ペインメニューの {% label primary @ネットワーク %}を選択し、{% label primary @ファイアウォール %}タブをクリックして見つける事ができます。デフォルトでは一切の制約なく接続可能になっていますので、ここでSSHとWeb Clientに接続可能なIPを登録できます。

{% asset_img esxi3.png alt %}

## HDPへのログイン

QNAP-NASでHDPを起動するとHDPのログイン画面が表示されます。
{% asset_img hdp1.png alt %}

2要素認証を設定されている方には「2段階認証」のポップアップが表示されます。6桁のワンタイムパスワードを入力しログインします。

以下はログイン直後のメインページです。
{% asset_img hdp2.png alt %}

| ネットワーク   | 内容                                                                                                       |
| -------------- | ---------------------------------------------------------------------------------------------------------- |
| インベントリ   | ESXiのホストおよび登録されているVMを選択します                                                             |
| リポジトリ領域 | QNAP-NASの共有フォルダを選択し、そこにバックアップデータを登録します。複数の保存先が設定できます           |
| バックアップ   | バックアップジョブを作成します。同一のVMについて周期の異なるジョブやリポジトリを変えたジョブを作成できます |
| 復元           | バックアップからESXiにVMを復元します                                                                       |
| ジョブの状態   | バックアップジョブ毎のジョブ状態を表示します                                                               |
| システム       | イベントログが表示されます                                                                                 |

## インベントリ登録

ここでは、任意の名前、ESXiのIPアドレス、ESXiにログインするユーザーおよびパスワードを指定し、登録します。
{% asset_img hdp3.png 800 alt %}

登録が無事完了するとVMの数が表示されます。

## 　バックアップリポジトリ登録

既に作成してある共有フォルダを指定します。画面右上の{% label primary @バックアップリポジトリの追加 %}ボタンをクリックします。
{% asset_img hdp4.png 640 alt %}

{% label primary @選択 %}ボタンをクリックし、共有フォルダを選択します。バックアップデータを暗号化しない場合は{% label primary @データ暗号化を有効にする %}のチェックボックスが空白になっています。NASの共有フォルダを暗号化している場合はチェックボックスが選択された状態になっています。

## 　バックアップ

いよいよバックアップです。
{% asset_img hdp5.png 640 alt %}
画面右上の{% label primary @ジョブの作成 %}ボタンをクリックし、ジョブを構成します。

1. VMの選択
 VMとバックアップ先のリポジトリを設定します
 {% asset_img hdp6.png 640 alt %}

2. スケジュール
 {% label primary @スケジューラー %}、{% label primary @リンクしたジョブの後に実行 %}、{% label primary @スケジュールなし %}を選択します。
 {% asset_img hdp7.png 640 alt %}
 少し気づきづらいですが、画面上部の {% label primary @スケジュール %}の隣に{% label primary @保持 %}とあります。ここをクリックすると、以下の通りバックアップの保存期間を設定可能です。
 {% asset_img hdp8.png 640 alt %}

3. ルール
 バックアップ時のデータ転送に関する暗号化や圧縮について設定します。
 {% asset_img hdp9.png 640 alt %}
 {% label primary @全VMに対しVMware CBTを有効にする %}では以下の説明があります。
「VMware CBT (Changed Block Tracking) は、Hyper Data Protectorがバックアップを実行する時には有効になっていなければなりません」
 また、{% label primary @アプリケーションアウェア処理の有効化 %}とあります。VSSというのはWindowsのVolume Shadow Copy Serviceを指しています。スナップショットなどを取得する場合、VSSに対応したアプリケーションに対して一旦データ書き込みなどを待たせるなどの命令を出し、アプリケーションのデータ一貫性を保つ機能です。バックアップ対象がWindowsの場合に意味があります。詳しくは以下の記事を参照してください。
 > Microsoft
 https://docs.microsoft.com/ja-jp/windows-server/storage/file-server/volume-shadow-copy-service

1. 要約
 設定した内容を確認し、スケジューリングしたものを保存するか、すぐにバックアップを取得するかを選択します。
 {% asset_img hdp10.png 640 alt %}

HDPのデザインですが、以下の注意事項があります。

{% note warning %}

- ESXiのVMのバックアップはESXi上でほぼ同じサイズのコピーを作成します。従い、ESXiのデータストアはVMの分だけ空きを残している必要があります。ストレージが不足していても単にバックアップエラーとなり原因に悩みますのでご注意ください

{% endnote %}

メニューの{% label primary @ジョブの状態 %}、{% label primary @システム %}ではバックアップの状況やエラーログを確認できます。また、HDPの右上のメニューから通知の設定ができますので、スマホなどへの通知設定をお勧めします。

バックアップ所要時間ですが、リポジトリ暗号化なし、転送時暗号化あり、圧縮なしのオプションで64GBのWindows10のバックアップに18分程度掛かりました。私の環境はHDDとQtierと呼ばれるNVMeとの動的な組み合わせになっており、少し特殊な環境であり、参考までに留めていただければと思います。

## 復元

復元メニューからジョブの作成を行います。まず最初に復元するジョブと復元するVMの場所を指定します。

 {% asset_img hdp11.png 640 alt %}

バックアップジョブ（リポジトリ）に含まれている対象のバックアップを選択します。

 {% asset_img hdp12.png 640 alt %}

復元先はデフォルトでバックアップしたESXiが選択されています。

{% asset_img hdp13.png 640 alt %}

{% label primary @ターゲットの編集 %}をクリックして、VMストレージ先の変更や新しい場所に（別のVMとして）復元する事も可能です。ここでも戻す際のESXi上のデータストアの容量には気をつけてください。

続いてスケジュールが必要であれば設定します。
{% label primary @ルール %}設定では、VMを上書きするか名前の変更して別名で登録するかを選びます。

{% asset_img hdp14.png 640 alt %}

復元されたVMを自動的に起動するというオプションもあります。これは上書きで戻す場合には使い勝手が良いですが、複製を作る場合はvSwitchにおける仮想NICが変わる事やIPアドレスの重複の可能性に留意する必要があります。もちろんOSのライセンス上の問題もありますので注意が必要です。

最後にジョブを作成するかすぐに復元するか選択します。

## HDPを使った感想

HDPは有償版ESXiのvStorageAPIを使ったバックアップのように高機能ではありませんが、日次・週次のバックアップなどホームユーザーが利用するための必須条件は押さえていると思います。
