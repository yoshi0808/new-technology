---
title: XG FirewallでIPv6の設定を行う（後半）
tags:
  - IPv6
  - XG Firewall
categories:
  - Security
date: 2020-04-29 20:13:18
---
<p class="onepoint">この記事で実現すること</p>
XG Firewall配下のクライアントにIPv6アドレスを配布し、インターネット接続を可能とし、同時にSSLインスペクションを設定します。

<!-- more -->

## XGのIPv6

IPv6は一般的に内部のホストに対してもパブリックIPアドレスを割り当てます。IPv6独自の工夫として、端末を特定されないために一時アドレスを割り当てます。一時アドレスは端末再起動時に変更され、外部からホストの特定を防ぐ目的があります。IPv4の枯渇が課題だったがために、到達性と安全面を考慮した設計と推察されます。

一方、XGのIPv6の考え方としてはNATを前提にします。内部ホストから外部に出ていくものはSNAT（Source NAT）、公開するホストはDNAT（Destination NAT）で外部から内部ホストに転送するという原則があります。LAN側のIPv6にはプライベートIPの考え方に近い、ユニークローカルアドレス（ULA）を用います。

ULAは、プライベート環境で自由に割り当てして良いというわけではなく、なるべく世界の中で一意にすべきという考え方です。企業向けとしては合併などがあった場合に重複しない事を前提としています。`192.168.1.0/24`のように、誰でも使って良いアドレスとは異なるのがIPv6のULAです。このULAは一定のルールに従い機械的に生成する必要があります。

## XGのIPv6を構成するまでの流れ

以下の流れでXGのIPv6をセットアップします。

1. ULAを生成
2. XGのLAN側のIPアドレスにULAを設定
3. LAN側ホストにIPv6を割り当てるためのDHCPv6、ルーターアドバタイズメント（RA）の設定
4. Firewallルールの設定
5. 固定IPv6アドレスの登録
6. SSLインスペクションの設定

## ULAを生成する

ULAの生成にはネットワークカードのMACアドレスが必要です。仮想環境で構築している方は仮想MACアドレスではなく、可能な限り衝突を避けるべく、物理マシンのMACアドレスを使ってください。

物理マシンに直接XGをインストールしている方は、XGの左ペインメニューの{% label @ネットワーク %}から{% label @インターフェース %}の"Port1(LAN)"を選択し、{% label @詳細設定 %}をクリックするとMACアドレスが確認出来ます。

{% asset_img mac1.png alt %}

仮想環境の場合、ESXiを例に挙げると、以下のようにLAN側物理MACアドレス（当方の環境では、vmnic1）にMACアドレスがあります。

{% asset_img mac2.png alt %}

ULAの生成は以下の通り過去記事でツールを置いてありますので、上記MACアドレスをコピーし、過去記事のULA生成ツールにMACアドレスを貼り付け、ULAを求めて下さい。

{% post_link ipv6 %}  

結果として、以下のような情報が得られるので、First IPv6 Addressの`fd`から始まるULAを控えてください。

``` bash
First IPv6 Address-> fd00:beaf:cafe::1/64
```

## LAN側IPv6アドレスにULAを設定

XGの左ペインメニューの{% label @ネットワーク %}の{% label @インターフェース %}にある、{% label @IPv6設定 %}のチェックボックスをチェックします。次に、{% label @IPv6　プレフィックス %}の項目に生成したULAを貼り付け、`/64`の部分を削除してください。画面を見てもらえると解りますが、IPv6のサブネット{% label @/64 %}は画面上で固定表示されています。

{% asset_img ula1.png alt %}

このアドレス体系は以下の通りです。

1. IPv6の体系は128ビットで、ユニキャストアドレスは1つのセグメントが64ビットとなります。XGでも64ビットで扱います。
2. 48ビットのULAに16ビットの内部サブネット`0000`を加え、64ビットプレフィックスを定義しています。別のサブネットにするのであれば、ここを`0001`などとしていきます<sup>**[[1]](#note1)**</sup>。
3. IPv6における、デフォルトルーターは、リンクローカルアドレスの1とするのが一般的です（`fe00::1`）。これに倣い、XG自身のIPv6アドレスの後半64ビットのインターフェース識別子は`0000:0000:0000:0001`としています。
4. `::`は、IPv6アドレスの`0000`が続く部分を省略できるものです。（例）`fd00:beaf:cafe:0000:0000:0000:0000:0001/64`の連続する`0`部分を省略し、`fd00:beaf:cafe::1/64`としています。

保存ボタンをクリックし、LAN側のインタフェースにIPv6を割り当てます。

## RAおよびDHCPv6の設定

### DHCPv6の設定

クライアントにIPv6のアドレスを配布します。SSLインスペクションが行えるクライアントは固定IP範囲を明示的に割り当てます。XGの左ペインメニューから{% label @ネットワーク %}、{% label @DHCP %}と進み、{% label @サーバー %}の"追加"ボタンをクリックします。次にIPv6のタブをクリックし、以下の画面の通り入力していきます。

{% asset_img dhcp.png alt %}

1. {% label @名前 %}は、IPv6のDHCPと分かるよう命名してください。
2. {% label @インターフェース %}は"Port1"を選択してください。すでに割り当てられているXGのIPv6アドレスが表示されます。
3. {% label @ダイナミックIPリース %}は、自動割り当てするIPv6アドレスの範囲を入力します。IPv4は10進数で表示する事が多いですが、IPv6は16進で表示する事になるので、ログを見た時に解りやすいIPアドレス体系となるような構成にされる事をお勧めします。
4. {% label @スタティックIPのDUIDマッピング %}は後ほど入力します。一旦は空のままにしておいてください。
5. {% label @DNSサーバー %}は、XGのLAN側IPv6アドレスを指定して下さい。内部ホストの名前解決のために必要です。

### RAの設定

クライアントにDNSの通知を行うため、RAの設定を行います。DHCPで明示的にIPv6アドレスを指定しないクライアントはRAにより自身のIPv6アドレスを自動生成しつつ、ゲートウェイ、DNSの情報を受け取ります。RAでは、マネージドフラグ（Mフラグ）、アザーフラグ（Oフラグ）という言葉が登場します。

| Flgの説明 | 内容                                                                                                                                                                                                                  |
| --------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Mフラグ   | DHCPv6によって明示的に割り当てたステートフルなIPv6アドレス（ON）にする（※IPv4のDHCPと同じ）か、RAによってPrefixが通知され、クライアントは自分のMACアドレスから生成するステートレスIPアドレスにする（OFF）かを決めます |
| Oフラグ   | IPアドレス以外の情報をDHCPv6サーバやRAから取得する（ON）、取得せず手動設定（OFF）                                                                                                                                     |

比較的時間の流れがゆっくりなIPv6において、最近のトレンドとしては、DHCPv6を使わずRAのみとする（Mフラグ＝OFF、Oフラグ＝ON）が定番です。長いIPv6アドレスの管理は大変なので、この設定が一番楽な管理方法です。しかし、私のXGに関する記事ではSSL/TLSインスペクションを最も重要視しています。MACアドレスをベースにクライアントでIPv6アドレスが生成されると、XGでCA証明書が登録されている端末か否かの判断が行えません。よってMフラグ＝ONとし、XGがIPv6アドレスを管理する、ステートフルなIPv6アドレスとする必要があります。OフラグがOFFの場合はDNSの情報は手動設定であり、ステートフルなプロトコルを受け付け出来ないという解釈です。

結論としては、**ステートフルなDHCPv6で全てを管理するため、Mフラグ＝ON、Oフラグ＝ONとなります**。やや管理者寄りの理論です<sup>**[[2]](#note2)**</sup>。また、IPv6では上述した通り、一時IPv6アドレスというものが存在します（XG上では匿名）。これを認めると、クライアントが再起動の度にIPアドレスが変わり、SSLインスペクションを迂回されてしまいますからこの一時アドレスの設定もOFFにします。XGの左ペインメニューの{% label @ネットワーク %}から、{% label @IPv6ルーターアドバタイズ %}を選択し、"追加"ボタンをクリックし、以下の図のように登録していきます。

{% asset_img ra.png alt %}

1. {% label @インターフェース %}は、"Port1"を選択します
2. {% label @マネージドフラグ %}にチェックします
3. {% label @アザーフラグ %}にチェックします
4. {% label @デフォルトゲートウェイ %}にチェックします
5. {% label @アドバタイズ設定のプレフィックス %}の{% label @プレフィックス %}には、今回作成した、ULA（例）`fd00.dead.beaf::`を入力します。また、一時アドレスは使わないので{% label @匿名 %}のチェックを外します
6. 保存をクリックし、設定を完了させます

## Firewallルール設定

ここまでの設定で、DHCPv6によるIPv6アドレスが割り振られています。インターネットにIPv6で接続するためには、Firewallルールの設定が必要となります。XGの左ペインメニューの{% label @ルールとポリシー %}で"IPv6"をクリックします。

{% asset_img rule1.png alt %}

{% label @ファイアウォールルールの追加 %}から"新しいファイアウォールルール"をクリックします。
ここでの設定内容は、過去の記事、{% post_link rule-policy2 %}でIPv4について設定した内容と変わりません。"To Internet"というルールを作りましたが、同じ内容になります。

1. ルール名はここでは"To_Internet_IPv6"とします。
2. 送信元ゾーンには、"LAN"を設定します。VPNを使う方は"VPN"も加えてください。宛先ゾーンは"WAN"を指定します。
3. IPv4でもリンクNATは使いませんでしたが、IPv6においても利用しません。
4. セキュリティの"Webフィルタリング"をクリックし、詳細メニューをオープンします。

- Webポリシーは"Default Policy"を選択します（任意）
- "HTTPおよび復号化したHTTPSをスキャン"をチェックします
- "FTPのマルウェアをスキャン"をチェックします
- QUICプロトコルのブロックは任意選択です
    Googleのサービスで利用されています。私はチェックしています。Google自体は問題ないですがそのプロトコルを利用した悪質なサイトがFirewallを回避するリスクを減らすという意味で選択しています
- その他のセキュリティ機能でアプリケーションコントロールを選択します
    私は"Block very high risk(Risk Level 5) apps"を選択しています
- IPSは"lantowan_general"を選択します
- 保存ボタンをクリックします

続いて、NATルールの設定に移ります。{% label @ルールとポリシー %}の{% label @NATルール %}から"IPv6"をクリックします。ここでは、既にIPv6の自動設定された情報が"Default SNAT IPv6"という名前で登録されています。ルールを開いて、{% label @ルールのステータス %}のトグルスイッチをOnにしてください。最後に"保存"をクリックしてください。この段階ではSSLインスペクションの設定は出来ていませんが、IPv6で接続可能な状態になっています。

テストのために、[ipv6.google.com](https://ipv6.google.com/)が正しく表示出来るか確認してください。

## 固定IPアドレスの登録

端末にルート証明書を導入できる端末（Windows、macOS、iOS）のみに対してSSLインスペクションを行いますので、DHCPv6では、該当端末が常に固定のIPv6アドレスを持つための設定を行います。XGの左ペインの{% label @ネットワーク %}の{% label @DHCP %}から、"IPv6リース"の状況をみると、実際にIPv6のアドレスが割り当てられている一覧が確認できます。ここの"DUID"が端末固有情報であるため、この値を控えて、**DHCPv6の設定にIPv6とDUIDのペアを登録していく事になります**。ここでは、DUIDの値をメモしてください。残念ながら以下の通りDUIDの文字列が長すぎて、表記が見切れます。マウスをポイントしてポップアップされたDUIDをメモする必要があります。

{% asset_img dhcp1.png alt %}

再び、DHCPの設定画面で、{% label @IPv6 DHCP Server %}を選択します。以下のように、{% label @スタティックIPのDUIDマッピング %}の項目にDUIDとIPv6のセットを登録してください。

{% asset_img dhcp2.png alt %}

注意点としては、SSLインスペクションでIPアドレスの範囲を設定する事になりますので、一定の範囲でスタティックのIPv6アドレスを設定するようにしてください。

## SSLインスペクションの設定

IPv6のSSLインスペクションの設定を行います。まずは、IPv4で対応した時と同じように、SSLインスペクションの対象範囲のIPホストを登録します。XGの左ペインメニューの{% label @ホストとサービス %}から、{% label @IPホスト %}のタブで、{% label @追加 %}ボタンをクリックします。

{% asset_img host.png alt %}

上記の通り、SSLインスペクションのためのIPv6の範囲を"CA_Client_IPv6"として登録します。16進数のアドレス表記ですが、ここでもIPv4のアドレス体系に合わせておくと、ログを確認した時の視認性が上がります。続いて、XGの左ペインメニューの{% label @ルールとポリシー %}から{% label @SSL/TLSインスペクションルール %}に進み、"IPv6"をクリックします。以前の記事"{% post_link ssl-inspection1 %}"で、このSSLインスペクションルールを一度作成しています。ここにIPv6の設定を加える事になります。

{% asset_img rule2.png alt %}

上記のように、{% label @送信元ネットワークとデバイス %}に、今回作成した、IPv6のホスト群である、"CA_Client_IPv6"を選択して追加します。

これでIPv6に関する設定は完了です。IPv6についても、SSLインスペクションの対象となり、より多くのコンテンツフィルタが可能となりました。一度IPv4でXGのルート証明書を端末にインストールしてあれば、再度インストールする必要はありません。SSLインスペクションのための端末へのインストールについては、過去の記事"{% post_link ssl-inspection1 %}"を参照してください。

## 動作確認

IPv6サイトをブラウザ等で閲覧後、XGのログのログビューアを開き、プルダウンから、{% label @SSL/TLSインスペクション %}を選択します。

{% asset_img rule3.png alt %}

上記の通り、同じホストでもIPv4とIPv6の通信が混在している事、またSSLインスペクションの対象/対象外についてもログの内容を見て確認できます。

<small id="note1">**[1]**
ULAの48ビットに対するネットワークアドレスとして（例）`fd00:beaf:cafe:0000`を使うため、業務上実際に使う64ビットプリフィックスは（例）`fd00:beaf:cafe:0001::/64`から開始するのが一般的です。今回はホームユーザー向けの一例として出来るだけ簡素化する事を目的とし、短い文字列で済むようにサブネットに`0000`を設定にしています。そういう私も自分の環境では、Prefixの後半16ビットは`0001`以降の数字を使っています。</small>

<small id="note2">**[2]**
DHCPv6とRAの戦いというものがあって、RA派は合理化を目指す方向です。ネットワーク管理者がIPアドレスの管理をすべきでサーバー管理者がやるべきでないという論調です。DHCPv6派はクライアントが勝手にアドレスを決めるのは困るという理論です。Sophosには頑張ってもらって、もう少し簡単に証明書が入っている端末を区別できるように期待したいところです。</small>
