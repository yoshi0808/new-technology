---
title: XG FirewallでIPv6の設定を行う（後半）
tags:
  - IPv6
  - XG Firewall
categories:
  - Security
date: 2020-04-29 20:13:18
---


{% note success  %}

## この記事で実現する内容について

　XG Firewall配下のクライアントにIPv6アドレスを割り当て、IPv6でインターネット接続を可能とし、かつSSLインスペクションも有効にします。

{% endnote %}

<!-- more -->

{% note primary no-icon %}

## XGにおけるIPv6の考え方

{% endnote %}

　IPv6はその広大なアドレス空間によって、一般的にはNATを必要としていません。従い内部のホストに対してもパブリックIPアドレスを割り当て、IPv6独自の工夫として、端末を特定されないために一時アドレスを割り当てます。一時アドレスは端末再起動時に変更され、外部からホストの特定を防ぐ目的があります。IPv4の枯渇が課題だったがために、到達性と安全面を考慮した設計と推察されます。

　XGのIPv6の考え方としてはNATを前提にします。内部ホストから外部に出ていくものはSNAT（Source NAT）、公開するホストはDNAT（Destination NAT）で外部から内部ホストに転送するという原則があります。LAN側のIPv6にはプライベートIPの考え方に近い、ユニークローカルアドレス（ULA）を用います。

　ULAは、プライベート環境で自由に割り当てして良いというわけではなく、なるべく世界の中で一意にすべきという考え方です。企業向けとしては合併などがあった場合に重複しない事を前提としています。個人環境で絶対にインターネット側へ出ていかないのであれば、IPは何を割り振っても良いわけですが、誰かが使っている可能性のあるIPアドレス群を使うのはちょっと気持ちが悪いものです。192.168.1.0/24のように、誰でも使って良いアドレスとは異なるのがIPv6のULAです。このULAは一定のルールに従い、生成する必要があります。

{% note primary no-icon %}

## XGのIPv6を構成するまでの流れ

{% endnote %}

　以下の流れでXGのIPv6をセットアップしていきます。

 1. ULAを生成
 2. XGのLAN側のIPアドレスにULAを設定
 3. LAN側ホストにIPv6を割り当てるためのDHCPv6及び、ルーターアドバタイズメント（RA）の設定
 4. Firewallルールの設定
 5. 固定IPv6アドレスの登録
 6. SSLインスペクションの設定

{% note primary no-icon %}

## ULAを生成する

{% endnote %}

　ULAの生成にはネットワークカードのMACアドレスが必要です。仮想環境で構築している方は仮想MACアドレスではなく、可能な限り衝突を避けるべく、物理マシンのMACアドレスを使ってください。

　物理マシンに直接XGをインストールしている方は、XGの左ペインメニューの{% label info @ネットワーク %}から{% label info @インターフェース %}の{% label info @Port1(LAN) %}を選択し、{% label info @詳細設定 %}をクリックするとMACアドレスが確認出来ます。

{% asset_img mac1.png alt %}

　仮想環境の場合、ESXiを例に挙げると、以下のようにLAN側物理MACアドレス（当方の環境では、vmnic1）にMACアドレスがあります。

{% asset_img mac2.png alt %}

　ULAの生成は以下の通り過去記事でツールを置いてありますので、上記MACアドレスをコピーし、過去記事のULA生成ツールにMACアドレスを貼り付け、ULAを求めて下さい。

{% post_link ipv6 %}  

　結果として、以下のような情報が得られるので、First IPv6 Addressの{% label info @fd %}から始まるULAをCopyして下さい。

``` bash
First IPv6 Address-> fdxx:xxxx:xxxx::1/64
```

{% note primary no-icon %}

## XGのLAN側IPv6アドレスとしてULAを設定する

{% endnote %}

　XGの左ペインメニューの{% label info @ネットワーク %}の{% label info @インターフェース %}にある、{% label info @IPv6設定 %}のチェックボックスをチェックします。

　次に、{% label info @IPv6　プレフィックス %}の項目に生成したULAを貼り付け、{% label info @/64 %}の部分を削除してください。画面を見てもらえると解りますが、IPv6のサブネット{% label info @/64 %}は最初からXGの画面でデフォルト入力されています。

{% asset_img ula1.png alt %}

　このアドレス体系を簡単に説明します。

1. IPv6の体系は128ビットで、ユニキャストアドレスは1つのセグメントが64ビットとなります。XGでも原則64ビットのまま扱います。
2. 48ビットのULAに16ビットの内部のサブネットを0000として今回のULAのサブネットPrefixを完成させています。別のネットワークを作成するのであれば、ここを0001などとしていきます<sup>[1](#note1)</sup>。
3. IPv6における、デフォルトルーターは、リンクローカルアドレスの1とするのが一般的です（fe00::1）。これに倣い、XG自身のIPv6アドレスの後半64ビットのインターフェース識別子は1としています。
4. {% label info @:: %}は、IPv6アドレスの0000が続く部分を省略できるものです。fdxx:xxxx:xxxx:0000:0000:0000:0000:0001/64の0部分を省略し、fdxx:xxxx:xxxx::1/64としています。

　保存ボタンをクリックし、LAN側のインタフェースにIPv6を割り当てます。

{% note primary no-icon %}

## RAおよびDHCPv6の設定

{% endnote %}

### DHCPv6の設定
　クライアントにIPv6のアドレスを配布します。SSLインスペクションが行えるクライアントは固定IP範囲を明示的に割り当てます。

　XGの左ペインメニューから{% label info @ネットワーク %}、{% label info @DHCP %}と進み、{% label info @サーバー %}の{% label info @追加 %}ボタンをクリックします。

　次にIPv6のタブをクリックし、以下の画面の通り入力していきます。

{% asset_img dhcp.png alt %}

1. {% label info @名前 %}は、IPv6のDHCPと分かるよう命名してください。
2. {% label info @インターフェース %}はPort1を選択してください。すでに割り当てられているXGのIPv6アドレスが表示されます。
3. {% label info @ダイナミックIPリース %}は、自動割り当てするIPv6アドレスの範囲を入力します。IPv4は10進数で表示する事が多いですが、IPv6は16進で表示する事になるので、ログを見た時に解りやすいIPアドレス体系となるような構成にされる事をお勧めします。
4. {% label info @スタティックIPのDUIDマッピング %}は後ほど入力します。一旦は空のままにしておいてください。
5. {% label info @DNSサーバー %}は、XGのIPv6アドレスを指定して下さい。プライベートのホスト名の名前解決のために、この設定が便利です。

### RAの設定

　クライアントにDNSの通知を行うため、RAの設定を行います。DHCPで明示的にIPv6アドレスを指定しないクライアントはRAにより自身のIPv6アドレスを自動生成しつつ、DNSの情報を受け取ります。今回は、原則DHCPv6の情報を元にIPv6アドレスが割り当てられます。RAはDNSの通知に使われます。

　XGの左ペインメニューの{% label info @ネットワーク %}から、{% label info @IPv6ルーターアドバタイズ %}を選択し、追加ボタンをクリックし、以下の図のように登録していきます。

{% asset_img ra.png alt %}

1. {% label info @インターフェース %}は、Port1を選択します
2. {% label info @マネージドフラグ %}にチェックします
3. {% label info @アザーフラグ %}にチェックします
4. {% label info @デフォルトゲートウェイ %}にチェックします
5. {% label info @アドバタイズ設定のプレフィックス %}の{% label info @プレフィックス %}には、今回のネットワークアドレスである、{% label info @fdxx.xxxx.xxxx:: %}を入力します。また、一時アドレスは使わないので{% label info @匿名 %}のチェックを外します
6. 保存をクリックし、設定を完了させます

{% note primary no-icon %}

## Firewallルール設定

{% endnote %}

　ここまでの設定で、DHCPv6によるIPv6アドレスが割り振られています。インターネットに出ていくためには、Firewallルールの設定が必要となります。
　XGの左ペインメニューの{% label info @ルールとポリシー %}で{% label info @IPv6 %}をクリックします。

{% asset_img rule1.png alt %}

 {% label info @ファイアウォールルールの追加 %}から{% label info @新しいファイアウォールルール %}をクリックします。
　ここでの設定内容は、過去の記事{% post_link rule-policy2 %}でIPv4について設定した内容と変わりません。{% label info @To Internet %}というルールを作りましたが、それと同じ内容の設定となります。

1. ルール名はここでは「To_Internet_IPv6」とします。
2. 送信元ゾーンには、LANを設定します。VPNを使う方はVPNも加えてください。宛先ゾーンはWANを指定します。
3. IPv4でもリンクNATは使いませんでしたが、IPv6においても利用しません。
4. セキュリティの「Webフィルタリング」をクリックし、詳細メニューをオープンします。

- Webポリシーは「Default Policy」を選択します
- 「HTTPおよび復号化したHTTPSをスキャン」をチェックします
- 「FTPのマルウェアをスキャン」をチェックします
- QUICプロトコルのブロックは任意選択です
    Googleのサービスで利用されています。私はチェックしています。Google自体は問題ないですがそのプロトコルを利用した悪質なサイトがFirewallを回避するリスクを減らすという意味で選択しています
- その他のセキュリティ機能でアプリケーションコントロールを選択します
    私は「Block very high risk(Risk Level 5) apps」を選択しています
- IPSは「lantowan_general」を選択します
- 保存ボタンをクリックします

　続いて、NATルールの設定に移ります。{% label info @ルールとポリシー %}の{% label info @NATルール %}から{% label info @IPv6 %}をクリックします。

　ここでは、既にIPv6の自動設定された情報が{% label info @Default SNAT IPv6 %} という名前で登録されています。ルールを開いて、{% label info @ルールのステータス %}のトグルスイッチをOnにしてください。

　最後に保存をクリックしてください。この段階ではSSLインスペクションの設定は出来ていませんが、IPv6で接続可能な状態になっています。

　テストのために、ひとまず、[ipv6.google.com](https://ipv6.google.com/)が正しく表示出来るか確認してください。

{% note primary no-icon %}

## 固定IPアドレスの登録

{% endnote %}

　端末にルート証明書を導入できる端末（Windows、macOS、iOS）のみに対してSSLインスペクションを行いますので、DHCPv6では、該当端末が常に固定のIPv6アドレスを持つための設定を行います。

　XGの左ペインの{% label info @ネットワーク %}の{% label info @DHCP %}から、{% label info @IPv6リース %}の状況をみると、実際にIPv6のアドレスが割り当てられている一覧が確認できます。ここの{% label info @DUID %}が端末固有情報であるため、この値を控えて、DHCPv6の設定にIPv6とDUIDのペアを登録していく事になります。

　ここでは、DUIDの値をメモしてください。残念ながら以下の通りDUIDの文字列が長すぎて、表記が見切れます。マウスをポイントしてポップアップされたDUIDをメモする必要があります。

{% asset_img dhcp1.png alt %}

　再び、DHCPの設定画面で、{% label info @IPv6 DHCP Server %}を選択します。以下のように、{% label info @スタティックIPのDUIDマッピング %}の項目にDUIDとIPv6のセットを登録してください。

{% asset_img dhcp2.png alt %}

　注意点としては、SSLインスペクションでIPアドレスの範囲を設定する事になりますので、一定の範囲でスタティックのIPv6アドレスを設定するようにしてください。

{% note primary no-icon %}

## SSLインスペクションの設定

{% endnote %}

　IPv6のSSLインスペクションの設定を行います。まずは、IPv4で対応した時と同じように、SSLインスペクションの対象範囲のIPホストを登録します。

　XGの左ペインメニューの{% label info @ホストとサービス %}から、{% label info @IPホスト %}のタブで、{% label info @追加 %}ボタンをクリックします。

{% asset_img host.png alt %}

　上記の通り、SSLインスペクションのためのIPv6の範囲を{% label info @CA_Client_IPv6 %}として登録します。16進数のアドレス表記ですが、ここでもIPv4のアドレス体系に合わせておくと、ログを確認した時の視認性が上がります。

　続いて、XGの左ペインメニューの{% label info @ルールとポリシー %}から{% label info @SSL/TLSインスペクションルール %}に進み、{% label info @IPv6 %}をクリックします。

　以前の記事{% post_link ssl-inspection1 %}で、このSSLインスペクションルールは一度作成しています。ここにIPv6の設定を加える事になります。

{% asset_img rule2.png alt %}

　上記のように、{% label info @送信元ネットワークとデバイス %}に、今回作成した、IPv6のホスト群である、{% label info @CA_Client_IPv6 %}を選択して追加します。

　これでIPv6に関する設定は完了です。IPv6についても、SSLインスペクションの対象となり、より多くのコンテンツフィルタリングが可能となりました。一度IPv4でXGのルート証明書を端末にインストールしてあれば、再度インストールする必要はありません。SSLインスペクションのための端末へのインストールについては、過去の記事、{% post_link ssl-inspection1 %}を参照してください。

　最後に、通信の確認です。XGのログのログビューアを開き、プルダウンから、{% label info @SSL/TLSインスペクション %}を選択します。

{% asset_img rule3.png alt %}

　上記の通り、同じホストでもIPv4とIPv6の通信が混在している事、またSSLインスペクションの対象/対象外についてもログの内容を見て確認できます。

<small id="note1">[1]
　ULAの48ビットに対するネットワークアドレスとして、fdxx:xxxx:xxxx:0000を使うため、複数のサブネットを扱う場合、実際に使うアドレスはfdxx:xxxx:xxxx:1::/64とするのが一般的です。今回は個人向けの一例として出来るだけ簡素化する事を目的とし、このような設定にしています。そういう私も自分の環境では、Prefixの後半16ビットは0001としています。</small>