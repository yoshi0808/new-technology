---
title: XG Firewall v18をESXi仮想マシンにインストールする
date: 2020-03-06 21:37:20
tags:
  - XG Firewall
categories:
  - Security
#comments: false
---
{% note success  %}

## この記事で実現すること

ESXi 6.7に環境構築済みの仮想マシンに対し、XG Firewall V18のインストールを行います。ESXiを使わない場合、PC（物理マシン）にフラッシュメモリを接続し直接インストールする事になりますが、この場合も手順自体はほとんど変わりません。

{% endnote %}
<!-- more -->

## XGのインストール概要

事前準備の記事、{% post_link esxi-conf %}、{% post_link InstallXG %}で、ネットワークアドレスを決めました。XGのインストール概要は以下の通りです。

- XGのLAN側ネットワークアドレスはXGのデフォルトである`172.16.16.0/24`を使うか、自身で決めたESXiが属するネットワークアドレス`192.168.1.0/24`（例）を使う事になります。ここではXGのWAN側を`192.168.0.0/24`のネットワーク、XGのLAN側を`192.168.1.0/24`として説明します。
- クライアントPCとESXiをインストールしたハードウェアのLAN側ネットワークとを接続します。クライアントPCは手動でLANのIPアドレスを割り当てます。
- 仮想マシンは事前に設定されたXGのインストールイメージ（ISOファイル）からブートさせるので、ブラウザでESXiホストにログインし、仮想マシンを起動してインストールを行います。ESXiをセットアップした機器にモニタを接続する必要はありません。

{% mermaid graph LR %}
  PC-- "192.168.1.0/24" ---XGFirewall
  PC-- "192.168.1.0/24" ---ESXiホスト
  subgraph ESXi_Hypervisor
  ESXiホスト-.->XGFirewall
  end
  XGFirewall-- "192.168.0.0/24" ---HGW
 {% endmermaid %}


## 仮想マシンを起動する

- ESXiの管理コンソールからXGの仮想マシンを選んでパワーオンをクリックします。
- Sophos FIRMWARE INSTALLERが起動します。
- インストールを開始すると（仮想マシンに割り当てた）ディスクが全てフォーマットされ、ファームウェアがインストールされていきます。
- press y to rebootでリブートします。
- 再起動後、さらにdefault conifgをインストールするとの表示がされ、やがてパスワード入力画面になります。最初のパスワードはadminです。まずライセンスを受け入れる画面となります。続いて、ネットワークの設定を変更します。

{% asset_img conf.png alt %}

1."Network Configuration"を選び、次の画面で、"1.Interface Configuration"を選びます。以下の表示がEnterを押下する毎に変わります。

- LAN側のIP
- WAN側のIP（ホームゲートウェイからのプライベートIPが割り当てられています）。
- "Set IPv4 Address(y/n)"と出るので、変更する場合は、y＋Enterします。
- IPv6は後で設定するので空Enterで構いません。
  
この状態で一旦IPの設定を終えたら、クライアントPCのブラウザからXGに対して接続し、セットアップを続けていきます。ここではXGのIPアドレスを`192.168.1.2`にしたと仮定して進めます。

{% note warning %}

WANのIPが割り振られていない場合は、後続のセットアップでライセンスの確認ができません。事後にもライセンス登録は可能ですが、初期のうちに課題を解決しておきましょう。

{% endnote %}

## XG Firewallの初期設定

ブラウザで、`<https://192.168.1.2:4444>`を開き初期設定を行っていきます。自己証明書でもあり、ブラウザのワーニングが表示されますが、了解のうえ進んでください。

{% asset_img setup1.png alt %}

ここでは、右上のプルダウンで日本語に変更しておくと良いでしょう。続いて、以下の項目を設定していきます。

- 管理者パスワード
- タイムゾーン
- 登録メールで届いたシリアル番号を入力します

{% asset_img setup2.png alt %}

- ゲートウェイとしてルーターモードを選択します
- LAN側に割り振るDHCPのIP範囲を設定します

{% asset_img setup3.png alt %}

- ネットワークプロテクションは**SandStormを除き**選択します。仮に選択してもホームユースでは解除されます。
  
{% asset_img setup4.png alt %}
  
続いての画面のメールセットアップですが、登録しないと先に進めないので、一旦登録を行います。Gmailをお持ちであれば、Gmailをメールの送信者にしておくと比較的簡単に送信できます。メールの受信者は、色々なイベント通知が発生した時に確認するアドレスですので、携帯などのアドレスが候補に挙げられます。

{% asset_img setup5.png alt %}

 セットアップも最後の仕上げです。5分程度と言いつつもう少し掛かる場合がありますので、ブラウザのリロードをせずそのまま待ちます。その後管理画面のリロードが入りますが、XGの管理サイトは自己証明書のためにブラウザのワーニングが出た画面で止まっている場合があります。

{% asset_img setup6.png alt %}

 ログイン画面です。固定IPにして設定してきたPCも、XGのDHCP機能によって、IPアドレスが割り当て可能となっています。PCの設定をDHCPにして確認して下さい。そして、インターネットにも接続出来ている事を確認して下さい。現段階では、基本はインターネットへの通信は全て通す設定になっているので疎通確認が出来たら、ホームゲートウェイに接続されている他の機器などをXGのLAN側に繋いで下さい。
