---
title: 10GbEスイッチ QSW-M408-4C
date: 2021-10-31 9:00:00
tags:
 - QNAP
categories: Network
---

{% asset_img QSW-M408-4C.png 1024 alt %}

## QNAPの10GbE/SFP+/RJ45スイッチ

1年ほど前にQNAPのQSW-M408-4Cというスイッチを購入しました。10GbpsのLAN（RJ45モジュラージャック）がNASや無線LANと増えてきたのもあり、家庭向けのデザインで小型化され、実売価格5万円程度でマネージドというのが珍しいなと思い購入に至りました。発売当初は管理画面が未熟で、アクセスコントロールなどが殆ど設定できませんでしたが、2回ほどファームウェアアップデートを経て1年越しで使える状態（お勧めできるレベルの製品）になってきました。

個人向けとして関係しそうな内容に絞って記載します。

> QNAP QSW-M408-4C
 <https://www.qnap.com/ja-jp/product/qsw-m408-4c/specs/hardware>

<!-- more -->

### ハードウェアの特徴

1. 10GbE SFP+/RJ45コンボポート  4つ
2. 1GbE (RJ45)  8つ　※NBASE-T（100M、1G、2.5G、5G、および10Gps）に対応
3. 寸法高さ：42.5mm　幅：290mm　奥行：127mm
4. 最大消費電力31.46W
5. ジャンボフレーム9K
6. スイッチングファブリック96Gbps

ファンは1つありますが、自宅用として殆ど気になる音量ではありません。枕元に置くのでなければファンの音が気になる事は無いでしょう。
この製品のベンチマークとなるのがNETGEARの**XS708T**でしょうか。ただ、XS708Tはホームユーザー向けという感じではなく、サイズも大きく消費電力も49.5Wという事でもう少し小さいサイズのものが無いかと思っていたところでした。そういう意味ではサイズがコンパクトになったためリビングでも目立たず取り扱いやすいデザインでもあります。
筐体は下面が金属ですが、その他はプラスチックとなっています。下面部分はそれなりに熱を持ちます。


>NETGEAR XS708T
 <https://store.netgear.jp/products/detail/130>

### ソフトウェアの特徴

1. QoS
2. VLAN
3. Portトランキング
4. アクセスコントロール（ACL）IPアドレス、MACアドレス
5. Portマネジメント

まず、ホームユーザーでネットワークに拘る方向けには簡易的なQoSやACLがある事、そしてモニタリングできる事が求められます。VLANなども最低限度の機能は持っています。この製品はL3スイッチではありませんので、VLANのセグメント間をルーティングする機能は持っていません。恐らくパワーユーザーの方がLinuxベースのルーターやFirewallから複数の足を出してVLANのセグメントの接続するなどがよくある構成でしょうか。セキュリティ観点では無線ルーターがゲスト用のAPを持て、ネットワーク分離が簡単にでき、昔ほどVLANの必要性も少なくなっているように感じます。

MACアドレスのACLもなりすましが可能という事で抑止力が極めて強い機能ではありませんが、内部ネットワークの悪意のあるソフトウェアやウィルスに感染したIoTから、重要な情報資産へのアクセスを防ぎます。

## Web管理画面

スイッチはDHCPからIPアドレスが割り振られます。管理画面はブラウザから`https://ipアドレス`で接続します。
{% asset_img login.png 1024 alt %}

ユーザーは今のところadmin固定のようです。

### 概要

サブメニューの {% label primary @概要 %}では各Portのモニタリングができます。

{% asset_img main.png 1024 alt %}

Portにマウスカーソルを合わせる事でPortの状況（接続スピード）が表示されます。但し、リアルタイムの状況がわかるだけで過去24時間の統計などは把握できません。上記画面下の**ポートのトラフィック**、**10GbEポートのトラフィック**は便利で、バックアップを取ったり何か作業をしている中、端末同士の実際のトラフィックがどれだけ流れているのか確認できます。

### Port管理

サブメニューの {% label primary @Port管理 %}では各Portの詳細モニタリングができます。

{% asset_img port.png 800 alt %}

過去3分間の履歴と記載があります。なぜ3分固定なんでしょうか{% emoji unamused %}。また、この画面を開いてからの履歴が画面上で記録されていくだけであり、スイッチ本体に記録されているものではなさそうです。元々スイッチ製品では長期的にデータを保存しておく機能は持っていないのが普通なのであまり多くは望めないと思います。

### VLAN

サブメニューの {% label primary @VLAN %}ではVLANの管理ができます。

個人向け環境でVLANを設定する方は、ネットワークの仕事に従事されている方が過半数だとは思います。Ciscoで慣れている方が多いと思われますが、個人向けのスイッチのVLANは各社ごとに機能の名称が異なり、かえって理解するのが難しいです。以下は私がVLANを切ってみた構成のキャプチャです。このスイッチは私のリビングにあり、Port12から光回線のそばに設置してあるコアスイッチに繋がっています。

{% asset_img vlan.png 800 alt %}

Ciscoで慣れている方のための補足説明です。
- QSW-M408-4CでのネイティブVLANは1固定となっており変更できません。
- QSW-M408-4Cではアクセスポートとトランクポートの設定項目がありません。
- デフォルトでは1のネイティブVLANで全てのPortがタグ無しとなっています。私はここでVLAN100を加えています。

VLAN100の説明

1. Port3-6までVLAN100を**タグ無し**として登録しています。これはCiscoのアクセスポートと同義です。
 - アクセスポートに設定することで設定されたVLANのタグは外され、端末側ではVLAN100に属しながらタグ無しのパケットを受信できます。
 - アクセスポートには一つのVLANしか属する事はできません。

2. Port12は上位のスイッチに接続されていますが、VLAN1を**タグ無し**、VLAN100は**タグあり**と設定しています。これはCiscoのトランクポートと同義です。
 - 上位のスイッチもVLAN1がネイティブVLANとなっておりタグ無しです。
 - 上位のスイッチとQSW-M408-4Cとの間はVLAN1はタグ無し、VLAN100は100のタグが付きやりとりされます。

このような仕組みでQSW-M408-4CはVLANに対応し、異なるメーカーのスイッチともVLANで接続できます。もし、PC側のNICでVLANID100を受けられるように設定するのであればスイッチ側で敢えてタグを付けるように設定します（この設定を敢えてやる事に意味はありませんが）。

もし、ESXiをこのハブに繋ぎ、vSwitchの複数のネットワークポートでVLANを切っていらっしゃるのであれば、タグ無しではなく、トランクポートの設定で ESXiのvSwitchに繋ぎ、タグ有りでESXiのvSwitchに流れるようにします。

### IGMP

サブメニューの {% label primary @IGMP %}ではマルチキャストパケットを効率化する管理ができます。

{% asset_img igmp.png 800 alt %}

PanasonicのプライベートVIERAなどマルチキャストを使う機器やアプリケーションがある場合、ネットワーク全体に負荷がかかるため、このIGMPスヌーピングを設定しておくと要求していないPortにはマルチキャストパケットを流しません<sup>**[[1]](#note1)**</sup>。マルチキャスト通信が無駄に多くの端末に流れないようにする事もネットワークの品質向上に役立つと考えています。

> Panasonic プライベートVIERA
 <https://panasonic.jp/privateviera/>

 ### QoS

サブメニューの {% label primary @QoS %}ではPort毎のトラフィックの優先度設定が可能です。

{% asset_img qos.png 1024 alt %}

リアルタイムでやりとりを行うアプリケーション、前述したプライベートVIERAやTV会議などのPortを優先し、裏で流れる大量・高速のバックアップなどから影響を受けないようにします。NASで10Gbpsを束ねるようなパワーユーザーであれば必要になってくる機能です。

### ACL

サブメニューの {% label primary @ACL %}ではIPv4によるアクセス制御、およびMACアドレスによるアクセス制御が可能です。

{% asset_img acl.png 800 alt %}

このスイッチのIPアドレスによるACLはIPv4のみ対応しています。ここでは、Port9にアクセス制限するサーバー（例えばNAS）が接続されており、接続を許可しているクライアントをMACアドレスベースのACLで制御する例です。ここでの設定のポイントは、以下の通りです。

1. Port9を通過するMACアドレスを全て列挙しています。
2. サーバーからインターネットへのアクセスを許可する場合は、インターネットに接続するルーターのLAN側MACアドレスも登録します。
3. 最後の行で該当しないMACアドレスからの送信は拒否しています。

この設定によって、TCPは元よりUDPやICMPも不許可のクライアントからはサーバーに送信できません。また、サーバーから不許可のクライアントに対するTCP接続も返りのパケットが受け取れないため、3Wayハンドシェークが失敗して接続できないようになります。

中継機をお使いの方への注意事項としては、アクセスする際は送信元のMACアドレスは端末のものではなく、中継機のMACアドレスになることが殆どです。ここは運用上少し工夫が必要です。これが面倒な場合はIPアドレスによるACLを利用される事をお勧めします。中継機にもいくつか方式があり、端末のMACアドレスでDHCPのIP割り当てをするものや、そもそも中継機のMACアドレスを元にDHCPのIP割り当てを要求するものもあるようです。

私が使っているNECのAtermの**W1200EX**という中継機は、DHCPでMACアドレスによる固定割り当てした端末について本来のIPアドレスが割り当てられますが、実際にアクセスする時はW1200EXのMACアドレスが送信元MACアドレスとなります。他社製でも、その方式はまちまちであるようです。PCなどでIPアドレスとMACアドレスとの関係を確認するには、`arp -a`で確認できます。

> NEC Aterm W1200EX
 <https://www.aterm.jp/product/atermstation/product/warpstar/w1200ex/>

> バッファロー：中継機能を利用したときのMACアドレス制限の設定方法について
 <https://www.buffalo.jp/support/faq/detail/15113.html>
>NETGEAR:How to setup devices on EX7000 when MAC address filter is enabled on the router
 <https://kb.netgear.com/26262/How-to-setup-devices-on-EX7000-when-MAC-address-filter-is-enabled-on-the-router>

## ファームウェア更新

このスイッチのファームウェア更新は手動で更新有無をチェックする必要があります。今年の5月にファームをあげてから全く障害もなく100日以上正常稼働を続けておりホームユーザー向けのスイッチの安定度としては今のところ十分ではないかと思われます。
{% asset_img firmware.png 320 alt %}

## iperf3のテスト
ESXiの仮想マシンであるubuntu20.04(10GbE)からQNAPのNAS(10GbE)へiperf3コマンドを実施したところ以下の結果でした。

``` bash
$ iperf3 -c 192.168.x.x
Connecting to host 192.168.x.x, port 5201
[  5] local 192.168.x.x port 56490 connected to 192.168.x.x port 5201
[ ID] Interval           Transfer     Bitrate         Retr  Cwnd
[  5]   0.00-1.00   sec  1.09 GBytes  9.35 Gbits/sec    0   1.87 MBytes
[  5]   1.00-2.00   sec  1.09 GBytes  9.37 Gbits/sec    0   1.87 MBytes
[  5]   2.00-3.00   sec  1.07 GBytes  9.19 Gbits/sec    0   1.87 MBytes
[  5]   3.00-4.00   sec  1.08 GBytes  9.29 Gbits/sec    0   1.87 MBytes
[  5]   4.00-5.00   sec  1.10 GBytes  9.42 Gbits/sec    0   2.06 MBytes
[  5]   5.00-6.00   sec  1.09 GBytes  9.41 Gbits/sec    0   2.06 MBytes
[  5]   6.00-7.00   sec  1.10 GBytes  9.42 Gbits/sec    0   2.21 MBytes
[  5]   7.00-8.00   sec  1.10 GBytes  9.42 Gbits/sec    0   2.21 MBytes
[  5]   8.00-9.00   sec  1.09 GBytes  9.37 Gbits/sec    0   2.32 MBytes
[  5]   9.00-10.00  sec  1.09 GBytes  9.41 Gbits/sec    0   2.32 MBytes
- - - - - - - - - - - - - - - - - - - - - - - - -
[ ID] Interval           Transfer     Bitrate         Retr
[  5]   0.00-10.00  sec  10.9 GBytes  9.36 Gbits/sec    0             sender
[  5]   0.00-10.00  sec  10.9 GBytes  9.35 Gbits/sec                  receiver

iperf Done.

```
仮想マシンを使った測定ではオーバーヘッドがあるので参考程度にはなりますが、十分なパフォーマンスが出ています。

## できるだけ有線LANの敷設を

LANの口がある機器は可能な限り有線接続することがベストです。ついつい手軽さから無線LANの接続を選びがちですが、特にリアルタイムのアプリケーションは転送量の問題でなくレイテンシ（遅延）に品質が左右されます。前出のプライベートVIERAは2秒程度、TV会議や動画チャットも0.5秒〜1秒程度の遅延が入り、その遅延の間にデータをバッファリングし安定的に動画と音声を届けるような仕組みです。

映画や音楽などのストリーミングはデータが固定ですから事前にかなりのデータを読み込んでおけますのでさほどシビアにはなりません。家電のネットワークPortは100Mbpsなどのものも多いですが、今の時代の無線が数100Mbpsではるかに早いという事にはならず、安定性のために有線LANをお勧めします。

家庭に10GbpsのLANが必須だとは思いませんが、最近のデバイスを快適に利用するためには10Gbpsでなくとも基幹LANが大切になります。無線（802.11）は半2重、有線は全2重の通信ですから、レイテンシという意味では有線の安定度が絶対的に勝ります。また、安定運用にはスペック上の余裕を持たせる事が大事と考えています。このスイッチに限らず、2.5Gbpsの製品はいくつか発売されています。クライアント側の2.5GbE対応については「{% post_link 2500MbE %}」を参考にしてください。

無線ルーターには数PortのLANの口も備えていますが、無線ルーターは何かと保守が必要であり、メンテナンスの都度ネットワークが切断されてしまいます。安定した基幹のスイッチを導入することをお勧めします。

スイッチであっても10Gbpsのチップはまだ発熱量が大きいのが現状です。もし、このスイッチをお使いになる場合は、筐体下面についている短いゴム足をもう少し長いものに変えたり、縦置きにするなど少し工夫が必要と思います。それでもこの製品はそれなりの小型化と静粛さと高速化を両立したバランスの良いスイッチであると思えます。

もし、10GbE対応のNASやPCがこのスイッチの近くに設置してある、またはこれから10GbEのNICを購入されるのであれば、是非SFP+ポートの接続を検討してみてください。DAC（ダイレクトアタッチケーブル）での接続は低レイテンシで発熱量がとても少ないです。RJ45ポートも100Mbps、1Gbps、2.5Gbps、5Gbps、10Gbpsと様々な速度でも繋がり、難しい設定は不要なので多くの方にお勧めできるスイッチです。

あとはネットワーク統計やエラーパケットなどを把握するための機能搭載を期待するところです。

<small id="note1">**[1]**
これはプライベートVIERAが大きな負荷を掛けるという話ではありません。接続の最初にはマルチキャストが使われますが通信が確立した後はユニキャスト中心ですので、トラフィック量としては殆ど気にする必要はありません。
</small>
