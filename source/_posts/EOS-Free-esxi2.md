---
title: VMWare 無償版ESXiの提供終了について（第2報）
date: 2024-02-14T23:09:13+09:00
tags: ESXi
categories:
---
{% asset_img vm1.png 1024 alt %}

<!-- more -->

## VMWareからの告知

2024-02-09ごろに、以下のKBが告知されました。

> End Of General Availability of the Free vSphere Hypervisor (ESXi 7.x and 8.x) (2107518)
 <https://kb.vmware.com/s/article/2107518?lang=en_us>

>要約：
 無償版ESXiはVMWareのWebサイトではもはや利用できません。

>解決方法：
 永久ライセンスから新しいサブスクリプション製品への移行の一環として、無償版ESXiは EOGA (End of General Availability) となりました。現時点では、同等の代替製品はありません。 

つまり、無償版ESXiのインストールモジュールはすでにダウンロードできなくなりました。
なお、パッチについては、VMWareのカスタマーコネクトにログインした上で、従来通り、製品パッチをダウンロードできます。2/14 20時においてダウンロードできました。
{% asset_img cc.png 1024 alt %}

1月30日に書いた記事「{% post_link EOS-Free-esxi %}」では、今後もESXiを新規利用またはアップグレードされる方はISOファイルのダウンロードとライセンスの取得をお勧めしていましたが、あまりに期間も短くお役に立てなかったかもしれません。

これにはもはや抗うことはできないようです。

## ESXiの代替の検討

既に稼働済みの無償版ESXiは定期的なオンライン認証などがあるわけではないので当面の間利用は継続できますが、有償のESXiを使うつもりでなければ、移行について検討しなければなりません。

## Proxmox VE

{% asset_img proxmox.png 400 alt %}

ProxmoxはLinuxユーザー、個人を中心に人気のあるプロダクトです。大学や団体の利用実績もあります。ドイツの2名の開発者からスタートした企業です。ESXiは比較的ネットワークカードやNVMeの種類を選びましたから、手軽に始められる仮想環境としてはまずはProxmoxが挙げられます。

> Proxmox Virtual Environment
 https://www.proxmox.com/en/proxmox-virtual-environment/overview

{% asset_img proxmox1.png 1024 alt %}

上記は取り急ぎproxmoxをセットアップして動作させたブラウザ画面のキャプチャです。現時点では、Ubuntu22をセットアップした程度でほとんど検証ができていません。

モニタ類も非常に見やすいです。
{% asset_img proxmox2.png 800 alt %}

Proxmoxにはバックアップサーバーという製品もありますが、Proxmox VE単独でバックアップのスケジューリングができます。これは無償版ESXiと比べて良い点です。SynologyNASのNFS4.1に接続してバックアップしています。
{% asset_img proxmox3.png 640 alt %}

通知は下記のように行われます。
{% asset_img proxmox4.png 640 alt %}

バックアップ速度は4Gbps強です。差分のバックアップ（ブロック変更のみ）は無さそうですね。
``` bash
100: 2024-02-17 14:43:09 INFO: transferred 32.00 GiB in 63 seconds (520.2 MiB/s)
100: 2024-02-17 14:43:10 INFO: archive file size: 10.06GB
```

スナップショットもESXi同等にメモリの状態まで確保できます（ZFSファイルシステムで実行）。

少し気になる点としては無償で利用するには開発用リポジトリを使うことになり、有償のリポジトリはより安全にテストされたものが利用できる仕組みです。GUIでもモジュールは更新できますが、更新の単位は`apt update`と同様の感覚です。リモートワークなどに利用しているVMがあるのであればその点は留意する必要があります。

まだ十分な検証ができていませんが、手軽にESXiからの移行を始めるにはProxmoxの環境で検証をスタートさせるのも良いかもしれません。
Proxmox自体、セキュアブートでインストールでき、VMもセキュアブートの設定ができます。

設定はややLinux寄りです。結局はLinuxのコマンドをGUIにうまく形を変えているとも言えます。ESXiで慣れていると少しギャップがあります。ESXiのVMWare Remote Consoleは素晴らしい製品でしたが、そこまでは行かずとも、別ウィンドウでVNCから暗号化通信でコンソールにアクセスするなど操作性はとても良く、先進的であると感じさせます。

取り急ぎ、ProxmoxVE8.1のセットアップとVMの新規作成に関する記事を投稿しました。Proxmoxを試してみたい方は参考にしてみてください。

- {% post_link ProxmoxVE %}
- {% post_link Proxmox-new-vm %}

## XCP-ng（XEN Orchestra）

{% asset_img xcpng.png 800 alt %}

新しいプロダクトではありませんが、Citrixが提供しているXen Serverから派生したオープンソースシステムでVatesという会社が提供しています。2012年にフランスで設立されています。おそらく規模は小さい会社のように見えます。こちらは企業中心、またホームラボでも利用されています。
仮想化という概念では素晴らしいものをXenから継承しており、本格的なHypervisorです。ProxmoxはHypervisorとも言えますが、VMが明確に独立しておらずDMAなどのメモリへのアクセスはかなり自由です。一方、XCP-NGは厳格にセパレートされておりセキュリティが高く、安定度も高い物と考えられます。その犠牲になるのは速度ですが、XEN Orchestraという有償のGUI管理ツールはわかりやすいため、ESXiユーザーはこちらの方が気にいるかもしれません。

> XCP-ng
 <https://xcp-ng.org/#easy-to-install>

Xen OrchestraのGUIツールは有償ですが、個人が使うためのソースコードが提供されており、自身でコンパイルして利用する分には無償です。有償のプロダクトはXOA（Xen Orchestra Apliance）、ソースコードからビルドしたものはXOと呼ばれ区別されています。

{% asset_img xo.png 1024 alt %}

Proxmoxと比べると少しグラフィカルな面は見劣りするでしょうか。
{% asset_img xo1.png 1024 alt %}

ネットワークなどは簡単にVLANを作成できて一覧として確認できるので管理しやすく思えます。
{% asset_img xo2.png 1024 alt %}

これはMellanox Connect X-3の１つのPort（ネイティブVLAN=1）にさらに仮想のVLAN110を加えています。

こちらもバックアップはスケジューリングできます。ESXiのようにバックアップもブロック単位の差分で取得できます。
バックアップのメール通知は以下のような形で行われます。
{% asset_img xo3.png 480 alt %}

VMはブラウザから操作することになりますが、メニューの大きさも相まって、少し使いづらいと感じます。クライアントのVNCからXenOrchestraにSSHしてPort Forwardingすることによって暗号化した上で単独のVNCクライアントから操作できるようですが、こちらはまだ未確認です。
{% asset_img xo4.png 1024 alt %}

XCP-NG本体は特に難しいところもなくインストールができます。8.2.1はまだセキュアブートのセットアップはできません。VM自体はセキュアブートの設定ができます。また、Xen Orchestraの管理ツール自体は別ノードからアクセスする方が好ましく、最初からノード単位のフェールオーバーなどを考えて作られています。現在私のセットアップではXen OrchestraをESXiで、昔使っていたintelのPCにXCP-NGをセットアップしています。

XCP-NGの最新バージョンは現在8.2.1ですが、Ryzen環境で動作させると応答速度やネットワーク速度が遅く、Communityの情報を見ながら、古いintel core i7マシン（Intel(R) Core(TM) i7-8700 CPU @ 3.20GHz）に再インストールするなど、少し回り道してしまいました。8.3はまだベータ版ですが、そこではRyzen版の速度改善が見込めるようなのでこちらはまた少し時間を置いてから検証を開始するつもりです。なお、P-Core/E-CoreのCPUは仮想環境でどのようにCPUが使われるのか読めないと考えられ、難しさを感じています。

XCP-NGはスナップショットやバックアップが少し古い時代を感じさせるところがあります。稼働中のVMをバックアップした後にレストアすると、OSをブートするところから始まります。つまり、メモリの内容が廃棄されてしまいます。オープンしていたファイルがどうなるのか、恐らくロールバックされるとは思いますが、検証をしっかりと行いたい箇所ではあります。

XO自体のリポジトリはGitHubにあり、かなり細かい単位でMasterブランチ（メインのソースコードの配置場所）がCommitされていきます。どこかでそれらの更新部分を取り込むには改めてXOのソースコードのコンパイルから必要になります。但し、これは簡単なスクリプトで手間をかけずに対処可能です。

私がXCP-NGに期待しているのはシステムの安定度です。ESXiも本当に安定していて、これまでハードウェアの故障以外でハングしたりすることは全くありませんでした。また、Xen Orchestraは、企業で数十台の仮想サーバを管理することを想定して作られており、管理のしやすさを感じます。

Proxmox、XCP-NGともに良いプロダクトのようで、最終的にはどちらかの仮想環境をメインに使い、2台構成でライブマイグレーション（仮想マシンのノード間の移動）まで実現できればと考えています。

海外のホームラボのパワーユーザーはどちらかといえば、XCP-NGを好むようにも見えます。これは簡単なProxmoxは面白くないということなのかもしれません。ESXiの代替としてはXCP-NGが今脚光を浴びているように見えます。

XCP-NG、Xen Orchestraへの理解を深めるには、ローレンスシステムズのTom氏が解説しているYouTubeビデオがわかりやすいと思います。

>Understanding How The XCP-NG & Xen Orchestra Open Source Virtualization Platform Works
 <https://www.youtube.com/watch?v=CEUFHudLO1g&t=447s>

今後、Xen Orchestraのセットアップ手順などを整理していきたいと考えています。手持ちの予備マシンをProxmoxで使ってしまったのでマシン調達から始めますのでしばらく時間がかかりそうです。