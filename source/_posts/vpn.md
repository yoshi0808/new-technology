---
title: XG Firewall VPNについて
tags:
  - XG Firewall
categories:
  - Security
  - VPN
date: 2020-03-28 11:41:42
---
<p class="onepoint">この記事で実現すること</p>
外出先から、PC（Windows、macOS）を使い、宅内にあるXG FirewallのVPNへ接続できるようになります。それによりウィルスおよびマルウェア対策やWebフィルタなどを含んだ安全なネット閲覧や、宅内のLANリソースへリモートアクセス出来るようになります。

<!-- more -->

## XG FirewallのVPN

XGのVPNはプロトコルが何種類かあります。一般的なSSL-VPN,L2TP,PPTP、そしてSophosConnectというIPSecベースのものがあります。SophosConnectは速く安定しているため、ここではSophosConnectのVPN導入について説明します。

## 事前確認

Sophos Connectの設定にあたり、インターネットに接続されているホームゲートウェイから、VPNのパケットについては内部のXGのWANインターフェースに転送しなくてはなりません。一般的に市販されているルーターにも装備されていますが、この方法には2通りあります。

1. 全ての宅内へのトラフィックは全てXGに転送する
 ルーターやホームゲートウェイの製品によって呼び方は異なりますが、DMZホスト機能などと呼ばれます。この場合はインターネットから入ってくるデータは全てXGに送られますので、宅内にサーバーを立てる場合、ホームゲートウェイからはXG以外の端末は接続出来なくなります。ただし、設定は単純というメリットがあります。
 {% asset_img dmz.png alt %}

2. SophosConnectに必要なプロトコルおよび通信PortのみXGに転送する
 こちらは一般的にポートマッピングと呼ばれます。内→外、外→内の方向について細かく設定を行う事になります。SophosConnectに必要なプロトコルとPortは外→内で以下の通信になります。
  - ESPプロトコル（プロトコル番号：50）
  - UDP 500,UDP 4500
 {% asset_img portmapping.png alt %}
  
上記の2つのどちらか対応できれば、XGに対するVPN接続が行えます。この画面はホームゲートウェイの画面であり、契約しているインターネット回線業者により、提供される機器は異なりますのであくまで設定例は参考となります。

## XG側のVPNユーザー作成

最初にユーザーの作成が必要です。VPNの最終接続形態としては、2要素認証対応のセキュアなものを目指します。ただし、いきなり全ての事を実施すると切り分けが難しいのでまずは2要素認証無しでの接続をし、次に2要素認証有りの接続に取り組みます。XGの左ペインメニューから{% label @認証 %}を選択、{% label @ユーザー %}のタブから、追加ボタンをクリックします。そして以下のようにユーザー名、パスワードとメールアドレスを入力します。

{% asset_img user1.png alt %}
{% asset_img user2.png alt %}

他はグループのところで、{% label @OPEN Group %}を選択するくらいで設定するところはありません。このまま保存をクリックします。VPNは、このユーザー名/パスワードで接続する事になります。

## XG側のSophos Connectの設定

XGの左ペインメニューから{% label @VPN %}を選択、{% label @Sophos Connect %}のタブを選択します。特に拘りがなければ、デジタル証明書ではなく、事前共有鍵を選択する事にしましょう。それなりの鍵の長さを設定しておけば安全です。また最終的にはワンタイムパスワードを設定する事でかなりの安心感が得られます。鍵はパスワードと異なり、一度クライアントに設定すれば接続の都度入力する必要もないため、複雑で長い鍵長の事前共有鍵の設定が好ましいでしょう。設定は以下の通りに行います。

- {% label @インターフェース %}はPort2(WAN)を選択します
- {% label @認証タイプ %}は事前共有鍵を選択します
- {% label @事前共有鍵 %}は文字列を入力、また繰り返し同じ鍵を入力します
- {% label @許可されたユーザー %}には、上記で作成したユーザーを選択します

{% asset_img vpn1.png alt %}

- 名前はXGの配置場所として適当な名前を入力します
- XGのVPNの割り当てネットワークは、LANとは別のネットワークアドレスを入力します。例えばLANが`192.168.2.0/24`のネットワークならば、`192.168.20.1`〜`192.168.20.8`などと別のネットワークを入力します
- DNSについては、XG自身のDNS（XGのLAN側のIPアドレス）を入力します
- 詳細設定の{% label @トンネルがアイドルの時に切断 %}を有効にします
- {% label @アイドルセッション時間の間隔 %}は600にします（特段のこだわりはありません）

{% asset_img vpn2.png alt %}

適用ボタンをクリックすると、"これにより、同じローカルピアとリモートピア間で設定したすべての接続の事前共有鍵が更新されます。続行してもよいですか？"と表示されます。OKをクリックすれば、VPNが有効になります。

## XG側のFirewallルールの確認

上記で設定したVPNがFirewallのルールに登録されている事を確認します。SSLインスペクションが入ると難しくなるので、まずはこの記事ではVPNとWANの接続を優先に考え設定します。以前の記事{% post_link rule-policy2 %}で、デフォルトのルール「To_Internet」を作成しました。ルールについて、以下の図のように{% label @送信元ゾーン %}が、LANとVPNとなっている事を確認してください。

{% asset_img rule1.png alt %}

続いて、VPNからLANへのルールを作成します。NATは使わず全てのトラフィックを通過させるものです。以下の通り、送信元ゾーンはVPN、宛先ゾーンはLANのルールを設定します。

{% asset_img rule2.png alt %}

（2020-06-20更新）このルールでは、{% label @リンクNATルールの作成 %}は行いません。NATの動作の確認のために「NATしない事を明示する」設定を行うと挙動がわかりやすいというメリットはありますが、v18では原則リンクNATは使わず運用可能という考え方のようで当初記載していたリンクNATの記述を削除しました。

さらにルールで保存をクリックしてルールの設定は完成です。念のため現在のルールについて確認しましょう。{% label @Traffic to Internal %}として、VPNからLANへの接続ルールがあります。もう1つは、{% label @Traffice to WAN %}として、VPNおよびLANからWANへの接続ルールがあります。

{% asset_img rule6.png alt %}

## XG側のDynamic DNSの設定

素晴らしい事に、XGでは無償のダイナミックDNSを用意してくれています。VPNで接続する際には、グローバルIPアドレスが必要ですが、XG用のmyfirewall.coドメインが利用できます。他に使われていない一意のホスト名を設定する事になります。{% label @IPv4アドレス %}の箇所は、{% label @NATされたパブリックIP %}を選んでください。その他のNo-IPなどの有名どころのダイナミックDNSを選ぶ事も可能です。

{% asset_img ddns.png alt %}

登録が終わると、直ちにグローバルIPがダイナミックDNSに登録されます。その後、{% label @前回更新したIP %}にグローバルIPが表示され、{% label @前回更新した状態 %}にSuccessと表示されます。

{% asset_img ddns2.png alt %}

## XG側のデバイスのアクセス設定

XG側はこれが最後の設定です。左ペインの{% label @管理 %}から、{% label @デバイスのアクセス %}へと進みます。そこに、LAN、WAN、VPN毎にサービスのアクセス権限が定めている一覧になります。ここでは以下の項目のアクセス権を加えます。

- 管理サービス　HTTPS/SSH
 XGの管理メニューにVPN経由でアクセスする事を可能とします。
- Ping/Ping6
 こちらの設定は任意です。
- DNS
 LANおよびVPNからのアクセスはXGのDNSをまず最初に参照します。LANにあるホストを参照する時は、XGのDNSがプライベートIPを返すように、スタティックのプライベートIPをDNSに登録しておきたいためです。これは後々サーバーを宅内に立てる場合、活用する事になります。

## Sophos Connectクライアントのダウンロード

WindowsでVPN接続するためにはVPNクライアントをダウンロードします。上記のXGのVPN設定画面で{% label @Sophos Connectクライアントのダウンロード %}というボタンがありました。そちらをクリックし、ソフトウェアをダウンロードします。こちらは、Windows版、macOS版のダウンロードが出来ます。さらに、この画面の{% label @接続のエクスポート %}ボタンをクリックし、接続設定ファイルをダウンロードしてください（拡張子tgb）。この設定ファイルには先ほど設定したダイナミックDNSの内容も含まれています。

## Sophos Connectクライアントのセットアップ

クライアントへのセットアップは、Windowsの場合は、SophosConnect.msiをインストールします。macOSの場合は、SophosConnect.pkgをインストールします。プログラム実行後、右上のメニューから、{% label @Import Connection %}をクリックし、先ほどダウンロードした接続設定ファイル（拡張子tgb）を読み込んでください。

{% asset_img install.png alt %}

## VPNの接続確認

{% label @Connect %}をクリックし、VPN用に設定したユーザー名とパスワードでインターネットから、宅内のXGに接続します。

{% asset_img connected1.png alt %}
{% asset_img connected2.png alt %}

VPN経由でインターネットに接続し、ブラウザからアクセスできること、IPアドレスがプロバイダから貸与されたアドレスになっているか確認します。また、LANの機器との接続が行える事も確認してください。公衆WIFIからダイナミックDNSを用いた確認が検証としては最適ですが、接続業者によっては、VPNを通さないところもあります。

なお、ここまで説明してきた通り、LANとVPNのネットワークセグメントは異なりますので、ブロードキャストで相手を見つけるようなアプリケーションはVPNからLANに対する接続は行えません。

## VPNからWANに対するSSLインスペクションの設定

ここまでの設定でVPNの設定は終了ですが、VPNについてもSSLインスペクションが有効となるように設定します。一旦はVPNのネットワークからインターネットにアクセスする場合は、全てがSSLインスペクションの対象とし、ファイアウォールルールを修正します。

1. 最初にVPNのネットワークアドレスを左ペインの{% label @ホストとサービス %}から{% label @IPホスト %}を登録します。

{% asset_img vpn3.png alt %}

2. 上記のようにネットワークにIPアドレス（この記事では192.168.20.0/24としています）を登録します。VPNのネットワークは、LANのネットワークとは別のネットワークアドレスとする必要があります。

3. 次に、左ペインの{% label @ルールとポリシー %}から、{% label @SSL/TLSインスペクション %}を選択します。
4. 事前に作成してある{% label @Catch SSL %}ルールを選択し、ここにVPNのネットワークがSSL/TLSインスペクションの対象である事を設定します。

{% asset_img vpn4.png alt %}

5. 上記の図では{% label @送信元ネットワークとデバイス %}に、CAがインストールされているPCおよびiPhoneを対象とするIPグループを{% label @CA_Clinet_IPv4 %}として登録していました。これに今回はVPNのネットワーク{% label @VPN_Network_IPv4 %}を追加登録します。

ここまでの設定でIPSec-VPNの設定は一段落です。SSLインスペクションの設定および動作確認については、過去の記事を参照して下さい。

- {% post_link ssl-inspection %}
- {% post_link ssl-inspection1 %}
- {% post_link ssl-inspection2 %}
