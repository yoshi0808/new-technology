---
title: Synology DS1621+（DSM7.2）とSSD
date: 2023-07-27T20:00:00+09:00
tags:
- Synology
- 10GbE
- 25GbE
categories:
- [Hardware]
- [Network]
---

{% asset_img synology-title.png 1024 alt %}

<p class="onepoint">この記事で実現すること</p>

サイバー攻撃の話題が相変わらず賑やかな状況下、これまで使っていたNASのソフトウェアの安定性やセキュリティ面の不安があり、安定感のあるSynologyのNASにリプレースしました。昨今SSDが安くなってきた事もあり、節電兼ねてALL SSDのNASをセットアップしてみました。

<!-- more -->

## 前提（私の使い方）

私のNASの用途は、写真や動画のバックアップ、複数のPCで使う文書・PDFなどの同期兼バックアップ、仮想マシンやモジュールのバックアップ用途です。このブログなどはプライベートなものではないので、自宅で保存するよりGitHubのパブリッククラウドに置いておくほうがより現実的ではありますが、操作ミスで消えるリスクも鑑みNASにバックアップを取得しています。

今のところ、TVや映画などの動画を保存する用途にはしていないので、容量だけでいえば1ベイか2ベイのNASで10TBあれば十分です。特殊要素があるとすれば、仮想マシンのバックアップを頻繁に取得するので、できるだけバックアップ速度を求めます。そういう意味では10GbEのネットワークは必須です。

NASでは仮想マシンを稼働させる事もできますが、私の用途としてはESXiを一般的なPCにセットアップし、複数の仮想マシンを稼働させているので、NASはストレージがメインです。Windowsファイル共有（SMB）、NFS、iSCSI、せいぜいsyslog、SQLデータベースあたりまで使うといったところです。Ubuntuは個人向けにウィルス対策ソフトが存在しないので、Ubuntuのブラウザでインターネットにアクセスする事は殆どなく、モジュールのダウンロードは（ウィルス対策ソフトが有効な）macOSかWindowsでダウンロードしたものをSMBで共有してUbuntuで利用することが殆どです。

NASの使い方は利用者によって様々でしょうから、あくまで一例ということでご覧ください。

## Synology機種選定

6ベイ〜8ベイ程度のNASでそろそろ新モデルが出るかなと思い、年初くらいからウォッチしていましたが、発表されたのはDS1823xs+で、30万円と高額でした。周辺機器の互換性としてEnterpriseクラスの製品が中心で、個人向けとしては少し不向きだなと感じました。メモリは厳格に互換性を重視しつつも、SSDは必ずしも互換性のドライブでなくても良いかと考えていましたが、Enterpriseクラスの厳格性で10万円超えクラスの製品レベルを求められるとコスト面でかなり厳しいと感じました。現行モデルとの比較は以下の通りです。最初からSFP+のネットワークカードを増設する前提で、それなりにCPUパワーのある機種の比較です。10GbE以上の場合、どこまでスループットが出るかという期待も含めての選定です。

| 機種      | CPU                                     | CPU TDP | 製造プロセス | ベイ | 実売価格 |
| --------- | --------------------------------------- | ------- | ------------ | ---- | -------- |
| DS1823xs+ | AMD Ryzen V1780B クアッド コア 3.35 GHz | 45W     | 14nm         | 8    | 30万円   |
| DS1821+   | AMD Ryzen V1500B クアッド コア 2.2 GHz  | 16W     | 14nm         | 8    | 16万円   |
| DS1621+   | AMD Ryzen V1500B クアッド コア 2.2 GHz  | 16W     | 14nm         | 6    | 12.5万円 |

意外にも、最新機種のDS1823xs+の製造プロセスは14nmで現行モデルと変わりません。DS1621+/DS1821+の現行モデルは発売後2年半が経過しています。それなりに長期間使うことになるNASはEOSLを気にする必要があります。ただし、2012年モデルでもセキュリティパッチはきちんと提供されているので、Synologyのソフトウェア保守に対する考え方は非常にしっかりとしています。2018年に発表されたDS1618+（CPU:intel Atom C3538）は発売後5年でDiscontinuedになっていますが、あくまで製造中止であって、サポートはフルに提供されています。さらに、DS1621+/DS1821+は新発表されたDS1823xs+とCPU世代が同じなので、長期的なサポート継続が行われると考えられます。

ちなみに、V1500BやV1780Bは2つの10GbEチップを内蔵しているんですね。ただし、DS1621+/DS1821+には10GbEの口はありません。DS1823xs+は1つの10GbE(RJ45)があるのでその10GbEを活用しているということでしょうか。

ということで、Synologyはソフトウェアが秀逸である反面、少し高いというイメージを持っていたのですが、実売価格として廉価なDS1621+を購入することにしました。メモリが4GBなので、純正ECCメモリ（1.5万円）4GBを追加し8GBとしました。

Synologyの保守に関する注意点としては、購入後の保証期間が過ぎたハードウェアの有償修理は行われないという点です。特殊なハードウェアだと電源やファンなど代替品というのも簡単には見つからないのでそこだけが留意する点でしょうか。故障が気になる方は延長保証を検討する必要があります。私は故障した場合は「さだめ」と割り切って新しいハードウェアを買う理由が見つかるので延長保証にはしていません笑

> Synology 製品サポート状況
 <https://www.synology.com/ja-jp/products/status>

## SSD

{% asset_img 870evo.png 320 alt %}

Synologyとしては公式には互換性確認が取れていないSamsungの870EVO 4TB(MZ-77E4T0B/IT)が28,000円程度だったこともあり、6つ購入しました（最初に1台購入し、動作確認の上で追加を5台買いました）。仕様は以下の通りTLCで速度、耐久性を重要視しました。

- インターフェース (転送速度・規格値）：SATA 3.0(6Gbps) ※SATA 2.0(3Gbps)およびSATA 1.0(1.5Gbps)互換フォームファクタ：7mm厚2.5インチHDD互換［搭載デバイス］NANDフラッシュ：Samsung 3bit MLC (TLC) V-NANDコントローラ：Samsung MKXコントローラキャッシュメモリ：2GB LPDDR4［パフォーマンス］シーケンシャル：読み出し560 MB/s、書き込み：530 MB/s
- 5年間または最大2,400TBWの限定保証

4TBのSSDといえば、つい昨年は8万円くらいしていたと記憶していますが、廉価になるスピードも早いですね。世の中では半導体が不足していると言われる一方で、個人向けPCの販売不振によって、SSDなどのパーツが余剰在庫で値崩れしていると聞きますので、SSD全般に関しては今はお得な時期と言えるでしょう。

DS1621+にはM.2-2280のNVMeキャッシュも搭載可能ですが、SSD RAID5の分散であればキャッシュを必要としない程度に十分な速度が出るものと見込んでいます。キャッシュだけだと見かけのベンチマークは良い数字が出るでしょうが、安定して読み込み・書き込み速度を出すにはSSDでシンプルな構成が一番と考えます。

なお、このストレージのセットアップ時には互換性の無いDiskである警告メッセージが表示されます。また、Synologyアカウントのページには以下の記載があります。

> 以下の状況ではテクニカル サポート サービスは提供されません。
 Synology互換性リストに記載されていないデバイス（ドライブ、メモリモジュール、PCIeカードなど）を使用する。

一度セットアップした後は警告メッセージは表示されていません。

NASというグループではなく、ConsumerというクラスでSynologyの互換性について検索すると、850EVO、860EVOが一覧に表示されます。何れ870EVOがサポート対象になるのを願うことにします。

> Synology 製品互換リスト（機種指定なし）
 <https://www.synology.com/ja-jp/compatibility?search_by=category&category=hdds_no_ssd_trim&filter_brand=Samsung&filter_class=Consumer&display_brand=other>

なお、Synologyの互換性試験を軽んじているわけではありませんし、なるべくは互換性のあるものを使おうと考えてはいます。ただし、DS1621+に関してSSDはサードパーティ製で認められたものはなく、SynologyのEnterpriseドライブのみで4TBだと価格が15万円/個なので、これは個人で購入するのは困難でしょう。
メモリやSSDキャッシュ用途であれば流石に互換性を重視した製品選定をしますが。。。

## NIC

{% asset_img mellanox.png 640 alt %}

このブログでは定番のMellanox Connect X4(MCX4121A-ACAT)を選定しました。ebayで1枚$70〜$80（日本円で約1万円）程度です。Synologyで正式に互換性検証されたものは、intel X710-T4がありますが、Connect X4は互換性リストにはありません。1つ昔のモデルのDS1618+はConnect X3には対応しているようです。Connect X4がダメなら純正のSFP28カードを購入するつもりでした。

前出の互換性リストを見ると、Mellanox Connect X4に対応しているSynology NASもそれなりの数があるようです。
> Synology 製品互換リスト
 <https://www.synology.com/ja-jp/compatibility?search_by=category&category=network_interface_cards&display_brand=other>

## ハードウェアインストール

### メモリ

筐体の底の部分に蓋があり、それを外すとメモリモジュールを挿すところがあります。シール付きの別売りモジュール（4GByte）を装着したところです。

{% asset_img memory.png 640 alt %}

## DiskStationManager（DSM）セットアップ

DS1621+は今更珍しいハードウェアでも無いですし、DSMのセットアップ情報も世の中に多くあるので、手順については省略します。最初はLAN1にRJ45のCat6ケーブルを接続しセットアップしました。インターネットに接続されている環境で無事DSM7.2のセットアップが完了しました。

論理Disk（ストレージプール）は初心者向けのSynology Hybrid RAID、または通常のRAIDを選択できますが、速度を重視し、RAID5としました。ダウンタイムを気にしてRAID6にするほど安全第一という事もなく、かといって、RAID0にして故障の際に大掛かりなリカバリのリスクを抱えたくも無いということで無難な選択です。6台のSSDすべてを1つの論理DISKとしてパリティの分散によって障害リスクの抑制、高速化を目指すことにします。

以前のNASでは、こういった論理ボリュームを作成後、利用するアプリケーションや目的毎のデータサイズによってストレージプールの中にそれぞれのボリュームを作成していました。例えば、macOSのバックアップであるTimeMachineなどでは、決められたディスクサイズの中で最新世代のバックアップを確保する仕組みとなっており、ディスクの容量を事前に決めておかないと（クオータ）、肥大し続ける事になります。PCで言えばパーティションのようなものですね。
また、別の目的では仮想マシンのバックアップなどは世代管理も含めて、どれだけのDisk容量を確保すべきかある程度運用しないとわかりません。意外と圧縮が効いて無駄にボリュームの空きができてしまう事はよくある課題です。また、複数ボリュームを作成するとスループットは落ちます。


NASはこの辺りの事前の計画がとても難しいのですが、DSM7では単一ボリュームに共有フォルダを作成する時にフォルダのサイズ制限を設定できます。これができればわざわざ複数ボリュームを悩みながら作成する事も不要です。これが実現できるのはSynologyがアピールするBtrfs（バターエフエス）ファイルシステムのおかげです。Btrfsではスナップショットを取得してバックアップする際、バックアップ中にファイルが更新されて一貫性が失われないとのことです。ファイルシステムもデータベースの仕組みに近くなっていくんでしょうか。

> Synology ナレッジセンター

 <https://kb.synology.com/ja-jp/DSM/help/DSM/AdminCenter/file_share_create?version=7#sharedfolderquota>
 {% note info  %}
 ストレージがBtrfsファイル システムを使用している場合に限り、共有スペースに共有スペースの割り当てを有効にするオプションをできますます。
 {% endnote %}

ESXiの仮想マシンのバックアップのために、 SynologyのActive Backup for Businessを使うつもりですので、これは64ビットOSとBtrfsが必須となります。Disk構成は以下のようになりました。
{% asset_img volume.drawio.png 480 alt %}

{% asset_img synology1.png 800 alt %}

## 消費電力

SSD6台、Mellanox Connect X4を装着した状態で、ワットチェッカーで計測してみました。以下の通り、おおよそ33W-35W程度で安定しています。なかなかの省電力です。以前に利用していたNASは4台のHDDという事もあり、70W-100W程度でかなり発熱も大きかったのがかなり改善されました。

-  Synology（SSDx6、Mellanox Connect X4）
 （33W-35W）
 {% asset_img wchecker1.png 360 alt %}

- 旧NAS（HDDx4、Mellanox Connect X3）
 （70W-100W）
 {% asset_img wchecker2.png 360 alt %}

## ネットワーク

セットアップ終了後、無事Connect X4はNASに以下のように認識されていました。
> `25000 Mbps, 全二重, MTU 1500`

2つのPortがあるので、1つは25GbE、もう1つは10GbEとして使ってみます。

お決まりのiperf3の計測です。Connect X4をSFP28でスイッチに接続します。クライアントはWindows11でこちらもConnect X4です。
Synologyのコミュニティから提供されているSynoCli Monitor Toolsというパッケージがあり、これをインストールして使ってみます。
この組み合わせでは上り、下り共に19〜21Gbps程度であり、及第点という感じでした。

Windows -> Synology（多重度2）
``` bash
[ ID] Interval           Transfer     Bitrate
[SUM]   0.00-10.00  sec  22.3 GBytes  19.1 Gbits/sec                  sender
[SUM]   0.00-10.00  sec  22.3 GBytes  19.1 Gbits/sec                  receiver

```

Synology NASとESXi上のUbuntuのiPerf3の結果は上り、下り共に十分なパフォーマンスが出ています。

Synology -> Ubuntu
``` bash
[ ID] Interval           Transfer     Bitrate
[  5]   0.00-1.00   sec  2.33 GBytes  20.0 Gbits/sec
[  5]   1.00-2.00   sec  2.59 GBytes  22.3 Gbits/sec
[  5]   2.00-3.00   sec  2.72 GBytes  23.4 Gbits/sec
[  5]   3.00-4.00   sec  2.59 GBytes  22.2 Gbits/sec
[  5]   4.00-5.00   sec  2.71 GBytes  23.3 Gbits/sec
[  5]   5.00-6.00   sec  2.72 GBytes  23.4 Gbits/sec
[  5]   6.00-7.00   sec  2.73 GBytes  23.4 Gbits/sec
[  5]   7.00-8.00   sec  2.70 GBytes  23.2 Gbits/sec
[  5]   8.00-9.00   sec  2.70 GBytes  23.2 Gbits/sec
[  5]   9.00-10.00  sec  2.69 GBytes  23.1 Gbits/sec
- - - - - - - - - - - - - - - - - - - - - - - - -
[ ID] Interval           Transfer     Bitrate         Retr
[  5]   0.00-10.00  sec  26.5 GBytes  22.7 Gbits/sec   22             sender
[  5]   0.00-10.00  sec  26.5 GBytes  22.7 Gbits/sec                  receiver

```

## Disk速度
定番のCrystal Diskmarkのベンチマークを実施します。

### 25GbE(SFP28)で計測

{% asset_img DiskMark25gbE.png 480 alt %}

読み込みは17Gbps、書き込みは14.3Gbpsと、かなり高いスループットが出ています。11Gbps-12Gbps程度であれば省電力を優先し10Gbpsで使おうと考えていましたが、迷いどころです。私が速度を重視するメインの使い道はESXiの仮想マシンのバックアップですので、それはまた別の機会に計測してみます。

### 10GbE(SFP+)で計測

 {% asset_img DiskMark10gbE.png 480 alt %}

 10GbEの場合は、読み込み、書き込みともにワイヤレートが出ており、バランスの良い組み合わせでしょうか。NICをSFP+の10GbEにして、もう5W程度省電力を狙うというのも良いですね。

### 25GbE(SFP28)にパケット署名を付けて計測

 {% asset_img DiskMark25GbE-PacketSign.png 480 alt %}

ビジネスではセキュリティの観点からほぼ必須と指摘されるSMBのパケット署名ですが、意外と落ち込まないですね。これも実運用するには十分な速度が出ています。

## その他、素晴らしい機能

以前のNASからリプレースして便利に感じた機能をいくつか挙げてみます。

- 2要素認証（TouchID、Windows Hello）
 DSMに2要素認証でログインする場合は、圧倒的に便利です。パスワードレスでTouchID、Windows Helloのみの認証にもできます。
 なお、YubiKeyのFIDO2も使えますが、PINもあって少し不便に感じます。YubiKeyはDSMへのSSHを公開鍵認証で使っています。iOSアプリのSecure SignInは自宅にいない場合に公衆回線を通じて2要素認証のためのサインインの通知が来るのは良いのですが、許可をタップするとNASへ直接接続しようとするようで、自宅のWi-Fiに接続していない場合は認証がうまく動作しません。これはいずれ機能アップして修正されることを期待します。SynologyのNASはTailScaleのアプリがインストールできるので、これを組み合わせる事で対応できるかもしれません。

 > tailscale
  <https://tailscale.com>

- ログセンター（Syslog）
 グラフィカルで分かりやすいです。ネットワーク機器のログを集めるのに使っています。このおかげでSyslogのために別の仮想マシンを用意する必要は無さそうです。以前のNASではフィルタ機能が十分でなく、使っていませんでした。Synologyでは演算子を使っていろいろな条件で絞り込みができます。個人でのログ確認には必要十分です。
  {% asset_img syslog.png 800 alt %}

 絞り込みも優秀で、ホスト名を入力させるのではなく、すでにログ出力されているホスト名から選択できます。
  {% asset_img syslog2.png 800 alt %}
  
- ストレージアナライザー
 {% asset_img analyzer.png 1024 alt %}  
 ファイルサイズの大きいもの順に確認できたり、重複ファイルを確認、削除できます。データの見える化ができて、とても便利です。

- ファイアウォール
 これはアプリケーションの自動ブロックと連動していて、このブロックが働いた時、つまり明らかな不正ログインの懸念がある場合のみ通知されます。ですので、普段から通知されることはありません。以前のNASでは許可していないサービスにIPレベルでパケットが到達した段階でエラーとカウントして膨大な件数の拒否カウントが定期的に通知されており、結局通知を止めていたのですが、こちらは現実的なファイアウォール機能となっています。
 > さまざまなサービスとパッケージが自動ブロックをサポートします。例：DSM、SSH、Telnet、rsync、ネットワーク バックアップ、共有フォルダの同期、FTP、SMB、WebDAV、File Station、Audio Station、Video Station、Download Station、Mail Server、Mail Station、MailPlus、MailPlus Server、VPN Server、Synology Drive Server、および Synology モバイル アプリ。

- Synology Drive
　NASでは一般的な機能で、複数クライアント端末とファイル同期を取るソリューションです。以前のNASでは小さいモジュールがたくさん存在するフォルダ、特にGitで使うようなソースコードや小さいモジュールのファイルは、_conflict_(0)のような競合ファイルがたくさん発生してしまい、全く使えずにいました。GitHubへのプッシュする際に大量の誤ったプッシュ候補のファイルが表示されてしまい、泣く泣く変更したファイルをロールバックする羽目になりました。他の端末との同時更新などの競合がある訳ではなかったのですが、それ以来、一般的な文書のみに使っていました。今回、SynologyのNASになってからはまだ日が浅いですが、このような小さいモジュール群も安定して複製してくれ、複数端末で同期が取れています。

- DSM画面のレスポンスが良いこと
　どのアプリケーションを稼働させても、ウィンドウがもたつくことはありません。

## まとめ

SSDが安くなったおかげで、今回は廉価にNASのリプレースが出来ました。SSDキャッシュはベンチマークこそ良い成績が出ますが、実際の運用においてはなかなか効果を感じづらいところがあります。NVMeではなくSATAなので大きな期待はしていませんでしたが、かなりの速度が出ることを確認できました。私の利用方法は少し特殊と考えられますが、Synologyのソフトウェアが素晴らしいことで、NASを利用している時のストレスが本当に減りました。
前述したSyslogや重複ファイルのチェックなど、本当にユーザーフレンドリーで使いやすく他社のNASから乗り換えた時にはこのDSM7.2を使うと、その使い勝手の良さに驚かれるでしょう。またストレージの消費量もかなり低く抑えられています。最近、SynologyはエントリーモデルにおいてもBtrfsに対応するようになったので廉価でも高性能なNASとして利用できそうです。今はNASのバックアップを外付けのHDDにしていますが、あまりに使い勝手が良いので廉価なビジネスモデルにリモートコピーでバックアップを取得するのでも良いかなと思い始めています。
