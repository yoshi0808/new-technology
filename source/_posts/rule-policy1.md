---
title: XG Firewall v18のルールとポリシーについて
date: 2020-03-14 09:23:01
tags:
  - XG Firewall
categories:
  - Security
---

{% note success  %}

## この記事で実現する内容について

XG Firewall v18のルールとポリシーの基本的な機能を紹介します。また、インストール後、最初から設定されているデフォルトポリシーの内容を解説します。

{% endnote %}
<!-- more -->

## ルールとポリシーの機能説明

この記事では、XG Firewallの具体的な設定を行います。Firewallというものは、TCP/UDPのレイヤ3またはレイヤ4の制御が一般的です。つまりhttpsであればPort443、ssh（セキュアシェル）であればPort22などです。そしてそのPortに対し、通過させるか拒否するかを決めるものです。XG Firewallはレイヤ7、つまりアプリケーションの中身まで見て可否を判断する事が可能となります。サイトがどういうサービスを提供しているかジャンル分けされており、好ましくないサイトには接続しないように設定が出来ます。従来の方法、例えばSSHであればPort22を止めるなどというFirewallは時代に合わなくなってきています。

あやしい振る舞いをするアプリケーションの挙動を見ていると、httpsの443で繋いでみてダメだったら一般的なProxyである8080などからの接続を試み、さらにダメならPort80と続きます。次に接続ドメインを変えたりするなど、ありとあらゆる手段を使って外部との接続を試みようとします。このような問題のあるアプリケーションをインストールしない事が一番良いのですが、ファイル交換サイトへのアクセスは禁じるという設定を行う事で一定の抑止力が発揮できます。

まず、XGのインストール直後は内部”LAN"からインターネット"WAN"への接続は、初期設定として全て通します。前述したレイヤ3、レイヤ4については一切制約は掛かっていません。原則WANへの通信は通すというのが最初の状態です。逆インターネットから内部のサーバに向けた接続は行えず、1つの接続対象毎に都度ルールを作成していく事になります。

左ペインのルールとポリシーを選択し、デフォルトの設定を見てみましょう。ルールグループというグループ化されたルールがあります。

{% asset_img rule_menu.png alt %}

- Traffic to Internal Zone
 Firewallの内側（内部のLANにサーバを立てる場合）にアクセスするルールを記載します（Inbound）。
- Traffic to Wan
 インターネットにアクセスするルールを記載します（Outbound）。
- Traffic to DMZ
 今回は使いません。そもそもは業務上サーバを立てる場合はDMZにWebサーバやメールサーバを配置し、内部クライアントとは分離するのが業務上一般的です。今回の設定では、個人でそこまでは不要としています。
- Default Network Policy
 上から順にルールを実行してきて、全てすり抜けるとここに到達します。全て許可するルールとなっています。業務で利用する場合は、デフォルトは破棄する設定を行うのが一般的です。こちらもホームユーザー向けとして全て通す設定を行い、"Traffice to Wan"のルールである程度厳格なルールを設定します。一番右の（•••）マークでルールのOn/Offをトグルで切り替えられるようになっており、「すべてをドロップ」は無効となっています。

次にDefault Network Policyを見てみます。

## デフォルトポリシーの機能説明

{% asset_img rule1.png alt %}
このルールでは、上述したルールグループは「なし」となっているので、グループから外れて単独で存在しています。そして、このルールは「許可する」となっています。なお、「破棄する」は無応答で相手はタイムアウトを待つ事になります。「拒否する」は接続要求をAcceptせず、接続を確立させず、すぐにエラーとなります。

次にInbound、Outboundの組み合わせになります。
{% asset_img rule2.png alt %}
ここでは、LANからWANへの通信を対象としています。サービスはプロトコルの設定をするのですが、「ftp」や「ntp」など、サービスとして登録でき登録方法もシンプルになっています。従来は、1つのFirewalのルールに長いコマンドをマニュアルや手順書を見ながら複数行入力していたものですが、隔世の感があります。

次に、アプリケーションFirewallの設定です。
{% asset_img rule3.png alt %}
デフォルトは少し甘めの設定に変更します。先ほども述べたとおり、Traffic to Wanで個別のポリシーを作成するなどして厳しいルールにします。そうすると意外とアプリケーションFirewallのルールで通信出来なくなる機会が増えます。一時的に通すなどルールを変更したい場合は、その厳しいルールを一旦Offにするなどして、このデフォルトルールを通す運用を行っていく事になります。理由は、Webポリシー/IPS/アプリケーションコントロールなど複数箇所で接続出来ない要素があります。1つ1つ切り分けしていると手間が掛かるので、Firewallのログで拒否または破棄となったルールを無効にして、短時間このルールを生かす運用を行うという事です。

Webポリシーは、Default PolicyからAllow Allに変更します。広告のタグがヘッダに含まれているとFirewallは律儀にRejectしてしまい、サイトが正しく表示できなくなるためです。これは当初セットアップのための暫定設定です。

アプリケーションコントロールとIPSはデフォルトのままにしますが、お好みで変更しても構いません。ただアプリケーションコントロールは厳しくしすぎると実行可能ファイルをダウンロード出来ないなど厳しいところもありますので、いろいろ設定を変更して試して下さい。

IPSの機能について補足します。”DPIエンジンでなくWEBプロキシを使用する”はV18では全て利用しないという前提で進めます。”webプロキシでのフィルタリング中にHTTPSを復号化する”も利用しないという前提で進めます。これは前バージョンのV17まではメインの方式で、Port443のみを対象としていました。V18の機能であるDPIエンジンはPortに依存しないのでこの機能を最大限活用します。
