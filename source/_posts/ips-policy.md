---
title: XG FirewallでIPSのポリシーを確認する
tags:
  - XG Firewall
categories:
  - Security
date: 2020-05-04 09:00:00
---

{% note success  %}

## この記事で実現する内容について

　XG Firewallの複数あるIPS Policyについて中身の確認をし、防御対象について理解を深めます。

{% endnote %}

<!-- more -->

{% note primary no-icon %}

## XGのIPSポリシーについて

{% endnote %}

　このブログでのXGインストールの記事、{% post_link rule-policy2 %} では、IPS Policyの選択として、{% label info @lantowan_general %}を設定しました。前回はまずセットアップを完了させる事を目的に、あまり十分な説明をしていませんでしたので、改めて中身の確認をしていきます。

　XGのIPSポリシーは、左ペインメニューの{% label info @侵入防御 %}の{% label info @IPSポリシー %}から確認できます。デフォルトで登録されているものには、以下の内容があります。

- DMZ TO LAN
- DMZ TO WAN
- LAN TO DMZ
- LAN TO WAN
- WAN TO DMZ
- WAN TO LAN
- dmzpolicy
- generalpolicy
- lantowan general
- lantowan strict

　前半の6つはそれぞれの接続形態に合わせたポリシーです。LAN TO WANでは、ブラウザやアプリからインターネットに接続する場合の攻撃を想定した防御ポリシーとなっています。XGの左ペインメニューの{% label info @侵入防御 %}から{% label info @IPSポリシー %}を選択し、さらにLAN TO WANを選択すると、以下の画面が表示されます。

{% asset_img lanwan.png alt %}

　このポリシーは、{% label info @カテゴリ %}、{% label info @重要度 %}、{% label info @プラットフォーム %}、{% label info @対象 %}というそれぞれのメニューに分かれています。これはブラウザなどのクライアントを対象として、WindowsやLinuxのクライアントOSが確認できます。macOSはありませんが、実際にAll Clientとして組み込まれているようです。正直このポリシーはどのような意図で作成されたのかはちょっとわかりません。なぜWindowsとLinuxだけを切り出しているのでしょうか。さらに、前半6つのポリシーはカスタマイズ出来ません。

　その下にあるdmzpolicy〜lantowan strictの4つのポリシーの中身はフィルタの種類の名前が異なっていますが、7126個あるXGのIPSポリシーが全て選択されており、4つのポリシーの中身は全く同じで何を選んでも変わりません。XGの昔からの伝統でそのようなカスタマイズ前提のポリシーになっています。

　これらの事実からみて、明らかに不要なポリシーを外せばパフォーマンスアップが期待されます。ですが、XGではその部分はさすがに工夫されていて、ポリシーを絞ったとしても殆ど効果はありません。もちろん、Solarisを個人で導入する人は稀でしょうが、下手にカスタマイズするよりは原則あるポリシーをそのまま使っても全く変わりません。これらの議論は、以下のSophos Communityの記事が参考になります。

>　[Please clarify IPS Policies?](https://community.sophos.com/products/xg-firewall/f/intrusion-prevention/98717/please-clarify-ips-policies)

{% cq %}

IPSを使用した場合のスループットのボトルネックに関しては、XGはsnortを使用していますが、SGシリーズを含む通常のファイアウォールに加えていくつかの工夫をしています。

{% endcq %}

　XGのIPSはオープンソースのセキュリティソフトであるsnortを使っているようです。私の検証では、下手にポリシーを絞り込むとかえってパフォーマンスが出なくなるように見えます（何10回も繰り返し統計をとったわけではありません）。lantowan generalなどの全く絞り込まないポリシーで全く不都合がない事と、XGで新しく自動追加されたポリシーが既存のフィルタで無効とならないようにするため、このままフィルタせずに利用しています。

　合計7126個のポリシーですが、これに過剰な期待は禁物です。話は変わりますが、Webサーバーのシェアは2017年に過半数を占めていたApacheは2020年4月には38.7％までシェアを落としています。代わりに高速性が売りのnginxが、足元32.1%までシェアを伸ばしています。

{% cq %} 
**Historical quarterly trends in the usage statistics of web servers**

This report shows the historical trends in the usage of web servers since April 2017.

|                           | 2017 1 Apr | 2018 1 Apr | 2019 1 Apr | 2020 1 Apr | 2020 4 May |
| ------------------------- | ---------- | ---------- | ---------- | ---------- | ---------- |
| **Apache**                | **50.1%**  | 46.9%      | 43.8%      | 39.5%      | **38.7%**  |
| **Nginx**                 | **33.1%**  | 37.7%      | 41.6%      | 31.7%      | **32.1%**  |
| **Cloudflare Server**     |            |            |            | 13.6%      | 14.0%      |
| **Microsoft-IIS**         | 11.4%      | 10.0%      | 8.7%       | 8.3%       | 8.1%       |
| **LiteSpeed**             | 2.5%       | 3.2%       | 4.0%       | 6.3%       | 6.5%       |
| **Google Servers**        | 1.3%       | 1.0%       | 0.9%       | 1.1%       | 1.1%       |
| **Node.js**               | 0.3%       | 0.4%       | 0.7%       | 0.8%       | 0.8%       |
| **Tomcat**                | 0.6%       | 0.5%       | 0.4%       | 0.2%       | 0.2%       |
| **Apache Traffic Server** | 0.3%       | 0.3%       | 0.5%       | 0.1%       | 0.1%       |
| **Cowboy**                | 0.1%       | 0.1%       | 0.1%       | 0.1%       | 0.1%       |
| **Tengine**               | 0.2%       | 0.2%       | 0.1%       | 0.1%       | 0.1%       |
| **IdeaWebServer**         | 0.3%       | 0.3%       | 0.3%       | 0.1%       | 0.1%       |
| **Kestrel**               |            | <0.1%      | 0.1%       | 0.1%       | 0.1%       |
| **ArvanNginx**            |            |            |            | <0.1%      | 0.1%       |
| **Lighttpd**              | 0.1%       | 0.1%       | 0.1%       | <0.1%      | <0.1%      |
| **Oracle Servers**        | 0.1%       | <0.1%      | <0.1%      | <0.1%      | <0.1%      |
| **IBM Servers**           | 0.1%       | <0.1%      | <0.1%      | <0.1%      | <0.1%      |

{% endcq %} 

https://w3techs.com/technologies/history_overview/web_server/ms/q

「パッチが多いのでアパッチ」と揶揄される事もありますが、XGのIPSにも178個のアパッチ用ポリシーがあります。一方、nginxは、まだ歴史が浅いという事もありますが、XGのポリシーを検索してみると4つしか見つかりません。全ての製品の脆弱性をXGがカバー出来るかといえば難しく、やはり利用しているプロダクトの製品パッチを適用するのが本筋です。

　再びホームユーザーとしての話に戻しますと、原則、Windows10やmacOS、スマホは脆弱性に対するパッチとして自動更新の機能があるので、それを行うのが確実です。むしろ危ないのは自動更新にしていないOSであったり、IoT機器・無線ルーター・NAS・家電などです。昨今、数多くの脆弱性が発見され、パッチが出ている現況においては、IPSに全ての製品の脆弱性の保護を頼るのは厳しいと考えます。きちんとベンダーからの通知システムを活用し、適切なパッチを適用する事が何よりも重要です。私はIT機器やソフトウェアを導入する場合には、こういったパッチが迅速に提供されるもの、また自動更新や通知の仕組みがあるものを選定するようにしています。そういう意味では、家電などはOSやシステム等の情報も少ないのが実情です。XGのIPSはあくまで補助的に使い、日常ログの確認も併せて行いたいところです。

　XGのIPSはこれだけにの機能に限らず、レイヤ7のファイアウォール機能として立派に役目を果たしてくれます。怪しいサイトに接続しない事は本人の心がけも重要ですが、XGである程度そういったサイトを遠ざける事も出来ます。2要素認証のように、面倒ではありますが複数の管理策を重ねる事と、日頃のログの確認や情報をウォッチする事が防御を高める事につながります。
