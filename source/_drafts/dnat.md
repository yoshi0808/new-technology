---
title: XG Firewall V18でLAN内のホストをインターネットに公開する
tags:
  - XG Firewall
categories:
  - Security
  - ホスト公開
---

{% note success  %}

## この記事で実現する内容について

XG Firewall V18で新しくなったDNATの設定を行い、LAN内のホストをインターネットへ公開できるようになります。

{% endnote %}
<!-- more -->

{% note primary no-icon %}

## ホスト公開の前提となる構成について

{% endnote %}

　インターネットから宅内の環境に対し、VPNを使わず直接アクセスするケースを説明します。最も一般的なのはネットワークストレージ（NAS）へのアクセスやWebサーバーのコンテンツ公開であろうかとおもいます。このブログではインターネット側にホームゲートウェイ、その内側にXG Firewallがあり、さらに内側にLANがある事を前提に説明しています。XG Firewallでは、一般的なルーターと同じように内部のホストをインターネットに公開するためには設定が必要となります。一般的な用語でもありますが、Sophosでは、このような外から内へのパブリックIPとプライベートIPとの変換を伴う接続形態をDNAT（Destination NAT）と呼んでいます。

{% asset_img network.png alt %}

　設定においては、上記の2つのサブネット（XGのWAN側、LAN側）を意識する事になります。

{% note primary no-icon %}

## V18より導入されたサーバーアクセスアシスタントについて

{% endnote %}

 V18では、V17と比較し設定がやや複雑になりました。その対策として、{% label info @サーバーアクセスアシスタント %}というウィザード形式で設定できる仕組みが導入されています。まだ製品版になる前のアーリーアクセスプログラムで、恐らく相応のフィードバックがあったのだとおもいます。結果、V18の開発途中に追加された機能となります。もちろん、このウィザードを使わなくてもDNATの設定は可能です。しかし、新しい機能でもあるので、それを使いながら設定方法について書いてみたいとおもいます。

{% note primary no-icon %}

## この記事における設定例について

{% endnote %}

　一般的な設定例として、内部にあるWebサーバーのhttpsアクセス（Port443）をインターネットから接続するケースで説明します。自分の環境ですと、ちょうどQNAPのNASをPort443で稼働させているのでこれを例に説明します。{% label info @パブリックIPのPort443 %}→{% label info @プライベートIPのPort443 %}に着信させる実例です。


{% note primary no-icon %}

## ホームゲートウェイでの事前設定

{% endnote %}

　VPNの導入の記事でも書きましたが、まずはインターネットから内部のホストにデータを届けるためには、ホームゲートウェイとXGそれぞれに設定を行う必要があります。

　以下のように、ホームゲートウェイでPort443のトラフィックをXGのWAN側IPアドレスに転送する設定を行います。

{% asset_img rule6.png alt %}

{% note primary no-icon %}

## XGのDNAT設定

{% endnote %}

　早速、サーバーアクセスアシスタントを使ったDNATの設定を行います。まずXGの左ペインメニューから、ルールとポリシーを選択します。ルールの上にある{% label info @ファイアウォールルールの追加 %}をクリックし、{% label info @サーバーアクセスアシスタントDNAT %}をクリックします。そうすると以下のウィザード画面が表示されます。

{% asset_img rule1.png alt %}

　ここでは、LANに設置してある、公開したいサーバーのIPとそのホストの名前を入力します。ここで入力したホストの名前とIPアドレスの組みは自動的にXGのIPホストとして登録されます。今回のケースではQNAPとそのIPアドレスを入力しています。入力後、{% label info @次へ %}をクリックします。

　2画面目では、以下のように公開したいパブリックIPアドレスを入力する画面となります。
{% asset_img rule2.png alt %}
　これはパブリックIPアドレスからプライベートIPへ変換するためのマッピング情報の元となるものです。但し、注意点として、ここでの構成はあくまでホームゲートウェイによってプライベートIPに変換された後のXGのWAN側IPアドレス（つまりプライベートIPアドレス）を入力する事になります。XGのWAN側インターフェースのIPアドレスである、{% label info @#Port2 %}を選択し、{% label info @次へ %}をクリックします。

　3画面目では、内部に転送するサービスを選択します。Port443のHTTPSを選択しています。

{% asset_img rule3.png alt %}

　選択後、{% label info @次へ %}をクリックします。

　4画面目では、{% label info @外部の送信元ネットワークとデバイス %}を選択します。

{% asset_img rule4.png alt %}

　表現が難しいのですが、WAN側のネットワークに制約を加える場合はここにネットワークの追加を行い、{% label info @任意 %}の設定を外す事になります。今回は、一旦はこのまま{% label info @次へ %}をクリックします。

　最後の5画面目では、これまで設定してきた内容の確認画面となります。画面の後半に{% label info @NATルールを3つ作成します %}という記述があります。DNAT以外の2つは不要なので後から削除する事になりますが、これは後ほど説明します。

{% asset_img rule5.png alt %}

　{% label info @保存して完了する %}をクリックしてください。

　これで、DNATの設定が完了しました。{% label info @ルールとポリシー %}では、作成されたルールは以下のようになっています。

{% asset_img rule7.png alt %}

　{% label info @ファイアウォールルール %}の一番上に新しいルール{% label info @DNAT to QNAPxxxx %}が追加されています。

　引き続き、{% label info @NATルール %}を見てみます。以下のように3つのルールが作成され、1番上にDNATルールが表示されています。

{% asset_img rule8.png alt %}

　これでひとまず設定は完了しています。これでインターネットから内部ホストへアクセス出来るようになりました。

{% note primary no-icon %}

## LAN環境からアクセスするため、DNSにプライベートIPを登録する

{% endnote %}

　さて、インターネットからパブリックIPを使ってアクセス出来るようになり、一般的にはダイナミックDNSなどを用いてFQDNで内部ホストへアクセスする事になるかとおもいます。しかし、宅内のLAN環境に入り当該サーバーへ同じURLを使って接続する場合は、パブリックIPではなくLANのプライベートIPで直接アクセスする事になります。
　この場合は、XGのDNSでスタティックとしてプライベートIPを登録します。左ペインの{% label info @ネットワーク %}から{% label info @DNS %}を選び、{% label info @DNSホストエントリ %}で、サーバーのFQDNとプライベートIPの組み合わせを登録してください。クライアントはXGのDHCPによってDNSがXG自身である事を指定されているため、当該ホストについてはプライベートIPでアクセス可能となります。

{% note primary no-icon %}

## DNATのウィザードで作成されるルールの詳細について

{% endnote %}

　ウィザードでは、シンプルにまずは繋がる事を優先に最低限度の設定を行いました。まずDNATの理解を深めるために、ウィザードで作成されたファイアウォールルールのDNATについて見てみましょう。

{% asset_img rule9.png alt %}

- {% label info @送信元とゾーン %}は、WAN
- {% label info @宛先ゾーン %}は、LAN
- {% label info @サービス %}は、HTTPS

　以上のように、それなりに理解出来るものが記載されています。しかし理解が進まないのは、{% label info @宛先ネットワーク %}の{% label info @#Port2 %}、つまりXGのWAN側IPアドレスが記述されている点です。宛先として直感ではLAN側のインタフェースである、{% label info @#Port1 %}のように感じます。まして、転送したいサーバーであるQNAPが記載されている項目はここにはありません。実際のHTTPSのアクセスである、QNAPに転送するという項目は{% label info @NATルール %}で記載されています。

　一旦、XGにおけるDNATはこういう仕様なんだと理解してください。不要となり削除する2つのルールを簡単に説明します。

- Loopback NAT
これはヘアピンNATとも呼ばれますが、内部ネットワークからパブリックIPアドレスを用いて公開サーバーへアクセスしたい場合に使います。XGがWANの外に出ていこうとするトラフィックを無理やり内部の公開サーバーに振り向ける動作です。パブリックIPはXGではなくホームゲートウェイが保持しており使えない事、固定IPでない場合は都度XGの設定変更が必要となり、実質使えませんので不要です。
- Reflexiv NAT
これはインストール直後のSNAT（ソースNAT　※送信元アドレスを書き換える一般的なNAT）のルールが最初から存在している事、このブログでは過去の記事（{% post_link rule-policy2 %}）で{% label info @To Internet %}というSNATのルールを作成しているので改めての作成は不要です。

{% note primary no-icon %}

## DNAT設定で防御要素を加える

{% endnote %}

　WAF（Web Application Firewall）を期待された方もいらっしゃるやもしれませんが、残念ながらWAFの設定ではありません。XGにもその機能はありますが、個人向けには少しハードルが高いのと、証明書の適用など運用が煩雑なのでここでは割愛します。その代わりに、ウィザードの4画面目で、任意とした外部の送信元ネットワークを活用します。もし、このWebサーバに対して日本国内からのアクセスに限るという設定を行った場合は、海外からの攻撃は一切防ぐ事になります。これはそれなりの防御になると考えられます。この場合は、{% label info @任意 %}を外し、{% label info @Japan %}を加えてください。
