<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>New technologies in our life</title>
  
  <subtitle>Device,Network,Code,etc...</subtitle>
  <link href="https://yoshi0808.github.io/new-technology/atom.xml" rel="self"/>
  
  <link href="https://yoshi0808.github.io/new-technology/"/>
  <updated>2023-11-12T04:31:09.127Z</updated>
  <id>https://yoshi0808.github.io/new-technology/</id>
  
  <author>
    <name>阿部　吉伸(Yoshinobu ABE)</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Sophos Firewall v20</title>
    <link href="https://yoshi0808.github.io/new-technology/2023/11/12/xg-v20/"/>
    <id>https://yoshi0808.github.io/new-technology/2023/11/12/xg-v20/</id>
    <published>2023-11-11T19:01:00.000Z</published>
    <updated>2023-11-12T04:31:09.127Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2023/11/12/xg-v20/Title.png" class="" title="alt"><h2 id="Sophos-Firewall-v20"><a href="#Sophos-Firewall-v20" class="headerlink" title="Sophos Firewall v20"></a>Sophos Firewall v20</h2><p>Sophos Firewall v20が2023年11月06日に発表されました。個人向けとしては、IPv6 DHCP Prefix Delegationのサポートがなされています。</p><span id="more"></span><h2 id="主なエンハンスの内容"><a href="#主なエンハンスの内容" class="headerlink" title="主なエンハンスの内容"></a>主なエンハンスの内容</h2><ul><li>IPv6 DHCP Prefix Delegation</li><li>IPv6 BGPv6</li><li>Synchronized Securityの強化</li><li>VPN管理の強化</li></ul><p>v20の詳細な説明はSophos Communityを参照してください。</p><blockquote><p><a href="https://community.sophos.com/sophos-xg-firewall/b/blog/posts/sophos-firewall-v20-is-now-available">https://community.sophos.com/sophos-xg-firewall/b/blog/posts/sophos-firewall-v20-is-now-available</a></p></blockquote><p>リリースノートはこちらです</p><blockquote><p><a href="https://docs.sophos.com/releasenotes/index.html?productGroupID=nsg&amp;productID=xg&amp;versionID=20.0">https://docs.sophos.com/releasenotes/index.html?productGroupID=nsg&amp;productID=xg&amp;versionID=20.0</a></p></blockquote><h2 id="Sophos-Firewallのアップデート"><a href="#Sophos-Firewallのアップデート" class="headerlink" title="Sophos Firewallのアップデート"></a>Sophos Firewallのアップデート</h2><p>XGの管理画面にログイン後、左ペインメニューの<mark class="label primary">バックアップ＆ファームウェア</mark>の<mark class="label primary">ファームウェアの確認</mark>でアップデートの案内が順次来ます。個別にバージョンアップのファイルを入手するには、以下のURLからダウンロードします。</p><p><a href="https://support.sophos.com/support/s/article/KB-000043162?language=ja">https://support.sophos.com/support/s/article/KB-000043162?language=ja</a></p><ol><li>上記画面で<mark class="label primary">ファームウェア</mark>の<mark class="label primary">ソフトウェア</mark>のLinkをクリックします。</li><li>“SW-20.0.0_GA.SFW-222.sig”をダウンロードします。</li><li>Sophos Firewallの管理画面にログインし、左ペインメニューの<mark class="label primary">バックアップ＆ファームウェア</mark>の<mark class="label primary">ファームウェアのタブメニュー</mark>から以下の画面に赤丸で囲った矢印のアイコンをクリックし、ダウンロードしたモジュールをアップロードします。</li></ol><img src="/new-technology/2023/11/12/xg-v20/verup.png" class="" width="800" title="alt"><p>ダウンロードしたファームウェアを指定します。</p><img src="/new-technology/2023/11/12/xg-v20/update.png" class="" width="480" title="alt"><p>アップロード＆再起動ボタンをクリックし、v20へのアップグレードを完了させます。</p><h2 id="auひかりのIPv6-DHCP-Prefix-Delegation"><a href="#auひかりのIPv6-DHCP-Prefix-Delegation" class="headerlink" title="auひかりのIPv6 DHCP Prefix　Delegation"></a>auひかりのIPv6 DHCP Prefix　Delegation</h2><p>ようやくIPv6のPrefix委任が使えるようになりました。これは日本だけではなく、世界のホームユーザーからしても待ち望んでいた対応です。これでSophos FirewallのIPv6での苦肉の策である、ULAからIPv6NATという方式から解放されます。ただ個人的には、私の利用しているauひかりの場合残念ながらPrefix Delegationが使えません。いや、正確には64ビットのサブネットが1つだけ割り振られるようではあるのですが、本来、Prefix Delegationは60ビットや56ビットなどの複数のサブネットを受け取り、個々のネットワークに割り当てることになりますから、1つだけあるというのは正規のDelegationという意味合いも少し違います。</p><p>とはいえ、auひかり以外のユーザーのために中身を確認していきます。</p><p>ネットワークの設定からWANを選び、モードは<mark class="label primary">手動</mark>にして<mark class="label primary">DHCPプレフィックスの委任</mark>を選択します。</p><img src="/new-technology/2023/11/12/xg-v20/ipv6-1.png" class="" width="480" title="alt"><mark class="label primary">優先する委任プレフィックス</mark>はホームユーザーは固定IPで予め指定されたPrefixがあるわけでは無いので設定せずOFFのままで構いません。法人の場合など、固定IPv6を保有する場合、Prefixと委任されるレングスとを入力しますが、デフォルトでは空です。私の場合、4バイト目でauひかりから1を貰っていたので、16ビット分のサブネットが使えるかもしれないと試行錯誤で設定しましたが、その情報が消せずに残っています。<p>続いて、LANの設定です。</p><img src="/new-technology/2023/11/12/xg-v20/ipv6-2.png" class="" width="640" title="alt"><p>ここでは、<mark class="label primary">IPの割り当て</mark>に<mark class="label primary">委任</mark>を選びます。続いて、<mark class="label primary">アップストリームのインターフェース</mark>として、WANであるPort2を選びます。<br>auひかりでは、ISP は、IPv6 プレフィックスを委任していませんと警告メッセージが表示されてしまいますが、NTT系などでは56ビットのPrefix委任が行われ設定が可能となるはずです。この中でLANに任意の64ビットのネットワークを割り当てることになります。</p><p>余談ですが、Sophos Firewallv20のEarly Accessプログラムで私は事前検証していたのですが、Sophos Firewallでは&#x2F;48, &#x2F;52, &#x2F;56, そして &#x2F;60がサポートされ、それ以外はサポートされないというSophos側からの回答でした。</p><p>実はEarly Accessのv20ではもう少し挙動が異なり、64ビットは受け取れていました。Sophosの話ではありませんが、Ubiquiti関係のコミュニティでもauひかりからIPv6のDHCPv6-PDは<strong>出来ない事もない</strong>という情報共有もあり64ビット１つは割り当て可能という事実は認識していました。</p><img src="/new-technology/2023/11/12/xg-v20/ea.png" class="" width="480" title="alt"><p>auひかりのWANのPrefixの4バイト目は”1”であり、LANのDelegationで確認したPrefix4バイト目は”2”でした。せめてサブネット１つだけでもIPv6 Delegationが出来ればと思いましたが、残念ながら製品版では、エラーチェックが強化された上で&#x2F;64は排除されてしまいました。</p><p>いっそのこと気前よく&#x2F;48くらい割り当てて貰えないかなと思いつつ、一応auひかりのサポート窓口にDHCPv6 Delegationに対応してほしいという要望は出しておきました。</p><h2 id="アクティブな脅威対応"><a href="#アクティブな脅威対応" class="headerlink" title="アクティブな脅威対応"></a>アクティブな脅威対応</h2><p>Firewallの左ペインメニューでは<mark class="label primary">アクティブな脅威対応</mark>というメニューがあります。<br>ここでは2種類の脅威対応があります。１つは名称変更でATP (Advanced Threat Protection) という旧機能がSophos X-Ops 脅威フィードに名称が変更されています。過去、ログを見ても殆どこのATPに関するログは見ることはありませんでした。</p><p>もう1つは、MDR脅威フィードという機能です。外部の MDR アナリストがネットワークの脅威フィードを特定し、自動的にファイアウォールにプッシュし、複数のファイアウォールモジュールが、これらのフィードに基づいてトラフィックをブロックするとのことです。</p><p>この２つの機能はログでもアクティブな脅威対応という項目で確認できます。</p><div class="note info"><p>仮想環境（ESXi）上にFirewallをインストールされている方はアップグレードの前に、「<a href="/2020/10/11/esxi-backup/" title="VMware ESXiの仮想マシンをバックアップする">VMware ESXiの仮想マシンをバックアップする</a>」を参考に、バックアップを確保される事をお勧めします。</p></div>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2023/11/12/xg-v20/Title.png&quot; class=&quot;&quot; title=&quot;alt&quot;&gt;

&lt;h2 id=&quot;Sophos-Firewall-v20&quot;&gt;&lt;a href=&quot;#Sophos-Firewall-v20&quot; class=&quot;headerlink&quot; title=&quot;Sophos Firewall v20&quot;&gt;&lt;/a&gt;Sophos Firewall v20&lt;/h2&gt;&lt;p&gt;Sophos Firewall v20が2023年11月06日に発表されました。個人向けとしては、IPv6 DHCP Prefix Delegationのサポートがなされています。&lt;/p&gt;</summary>
    
    
    
    <category term="Security" scheme="https://yoshi0808.github.io/new-technology/categories/Security/"/>
    
    
    <category term="XG Firewall" scheme="https://yoshi0808.github.io/new-technology/tags/XG-Firewall/"/>
    
  </entry>
  
  <entry>
    <title>iPhone15 ProとWiFi6E</title>
    <link href="https://yoshi0808.github.io/new-technology/2023/10/21/iPhone15pro/"/>
    <id>https://yoshi0808.github.io/new-technology/2023/10/21/iPhone15pro/</id>
    <published>2023-10-20T22:00:00.000Z</published>
    <updated>2023-10-20T22:37:34.927Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2023/10/21/iPhone15pro/Title.png" class="" width="1024" title="alt"><p class="onepoint">この記事で実現すること</p>iPhone15 Proを購入しました。代表的なものはWi-Fi6Eへの対応ですが、色々なものに繋いだ所感を書いていきます。<span id="more"></span><h2 id="Wi-Fi-6E"><a href="#Wi-Fi-6E" class="headerlink" title="Wi-Fi 6E"></a>Wi-Fi 6E</h2><p>ネットワークに興味がある方としては、iPhone15 Pro&#x2F;Pro MAXがWi-Fi 6Eに対応した事が大きいですね。160MHz幅で接続可能です。 MacbookであればTimeMachineでバックアップの時間短縮できるなど明らかなメリットがあるのですが、スマホではそのメリットが感じにくいところではあります。撮影した4K動画のNASへのアップロードが短縮できることや、画面のリフレッシュ速度も向上し端末全体が高速化しているので、Webブラウジングもより快適に感じます。</p><ul><li><p>SpeedTest</p><img src="/new-technology/2023/10/21/iPhone15pro/speedtest.png" class="" width="360" title="alt"></li><li><p>iPerf3</p><img src="/new-technology/2023/10/21/iPhone15pro/iperf3.png" class="" width="360" title="alt"></li></ul><p>まずまずの速度が出ています。私の環境ではInternet向けにはFirewallが入っていることもあり、一般的にはもう少し速度が出るかもしれません。</p><p>なお、iOSに限らず、macOSでもそうなんですが、Appleデバイス全般の注意事項としては、Wi-Fi 6E単独のチャンネルでは安定せず、2.4GHz、5GHz、6GHz全てを有効にしたSSIDを作成する必要があります。</p><blockquote><p>Apple 製デバイスで Wi-Fi 6E ネットワークを利用する<br> <a href="https://support.apple.com/ja-jp/HT213433">https://support.apple.com/ja-jp/HT213433</a></p></blockquote><p>単独のWi-Fi6EではSpeedtestでも安定せず途中でテストが終了したり不安定です。これはMacbook Pro(2023)でも同じです。<br>6E単独で接続した場合は、iOSで以下の警告が表示されます。</p><img src="/new-technology/2023/10/21/iPhone15pro/ios.png" class="" width="400" title="alt"><p>制約のように見えますが、Wi-Fi6Eの電波の見つけ方の方法によってこのような挙動になります。Apple製品のように、必ずしもWi-Fi6Eのみに接続されていない5GHzの端末ともスムーズに連携するためには必要なのでしょう。</p><h2 id="Wi-Fi-ローミング"><a href="#Wi-Fi-ローミング" class="headerlink" title="Wi-Fi ローミング"></a>Wi-Fi ローミング</h2><p>Wi-Fiローミングというのは同一SSIDで異なるアクセスポイント（AP)に自動で切り替わることです。最近の無線ルーターではメッシュ機能を持つものが増えてきました。例えば、1階から2階に移動した時に近くにあるアクセスポイントに自動的に切り替わり、より快適に使えるようになるというものです。</p><p>このローミングについて説明しだすとかなり長くなるのでここでは簡単にiPhoneに関して説明します。<br>iPhoneはWi-Fiの電波が-70dBmを下回ると、他のAPにローミングしようとします（厳密には他のAPを探すという工程も含まれます）。その際、高速にローミングが行えるかどうかというのがスマホの使い勝手では重要です。</p><p>一般的にスマホがWi-Fiに繋がる場合は、無線に接続する際の認証が行われ、DHCPによってIPアドレスを割り当てるという手順が入ります。この手順をAPが変わるたびに実施していたのでは最低でも1秒程度の切断が発生します。つまり通話中にフロアを移動していると途中でパケットの再送が入りますが、IPアドレスの再取得をやっていたのでは通話、アプリが切断されることになります。これらに対処するものが高速ローミングです。</p><p>高速ローミングは認証情報がキャッシュされることが必須です。私たちが一般的に使うようなSSID毎のパスワードであったり、企業で使われるRADIUS認証によるユーザー認証情報をキャッシュし、別のAPで速やかにIPアドレス引き継ぎと高速な再認証が必要です。</p><p>このような方法によって、高速ローミングが実現し、数十ミリ〜遅くとも100ミリ程度でAPが切り替わり、その際に通話が途絶えることはありません。パケットの再送は確実に行われますが、スマホやリモート会議などでは1秒近くのバッファリングがあるので再送による遅延にユーザーが気づくことはあまりありません。</p><p>お使いのAPによって挙動は変わりますが、以下は私が自宅で1階から2階に移動した時のPingの結果です。PingPlotterというアプリでGoogleまでのラウンドトリップを計測しています。最初に他のAPを探すところで第1段階の遅延、切り替わるところで第2段階の遅延が発生します。</p><img src="/new-technology/2023/10/21/iPhone15pro/plotter.png" class="" width="480" title="alt"><p>丸を2つ示していますが、左側が最初の遅延で250ミリ秒近くあります。これはAPを探している状態に入っています。このタイミングではAPー端末間の通信が保留になり遅延が発生します。本当にタイミングが悪ければパケットを取りこぼすこともあり再送が入ります。が、極めて小さな時間でありTCP&#x2F;IPやアプリケーションの再送機能によって大半はカバーされます。これはやや悪いケースの計測結果であり、一旦情報がキャッシュされるなどしていて、良いケースではその半分程度まで遅延が軽減されます。<br>右側の丸辺りで実際にローミングしています。これは20ミリ秒程度の遅延です。スマホのWi-Fiのアンテナ表示が変わったタイミングを目視により確認しました。</p><p>なお、APを探すところで250ミリあるのは私の環境の問題にも関わっており、iPhoneがAPから離れすぎた状況（-75dBmを下回る）のためと考えられます。電波の強さと端末との距離を考えながらAPの配置を行う必要があり、これには計測とトライアンドエラーの繰り返しが必要です。ちょうど家の端の階段の辺りが電波の弱いところで、そこにAPをさらに置いても良いのですが、100ミリ秒程度の改善でそこまで対応する気にもならずそのままにしています。</p><p>iPerf3を実行しながらフロアを移動した場合、瞬間的にはAPを探すところで数十Mbpsまでに落ち込むケースもありますが、完全に0となったりエラーになることはありません。</p><p>これ以上の話は複雑なのでまた別の機会があれば触れてみたいと思いますが、リビングでTeamsやZoomなどのリモート会議をしていて、家族が帰ってきてバタバタと2階に移動する際にも相手の発言が途切れることはありません。</p><p>iPhone15Proは、以前のiPhone11やiPhone12よりも電波を掴む力は強いように感じます。5GHzの電波ではまれに公衆回線に切り替わっていたお風呂でのブラウジングが捗ります😊</p><h2 id="有線バックホールとメッシュWi-Fi"><a href="#有線バックホールとメッシュWi-Fi" class="headerlink" title="有線バックホールとメッシュWi-Fi"></a>有線バックホールとメッシュWi-Fi</h2><p>APは一般的に有線で接続され、前述したようにローミング機能を提供しますが、個人向けのメーカーでは有線バックホールという名前が使われる場合があります。AP同士のコミュニケーションや通信を有線によって行うためです。一方、この有線バックホールを使わず、AP同士が無線で接続する形態をメッシュと呼んでいるようです。</p><p>このメッシュも独立したチャンネルを使う方法や端末と同一のチャンネルを使う方法など色々あり、各社のマニュアルを見ても、それについてはあまり明確に記載されていないものが多いようです。</p><p>なお、一般的にビジネスで用いられるローミング方式（有線バックホール）では、AP同士は異なる周波数（チャネル）にするのが基本です。<strong>異なるAP</strong>で<strong>同じ周波数</strong>を使っていると、昔の中継機と同じで<strong>それぞれのAPが出す電波同士で干渉してしまい、パフォーマンスが出ません</strong>。メッシュにすると遅くなるという感覚をお持ちの方も多いのではないでしょうか。</p><p>高速なローミングとWi-Fiの最大限のパフォーマンスを引き出すにはAP同士は異なるチャンネルを設定する必要があります。これは製品によって対応できないものもあるようですので確認をお勧めします。</p><p>有線バックホールを使わないケース、これは4LDK以上の広いフロアで物理配線が引けないなどの制約がある場合にやむなくAPをメッシュで分散配置する事については意味があります。ただそのような環境では後述するDFSを除けば、Wi-Fi6Eとなるメリットはあまり見出せないかもしれません。5GHzよりは6GHzの方が壁を通す力は落ちますから、5GHzの方がより電波は強力です。</p><h2 id="メッシュWi-FiとDFS"><a href="#メッシュWi-FiとDFS" class="headerlink" title="メッシュWi-FiとDFS"></a>メッシュWi-FiとDFS</h2><p>個人向けの5GHzでは割り当てられた電波の幅によって80MHz単位で使うことが一般的ですが、5.2GHz帯のみDFSが無く、5.3GHz、5.6GHzはDFSがあります。レーダーを受信するとAPが停波してしまうことになりますから、レーダー回避のために6GHzを使うのは有効です。</p><h2 id="私の環境"><a href="#私の環境" class="headerlink" title="私の環境"></a>私の環境</h2><p>私の環境ではUbiquitiのUniFi製品を利用しています。<br>以下はUniFiのトポロジーで自動的に構成されたネットワーク図です。上流のインターネット回線は、auひかり（10GbE）を使っています。</p><img src="/new-technology/2023/10/21/iPhone15pro/unifi.png" class="" width="800" title="alt"><p>APはU6 Enterpriseという製品で、PoEで2.5GbEのLAN接続と併せてスイッチから電源を取ります。<br>よくよく考えてみれば、クライアントが繋がっているスイッチからいきなりローミングして別のスイッチに切り替われば、スイッチは「いきなり別のスイッチポートから同じMACアドレスの端末のデータが届きネットワークループしてるのではないか」と混乱するはずです。しかし、そこはきちんと制御され、ローミングしたクライアントについて、接続されたすべてのスイッチのMACアドレステーブルを瞬時に更新しにいくようです。</p><blockquote><p>U6 Enterpriseアクセスポイント<br> <a href="https://jp.store.ui.com/collections/unifi-network-wireless/products/u6-enterprise">https://jp.store.ui.com/collections/unifi-network-wireless/products/u6-enterprise</a></p></blockquote><blockquote><p>Switch Enterprise 8 PoE スイッチ<br> <a href="https://jp.store.ui.com/collections/unifi-network-switching/products/switch-enterprise-8-poe">https://jp.store.ui.com/collections/unifi-network-switching/products/switch-enterprise-8-poe</a></p></blockquote><p>UniFi製品については、このブログでも取り上げています。</p><ul><li>「<a href="/2022/08/27/ubiquiti-unifi/" title="Ubiquiti UniFiの世界">Ubiquiti UniFiの世界</a>」</li><li>「<a href="/2022/11/23/unifi-switch/" title="UniFiスイッチ">UniFiスイッチ</a>」</li><li>「<a href="/2022/12/31/unifi-ap/" title="UniFi Wi-Fiシステム">UniFi Wi-Fiシステム</a>」</li></ul><h2 id="公衆回線（5G）"><a href="#公衆回線（5G）" class="headerlink" title="公衆回線（5G）"></a>公衆回線（5G）</h2><p>公衆回線（5G)においては、iPhoneの実力というよりは公衆回線の環境が色濃く出ると思いますが、どうでしょうか。<br>海外サイトのSpeedSmartでは、5Gの速度テストにおいて、iPhone15 ProはiPhone14 Proよりも24％速いとレポートしています。</p><blockquote><p>SpeedSmart.net<br> <a href="https://speedsmart.net/blog/post/2005/iPhone-15-Pro-up-to-24-Faster-5G-Download-Speeds">https://speedsmart.net/blog/post/2005/iPhone-15-Pro-up-to-24-Faster-5G-Download-Speeds</a></p></blockquote><p>米国での5G速度は300Mbpsオーバーとの事です。<br>都内の某所（勤務先）で帰宅時に計測してみました。5G(5Gオート）と4Gとそれぞれ切り替えて計測してみます。</p><p>5G</p><img src="/new-technology/2023/10/21/iPhone15pro/5G.png" class="" width="360" title="alt"><p>4G</p><img src="/new-technology/2023/10/21/iPhone15pro/4G.png" class="" width="360" title="alt"><p>都心ではまずまずの速度です（5Gでは500Mbps超えると期待していましたが）。ビルの中に入っても100Mbps程度しか落ち込みません。</p><p>最も混雑する時間帯と言われる12時過ぎの状況は以下の通りです。</p><p>5G</p><img src="/new-technology/2023/10/21/iPhone15pro/5G1.png" class="" width="360" title="alt"><p>4G</p><img src="/new-technology/2023/10/21/iPhone15pro/4G1.png" class="" width="360" title="alt"><p>5Gは快適ですが、4Gは少し苦しいですね。やはりお昼時は4Gのユーザーがまだまだ多く速度が落ち込むようです。<br>もちろん、地下鉄では4Gですし、5G網も郊外に行くと4Gに切り替わったり途端に数十Mbps程度まで落ち込みます。また、私の計測した場所は「都内でたまたま計測した場所」ですので、ご参考に留めていただければと思います。</p><h2 id="USBハブに繋げてみる"><a href="#USBハブに繋げてみる" class="headerlink" title="USBハブに繋げてみる"></a>USBハブに繋げてみる</h2><p>iPhone15 ProはUSB-Cに対応しました。USB 3.2 Gen2に（USB3.1 Gen2と同義）対応し、10Gbpsの速度が出ます。パッケージに付属してくるUSB-CケーブルはUSB 2.0に対応（480Mbps)との事で高速通信のメリットは活かせません。</p><blockquote><p>Apple iPhone 15 の USB-C コネクタで充電および接続する<br> <a href="https://support.apple.com/ja-jp/HT213839">https://support.apple.com/ja-jp/HT213839</a></p></blockquote><p>「Belkin 7 in 1 USB-C 2.5Gbpsイーサネットハブ」に繋いでみます。</p><img src="/new-technology/2023/10/21/iPhone15pro/hub.png" class="" width="800" title="alt"><p>iPhoneの画面はUSBハブからHDMIで接続されたモニタにも映し出されますし、ネットワーク通信も可能で2.5GbEでの速度が当たり前のように出ます（ハブはUSB-PD電源に接続しています）。</p><img src="/new-technology/2023/10/21/iPhone15pro/speedtesthub.png" class="" width="360" title="alt"><p>念の為、無線を利用しないように機内モードに設定しています。</p><p>スマホの写真をNASに大量にアップロードする時などは、WiFi6Eが速いと言っても、2.5GbEの有線はレイテンシが小さいことによって高速にアップロード可能です。今回、NASにある無駄な写真や動画を一旦削除してスマホから整理済みの全ての写真・動画をSynologyのPhoto Mobileというアプリを使って再アップしたのですが、非常に高速でした。感覚的ですがWiFi6Eの2、3倍といった感じです。アプリの作りにもよりますけれども、写真または動画を1枚単位にアップロードする仕組みのアプリケーションでは、5本も6本ものスレッドで分散してアップロードはしないと思われますのでハードウェアでカバーできる一例でしょうか。こういったケースは今回のようなスマホ入れ替え時など滅多に発生しないケースですが、USB 3.2 Gen2（10GbE）となった事で非常に便利になりました。</p><blockquote><p>Belkin<br> <a href="https://www.belkin.com/jp/usb-c-7-in-1%E3%83%9E%E3%83%AB%E3%83%81%E3%83%9D%E3%83%BC%E3%83%88%E3%82%A2%E3%83%80%E3%83%97%E3%82%BF%E3%83%BC/INC009btSGY.html">https://www.belkin.com/jp/usb-c-7-in-1マルチポートアダプター/INC009btSGY.html</a></p></blockquote><h2 id="Macbookに繋げてみる"><a href="#Macbookに繋げてみる" class="headerlink" title="Macbookに繋げてみる"></a>Macbookに繋げてみる</h2><p>Macbookはテザリングの逆、iOSにネットワーク機能を提供できます。</p><img src="/new-technology/2023/10/21/iPhone15pro/mac.png" class="" width="480" title="alt"><p>実用性を考えると利用するシチュエーションはなかなか見出せませんが、Macbookが10GbEのネットワークに接続されている環境があれば、iPhone15 Proはさらに高速に通信が可能となります。</p><img src="/new-technology/2023/10/21/iPhone15pro/speedtestmac.png" class="" width="360" title="alt"><p>USB 3.2 Gen2やネットワークも10Gbpsとなればそれを基準と考え、その他周辺機器ともできるだけ速度差を無くしたいものです。例えばUSBメモリやSDカードはどうでしょうか？昔ながらにOSのセットアップなどに使ってきた経緯がありますが、技術の進歩でSDカードが大容量になったとしても速度とのバランスが悪いのではないでしょうか。今は10GbpsのUSBのSSDケース（M2.2280）が2、3千円で買えますので、廉価となったNVMeのSSDを挿して使うのはいかがでしょうか？USB3.2 Gen2であれば読み込み、書き込み共に10Gbps出ますし、NASのキャッシュ用で使っていた余りなどがあればそれを再利用するのも良いですね。</p><h2 id="Apple-CarPlay"><a href="#Apple-CarPlay" class="headerlink" title="Apple CarPlay"></a>Apple CarPlay</h2><p>Apple CarPlayは既に知られたサービスでiPhone15 Proになったからといって何かが変わるわけではありません。iOS17からはSharePlayという機能が追加され、車の中で搭乗者が（iPhoneを持っていれば）Apple Musicのセッションに参加し、搭乗者の好きな音楽を運転者のiPhoneのCar Playで再生できるようになりました。仕組みとしてはこれまであったAir Playに近いものがありますね。仲間で音楽もシェアする、時代を感じさせるサービスです。Siriの機能と組み合わせてマップの到着予定時刻を家族に共有できます。<br>iPhoneが車載のBluetoothに接続するとiOSの集中モードが自動的に運転モードに変わり通知などを制限できるようにもできます。<br>CarPlayも地道なアプリケーションの改善によってかなり使い勝手の良いシステムとなっています。</p><img src="/new-technology/2023/10/21/iPhone15pro/carplay.png" class="" width="1024" title="alt"><p>個人的にはThunderbolt3ケーブルでiPhoneとカーナビとを繋いでいるという事実が感慨深いものがあります。。。</p><h2 id="画面との距離"><a href="#画面との距離" class="headerlink" title="画面との距離"></a>画面との距離</h2><p>iPhone15 Proと直接関係ありませんが、iOS17からFaceIDに関連する機能追加として<strong>画面との距離</strong>があります。これはスマホに顔を近づけすぎると眼精疲労警告のため、画面全体が警告メッセージで覆われるというものです。これは子供の視力悪化対策に有用です。iPadでFaceIDに対応している製品は最新のiPad Proしかない（他はTouchID）ので、iOSのタブレットでこの機能を使いたければ（子供に利用させたければ）iPad Proを購入することになるのでしょうか。。。</p><img src="/new-technology/2023/10/21/iPhone15pro/screendistance.png" class="" width="360" title="alt">]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2023/10/21/iPhone15pro/Title.png&quot; class=&quot;&quot; width=&quot;1024&quot; title=&quot;alt&quot;&gt;

&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;
iPhone15 Proを購入しました。代表的なものはWi-Fi6Eへの対応ですが、色々なものに繋いだ所感を書いていきます。</summary>
    
    
    
    <category term="Hardware" scheme="https://yoshi0808.github.io/new-technology/categories/Hardware/"/>
    
    <category term="Network" scheme="https://yoshi0808.github.io/new-technology/categories/Network/"/>
    
    
  </entry>
  
  <entry>
    <title>Synology NASでESXi仮想マシンのバックアップを取得する</title>
    <link href="https://yoshi0808.github.io/new-technology/2023/09/16/Synology-abb/"/>
    <id>https://yoshi0808.github.io/new-technology/2023/09/16/Synology-abb/</id>
    <published>2023-09-15T15:44:10.000Z</published>
    <updated>2023-09-16T00:44:28.464Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2023/09/16/Synology-abb/install.png" class="" width="1024" title="alt"><p class="onepoint">この記事で実現すること</p><p>SynologyのNASでは無償版ESXiの仮想マシン（VM）バックアップが可能なActive Backup for Business(ABB)というソフトウェアが提供されています。Microsoft Hyper-V2016および2019にも対応しています。無償版ESXiのバックアップソフトは「<a href="/2021/03/06/esxi-nakivo/" title="無償版ESXiの高度なバックアップ">無償版ESXiの高度なバックアップ</a>」で書いた有償のもの（1年期限の無償版）は存在します。無償バックアップソフトは無償版ESXiに対応していないという難しい状況でしたが、NASが必須という前提はあるものの、追加コストゼロでESXi仮想マシンのバックアップが可能です。エージェントレスで、ESXi本体やVMには何もインストールする必要はありません。</p><blockquote><p>Synology<br> <a href="https://www.synology.com/ja-jp/dsm/feature/active-backup-business/virtual-machine">https://www.synology.com/ja-jp/dsm/feature/active-backup-business/virtual-machine</a></p></blockquote><span id="more"></span><h2 id="稼働条件"><a href="#稼働条件" class="headerlink" title="稼働条件"></a>稼働条件</h2><p>ABBは基本はSynologyNASのPlusモデルで、Btrfsでフォーマットされたファイルシステムが必要です。一部のPlusモデルにはBtrfsに対応しない製品もあるので事前の確認をお勧めします。</p><p><a href="https://www.synology.com/ja-jp/dsm/packages/ActiveBackup">https://www.synology.com/ja-jp/dsm/packages/ActiveBackup</a></p><h2 id="ABBの主要な機能について"><a href="#ABBの主要な機能について" class="headerlink" title="ABBの主要な機能について"></a>ABBの主要な機能について</h2><p>ここでは、ESXi仮想マシンのバックアップに目的を絞って説明します。</p><ol><li>ESXi7.0、8.0対応</li><li>VMのバックアップを複数世代管理</li><li>ジョブスケジューリング機能<br> ワンタイム、定期、日次、週次、月次を利用できます。</li><li>重複排除<br> VMWareのChange Block Trackingに対応。</li><li>暗号化転送</li><li>バックアップデータの暗号化</li></ol><h2 id="Synology-NASの事前準備"><a href="#Synology-NASの事前準備" class="headerlink" title="Synology NASの事前準備"></a>Synology NASの事前準備</h2><h3 id="ABBのインストール"><a href="#ABBのインストール" class="headerlink" title="ABBのインストール"></a>ABBのインストール</h3><p>NASのWeb画面に管理者としてログインし、パッケージセンターから”Active Backup for Business”をインストールします。</p><img src="/new-technology/2023/09/16/Synology-abb/install.png" class="" width="1024" title="alt"><p>上記はインストール済みの状態ですが、<mark class="label primary">「インストール」ボタン</mark>をクリックしてインストールします。<br>NASのFirewallを利用している場合は自動的にPort5510を開けるようにFirewallにルールが追加されます。</p><h2 id="可用性および機密性向上のために"><a href="#可用性および機密性向上のために" class="headerlink" title="可用性および機密性向上のために"></a>可用性および機密性向上のために</h2><ul><li>フォルダの容量制限（クォータ）についてはABBでは推奨されていません。</li><li>ESXiに対してSSHでの接続が必要です。セキュリティ向上のためroot相当の専用ユーザーをESXiに新規作成されることをお勧めします。</li></ul><h2 id="ESXiの事前準備"><a href="#ESXiの事前準備" class="headerlink" title="ESXiの事前準備"></a>ESXiの事前準備</h2><p>ESXiには以下の設定が必要です。</p><ol><li>VMWare Toolsのインストールが必要です。</li><li>ABBからESXiに対しHTTPS(Port443)、SSH(Port22)を使って接続可能なようにサービスを設定します。</li><li>ABBで無償版ESXiをバックアップするためにはCBT(Changed Block Tracking)を手動で有効にする必要があります。</li><li>（任意）セキュリティ向上のため、ESXi上に管理者アカウントを作成します。</li><li>（任意）セキュリティ向上のため、Port22,443で接続可能なIPアドレスをESXi上のFirewall設定で絞ります。</li></ol><h2 id="ESXi上でHTTPS、SSHの解放"><a href="#ESXi上でHTTPS、SSHの解放" class="headerlink" title="ESXi上でHTTPS、SSHの解放"></a>ESXi上でHTTPS、SSHの解放</h2><p>無償版ESXiを使う場合はブラウザから基本はvSphere Web Clientを使いますので、HTTPS(Pprt443)の解放は特に意識する必要はありません。ESXiのファイアウォールで接続可能なIPアドレスを絞っている場合はNASのIPアドレスから接続できるようにしておきます。</p><p>SSH(Port22)についてはESXiはデフォルトでサービス停止されている状態ですので、シェルおよびSSHのサービスを起動します。<br>左ペインメニューの<mark class="label primary">ホスト</mark>ー<mark class="label primary">管理</mark>の<mark class="label primary">サービスタブ</mark>から<mark class="label primary">TSM</mark>および<mark class="label primary">TSM-SSH</mark>を起動します。<br> <img src="/new-technology/2023/09/16/Synology-abb/esxi1.png" class="" width="800" title="alt"><br>この2つのサービスは右クリックメニューの<mark class="label primary">ポリシー</mark>から<mark class="label primary">ホストと連動して起動および停止します</mark>をチェックしておく事でESXiの起動時に自動的にサービスが起動するようになります。</p><h2 id="VMのChanged-Block-Trackingの設定"><a href="#VMのChanged-Block-Trackingの設定" class="headerlink" title="VMのChanged Block Trackingの設定"></a>VMのChanged Block Trackingの設定</h2><p>ESXiの機能であるChanged Block Tracking(CBT)はVMが稼働していて前回バックアップしたものから未更新のディスクブロックをスキップして差分のみバックアップする機能です。バックアップに必要な領域を削減できます。途中で別のバックアップ製品によるバックアップ、例えばghettoVCBなどでバックアップされると、次回のバックアップはフルバックアップを行います。</p><p>この設定にあたり、事前にVMのデータを退避することをお勧めします。VMを停止のうえで、データストアブラウザからVMの入っているフォルダ毎別の場所にコピーしてください。もし、設定の変更でVMを壊してしまった場合は、当該フォルダの<code>VM名.vmx</code>を右クリックから「VMの登録」で再登録できます。</p><h3 id="設定方法"><a href="#設定方法" class="headerlink" title="設定方法"></a>設定方法</h3><p>最初にVMがインストールされているディスクを調べ、そのSCSI-IDを確認します。<br>ESXi管理画面のVMを選択し右クリックして<mark class="label primary">設定の編集</mark>をクリックします。</p><img src="/new-technology/2023/09/16/Synology-abb/esxi2.png" class="" width="640" title="alt"><mark class="label primary">ハードディスク</mark>の詳細を開き、<mark class="label primary">コントローラの場所</mark>でSCSI-IDを確認します（SCSI(0:0)など）。<ol><li>VMを停止します。</li><li>ESXi管理画面のVMを右クリックして、<mark class="label primary">設定の編集</mark>をクリックします。</li><li><mark class="label primary">VMオプション</mark>タブをクリックします。</li><li><mark class="label primary">詳細</mark>セクションを開き <mark class="label primary">設定パラメータ</mark>の<mark class="label primary">設定の編集</mark>をクリックします。<mark class="label primary">設定パラメータ</mark>ダイアログが開きます。</li><li><mark class="label primary">パラメータの追加</mark>をクリックします。</li><li><code>ctkEnabled</code>パラメータを追加して、その値を<code>true</code>に設定します。</li><li>さらに<mark class="label primary">パラメータの追加</mark>をクリックし、<code>scsi0:0.ctkEnabled</code>を追加して、その値を<code>true</code>に設定します（環境に合わせて<code>scsi0:0</code>の内容は変更してください）。</li><li>OKボタンをクリックし設定を完了させます。</li><li>VMを起動します。</li><li>SSHでESXiに入り、VMが配置されているディレクトリで、<code>VM名-ctk.vmdk</code>ファイルがあることを確認します。</li></ol><p>CBTを無効にする場合はこの逆の手順、ctkEnabledの値をfalseに設定します。<br>VMWareによるCBTの説明は以下を参照してください。</p><blockquote><p>VMware VM上の変更ブロックのトラッキング（CBT） (1020128)<br> <a href="https://kb.vmware.com/s/article/1031873?lang=ja&amp;queryTerm=changed+block+tracking">https://kb.vmware.com/s/article/1031873?lang=ja&amp;queryTerm=changed+block+tracking</a></p></blockquote><h2 id="（任意）管理者アカウントの作成"><a href="#（任意）管理者アカウントの作成" class="headerlink" title="（任意）管理者アカウントの作成"></a>（任意）管理者アカウントの作成</h2><p>セキュリティの観点からrootはできるだけ使わない事をお勧めします。これは一般論でありrootがよく知られたユーザー名だからです。以下の手順で管理者アカウントを作成します。</p><ol><li>管理メニューの左ペイン<mark class="label primary">ホスト</mark>ー<mark class="label primary">管理</mark>から<mark class="label primary">セキュリティとユーザー</mark>に進み、<mark class="label primary">ユーザー</mark>から<mark class="label primary">ユーザーの追加</mark>をクリックします。<img src="/new-technology/2023/09/16/Synology-abb/esxi5.png" class="" width="800" title="alt"></li><li>ABBから接続する専用のユーザー名とパスワードを登録してユーザーの作成を終えます。</li><li>管理メニューの左ペイン<mark class="label primary">ホスト</mark>から<mark class="label primary">アクション</mark>を選択し、プルダウンの<mark class="label primary">権限</mark>をクリックします。</li><li>さらに<mark class="label primary">ユーザーの追加</mark>を選択します。実際には上記で作成したユーザーと同一名のユーザー名を入力します。ロールについては”システム管理者”を選択します。<img src="/new-technology/2023/09/16/Synology-abb/esxi4.png" class="" width="800" title="alt"></li></ol><p>これで新しいユーザーが作成できたので、Web管理画面からログイン可能か確認してください。</p><h2 id="（任意）SSH、Web-Clientのために接続可能なIPアドレスを絞る"><a href="#（任意）SSH、Web-Clientのために接続可能なIPアドレスを絞る" class="headerlink" title="（任意）SSH、Web Clientのために接続可能なIPアドレスを絞る"></a>（任意）SSH、Web Clientのために接続可能なIPアドレスを絞る</h2><p>この機能はESXiではファイアウォールと呼ばれ、Linuxのiptablesやufwと同様にシンプルなものです。ホームユーザーはシンプルなLANで閉じられたアクセスですが、安全のために特にSSHは設定を検討すべきです。<br>Web管理画面の左ペインメニューの <mark class="label primary">ネットワーク</mark>を選択し、<mark class="label primary">ファイアウォール</mark>タブをクリックして見つける事ができます。デフォルトでは一切の制約なく接続可能になっていますので、ここでSSHとWeb Clientに接続可能なIPを登録できます。</p><img src="/new-technology/2023/09/16/Synology-abb/esxi5.png" class="" title="alt"><h2 id="ABBの利用について"><a href="#ABBの利用について" class="headerlink" title="ABBの利用について"></a>ABBの利用について</h2><p>ABBの使い方については公式のクイックガイドが提供されています。</p><blockquote><p>Active Backup for Business クィック スタート ガイド<br> <a href="https://kb.synology.com/ja-jp/DSM/tutorial/Quick_Start_Active_Backup_for_Business">https://kb.synology.com/ja-jp/DSM/tutorial/Quick_Start_Active_Backup_for_Business</a></p></blockquote><p>ABBでは管理者（Administratorsグループ）ユーザーのみが操作できます。</p><h2 id="仮想マシンのABBへの登録"><a href="#仮想マシンのABBへの登録" class="headerlink" title="仮想マシンのABBへの登録"></a>仮想マシンのABBへの登録</h2><p>DSMからABBを起動します。</p><img src="/new-technology/2023/09/16/Synology-abb/abb1.png" class="" title="alt"><p>仮想マシンを対象にします。</p><img src="/new-technology/2023/09/16/Synology-abb/abb2.png" class="" title="alt"><p>最初にバックアップ対象となるESXiを登録します。</p><img src="/new-technology/2023/09/16/Synology-abb/abb3.png" class="" width="640" title="alt"><p>バックアップ対象となるESXiのIPアドレス、アカウントを入力します。</p><img src="/new-technology/2023/09/16/Synology-abb/abb4.png" class="" width="640" title="alt"><p>ESXiに有効な証明書が設定されていないとワーニングが出ますが、ここはそのまま進みます。</p><img src="/new-technology/2023/09/16/Synology-abb/abb5.png" class="" width="640" title="alt"><p>ESXiへの接続が確認されチェックがOKであれば状態が<strong>成功</strong>となります。</p><img src="/new-technology/2023/09/16/Synology-abb/abb6.png" class="" width="640" title="alt"><p>エラーとなった場合は、ESXi側の設定、またはネットワークを確認してください。</p><h2 id="バックアップタスクの登録"><a href="#バックアップタスクの登録" class="headerlink" title="バックアップタスクの登録"></a>バックアップタスクの登録</h2><p>無事にESXiの情報がABBに取り込まれると、仮想マシンの情報が出力されます。</p><img src="/new-technology/2023/09/16/Synology-abb/abb7.png" class="" width="640" title="alt"><p>現在はバックアップが取得されておらず、タスクなしとなっています。</p><p>上記の<mark class="label primary">タスクの作成</mark>ボタンをクリックします。</p><p>仮想マシンが選択されます。</p><img src="/new-technology/2023/09/16/Synology-abb/abb8.png" class="" width="640" title="alt"><p>ここでタスク名を入力します。ここでは、ESXi8のUbuntu22のバックアップを取るのでESXi8.Ubuntu22とします。</p><p>続いてバックアップするフォルダを選択します。デフォルトでは、<mark class="label primary">ActiveBackupforBusiness</mark>になります。</p><img src="/new-technology/2023/09/16/Synology-abb/abb9.png" class="" width="640" title="alt"><p>最初のバックアップ時にフォルダの暗号化&#x2F;圧縮を設定します。私の場合すでに設定済みでありここでは変更できません。</p><img src="/new-technology/2023/09/16/Synology-abb/abb10.png" class="" width="640" title="alt"><p>バックアップオプションを選択します。Windows、Linuxのバックアップ時には<mark class="label primary">アプリケーション対応バックアップを有効化</mark>にチェックすることが推奨されます。<br>また、ESXiのCBTが有効である場合は<mark class="label primary">変更ブロック　トラッキングを有効化</mark>のチェックが有効になります。</p><img src="/new-technology/2023/09/16/Synology-abb/abb11.png" class="" width="640" title="alt"><p>改めて構成チェックが行われます。</p><img src="/new-technology/2023/09/16/Synology-abb/abb12.png" class="" width="640" title="alt"><p>続いて定期的なバックアップの設定です。</p><img src="/new-technology/2023/09/16/Synology-abb/abb13.png" class="" width="640" title="alt"><p>保持ポリシーを選定します。これはディスクの容量やバックアップ期間などに合わせて設定します。</p><img src="/new-technology/2023/09/16/Synology-abb/abb14.png" class="" width="640" title="alt"><p>復元を許可するユーザーを設定します。</p><img src="/new-technology/2023/09/16/Synology-abb/abb15.png" class="" width="640" title="alt"><p>最後のサマリで確認をし完了させます。今すぐバックアップを取得することもできます。</p><img src="/new-technology/2023/09/16/Synology-abb/abb16.png" class="" width="640" title="alt"><h2 id="仮想マシンのバックアップ実行"><a href="#仮想マシンのバックアップ実行" class="headerlink" title="仮想マシンのバックアップ実行"></a>仮想マシンのバックアップ実行</h2><p>64GBのシックプロビジョニングのUbuntu22の仮想マシンを手動でバックアップをしてみました。バックアップ速度についても計測してみます。</p><p><strong>環境</strong></p><p>ESXi8</p><table><thead><tr><th>パーツ</th><th>製品名</th></tr></thead><tbody><tr><td>CPU</td><td>AMD Ryzen5 5600G 6コア&#x2F;12スレッド 3.9-4.4GHz</td></tr><tr><td>メモリ</td><td>16GB(8GB×2) DDR4-3200</td></tr><tr><td>NVMe</td><td>WesternDigital Blue 500GB SSD &#x2F; NVMe M.2[PCIe 3.0×4]</td></tr><tr><td>NIC</td><td>Mellanox Connect X5(MCX512A-ACAT) SFP28 2Port</td></tr></tbody></table><p>Synology 1621+</p><table><thead><tr><th>パーツ</th><th>製品名</th></tr></thead><tbody><tr><td>CPU</td><td>AMD Ryzen V1500B クアッド コア 2.2 GHz</td></tr><tr><td>メモリ</td><td>8GB(4GB×2)</td></tr><tr><td>SSD</td><td>Samsung 870EVO 4TB(MZ-77E4T0B&#x2F;IT) &#x2F; SATA x 6(RAID5)</td></tr><tr><td>NIC</td><td>Mellanox Connect X4(MCX4121A-ACAT) SFP28 2Port</td></tr></tbody></table><p>SFP28(25GbE)のスイッチポートにそれぞれDACケーブルで接続しています。</p><p>ログの結果も非常に詳細で分かりやすいです。ここはさすがソフトウェアが売りのSynologyですね。</p><img src="/new-technology/2023/09/16/Synology-abb/time.png" class="" width="800" title="alt"><p>開発者が障害切り分けのために利用するログではなく、ユーザーに価値のある情報（ログ）を提供しています。これは他のメーカーとは根本的に出来が違います。</p><p>通知設定しているとメールも届きます。</p><blockquote><p>**** のバックアップタスク ESXi8.Ubuntu22 が完了しました。<br> 開始時間：2023-09-02 12:46<br> 終了時間：2023-09-02 12:47<br> 転送サイズ：24.7 GB<br> デバイス リスト：Ubuntu22</p></blockquote><p> 送信元 ****</p><p>まずは圧縮効果が出ており、64GBの仮想マシンが24.7GBとなっています。</p><p>さらに30分後、もう一度バックアップを取得してみます。今度は数秒で終了しました。通知では3.1MBとなっていました。これはESXiのCBTが有効で差分のみバックアップするためわずかの量に収まっていることになります。仮想マシンの稼働時間が長くなるとそれだけバックアップ量も増えることになります。</p><p>ちなみに、同一の環境でghettoVCBスクリプトでバックアップを取得した場合は以下の通り35秒でした。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">2023-09-03 01:27:50 -- info: ============================== ghettoVCB LOG START ==============================</span><br><span class="line">2023-09-03 01:27:52 -- info: Creating Snapshot <span class="string">&quot;ghettoVCB-snapshot-2023-09-03&quot;</span> <span class="keyword">for</span> Ubuntu22</span><br><span class="line">Destination disk format: VMFS thin-provisioned</span><br><span class="line">Cloning disk <span class="string">&#x27;/vmfs/volumes/datastore1/Ubuntu22/Ubuntu22.vmdk&#x27;</span>...</span><br><span class="line">2023-09-03 01:28:23 -- info: Removing snapshot from Ubuntu22 ...</span><br><span class="line">2023-09-03 01:28:23 -- info: Backup Duration: 31 Seconds</span><br><span class="line">2023-09-03 01:28:23 -- info: Successfully completed backup <span class="keyword">for</span> Ubuntu22!</span><br><span class="line"></span><br><span class="line">2023-09-03 01:28:25 -- info: <span class="comment">###### Final status: All VMs backed up OK! ######</span></span><br><span class="line"></span><br><span class="line">2023-09-03 01:28:25 -- info: ============================== ghettoVCB LOG END ================================</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="ABBの実行内容について"><a href="#ABBの実行内容について" class="headerlink" title="ABBの実行内容について"></a>ABBの実行内容について</h2><p>ABBの実行している内容は、ghettoVCBとほぼ変わりません。ESXiのAPIでESXiのスナップショットを取得しつつ、無償版ESXiではバックアップ関係のAPIが使えないためSSHで各種操作をして仮想マシンの情報を吸い上げています。<br>普段私はESXiにSSHで接続する際にはrootで公開鍵認証をしています（YubiKeyに秘密鍵を入れています）。ABBでは公開鍵認証は使えないようですので、今回示したように、別アカウントでパスワードを設定しています。ESXiのパスワードは他の用途を含めてABB以外では使うことがなく操作ミスなどによるパスワード漏洩の心配も不要です。</p><h2 id="復元"><a href="#復元" class="headerlink" title="復元"></a>復元</h2><p>ABBでバックアップを取得した日時（スナップショット）毎にESXiに復元します。</p><p>ABBの左ペインのメニューから仮想マシンを選択し、さらに実際に復元する仮想マシンを選択します。</p><img src="/new-technology/2023/09/16/Synology-abb/abb17.png" class="" width="1024" title="alt"><p>仮想マシンを選択した状態では背景が薄いグレーになりますので、ここで<mark class="label primary">復元</mark>ボタンをクリックします。</p><p>続いて、復元ポイント（バックアップを取得した日付と時刻）を選択し、<mark class="label primary">VMWare VSphereへの復元</mark>を選択し、次に進みます。<br>注釈で「ゲストOSファイル（Windows&#x2F;Linux）の復元の場合、Active Backup for Business Portalに進んでください」とありますが、これはファイル単位で復元したい場合です。ここではスナップショット単位に戻す事を目的としていますのでこの説明は省略します。</p><p>続いて復元の仕方を選択します。</p><img src="/new-technology/2023/09/16/Synology-abb/abb18.png" class="" width="640" title="alt"><mark class="label primary">仮想マシンの完全復元</mark>と<mark class="label primary">即時復元</mark>との2種類があります。ここでは完全復元の例について記載します。<p>なお、即時復元はNAS上で重複排除されてバックアップされたそのままの情報がESXiから見えるようになります。そこで仮想マシンを登録するなどすれば、すぐに仮想マシンを起動しその内容にアクセス可能となります。ただし、仮想マシンの実態はNAS上にあるのでパフォーマンスは落ちます。</p><p>復元モードを選択します。</p><img src="/new-technology/2023/09/16/Synology-abb/abb19.png" class="" width="640" title="alt"><mark class="label primary">元の場所に復元</mark>と<mark class="label primary">新しい場所に復元、或いは異なる設定で復元</mark>との2種類があります。<p>一般的にはMACアドレスはESXi上で動的に生成されますが、元の場所、つまりこれまでの仮想マシン同様のIPアドレス、構成で戻すのであればIPアドレスの引き継ぎなども鑑み、元のMACアドレスで戻すことになります。新しい場所、つまり新しい仮想マシンとして複製するのであれば、後者を選択します。</p><p>なお、MACアドレスが静的な場合のオプションもありますがここでは割愛します。</p><p>この例では元の場所に戻します（仮想マシンの稼働中に復元します）。</p><p>最後に構成の最終確認をして実行します。</p><img src="/new-technology/2023/09/16/Synology-abb/abb20.png" class="" width="640" title="alt"><p>対象のデータストア、ネットワーク（VLAN）を念のため確認してください。</p><mark class="label primary">復元後、自動的にVMの電源をオンにします</mark>のチェックは手前が省けるのでオンで良いでしょう。構成を変更したい場合は外すなど状況に合わせて選択します。<p>ちなみに、私の構成では、<code>vmfs/volumes/datastore1</code>にUbuntu22というフォルダが作成され、その中に仮想マシンの関連ファイルが登録されています（新規に仮想マシンを作成した一般的な構成です）。</p><p>ESXiの稼働中の画面は以下の通りです。</p><img src="/new-technology/2023/09/16/Synology-abb/esxi6.png" class="" width="1024" title="alt"><p>さて、実行中のアラートが表示されますがOKで続行します。</p><img src="/new-technology/2023/09/16/Synology-abb/abb21.png" class="" width="360" title="alt"><p>実行結果です。</p><img src="/new-technology/2023/09/16/Synology-abb/time2.png" class="" width="800" title="alt"><p>普通にUbuntuにESXi管理コンソール経由で接続でき、SSHも問題ありません。仮想MACアドレスは同一のもので復元されておりIPアドレスも前回と同じものでした。<br>復元動作は完璧です。</p><p>さて、復元では留意する点として、仮想マシンのESXi上の管理IDが変わる事が挙げられます。</p><p>復元後のフォルダ構成を確認しましたが、特にフォルダパスも変更はなく、復元前とは変更されたようには見受けられません。復元のログではテンポラリのフォルダを作成しているように見えますが、最終的には<code>vmfs/volumes/datastore1</code>にUbuntu22というフォルダにて復元されています。</p><p>ESXiの管理IDは特に意識しない場合も多いのですが、ブラウザからESXiの管理コンソールを起動せずにいきなり仮想マシンを起動する場合は、<code>vmrc://ユーザーID@ホスト名/?moid=管理ID</code>　ですぐに仮想マシン（GUI）にアクセスできますが、このIDが変更されているので、ESXi管理コンソールで新しいIDを確認する必要があります。</p><p>なお、これによってABBでバックアップしていた構成も変わることになるので、これまでタスク化されているバックアップは失敗することになりますので改めて仮想マシンの登録情報を編集しておく必要があります。</p><blockquote><p>警告,2023-09-03 12:42:22,前回のバージョンからのディスク [[datastore1] Ubuntu22&#x2F;Ubuntu22.vmdk] が見つかりません。それは削除されたか、あるいはパススルー、RDM、あるいは独立したディスクへ変更された可能性があります。バックアップ タスクはディスクをバックアップしません。</p></blockquote><p>このエラーは構成情報の変更を検知したという事でしょう。私はこの対策として、旧環境でのバックアップの定期的な実行を取りやめる設定に変更し、新しいバックアップタスクを改めて作成するようにしています。それでしばらく時間が経過してから古いバックアップファイルを削除することにしています。</p><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>非常に簡単なGUI操作で後は殆ど気にすることなく定期的な仮想マシンのバックアップが行えます。速度も必要十分で特に指摘する点は見つかりません。仮想マシンの一部のファイルを取り出したいなどのニーズにも応えられますし、本格的なバックアップソフトウェアです。小規模なビジネスやホームユーザーには十分すぎる機能を持ち合わせていると言えるでしょう。</p><p>仮想環境としてESXiを選定するメリットとして、第一に使いやすさと安定性、セキュリティレベルが高いということが挙げられますが、こういったスタンダードなNASがESXiのバックアップをサポートしている事も大きなメリットではないでしょうか。</p>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2023/09/16/Synology-abb/install.png&quot; class=&quot;&quot; width=&quot;1024&quot; title=&quot;alt&quot;&gt;

&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;

&lt;p&gt;SynologyのNASでは無償版ESXiの仮想マシン（VM）バックアップが可能なActive Backup for Business(ABB)というソフトウェアが提供されています。Microsoft Hyper-V2016および2019にも対応しています。無償版ESXiのバックアップソフトは「&lt;a href=&quot;/2021/03/06/esxi-nakivo/&quot; title=&quot;無償版ESXiの高度なバックアップ&quot;&gt;無償版ESXiの高度なバックアップ&lt;/a&gt;」で書いた有償のもの（1年期限の無償版）は存在します。無償バックアップソフトは無償版ESXiに対応していないという難しい状況でしたが、NASが必須という前提はあるものの、追加コストゼロでESXi仮想マシンのバックアップが可能です。エージェントレスで、ESXi本体やVMには何もインストールする必要はありません。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Synology&lt;br&gt; &lt;a href=&quot;https://www.synology.com/ja-jp/dsm/feature/active-backup-business/virtual-machine&quot;&gt;https://www.synology.com/ja-jp/dsm/feature/active-backup-business/virtual-machine&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="Network" scheme="https://yoshi0808.github.io/new-technology/categories/Network/"/>
    
    <category term="Software" scheme="https://yoshi0808.github.io/new-technology/categories/Software/"/>
    
    
    <category term="10GbE" scheme="https://yoshi0808.github.io/new-technology/tags/10GbE/"/>
    
    <category term="25GbE" scheme="https://yoshi0808.github.io/new-technology/tags/25GbE/"/>
    
    <category term="Synology" scheme="https://yoshi0808.github.io/new-technology/tags/Synology/"/>
    
    <category term="ESXi" scheme="https://yoshi0808.github.io/new-technology/tags/ESXi/"/>
    
  </entry>
  
  <entry>
    <title>Sophos Firewall v19.5 MR-3</title>
    <link href="https://yoshi0808.github.io/new-technology/2023/08/20/xg-v195mr3/"/>
    <id>https://yoshi0808.github.io/new-technology/2023/08/20/xg-v195mr3/</id>
    <published>2023-08-19T15:00:00.000Z</published>
    <updated>2023-08-20T00:20:19.429Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2023/08/20/xg-v195mr3/title.png" class="" title="alt"><h2 id="Sophos-Firewall-v19-5-MR3"><a href="#Sophos-Firewall-v19-5-MR3" class="headerlink" title="Sophos Firewall v19.5 MR3"></a>Sophos Firewall v19.5 MR3</h2><p>Sophos Firewall v19.5 MR3が2023年8月2日に発表されました。</p><span id="more"></span><h2 id="主なエンハンスの内容"><a href="#主なエンハンスの内容" class="headerlink" title="主なエンハンスの内容"></a>主なエンハンスの内容</h2><p>MR3では65以上のパフォーマンスおよび安定化・セキュリティ向上に対応しています。また、今後、リモートアクセス製品であるZTNAのセキュアアクセスに対応させる予定とのこと。<br>私の所感としては、これまでのSophos FirewallのVPNではそれなりに便利に活用していますが、ZTNAで透過的にリモートアプリケーションが利用できるようになるとの事であれば期待が持てます。但し、ZTNAの導入にはSophos Centralが必要であること（無料）、ZTNAの価格についてホームユーザーの扱いがどうなるかはまだ判明しないように見えます。<br>システム構成としてはActive Directoryとの統合連携など法人向けには必須の要件が含まれているので、ホームユーザーからは少し遠い存在になってしまうかもしれません。</p><p>v19.5 MR3の詳細な説明はRelease Notesを参照してください。</p><blockquote><p><a href="https://docs.sophos.com/releasenotes/index.html?productGroupID=nsg&amp;productID=xg&amp;versionID=19.5">https://docs.sophos.com/releasenotes/index.html?productGroupID=nsg&amp;productID=xg&amp;versionID=19.5</a></p></blockquote><p>Ipsec-VPNでSSL&#x2F;TLSインスペクションが動作しないという不具合の改善も含まれています。</p><h2 id="Sophos-Firewallのアップデート"><a href="#Sophos-Firewallのアップデート" class="headerlink" title="Sophos Firewallのアップデート"></a>Sophos Firewallのアップデート</h2><p>XGの管理画面にログイン後、左ペインメニューの<mark class="label primary">バックアップ＆ファームウェア</mark>の<mark class="label primary">ファームウェアの確認</mark>に通知が来る場合があります(以下はMR-2の画面です)。</p><img src="/new-technology/2023/08/20/xg-v195mr3/notice.png" class="" width="480" title="alt"><p>また、アップデートの案内が来ていなくても、MySophosにログインし、バージョンアップの差分モジュールをダウンロードします。</p><ol><li>Sophosのサイトの上部の「ソフォスについて」のプルダウンメニューから、<mark class="label primary">ライセンスとアカウント</mark>をクリックします。<blockquote><p><a href="https://www.sophos.com/ja-jp.aspx">https://www.sophos.com/ja-jp.aspx</a></p></blockquote></li><li>Sophos IDをお持ちでなければIDを作成します。</li><li>ログイン後、<mark class="label primary">Network Protection</mark>をクリックします。</li><li><mark class="label primary">Firmware Updates</mark>をクリックします。</li><li>「製品名&#x2F;OSを使った検索」で”Firewall”を選択し、その後現れるプルダウンは”Software”を選択します。</li><li><mark class="label primary">Show Available Downloads</mark>ボタンをクリックします。</li></ol><img src="/new-technology/2023/08/20/xg-v195mr3/mysophos.png" class="" width="800" title="alt"><ol><li>上記画面で”SW-19.5.3_MR-3.SFW-652.sig”というアップデータが表示されますのでダウンロードします。</li><li>MY Sophosはここで終了してXGの管理画面にログインし、左ペインメニューの<mark class="label primary">バックアップ＆ファームウェア</mark>の<mark class="label primary">ファームウェアのタブメニュー</mark>から以下の画面に赤丸で囲った矢印のアイコンをクリックし、ダウンロードしたモジュールをアップロードします。</li></ol><img src="/new-technology/2023/08/20/xg-v195mr3/verup.png" class="" width="800" title="alt"><p>アップロード＆再起動ボタンをクリックし、v19.5 MR3へのアップグレードを完了させます。</p><img src="/new-technology/2023/08/20/xg-v195mr3/upgrade.png" class="" width="800" title="alt"><div class="note info"><p>仮想環境（ESXi）上にFirewallをインストールされている方はアップグレードの前に、「<a href="/2020/10/11/esxi-backup/" title="VMware ESXiの仮想マシンをバックアップする">VMware ESXiの仮想マシンをバックアップする</a>」を参考に、バックアップを確保される事をお勧めします。</p></div>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2023/08/20/xg-v195mr3/title.png&quot; class=&quot;&quot; title=&quot;alt&quot;&gt;

&lt;h2 id=&quot;Sophos-Firewall-v19-5-MR3&quot;&gt;&lt;a href=&quot;#Sophos-Firewall-v19-5-MR3&quot; class=&quot;headerlink&quot; title=&quot;Sophos Firewall v19.5 MR3&quot;&gt;&lt;/a&gt;Sophos Firewall v19.5 MR3&lt;/h2&gt;&lt;p&gt;Sophos Firewall v19.5 MR3が2023年8月2日に発表されました。&lt;/p&gt;</summary>
    
    
    
    <category term="Security" scheme="https://yoshi0808.github.io/new-technology/categories/Security/"/>
    
    
    <category term="XG Firewall" scheme="https://yoshi0808.github.io/new-technology/tags/XG-Firewall/"/>
    
  </entry>
  
  <entry>
    <title>Synology DS1621+（DSM7.2）とSSD</title>
    <link href="https://yoshi0808.github.io/new-technology/2023/07/27/Synology1621plus-ssd/"/>
    <id>https://yoshi0808.github.io/new-technology/2023/07/27/Synology1621plus-ssd/</id>
    <published>2023-07-27T02:00:00.000Z</published>
    <updated>2023-07-27T11:37:57.655Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2023/07/27/Synology1621plus-ssd/synology-title.png" class="" width="1024" title="alt"><p class="onepoint">この記事で実現すること</p><p>サイバー攻撃の話題が相変わらず賑やかな状況下、これまで使っていたNASのソフトウェアの安定性やセキュリティ面の不安があり、安定感のあるSynologyのNASにリプレースしました。昨今SSDが安くなってきた事もあり、節電兼ねてALL SSDのNASをセットアップしてみました。</p><span id="more"></span><h2 id="前提（私の使い方）"><a href="#前提（私の使い方）" class="headerlink" title="前提（私の使い方）"></a>前提（私の使い方）</h2><p>私のNASの用途は、写真や動画のバックアップ、複数のPCで使う文書・PDFなどの同期兼バックアップ、仮想マシンやモジュールのバックアップ用途です。このブログなどはプライベートなものではないので、自宅で保存するよりGitHubのパブリッククラウドに置いておくほうがより現実的ではありますが、操作ミスで消えるリスクも鑑みNASにバックアップを取得しています。</p><p>今のところ、TVや映画などの動画を保存する用途にはしていないので、容量だけでいえば1ベイか2ベイのNASで10TBあれば十分です。特殊要素があるとすれば、仮想マシンのバックアップを頻繁に取得するので、できるだけバックアップ速度を求めます。そういう意味では10GbEのネットワークは必須です。</p><p>NASでは仮想マシンを稼働させる事もできますが、私の用途としてはESXiを一般的なPCにセットアップし、複数の仮想マシンを稼働させているので、NASはストレージがメインです。Windowsファイル共有（SMB）、NFS、iSCSI、せいぜいsyslog、SQLデータベースあたりまで使うといったところです。Ubuntuは個人向けにウィルス対策ソフトが存在しないので、Ubuntuのブラウザでインターネットにアクセスする事は殆どなく、モジュールのダウンロードは（ウィルス対策ソフトが有効な）macOSかWindowsでダウンロードしたものをSMBで共有してUbuntuで利用することが殆どです。</p><p>NASの使い方は利用者によって様々でしょうから、あくまで一例ということでご覧ください。</p><h2 id="Synology機種選定"><a href="#Synology機種選定" class="headerlink" title="Synology機種選定"></a>Synology機種選定</h2><p>6ベイ〜8ベイ程度のNASでそろそろ新モデルが出るかなと思い、年初くらいからウォッチしていましたが、発表されたのはDS1823xs+で、30万円と高額でした。周辺機器の互換性としてEnterpriseクラスの製品が中心で、個人向けとしては少し不向きだなと感じました。メモリは厳格に互換性を重視しつつも、SSDは必ずしも互換性のドライブでなくても良いかと考えていましたが、Enterpriseクラスの厳格性で10万円超えクラスの製品レベルを求められるとコスト面でかなり厳しいと感じました。現行モデルとの比較は以下の通りです。最初からSFP+のネットワークカードを増設する前提で、それなりにCPUパワーのある機種の比較です。10GbE以上の場合、どこまでスループットが出るかという期待も含めての選定です。</p><table><thead><tr><th>機種</th><th>CPU</th><th>CPU TDP</th><th>製造プロセス</th><th>ベイ</th><th>実売価格</th></tr></thead><tbody><tr><td>DS1823xs+</td><td>AMD Ryzen V1780B クアッド コア 3.35 GHz</td><td>45W</td><td>14nm</td><td>8</td><td>30万円</td></tr><tr><td>DS1821+</td><td>AMD Ryzen V1500B クアッド コア 2.2 GHz</td><td>16W</td><td>14nm</td><td>8</td><td>16万円</td></tr><tr><td>DS1621+</td><td>AMD Ryzen V1500B クアッド コア 2.2 GHz</td><td>16W</td><td>14nm</td><td>6</td><td>12.5万円</td></tr></tbody></table><p>意外にも、最新機種のDS1823xs+の製造プロセスは14nmで現行モデルと変わりません。DS1621+&#x2F;DS1821+の現行モデルは発売後2年半が経過しています。それなりに長期間使うことになるNASはEOSLを気にする必要があります。ただし、2012年モデルでもセキュリティパッチはきちんと提供されているので、Synologyのソフトウェア保守に対する考え方は非常にしっかりとしています。2018年に発表されたDS1618+（CPU:intel Atom C3538）は発売後5年でDiscontinuedになっていますが、あくまで製造中止であって、サポートはフルに提供されています。さらに、DS1621+&#x2F;DS1821+は新発表されたDS1823xs+とCPU世代が同じなので、長期的なサポート継続が行われると考えられます。</p><p>ちなみに、V1500BやV1780Bは2つの10GbEチップを内蔵しているんですね。ただし、DS1621+&#x2F;DS1821+には10GbEの口はありません。DS1823xs+は1つの10GbE(RJ45)があるのでその10GbEを活用しているということでしょうか。</p><p>ということで、Synologyはソフトウェアが秀逸である反面、少し高いというイメージを持っていたのですが、実売価格として廉価なDS1621+を購入することにしました。メモリが4GBなので、純正ECCメモリ（1.5万円）4GBを追加し8GBとしました。</p><p>Synologyの保守に関する注意点としては、購入後の保証期間が過ぎたハードウェアの有償修理は行われないという点です。特殊なハードウェアだと電源やファンなど代替品というのも簡単には見つからないのでそこだけが留意する点でしょうか。故障が気になる方は延長保証を検討する必要があります。私は故障した場合は「さだめ」と割り切って新しいハードウェアを買う理由が見つかるので延長保証にはしていません笑</p><blockquote><p>Synology 製品サポート状況<br> <a href="https://www.synology.com/ja-jp/products/status">https://www.synology.com/ja-jp/products/status</a></p></blockquote><h2 id="SSD"><a href="#SSD" class="headerlink" title="SSD"></a>SSD</h2><img src="/new-technology/2023/07/27/Synology1621plus-ssd/870evo.png" class="" width="320" title="alt"><p>Synologyとしては公式には互換性確認が取れていないSamsungの870EVO 4TB(MZ-77E4T0B&#x2F;IT)が28,000円程度だったこともあり、6つ購入しました（最初に1台購入し、動作確認の上で追加を5台買いました）。仕様は以下の通りTLCで速度、耐久性を重要視しました。</p><ul><li>インターフェース (転送速度・規格値）：SATA 3.0(6Gbps) ※SATA 2.0(3Gbps)およびSATA 1.0(1.5Gbps)互換フォームファクタ：7mm厚2.5インチHDD互換［搭載デバイス］NANDフラッシュ：Samsung 3bit MLC (TLC) V-NANDコントローラ：Samsung MKXコントローラキャッシュメモリ：2GB LPDDR4［パフォーマンス］シーケンシャル：読み出し560 MB&#x2F;s、書き込み：530 MB&#x2F;s</li><li>5年間または最大2,400TBWの限定保証</li></ul><p>4TBのSSDといえば、つい昨年は8万円くらいしていたと記憶していますが、廉価になるスピードも早いですね。世の中では半導体が不足していると言われる一方で、個人向けPCの販売不振によって、SSDなどのパーツが余剰在庫で値崩れしていると聞きますので、SSD全般に関しては今はお得な時期と言えるでしょう。</p><p>DS1621+にはM.2-2280のNVMeキャッシュも搭載可能ですが、SSD RAID5の分散であればキャッシュを必要としない程度に十分な速度が出るものと見込んでいます。キャッシュだけだと見かけのベンチマークは良い数字が出るでしょうが、安定して読み込み・書き込み速度を出すにはSSDでシンプルな構成が一番と考えます。</p><p>なお、このストレージのセットアップ時には互換性の無いDiskである警告メッセージが表示されます。また、Synologyアカウントのページには以下の記載があります。</p><blockquote><p>以下の状況ではテクニカル サポート サービスは提供されません。<br> Synology互換性リストに記載されていないデバイス（ドライブ、メモリモジュール、PCIeカードなど）を使用する。</p></blockquote><p>一度セットアップした後は警告メッセージは表示されていません。</p><p>NASというグループではなく、ConsumerというクラスでSynologyの互換性について検索すると、850EVO、860EVOが一覧に表示されます。何れ870EVOがサポート対象になるのを願うことにします。</p><blockquote><p>Synology 製品互換リスト（機種指定なし）<br> <a href="https://www.synology.com/ja-jp/compatibility?search_by=category&amp;category=hdds_no_ssd_trim&amp;filter_brand=Samsung&amp;filter_class=Consumer&amp;display_brand=other">https://www.synology.com/ja-jp/compatibility?search_by=category&amp;category=hdds_no_ssd_trim&amp;filter_brand=Samsung&amp;filter_class=Consumer&amp;display_brand=other</a></p></blockquote><p>なお、Synologyの互換性試験を軽んじているわけではありませんし、なるべくは互換性のあるものを使おうと考えてはいます。ただし、DS1621+に関してSSDはサードパーティ製で認められたものはなく、SynologyのEnterpriseドライブのみで4TBだと価格が15万円&#x2F;個なので、これは個人で購入するのは困難でしょう。<br>メモリやSSDキャッシュ用途であれば流石に互換性を重視した製品選定をしますが。。。</p><h2 id="NIC"><a href="#NIC" class="headerlink" title="NIC"></a>NIC</h2><img src="/new-technology/2023/07/27/Synology1621plus-ssd/mellanox.png" class="" width="640" title="alt"><p>このブログでは定番のMellanox Connect X4(MCX4121A-ACAT)を選定しました。ebayで1枚$70〜$80（日本円で約1万円）程度です。Synologyで正式に互換性検証されたものは、intel X710-T4がありますが、Connect X4は互換性リストにはありません。1つ昔のモデルのDS1618+はConnect X3には対応しているようです。Connect X4がダメなら純正のSFP28カードを購入するつもりでした。</p><p>前出の互換性リストを見ると、Mellanox Connect X4に対応しているSynology NASもそれなりの数があるようです。</p><blockquote><p>Synology 製品互換リスト<br> <a href="https://www.synology.com/ja-jp/compatibility?search_by=category&amp;category=network_interface_cards&amp;display_brand=other">https://www.synology.com/ja-jp/compatibility?search_by=category&amp;category=network_interface_cards&amp;display_brand=other</a></p></blockquote><h2 id="ハードウェアインストール"><a href="#ハードウェアインストール" class="headerlink" title="ハードウェアインストール"></a>ハードウェアインストール</h2><h3 id="メモリ"><a href="#メモリ" class="headerlink" title="メモリ"></a>メモリ</h3><p>筐体の底の部分に蓋があり、それを外すとメモリモジュールを挿すところがあります。シール付きの別売りモジュール（4GByte）を装着したところです。</p><img src="/new-technology/2023/07/27/Synology1621plus-ssd/memory.png" class="" width="640" title="alt"><h2 id="DiskStationManager（DSM）セットアップ"><a href="#DiskStationManager（DSM）セットアップ" class="headerlink" title="DiskStationManager（DSM）セットアップ"></a>DiskStationManager（DSM）セットアップ</h2><p>DS1621+は今更珍しいハードウェアでも無いですし、DSMのセットアップ情報も世の中に多くあるので、手順については省略します。最初はLAN1にRJ45のCat6ケーブルを接続しセットアップしました。インターネットに接続されている環境で無事DSM7.2のセットアップが完了しました。</p><p>論理Disk（ストレージプール）は初心者向けのSynology Hybrid RAID、または通常のRAIDを選択できますが、速度を重視し、RAID5としました。ダウンタイムを気にしてRAID6にするほど安全第一という事もなく、かといって、RAID0にして故障の際に大掛かりなリカバリのリスクを抱えたくも無いということで無難な選択です。6台のSSDすべてを1つの論理DISKとしてパリティの分散によって障害リスクの抑制、高速化を目指すことにします。</p><p>以前のNASでは、こういった論理ボリュームを作成後、利用するアプリケーションや目的毎のデータサイズによってストレージプールの中にそれぞれのボリュームを作成していました。例えば、macOSのバックアップであるTimeMachineなどでは、決められたディスクサイズの中で最新世代のバックアップを確保する仕組みとなっており、ディスクの容量を事前に決めておかないと（クオータ）、肥大し続ける事になります。PCで言えばパーティションのようなものですね。<br>また、別の目的では仮想マシンのバックアップなどは世代管理も含めて、どれだけのDisk容量を確保すべきかある程度運用しないとわかりません。意外と圧縮が効いて無駄にボリュームの空きができてしまう事はよくある課題です。また、複数ボリュームを作成するとスループットは落ちます。</p><p>NASはこの辺りの事前の計画がとても難しいのですが、DSM7では単一ボリュームに共有フォルダを作成する時にフォルダのサイズ制限を設定できます。これができればわざわざ複数ボリュームを悩みながら作成する事も不要です。これが実現できるのはSynologyがアピールするBtrfs（バターエフエス）ファイルシステムのおかげです。Btrfsではスナップショットを取得してバックアップする際、バックアップ中にファイルが更新されて一貫性が失われないとのことです。ファイルシステムもデータベースの仕組みに近くなっていくんでしょうか。</p><blockquote><p>Synology ナレッジセンター</p></blockquote><p> <a href="https://kb.synology.com/ja-jp/DSM/help/DSM/AdminCenter/file_share_create?version=7#sharedfolderquota">https://kb.synology.com/ja-jp/DSM/help/DSM/AdminCenter/file_share_create?version=7#sharedfolderquota</a><br> <div class="note info"><p>ストレージがBtrfsファイル システムを使用している場合に限り、共有スペースに共有スペースの割り当てを有効にするオプションをできますます。</p></div></p><p>ESXiの仮想マシンのバックアップのために、 SynologyのActive Backup for Businessを使うつもりですので、これは64ビットOSとBtrfsが必須となります。Disk構成は以下のようになりました。</p><img src="/new-technology/2023/07/27/Synology1621plus-ssd/volume.drawio.png" class="" width="480" title="alt"><img src="/new-technology/2023/07/27/Synology1621plus-ssd/synology1.png" class="" width="800" title="alt"><h2 id="消費電力"><a href="#消費電力" class="headerlink" title="消費電力"></a>消費電力</h2><p>SSD6台、Mellanox Connect X4を装着した状態で、ワットチェッカーで計測してみました。以下の通り、おおよそ33W-35W程度で安定しています。なかなかの省電力です。以前に利用していたNASは4台のHDDという事もあり、70W-100W程度でかなり発熱も大きかったのがかなり改善されました。</p><ul><li><p>Synology（SSDx6、Mellanox Connect X4）<br> （33W-35W）</p> <img src="/new-technology/2023/07/27/Synology1621plus-ssd/wchecker1.png" class="" width="360" title="alt"></li><li><p>旧NAS（HDDx4、Mellanox Connect X3）<br> （70W-100W）</p> <img src="/new-technology/2023/07/27/Synology1621plus-ssd/wchecker2.png" class="" width="360" title="alt"></li></ul><h2 id="ネットワーク"><a href="#ネットワーク" class="headerlink" title="ネットワーク"></a>ネットワーク</h2><p>セットアップ終了後、無事Connect X4はNASに以下のように認識されていました。</p><blockquote><p><code>25000 Mbps, 全二重, MTU 1500</code></p></blockquote><p>2つのPortがあるので、1つは25GbE、もう1つは10GbEとして使ってみます。</p><p>お決まりのiperf3の計測です。Connect X4をSFP28でスイッチに接続します。クライアントはWindows11でこちらもConnect X4です。<br>Synologyのコミュニティから提供されているSynoCli Monitor Toolsというパッケージがあり、これをインストールして使ってみます。<br>この組み合わせでは上り、下り共に19〜21Gbps程度であり、及第点という感じでした。</p><p>Windows -&gt; Synology（多重度2）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[ ID] Interval           Transfer     Bitrate</span><br><span class="line">[SUM]   0.00-10.00  sec  22.3 GBytes  19.1 Gbits/sec                  sender</span><br><span class="line">[SUM]   0.00-10.00  sec  22.3 GBytes  19.1 Gbits/sec                  receiver</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Synology NASとESXi上のUbuntuのiPerf3の結果は上り、下り共に十分なパフォーマンスが出ています。</p><p>Synology -&gt; Ubuntu</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[ ID] Interval           Transfer     Bitrate</span><br><span class="line">[  5]   0.00-1.00   sec  2.33 GBytes  20.0 Gbits/sec</span><br><span class="line">[  5]   1.00-2.00   sec  2.59 GBytes  22.3 Gbits/sec</span><br><span class="line">[  5]   2.00-3.00   sec  2.72 GBytes  23.4 Gbits/sec</span><br><span class="line">[  5]   3.00-4.00   sec  2.59 GBytes  22.2 Gbits/sec</span><br><span class="line">[  5]   4.00-5.00   sec  2.71 GBytes  23.3 Gbits/sec</span><br><span class="line">[  5]   5.00-6.00   sec  2.72 GBytes  23.4 Gbits/sec</span><br><span class="line">[  5]   6.00-7.00   sec  2.73 GBytes  23.4 Gbits/sec</span><br><span class="line">[  5]   7.00-8.00   sec  2.70 GBytes  23.2 Gbits/sec</span><br><span class="line">[  5]   8.00-9.00   sec  2.70 GBytes  23.2 Gbits/sec</span><br><span class="line">[  5]   9.00-10.00  sec  2.69 GBytes  23.1 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[ ID] Interval           Transfer     Bitrate         Retr</span><br><span class="line">[  5]   0.00-10.00  sec  26.5 GBytes  22.7 Gbits/sec   22             sender</span><br><span class="line">[  5]   0.00-10.00  sec  26.5 GBytes  22.7 Gbits/sec                  receiver</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="Disk速度"><a href="#Disk速度" class="headerlink" title="Disk速度"></a>Disk速度</h2><p>定番のCrystal Diskmarkのベンチマークを実施します。</p><h3 id="25GbE-SFP28-で計測"><a href="#25GbE-SFP28-で計測" class="headerlink" title="25GbE(SFP28)で計測"></a>25GbE(SFP28)で計測</h3><img src="/new-technology/2023/07/27/Synology1621plus-ssd/DiskMark25gbE.png" class="" width="480" title="alt"><p>読み込みは17Gbps、書き込みは14.3Gbpsと、かなり高いスループットが出ています。11Gbps-12Gbps程度であれば省電力を優先し10Gbpsで使おうと考えていましたが、迷いどころです。私が速度を重視するメインの使い道はESXiの仮想マシンのバックアップですので、それはまた別の機会に計測してみます。</p><h3 id="10GbE-SFP-で計測"><a href="#10GbE-SFP-で計測" class="headerlink" title="10GbE(SFP+)で計測"></a>10GbE(SFP+)で計測</h3> <img src="/new-technology/2023/07/27/Synology1621plus-ssd/DiskMark10gbE.png" class="" width="480" title="alt"><p> 10GbEの場合は、読み込み、書き込みともにワイヤレートが出ており、バランスの良い組み合わせでしょうか。NICをSFP+の10GbEにして、もう5W程度省電力を狙うというのも良いですね。</p><h3 id="25GbE-SFP28-にパケット署名を付けて計測"><a href="#25GbE-SFP28-にパケット署名を付けて計測" class="headerlink" title="25GbE(SFP28)にパケット署名を付けて計測"></a>25GbE(SFP28)にパケット署名を付けて計測</h3> <img src="/new-technology/2023/07/27/Synology1621plus-ssd/DiskMark25GbE-PacketSign.png" class="" width="480" title="alt"><p>ビジネスではセキュリティの観点からほぼ必須と指摘されるSMBのパケット署名ですが、意外と落ち込まないですね。これも実運用するには十分な速度が出ています。</p><h2 id="その他、素晴らしい機能"><a href="#その他、素晴らしい機能" class="headerlink" title="その他、素晴らしい機能"></a>その他、素晴らしい機能</h2><p>以前のNASからリプレースして便利に感じた機能をいくつか挙げてみます。</p><ul><li>2要素認証（TouchID、Windows Hello）<br> DSMに2要素認証でログインする場合は、圧倒的に便利です。パスワードレスでTouchID、Windows Helloのみの認証にもできます。<br> なお、YubiKeyのFIDO2も使えますが、PINもあって少し不便に感じます。YubiKeyはDSMへのSSHを公開鍵認証で使っています。iOSアプリのSecure SignInは自宅にいない場合に公衆回線を通じて2要素認証のためのサインインの通知が来るのは良いのですが、許可をタップするとNASへ直接接続しようとするようで、自宅のWi-Fiに接続していない場合は認証がうまく動作しません。これはいずれ機能アップして修正されることを期待します。SynologyのNASはTailScaleのアプリがインストールできるので、これを組み合わせる事で対応できるかもしれません。</li></ul><blockquote><p>tailscale<br>  <a href="https://tailscale.com/">https://tailscale.com</a></p></blockquote><ul><li>ログセンター（Syslog）<br> グラフィカルで分かりやすいです。ネットワーク機器のログを集めるのに使っています。このおかげでSyslogのために別の仮想マシンを用意する必要は無さそうです。以前のNASではフィルタ機能が十分でなく、使っていませんでした。Synologyでは演算子を使っていろいろな条件で絞り込みができます。個人でのログ確認には必要十分です。<img src="/new-technology/2023/07/27/Synology1621plus-ssd/syslog.png" class="" width="800" title="alt"></li></ul><p> 絞り込みも優秀で、ホスト名を入力させるのではなく、すでにログ出力されているホスト名から選択できます。<br>  <img src="/new-technology/2023/07/27/Synology1621plus-ssd/syslog2.png" class="" width="800" title="alt"></p><ul><li><p>ストレージアナライザー</p> <img src="/new-technology/2023/07/27/Synology1621plus-ssd/analyzer.png" class="" width="1024" title="alt">  <p> ファイルサイズの大きいもの順に確認できたり、重複ファイルを確認、削除できます。データの見える化ができて、とても便利です。</p></li><li><p>ファイアウォール<br> これはアプリケーションの自動ブロックと連動していて、このブロックが働いた時、つまり明らかな不正ログインの懸念がある場合のみ通知されます。ですので、普段から通知されることはありません。以前のNASでは許可していないサービスにIPレベルでパケットが到達した段階でエラーとカウントして膨大な件数の拒否カウントが定期的に通知されており、結局通知を止めていたのですが、こちらは現実的なファイアウォール機能となっています。</p><blockquote><p>さまざまなサービスとパッケージが自動ブロックをサポートします。例：DSM、SSH、Telnet、rsync、ネットワーク バックアップ、共有フォルダの同期、FTP、SMB、WebDAV、File Station、Audio Station、Video Station、Download Station、Mail Server、Mail Station、MailPlus、MailPlus Server、VPN Server、Synology Drive Server、および Synology モバイル アプリ。</p></blockquote></li><li><p>Synology Drive<br>　NASでは一般的な機能で、複数クライアント端末とファイル同期を取るソリューションです。以前のNASでは小さいモジュールがたくさん存在するフォルダ、特にGitで使うようなソースコードや小さいモジュールのファイルは、<em>conflict</em>(0)のような競合ファイルがたくさん発生してしまい、全く使えずにいました。GitHubへのプッシュする際に大量の誤ったプッシュ候補のファイルが表示されてしまい、泣く泣く変更したファイルをロールバックする羽目になりました。他の端末との同時更新などの競合がある訳ではなかったのですが、それ以来、一般的な文書のみに使っていました。今回、SynologyのNASになってからはまだ日が浅いですが、このような小さいモジュール群も安定して複製してくれ、複数端末で同期が取れています。</p></li><li><p>DSM画面のレスポンスが良いこと<br>　どのアプリケーションを稼働させても、ウィンドウがもたつくことはありません。</p></li></ul><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>SSDが安くなったおかげで、今回は廉価にNASのリプレースが出来ました。SSDキャッシュはベンチマークこそ良い成績が出ますが、実際の運用においてはなかなか効果を感じづらいところがあります。NVMeではなくSATAなので大きな期待はしていませんでしたが、かなりの速度が出ることを確認できました。私の利用方法は少し特殊と考えられますが、Synologyのソフトウェアが素晴らしいことで、NASを利用している時のストレスが本当に減りました。<br>前述したSyslogや重複ファイルのチェックなど、本当にユーザーフレンドリーで使いやすく他社のNASから乗り換えた時にはこのDSM7.2を使うと、その使い勝手の良さに驚かれるでしょう。またストレージの消費量もかなり低く抑えられています。最近、SynologyはエントリーモデルにおいてもBtrfsに対応するようになったので廉価でも高性能なNASとして利用できそうです。今はNASのバックアップを外付けのHDDにしていますが、あまりに使い勝手が良いので廉価なビジネスモデルにリモートコピーでバックアップを取得するのでも良いかなと思い始めています。</p>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2023/07/27/Synology1621plus-ssd/synology-title.png&quot; class=&quot;&quot; width=&quot;1024&quot; title=&quot;alt&quot;&gt;

&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;

&lt;p&gt;サイバー攻撃の話題が相変わらず賑やかな状況下、これまで使っていたNASのソフトウェアの安定性やセキュリティ面の不安があり、安定感のあるSynologyのNASにリプレースしました。昨今SSDが安くなってきた事もあり、節電兼ねてALL SSDのNASをセットアップしてみました。&lt;/p&gt;</summary>
    
    
    
    <category term="Hardware" scheme="https://yoshi0808.github.io/new-technology/categories/Hardware/"/>
    
    <category term="Network" scheme="https://yoshi0808.github.io/new-technology/categories/Network/"/>
    
    
    <category term="10GbE" scheme="https://yoshi0808.github.io/new-technology/tags/10GbE/"/>
    
    <category term="25GbE" scheme="https://yoshi0808.github.io/new-technology/tags/25GbE/"/>
    
    <category term="Synology" scheme="https://yoshi0808.github.io/new-technology/tags/Synology/"/>
    
  </entry>
  
  <entry>
    <title>ESXi8.0をRyzen5 5600Gで構築</title>
    <link href="https://yoshi0808.github.io/new-technology/2023/07/07/building-setup-esxi8/"/>
    <id>https://yoshi0808.github.io/new-technology/2023/07/07/building-setup-esxi8/</id>
    <published>2023-07-07T00:58:48.000Z</published>
    <updated>2023-09-23T00:59:59.303Z</updated>
    
    <content type="html"><![CDATA[<p class="onepoint">この記事で実現すること</p><p>1年半前に、「<a href="/2022/02/27/building-setup-esxi7/" title="ESXI7.0をRyzen7 5700Gで構築">ESXI7.0をRyzen7 5700Gで構築</a>」の記事で、Ryzen7 5700GでESXi7のセットアップをしました。今回はESXi8.0の動作確認も含めてRyzen5 5600Gでセットアップしました。</p><span id="more"></span><h2 id="ESXi8のためのハードウェア選定検討"><a href="#ESXi8のためのハードウェア選定検討" class="headerlink" title="ESXi8のためのハードウェア選定検討"></a>ESXi8のためのハードウェア選定検討</h2><p>実は最初からESXi8をセットアップするつもりはなく、WindowsPCを新調するつもりでした。私はゲームはやらないので、せいぜい4Kのビデオが見られれば十分というPCの使い方をしており、ビデオカードを購入する事は殆どありません。パソコン工房で「STYLE-S0P5-R55G-EZX」という5600Gを積んだ機種が8万円台と安かった事もあり、あまり深くは考えずに注文しました。</p><blockquote><p>パソコン工房<br> <a href="https://www.pc-koubou.jp/">https://www.pc-koubou.jp</a></p></blockquote><h2 id="ハードウェア構成"><a href="#ハードウェア構成" class="headerlink" title="ハードウェア構成"></a>ハードウェア構成</h2><p>注文したPCは以下の構成でした。<br>【OS】Windows 11 Home<br>　【プロセッサー】AMD Ryzen 5 5600Gプロセッサー (3.9-4.4GHz&#x2F;6コア&#x2F;12スレッド&#x2F;16MBキャッシュ&#x2F;TDP 65W)<br>　【CPU冷却グリス】【熱伝導率： 9W&#x2F;m K】 シルバーグリスArctic Silver 5塗布サービス<br>　【CPUクーラー】静音CPUクーラー Wraith Stealth[トップフロー]<br>　【グラフィックアクセラレーター】Radeon Graphics(CPU統合グラフィックス）<br>　【メインメモリ】16GB(8GB×2)[DDR4-3200 &#x2F; デュアルチャンネル］<br>　【1stストレージ［OSインストール］】500GB SSD &#x2F; NVMe M.2[PCIe 3.0×4]<br>　【チップセット】AMD B550チップセット<br>　【サウンド機能】High Definition Audio subsystem<br>　【内蔵ネットワークカード】有線：1000BASE-T ※無線機能はついておりません<br>　【光学ドライブ】DVDスーパーマルチドライブ［LG GH24NSxx]<br>　【電源】400W[80PLUS BRONZE認証］&#x2F; TFX電源<br>　【ケース】スリムタイプMicroATXケースHEC 7KJC[フロントUSB3.0]ブラック</p><p>さて、PCが届いてから、ハードウェアを確認したところ、NVMeはウェスタンデジタルのBlueが組み込まれていました。また、マザーボードはASRock社のものです。そういえば、前回のESXi7.0のセットアップでは、セキュアブートは断念していました。Win11 Homeがセットアップされているモデルでしたが、WDのBlue（SN570）が入っていた事もあり、ふつふつとESXi8.0をインストールしたいと思い始め、ESXi8をクリーンインストールする事にしました。</p><h3 id="ストレージ"><a href="#ストレージ" class="headerlink" title="ストレージ"></a>ストレージ</h3><p>前回は、VMware Commmunityで鉄板だった970EVO Plusでした。ESXiではSamsungが確実という印象でしたが、980 Pro NVMeでは、ファームウェアの不具合で故障率が高いという報告が上がっています。ESXiはNVMeストレージの種類を選ぶため事前調査が必要ですが、今回、何となくうまく行くだろう感があってBlue（SN570）にESXi8をセットアップしました。結果、全く問題ありませんでした。なぜかESXiの事例としてあまり出てこないのが不思議です。。。</p><p>うまく行かなければ、William Lam氏のNVMeに関する情報で、SabrentのRocket Plus NVMeを試そうと思っていたところでした。<br><a href="https://williamlam.com/2023/02/quick-tip-additional-nvme-vendors-sk-hynix-sabrent-for-esxi-homelab.html">https://williamlam.com/2023/02/quick-tip-additional-nvme-vendors-sk-hynix-sabrent-for-esxi-homelab.html</a></p><h3 id="ネットワークカード"><a href="#ネットワークカード" class="headerlink" title="ネットワークカード"></a>ネットワークカード</h3><p>前回は、intelのX710のSFP+4Portを使いましたが、今回はSFP28の検証も兼ねてMellanox Connect X-5を選定しました。Connect X-4はWindowsやNASで使おうと計画してます。前回はセキュアブートがうまく行かなかった点は課題でしたが、実はそれが功を奏したところもありました。X710のESXiのドライバーはデフォルトではフローコントロール（pauseパラメータ）がオフになっています。それで、ブート時に、<code>/etc/rc.local.d/local.sh</code>にpauseパラメータを有効にする設定を加えていました。もし、セキュアブートであれば、<code>/etc/rc.local.d/local.sh</code>にスクリプトを記述しても無視されます。</p><h3 id="UEFIの設定"><a href="#UEFIの設定" class="headerlink" title="UEFIの設定"></a>UEFIの設定</h3><p>さて、UEFIのリベンジです。色々な情報をこれまで収集し、セキュアブートの初期化をすればセキュアブートが可能と調べがついていました。</p><p>最初、Secure Boot Modeを<mark class="label primary">Custom</mark>に変更し、<mark class="label primary">Install default Secure Boot keys</mark>を実施した上でセットアップしましたが、セキュアブートでインストールされませんでした。以下のページでGIGABYTEのマザーということでセキュアブートに関する情報がありました。</p><p><a href="https://support.pcdiy.newx.co.jp/hc/ja/articles/6572156997657--GIGABYTE%E3%83%9E%E3%82%B6%E3%83%BC%E3%83%9C%E3%83%BC%E3%83%89%E5%85%A8%E8%88%AC-Secure-Boot-%E3%81%AE%E8%A8%AD%E5%AE%9A%E6%96%B9%E6%B3%95%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">https://support.pcdiy.newx.co.jp/hc/ja/articles/6572156997657--GIGABYTEマザーボード全般-Secure-Boot-の設定方法について</a></p><blockquote><p><strong>Restore Factory Keys</strong> を選択していただき、ポップアップが表示されますのでYes(はい)を選択してください</p></blockquote><p>今回のマザーボードはASRockですが、以下の手順でセキュアブートにできました。</p><ol><li><mark class="label primary">Secure Boot Mode</mark>を<mark class="label primary">Normal</mark>から<mark class="label primary">Custom</mark>に変更する。</li><li><mark class="label primary">Clear Secure Boot Keys</mark>を実行する</li><li><mark class="label primary">Install default Secure Boot keys</mark>を実行する。</li><li><mark class="label primary">Secure Boot Mode</mark>を<mark class="label primary">Normal</mark>に戻す。</li></ol><p>この手順を踏んでセットアップ開始したところ、無事セキュアブートが可能になりました。無償版ESXiはTPMは使えませんので、単に改ざん防止という事になります。<br>簡単な確認方法として、セキュアブートが有効である場合、ESXiの管理コンソールの<mark class="label primary">セキュリティとユーザー</mark>の許容レベルをパートナーからコミュニティに変更できなくなります。また、前述した<code>local.sh</code>もスキップされます。</p><h2 id="インストール"><a href="#インストール" class="headerlink" title="インストール"></a>インストール</h2><p>これまで同様、Rufusで32GBのUSBメモリにISOファイルを登録しUSBブートからESXi8.0Update1aをセットアップします。<br>なお、セットアップされる場合はVMWareのサイトで最新のバージョンを確認下さい。</p><p>VMWare ESXi8.0<br><a href="https://customerconnect.vmware.com/jp/evalcenter?p=free-esxi8">https://customerconnect.vmware.com/jp/evalcenter?p=free-esxi8</a></p><img src="/new-technology/2023/07/07/building-setup-esxi8/esxi1.png" class="" width="800" title="alt"><p>メーカーはiiyamaなのに、なんでMouseComputerなんだろう。。。</p><h2 id="ネットワーク"><a href="#ネットワーク" class="headerlink" title="ネットワーク"></a>ネットワーク</h2><p>ドライバーはnmlx5_coreとなっています。SFP28のDACケーブルをスイッチに接続し、vmnic0が25Gbpsでリンクアップしています。</p><img src="/new-technology/2023/07/07/building-setup-esxi8/esxi2.png" class="" width="800" title="alt"><p>ESXi8にセットアップしたUbuntu22ではOS上は10GbEと認識していますが、速度は23Gbps近くは出ています。</p><img src="/new-technology/2023/07/07/building-setup-esxi8/ubuntu1.png" class="" width="640" title="alt"><p>Ubuntuからの送信</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">yoshi@ub22:~$ iperf3 -c 192.168.x.20</span><br><span class="line">Connecting to host 192.168.x.20, port 5201</span><br><span class="line">[  5] <span class="built_in">local</span> 192.168.x.182 port 47676 connected to 192.168.x.20 port 5201</span><br><span class="line">[ ID] Interval           Transfer     Bitrate         Retr  Cwnd</span><br><span class="line">[  5]   0.00-1.00   sec  2.61 GBytes  22.4 Gbits/sec  6519    967 KBytes</span><br><span class="line">[  5]   1.00-2.00   sec  2.54 GBytes  21.9 Gbits/sec  5013   1.01 MBytes</span><br><span class="line">[  5]   2.00-3.00   sec  2.50 GBytes  21.4 Gbits/sec  3376    667 KBytes</span><br><span class="line">[  5]   3.00-4.00   sec  2.57 GBytes  22.1 Gbits/sec  5961    612 KBytes</span><br><span class="line">[  5]   4.00-5.00   sec  2.53 GBytes  21.8 Gbits/sec  4767    648 KBytes</span><br><span class="line">[  5]   5.00-6.00   sec  2.57 GBytes  22.1 Gbits/sec  6294    765 KBytes</span><br><span class="line">[  5]   6.00-7.00   sec  2.55 GBytes  21.9 Gbits/sec  4271    489 KBytes</span><br><span class="line">[  5]   7.00-8.00   sec  2.56 GBytes  22.0 Gbits/sec  3493    573 KBytes</span><br><span class="line">[  5]   8.00-9.00   sec  2.55 GBytes  21.9 Gbits/sec  5756    789 KBytes</span><br><span class="line">[  5]   9.00-10.00  sec  2.58 GBytes  22.2 Gbits/sec  4816    546 KBytes</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[ ID] Interval           Transfer     Bitrate         Retr</span><br><span class="line">[  5]   0.00-10.00  sec  25.6 GBytes  22.0 Gbits/sec  50266             sender</span><br><span class="line">[  5]   0.00-10.00  sec  25.6 GBytes  22.0 Gbits/sec                  receiver</span><br><span class="line"></span><br><span class="line">iperf Done.</span><br></pre></td></tr></table></figure><p>Ubuntuの受信</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">yoshi@ub22:~$ iperf3 -c 192.168.x.20 -R</span><br><span class="line">Connecting to host 192.168.x.20, port 5201</span><br><span class="line">Reverse mode, remote host 192.168.x.20 is sending</span><br><span class="line">[  5] <span class="built_in">local</span> 192.168.x.182 port 44930 connected to 192.168.x.20 port 5201</span><br><span class="line">[ ID] Interval           Transfer     Bitrate</span><br><span class="line">[  5]   0.00-1.00   sec  2.68 GBytes  23.0 Gbits/sec</span><br><span class="line">[  5]   1.00-2.00   sec  2.73 GBytes  23.4 Gbits/sec</span><br><span class="line">[  5]   2.00-3.00   sec  2.72 GBytes  23.4 Gbits/sec</span><br><span class="line">[  5]   3.00-4.00   sec  2.73 GBytes  23.4 Gbits/sec</span><br><span class="line">[  5]   4.00-5.00   sec  2.73 GBytes  23.4 Gbits/sec</span><br><span class="line">[  5]   5.00-6.00   sec  2.73 GBytes  23.4 Gbits/sec</span><br><span class="line">[  5]   6.00-7.00   sec  2.73 GBytes  23.4 Gbits/sec</span><br><span class="line">[  5]   7.00-8.00   sec  2.73 GBytes  23.4 Gbits/sec</span><br><span class="line">[  5]   8.00-9.00   sec  2.73 GBytes  23.4 Gbits/sec</span><br><span class="line">[  5]   9.00-10.00  sec  2.73 GBytes  23.4 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[ ID] Interval           Transfer     Bitrate         Retr</span><br><span class="line">[  5]   0.00-10.00  sec  27.2 GBytes  23.4 Gbits/sec  279             sender</span><br><span class="line">[  5]   0.00-10.00  sec  27.2 GBytes  23.4 Gbits/sec                  receiver</span><br><span class="line"></span><br><span class="line">iperf Done</span><br></pre></td></tr></table></figure><p>受信は25Gbpsのワイヤレートが出ています。<br>Ubuntuからの送信側では再送が多いようです。これはまだESXiの構成または設定の問題なのか私の環境の問題なのかは分かっていません。<br>NVidiaのサイトのInboxドライバの情報はESXi8.0向けは4.23.0.36-8vmwという事になっています。</p><blockquote><p>NVIDIA Native Drivers for VMware ESXi Inbox Drivers Release Notes<br> <a href="https://docs.nvidia.com/networking/display/VMwareESXiInboxDriversReleaseNotes">https://docs.nvidia.com/networking/display/VMwareESXiInboxDriversReleaseNotes</a></p></blockquote><p>なお、最新のESXi8.0Update1aでのMellanoxのドライバのバージョンは以下の通りです。NVidiaのサイトのものよりも新しいですね。これはまた次回にドライバが更新されるかもしれません。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost:~] esxcli software vib list | grep nmlx</span><br><span class="line">nmlx5-core                     4.23.0.36-14vmw.801.0.0.21495797     VMW     VMwareCertified   2023-04-29    host</span><br><span class="line">nmlx5-rdma                     4.23.0.36-14vmw.801.0.0.21495797     VMW     VMwareCertified   2023-04-29    host</span><br></pre></td></tr></table></figure><p>色々な情報を探してみてもやはりESXi7.0の情報は充実しており、まだESXi8.0は安定というには早いかなと感じます。</p><h2 id="ESXiにおけるNICのフローコントロールについて"><a href="#ESXiにおけるNICのフローコントロールについて" class="headerlink" title="ESXiにおけるNICのフローコントロールについて"></a>ESXiにおけるNICのフローコントロールについて</h2><p>ESXiにはフローコントロールの制御について、送信、受信のpauseパラメータを設定できます。<br>Connect X-5を使っている状況でESXiにSSHし、以下のコマンドでpauseパラメータの状況が確認できます。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost:~] esxcli network nic pauseParams list</span><br><span class="line">NIC     Pause Params Supported  Pause RX  Pause TX  Auto Negotiation  Auto Negotiation Resolution Avail  RX Auto Negotiation Resolution  TX Auto Negotiation Resolution</span><br><span class="line">------  ----------------------  --------  --------  ----------------  ---------------------------------  ------------------------------  ------------------------------</span><br><span class="line">vmnic0                    <span class="literal">true</span>      <span class="literal">true</span>      <span class="literal">true</span>             <span class="literal">false</span>                              <span class="literal">false</span>                           <span class="literal">false</span>                           <span class="literal">false</span></span><br><span class="line">vmnic1                    <span class="literal">true</span>      <span class="literal">true</span>      <span class="literal">true</span>             <span class="literal">false</span>                              <span class="literal">false</span>                           <span class="literal">false</span>                           <span class="literal">false</span></span><br></pre></td></tr></table></figure><p><code>Pause Params Supported</code>が<code>true</code>の場合は、フローコントロールの機能を持っています。Pause RXがfalseだとスイッチからpauseフレームの通知を無視してしまいます。またPause TXがfalseだと自身が飽和した時にpauseフレームを送信しません。上記ではデフォルトでフローコントロールがオンになっています。</p><p>一方、ESXi7.0のintel x710では、以下の結果になりました。Pause RX&#x2F;TXがfalseとなっています。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@esxi2:~] esxcli network nic pauseParams list</span><br><span class="line">NIC     Pause Params Supported  Pause RX  Pause TX  Auto Negotiation  Auto Negotiation Resolution Avail  RX Auto Negotiation Resolution  TX Auto Negotiation Resolution</span><br><span class="line">------  ----------------------  --------  --------  ----------------  ---------------------------------  ------------------------------  ------------------------------</span><br><span class="line">vmnic0                    true     false     false             false                              false                           false                           false</span><br><span class="line">vmnic1                    true     false     false             false                              false                           false                           false</span><br><span class="line">vmnic2                    true     false     false             false                              false                           false                           false</span><br><span class="line">vmnic3                    true     false     false             false                              false                           false                           false</span><br></pre></td></tr></table></figure><p>この場合は、前述した、<code>/etc/rc.local.d/local.sh</code>にフローコントロールをOnにするコマンドを列挙します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">esxcli network nic pauseParams set -n vmnic0 -t t -r t</span><br><span class="line">esxcli network nic pauseParams set -n vmnic1 -t t -r t</span><br><span class="line">esxcli network nic pauseParams set -n vmnic2 -t t -r t</span><br><span class="line">esxcli network nic pauseParams set -n vmnic3 -t t -r t</span><br></pre></td></tr></table></figure><p>繰り返しですが、これはセキュアブートではない場合にのみ設定が可能です。<br>10GbEとWi-Fiなど、<strong>速度差がある端末同士で効率の良い通信を行うためにはフローコントロールは必要</strong>と言えます。フローコントロールが無い場合、私の環境ではWi-Fi6のiperf3の例では900Mbps→750Mbps程度には劣化します。Wi-Fi電波の範囲ギリギリとかWi-Fiの別のAPへのローミングなどセンシティブな箇所で安定度が高まるとお考えください。</p><p>フローコントロールはこのようにホスト側での設定とネットワークスイッチ側と双方で有効にしておく必要があります。</p><p>なお、ESXiにおいて少し高度な話としては、Single Root I&#x2F;O Virtualization（SR-IOV）による仮想マシンにNIC（NICが持つ仮想機能）を直接割り当てる方法で高速化する方法もあります。Windows ServerやRed Hat Enterprise LinuxなどOSを選びますが今後機会があればテストしてみます。</p><img src="/new-technology/2023/07/07/building-setup-esxi8/esxi3.png" class="" width="800" title="alt"><p>※ESXi上のUbuntuはSR-IOVに対応していません。</p><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>25GbEはあくまで実験的に検証しているものであり、私自身がパワーユーザーではない事もあり、今のところメインは10GbEとし、スイッチ間を25GbEで使うつもりでいます。ただし、アプリケーション同士で9Gbps程度の速度が25GbE環境下で出ているからといって、ネットワークを10Gbpsに変更しても影響が出ないかと言われるとそうでもなく、7Gbps程度に落ち込むケースも確認できています。今後色々検証していきたいと考えています。このブログで紹介している25GbEは簡単に接続できているように見えますが、私の使っているネットワークスイッチ（Ubiquiti PRO Aggregationスイッチ）とMellanox Connect Xカードとの相性が良い事もあります。</p>]]></content>
    
    
    <summary type="html">&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;

&lt;p&gt;1年半前に、「&lt;a href=&quot;/2022/02/27/building-setup-esxi7/&quot; title=&quot;ESXI7.0をRyzen7 5700Gで構築&quot;&gt;ESXI7.0をRyzen7 5700Gで構築&lt;/a&gt;」の記事で、Ryzen7 5700GでESXi7のセットアップをしました。今回はESXi8.0の動作確認も含めてRyzen5 5600Gでセットアップしました。&lt;/p&gt;</summary>
    
    
    
    <category term="Hardware" scheme="https://yoshi0808.github.io/new-technology/categories/Hardware/"/>
    
    
    <category term="25GbE" scheme="https://yoshi0808.github.io/new-technology/tags/25GbE/"/>
    
    <category term="ESXi" scheme="https://yoshi0808.github.io/new-technology/tags/ESXi/"/>
    
  </entry>
  
  <entry>
    <title>VMware ESXiを8.0にアップグレードする</title>
    <link href="https://yoshi0808.github.io/new-technology/2023/06/18/esxi-upgrade8/"/>
    <id>https://yoshi0808.github.io/new-technology/2023/06/18/esxi-upgrade8/</id>
    <published>2023-06-17T22:00:00.000Z</published>
    <updated>2023-09-23T01:05:38.854Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2023/06/18/esxi-upgrade8/title.png" class="" width="1024" title="alt"><p class="onepoint">この記事で実現すること</p><p>無償版ESXi（VMware vSphere Hypervisor）について、ESXi8.0U1にアップグレードします。最新のESXiは8.0U2となっています。</p><span id="more"></span><h2 id="ESXiのアップグレード"><a href="#ESXiのアップグレード" class="headerlink" title="ESXiのアップグレード"></a>ESXiのアップグレード</h2><p>まず正式なアップグレードに関するドキュメントがVMwareより提供されており、こちらでポイントを確認します。アップデートとアップグレードとは異なります。<br>ESXiのバージョン体系は、”x”.”y” update “z” ビルド番号 という並びで表現されます。</p><ul><li>アップグレードは、前2桁（x,y）を上げることを指します。</li><li>アップデートは、前2桁が変わりません。それ以降の数字があるケース、またはUpdate”z”などの形式があります。Update2を省略してU2、さらにU2a、U2cなど英数字が上がっていきます。</li></ul><p><strong>アップデート</strong>によってこれまで動いていたハードウェアが動かなくなるという事は大々的にはおきません（ドライバーの更新によって認識しなくなったりうまく動作しないという一般的な理由はあります）。<strong>アップグレード</strong>ではハードウェアのサポート対象の見直しが入ります。</p><blockquote><p>ESXiのアップグレード<br> <a href="https://docs.vmware.com/jp/VMware-vSphere/8.0/vsphere-esxi-80-upgrade-guide.pdf">https://docs.vmware.com/jp/VMware-vSphere/8.0/vsphere-esxi-80-upgrade-guide.pdf</a></p></blockquote><p>例によってVMwareのマニュアルは法人向けにvCenter Serverを中心に記載されているのでポイントを無償版ESXiに絞ります。</p><ul><li>VMWare互換性ガイドでアップグレードが可能か確認する（P8）</li><li>ESXi8のハードウェア要件（P17）</li><li>アップグレード後はDiskのパーティション要件にてロールバック不可（P19）</li><li>esxcliコマンドまたはISOブートからのアップグレードの2種類がある（P37,P70）</li><li>アップグレードには新たにESXi8.0向けの（無償版ESXiの）ライセンスを登録する（P87）</li><li>仮想マシンとVMware Toolsのアップグレード（P11）</li></ul><p>注意点は以下の通りです。</p><blockquote><p>esxcliコマンドを使用してアップグレードすると、古いバージョンのESXiは新しいVIBのインストールを実行するため、署名が保存されずセキュアブートは実行できません。ISOを使用してアップグレードすると、新しいVIBは署名を保存できます。（P88）</p></blockquote><p>上記の注意点の通り、UEFIのセキュアブートで稼働しているESXiのバージョンアップにはISOを使用してアップグレードすべきと読めます。一方、セキュアブートでなければ、<code>esxcli software profile update --depot=&lt;depot_location&gt; --profile=&lt;profile_name&gt; </code>のコマンドでアップグレード可能です。詳細は、「<a href="/2020/06/14/esxi67-patch/" title="VMware ESXiにパッチを適用する">VMware ESXiにパッチを適用する</a>」の記事を参照してください。但し、ESXi8.0におけるハードウェア互換性が維持できるか慎重に確認するためには、ISOでのアップグレードを検討してください。</p><p>VMware互換性ガイドは個人向けのハードウェアが殆ど列挙されておらずチェックが困難なのが実態です。ハードウェアが準拠しているかどうかのチェックについては後述します。</p><p>また、上記マニュアルには注意点としての記載がありませんが、スナップショットを取得していない状態でアップグレードされる事をお勧めします。</p><p>ESXi8にアップグレードする例を記載しています。厳密なアップグレードパスについては以下を確認してください。</p><img src="/new-technology/2023/06/18/esxi-upgrade8/upgradepath.png" class="" width="640" title="alt"><p><a href="https://interopmatrix.vmware.com/Upgrade?productId=1363">https://interopmatrix.vmware.com/Upgrade?productId=1363</a></p><blockquote><p>vCenter Server Back-in-time release<br> <a href="https://kb.vmware.com/s/article/67077#vCenterServer_7.0.x_to_8.0_upgrade_matrix">https://kb.vmware.com/s/article/67077#vCenterServer_7.0.x_to_8.0_upgrade_matrix</a></p></blockquote><h2 id="仮想マシンのバックアップ（任意）"><a href="#仮想マシンのバックアップ（任意）" class="headerlink" title="仮想マシンのバックアップ（任意）"></a>仮想マシンのバックアップ（任意）</h2><p>バージョンアップの前には仮想マシンのバックアップを別の筐体またはメディアに取得される事をお勧めします。「<a href="/2020/10/11/esxi-backup/" title="VMware ESXiの仮想マシンをバックアップする">VMware ESXiの仮想マシンをバックアップする</a>」の記事を参照してください。ghettoVCBを使ったバックアップでは、ESXiにsshした上で、次のコマンドで全ての仮想マシンのバックアップ取得が可能です。<code>/bin/sh ./ghettoVCB.sh -a</code></p><h2 id="アップグレード対象のESXi8-0を確認する"><a href="#アップグレード対象のESXi8-0を確認する" class="headerlink" title="アップグレード対象のESXi8.0を確認する"></a>アップグレード対象のESXi8.0を確認する</h2><p>ESXiのISOインストーラのダウンロードは、2023年9月23日時点ではESXi8.0 Update2となっています。</p><blockquote><p>VMware vSphere Hypervisor 8.0 ダウンロード センター(※VMware Customer Connectへログインが必要です)<br> <a href="https://customerconnect.vmware.com/jp/evalcenter?p=free-esxi8">https://customerconnect.vmware.com/jp/evalcenter?p=free-esxi8</a></p></blockquote><h2 id="ESXi8-0インストールメディア（USB）の作成"><a href="#ESXi8-0インストールメディア（USB）の作成" class="headerlink" title="ESXi8.0インストールメディア（USB）の作成"></a>ESXi8.0インストールメディア（USB）の作成</h2><p>ここではUSBメモリを用意し、ESXi8.0のインストーラーをセットアップします。<br>事前にハードウェア互換リストを元に互換性があるかチェックしたいところですが、実際に個人向けのハードウェアは殆ど列挙されていません。</p><blockquote><p>VMware Compatibility Guide<br> <a href="https://www.vmware.com/resources/compatibility/search.php">https://www.vmware.com/resources/compatibility/search.php</a></p></blockquote><p>以前は検証のためにUSB上にESXi7.0をセットアップできましたが、 ESXi8からはUSBへのテストセットアップできなくなっています。ハードウェアが準拠せずアップグレード後起動しない、NICが利用できない可能性があるため、仮想マシンのバックアップを確保される事をお勧めします。なお、個人向けのハードウェアで関係するところは、Mellanox Connect X-3がサポート対象外となりました。Mellanoxユーザーとしては、Connect X-4&#x2F;X-5を使う事になるでしょう。</p><h3 id="ESXi8-0-インストーラーのダウンロード"><a href="#ESXi8-0-インストーラーのダウンロード" class="headerlink" title="ESXi8.0 インストーラーのダウンロード"></a>ESXi8.0 インストーラーのダウンロード</h3><p>以下からISOをダウンロードします。</p><p><a href="https://customerconnect.vmware.com/jp/web/vmware/evalcenter?p=free-esxi8">https://customerconnect.vmware.com/jp/web/vmware/evalcenter?p=free-esxi8</a></p><p>ダウンロードは、”VMware vSphere Hypervisor (ESXi ISO) image”をダウンロードします。</p><p>また、製品のライセンスキーが表示されていますので、メモを取っておいてください。</p><h3 id="Rufusによるisoメディアの作成"><a href="#Rufusによるisoメディアの作成" class="headerlink" title="Rufusによるisoメディアの作成"></a>Rufusによるisoメディアの作成</h3><p>以下のサイトからRufusをWindowsでダウンロードし実行します。</p><blockquote><p>Rufus<br> <a href="https://rufus.ie/ja/">https://rufus.ie/ja/</a></p></blockquote><p> 以下のオプションでUSBメディアにESXi8のインストーラーを書き込みます。</p> <img src="/new-technology/2023/06/18/esxi-upgrade8/rufus1.png" class="" width="480" title="alt"><p> UEFIのセキュアブートに対応させるためにはGPTとUEFIを選択してください。</p><h2 id="ESXi8-0へのアップグレード"><a href="#ESXi8-0へのアップグレード" class="headerlink" title="ESXi8.0へのアップグレード"></a>ESXi8.0へのアップグレード</h2><p>以下の動画を参考にしてください。特に難しいものはありません。途中、新規インストールかアップグレードか選択する箇所があります。この動画では新規インストールを選択していますが、アップグレードを選んでください。</p><blockquote><p><a href="https://www.youtube.com/watch?v=eiZn54GPfzI">https://www.youtube.com/watch?v=eiZn54GPfzI</a></p></blockquote><img src="/new-technology/2023/06/18/esxi-upgrade8/install.png" class="" width="1024" title="alt"><p>アップグレードが終了し、再起動する際にはUSBメディアは外してください。</p><p>無事再起動したら管理画面にログインします。<br>sshでESXiに接続し、<code>esxcli system version get</code>を実行し確認します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost:~] esxcli system version get</span><br><span class="line">   Product: VMware ESXi</span><br><span class="line">   Version: 8.0.1</span><br><span class="line">   Build: Releasebuild-21495797</span><br><span class="line">   Update: 1</span><br><span class="line">   Patch: 0</span><br><span class="line">[root@localhost:~]</span><br></pre></td></tr></table></figure><p>管理画面でもESXi8になっていることは確認できますし、<code>vmware -l</code>コマンドでも確認できますが、Versionとビルド番号で見るには上記コマンドを使います。</p><h2 id="後処理"><a href="#後処理" class="headerlink" title="後処理"></a>後処理</h2><p>無事アップグレードが成功したら、以下の作業を行います。</p><ol><li>ESXi8.0のライセンス登録<br> ESXiにログイン後、左ペインメニューの<mark class="label primary">ホスト</mark>-<mark class="label primary">管理</mark>から<mark class="label primary">ライセンスタブ</mark>を選択し、<mark class="label primary">ライセンスの割り当て</mark>でダウンロード時に控えたライセンスキーを登録します。</li><li>ESXi8.0の最新パッチ適用<br> ESXiのパッチ適用については、「<a href="/2020/06/14/esxi67-patch/" title="VMware ESXiにパッチを適用する">VMware ESXiにパッチを適用する</a>」を参照してください。</li><li>ESXi8.0の構成情報のバックアップ（任意）</li></ol><h2 id="仮想マシンのアップグレード（任意）"><a href="#仮想マシンのアップグレード（任意）" class="headerlink" title="仮想マシンのアップグレード（任意）"></a>仮想マシンのアップグレード（任意）</h2><p>ESXiのバージョンアップ後、仮想マシンのバージョンをアップグレードできます。</p><p>アップグレードしたESXi8.0VMware Toolsよりも新しいバージョンがある場合は以下のように表示されます。</p><img src="/new-technology/2023/06/18/esxi-upgrade8/vmwaretools2.png" class="" width="640" title="alt"><p>この場合はWebUIで左ペインの<mark class="label primary">仮想マシン</mark>で対象仮想マシンを選択し、<mark class="label primary">アクション</mark>メニュー→<mark class="label primary">ゲストOS</mark>から<mark class="label primary">VMware Toolsのアップグレード</mark>を実行します。</p><p>詳細は以下の内容を参照してください。</p><blockquote><p>VMware Tools のアップグレード<br> <a href="https://docs.vmware.com/jp/VMware-Tools/11.3.0/com.vmware.vsphere.vmwaretools.doc/GUID-A2491004-1C67-4E14-B47B-807E20C19108.html">https://docs.vmware.com/jp/VMware-Tools/11.3.0/com.vmware.vsphere.vmwaretools.doc/GUID-A2491004-1C67-4E14-B47B-807E20C19108.html</a></p></blockquote><p>VMware Toolsを最新にした後、仮想マシンハードウェアをアップグレードすることができます。ただし、下記のドキュメントに注意書きがある通り、新しいハードウェアバージョンの付属機能が必要な場合のみ実行することとあり、これはESXiのアップグレードに対して必須事項ではありません。</p><blockquote><p>仮想マシンの互換性の手動アップグレード<br> <a href="https://docs.vmware.com/jp/VMware-vSphere/7.0/com.vmware.vsphere.vm_admin.doc/GUID-60768C2F-72E1-42E0-8A17-CA76849F2950.html">https://docs.vmware.com/jp/VMware-vSphere/7.0/com.vmware.vsphere.vm_admin.doc/GUID-60768C2F-72E1-42E0-8A17-CA76849F2950.html</a></p></blockquote><div class="note warning"><ul><li>仮想マシン ハードウェアをアップグレードすると、一部のアプリケーションまたはオペレーティング システムが適切に動作しなくなることがあります。ハードウェア バージョンのアップグレードは、新しいハードウェア バージョンの付属機能が必要な場合のみ実行します。</li><li>Microsoft Windows 仮想マシンで VMware Tools をアップグレードする前に互換性をアップグレードすると、仮想マシンのネットワーク設定が失われることがあります。</li></ul></div><p>この操作は以下の通りWebUIで左ペインの<mark class="label primary">仮想マシン</mark>で対象仮想マシンを選択し、<mark class="label primary">アクション</mark>メニューから<mark class="label primary">仮想マシンの互換性のアップグレード</mark>を実行します。</p><img src="/new-technology/2023/06/18/esxi-upgrade8/upgrade-vm.png" class="" width="800" title="alt"><h2 id="構成情報のバックアップ（任意）"><a href="#構成情報のバックアップ（任意）" class="headerlink" title="構成情報のバックアップ（任意）"></a>構成情報のバックアップ（任意）</h2><p>今後、パッチ適用を重ねていきますが、ある時点にロールバックしたいと思った時に、ホスト構成バックアップから戻す必要が出てきます。パッチを当てる度に構成情報のバックアップを取得されることをお勧めします。</p><p>参考にするドキュメントはこちらです。</p><blockquote><p>ESXi ホストの構成のバックアップ方法 (2042141)<br> <a href="https://kb.vmware.com/s/article/2042141?lang=ja">https://kb.vmware.com/s/article/2042141?lang=ja</a></p></blockquote><ol><li>SSHでESXiに接続します。</li><li>ストレージの確実な同期のためのコマンド<code>vim-cmd hostsvc/firmware/sync_config</code>を実行します。</li><li>バックアップコマンド<code>vim-cmd hostsvc/firmware/backup_config</code>を実行します。</li><li>画面にダウンロードパスが表示されるのでそのURLにブラウザから接続し構成情報をダウンロードします。</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@esxi:~] vim-cmd hostsvc/firmware/sync_config</span><br><span class="line">[root@esxi:~] vim-cmd hostsvc/firmware/backup_config</span><br><span class="line">Bundle can be downloaded at : http://*/downloads/52ce000f-cad4-20c0-078d-a111fa1ad82x/configBundle-esxi.local.tgz</span><br><span class="line">[root@esxi:~]</span><br></pre></td></tr></table></figure><p>先頭に<code>http://*/</code>とありますが、ここはESXiのホスト名またはIPアドレスを指定しブラウザからアクセスします。例えば、<code>http://192.168.1.1/downloads〜</code>という具合です。万が一レストアが必要になってしまった場合はバックアップを取得したバージョンのパッチを適用の上、メンテナンスモードに移行してから<code>vim-cmd hostsvc/firmware/restore_config /your_backup_location/configBundle-esxi.local.tgz</code>で戻します。バックアップを取得してから既にハードウェア構成が変わっていたりする場合は戻せない場合があります。仮想マシンはデータストアブラウザから再登録する必要があります。詳細は上記VMwareのドキュメントを参照してください。</p>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2023/06/18/esxi-upgrade8/title.png&quot; class=&quot;&quot; width=&quot;1024&quot; title=&quot;alt&quot;&gt;
&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;

&lt;p&gt;無償版ESXi（VMware vSphere Hypervisor）について、ESXi8.0U1にアップグレードします。最新のESXiは8.0U2となっています。&lt;/p&gt;</summary>
    
    
    
    <category term="Software" scheme="https://yoshi0808.github.io/new-technology/categories/Software/"/>
    
    
    <category term="ESXi" scheme="https://yoshi0808.github.io/new-technology/tags/ESXi/"/>
    
  </entry>
  
  <entry>
    <title>Sophos Firewall v19.5 MR-2</title>
    <link href="https://yoshi0808.github.io/new-technology/2023/05/16/xg-v195mr2/"/>
    <id>https://yoshi0808.github.io/new-technology/2023/05/16/xg-v195mr2/</id>
    <published>2023-05-16T03:00:00.000Z</published>
    <updated>2023-05-16T12:39:00.659Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2023/05/16/xg-v195mr2/title.png" class="" title="alt"><h2 id="Sophos-Firewall-v19-5-MR2"><a href="#Sophos-Firewall-v19-5-MR2" class="headerlink" title="Sophos Firewall v19.5 MR2"></a>Sophos Firewall v19.5 MR2</h2><p>Sophos Firewall v19.5 MR2が2023年5月8日に発表されました。</p><span id="more"></span><h2 id="主なエンハンスの内容"><a href="#主なエンハンスの内容" class="headerlink" title="主なエンハンスの内容"></a>主なエンハンスの内容</h2><p>MR2ではセキュリティ向上と4,000のマルチキャストグループのルーティングに対応しています。ホームユーザーにとって新機能が無いのは少し寂しいですが、安定性はv19以降でかなり向上しています。<br>WANセグメントに管理画面を開放している場合、ACLで厳格にアクセスリストを求められるようになります。部門のFirewallを想定しているのかもしれませんね。個人ではWANに管理画面を開放するようなことはありませんが。。。</p><p>v19.5 MR2の詳細な説明はRelease Notesを参照してください。</p><blockquote><p><a href="https://docs.sophos.com/releasenotes/index.html?productGroupID=nsg&amp;productID=xg&amp;versionID=19.5">https://docs.sophos.com/releasenotes/index.html?productGroupID=nsg&amp;productID=xg&amp;versionID=19.5</a></p></blockquote><h2 id="Sophos-Firewallのアップデート"><a href="#Sophos-Firewallのアップデート" class="headerlink" title="Sophos Firewallのアップデート"></a>Sophos Firewallのアップデート</h2><p>XGの管理画面にログイン後、左ペインメニューの<mark class="label primary">バックアップ＆ファームウェア</mark>の<mark class="label primary">ファームウェアの確認</mark>に通知が来る場合があります。</p><img src="/new-technology/2023/05/16/xg-v195mr2/notice.png" class="" width="480" title="alt"><p>また、アップデートの案内が来ていなくても、MySophosにログインし、バージョンアップの差分モジュールをダウンロードします。</p><ol><li>Sophosのサイトの上部の「ソフォスについて」のプルダウンメニューから、<mark class="label primary">ライセンスとアカウント</mark>をクリックします。<blockquote><p><a href="https://www.sophos.com/ja-jp.aspx">https://www.sophos.com/ja-jp.aspx</a></p></blockquote></li><li>Sophos IDをお持ちでなければIDを作成します。</li><li>ログイン後、<mark class="label primary">Network Protection</mark>をクリックします。</li><li><mark class="label primary">Firmware Updates</mark>をクリックします。</li><li>「製品名&#x2F;OSを使った検索」で”Firewall”を選択し、その後現れるプルダウンは”Software”を選択します。</li><li><mark class="label primary">Show Available Downloads</mark>ボタンをクリックします。</li></ol><img src="/new-technology/2023/05/16/xg-v195mr2/mysophos.png" class="" width="800" title="alt"><ol><li>上記画面で”SW-19.5.2_MR-3.SFW-624.sig”というアップデータが表示されますのでダウンロードします。</li><li>MY Sophosはここで終了してXGの管理画面にログインし、左ペインメニューの<mark class="label primary">バックアップ＆ファームウェア</mark>の<mark class="label primary">ファームウェアのタブメニュー</mark>から以下の画面に赤丸で囲った矢印のアイコンをクリックし、ダウンロードしたモジュールをアップロードします。</li></ol><img src="/new-technology/2023/05/16/xg-v195mr2/verup.png" class="" width="800" title="alt"><p>アップロード＆再起動ボタンをクリックし、v19.5 MR2へのアップグレードを完了させます。</p><img src="/new-technology/2023/05/16/xg-v195mr2/upgrade.png" class="" width="800" title="alt"><div class="note info"><p>仮想環境（ESXi）上にFirewallをインストールされている方はアップグレードの前に、「<a href="/2020/10/11/esxi-backup/" title="VMware ESXiの仮想マシンをバックアップする">VMware ESXiの仮想マシンをバックアップする</a>」を参考に、バックアップを確保される事をお勧めします。</p></div>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2023/05/16/xg-v195mr2/title.png&quot; class=&quot;&quot; title=&quot;alt&quot;&gt;

&lt;h2 id=&quot;Sophos-Firewall-v19-5-MR2&quot;&gt;&lt;a href=&quot;#Sophos-Firewall-v19-5-MR2&quot; class=&quot;headerlink&quot; title=&quot;Sophos Firewall v19.5 MR2&quot;&gt;&lt;/a&gt;Sophos Firewall v19.5 MR2&lt;/h2&gt;&lt;p&gt;Sophos Firewall v19.5 MR2が2023年5月8日に発表されました。&lt;/p&gt;</summary>
    
    
    
    <category term="Security" scheme="https://yoshi0808.github.io/new-technology/categories/Security/"/>
    
    
    <category term="XG Firewall" scheme="https://yoshi0808.github.io/new-technology/tags/XG-Firewall/"/>
    
  </entry>
  
  <entry>
    <title>L2ネットワークとESXi</title>
    <link href="https://yoshi0808.github.io/new-technology/2023/04/29/l2-esxi/"/>
    <id>https://yoshi0808.github.io/new-technology/2023/04/29/l2-esxi/</id>
    <published>2023-04-28T15:00:00.000Z</published>
    <updated>2023-04-28T23:27:23.360Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2023/04/29/l2-esxi/title.png" class="" title="alt"><p class="onepoint">この記事で実現すること</p><p>ネットワークの教本といえば、TCP&#x2F;IP、つまりレイヤ3が中心の解説が中心です。ここでは、普段なかなか目にすることのないL2ネットワークの基礎、 ESXiにおけるネットワークの設定について説明するものです。</p><span id="more"></span><h2 id="L2ネットワークとIPアドレス"><a href="#L2ネットワークとIPアドレス" class="headerlink" title="L2ネットワークとIPアドレス"></a>L2ネットワークとIPアドレス</h2><p>個人向けのWi-Fiルーターなどを使い、PCやスマホ、またはNASや仮想環境などを使うようになれば、IPアドレスやDHCP、そして個々の端末が保有するMACアドレスというところは良く目にすることでしょう。Wi-Fiルーターと無線接続する端末だけだと、なかなかL2レイヤは気にすることは無いかもしれません。ネットワークを高度化して、ESXiなどの仮想環境を使い始めると、L2レイヤの知識が必要となってきます。何となくは理解して仮想環境を使われている方が多いかと思いますが、L2スイッチとVLAN、スタンドアロン（無償版）ESXiのvSwitchなどの具体的な設定などを確認していきます。</p><h2 id="スイッチングハブ"><a href="#スイッチングハブ" class="headerlink" title="スイッチングハブ"></a>スイッチングハブ</h2><p>個人向けに販売されているスイッチングハブといえば、一般的にL2スイッチを指します。TCP&#x2F;IPのルーティングができるL3スイッチもありますが、高額です。L2スイッチも大まかには2種類あり、VLANの設定ができるタイプと、設定が出来ないタイプとの2種類あります。スイッチングハブのネーミングの理由としては、指定されたMACアドレスがあるポートにのみデータを転送する機能を持つものです。昔のハブは電気的に全てのポートにデータを送っており、さらに半二重通信（片方が送信している時は相手側は送信できない。Wi-Fiと同様）でしたが、今のスイッチングハブといえば、全二重で双方向通信が可能であり、複数端末の同時通信でデータ送受信の競合がないようになっています（半二重通信ができる製品もあります）。スイッチングハブではない昔ながらのハブはダムハブやリピーターハブと呼ばれましたが昨今ではむしろその製品を探すのが難しくなっています（ダムハブは隣の端末の通信を傍受できるのでパケットキャプチャとしての使い道はあります）。</p><p>スイッチングハブをタイプ別と特徴で示すと以下の通りです。</p><table><thead><tr><th>タイプ</th><th>説明</th><th>特徴</th></tr></thead><tbody><tr><td>アンマネージ</td><td>電源OnしてLANケーブルを繋いですぐに使える製品。設定画面などは一切ない。</td><td>安価</td></tr><tr><td>スマートスイッチ</td><td>管理画面があり、VLAN、MACアドレスフィルタやパケットの優先度設定などが可能</td><td>個人向けには少ない</td></tr><tr><td>マネージド</td><td>VLAN、高度な管理（SNMP、Portミラーリング、コマンドライン）</td><td>やや高額。L2スイッチではスマートスイッチとマネージドとの区別が付けづらくなってきている</td></tr><tr><td>L3スイッチ</td><td>DHCP機能、ネットワークアドレスを分離し、ルーティングが可能。マネージドスイッチの扱い。</td><td>高額。ネットワークの知識が必要な難解なコマンドライン中心の製品が多い。</td></tr></tbody></table><p>ホームユーザーとしては、こういった情報よりも、10GbEとか2.5GbEなどのポートの速度を優先したり、発熱を気にしてファンレスか否か、ファンがどれだけ静かなのかをポイントにしてスイッチングハブを購入されていることでしょう。単にネットを使うだけであればそれで充分で、普段はL2ネットワークの事を気にする必要はありません。</p><p>リモートワークで家の機器と会社の機器とを分離したい場合、一般的にWi-Fiルーターではゲスト用ネットワーク（ゲスト用SSID）があるので、昔ほどVLANを必要としなくなっています。こういった単にネットを使うだけで何も管理できないスイッチをアンマネージスイッチと呼びます。</p><h3 id="スイッチング能力"><a href="#スイッチング能力" class="headerlink" title="スイッチング能力"></a>スイッチング能力</h3><p>スイッチの性能の一つにスイッチング能力、別名、スイッチングファブリックというものがあります。比較サイトでも必ずスペックとして出ているものですが、この数値は、基本的に全てのポートが全二重でブロッキングせずにデータを送信できるものとして計算された数値となっています。8Portで全て10GbEなら以下の通りです。</p><ul><li>10Gbps×8(Port)×2（全二重）&#x3D; 160Gbps</li></ul><p>10GbEが4Port、1GbEが8Portの製品なら、96Gbpsという具合です。ですので、製品を比較して「こちらのハブのスループットが高そうだ」という事にはなりません。</p><h3 id="スマートスイッチ・マネージドスイッチ"><a href="#スマートスイッチ・マネージドスイッチ" class="headerlink" title="スマートスイッチ・マネージドスイッチ"></a>スマートスイッチ・マネージドスイッチ</h3><p>全く管理画面が無いL2スイッチはIPアドレスを持ちませんが、スマートスイッチ・マネージドスイッチと呼ばれている製品はIPアドレスを持ちます。この”スマート”や”マネージド”というネーミングも実は明確な定義はありません。各社によって呼び名が少しづつ異なっており、はっきり言えばマーケティング用語です。Webの管理画面があってもVLANが無いL2スイッチもあります。</p><p>IPアドレスを持っているとはいえ、スイッチ経由で通信をする際に、ルーターのようにスイッチのIPアドレスを経由する訳ではありません。以下のように見えないPort0番にAmazon Fire Stickをさらに小さくしたような組み込み機器で独立したOSが接続されていて、そこに最低限のネットワーク通信と管理のためのOSの機能を持っていると考えてください。スイッチングハブとしてパケットを転送している機能はハードウェアであるASIC(Application Specific Integrated Circuit)が担っており、この小さな機器は殆ど使われません。最近のWi-Fi機器もこういった形になっており、管理画面の遷移が遅いからといって転送能力が劣っているという訳でもありません。PCなどからスイッチへのpingを打つと、このPort0番に着信して応答を返す仕組みになります（pingの応答速度も一般的に遅いです）。</p><img src="/new-technology/2023/04/29/l2-esxi/sw3.drawio.png" class="" width="360" title="alt"><p>日本では、全くITの知識が無い人向けに分かりやすくスイッチを提供するという事が主眼に置かれているため、アンマネージスイッチが主力製品として販売されていますが、値段なりの品質です。仮想環境やNASなど24時間の運用を前提で考えるのであれば、スイッチにもそれなりの品質を求めるべきです。アンマネージで不具合が出ると回収するしかありません。ファームウェアの更新ができるもの、かつ、きちんと定期的にアップデートが行われている製品を選定されることをお勧めします。</p><h3 id="L2ネットワークとMACアドレス"><a href="#L2ネットワークとMACアドレス" class="headerlink" title="L2ネットワークとMACアドレス"></a>L2ネットワークとMACアドレス</h3><p>L2スイッチはMACアドレスを宛先として判断し、パケットを目的のポートに転送します。この世界ではIPアドレスはデータの中身として扱われ、宛先として使われることはありません。例えば、以下のPCとL2スイッチとの関係で確認してみます。</p><img src="/new-technology/2023/04/29/l2-esxi/net1.drawio.png" class="" width="640" title="alt"><p>PC1からPC2にpingを打つこととします。</p><pre class="mermaid">sequenceDiagramparticipant pc1 as PC1participant sw as SWitchparticipant pc2 as PC2Note over pc1: 1.PC2へのpingコマンド投入pc1 -&gt;&gt; sw : 2.ARP Request(PC2)をブロードキャストNote over sw: 3.PC1のMACを自己学習sw -&gt;&gt; pc2 : 4.ARP Requestをブロードキャストpc2 --&gt;&gt; sw : 5.ARP Reply(PC2のMAC)Note over sw: 6.PC2のMACを自己学習sw --&gt;&gt; pc1 : 7.ARP Reply(PC2のMAC)pc1 -&gt;&gt; sw : 8.ICMP Echo Requestsw -&gt;&gt; pc2 : 9.ICMP Echo Requestpc2 --&gt;&gt; sw : 10.ICMP Echo Replysw --&gt;&gt; pc1 : 11.ICMP Echo ReplyNote over pc1: 12.ping応答</pre><p>このシーケンスの実行の結果は以下の通りです。</p><p>PC1のarpテーブルは以下になります(Windowsでの実行を想定)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\yoshi&gt;arp -a</span><br><span class="line"></span><br><span class="line">インターフェイス: 192.168.100.129 --- 0x10</span><br><span class="line"> インターネット アドレス 物理アドレス           種類</span><br><span class="line">  192.168.100.161       04-69-f8-aa-bb-cc      動的</span><br><span class="line">  255.255.255.255       ff-ff-ff-ff-ff-ff     静的</span><br></pre></td></tr></table></figure><p>PC2のARPテーブルは以下になります(macOSでの実行を想定)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ arp -a</span><br><span class="line">? (192.168.100.129) at 30:59:b7:00:11::22 on en0 ifscope [ethernet]</span><br></pre></td></tr></table></figure><p>そして、スイッチ上のMACアドレステーブルは、MACアドレスと接続されているPortの組み合わせが登録されています（ここではUbiquiti社のPro Aggregationスイッチを使っています。各社、機種毎に取得方法は異なります）。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(UBNT) &gt;show mac-addr-table</span><br><span class="line"></span><br><span class="line">VLAN ID  MAC Address         Interface              IfIndex  Status</span><br><span class="line">-------  ------------------  ---------------------  -------  ------------</span><br><span class="line">1        30:59:B7:00:11:22   0/1                    1        Learned</span><br><span class="line">1        04:69:F8:AA:BB:CC   0/28                   28       Learned</span><br></pre></td></tr></table></figure><p>VLANはデフォルトVLANが1の製品が大半です。MACアドレステーブルにはVLANのIDが必要ですが、詳細説明は割愛します（機種により実装の違いがあります）。</p><p>さて、このようにして、PC同士はL3レイヤ（IPアドレス）からL2レイヤ（MACアドレス）への変換の情報をお互いに持ち、スイッチはMACアドレスとそれがどのPortに接続されているかを管理しています。</p><p>スイッチ自身に管理画面がないと、スイッチの中身がどうなっているか分からないんですが、アンマネージスイッチでは管理IPアドレスを持たないだけで、しっかりとMACアドレステーブルの管理は行われています。</p><p>ちなみに、MACアドレスは6バイトでコロン区切りかハイフン区切りとなっています。先頭の3バイトがVendorIDとなっていて、上記の例だと、<code>30:59:B7</code>はMicrosoft社であり、<code>04:69:F8</code>はApple社になります。</p><p>ご自身のPCでも<code>arp -a</code>を実行してみてください。LANにあるさまざまな端末のIPアドレスとMACアドレスの一覧が確認できるはずです。</p><blockquote><p>Ubiquiti Switch Pro Aggregation<br> <a href="https://jp.store.ui.com/collections/unifi-network-switching/products/unifi-switch-aggregation-pro">https://jp.store.ui.com/collections/unifi-network-switching/products/unifi-switch-aggregation-pro</a></p></blockquote><h2 id="ESXiのL2ネットワーク"><a href="#ESXiのL2ネットワーク" class="headerlink" title="ESXiのL2ネットワーク"></a>ESXiのL2ネットワーク</h2><p>ここではVSphere Hypervisor（無償版ESXi）についての説明になります。ESXiは仮想環境として端末を動作させる機能とvSwitchという仮想ネットワークスイッチの機能を持っています。実際は1つのネットワークカードに対して、複数の仮想マシンを動作させることが可能となっています。</p><h3 id="仮想マシンのNIC"><a href="#仮想マシンのNIC" class="headerlink" title="仮想マシンのNIC"></a>仮想マシンのNIC</h3><p>仮想マシンの構成としての一例を挙げます。</p><img src="/new-technology/2023/04/29/l2-esxi/vm1.png" class="" width="1024" title="alt"><p>この仮想マシンはUbuntuで、1つの仮想ネットワークアダプタを持っています。最もシンプルな構成です。MACアドレスの先頭3バイトは<code>00:0c:29</code>となっており、これはVMwareのVenderIDです。下位3バイトは仮想マシンの構成時に自動的に振られます。</p><p>続いて、仮想ネットワークスイッチの説明です。</p><img src="/new-technology/2023/04/29/l2-esxi/vsw1.png" class="" width="1024" title="alt"><p>この例では仮想スイッチ1つに物理アダプタを1つ加えています。ESXi本体のハードウェアに付属するネットワークカードが物理アダプタです。</p><img src="/new-technology/2023/04/29/l2-esxi/vsw2.png" class="" width="640" title="alt"><p>この物理アダプタには当然ですが物理MACアドレスがあります。仮想ネットワークアダプタに到達するためには、この物理アダプタを経由する必要があります。しかし、ESXiのネットワークドライバのレベルで仮想ネットワークアダプタがNICの物理デバイスと接続されており、物理ネットワークアダプタ<code>80:61:5f:xx:xx:xx</code>は使わず、仮想MACアドレス<code>00:0c:29:4f:2e:05</code>が仮想マシンに接続されています。<code>80:61:5f:xx:xx:xx</code>は使われていないと書きましたが、ESXiを構成すると、vmnic0の物理MACアドレスはESXiのVMKernelのvmk0に使われるようになっています。ESXiの世界ではネットワークの障害時の切り替えなども考慮し、物理MACアドレスはあまり重要ではありません。</p><p>過去の技術ですが、物理MACアドレスがデータを受け取って仮想MACアドレスに変換して受け渡す、いわゆるNATの技術も実際には存在します。しかし、今のESXiでは物理NICから実際の仮想MACアドレスのデータが流れていきます。</p><p>一例として、私の保有しているスイッチでPort19のESXiの物理NICとESXiの仮想MACアドレステーブルを表示させると以下のようになっています。<br>（物理MACアドレスの値と一部のVLANの値は修正しています）<br>前述したように、先頭３バイトが<code>00:0C:29</code>のものが仮想マシンです。</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(UBNT) <span class="comment">#show mac-addr-table | include Interface|00:0C:29|80:61:5F</span></span><br><span class="line"></span><br><span class="line">VLAN ID  MAC Address         Interface              IfIndex  Status</span><br><span class="line">200      00:0C:29:4F:2E:05   0/19                   19       Learned</span><br><span class="line">200      00:0C:29:C8:1F:97   0/19                   19       Learned</span><br><span class="line">200      80:61:5F:00:00:03   0/19                   19       Learned</span><br></pre></td></tr></table></figure><p>VLAN200の２つの仮想マシンが存在している事が分かります、スイッチはこのようにして仮想マシンのMACアドレス１つ１つを管理し、適切なスイッチポートに転送していることがわかります。</p><p>ちなみに物理スイッチを多段接続した場合にも、1つのポートから先のスイッチ経由で複数の端末が接続されていれば同様に1つのポートに複数の端末のMACアドレスがテーブルに管理されます。</p><h3 id="vSwitch"><a href="#vSwitch" class="headerlink" title="vSwitch"></a>vSwitch</h3><p>vSwitchでは物理NICを経由して仮想マシンと接続するためのポートグループが必要です。仮想マシンにネットワークアダプタを加える時にはこのポートグループが必要です。ESXiのセットアップ完了後は、<mark class="label primary">vSwitch0</mark>  がデフォルトのvSwitchとして作成されており、ポートグループとして、<mark class="label primary">Management Network</mark>および<mark class="label primary">VM Network</mark>の2つが作成されています。</p><img src="/new-technology/2023/04/29/l2-esxi/vsw3.png" class="" width="480" title="alt"><mark class="label primary">Management Network</mark>は、ESXiのWebにログインしたり制御のためのポートグループです。このグループの中にデフォルトで<mark class="label primary">VMKernel NIC</mark>として<mark class="label primary">vmk0</mark>が自動作成されています。VMKernel NICはESXiのWebサービスを始めとする管理系のサービス提供のためのIPアドレスを持ちます。前述したL2スイッチの説明ではPort0として小さな組み込み機器としてOSが稼働していると表現しましたが、それと目的は同じです。VMKernelはvSwitchを制御するというよりは、ネットワークセグメント単位に持ち、ESXiを管理するためのIPアドレスとなります。<mark class="label primary">VM Network</mark>もポートグループです。仮想マシンが何もない初期状態では特に仮想IPアドレスも保有していません。仮想マシンを作成し、ネットワークアダプタを追加する際に、この<mark class="label primary">VM Network</mark>を選択することになります。そうすると自動的に仮想IPアドレスが振られます。もちろん、新規にポートグループを作成し、仮想マシンにネットワークアダプタを追加する事もできます。また、ポートグループという”グループ”の意味としては、複数の仮想マシンを同一のポートグループに追加できます。この際、MACアドレスが同じになったりはしません。<div class="note info"><p>ポートグループ1つで複数の仮想NICと接続できます。仮想マシン作成時、仮想MACアドレスは自動的に割り当てられます。物理NICを2つ以上保有する場合、障害対策と負荷分散ができます。負荷分散の際、ESXiのデフォルトでは、ポートグループ単位に複数の物理NICを使い負荷分散をします。</p></div><div class="note info"><p><mark class="label primary">Management Network</mark>と<mark class="label primary">VM Network</mark>のポートグループが分かれているのは、本来、マネジメントネットワークとクライアントやサーバーがある仮想マシンのネットワークとは分離すべきという考えに基づいています。</p></div><p>なお、仮想マシンをバックアップから戻した場合には、既存の仮想マシンと同一のMACアドレスで復元してしまうと通信が正しく行えなくなります。従って、仮想マシンの復元後、初期起動時には以下のダイアログが表示され、<mark class="label primary">コピーしました</mark>を選択すると、新しい仮想MACアドレスが割り当てられます。</p><img src="/new-technology/2023/04/29/l2-esxi/esxi3.png" class="" width="640" title="alt"><h4 id="特殊な設定"><a href="#特殊な設定" class="headerlink" title="特殊な設定"></a>特殊な設定</h4><p>vSwitchには以下の2つの特殊な仮想マシンのための追加設定ができます。</p><img src="/new-technology/2023/04/29/l2-esxi/vsw4.png" class="" width="480" title="alt"><ul><li><mark class="label primary">無差別モードを許可</mark><p> ファイアウォールやIPS&#x2F;IDS（Intrusion Prevention System&#x2F;Intrusion Detection System）などセキュリティ製品におけるブリッジモードのように、同一LAN内でパケットの検証をする際にはこれを<mark class="label primary">はい</mark>に変更します。セキュリティ製品の先に接続されている端末も同一のL2ネットワークとして全てパケットを転送してあげる動作です。自分宛のMACアドレスでなくとも受け取る挙動であり、仮想マシンはダムハブに見えるわけです。また、仮想マシンのネットワークキャプチャを行う場合に使えます。</p></li><li><mark class="label primary">偽装転送を許可/MAC変更を許可</mark><p> 上記と同じようにセキュリティ製品（ゲートウェイ）がバックヤードにある端末のパケットを相互にやりとりするわけですから、自分自身のMACアドレスではないMACアドレスを持ったデータを送信する事になります。一般的にはセキュリティ上認めていないものですが、セキュリティ製品では<mark class="label primary">MAC変更を許可</mark>を<mark class="label primary">はい</mark>を、<mark class="label primary">偽装転送を許可</mark>を<mark class="label primary">はい</mark>にします。</p></li></ul><p>これらはいずれもセキュリティ強化のためにデフォルトでは<mark class="label primary">いいえ</mark>になっています。<br>これらの機能の詳細はVMwareの以下のドキュメントを参照してください。</p><blockquote><p>vSphere 標準スイッチのセキュリティ強化<br> <a href="https://docs.vmware.com/jp/VMware-vSphere/7.0/com.vmware.vsphere.security.doc/GUID-3507432E-AFEA-4B6B-B404-17A020575358.html">https://docs.vmware.com/jp/VMware-vSphere/7.0/com.vmware.vsphere.security.doc/GUID-3507432E-AFEA-4B6B-B404-17A020575358.html</a></p></blockquote><h2 id="ESXiのVLAN"><a href="#ESXiのVLAN" class="headerlink" title="ESXiのVLAN"></a>ESXiのVLAN</h2><p>無償版ESXiではVLAN設定が可能です。<br>ESXiにおけるデフォルトVLAN（タグ無し）はVLAN ID＝0となります。通常のスイッチはVLAND ID＝1のものが多いのですが、基本的にタグ無し同士の通信であれば問題になりません。デフォルトVLANを変更し、さらにそれをネイティブVLAN（タグ無し）にする時は少し考える必要がありますが、ホームユーザー向けではそこまで考えることも無いでしょう。</p><table><thead><tr><th>ESXiのVLANのタイプ</th><th>説明</th></tr></thead><tbody><tr><td>EST</td><td>通常のタグ無し。物理スイッチのアクセスポートに接続する場合でスイッチ側でタグが外される事を期待。</td></tr><tr><td>VST</td><td>タグ付き（1〜4094）。物理スイッチからタグ付きで接続する場合。</td></tr><tr><td>VGT</td><td>タグ付き（4095）。仮想マシンに複数のタグ付きパケットを流す場合</td></tr></tbody></table><p>3種類それぞれのネーミングがあります。</p><p>EST（タグ無し）はVLANを意識しないモードです。<br>タグ無しでvSwitchのポートグループに渡されることを期待している設定です。物理スイッチがアクセスポートの場合は、タグが外されるのでvSwtichおよびポートグループでは特に何もしませんし、仮想マシンでも何も意識しません。</p><p>VSTは、VLAN IDをポートグループに設定します。<br>例えば、ESXiのマネジメントネットワークはタグ無し、仮想マシンはユーザー側ネットワークとする場合にvSwitchで2つのセグメントのデータを受け入れ、VMKernelはタグ無しのまま、仮想マシンはポートグループでIDに200を指定します。この場合はVLAN200について、vSwitchでタグが外され仮想マシンにパケットが届きますので仮想マシンでVLANの意識はしません。</p><p>VGTは物理スイッチにおけるトランクポートの役割と同等です。ポートグループに4095を設定します。仮想マシン自身がタグVLANを解釈できる場合に複数のVLANのタグ付きパケットを流し、仮想マシン側でタグを外すような使い方となります。また、VSTではESXiの仕様として1〜4094とありますが、一般的にタグありのVLANは2〜1005の間で作成しますし、個人向け環境のVLANはネットワークアドレスの第3オクテットの数字と合わせるのが無難です。<code>192.168.xxx.0/24</code><br>全てのVLANデータが流れて不要なものは仮想マシン側で破棄する事になるので負荷が高くなりやすく、物理スイッチからは必要なVLANのみのデータを流すことが求められます。</p><img src="/new-technology/2023/04/29/l2-esxi/vsw3.png" class="" width="480" title="alt"><p>VSTの例ですが、Win10ProのVLAN IDを300とすると、ポートグループの設定でVLANの値を明示します。</p><img src="/new-technology/2023/04/29/l2-esxi/vsw5.png" class="" width="640" title="alt"><p>このvSwitchの例で言えば、タグ300のパケットは、VGT（ID&#x3D;4095）、300と明示した2つの仮想マシンのみに転送されます。VLAN ID0のVM NetworkおよびManagement Networkにはタグ300のパケットは流れません。</p><p>このように、vmnic0に接続されたvSwitchネットワークはvmk0のIPネットワークが<code>192.168.1.0/24</code>だとすれば、全ての仮想マシンが<code>192.168.1.0/24</code>のIPアドレスを持つのがシンプルな構成ですが、このようにタグVLANを組み合わせることで、物理NICの数が少なくても複数のVLAN、つまり複数のネットワークセグメントのデータを通すことができます。</p><p>VGTの場合は、物理スイッチ側のMACアドレステーブルは以下のようになっています。仮想マシン自体がVLANのトランクポートを扱えるため、１つのMACアドレスに複数のVLANが割り当てられている事が分かります。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">VLAN ID  MAC Address         Interface              IfIndex  Status</span><br><span class="line">1        00:0C:29:EB:B3:CC   0/15                   15       Learned</span><br><span class="line">200      00:0C:29:EB:B3:CC   0/15                   15       Learned</span><br><span class="line">300      00:0C:29:EB:B3:CC   0/15                   15       Learned</span><br><span class="line">4040     00:0C:29:EB:B3:CC   0/15                   15       Learned</span><br></pre></td></tr></table></figure><p>ESXiのVLANタグについては以下のドキュメントを参照してください。英語ですが3つのVLANについての解説ビデオもあります。</p><blockquote><p>VMware VLAN 構成<br> <a href="https://docs.vmware.com/jp/VMware-vSphere/7.0/com.vmware.vsphere.networking.doc/GUID-7225A28C-DAAB-4E90-AE8C-795A755FBE27.html?hWord=N4IghgNiBcIBwAYBMA6AjARRAXyA">https://docs.vmware.com/jp/VMware-vSphere/7.0/com.vmware.vsphere.networking.doc/GUID-7225A28C-DAAB-4E90-AE8C-795A755FBE27.html?hWord=N4IghgNiBcIBwAYBMA6AjARRAXyA</a></p></blockquote>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2023/04/29/l2-esxi/title.png&quot; class=&quot;&quot; title=&quot;alt&quot;&gt;

&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;

&lt;p&gt;ネットワークの教本といえば、TCP&amp;#x2F;IP、つまりレイヤ3が中心の解説が中心です。ここでは、普段なかなか目にすることのないL2ネットワークの基礎、 ESXiにおけるネットワークの設定について説明するものです。&lt;/p&gt;</summary>
    
    
    
    <category term="Network" scheme="https://yoshi0808.github.io/new-technology/categories/Network/"/>
    
    
    <category term="ESXi" scheme="https://yoshi0808.github.io/new-technology/tags/ESXi/"/>
    
  </entry>
  
  <entry>
    <title>Mellanox Connect XとWindows11</title>
    <link href="https://yoshi0808.github.io/new-technology/2023/03/25/Mellanox-ConnectXandWindows11/"/>
    <id>https://yoshi0808.github.io/new-technology/2023/03/25/Mellanox-ConnectXandWindows11/</id>
    <published>2023-03-24T15:00:01.000Z</published>
    <updated>2023-07-07T09:59:55.337Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2023/03/25/Mellanox-ConnectXandWindows11/title.png" class="" width="1024" title="alt"><p class="onepoint">この記事で実現すること</p><p>この記事ではSFP+のネットワークカードである、Mellanox Connect XについてWindows11の対応状況やWindowsでのファームウェアアップデートなどを記します。</p><span id="more"></span><h2 id="安価なMellanox-Connect-Xカード"><a href="#安価なMellanox-Connect-Xカード" class="headerlink" title="安価なMellanox Connect-Xカード"></a>安価なMellanox Connect-Xカード</h2><p>すでに販売終了となったConnect X-3はeBayで5,000円弱で売られています。MellanoxのConnect Xシリーズは脆弱性の指摘も見かけず、安定しているNICでしょうか。intelに比べればマイナーですが、SFP＋で安価に入手可能となっており、ホームユーザーにとっても大変ありがたい存在です。<br>Connect X-3はWindows10までのドライバはNvidiaのサイトに掲載されていますがWindows11ではドライバの存在はありません。</p><p>しかしながら、Windows11ではConnect Xを認識してWindowsとして用意されたドライバのインストールが行われ、すぐに使えます。いわゆる、Windows11に標準で付属しているinboxドライバになります。逆にNVidiaサイトにあるWindows10用のドライバはWindows11ではエラーが発生し動きません。後述のNVidiaフォーラムの投稿をご確認ください。</p><p>最近、2PortのMellanox Connect X-4 LxをeBayでちらほら見かけるようになってきました。販売終了した製品ですが、サポートはされています。</p><p><strong>MCX4121A-ACAT</strong>という型番は、<strong>Mellanox ConnectX-4 LX 25GBE SFP28 2ポートPCIeイーサネット アダプター</strong>となっており、eBayで15,000円ほどで購入できます。SFP28はSFP+とモジュール接続口の互換性があります。SFP＋のダイレクトアタッチケーブル（DAC）やOM3ケーブルと共に使うSFP+短距離マルチモードファイバ（MM SR）モジュール等の10GbE SFP+で問題なく10Gbps通信できます。もちろん25GbEとしても使えますが、PCなどホスト端末に挿して使うには他の機器との速度差が大きすぎて使いにくいものです。intel製のNICは在庫不足から回復傾向にあるようですが、まだまだ高額です。</p><p>詳しいスペックは以下のリンクを参照してください。PCIe3 x8となっています。</p><blockquote><p>Mellanox Connect X-4<br> <a href="https://network.nvidia.com/files/doc-2020/pb-connectx-4-lx-en-card.pdf">https://network.nvidia.com/files/doc-2020/pb-connectx-4-lx-en-card.pdf</a></p></blockquote><p>Connect X-3はやや個人向けの色合いが強かったですが、Connect X-4あたりからはサーバー製品としての要素が強くなっていきます。OEM版（HPE、DELL向け等）は避けることをお勧めします。これはベンダーロックインが掛かっている可能性が高く、ファームウェアの強制書き込みなどが必要になります。また、それでうまくいく保証もありません。また、Connect X-4はいろいろなホストインタフェースがありますので、Ethernet、PCIeというところに気をつけてください。PCIeスロットに挿すだけですぐにWindows11で使えるMCX4121A-ACATはお勧めです。</p><p>2Portも要らないといっても、eBayでは意外と1Portものが出ていません。また、他カードとの兼ね合い（x16が埋まっている）でPCIe x4までという方は一般論としてConnect X-3（MCX311A-XCAT）が向いています。</p><blockquote><p>Nvidia ConnectX-4 Lx 製品概要<br> <a href="https://www.nvidia.com/ja-jp/networking/ethernet/connectx-4-lx/">https://www.nvidia.com/ja-jp/networking/ethernet/connectx-4-lx/</a></p></blockquote><blockquote><p>NVidiaフォーラムでConnect X-3のWin11のドライバが無いことをNVidiaのテクニカルサポートが示唆<br> <a href="https://forums.developer.nvidia.com/t/connectx-3-cx311a-xcat-for-win11-crashed/205962">https://forums.developer.nvidia.com/t/connectx-3-cx311a-xcat-for-win11-crashed/205962</a></p></blockquote><h2 id="Windows11でのデバイスドライバ"><a href="#Windows11でのデバイスドライバ" class="headerlink" title="Windows11でのデバイスドライバ"></a>Windows11でのデバイスドライバ</h2><h3 id="Connect-X-3"><a href="#Connect-X-3" class="headerlink" title="Connect X-3"></a>Connect X-3</h3><p>Connect X-3をPCIeにセットしてWin11を起動します。デバイスドライバを見てみます。</p><img src="/new-technology/2023/03/25/Mellanox-ConnectXandWindows11/x3.png" class="" width="480" title="alt"><p>2019年のinboxドライバが自動的に取り込まれます。このドライバに脆弱性が出てしまえば、リスクがあり別の製品に買い替えが必要となりますが、脆弱性データベースでもなかなかMellanoxの名前を見ることはありません。</p><p>お約束ですが、ESXi上のUbuntuとのiperf3を実行してみます。MTUは1,500のデフォルト、スイッチはフローコントロールをオンにしています。<br>多重度3でUbuntuからダウンロードする方向（-Rオプション）に実行して以下の通りです。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[ ID] Interval           Transfer     Bitrate         Retr</span><br><span class="line">[  5]   0.00-10.05  sec  3.81 GBytes  3.26 Gbits/sec  615             sender</span><br><span class="line">[  5]   0.00-10.00  sec  3.81 GBytes  3.27 Gbits/sec                  receiver</span><br><span class="line">[  7]   0.00-10.05  sec  3.46 GBytes  2.96 Gbits/sec  423             sender</span><br><span class="line">[  7]   0.00-10.00  sec  3.46 GBytes  2.97 Gbits/sec                  receiver</span><br><span class="line">[  9]   0.00-10.05  sec  3.79 GBytes  3.24 Gbits/sec  623             sender</span><br><span class="line">[  9]   0.00-10.00  sec  3.78 GBytes  3.25 Gbits/sec                  receiver</span><br><span class="line">[SUM]   0.00-10.05  sec  11.1 GBytes  9.45 Gbits/sec  1661             sender</span><br><span class="line">[SUM]   0.00-10.00  sec  11.1 GBytes  9.49 Gbits/sec                  receiver</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>(Ryzen 7 5700G、メモリDDR4-3200 DIMM (PC4-25600)32GByte)<br>このPCにはPCIe×16のスロットにConnect X-4を、PCIe x4のスロットにConnect X-3を挿しています。</p><p>少しリトライが多いようですが、9.49Gbpsです。<code>-R -P3</code>オプションとして逆方向の送信（ダウンロード）、多重度3のみ、それ以外のオプションは指定していません。Windows10時代でも多重度は4程度から9.3Gbpsをマークしていたと記憶しているので、まずまずでしょうか。Windows11側がダウンロード側ですのでUbuntu側の送信速度に少し追いついていないようです。これはドライバが最適化されていない可能性もあります。しかし、実運用として使うのであれば十分でしょう。</p><h3 id="Connect-X-4"><a href="#Connect-X-4" class="headerlink" title="Connect X-4"></a>Connect X-4</h3><p>Connect X-4はWindows11で自動導入されるドライバは2020年のものですが、新しいドライバをNvidiaからダウンロードできます。</p><img src="/new-technology/2023/03/25/Mellanox-ConnectXandWindows11/x4.png" class="" width="480" title="alt"><p>NVidiaではSoftwareのEthernetの分類でドライバを検索することになります。<br><a href="https://developer.nvidia.com/networking/ethernet-software">https://developer.nvidia.com/networking/ethernet-software</a></p><p>具体的には、以下のWinOF-2がWin10以降のドライバとなります。</p><blockquote><p>MLNX_OFED for Windows - WinOF &#x2F; WinOF-2<br> <a href="https://network.nvidia.com/products/adapter-software/ethernet/windows/winof-2/">https://network.nvidia.com/products/adapter-software/ethernet/windows/winof-2/</a></p></blockquote><p>Connect X-4は2023年2月2日に発表されたRevision3.20.50010が最新のようですが、実際のドライバは上記のキャプチャの通り、3.2.25がインストールされます。</p><p>セットアップはただインストーラの指示に従い、進めていくだけなので何も難しいものはありません。</p><img src="/new-technology/2023/03/25/Mellanox-ConnectXandWindows11/setup.png" class="" width="480" title="alt"><h2 id="Connect-X-4のスループット"><a href="#Connect-X-4のスループット" class="headerlink" title="Connect X-4のスループット"></a>Connect X-4のスループット</h2><p>PCのConnect X-4（SFP28スロット）にSFP＋モジュールを挿入し、対向もスイッチに挿します。</p><p>Connect X-3もConnect X-4も同じ10GbEとして使うなら変わらないように思えますが、ドライバの違いもさることながら能力は結構違います。<br>多重度1でUbuntuに対して実行した結果です。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">Connect X-4 flow control send</span><br><span class="line"></span><br><span class="line">[ ID] Interval           Transfer     Bitrate</span><br><span class="line">[  5]   0.00-1.00   sec  1.11 GBytes  9.51 Gbits/sec</span><br><span class="line">[  5]   1.00-2.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   2.00-3.00   sec  1.10 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   3.00-4.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   4.00-5.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   5.00-6.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   6.00-7.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   7.00-8.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   8.00-9.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   9.00-10.00  sec  1.10 GBytes  9.49 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[ ID] Interval           Transfer     Bitrate</span><br><span class="line">[  5]   0.00-10.00  sec  11.1 GBytes  9.49 Gbits/sec                  sender</span><br><span class="line">[  5]   0.00-10.04  sec  11.0 GBytes  9.45 Gbits/sec                  receiver</span><br><span class="line"></span><br><span class="line">Connect X-4 flow control recv</span><br><span class="line"></span><br><span class="line">[ ID] Interval           Transfer     Bitrate</span><br><span class="line">[  5]   0.00-1.00   sec  1.11 GBytes  9.51 Gbits/sec</span><br><span class="line">[  5]   1.00-2.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   2.00-3.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   3.00-4.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   4.00-5.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   5.00-6.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   6.00-7.00   sec  1.10 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   7.00-8.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   8.00-9.00   sec  1.10 GBytes  9.48 Gbits/sec</span><br><span class="line">[  5]   9.00-10.00  sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[ ID] Interval           Transfer     Bitrate         Retr</span><br><span class="line">[  5]   0.00-10.05  sec  11.1 GBytes  9.45 Gbits/sec    0             sender</span><br><span class="line">[  5]   0.00-10.00  sec  11.1 GBytes  9.49 Gbits/sec                  receiver</span><br></pre></td></tr></table></figure><p>非常に安定していますね。Windowsのiperf3のシングルプロセスでRetryが0です。<br>ちなみにこれだけ安定しているならということでスイッチのフローコントロールを外してみます。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">Connect X-4 no flow control send</span><br><span class="line"></span><br><span class="line">[ ID] Interval           Transfer     Bitrate</span><br><span class="line">[  5]   0.00-1.00   sec  1.11 GBytes  9.52 Gbits/sec</span><br><span class="line">[  5]   1.00-2.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   2.00-3.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   3.00-4.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   4.00-5.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   5.00-6.00   sec  1.10 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   6.00-7.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   7.00-8.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   8.00-9.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   9.00-10.00  sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[ ID] Interval           Transfer     Bitrate</span><br><span class="line">[  5]   0.00-10.00  sec  11.1 GBytes  9.50 Gbits/sec                  sender</span><br><span class="line">[  5]   0.00-10.04  sec  11.1 GBytes  9.45 Gbits/sec                  receiver</span><br><span class="line"></span><br><span class="line">Connect X-4 no flow control recv</span><br><span class="line"></span><br><span class="line">[ ID] Interval           Transfer     Bitrate</span><br><span class="line">[  5]   0.00-1.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   1.00-2.00   sec  1.10 GBytes  9.47 Gbits/sec</span><br><span class="line">[  5]   2.00-3.00   sec  1.10 GBytes  9.47 Gbits/sec</span><br><span class="line">[  5]   3.00-4.00   sec  1.10 GBytes  9.47 Gbits/sec</span><br><span class="line">[  5]   4.00-5.00   sec  1.10 GBytes  9.47 Gbits/sec</span><br><span class="line">[  5]   5.00-6.00   sec  1.10 GBytes  9.47 Gbits/sec</span><br><span class="line">[  5]   6.00-7.00   sec  1.10 GBytes  9.47 Gbits/sec</span><br><span class="line">[  5]   7.00-8.00   sec  1.10 GBytes  9.47 Gbits/sec</span><br><span class="line">[  5]   8.00-9.00   sec  1.10 GBytes  9.47 Gbits/sec</span><br><span class="line">[  5]   9.00-10.00  sec  1.10 GBytes  9.45 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[ ID] Interval           Transfer     Bitrate         Retr</span><br><span class="line">[  5]   0.00-10.05  sec  11.0 GBytes  9.42 Gbits/sec    0             sender</span><br><span class="line">[  5]   0.00-10.00  sec  11.0 GBytes  9.47 Gbits/sec                  receiver</span><br></pre></td></tr></table></figure><p>フローコントロール無しでこれは良い結果です。もっとも、アプリケーション（iperf3）が再送を必要としていないだけであって、NIC同士がオフロードして送受信管理するのでOSまでその情報は見えていないと考えられます。昔はとても高価かつ使いこなすのが難しいNICでしたが、シンプルに使うだけであれば、容易にその高い性能がホームユーザーにも享受できるようになってきました。</p><h2 id="Connect-Xのファームウェア更新（Windows版）"><a href="#Connect-Xのファームウェア更新（Windows版）" class="headerlink" title="Connect Xのファームウェア更新（Windows版）"></a>Connect Xのファームウェア更新（Windows版）</h2><p>特にMellanoxのNICで脆弱性という話を聞いたことはなく、頻繁にパッチが出ないので本当に運用が楽ではありますが購入時にファームウェアを更新しておきましょう。「<a href="/2022/04/02/nic-firmware/" title="ESXiでネットワークカードのファームウェアを更新する">ESXiでネットワークカードのファームウェアを更新する</a>」ではネットに接続されていない前提としてパッチを個別にダウンロードしましたが、Windowsの場合はネットに接続されている事が前提でしょうから、もう少し手間は省けます（ESXiホスト自身はNTPなど限定されたサービスを除きインターネットアクセスしないのが一般的です）。</p><p>WindowsにおいてMellanoxカードのファームウェアの更新にはMFTとmlxupの2つのツールが必要です。<br>まずMFTのインストールになります。以下のURLからMFTをダウンロードします。</p><blockquote><p>NVIDIA Firmware Tools (MFT)<br> <a href="https://network.nvidia.com/products/adapter-software/firmware-tools/">https://network.nvidia.com/products/adapter-software/firmware-tools/</a></p></blockquote><p>2023-3-25時点では、2023-1-31リリースの4.23.0が最新のようです。<br>MFTもインストーラーで特に悩むこともなくセットアップを完了させます。OSを再起動するとMFTツールは自動起動されますが、再起動しなくともコマンドプロンプトから<code>mst server start</code>でサービスが起動します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\yoshi&gt;mst server start</span><br><span class="line"></span><br><span class="line">C:\Users\yoshi&gt;Waiting for connection on port 23108</span><br></pre></td></tr></table></figure><p>引き続き、管理者権限のコマンドプロンプトを開き、<code>mst status</code>を実行するとNICの情報が得られます。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">C:\Windows\System32&gt;mst status</span><br><span class="line">MST devices:</span><br><span class="line">------------</span><br><span class="line"></span><br><span class="line">  mt4117_pciconf0</span><br><span class="line"></span><br><span class="line">C:\Windows\System32&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>続いてmlxupのダウンロードです。これはexeファイルそのものなので、ブラウザからのダウンロード時に警告が出るかもしれません。</p><blockquote><p>mlxup - Update and Query Utility<br> <a href="https://network.nvidia.com/support/firmware/mlxup-mft/">https://network.nvidia.com/support/firmware/mlxup-mft/</a></p></blockquote><p>ダウンロードしたら、コマンドプロンプトにて<code>mlxup.exe --query</code>を実行します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mlxup --query</span><br><span class="line"></span><br><span class="line">Querying Mellanox devices firmware ...</span><br><span class="line"></span><br><span class="line">Device #1:</span><br><span class="line">----------</span><br><span class="line"></span><br><span class="line">  Device Type:      ConnectX4LX</span><br><span class="line">  Part Number:      MCX4121A-ACA_Ax</span><br><span class="line">  Description:      ConnectX-4 Lx EN network interface card; 25GbE dual-port SFP28; PCIe3.0 x8; ROHS R6</span><br><span class="line">  PSID:             MT_2420110034</span><br><span class="line">  PCI Device Name:  mt4117_pciconf0</span><br><span class="line">  Base MAC:         0c42a1000000</span><br><span class="line">  Versions:         Current        Available</span><br><span class="line">     FW             14.25.1020     14.32.1010</span><br><span class="line">     PXE            3.5.0701       3.6.0502</span><br><span class="line">     UEFI           14.18.0019     14.25.0017</span><br><span class="line"></span><br><span class="line">  Status:           Update required</span><br></pre></td></tr></table></figure><p>するとこのようにファームウェアの情報とアップデート可能か否かの情報が得られます。<br>実際のファームウェアの更新は<code>mlxup --online</code>です。これで適切なファームウェアがダウンロードされ適用されます。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\yoshi\Downloads&gt;mlxup --online</span><br><span class="line">Querying Mellanox devices firmware ...</span><br><span class="line"></span><br><span class="line">Device #1:</span><br><span class="line">----------</span><br><span class="line"></span><br><span class="line">  Device Type:      ConnectX4LX</span><br><span class="line">  Part Number:      MCX4121A-ACA_Ax</span><br><span class="line">  Description:      ConnectX-4 Lx EN network interface card; 25GbE dual-port SFP28; PCIe3.0 x8; ROHS R6</span><br><span class="line">  PSID:             MT_2420110034</span><br><span class="line">  PCI Device Name:  mt4117_pciconf0</span><br><span class="line">  Base MAC:         0c42a1000000</span><br><span class="line">  Versions:         Current        Available</span><br><span class="line">     FW             14.25.1020     14.32.1010</span><br><span class="line">     PXE            3.5.0701       3.6.0502</span><br><span class="line">     UEFI           14.18.0019     14.25.0017</span><br><span class="line"></span><br><span class="line">  Status:           Update required</span><br><span class="line"></span><br><span class="line">Release notes for the available Firmware:</span><br><span class="line">-----------------------------------------</span><br><span class="line"></span><br><span class="line">  For more details, please refer to the following FW release notes:</span><br><span class="line">    1- ConnectX3 (2.42.5000):    http://www.mellanox.com/pdf/firmware/ConnectX3-FW-2_42_5000-release_notes.pdf</span><br><span class="line">    2- ConnectX3Pro (2.42.5000): http://www.mellanox.com/pdf/firmware/ConnectX3Pro-FW-2_42_5000-release_notes.pdf</span><br><span class="line">    3- Connect-IB (10.16.1200):  http://www.mellanox.com/pdf/firmware/ConnectIB-FW-10_16_1200-release_notes.pdf</span><br><span class="line">    4- ConnectX4 (12.28.2006):   http://docs.mellanox.com/display/ConnectX4Firmwarev12282006</span><br><span class="line">    5- ConnectX4Lx (14.32.1010): http://docs.mellanox.com/display/ConnectX4LxFirmwarev14321010</span><br><span class="line">    6- ConnectX5 (16.35.2000):   http://docs.mellanox.com/display/ConnectX5Firmwarev16352000</span><br><span class="line">    7- ConnectX6 (20.36.1010):   http://docs.mellanox.com/display/ConnectX6Firmwarev20361010</span><br><span class="line">    8- ConnectX6Dx (22.36.1010):   http://docs.mellanox.com/display/ConnectX6DxFirmwarev22361010</span><br><span class="line">    9- ConnectX6Lx (26.36.1010):   http://docs.mellanox.com/display/ConnectX6LxFirmwarev26361010</span><br><span class="line">    10- BlueField2 (24.35.2000):   http://docs.mellanox.com/display/BlueField2Firmwarev24352000</span><br><span class="line">    11- ConnectX7 (28.36.1010):   http://docs.mellanox.com/display/ConnectX7Firmwarev28361010</span><br><span class="line"></span><br><span class="line">---------</span><br><span class="line">Found 1 device(s) requiring firmware update...</span><br><span class="line"></span><br><span class="line">Perform FW update? [y/N]: y</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CMD: mlxup -u --log-on-update --ssl-certificate C:\Users\yoshi\AppData\Local\Temp\sfxter_yoshi_3512\mlxup-dir\ca-bundle.crt --current-dir C:\Users\yoshi\Downloads\  --online</span><br><span class="line">Querying Mellanox devices firmware ...</span><br><span class="line"></span><br><span class="line">Device #1:</span><br><span class="line">----------</span><br><span class="line"></span><br><span class="line">  Device Type:      ConnectX4LX</span><br><span class="line">  Part Number:      MCX4121A-ACA_Ax</span><br><span class="line">  Description:      ConnectX-4 Lx EN network interface card; 25GbE dual-port SFP28; PCIe3.0 x8; ROHS R6</span><br><span class="line">  PSID:             MT_2420110034</span><br><span class="line">  PCI Device Name:  mt4117_pciconf0</span><br><span class="line">  Base MAC:         0c42a1000000</span><br><span class="line">  Versions:         Current        Available</span><br><span class="line">     FW             14.25.1020     14.32.1010</span><br><span class="line">     PXE            3.5.0701       3.6.0502</span><br><span class="line">     UEFI           14.18.0019     14.25.0017</span><br><span class="line"></span><br><span class="line">  Status:           Update required</span><br><span class="line"></span><br><span class="line">Release notes for the available Firmware:</span><br><span class="line">-----------------------------------------</span><br><span class="line"></span><br><span class="line">  For more details, please refer to the following FW release notes:</span><br><span class="line">    1- ConnectX3 (2.42.5000):    http://www.mellanox.com/pdf/firmware/ConnectX3-FW-2_42_5000-release_notes.pdf</span><br><span class="line">    2- ConnectX3Pro (2.42.5000): http://www.mellanox.com/pdf/firmware/ConnectX3Pro-FW-2_42_5000-release_notes.pdf</span><br><span class="line">    3- Connect-IB (10.16.1200):  http://www.mellanox.com/pdf/firmware/ConnectIB-FW-10_16_1200-release_notes.pdf</span><br><span class="line">    4- ConnectX4 (12.28.2006):   http://docs.mellanox.com/display/ConnectX4Firmwarev12282006</span><br><span class="line">    5- ConnectX4Lx (14.32.1010): http://docs.mellanox.com/display/ConnectX4LxFirmwarev14321010</span><br><span class="line">    6- ConnectX5 (16.35.2000):   http://docs.mellanox.com/display/ConnectX5Firmwarev16352000</span><br><span class="line">    7- ConnectX6 (20.36.1010):   http://docs.mellanox.com/display/ConnectX6Firmwarev20361010</span><br><span class="line">    8- ConnectX6Dx (22.36.1010):   http://docs.mellanox.com/display/ConnectX6DxFirmwarev22361010</span><br><span class="line">    9- ConnectX6Lx (26.36.1010):   http://docs.mellanox.com/display/ConnectX6LxFirmwarev26361010</span><br><span class="line">    10- BlueField2 (24.35.2000):   http://docs.mellanox.com/display/BlueField2Firmwarev24352000</span><br><span class="line">    11- ConnectX7 (28.36.1010):   http://docs.mellanox.com/display/ConnectX7Firmwarev28361010</span><br><span class="line"></span><br><span class="line">---------</span><br><span class="line">Found 1 device(s) requiring firmware update...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Please wait while downloading MFA(s) ...</span><br><span class="line">Device #1: Updating FW ...</span><br><span class="line"></span><br><span class="line">FSMST_INITIALIZE -   OK</span><br><span class="line"></span><br><span class="line">Writing Boot image component -   0%</span><br><span class="line">Writing Boot image component -   1%</span><br><span class="line">Writing Boot image component -   2%</span><br><span class="line">(省略)</span><br><span class="line">Writing Boot image component - 100%</span><br><span class="line">Writing Boot image component -   OK</span><br><span class="line">Done</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Restart needed for updates to take effect.</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>最後にOSをリブートして完了です。ESXiよりはずいぶん簡単ですね。</p><p>個別のファームウェアを適用したい場合は、mlxupのダウンロードページにUser Manualのリンクがありますので参照してください。</p><h2 id="PCIe-x4スロット"><a href="#PCIe-x4スロット" class="headerlink" title="PCIe x4スロット"></a>PCIe x4スロット</h2><p>さて、エイプリールフールも近いのでネタを1つご紹介します。<br>今回紹介したMellanox Connect X-4の必要レーン数は、PCIe x8です。グラフィックカードをPCIe x16に挿していらっしゃる方は残りのPCIe x4のスロットしか使えず、最初からPCIe x8のネットワークカードは候補に上がらないと思います。</p><p>私のもう1台のPC（Ryzen5 5600G）のPCIe x4のスロットです（PCIe3 x4で動作）。物理的なスロットは長いですが、接続端子がx4の部分までしかありません（画像をクリックして拡大できます）。</p><img src="/new-technology/2023/03/25/Mellanox-ConnectXandWindows11/pci1.png" class="" width="1024" title="alt"><p>Connect X-4を挿すところです。どう見てもレーン数が不足しています。</p><img src="/new-technology/2023/03/25/Mellanox-ConnectXandWindows11/pci2.png" class="" width="1024" title="alt"><p>とりあえずはスロットにConnect X-4を差し込み、Windows11を起動すると無事にカードは認識されています。<strong>SFP28モジュール</strong>とOM3ケーブルとを使ってスイッチに繋いでみます。</p><img src="/new-technology/2023/03/25/Mellanox-ConnectXandWindows11/unifi1.png" class="" width="1024" title="alt"><p>（UbiquitiのSwitch Pro Aggregationスイッチは4つのSFP28ポートを持っています。見た目はSFP+と区別がつきませんが、右側の4PortがSFP28です）</p><p>iperf3のテストです。Windows11同士、それぞれがConnectx-4で片方がPCIe x4です。多重度は2です。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">iperf3 PCIe x4 Ryzen5(SFP28) &lt;- Ryzen7(SFP28)</span><br><span class="line"></span><br><span class="line">C:\Users\yoshi&gt;iperf3 -c 192.168.x.165 -R -P2</span><br><span class="line">Connecting to host 192.168.x.165, port 5201</span><br><span class="line">Reverse mode, remote host 192.168.x.165 is sending</span><br><span class="line">[  5] <span class="built_in">local</span> 192.168.x.112 port 49813 connected to 192.168.x.165 port 5201</span><br><span class="line">[  7] <span class="built_in">local</span> 192.168.x.112 port 49814 connected to 192.168.x.165 port 5201</span><br><span class="line">[ ID] Interval           Transfer     Bitrate</span><br><span class="line">[  5]   0.00-1.00   sec  1.37 GBytes  11.8 Gbits/sec</span><br><span class="line">[  7]   0.00-1.00   sec  1.35 GBytes  11.6 Gbits/sec</span><br><span class="line">[SUM]   0.00-1.00   sec  2.72 GBytes  23.3 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[  5]   1.00-2.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class="line">[  7]   1.00-2.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class="line">[SUM]   1.00-2.00   sec  2.76 GBytes  23.7 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[  5]   2.00-3.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class="line">[  7]   2.00-3.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class="line">[SUM]   2.00-3.00   sec  2.76 GBytes  23.7 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[  5]   3.00-4.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class="line">[  7]   3.00-4.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class="line">[SUM]   3.00-4.00   sec  2.76 GBytes  23.7 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[  5]   4.00-5.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class="line">[  7]   4.00-5.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class="line">[SUM]   4.00-5.00   sec  2.76 GBytes  23.7 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[  5]   5.00-6.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class="line">[  7]   5.00-6.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class="line">[SUM]   5.00-6.00   sec  2.76 GBytes  23.7 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[  5]   6.00-7.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class="line">[  7]   6.00-7.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class="line">[SUM]   6.00-7.00   sec  2.76 GBytes  23.7 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[  5]   7.00-8.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class="line">[  7]   7.00-8.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class="line">[SUM]   7.00-8.00   sec  2.76 GBytes  23.7 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[  5]   8.00-9.00   sec  1.35 GBytes  11.6 Gbits/sec</span><br><span class="line">[  7]   8.00-9.00   sec  1.39 GBytes  11.9 Gbits/sec</span><br><span class="line">[SUM]   8.00-9.00   sec  2.74 GBytes  23.5 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[  5]   9.00-10.00  sec  1.39 GBytes  11.9 Gbits/sec</span><br><span class="line">[  7]   9.00-10.00  sec  1.35 GBytes  11.6 Gbits/sec</span><br><span class="line">[SUM]   9.00-10.00  sec  2.73 GBytes  23.5 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[ ID] Interval           Transfer     Bitrate</span><br><span class="line">[  5]   0.00-10.00  sec  13.8 GBytes  11.8 Gbits/sec                  sender</span><br><span class="line">[  5]   0.00-10.00  sec  13.8 GBytes  11.8 Gbits/sec                  receiver</span><br><span class="line">[  7]   0.00-10.00  sec  13.8 GBytes  11.8 Gbits/sec                  sender</span><br><span class="line">[  7]   0.00-10.00  sec  13.8 GBytes  11.8 Gbits/sec                  receiver</span><br><span class="line">[SUM]   0.00-10.00  sec  27.5 GBytes  23.6 Gbits/sec                  sender</span><br><span class="line">[SUM]   0.00-10.00  sec  27.5 GBytes  23.6 Gbits/sec                  receiver</span><br><span class="line"></span><br><span class="line">iperf Done.</span><br></pre></td></tr></table></figure><p>中途半端な繋ぎ方ですが、25GbEワイヤレートの速度がしっかり出ています。25GbEの全二重通信の検証まではやっていませんが、そもそもPCIe x8で25GbEが2Portならば、PCIe x4で25GbEの1Portはいけるでしょうし、10GbEなら2Portともに大丈夫でしょう。</p><p>まるでギャンブルですが、エイプリールフールでした、、、ということではありません。Mellanox Connect X-4はこういった接続方法に対応しています。</p><img src="/new-technology/2023/03/25/Mellanox-ConnectXandWindows11/mellanox.png" class="" width="480" title="alt"><p>冒頭で紹介した製品スペックのPDFでは、赤枠で囲ったところに、オートネゴシエートとあります。理論上、PCIe3 x4では帯域が32Gbpsですから25Gbpsの通信は可能ということになります。</p><p>どうしても先入観があって、x4のスロットにx8のカードを挿そうと思いませんよね。</p><p>PCIeのレーン数はご利用のマザーボードによって様々な仕様がありますので事前のご確認をお勧めします。</p>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2023/03/25/Mellanox-ConnectXandWindows11/title.png&quot; class=&quot;&quot; width=&quot;1024&quot; title=&quot;alt&quot;&gt;
&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;

&lt;p&gt;この記事ではSFP+のネットワークカードである、Mellanox Connect XについてWindows11の対応状況やWindowsでのファームウェアアップデートなどを記します。&lt;/p&gt;</summary>
    
    
    
    <category term="Hardware" scheme="https://yoshi0808.github.io/new-technology/categories/Hardware/"/>
    
    <category term="Network" scheme="https://yoshi0808.github.io/new-technology/categories/Network/"/>
    
    
    <category term="SFP+" scheme="https://yoshi0808.github.io/new-technology/tags/SFP/"/>
    
    <category term="10GbE" scheme="https://yoshi0808.github.io/new-technology/tags/10GbE/"/>
    
    <category term="25GbE" scheme="https://yoshi0808.github.io/new-technology/tags/25GbE/"/>
    
  </entry>
  
  <entry>
    <title>Sophos Firewall v19.5 MR-1</title>
    <link href="https://yoshi0808.github.io/new-technology/2023/02/23/xg-v195mr1/"/>
    <id>https://yoshi0808.github.io/new-technology/2023/02/23/xg-v195mr1/</id>
    <published>2023-02-22T21:34:42.000Z</published>
    <updated>2023-02-23T06:48:44.000Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2023/02/23/xg-v195mr1/title.png" class="" title="alt"><h2 id="Sophos-Firewall-v19-5-MR1"><a href="#Sophos-Firewall-v19-5-MR1" class="headerlink" title="Sophos Firewall v19.5 MR1"></a>Sophos Firewall v19.5 MR1</h2><p>Sophos Firewall v19.5 MR1が2023年2月15日に発表されました。</p><span id="more"></span><h2 id="主なエンハンスの内容"><a href="#主なエンハンスの内容" class="headerlink" title="主なエンハンスの内容"></a>主なエンハンスの内容</h2><p>Home Editionとしてはバグフィックスのみで機能向上はなさそうです。新機能が無いのは少し寂しいですが、安定性はv19以降でかなり向上したと感じます。</p><p>v19.5 MR1の詳細な説明はRelease Notesを参照してください。</p><blockquote><p><a href="https://docs.sophos.com/releasenotes/index.html?productGroupID=nsg&amp;productID=xg&amp;versionID=19.5">https://docs.sophos.com/releasenotes/index.html?productGroupID=nsg&amp;productID=xg&amp;versionID=19.5</a></p></blockquote><h2 id="Sophos-Firewallのアップデート"><a href="#Sophos-Firewallのアップデート" class="headerlink" title="Sophos Firewallのアップデート"></a>Sophos Firewallのアップデート</h2><p>XGの管理画面にログイン後、左ペインメニューの<mark class="label primary">バックアップ＆ファームウェア</mark>の<mark class="label primary">ファームウェアの確認</mark>ではただちに全てのユーザーにアップデートの案内が来るわけでは無いので、アップデートにはMySophosにログインし、バージョンアップの差分モジュールをダウンロードします。</p><ol><li>Sophosのサイトの右上のプルダウンメニューから、<mark class="label primary">ライセンスとアカウント</mark>をクリックします。<blockquote><p><a href="https://www.sophos.com/ja-jp.aspx">https://www.sophos.com/ja-jp.aspx</a></p></blockquote></li><li>Sophos IDをお持ちでなければIDを作成します。</li><li>ログイン後、<mark class="label primary">Network Protection</mark>をクリックします。</li><li><mark class="label primary">ファームウェアの更新</mark>をクリックします。</li><li>「製品名&#x2F;OSを使った検索」で”ファイアーウォール”を選択し、その後現れるプルダウンは”ソフトウェア”を選択します。</li><li><mark class="label primary">選択可能なダウンロードを表示</mark>ボタンをクリックします。</li></ol><img src="/new-technology/2023/02/23/xg-v195mr1/mysophos.png" class="" width="800" title="alt"><ol><li>上記画面で”SW-19.5.1_MR-1.SFW-278.sig”というアップデータが表示されますのでダウンロードします。</li><li>MY Sophosはここで終了してXGの管理画面にログインし、左ペインメニューの<mark class="label primary">バックアップ＆ファームウェア</mark>の<mark class="label primary">ファームウェアのタブメニュー</mark>から以下の画面に赤丸で囲った矢印のアイコンをクリックし、ダウンロードしたモジュールをアップロードします。</li></ol><img src="/new-technology/2023/02/23/xg-v195mr1/verup.png" class="" width="800" title="alt"><p>アップロード＆再起動ボタンをクリックし、v19.5へのアップグレードを完了させます。</p><img src="/new-technology/2023/02/23/xg-v195mr1/upgrade.png" class="" width="800" title="alt"><div class="note info"><p>仮想環境（ESXi）上にFirewallをインストールされている方はアップグレードの前に、「<a href="/2020/10/11/esxi-backup/" title="VMware ESXiの仮想マシンをバックアップする">VMware ESXiの仮想マシンをバックアップする</a>」を参考に、バックアップを確保される事をお勧めします。</p></div>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2023/02/23/xg-v195mr1/title.png&quot; class=&quot;&quot; title=&quot;alt&quot;&gt;

&lt;h2 id=&quot;Sophos-Firewall-v19-5-MR1&quot;&gt;&lt;a href=&quot;#Sophos-Firewall-v19-5-MR1&quot; class=&quot;headerlink&quot; title=&quot;Sophos Firewall v19.5 MR1&quot;&gt;&lt;/a&gt;Sophos Firewall v19.5 MR1&lt;/h2&gt;&lt;p&gt;Sophos Firewall v19.5 MR1が2023年2月15日に発表されました。&lt;/p&gt;</summary>
    
    
    
    <category term="Security" scheme="https://yoshi0808.github.io/new-technology/categories/Security/"/>
    
    
    <category term="XG Firewall" scheme="https://yoshi0808.github.io/new-technology/tags/XG-Firewall/"/>
    
  </entry>
  
  <entry>
    <title>auひかり BL3000HM</title>
    <link href="https://yoshi0808.github.io/new-technology/2023/01/28/bl3000hm/"/>
    <id>https://yoshi0808.github.io/new-technology/2023/01/28/bl3000hm/</id>
    <published>2023-01-27T15:00:00.000Z</published>
    <updated>2023-02-23T07:12:09.000Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2023/01/28/bl3000hm/bl3000hm.png" class="" width="240" title="alt"><p class="onepoint">この記事で実現すること</p><p>auひかりの新しいホームゲートウェイ（HGW)に交換してみたのでレポートします。ONUと一体型となったモデルです。Wi-Fi6Eにも対応しています。私はauひかりのWi-Fiは契約していないため、Wi-Fi以外の基本性能・機能について紹介します。</p><span id="more"></span><h2 id="auひかりホームユーザー向け、HGW交換の案内"><a href="#auひかりホームユーザー向け、HGW交換の案内" class="headerlink" title="auひかりホームユーザー向け、HGW交換の案内"></a>auひかりホームユーザー向け、HGW交換の案内</h2><p>auひかりではこれまでもユーザーの希望によるホームゲートウェイの交換について、半導体不足により一時的に交換を停止していましたが、昨年末に再開するという案内がありました。</p><blockquote><p>2022&#x2F;12&#x2F;22 auひかり ホームゲートウェイ：お客さまのご要望による交換（希望交換）の再開について<br> <a href="https://www.au.com/information/notice_internet/service/20221220-01/">https://www.au.com/information/notice_internet/service/20221220-01/</a></p></blockquote><p>私はこれまでホーム5ギガユーザーとしてBL1000HW（HGW）と10G-PON（ONU）をレンタルで利用していましたが、ONU一体型のHGWになるということで多少のレイテンシと消費電力の改善期待があり早速交換のお願いをしました。交換には3,300円掛かるとの記載があります。電話回線が2回線ある場合はBL3000HMには交換できないようです。<br>インターネット回線によるスピードテストでも3ギガ程度は出ており全く不満はありませんが、5ギガと10ギガの差額が月額780円なので、10ギガの契約に併せて変更もしました。</p><h2 id="auひかりホーム10ギガ・5ギガについて"><a href="#auひかりホーム10ギガ・5ギガについて" class="headerlink" title="auひかりホーム10ギガ・5ギガについて"></a>auひかりホーム10ギガ・5ギガについて</h2><p>auひかりのホーム10ギガ・5ギガサービスは関東圏の一部エリアのみ提供となっています。IPv4&#x2F;IPv6デュアルスタックで複雑な設定が不要で高速インターネットが利用できます。<br>ホーム10ギガ・5ギガのサービス説明は以下を参照してください。</p><blockquote><p>auひかり ホーム10ギガ・5ギガ<br> <a href="https://www.au.com/internet/auhikari_10-5g/">https://www.au.com/internet/auhikari_10-5g/</a></p></blockquote><p>基本情報、マニュアルは以下を参照してください。</p><blockquote><p>auひかり ホームゲートウェイ Aterm BL3000HM<br> <a href="https://www.au.com/support/service/internet/guide/modem/bl3000hm/">https://www.au.com/support/service/internet/guide/modem/bl3000hm/</a></p></blockquote><h2 id="BL3000HM"><a href="#BL3000HM" class="headerlink" title="BL3000HM"></a>BL3000HM</h2><p>年末に申し込んで年明け早々にBL3000HM（BL3000：右側）が届きました。BL1000（左側）も大きかったですがBL3000はかなり大きいと感じます。交換は自分で行います。</p><img src="/new-technology/2023/01/28/bl3000hm/bl3000-1.png" class="" width="1024" title="alt"><p>横幅28cm程度もありますね。私の場合はクローゼットの中に収まるので大きさは特に気になりませんが、リビングに配置するとなると少し目立つサイズです。</p><p>BL3000には、上記写真にある通り、ひかり回線と接続するコネクタ付きのシングルモードファイバケーブル（約3m）が既に取り付けられています。説明書には約3mと書いてありますが、これ3mもあるかな。。。その他付属品として電源ケーブル（アース無し）とLANケーブル（1.5m）があります。</p><table><thead><tr><th>機種</th><th>消費電力</th><th>アース</th><th>LANケーブル</th></tr></thead><tbody><tr><td>BL3000HM</td><td>45W（最大）</td><td>無し</td><td>Cat6A STP</td></tr><tr><td>BL1000HW</td><td>34W(最大)</td><td>無し</td><td>Cat6A STP</td></tr><tr><td>10G-EPON</td><td>14.3W以下</td><td>無し</td><td>Cat6A STP</td></tr></tbody></table><p>最大消費電力だけで見るとBL1000とONUとを合計したものとBL3000と比較した場合は大して変わりません。BL1000、BL3000共にWi-Fi機能を持ちますから、Wi-Fiを使わない場合はそれなりに電力が抑えられているものと思います。付属のケーブルは前回も今回も変わらず、Cat6Aのシールドツイストペア（STP）です。STPを使う場合には正しいアースが云々というご意見もあるようですが、短いケーブルについて気にすることは無いということでしょう。LAN4というRJ45の口が10GbEですが、5G&#x2F;2.5G&#x2F;1G&#x2F;100Base-TXにも対応しています。</p><p>早速、BL3000のファイバケーブルを光回線に接続し直し、LANケーブルを10GbEポートに接続し、電源を入れてみます。</p><img src="/new-technology/2023/01/28/bl3000hm/wchecker.png" class="" width="360" title="alt"><p>普段のアイドル状態で16.35w、2.5Gbps程度のアップロード時で16.5Wです。やはりネットワーク機器なのでNATやフィルタ処理などを除いたルーティングは通信専用のチップ（ASIC）が対応するため通信量と電力とは殆ど関係ありません。</p><h2 id="回線速度"><a href="#回線速度" class="headerlink" title="回線速度"></a>回線速度</h2><p>さて、いつものSpeedtestです。HGWとスイッチとをRJ45で接続し、スイッチとMacBook-AirとをSFP+で接続して計測してみます。平日の夕方に計測しました。</p><p>HGWのLANに接続</p><img src="/new-technology/2023/01/28/bl3000hm/speedtest1.png" class="" width="360" title="alt"><p>Sophos Firewall（TLS／SSLインスペクション有り）を通した速度</p><img src="/new-technology/2023/01/28/bl3000hm/speedtest2.png" class="" width="360" title="alt"><p>HGWのLANに接続した場合は5Gbps以上の速度が出ています。一方、FirewallのTLS&#x2F;SSLインスペクションを通しても下りはさほど落ちていません。上りは流石にデータ漏洩の観点から厳しくチェックするのでこれくらいには落ちてしまうのは仕方がないところでしょうか。自宅内のFirewallを通してもレイテンシ（Ping）が3ミリ秒という表示になっており、かなりの低遅延のネットワークになっていると言えそうです。これまでは4ミリ秒でした。</p><p>朝方の計測はHGW直結で5Gbps〜6Gbps程度の速度です。</p><h2 id="ログ機能"><a href="#ログ機能" class="headerlink" title="ログ機能"></a>ログ機能</h2><p>今回のHGWは簡単なログ機能が付いています。HGWのデフォルトのLANのIPアドレスは<code>192.168.0.1/24</code>です。</p><img src="/new-technology/2023/01/28/bl3000hm/log.png" class="" width="800" title="alt"><h2 id="スイッチ部分"><a href="#スイッチ部分" class="headerlink" title="スイッチ部分"></a>スイッチ部分</h2><p>BL1000HWと同様、BL3000HMも10GbEが1Port、1GbEが3Portとなります。</p><img src="/new-technology/2023/01/28/bl3000hm/sw.png" class="" width="360" title="alt"><p>一般的に、スイッチ機能を持つ1Gのチップ（PHY）は4Port単位で組まれることが多いです。10GbEと1GbEと合わせて4Portというのは、実際に10GbEに対応した4PortのPHYに1GbEの3Portが接続されているのでは？と妄想してしまいます。</p><p>10Gポートと1Gポートとのスループットはどうでしょうか。10Gポートには、Mellanox Connect-X3(10G SFP+)を挿したUbuntu22をSFP+スイッチ経由で接続し、1GポートにはMacBook-AirにPlaggableのUSBアダプタを挿してiperf3を実行してみます。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">yoshi@ub22:~$ iperf3 -c 192.168.0.3</span><br><span class="line">Connecting to host 192.168.0.3, port 5201</span><br><span class="line">[  5] <span class="built_in">local</span> 192.168.0.4 port 48032 connected to 192.168.0.3 port 5201</span><br><span class="line">[ ID] Interval           Transfer     Bitrate         Retr  Cwnd</span><br><span class="line">[  5]   0.00-1.00   sec   115 MBytes   963 Mbits/sec    0   3.77 MBytes</span><br><span class="line">[  5]   1.00-2.00   sec   112 MBytes   944 Mbits/sec    0   3.77 MBytes</span><br><span class="line">[  5]   2.00-3.00   sec   112 MBytes   944 Mbits/sec    0   3.96 MBytes</span><br><span class="line">[  5]   3.00-4.00   sec   111 MBytes   933 Mbits/sec    0   3.96 MBytes</span><br><span class="line">[  5]   4.00-5.00   sec   112 MBytes   944 Mbits/sec    0   3.96 MBytes</span><br><span class="line">[  5]   5.00-6.00   sec   112 MBytes   944 Mbits/sec    0   3.96 MBytes</span><br><span class="line">[  5]   6.00-7.00   sec   112 MBytes   944 Mbits/sec    0   3.96 MBytes</span><br><span class="line">[  5]   7.00-8.00   sec   112 MBytes   944 Mbits/sec    0   3.96 MBytes</span><br><span class="line">[  5]   8.00-9.00   sec   111 MBytes   933 Mbits/sec    0   3.96 MBytes</span><br><span class="line">[  5]   9.00-10.00  sec   112 MBytes   944 Mbits/sec    0   3.96 MBytes</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[ ID] Interval           Transfer     Bitrate         Retr</span><br><span class="line">[  5]   0.00-10.00  sec  1.10 GBytes   944 Mbits/sec    0             sender</span><br><span class="line">[  5]   0.00-10.03  sec  1.10 GBytes   941 Mbits/sec                  receiver</span><br></pre></td></tr></table></figure><p>文句なしのパフォーマンスです。このタイミングでワットチェッカーを確認してみました。</p><img src="/new-technology/2023/01/28/bl3000hm/wchecker2.png" class="" width="360" title="alt"><p>10GbEに加え、1GbEのRJ45をBL3000HMに接続しているため、ベースの消費電力は16.787Wとなっています。10GbEのみと比べ、0.43W消費電力が増えています。<br>これにiperf3を実行したタイミングでは、16.84Wとなり、僅か0.07W弱の消費電力が上昇しています。非常に誠実な作りであると思われます。</p><p>10GのPHYは単体であったり、2Port、4Portと様々な種類がありますが、他の製品のHGWやWi-Fiルーターで1GbEが4Port、10GbEが1Portある製品を見た時には、それらを繋ぐのはどうやっているのかな？と気になります。ASICではなくCPU（ソフトウェア）で相互にパケットをやり取りしている製品もあるらしく、10GbEと1GbEの通信のパフォーマンスが出ないそうです。</p><h2 id="レイテンシとアプリケーション"><a href="#レイテンシとアプリケーション" class="headerlink" title="レイテンシとアプリケーション"></a>レイテンシとアプリケーション</h2><p>私は10Gbpsのトラフィックを必要としていませんが、こういった多段のセグメントを介するネットワーク構成(VLAN)&#x2F;仮想環境&#x2F;Firewall&#x2F;アンチウィルス&#x2F;アプリケーションFirewallを組み合わせているため、少しでもレイテンシが大きくなるのを防ぎたいという狙いがあります。こうやって全体を俯瞰して見ると、セキュリティのためとはいえ、レイテンシが大きくなるような事ばかりしているわけです。</p><p>私の使っているアンチウィルスソフトのBitDefenderはそれ単体でTLS&#x2F;SSLインスペクションを実行するため、なおさら遅くなります。</p><p>最近のファイル転送プロトコルであればファイルのやり取りに高度な並列処理を実施することでトータルのデータ転送量を稼ぎますが、アプリケーションによっては単一のTCPセッションによるやり取りとなります。そのようなアプリケーションはいくら回線が太くても、到底大きな転送量はこなせません。数10Mbps程度の速度でもレイテンシが大きく関係するようになります。</p><p>高速回線と聞けば、ストリーミングビデオを思いつく方が多いでしょうか。4Kの映画や音楽配信サービスなどは負担が大きそうに思えるかもしれません。しかしこのようなサービスはデータの先読みができて、いくらでもバッファに積めます。1秒後どころか1分後に再生すべきであろうデータは全て読み込んでおけるので回線が多少不安定でも並列度を高めてデータ受信することで全く問題ありません。<br>しかし、電話であればそうはいきません。データの安定度を高めるために0.2秒程度のバッファは持ちますが、それ以上のバッファを持ち、遅延させると電話による会話が噛み合わなくなります。現代のリモートワークでも同時に発言してお互い譲り合うというのは見慣れた光景かもしれません。ホームユーザーであれば、リモートワークはもちろん、オンライン授業・コミュニティや友人・家族・親戚とのビデオ通話などが該当するでしょう。こういったビデオ通話ではデータの先読みが殆ど出来ないため、ネットワークの品質とレイテンシが大きく影響します。</p><p>私はオンラインゲームはしませんが、これもビデオ会議と同様でしょう。TCP通信では遅すぎるのでUDP通信でアプリケーション固有のプロトコルでやりとりすることになるでしょうか。私は自宅の環境でパケットロスを認識できるほどの経験はありませんが、回線の太さ以前に、パケット損失が大きく出てしまうプロバイダや回線業者もあるようです。私が10ギガネットワークを使いたいというのは光回線で、通信業者自体が持つバックボーンに（レイテンシが極めて小さい）大型ネットワーク機器が収容されていることを期待しています。さらに言えば、Apple、Googleなどの主要IT、CloudflareやAkamaiなどのCDN（コンテンツ・デリバリ・ネットワーク）、AWSやAzureなどのクラウドサービスにネットワーク的に近い環境が好ましいとも言えます。</p><p>私が利用しているSophos Firewallではレポート機能でビデオ会議のトラフィックを確認できます。</p><img src="/new-technology/2023/01/28/bl3000hm/sophos.png" class="" width="1024" title="alt"><mark class="label primary">Conferencing</mark> でフィルタすると、Teams会議、Zoom会議がクラウドアプリケーションとして判定され、サーバーIPアドレスも列挙されます。<p>実例として、Microsoft365のTeamsのサーバーにpingでレイテンシを計測してみます。</p><img src="/new-technology/2023/01/28/bl3000hm/ping.png" class="" width="1024" title="alt"><p>10分程度、pingの往復レイテンシを計測しています。平均4.6msであり、非常に低レイテンシでスパイクもせいぜい20ms以下ですから安定していると言えます。サーバーIPアドレスをGeo Locationで見ると場所は米国のマイクロソフト社になりますが、レイテンシから鑑みると関東近辺のデータセンターになると思われます。私の感覚的なものですが、米国の西海岸までは純粋なネットワークだけで往復100msのレイテンシ、東海岸までは往復150ms程度はあるはずです。実際のサーバーとの往復だと数百msにはなるようです。</p><p>なお、PCをWi-Fi6接続に変更すると、6.8msとなり、2.2ms遅延が追加されます。</p><h2 id="auひかりのホーム5ギガ、ホーム10ギガの違い"><a href="#auひかりのホーム5ギガ、ホーム10ギガの違い" class="headerlink" title="auひかりのホーム5ギガ、ホーム10ギガの違い"></a>auひかりのホーム5ギガ、ホーム10ギガの違い</h2><p>今回、HGWの交換によって若干のレイテンシ改善は確認できましたが、スループットとして大きく変わるような結果はありません。恐らく地域によって結果は大きく異なると思われます。なお、auひかりの場合は増速の際には事前の調査が必要なようで、混雑している地域だと10ギガへの変更が行えないとの事。ここ2、3年で1ギガを超える光回線の提供も随分浸透してきたと思われるので、時間帯によって帯域制限が加わっているような感覚をお持ちの方は一度確認されてはいかがでしょうか。</p><h2 id="契約変更"><a href="#契約変更" class="headerlink" title="契約変更"></a>契約変更</h2><p>機器交換には3,300円必要とauのホームページには記載がありましたが、以下の案内が事後に郵送されてきました。3,300円の交換に加えて2,000円の交換手数料が掛かるがそれは無料ということなのか、そもそも3,300円ではなく2,000円になるのか、或いは都合良く解釈すれば機器交換は無料なのか。。。また、プロバイダがau one netで10ギガに増速した場合、12ヶ月の間、780円（税込858円）を割り引くとの事です。こちらも次月の請求がわかったところでアップデートしたいと思いますが、そもそもの最初の契約の仕方によって人それぞれで割引プランが異なるのかもしれませんね。<br>（私はプロバイダはau one netでどこのアフェリエイトも通さず、直接auひかりに申し込みしています）</p><img src="/new-technology/2023/01/28/bl3000hm/au.png" class="" width="1024" title="alt"><p>(2023-2-23更新）<br>1月の請求を確認しました。キャンペーンの月額割引は日割りもあり、ピッタリ一致していませんが、計算上は780円の割引になっていました。また、機器交換の請求は現時点でありませんでした。</p><h2 id="補足"><a href="#補足" class="headerlink" title="補足"></a>補足</h2><p>新しいHGWを接続してから、しばらくしてIPv6アドレスが割り当てられていない事に気づきました。結局は翌日の昼頃に特にHGWを再起動したわけでもないですが、IPv6が割り当てられていました。環境変更後、少し時間が掛かるようです。</p>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2023/01/28/bl3000hm/bl3000hm.png&quot; class=&quot;&quot; width=&quot;240&quot; title=&quot;alt&quot;&gt;
&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;

&lt;p&gt;auひかりの新しいホームゲートウェイ（HGW)に交換してみたのでレポートします。ONUと一体型となったモデルです。Wi-Fi6Eにも対応しています。私はauひかりのWi-Fiは契約していないため、Wi-Fi以外の基本性能・機能について紹介します。&lt;/p&gt;</summary>
    
    
    
    <category term="Hardware" scheme="https://yoshi0808.github.io/new-technology/categories/Hardware/"/>
    
    <category term="Network" scheme="https://yoshi0808.github.io/new-technology/categories/Network/"/>
    
    
    <category term="10GbE" scheme="https://yoshi0808.github.io/new-technology/tags/10GbE/"/>
    
  </entry>
  
  <entry>
    <title>UniFi Wi-Fiシステム</title>
    <link href="https://yoshi0808.github.io/new-technology/2022/12/31/unifi-ap/"/>
    <id>https://yoshi0808.github.io/new-technology/2022/12/31/unifi-ap/</id>
    <published>2022-12-30T15:00:01.000Z</published>
    <updated>2023-06-17T23:26:14.393Z</updated>
    
    <content type="html"><![CDATA[<p class="onepoint">この記事で実現すること</p><p>この記事ではホームユーザー向けにUniFi AP(Wi-Fiアクセスポイント）の設定ができるようになることを目的としています。</p><span id="more"></span><h2 id="最近のWi-Fi事情"><a href="#最近のWi-Fi事情" class="headerlink" title="最近のWi-Fi事情"></a>最近のWi-Fi事情</h2><p>2022年9月にWi-Fiで6GHzも利用できるよう法律が変更されました（Wi-Fi6E）。国内のメーカーはこの6GHzとメッシュを謳い文句にWi-Fiルータの販売強化を図っているようです。しかしながら、端末側は今年に発売するiPhoneで6Eの対応が見送られた事であまり盛り上がってはいないようです。</p><p>Wi-Fiの難しいところはその住居の形や家の周りの電波状態に大きく左右されてしまう点で、これがベストという構成を見出せません。私の例で言えば、凡庸な建売の木造2階建であり、無線APが1つだけでも、それなりに無難にWi-Fiが使えるという環境です。</p><p>最近販売され始めた無線ルーターは、メッシュ対応のものが多く出てきました。メッシュは複数台のAPと無線でデータをやり取りできる機能です。無線の中継機は常に親機に集約されていましたが、メッシュは複数台のAPと相互に接続します。一般的には中継専用のSSIDを用いお互いにデータを中継します。</p><p>最近のメッシュWi-Fiルーターでは高速ローミング（802.11k、802.11r、802.11v）に対応している製品も出てきており、端末を持ちながら移動した場合に、アクセスポイント（AP）間を高速ローミングすることで切断時間を短くし、近くのAPに接続できます。また、それぞれのAPがメッシュ（無線）ではなく、有線接続して互いの情報を交換できる<strong>イーサネットバックホール（有線バックホール）</strong>という機能に対応している製品を複数の部屋に設置することでずいぶん快適になるでしょう。</p><p>なお、6EはDFSの影響を受けないチャンネルなので、自宅の間取りで6GHzが効率よく使える環境下であれば利便性は増します。私は6GHzの無線APは保有していないので、どのくらい電波が届くものなのかは今後機会があれば評価してみたいと考えています。周波数が上がるにつれて障害物によって遠くに届きづらくなるとは考えられます。各部屋に有線がなく、イーサネットバックホールが使えないケースでは、AP同士を6Eの独立チャンネルで接続する事で中継機能が改善することが期待されます（これまでは親機と中継機が同一のチャンネルを使うことで効率が大幅に落ちるケースがありました）。</p><p>また、端末側の6E対応状況が進捗するまではしばらくはWi-Fi6（5GHz）のままというのが現状でしょうか。</p><h2 id="UniFi-APのスペック"><a href="#UniFi-APのスペック" class="headerlink" title="UniFi APのスペック"></a>UniFi APのスペック</h2><p>日本国内で販売されているUniFi APはルーター機能を持たず、アクセスポイントに特化したハードウェアです。UniFiネットワークアプリケーションまたはUniFiコンソールを介して情報連携が行われます。</p><table><thead><tr><th>機種</th><th>U6 Pro</th><th>U6 Lite</th></tr></thead><tbody><tr><td>有線</td><td>GbE RJ45ポート x1</td><td>GbE RJ45ポート x1</td></tr><tr><td>給電方法</td><td>PoE</td><td>PoE</td></tr><tr><td>最大消費電力</td><td>13W</td><td>13.5W</td></tr><tr><td>最大送信パワー2.4GHz</td><td>22dBm</td><td>23dBm</td></tr><tr><td>最大送信パワー5GHz</td><td>23dBm※</td><td>23dBm</td></tr><tr><td>MIMO 2.4GHz</td><td>2x2</td><td>2x2</td></tr><tr><td>MIMO 5GHz</td><td>4x4</td><td>2x2</td></tr></tbody></table><p>※U6 Proのスペック上は26dBmが上限ですが、日本国内で利用する場合は上限が23dBmとなります。</p><p>Wi-FiのスペックとしてはU6 Proで日本国内のやや高性能モデルに相当するでしょうか。アンテナ数を見ても、国内のWi-Fi機器と比較して特段優れている項目はありません。U6 Liteも一般的なスペックです。</p><p>上記以外にも、11axに対応した中継機である、U6 Extender、メッシュ接続を前提とした、U6 Meshアクセスポイントなどが販売されています。商品の詳細は日本のオンラインストアを参照してください。</p><blockquote><p>Ubiquiti オンラインストア<br> <a href="https://jp.store.ui.com/collections/unifi-network-wireless">https://jp.store.ui.com/collections/unifi-network-wireless</a></p></blockquote><h2 id="UniFi-APの実速度"><a href="#UniFi-APの実速度" class="headerlink" title="UniFi APの実速度"></a>UniFi APの実速度</h2><p>iPhone11を使ってAPに1mの距離まで近づけて、iperf3を実行した時の結果は以下の通りです。</p><blockquote><p>U6 Pro<br> <img src="/new-technology/2022/12/31/unifi-ap/u6-pro3.png" class="" width="360" title="alt"></p></blockquote><blockquote><p>U6 Lite<br> <img src="/new-technology/2022/12/31/unifi-ap/u6-lite3.png" class="" width="360" title="alt"></p></blockquote><p>参考までに、Aterm WX6000HPの場合は以下です。</p><blockquote><img src="/new-technology/2022/12/31/unifi-ap/aterm.png" class="" width="360" title="alt"></blockquote><p>U6 Proの個性として、iperf3の起動直後は少しスロースタートに見えます。省電力の最適化に重きを置いているのでしょうか。</p><p>また、私の自宅の1階において、macOSのWi-Fi Explorerで電波の強さを計測してみました。1階にはU6 ProとAterm、2階にはU6 Liteが配置されています。</p><img src="/new-technology/2022/12/31/unifi-ap/wifi-explorer.png" class="" width="1024" title="alt"><p>電波の強さだけであればAtermのWX6000HPが素晴らしい結果を出しています。しかしiperf3の最高速度という観点についてはU6 Proの方が良いスコアです。</p><p>pingのレイテンシも見てみましょう。iPhoneからNASへのping応答速度です。iOSやmacOSはpingのレイテンシ数値が高く出てしまう傾向にあります。実は上記のiperf3を含めてL3スイッチ経由でルーティングしてNASのiperf3サーバーに接続しており、1ホップあります。</p><ul><li><p>Aterm pingレイテンシ</p> <img src="/new-technology/2022/12/31/unifi-ap/aterm4.png" class="" width="360" title="alt"></li><li><p>U6 Pro pingレイテンシ</p> <img src="/new-technology/2022/12/31/unifi-ap/u6-pro4.png" class="" width="360" title="alt"></li></ul><blockquote><p>PingPlotterによる計測<br> <a href="https://www.pingman.com/">https://www.pingman.com</a></p></blockquote><p>U6 Proの方が電波の出力は低いものの、レイテンシは15msあたりで上限が整っています。一方、Atermは時々、20msを超えるスパイクが発生しています。U6 Proの速度が出る理由はレイテンシが低い事と想定されます。スマホやノートPCの一般的な操作では100Mbpsを超えたあたりから殆どその差については分からなくなってきますが、リモートワークのビデオ会議の安定性を考えるとレイテンシは意識したいところです。</p><p>UniFi APはWi-Fi設定が非常に詳細まで行えることがメリットであり、電波が届かないなどの対策としての購入用途には向いていません。</p><h2 id="UniFi-APの設置"><a href="#UniFi-APの設置" class="headerlink" title="UniFi APの設置"></a>UniFi APの設置</h2><p>具体的にAPのセットアップの前に一度日本語ガイドのページをご覧になることをお勧めします。<br>これは最近拡充されてきたリソースですが、本来は私がブログで書きたかった、メーカーに依存しない無線LANに必要な知見が整理されており、とても貴重な内容となっています。</p><blockquote><p>UniFi Network - ワイヤレスクライアントの接続性を最適化する<br> <a href="https://help.jp.ui.com/articles/221029967/">https://help.jp.ui.com/articles/221029967/</a></p></blockquote><blockquote><p>UniFi Network - ワイヤレスネットワーク速度の最適化<br> <a href="https://help.jp.ui.com/articles/360012947634/">https://help.jp.ui.com/articles/360012947634/</a></p></blockquote><blockquote><p>UniFi Network - 最適なワイヤレスメッシュネットワークにするための検討事項<br> <a href="https://help.jp.ui.com/articles/115002262328/">https://help.jp.ui.com/articles/115002262328/</a></p></blockquote><p>私もどこかで自分なりの考えをまとめて記事にしたいとは考えています。</p><p>さて、APの設置についてです。</p><p>電源を取るのはPoEアダプタまたはPoEスイッチからというのが独特です。これによってLANケーブルのみでデータ送受信と送電が行え、美観を損ねる事なく、壁の上部にAPを配置し、障害物を避けた効率の良い電波の発信が行えます。Wi-Fiはハードウェアスペックも関係ありますが、こういった物理的な配置も重要です。有線バックホールを使わずにPoEの電力だけを使い、メッシュにすることもできます。この場合、UniFi APは有線接続されている他のUniFi APにメッシュで接続してくれます。</p><p>有線バックホールの一例です。</p><p>（U6 Liteを2階に設置）</p><img src="/new-technology/2022/12/31/unifi-ap/u6-lite.png" class="" width="640" title="alt"><p>コアスイッチから2階のこの部屋までは光で通し、SFP+スイッチ（usw-Aggregation)から1GbEでAPに接続しています。このスイッチにはPoE機能はないため、別途PoEアダプタを使ってAPに給電しています。</p><img src="/new-technology/2022/12/31/unifi-ap/poe.png" class="" width="640" title="alt"><p>PoEアダプタを電源に繋ぎ、LANをusw-AggregationにRJ45で接続し、POEをU6 LiteにRJ45で接続します。</p><p>（私の環境の場合）電波の弱い階段のエリアにまで電波を届かせるために出来るだけ障害物を避けるAPの配置の工夫をしました。階を移動した時にスムーズなローミングができ、ビデオ会議で相手の声がなるべく途切れない事を目的としています。</p><img src="/new-technology/2022/12/31/unifi-ap/u6-lite2.png" class="" width="640" title="alt"><p>2階の各部屋に電波を届けつつ、立体的に見て、壁と2階の床を抜ける箇所を想定し、試行錯誤しながら配置を決めていきます。</p><h2 id="UniFi-Wi-Fi設定"><a href="#UniFi-Wi-Fi設定" class="headerlink" title="UniFi Wi-Fi設定"></a>UniFi Wi-Fi設定</h2><p>ここでは、UniFiコンソールやUniFiネットワークアプリケーションが既にセットアップされている事を前提に説明します。<br>UniFiネットワークアプリケーションを最初からセットアップされる方は以下の記事を参照してください。</p><ul><li>「<a href="/2022/08/27/ubiquiti-unifi/" title="Ubiquiti UniFiの世界">Ubiquiti UniFiの世界</a>」</li><li>「<a href="/2022/09/23/ubuntu22-04lts/" title="Ubuntu22.04LTSをESXiにセットアップする">Ubuntu22.04LTSをESXiにセットアップする</a>」</li><li>「<a href="/2022/09/23/unifi-network-application/" title="UniFi Network Applicationのセットアップ">UniFi Network Applicationのセットアップ</a>」</li><li>「<a href="/2022/10/23/unifi-network-application2/" title="UniFi Network Applicationの運用">UniFi Network Applicationの運用</a>」</li></ul><p>ネットワークアプリケーションの<mark class="label primary">SETTINGS</mark>から<mark class="label primary">WiFi</mark>の画面を開くと以下の表示となります。</p><img src="/new-technology/2022/12/31/unifi-ap/wifi1.png" class="" width="640" title="alt"><p>画面上部のWiFiについては、既存のSSID一覧が表示されます。画面下部の<mark class="label primary">Global AP Settings</mark>では、複数台のAPに共通設定を指定します。</p><p>メインとなる5GHzの無線設定では、DFSのこともあり、一般的には80MHzを指定します。日本の製品ではアンテナ数で上り2、下り2として2x2という表現がされている事が多いでしょうか。スマホなど多くは80MHzになります。高性能なWiFiクライアントをお持ちの場合は160MHzも設定可能です（U6 Liteは80MHzが上限です）。</p><mark class="label primary">Transmit Power</mark>は環境に応じて、Auto、High、Medium、Low、Custom（固定数値指定）と設定できます。<p>有線バックホール無しでAPを設置する場合は、<mark class="label primary">Wireless Connectivity</mark>の<mark class="label primary">Wireless Meshing</mark>のチェックボックスをOnにします。私は普段は有線バックホールで運用していますが、U6 Proでは有線LANへ接続せずにメッシュ接続が行えました。</p><p>続いて、SSIDの設定です。</p><img src="/new-technology/2022/12/31/unifi-ap/wifi2.png" class="" width="800" title="alt"><p>SSIDの名前、パスワード、ネットワーク、そのSSIDにどのAPを参加させるかを決めます。ここでは個人向けのWi-Fiとして一般的なWPA2パーソナルまたはWPA3パーソナルを前提としています。</p><p>続いて、マニュアル設定でSSIDの詳細を設定していきます。</p><img src="/new-technology/2022/12/31/unifi-ap/wifi3.png" class="" width="480" title="alt"><img src="/new-technology/2022/12/31/unifi-ap/wifi4.png" class="" width="480" title="alt"><table><thead><tr><th>項目名</th><th>説明</th></tr></thead><tbody><tr><td>WiFi Band</td><td>2.4GHz&#x2F;5GHzを選択します。両方を有効にもできます。</td></tr><tr><td>WiFi Type</td><td>通常はStandardです。カフェのように外部にWiFiを解放する場合はGuest Hotspotを選択します。</td></tr><tr><td>Band Steering</td><td>バンドステアリング。Bandで2.4GHz、5GHzを指定した場合に設定でき、電波状態によって自動で切り替わります。</td></tr><tr><td>Bandwidth Profile</td><td>帯域制限を指定します。</td></tr><tr><td>Multicast Management</td><td>通常必要ありませんので説明は割愛します。</td></tr><tr><td>Client Device Isolation</td><td>クライアントをお互いに接続できないようにします。Guest扱い。</td></tr><tr><td>Proxy ARP</td><td>混雑している環境ではWiFiデバイスの代わりにAPが代理応答します。</td></tr><tr><td>BSS Transition</td><td>AP同士でクライアントの状況を共有します。デフォルト有効。</td></tr><tr><td>UAPSD</td><td>省電力に関するパラメータです。古いデバイスでは問題が出る場合があります。</td></tr><tr><td>Fast Roaming</td><td>Fast Roamingに対応している端末であれば有効にすべきです。逆に言えば、Fast Roamingに対応した端末専用のSSIDにすべきです。</td></tr><tr><td>802.11 DTIM Period</td><td>デフォルト有効。Autoを推奨。説明は割愛します。</td></tr><tr><td>Minimum Data Rate Control</td><td>デフォルト有効。最低通信量を定め、それを下回る場合クライアントにAP切り替えを促すはずですが、私の環境ではあまり有効に機能しません。</td></tr><tr><td>Security Protocol</td><td>WPA2、WPA3の指定をします。WPA Enterpriseを指定することでRADIUS認証（ユーザー認証）が可能です。子供が友達にWi-Fiパスワード共有することに対策したいというこだわりのある方などチャレンジされてはいかがでしょうか。SynologyのNASなどでRADIUSサーバを稼働させられます</td></tr><tr><td>PMF</td><td>保護された管理フレーム。WPA3では必須。WPA2では任意にすることも可能。必須にすると古い端末は繋がらない可能性があリます。</td></tr><tr><td>Group Rekey Interval</td><td>暗号化キーの交換を定期的に行います。デフォルトは3600秒（＝1時間）です。</td></tr><tr><td>Hide WiFi Name</td><td>使うメリットはありません。説明は割愛します。</td></tr><tr><td>MAC Address Filter</td><td>MACアドレスのホワイトリスト、ブラックリストを指定します。</td></tr><tr><td>RADIUS MAC Authentication</td><td>説明は割愛します。</td></tr></tbody></table><p>WiFi Schedulerは夜間など使わない時の時間を設定できます。私は夜間は弱い2.4GHzのみ利用し、日中使っている5GHzは止めています。</p><h2 id="AP単位の設定"><a href="#AP単位の設定" class="headerlink" title="AP単位の設定"></a>AP単位の設定</h2><p>UniFiのDevice画面の<mark class="label primary">Settings</mark>から、AP本体の設定を変更します。主にはIPアドレス、無線のチャンネルを指定します。</p><img src="/new-technology/2022/12/31/unifi-ap/u6-pro5-1.png" class="" width="360" title="alt"><p>５GHzについては、APを2つ設置するならば、メインはDFSを受けないチャンネル、サブは別のチャンネルにするとお互い競合せずに安定した電波の受信ができます。2.4GHzはChannel幅は20MHzとし、1、6、11という具合に５づつスライドさせてAP毎に電波が重ならないように設定します。AP毎に電波の出力も変更できますし、きめ細かい設定が行えるのもUniFi APの特徴です。</p><h3 id="VLAN"><a href="#VLAN" class="headerlink" title="VLAN"></a>VLAN</h3><img src="/new-technology/2022/12/31/unifi-ap/u6-pro5-2.png" class="" width="360" title="alt"><p>このAP自体が属するマネジメント用のVLANを指定します。Wi-Fi設定ではSSID毎にVLANを設定できるので、APに接続するスイッチは、マネジメントVLANを含む全てのVLAN IDを含めるようにトランクポートとして設定する必要があります。</p><p>VLANを使った設定の一例です。</p><p>デバイスの管理をデフォルトVLAN（かつネイティブVLAN）、一般端末をVLAN100、会社用・ゲストをVLAN500とした、よくある一般的なシナリオです。</p><img src="/new-technology/2022/12/31/unifi-ap/network.drawio.png" class="" width="1024" title="alt"><p>UniFIでは複数VLANのペアを作って、そのうちの１つをネイティブVLANとして指定します。この例ではマネジメントVLANをDefault（VLAN ID＝1）、かつ、ネイティブVLAN（タグ無し）としています。会社のPCやゲスト用端末はClient Device IsolationをEnableにして互いの機器の通信を拒否します。スイッチ間のトランクポートは必ず通信するVLAN IDのタグを含めてあげる必要があります。</p><h2 id="APのファームウェア"><a href="#APのファームウェア" class="headerlink" title="APのファームウェア"></a>APのファームウェア</h2><p>UniFi APの最新のOfficialのファームウェアは、ローミングの切り替わりが安定しないように見えますが、現在リリース候補となっている、6.5.40は遅延の少ないローミングが成功しているように見えます。また、Wi-Fi6Eに対応したU6 Enterpriseもいよいよ発売されるようです。</p><h2 id="通知機能"><a href="#通知機能" class="headerlink" title="通知機能"></a>通知機能</h2><p>通知はUniFiコンソールまたはUniFiネットワークアプリケーションの機能ですが、APに関して通知機能は以下の通りです。</p><img src="/new-technology/2022/12/31/unifi-ap/wifi5.png" class="" width="800" title="alt"><p>DFSを受信した時にアラートが受けられるのと、自宅付近に同じSSIDを持つAPを発見した場合通知してくれます。特に後者はセキュリティ上有用です。これは試験的にUniFi以外のAPを同じSSIDで起動して検知させています。</p><img src="/new-technology/2022/12/31/unifi-ap/wifi6.png" class="" width="360" title="alt"><p>通知はメールとスマホアプリと2種類あり、選択できます。<mark class="label primary">Hotspot Client Connection Change</mark>は、端末の接続&#x2F;切断を検知したり、ローミングの切り替わり状況を通知してくれます。家族の自宅への出入りも把握できます。ただし、通知数が多くなるので、メール通知は避け、アプリ通知にした方が良さそうです。本来の趣旨は知らないMACアドレスからの接続があった時に検知するものです。</p><p>これらの機能はハイブリッドクラウド機能を持つUniFi製品の特徴ですが、これらが無償で利用できるというのは本当にありがたい存在です。</p><h2 id="リソース"><a href="#リソース" class="headerlink" title="リソース"></a>リソース</h2><p>以下の日本語ヘルプ、コミュニティがUniFiの構築には大いに参考になります。</p><blockquote><p>Ubiquiti コミュニティ（日本）<br> <a href="https://www.facebook.com/groups/uijapan">https://www.facebook.com/groups/uijapan</a></p></blockquote><blockquote><p>UI 日本語ヘルプ記事<br> <a href="https://help.jp.ui.com/categories/6583256751383/">https://help.jp.ui.com/categories/6583256751383/</a></p></blockquote><blockquote><p>Ubiquiti Community（米国中心）<br> <a href="https://community.ui.com/">https://community.ui.com/</a></p></blockquote>]]></content>
    
    
    <summary type="html">&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;

&lt;p&gt;この記事ではホームユーザー向けにUniFi AP(Wi-Fiアクセスポイント）の設定ができるようになることを目的としています。&lt;/p&gt;</summary>
    
    
    
    <category term="Hardware" scheme="https://yoshi0808.github.io/new-technology/categories/Hardware/"/>
    
    <category term="Network" scheme="https://yoshi0808.github.io/new-technology/categories/Network/"/>
    
    
    <category term="UniFi" scheme="https://yoshi0808.github.io/new-technology/tags/UniFi/"/>
    
  </entry>
  
  <entry>
    <title>Sophos Firewall v19.5</title>
    <link href="https://yoshi0808.github.io/new-technology/2022/12/03/xg-v195/"/>
    <id>https://yoshi0808.github.io/new-technology/2022/12/03/xg-v195/</id>
    <published>2022-12-02T15:01:00.000Z</published>
    <updated>2022-12-11T10:16:39.000Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2022/12/03/xg-v195/title.png" class="" title="alt"><h2 id="Sophos-Firewall-v19-5"><a href="#Sophos-Firewall-v19-5" class="headerlink" title="Sophos Firewall v19.5"></a>Sophos Firewall v19.5</h2><p>Sophos Firewall v19.5が2022年11月16日に発表されました。</p><span id="more"></span><h2 id="主なエンハンスの内容"><a href="#主なエンハンスの内容" class="headerlink" title="主なエンハンスの内容"></a>主なエンハンスの内容</h2><ul><li>SD-WAN Load Balancingの強化</li><li>OSPFv3 (IPv6)の対応</li></ul><p>ホームユーザーにはあまり関係しない機能でしょうか。</p><p>v19.5の詳細な説明はSophos Communityを参照してください。</p><blockquote><p><a href="https://community.sophos.com/sophos-xg-firewall/b/blog/posts/sophos-firewall-v195-is-now-available">https://community.sophos.com/sophos-xg-firewall/b/blog/posts/sophos-firewall-v195-is-now-available</a></p></blockquote><h2 id="Sophos-Firewallのアップデート"><a href="#Sophos-Firewallのアップデート" class="headerlink" title="Sophos Firewallのアップデート"></a>Sophos Firewallのアップデート</h2><p>XGの管理画面にログイン後、左ペインメニューの<mark class="label primary">バックアップ＆ファームウェア</mark>の<mark class="label primary">ファームウェアの確認</mark>ではただちに全てのユーザーにアップデートの案内が来るわけでは無いので、アップデートにはMySophosにログインし、バージョンアップの差分モジュールをダウンロードします。</p><ol><li>Sophosのサイトの右上のプルダウンメニューから、<mark class="label primary">ライセンスとアカウント</mark>をクリックします。<blockquote><p><a href="https://www.sophos.com/ja-jp.aspx">https://www.sophos.com/ja-jp.aspx</a></p></blockquote></li><li>Sophos IDをお持ちでなければIDを作成します。</li><li>ログイン後、<mark class="label primary">Network Protection</mark>をクリックします。</li><li><mark class="label primary">ファームウェアの更新</mark>をクリックします。</li><li>「製品名&#x2F;OSを使った検索」で”ファイアーウォール”を選択し、その後現れるプルダウンは”ソフトウェア”を選択します。</li><li><mark class="label primary">選択可能なダウンロードを表示</mark>ボタンをクリックします。</li></ol><img src="/new-technology/2022/12/03/xg-v195/mysophos.png" class="" width="800" title="alt"><ol><li>上記画面で”SW-19.5.0_GA.SFW-197.sig”というアップデータが表示されますのでダウンロードします。</li><li>MY Sophosはここで終了してXGの管理画面にログインし、左ペインメニューの<mark class="label primary">バックアップ＆ファームウェア</mark>の<mark class="label primary">ファームウェアのタブメニュー</mark>から以下の画面に赤丸で囲った矢印のアイコンをクリックし、ダウンロードしたモジュールをアップロードします。</li></ol><p>アップロード＆再起動ボタンをクリックし、v19.5へのアップグレードを完了させます。</p><div class="note info"><p>仮想環境（ESXi）上にFirewallをインストールされている方はアップグレードの前に、「<a href="/2020/10/11/esxi-backup/" title="VMware ESXiの仮想マシンをバックアップする">VMware ESXiの仮想マシンをバックアップする</a>」を参考に、バックアップを確保される事をお勧めします。</p></div><p>Relase Notesを見るとセキュリティ観点ではOpenSSL (CVE-2022-1292)の脆弱性対応が行われています。他にもかなりの数の不具合が修正されていますが、コメントがサラッとしており、どういう事象なのかまでは判明しないものが多いようです。</p><p>IPSec-VPN、SSL&#x2F;TLSインスペクション、マルウェアチェック（EICAR Testファイル）などを検証し、2週間程度運用していますが、スループット含めて特段の問題は見つかっていません。</p><p>（2022-12-11追記）<br>SophosからSophos Firewallのv19以前の脆弱性について12-06にレポートが公開されています。<br>以下の脆弱性に対応したものであり、v19以前のユーザーはv19.5にアップグレードが必要との事です。<br>CVE-2022-3236<br>CVE-2022-3226<br>CVE-2022-3713<br>CVE-2022-3696<br>CVE-2022-3709<br>CVE-2022-3711<br>CVE-2022-3710</p><blockquote><p>Sophos Firewall v19.5 GA Resolves Security Vulnerabilities<br> <a href="https://www.sophos.com/en-us/security-advisories/sophos-sa-20221201-sfos-19-5-0">https://www.sophos.com/en-us/security-advisories/sophos-sa-20221201-sfos-19-5-0</a></p></blockquote><p>大幅に機能が更新されていないにも関わらず、v19からv19.5となり、リリースノートでの表現も控え目で何が変わったのか良くわかりませんでしたが結局のところ脆弱性の対応が中心ということですね。</p><p>私は「<a href="/2020/06/24/protect-xg/" title="XG Firewall自身を防御する">XG Firewall自身を防御する</a>」の記事で、そもそもFirewall自身を守るためのセキュアな設定が必要と記載しており、パッチやバージョンアップを速やかに実施することも必要ですが、セキュアな環境のために追加の設定をお勧めしています。</p><p>過去からの経緯を見ていると、v18で大きくアーキテクチャが変更になったものの、管理画面を中心とした機能は大きな変更が行われていません。過去からの脆弱性、特にUI周りのクロスサイトスクリプティング、およびDBアクセス機能におけるSQLインジェクションのサニタイズが不十分であり、指摘されては都度修正しているという活動を繰り返しているように見えます。<br>ユーザー側の自主的な防御として、余計な機能はインターネット向けには提供しない事をお勧めします。つまりSophos Firewallの管理画面や入力項目を持つユーザーポータルはLANからのアクセスのみに限定すべきで、WAN、DMZはもちろん、可能であればVPNからもアクセス不可にしておく事をお勧めします。今回のエンハンスでSQLインジェクションなどが全て撲滅されたかどうかは不明です。</p><img src="/new-technology/2022/12/03/xg-v195/manage.png" class="" width="1024" title="alt">]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2022/12/03/xg-v195/title.png&quot; class=&quot;&quot; title=&quot;alt&quot;&gt;

&lt;h2 id=&quot;Sophos-Firewall-v19-5&quot;&gt;&lt;a href=&quot;#Sophos-Firewall-v19-5&quot; class=&quot;headerlink&quot; title=&quot;Sophos Firewall v19.5&quot;&gt;&lt;/a&gt;Sophos Firewall v19.5&lt;/h2&gt;&lt;p&gt;Sophos Firewall v19.5が2022年11月16日に発表されました。&lt;/p&gt;</summary>
    
    
    
    <category term="Security" scheme="https://yoshi0808.github.io/new-technology/categories/Security/"/>
    
    
    <category term="XG Firewall" scheme="https://yoshi0808.github.io/new-technology/tags/XG-Firewall/"/>
    
  </entry>
  
  <entry>
    <title>UniFiスイッチ</title>
    <link href="https://yoshi0808.github.io/new-technology/2022/11/23/unifi-switch/"/>
    <id>https://yoshi0808.github.io/new-technology/2022/11/23/unifi-switch/</id>
    <published>2022-11-22T15:00:00.000Z</published>
    <updated>2023-06-05T10:30:51.488Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2022/11/23/unifi-switch/title.png" class="" width="1024" title="alt"><p class="onepoint">この記事で実現すること</p><p>この記事ではホームユーザー向けにUniFiスイッチの設定ができるようになることを目的としています。</p><span id="more"></span><h2 id="UniFiスイッチの特徴"><a href="#UniFiスイッチの特徴" class="headerlink" title="UniFiスイッチの特徴"></a>UniFiスイッチの特徴</h2><p>UniFiネットワークスイッチの特徴としては、どちらかといえばスモールビジネス向けの製品が中心ではあります。<br>スモールオフィスの基幹ネットワークを構成しながら、監視カメラやWi-Fiシステムを導入し、トータルソリューションが売りになります。<br>ネットワークスイッチ単独の機能として見ると、以下の特徴があります。</p><ol><li>Wi-FiにRJ45ケーブルで通信と電力出力を兼ねるPoE</li><li>SFP＋などの10GbEネットワーク</li><li>UniFiネットワークアプリケーションによる集中管理</li></ol><p>ホームユーザー向けとして自宅内のネットワークを10GbEかつSFP+を選択する場合は、いくつかの魅力的なネットワークスイッチが候補に上がります。<br>発熱対策のために各部屋にSFP+でOM3などの光ケーブルを通す場合は、個人向けのネットワークスイッチではPortが不足してしまうのが実態です。<br>機器の価格帯が個人向け、かつ消去法でいくとMikroTikかUniFiが選択肢に上がります。円安で昔ほどは安いと思えなくなりましたが、SFP+スイッチは廉価です。</p><h2 id="基本設定"><a href="#基本設定" class="headerlink" title="基本設定"></a>基本設定</h2><p>基本設定です。UniFiスイッチを新規導入する際には、ネットワークアプリケーションに登録（採用）する必要があります。初期セットアップについては、以下の記事を参照してください。UniFi製品群の標準の考え方ではセキュリティゲートウェイをインターネットルーターの役割として配置し、そこに各UniFi製品群をぶら下げることになります。私はSophos Firewallを利用しており、UniFiセキュリティゲートウェイは不要としているため、集中管理のためのUniFiネットワークアプリケーションを導入しています。</p><ul><li><a href="/2022/08/27/ubiquiti-unifi/" title="Ubiquiti UniFiの世界">Ubiquiti UniFiの世界</a></li><li><a href="/2022/09/23/unifi-network-application/" title="UniFi Network Applicationのセットアップ">UniFi Network Applicationのセットアップ</a></li><li><a href="/2022/10/23/unifi-network-application2/" title="UniFi Network Applicationの運用">UniFi Network Applicationの運用</a></li></ul><p>UniFiスイッチが採用（Adoption）されると、ネットワークアプリケーションから管理できるようになります。</p><p>スイッチ毎の<mark class="label primary">Settings</mark>では、<mark class="label primary">Service</mark>で基本設定を、<mark class="label primary">Network</mark>でIPアドレスを設定できます。</p><img src="/new-technology/2022/11/23/unifi-switch/netapp2.png" class="" width="360" title="alt"><mark class="label primary">Service</mark>では、スイッチ自身がどのネットワーク（VLAN）に属するのかを決め、Flow ControlやJumbo Frameの設定が可能です。デフォルトでFlow ControlはOffです。ネットワーク速度が異なる端末を接続する場合は、Flow ControlはOnの方が良いでしょう。もちろん、送信側端末のネットワークカードがFlow Controlに対応している必要はあります。最近、UniFiネットワークアプリケーションではスイッチのGlobalSettingが可能となり、スイッチ毎にこれらの設定が不要になっています。<img src="/new-technology/2022/11/23/unifi-switch/netapp3.png" class="" width="360" title="alt"><mark class="label primary">Network</mark>では、静的IPアドレスを設定することもできます。<p>その他、<mark class="label primary">Settings</mark>からは、スイッチの再起動が可能です。</p><h2 id="スイッチポート確認"><a href="#スイッチポート確認" class="headerlink" title="スイッチポート確認"></a>スイッチポート確認</h2><p>スイッチ毎の<mark class="label primary">Ports</mark>からはPortの稼働状況が確認できます。</p><img src="/new-technology/2022/11/23/unifi-switch/netapp4.png" class="" width="360" title="alt"><table><thead><tr><th>項目名</th><th>内容</th></tr></thead><tbody><tr><td>Status</td><td>実際に接続されている速度を示します。稀にファームウェアのアップデートのタイミングで誤った認識になる場合があります</td></tr><tr><td>Tx&#x2F;Rx</td><td>送信(Tx)、受信(Rx)量を示します</td></tr><tr><td>Profile</td><td>UniFiのVLANは複数のネットワークを指定した上で纏めたトランクポートを複数種類作成可能です。ネットワークアプリケーション7.4からは仮想ネットワークバインディングという概念があり、このProfileは使わなくても済むようになりました（もちろん使っても構いません）。</td></tr><tr><td>Uplink</td><td>上流の機器を示します。UniFiがInternetへのルーティングを解析し、Internet接続ルーターを上流として自動的にUplinkポートを判別します</td></tr></tbody></table><p>その他、SFPモジュールの情報などが出力されています。</p><h2 id="スイッチポート設定"><a href="#スイッチポート設定" class="headerlink" title="スイッチポート設定"></a>スイッチポート設定</h2><p>スイッチ毎の<mark class="label primary">Ports</mark>からさらに<mark class="label primary">Port Management</mark>を選択すると、個々のPortの設定を行えます。</p><img src="/new-technology/2022/11/23/unifi-switch/netapp5.png" class="" width="1024" title="alt"><p>これはPro-Aggregationの例ですが、Portごとに接続されているクライアントが表示されています。ここで個別のPortを選択すると、ポートの速度やVLANを設定できます。</p><h3 id="Portの設定変更"><a href="#Portの設定変更" class="headerlink" title="Portの設定変更"></a>Portの設定変更</h3><p>Portの物理的な設定変更は以下の<mark class="label primary">Port Profile Override</mark>から行います。</p><img src="/new-technology/2022/11/23/unifi-switch/netapp7.png" class="" width="360" title="alt"><table><thead><tr><th>項目名</th><th>内容</th></tr></thead><tbody><tr><td>Operation</td><td>Switching または、Aggregate（複数のPortを束ねて帯域を増やす）、Mirrorを選択します。</td></tr><tr><td>Link Speed</td><td>オートネゴ、10Gbps、2.5Gbpsなどの速度固定を選択します。なお、2.5Gはオートネゴでは動作しません</td></tr><tr><td>Port Isolation</td><td>Uplinkポートのみトラフィックを転送します</td></tr><tr><td>Storm Control</td><td>ブロードキャスト、マルチキャストなどの飽和を某防止します</td></tr><tr><td>LLDP</td><td>ディスカバリプロトコルを有効にします（デフォルトON）</td></tr><tr><td>Spanning Tree Protocol</td><td>スパニングツリーを有効にします（デフォルトON）</td></tr></tbody></table><p>ミラーPortはトラブル時の確認のために使います。トラブルのあるPort番号を指定し、ミラーに設定することで同じデータが流れます。ノートPCなどを接続し、WireSharkなどを使いパケット解析します。</p><p>SFP+の製品であっても、USW-AggregationスイッチやUSW-Enterprise-8-PoEのSFP+ポートは2.5GbEに対応していません。過去記事「<a href="/2022/07/30/sfp-plus-nbaset/" title="SFP+の2.5GbE対応">SFP+の2.5GbE対応</a>」で書いたように、10GbEを2.5GbEとして偽装させる特殊なSFP+モジュールが必要になります（もっとも、USW-Enterprise-8-PoEは2.5GbEのRJ45ポートを備えているので運用上困ることはありませんが）。</p><h2 id="VLANを設定"><a href="#VLANを設定" class="headerlink" title="VLANを設定"></a>VLANを設定</h2><p>VLANを作成するにはネットワークアプリケーションの<mark class="label primary">SETTINGS</mark>から<mark class="label primary">NETWORKS</mark>を選択し、<mark class="label primary">Create New Network</mark>をクリックします。</p><p>L3スイッチではなく、単にVLANを作成したい場合は、ここで<mark class="label primary">VLAN-only Network</mark>のチェックボックスをONにし、VLAN IDを決定します。</p><img src="/new-technology/2022/11/23/unifi-switch/netapp8.png" class="" width="360" title="alt"><p>こういったネットワーク構成全般の変更を行うと、全てのスイッチに対してコンフィグの転送が行われ、スイッチの再構成が実行されます。</p><p>トランクポートとして使う場合は２つの方法があります。</p><ol><li>仮想ネットワークバインディングで許可するVLANまたはブロックするVLANを指定します。</li><li>予め作成した複数のネットワークを束ねたProfileを作成した上でそれを指定します。</li></ol><h3 id="仮想ネットワークバインディングを使う方法"><a href="#仮想ネットワークバインディングを使う方法" class="headerlink" title="仮想ネットワークバインディングを使う方法"></a>仮想ネットワークバインディングを使う方法</h3><p>ネットワークアプリケーションv7.4から導入された仮想ネットワークバインディングは、従前のように、トランクポートのネットワークの組み合わせをわざわざProfileで作成しなくて済むというメリットがあります。</p><img src="/new-technology/2022/11/23/unifi-switch/netapp10.png" class="" width="1024" title="alt"><p>タグなしのメインのネットワーク（ネイティブVLAN）を決めた上で、タグ付きのVLANについては、許可する、ブロックするの分類を指定します。ファイアウォールのように許可かブロックかを選択するというものではなく、ネイティブVLAN以外のタグ付きVLANを全て列挙し、許可またはブロックの何れかに分類するという方が近いでしょう。</p><p>仮想ネットワークバインディングで<mark class="label primary">該当なし</mark>を選択すると、そのポートには全てのデータが流れることになるようです。Switch Flex MiniのようにProfileを割り当てできない小型スイッチではこの該当なしを選択してアップリンクのスイッチからタグ無し、タグ有りのパケットをそのまま送受信する事になります。</p><h3 id="従来からのProfileを使う方法"><a href="#従来からのProfileを使う方法" class="headerlink" title="従来からのProfileを使う方法"></a>従来からのProfileを使う方法</h3><p>Profile作成時には指定する複数のネットワークのうちどれか1つをネイティブVLANとしてタグ無しに設定します。昨今、デフォルトVLANを変えることがセキュリティ上優位であるとも思えないので、私は管理用VLANは無条件にデフォルトVLAN（VLAN ID&#x3D;1）で管理するようにしています。</p><p>Profileを使う方式では、このようにネイティブVLANがどのネットワークか定め、タグ付きのVLANを追加で選択していきます。</p><img src="/new-technology/2022/11/23/unifi-switch/netapp6.png" class="" width="1024" title="alt"><p>Profileを作成後、スイッチポートの設定にて、<mark class="label primary">イーサネットポートプロファイル</mark>のチェックボックスをオンにしてリストボックスからProfileを指定します。</p><img src="/new-technology/2022/11/23/unifi-switch/netapp11.png" class="" width="480" title="alt"><p>この例では、 UniFi-APはデフォルトVLANで接続し、AP同士の制御用パケットは全てデフォルトVLAN配下に流れます。また、タグ付きネットワークでVLAN-XXX（一般端末向け）とGuestがありますが、UniFi-APは複数のネットワークに属することができますので1つのAPで複数のネットワークに対してWi-Fiサービス提供できるようになります。</p><p>ネットワーク機器のLANをデフォルトVLAN、かつ、ネイティブVLAN（タグ無し）としているのは何らかのトラブル時に復旧させやすいという点もあります。</p><h2 id="SSH"><a href="#SSH" class="headerlink" title="SSH"></a>SSH</h2><p>UniFiスイッチは廉価なSwitch Flex Miniを除き、大半のスイッチはSSH接続が可能です。ネットワークアプリケーションで設定したID&#x2F;パスワードでも接続できますし、公開鍵認証でも接続可能です。スイッチにSSHすると Linuxのインタフェースのように見えます。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">$ ssh xxx</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BusyBox v1.25.1 () built-in shell (ash)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  ___ ___      .__________.__</span><br><span class="line"> |   |   |____ |__\_  ____/__|</span><br><span class="line"> |   |   /    \|  ||  __) |  |   (c) 2010-2022</span><br><span class="line"> |   |  |   |  \  ||  \   |  |   Ubiquiti Inc.</span><br><span class="line"> |______|___|  /__||__/   |__|</span><br><span class="line">            |_/                  https://www.ui.com</span><br><span class="line"></span><br><span class="line">      Welcome to UniFi USW-Aggregation!</span><br><span class="line"></span><br><span class="line">********************************* NOTICE **********************************</span><br><span class="line">* By logging <span class="keyword">in</span> to, accessing, or using any Ubiquiti product, you are     *</span><br><span class="line">* signifying that you have <span class="built_in">read</span> our Terms of Service (ToS) and End User   *</span><br><span class="line">* License Agreement (EULA), understand their terms, and agree to be       *</span><br><span class="line">* fully bound to them. The use of SSH (Secure Shell) can potentially      *</span><br><span class="line">* harm Ubiquiti devices and result <span class="keyword">in</span> lost access to them and their data. *</span><br><span class="line">* By proceeding, you acknowledge that the use of SSH to modify device(s)  *</span><br><span class="line">* outside of their normal operational scope, or <span class="keyword">in</span> any manner             *</span><br><span class="line">* inconsistent with the ToS or EULA, will permanently and irrevocably     *</span><br><span class="line">* void any applicable warranty.                                           *</span><br><span class="line">***************************************************************************</span><br><span class="line"></span><br><span class="line">USW-Aggregation-US.6.3.13<span class="comment"># cd /var/log</span></span><br><span class="line">USW-Aggregation-US.6.3.13<span class="comment"># vi messages</span></span><br><span class="line">USW-Aggregation-US.6.3.13<span class="comment"># ping 192.168.x.100</span></span><br><span class="line">PING 192.168.x.100 (192.168.x.100): 56 data bytes</span><br><span class="line">64 bytes from 192.168.x.100: <span class="built_in">seq</span>=0 ttl=64 time=0.000 ms</span><br><span class="line">64 bytes from 192.168.x.100: <span class="built_in">seq</span>=1 ttl=64 time=10.000 ms</span><br><span class="line">64 bytes from 192.168.x.100: <span class="built_in">seq</span>=2 ttl=64 time=10.001 ms</span><br><span class="line">64 bytes from 192.168.x.100: <span class="built_in">seq</span>=3 ttl=64 time=10.000 ms</span><br><span class="line">64 bytes from 192.168.x.100: <span class="built_in">seq</span>=4 ttl=64 time=10.001 ms</span><br></pre></td></tr></table></figure><p><code> /var/log/messages</code>にはsyslogがありますので、たまには中身を確認されることをお勧めします（viコマンドなどで開きます）。表向き、SFPモジュールが動作しているように見えても、互換性の問題でエラーを吐いている場合もあります。ダイレクトアタッチケーブルなどを対向の端末を繋がずスイッチに接続している場合など定期的にLinkDownのアラートが出ている場合もあります。RJ45とは動きは異なります。</p><p>上記はUSW-Aggregationに接続した状態ですが、pingも動作しますが、レスポンスは悪いです。LAN内の機器の応答に10ms掛かっていますが驚かないでください。スイッチのデータ転送は専用チップ（ASIC）が行うため、機器のCPUがスイッチの実力にはなりません。OSに割り当てるCPUリソースの関係でしょうか、このpingの応答速度は「ご参考」として割り切った方が良さそうです。</p><h3 id="スイッチの詳細情報について"><a href="#スイッチの詳細情報について" class="headerlink" title="スイッチの詳細情報について"></a>スイッチの詳細情報について</h3><p>Linuxのコンソールから、<code>cli</code>コマンドを投入することで、Ciscoライクなスイッチのコマンドモードに入ることができます。<br>コマンド入力途中でタブを押下するとコマンドが補完されます。<br><code>show  running-config</code>などそのまま使えます。<code>copy running-config startup-config</code>なども実行できそうですが、UniFiではネットワークアプリケーションから完全同期されていることが大前提であり、コマンドモードで設定しても再起動時にはネットワークアプリケーションから上書きされてしまいます。<br>ややこしいのは、スイッチ毎にコマンドの互換性が殆どないことです。コマンドの途中で<code>&quot;？&quot;</code>を入力すると、実行できるパラメータが列挙されるので推測でコマンドを補完しながら入力することになります。私の知る限り、機種毎のコマンドラインのマニュアルは存在しないようです。</p><h3 id="USW-Pro-Aggregation-L3スイッチ"><a href="#USW-Pro-Aggregation-L3スイッチ" class="headerlink" title="USW-Pro-Aggregation(L3スイッチ)"></a>USW-Pro-Aggregation(L3スイッチ)</h3><p>このスイッチは比較的コマンドが充実しています。<code>cli</code>でコマンドモードに入り、<code>en</code>で特権モードに入ります。<br>Portの状況を見るには以下のコマンドを使います。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(UBNT) #show interface ethernet 0/x</span><br></pre></td></tr></table></figure><p>これだと100行余りの結果が表示されるのでパイプ（｜）で区切り、必要な項目だけフィルタできます。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">(UBNT) #show interface ethernet 0/x | include Error|Collision|Discard</span><br><span class="line"></span><br><span class="line">Total Packets Received Without Errors.......... 43388669</span><br><span class="line">Receive Packets Discarded...................... 0</span><br><span class="line">Total Packets Received with MAC Errors......... 0</span><br><span class="line">Alignment Errors Received...................... 0</span><br><span class="line">FCS Errors Received............................ 0</span><br><span class="line">URPF Discards.................................. 0</span><br><span class="line">Transmit Packets Discarded..................... 0</span><br><span class="line">Total Transmit Errors.......................... 0</span><br><span class="line">FCS Errors Transmitted......................... 0</span><br><span class="line">Total Transmit Packets Discarded............... 0</span><br><span class="line">Single Collision Frames........................ 0</span><br><span class="line">Multiple Collision Frames...................... 0</span><br><span class="line">Excessive Collision Frames..................... 0</span><br><span class="line"></span><br><span class="line">(UBNT) #</span><br></pre></td></tr></table></figure><p>このようにして重要な情報のみ取得できます。あくまで一般的なパラメータとしていますが、現代の全二重の通信前提であればCollisionまで見る必要はないですね。一般的にはReceiveでエラーがあるときはケーブルを最初に疑ってみること、Transmit Packets Discardedの場合はVLANの設定が間違っている可能性があることでしょうか。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clear counters all</span><br></pre></td></tr></table></figure><p>カウンタをクリアします。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show fiber-ports optics-info all</span><br></pre></td></tr></table></figure><p>モジュールのメーカーやシリアル番号を表示します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">(UBNT) #show fiber-ports optics all</span><br><span class="line"></span><br><span class="line">                                                 Output   Input</span><br><span class="line">Port    Physical Port/  Temp  Voltage  Current   Power    Power     TX     LOS</span><br><span class="line">        Lane Number     [C]   [Volt]     [mA]    [dBm]    [dBm]     Fault</span><br><span class="line">------  --------------  ----  -------  -------   -------  -------   -----  ---</span><br><span class="line">0/4     0/4-Lane1       34.2    3.328     10.2    -3.370   -2.496   No     No</span><br><span class="line">0/5     0/5-Lane1       34.5    3.265     10.4    -2.976   -3.373   No     No</span><br><span class="line">0/8     0/8-Lane1       34.0    3.360     10.2    -3.799   -1.643   No     No</span><br><span class="line">0/9     0/9-Lane1        N/A      N/A      N/A       N/A      N/A   N/A    N/A</span><br><span class="line">0/12    0/12-Lane1       N/A      N/A      N/A       N/A      N/A   N/A    N/A</span><br><span class="line">0/15    0/15-Lane1       N/A      N/A      N/A       N/A      N/A   N/A    N/A</span><br><span class="line">0/18    0/18-Lane1       N/A      N/A      N/A       N/A      N/A   N/A    N/A</span><br><span class="line">0/19    0/19-Lane1       N/A      N/A      N/A       N/A      N/A   N/A    N/A</span><br><span class="line">0/22    0/22-Lane1       N/A      N/A      N/A       N/A      N/A   N/A    N/A</span><br><span class="line">0/26    0/26-Lane1      33.3    3.235      6.0    -3.002   -3.002   No     No</span><br><span class="line"></span><br><span class="line"> Temp - Internally measured transceiver temperatures.</span><br><span class="line"> Voltage - Internally measured supply voltage.</span><br><span class="line"> Current - Measured TX bias current.</span><br><span class="line"> Output Power - Measured optical output power relative to 1mW.</span><br><span class="line"> Input Power - Measured optical power received relative to 1mW.</span><br><span class="line"> TX Fault - Transmitter fault.</span><br><span class="line"> LOS - Loss of signal.</span><br><span class="line"></span><br><span class="line">(UBNT) #</span><br></pre></td></tr></table></figure><p>モジュールのDDM（温度、光の強さ）を表示します。</p><h3 id="USW-Aggregation-SFP-8Port"><a href="#USW-Aggregation-SFP-8Port" class="headerlink" title="USW-Aggregation(SFP+ 8Port)"></a>USW-Aggregation(SFP+ 8Port)</h3><p>このスイッチは<code>cli</code>でコマンドモードに入ったら、すぐに大半のコマンドが実行できます。代表的なのは以下のものです。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show interfaces TenGigabitEthernet x</span><br></pre></td></tr></table></figure><p>Port xのPort状況を表示します。パケットカウントやコリジョンなどの数を示します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clear interfaces TenGigabitEthernet  x counters</span><br></pre></td></tr></table></figure><p>Port xのカウンタをクリアします。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show fiber-transceiver-info interfaces  TenGigabitEthernet  x</span><br></pre></td></tr></table></figure><p>SFPモジュールの種類やシリアル番号を表示します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show fiber-transceiver interfaces  TenGigabitEthernet x</span><br></pre></td></tr></table></figure><p>SFPモジュールのDDM（信号の強さ、温度）を示します。</p><h2 id="L3スイッチの制約"><a href="#L3スイッチの制約" class="headerlink" title="L3スイッチの制約"></a>L3スイッチの制約</h2><p>UniFiのL3スイッチはDHCP機能を持ちますが、管理機能やルーティングについてはIPv6には対応していません。スイッチ自身はIPv6アドレスを持てるようですが、現段階でIPv6のL3ルーティングできるようにはなっていません。別のルーターでDHCPv6を割り当て、そちらをゲートウェイにするなどが必要です。L2スイッチを含めてIPv6通信が行えないということではありません。</p><h2 id="SFPモジュール"><a href="#SFPモジュール" class="headerlink" title="SFPモジュール"></a>SFPモジュール</h2><p>Ubiquitiのモジュール群は廉価なため、光モジュールは純正が間違いないでしょう。OM3ケーブルやDACはさまざまなメーカーのものを使いましたが、UniFi製品で問題が発生したことはありません。RJ45モジュールは特に10GbEのものは低電力を踏まえるとSFPメーカーの製品の選定も視野に入ります。</p><img src="/new-technology/2022/11/23/unifi-switch/module.png" class="" width="640" title="alt"><p>1GbE tp-link TL-SM331<br>一般的なMarvell社88E1111などを使ったモジュールが通常使用（Typical）で1.05Wの消費電力なのに対し、その半分以下の0.5Wとなっており、発熱もかなり抑えられています。最近、国内でも発売になったようですが、私は今年の5月に米Amazonで$19.99で購入し、問題なく使えています。</p><blockquote><p>tp-link<br> <a href="https://www.tp-link.com/jp/service-provider/switch-accessory/tl-sm331t/">https://www.tp-link.com/jp/service-provider/switch-accessory/tl-sm331t/</a></p></blockquote><p>10GbE Fiber mall SFP-10G-T-UB-80m<br>80mまで対応した省電力の10GbEモジュールです。こちらも米Amazonで購入しました。＄68.99でした。BroadcomのBCM84891のチップを採用している80mに対応したモジュールはいくつか存在します。Cisco用のモジュール（SFP-10G-TS80）についてはメーカーの公表ではDDMに対応していないと記載があるものの、UniFiスイッチ上では、モジュールの温度などのパラメータが出力されています。</p><blockquote><p>Fiber mall<br> <a href="https://www.fibermall.com/ja/news/10g-copper-sfp.htm">https://www.fibermall.com/ja/news/10g-copper-sfp.htm</a></p></blockquote><p>英語ですが、ぜひAmazonのカスタマーレビューを見てください。より詳細で素晴らしい知見に基づいたコメントが見られます。</p><blockquote><p>米Amazon Customer Review<br> <a href="https://www.amazon.com/gp/customer-reviews/RLHW2OL4I1QZP/ref=cm_cr_dp_d_rvw_ttl?ie=UTF8&amp;ASIN=B0B18BY1XK">https://www.amazon.com/gp/customer-reviews/RLHW2OL4I1QZP/ref=cm_cr_dp_d_rvw_ttl?ie=UTF8&amp;ASIN=B0B18BY1XK</a></p></blockquote><h2 id="PoE"><a href="#PoE" class="headerlink" title="PoE"></a>PoE</h2><p>スイッチにおけるPoEもネットワークアプリケーションから設定できます。USW-Enterprise-8-PoEの例では、Switch Flex MiniおよびAPのU6 Proに給電している状況が確認できます。</p><img src="/new-technology/2022/11/23/unifi-switch/netapp9.png" class="" width="640" title="alt"><p>Port ManagementからPoEのOn&#x2F;Offが可能となっています。</p><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>これらのように、ネットワークスイッチをただ単に繋げるための道具ではなく、ITやネットワークを見える化するという目的においては非常に有用な機器になります。セキュリティ観点ではできることは限られていますが、ホームユーザーにとっても有用な機能は活用できると思われます。</p><p>Ubiquiti 日本語ガイドのスイッチに関する記事は以下が参考になります。</p><blockquote><p>UniFi Network - 有線ネットワーク速度の最適化<br> <a href="https://help.jp.ui.com/articles/6949005136919/">https://help.jp.ui.com/articles/6949005136919/</a></p></blockquote><h2 id="リソース"><a href="#リソース" class="headerlink" title="リソース"></a>リソース</h2><p>以下の日本語ヘルプ、コミュニティがUniFiの構築には大いに参考になります。</p><blockquote><p>Ubiquiti コミュニティ（日本）<br> <a href="https://www.facebook.com/groups/uijapan">https://www.facebook.com/groups/uijapan</a></p></blockquote><blockquote><p>UI 日本語ヘルプ記事<br> <a href="https://help.jp.ui.com/categories/6583256751383/">https://help.jp.ui.com/categories/6583256751383/</a></p></blockquote><blockquote><p>Ubiquiti Community（米国中心）<br> <a href="https://community.ui.com/">https://community.ui.com/</a></p></blockquote>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2022/11/23/unifi-switch/title.png&quot; class=&quot;&quot; width=&quot;1024&quot; title=&quot;alt&quot;&gt;
&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;

&lt;p&gt;この記事ではホームユーザー向けにUniFiスイッチの設定ができるようになることを目的としています。&lt;/p&gt;</summary>
    
    
    
    <category term="Hardware" scheme="https://yoshi0808.github.io/new-technology/categories/Hardware/"/>
    
    <category term="Network" scheme="https://yoshi0808.github.io/new-technology/categories/Network/"/>
    
    
    <category term="SFP+" scheme="https://yoshi0808.github.io/new-technology/tags/SFP/"/>
    
    <category term="10GbE" scheme="https://yoshi0808.github.io/new-technology/tags/10GbE/"/>
    
    <category term="UniFi" scheme="https://yoshi0808.github.io/new-technology/tags/UniFi/"/>
    
  </entry>
  
  <entry>
    <title>UniFi Network Applicationの運用</title>
    <link href="https://yoshi0808.github.io/new-technology/2022/10/23/unifi-network-application2/"/>
    <id>https://yoshi0808.github.io/new-technology/2022/10/23/unifi-network-application2/</id>
    <published>2022-10-23T01:38:49.000Z</published>
    <updated>2023-06-03T01:53:08.442Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2022/10/23/unifi-network-application2/unifi1.png" class="" width="1024" title="alt"><p class="onepoint">この記事で実現すること</p><p>前回記事「<a href="/2022/09/23/unifi-network-application/" title="UniFi Network Applicationのセットアップ">UniFi Network Applicationのセットアップ</a>」では、UniFi Network ApplicationをUbuntu上にセットアップし、UniFiネットワーク製品の登録（Adoption）までを行いました。この記事ではホームユーザーがUniFi製品を運用していくにあたり、必要な操作ができるようになることを目的としています。</p><span id="more"></span><h2 id="日本語ガイド"><a href="#日本語ガイド" class="headerlink" title="日本語ガイド"></a>日本語ガイド</h2><p>セットアップが完了し、運用開始するにあたり、日本の公式のガイドとして以下のリソースがあります。</p><blockquote><p>UniFi - アップデート<br> <a href="https://help.jp.ui.com/articles/7605005245975/">https://help.jp.ui.com/articles/7605005245975/</a></p></blockquote><blockquote><p>接続の課題などのFAQ<br> <a href="https://help.jp.ui.com/articles/7258465146519/">https://help.jp.ui.com/articles/7258465146519/</a></p></blockquote><h2 id="UniFiデバイス一覧およびアップデート"><a href="#UniFiデバイス一覧およびアップデート" class="headerlink" title="UniFiデバイス一覧およびアップデート"></a>UniFiデバイス一覧およびアップデート</h2><p><code>https://UniFi Network Application Host:8443/</code>に接続すると左にカテゴリのアイコンが並びます。以下のように左の赤枠で囲った<mark class="label primary">UNIFI DEVICES</mark>一覧では現在のAdoptされているUniFi機器の一覧が確認できます。</p><img src="/new-technology/2022/10/23/unifi-network-application2/u1.png" class="" width="1024" title="alt"><p>バージョンアップの通知があれば、ここで<mark class="label primary">Click to Update</mark>のように表示されますので、これをクリックしてデバイスのアップデートが行えます。<br>リリースの情報については本国のCommunityを参照することになります。</p><blockquote><p>UniFi リリース一覧<br> <a href="https://community.ui.com/releases/">https://community.ui.com/releases/</a></p></blockquote><img src="/new-technology/2022/10/23/unifi-network-application2/rel.png" class="" width="1024" title="alt"><p>ここでは、<mark class="label primary">Official</mark>または<mark class="label primary">Release Candidate(リリース候補）</mark>と区分されています。Network Applicationの初期設定では、Officialのものが自動的にアップデートされる仕組みになっています。後に説明する設定画面で、Official,Release Candidate,Early Accessと3つの区分を選択可能です。</p><p>実際のリリースのポストを参照すると先頭には簡単なリリースノーツが記述されており、それ以下でユーザーによるレポートが続きます。前回も記載しましたが、マニュアルがないことや製品提供機能やUbiquitiの今後の方向性があまり見えてこないこともあり、他のプロダクトと比較しても、ユーザーからは辛辣な意見が寄せられる事が多いです。単なる不満（ユーザーのスキル不足や、製品への過剰な期待や思い込みが原因である事も多いように感じられます）の投稿によって重要な情報を見失わないようにすることが大事です。詳細な検証結果など貴重な情報を提供してくれるユーザーも存在しています。</p><p>デバイスを選択すると個々のデバイスのトラフィック状況などが確認できます。<mark class="label primary">Settings</mark>に進むとバージョンアップや再起動、ファームウェアのロールバックなどが実行できます。また、デバイスをリセットする場合や他のネットワークに使う場合は、<mark class="label primary">Forget</mark>を選択します。</p><img src="/new-technology/2022/10/23/unifi-network-application2/u2.png" class="" width="360" title="alt"><p>ファームウェアをロールバック（ダウングレード）する場合は、該当製品のファームウェアバージョンのURLを指定します。ここで説明している使い方は、Ubiquitiクラウド連携を前提としており、UniFiネットワークアプリケーション、スイッチ共にインターネットへ接続可能である必要があります。リリース一覧は以下のURLから確認します。</p><blockquote><p>UniFi APなど<br><a href="https://www.ui.com/download/unifi/">https://www.ui.com/download/unifi/</a></p></blockquote><blockquote><p>UniFi スイッチ<br><a href="https://www.ui.com/download/unifi-switching-routing">https://www.ui.com/download/unifi-switching-routing</a></p></blockquote><img src="/new-technology/2022/10/23/unifi-network-application2/dl.png" class="" width="1024" title="alt"><p>左メニューのプルダウンから製品を選択すると以下のように最新バージョンが表示されます。ここから<mark class="label primary">PAST FIRMWARE</mark>を選択し、具体的なバージョンを指定してから、ダウンロードを選択するとURLが示されるので、そのURLをネットワークアプリケーションのデバイスのURLに貼り付け、Updateを実行します。</p><img src="/new-technology/2022/10/23/unifi-network-application2/rel1.png" class="" width="800" title="alt"><p>ここまでの作業はスマホアプリ（UniFi Network）でも同様の操作が可能です。</p><h2 id="クライアントデバイス一覧"><a href="#クライアントデバイス一覧" class="headerlink" title="クライアントデバイス一覧"></a>クライアントデバイス一覧</h2><p>以下のように左の赤枠で囲った<mark class="label primary">CLIENT DEVICES</mark>では現在のUniFiネットワークに接続されているクライアント一覧が確認できます。</p><img src="/new-technology/2022/10/23/unifi-network-application2/u3.png" class="" width="1024" title="alt"><p>ここではIPアドレス、クライアントが所属するVLAN、接続しているWi-Fiの情報、トラフィックなどが確認できます。もし、UniFiのL3スイッチがあれば、L3スイッチにDHCP機能があるので、この画面からスタティックIPアドレスを設定可能です。</p><p>この画面もスマホアプリで同様の操作と確認ができます。</p><h2 id="設定"><a href="#設定" class="headerlink" title="設定"></a>設定</h2><p>以下のように左の赤枠で囲った<mark class="label primary">SETTINGS</mark>ではUniFi製品群の全般的な設定をします。なおこの記事のUniFiの構成では、UDM Proなどのセキュリティゲートウェイを保有していない状態であり、単独のUniFi Network Applicationの設定例となります。以下の左側メニューの<mark class="label primary">Internet</mark>、<mark class="label primary">VPN</mark>、<mark class="label primary">Traffic Management</mark>、<mark class="label primary">Firewall & Security</mark>は対象外です。</p><img src="/new-technology/2022/10/23/unifi-network-application2/u4.png" class="" width="1024" title="alt"><h3 id="WiFi"><a href="#WiFi" class="headerlink" title="WiFi"></a>WiFi</h3><p>WiFi設定では名前、所属するVLAN、チャンネルなど設定します。UniFiは集中型管理であるため、個々のAP毎に設定するよりはネットワーク全体でどのように管理するかを決めるモデルとなります。</p><ul><li><p>Global AP Settings<br> この設定で、複数APを立てることを想定し、全般設定を行います。</p></li><li><p>Channel Width<br> 2.4GHz、5GHzそれぞれでバンド幅を設定します。ここは個人の好みによりますが、一般的なデバイスのために2.4GHzは20MHzを、5GHzでは80MHzを設定することをお勧めします。もちろん、PCなども無線でできるだけ速度を求める方は160MHzの設定が可能です。こういった場合は、AP単位にバンド幅を個別設定し、クライアント単位に接続させるAPを固定させる事ができます。</p></li><li><p>Transmit Power<br> 無線の送信出力を決めます。Auto&#x2F;High&#x2F;Medium&#x2F;Lowが選択できます。</p></li><li><p>AP Site Settings<br> Wiress Meshingの項目がありますが、メッシュ製品（無線によるバックホール接続）は現在日本では発売されていません。</p></li><li><p>Nightly Channel Optimization<br> 夜間に外部のWiFiの電波状況を見ながらUniFi側でWiFiチャネルの最適化を行います。比較的近い距離で同一のチャンネルを選択していると競合することになるのでこれは実際にテストしながら選択されることをお勧めします。</p></li></ul><p>これより詳細のWiFi設定についてはまた別の機会があれば書きたいと思います。</p><h3 id="Networks"><a href="#Networks" class="headerlink" title="Networks"></a>Networks</h3><p>Networksでは主にVLANとスイッチの全般設定をします。</p><img src="/new-technology/2022/10/23/unifi-network-application2/u5.png" class="" width="1024" title="alt"><p>今回の記事は概要に留めますが、VLANを構成する場合にはスイッチ単位ではなく、ネットワークアプリケーションでネットワーク全体の構成を決めることになります。もし、UniFiのL3スイッチがあり、L3ネットワークにするのであれば、L3のDHCPを有効にします。L3スイッチがない場合で単にL2のVLANを作成する場合は、<mark class="label primary">VLAN Only Network</mark>としてVLANを作成し、ルーティングやDHCP機能はFirewallやルータに任せることになります。</p><p>一旦ネットワークアプリケーションでVLANを定義すると、どのスイッチからもそのVLANが利用できるようになります。</p><p>以下はFirewallを利用する場合の一例です。インターネット接続がホームゲートウェイとなる場合、もちろんFirewallとHGWとを直結しても構いませんが、トラフィックを把握するためにVLANを定義し、FirewallのWANとHGWとをスイッチに接続します。こういった場合にはUniFiスイッチではFirewallの外側（ホームゲートウェイ側）と内側（LAN）のネットワークとを分離するため、VLAN OnlyでWANのVLANを作成することになります。</p><img src="/new-technology/2022/10/23/unifi-network-application2/switch.drawio.png" class="" width="480" title="alt"><p>UniFiネットワークアプリケーション7.4.156からは、VLANの概念は仮想ネットワークという概念に変わっています。メインのネットワーク（タグ無し）と許可&#x2F;禁止するネットワーク（VLAN）として定義することになり、ネットワーク専門用語ではなく、UniFiの世界の用語へと変わっていくようです。</p><ul><li><p>Global Network Settings<br> ネットワーク設定全般を行います。スイッチの共通設定部分になります。</p></li><li><p>Multicast DNS<br> Apple AirPlayやGoogle Chromecastのためにネットワークセグメントを超えてmDNS(Bonjour)の名前解決およびデータ配信を支援します。</p></li><li><p>IGMP Snooping<br> 本来は、マルチキャストトラフィックを使っていないクライアントに対してはパケットの転送を抑制するためのものですが、スイッチでPackets Discardedのカウンタが増えるのが気になり私は無効にしています。WiFiネットワークがあるセグメントにひかりTVなど、対象セグメントに一定量のマルチキャストトラフィックを流すのが気になる場合はセグメントをVLANで分離する方がお勧めです。</p></li><li><p>Global Switch Settings<br> 複数スイッチの共通設定を指定します。主には、Flow Control、Jumbo Framesがあります。また固有のスイッチだけフローコントロールを外すとか個別設定が可能なように、<mark class="label primary">Switch Exclusion</mark>から該当するスイッチを選択できます。</p></li></ul><h3 id="System"><a href="#System" class="headerlink" title="System"></a>System</h3><p>Systemでは主にネットワークアプリケーション全般設定をします。</p><img src="/new-technology/2022/10/23/unifi-network-application2/u6.png" class="" width="1024" title="alt"><mark class="label primary">Network Notification</mark>で通知設定ができます。これはメール、スマホアプリへの通知、ネットワークアプリケーション画面上での通知が選択できます。ファームウェア通知、APのレーダー受信、クライアントの接続/切断通知など設定項目は多岐にわたります。<p>その他主要項目を抜粋します。</p><ul><li><p>Updates<br> ここではデバイスのファームウェア情報についての設定です。ネットワークアプリケーション自身のアップデートがある場合、デバイスのアップデートがある場合は通知できます。ここで接続チャネル（Officail&#x2F;Release Candidate&#x2F;Early Access）が選べます。なお、ネットワークアプリケーションはインストールで実施したようにShellスクリプトで実施することになります（後述します）。</p></li><li><p>Device Auto Updates<br> デバイスを自動的にアップデートするか選択します。最新ファームウェアが公開されると時刻に関係なくアップデートされるので、ここはオフに設定し、<mark class="label primary">Schedule Device Updates</mark>で週末などにアップデートする設定を追加することをお勧めします。</p> <img src="/new-technology/2022/10/23/unifi-network-application2/u7.png" class="" width="240" title="alt"></li><li><p>Backup<br> ネットワークアプリケーションの設定のバックアップです。日次、週次、月次でバックアップ可能です。トラフィックログも併せてバックアップが可能です。</p></li><li><p>System Logging<br> デバイスのログをsyslogに転送できます。syslogサーバのIPアドレスとPort（一般的に514）を設定します。</p></li><li><p>Network Device SSH Authentication<br> スイッチやAPに対しSSH可能です。スイッチの詳細なカウンタを取得するために必要です。カウンタのエラーが無いか、切断回数などを確認するために使います。パスワード認証または公開鍵を設定することでUniFiデバイスへ接続可能になります。</p> <img src="/new-technology/2022/10/23/unifi-network-application2/u8.png" class="" width="480" title="alt"></li><li><p>Other Configuration<br> NTPの設定、メールサーバーの設定ができます。メールサーバーはCloudを選択するとUbiquitiクラウドからメール通知が行われます。</p></li></ul><h2 id="Network-Applicationのバージョンアップ"><a href="#Network-Applicationのバージョンアップ" class="headerlink" title="Network Applicationのバージョンアップ"></a>Network Applicationのバージョンアップ</h2><p>Network ApplicationはこのGUIから更新することはできず、前回記事「<a href="/2022/09/23/unifi-network-application/" title="UniFi Network Applicationのセットアップ">UniFi Network Applicationのセットアップ</a>」で説明したLinuxのシェルからアップデートスクリプトを実行することになります。Windows、macOSでお使いの方は最新モジュールをダウンロードし、セットアップを実行することになります。ここではUbuntuのアップデートの例を記載します。</p><p>スクリプトの情報は、コミュニティにあります。<br><a href="https://community.ui.com/questions/UniFi-Installation-Scripts-or-UniFi-Easy-Update-Script-or-UniFi-Lets-Encrypt-or-UniFi-Easy-Encrypt-/ccbc7530-dd61-40a7-82ec-22b17f027776">https://community.ui.com/questions/UniFi-Installation-Scripts-or-UniFi-Easy-Update-Script-or-UniFi-Lets-Encrypt-or-UniFi-Easy-Encrypt-/ccbc7530-dd61-40a7-82ec-22b17f027776</a></p><p>セットアップで失敗した際にすぐに戻れるように、このタイミングでESXiのスナップショット、またはバックアップの取得をお勧めします。</p><p>実行は3ステップです。Ubuntuの<mark class="label primary">端末</mark>から、以下のコマンドを実行します。</p><ol><li><p>管理者になります</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo -i</span><br></pre></td></tr></table></figure></li><li><p>証明書などのダウンロードをします。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ apt-get update; apt-get install ca-certificates wget -y</span><br></pre></td></tr></table></figure></li><li><p>ネットワークアプリケーションのアップデートを行います。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">rm</span> unifi-update.sh &amp;&gt; /dev/null; wget https://get.glennr.nl/unifi/update/unifi-update.sh &amp;&amp; bash unifi-update.sh</span><br></pre></td></tr></table></figure></li></ol><p>上記のCommunityでは、個別のバージョンのスクリプトシェルへのリンクもありますので、unifi-updates.shの代わりに、バージョンを指定したスクリプトでインストールすることもできます。ロールバックは対応していないとの情報があるので、私はESXiでのバックアップを保存するようにしています。</p><p>日本語ガイドにもアップデートに関する言及があります。</p><blockquote><p>UniFi Network - 他社製の非コンソールUniFi Networkアプリケーションをアップデートする（Linux - 高度）<br> <a href="https://help.jp.ui.com/articles/220066768/">https://help.jp.ui.com/articles/220066768/</a></p></blockquote><h2 id="リソース"><a href="#リソース" class="headerlink" title="リソース"></a>リソース</h2><p>以下の日本語ヘルプ、コミュニティがUniFiの構築には大いに参考になります。</p><blockquote><p>Ubiquiti コミュニティ（日本）<br> <a href="https://www.facebook.com/groups/uijapan">https://www.facebook.com/groups/uijapan</a></p></blockquote><blockquote><p>UI 日本語ヘルプ記事<br> <a href="https://help.jp.ui.com/categories/6583256751383/">https://help.jp.ui.com/categories/6583256751383/</a></p></blockquote><blockquote><p>Ubiquiti Community（米国中心）<br> <a href="https://community.ui.com/">https://community.ui.com/</a></p></blockquote>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2022/10/23/unifi-network-application2/unifi1.png&quot; class=&quot;&quot; width=&quot;1024&quot; title=&quot;alt&quot;&gt;

&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;

&lt;p&gt;前回記事「&lt;a href=&quot;/2022/09/23/unifi-network-application/&quot; title=&quot;UniFi Network Applicationのセットアップ&quot;&gt;UniFi Network Applicationのセットアップ&lt;/a&gt;」では、UniFi Network ApplicationをUbuntu上にセットアップし、UniFiネットワーク製品の登録（Adoption）までを行いました。この記事ではホームユーザーがUniFi製品を運用していくにあたり、必要な操作ができるようになることを目的としています。&lt;/p&gt;</summary>
    
    
    
    <category term="Network" scheme="https://yoshi0808.github.io/new-technology/categories/Network/"/>
    
    
    <category term="UniFi" scheme="https://yoshi0808.github.io/new-technology/tags/UniFi/"/>
    
  </entry>
  
  <entry>
    <title>UniFi Network Applicationのセットアップ</title>
    <link href="https://yoshi0808.github.io/new-technology/2022/09/23/unifi-network-application/"/>
    <id>https://yoshi0808.github.io/new-technology/2022/09/23/unifi-network-application/</id>
    <published>2022-09-22T16:00:00.000Z</published>
    <updated>2023-06-03T01:44:56.083Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2022/09/23/unifi-network-application/unifi1.png" class="" width="1024" title="alt"><p class="onepoint">この記事で実現すること</p><p>米国Ubiquiti（ユビキティ）社のUniFi製品であるネットワークスイッチ、Wi-Fiアクセスポイントを利用するには、管理コンソールとしてUniFi OS ConsoleまたはUniFi Network Applicationが必要となります。UniFi Network ApplicationはUbiquitiより無償提供されており、管理・運用においてはUniFiクラウドサービスと連携します。一般的にはこのようなサービスはサブスクリプション費用が必要ですが、この費用も掛かりません。UniFi製品はネットワークの見える化に特化しているため、管理コンソールの24時間稼働が理想です。最初からハード組み込みのセキュリティ機器（UniFi Security Gateway等）やUniFi Cloud Keyを購入すればすぐにUniFi製品を使い始めることができますが、これらのハードウェアを購入しなくとも、ネットワークやLinuxの知識がある人はUniFi Network Applicationをセットアップし、使い始めることができます。</p><span id="more"></span><h2 id="UniFi-Network-Applicationのセットアップの前提"><a href="#UniFi-Network-Applicationのセットアップの前提" class="headerlink" title="UniFi Network Applicationのセットアップの前提"></a>UniFi Network Applicationのセットアップの前提</h2><p>「<a href="/2022/08/27/ubiquiti-unifi/" title="Ubiquiti UniFiの世界">Ubiquiti UniFiの世界</a>」ではUniFiの機能全般を説明しました。UniFi Network Applicationをセットアップする以前に製品の情報やアップデートの情報は全てUbiquitiの提供するCommunityから入手します。英語のコミュニティサイトではSOHOなどのユーザーはUDM Proなどのセキュリティゲートウェイに、スイッチ、APを組み合わせているケースが多く見られます。スイッチユーザーは、もう少し大きな規模のユーザーがネットワークアプリケーションをLinuxで構築しているユーザーが多いように見えます。実際に顧客にサービスを提供しているSIerやエンジニアの参加もあります。コミュニティの情報・不具合などの割合から見ると、ネットワークアプリケーションの機能とスイッチの情報が圧倒的に多いように見え、セキュリティゲートウェイの質問やセキュリティそのものに関する技術的な内容は少ないように見えます。</p><p>手っ取り早くUniFi機器を稼働させるには、Windows、macOSのUniFi Network Applicationをセットアップし、動作させることです。</p><p>基本的には24時間稼働させ、スイッチ&#x2F;APからリアルタイムで情報を収集したり、スイッチ&#x2F;APに必要な動作を指示するのがConsole&#x2F;Network Applicationの役目です。Linux上（Debian&#x2F;Ubuntu）にセットアップされるケースが多いようです。わざわざLinuxのセットアップをするのは手間だと思えますが、運用を継続することを考えると、Linuxへのセットアップがお勧めです。また、バックアップや設定変更で動作しなくなった時のロールバックを考えると仮想環境（ESXi）にセットアップされることをお勧めします。Ubuntuの最新バージョンであるUbuntu22.04LTSはサポート期間が2027年までと十分長い期間があります。UniFiのためのUbuntuのセットアップ記事は「<a href="/2022/09/23/ubuntu22-04lts/" title="Ubuntu22.04LTSをESXiにセットアップする">Ubuntu22.04LTSをESXiにセットアップする</a>」を参照してください。</p><p>ローカル環境のみのアクセス（オンプレミス）、リモート（スマホアプリ）から管理可能なハイブリッドクラウド方式がありますが、ここではハイブリッドクラウド方式で進めます。クラウドはUbiquitが提供する無償のサービスです（※有償のUbiquitiクラウド管理の方式もあります）。基本的には機器のCPU、メモリ使用量、温度管理に加え、スマホへの通知やリモートによる機器のリスタート、アップグレード、高い利便性があります。</p><p>UniFiはAppleのiPhoneのように説明書が無くても使えることを目標にしているのでしょうか。難しいスイッチなどのコマンドラインを必要としませんが、マニュアルというものがありません。文末に示すコミュニティなどの情報を参考にしてください。徐々に日本語向けガイドも整備されてきています。</p><p>この記事ではUbuntuに具体的にネットワークアプリケーションをセットアップする方法を記載していますが、最初に日本語のガイドを参照されることをお勧めします。より詳細の手順としてこの記事を参考にされることをお勧めします。Ubiquitiの公式ではUniFiコンソールを購入してセットアップする事が推奨されています。</p><blockquote><p>UI Japan サポートセンター UniFiの導入<br> <a href="https://help.jp.ui.com/articles/360012192813/">https://help.jp.ui.com/articles/360012192813/</a></p></blockquote><blockquote><p>UniFi Network - コンソールなしでUniFi Networkをセルフホスティングする（高度）<br> <a href="https://help.jp.ui.com/articles/360012282453/">https://help.jp.ui.com/articles/360012282453/</a></p></blockquote><p>この記事では、公式で記載されている方法ではなく、有志が作成したスクリプトを用いてセットアップします。</p><h3 id="UniFi-Networkのリモートアクセス"><a href="#UniFi-Networkのリモートアクセス" class="headerlink" title="UniFi Networkのリモートアクセス"></a>UniFi Networkのリモートアクセス</h3><p>Requirementとして以下のドキュメントがあります。</p><blockquote><p>UniFi Network - リモートアクセスの要件<br> <a href="https://help.jp.ui.com/articles/115012240067/">https://help.jp.ui.com/articles/115012240067/</a></p></blockquote><p>説明は至ってシンプルです。UIシングルサインオンアカウント、インターネットに接続されているネットワークアプリケーションホストが必要とあります。<br>よくあるトラブルとしては、Port解放の問題、DNS、NTPへの接続が必要という項目があります。また、コミュニティのリリースポストを参照してほしいとあります。</p><p>UniFiの環境は慣れるまでは理解するのが大変ですが、その世界観を理解できれば1つ1つは難しくありません。</p><h3 id="UIシングルサインオンアカウントの作成"><a href="#UIシングルサインオンアカウントの作成" class="headerlink" title="UIシングルサインオンアカウントの作成"></a>UIシングルサインオンアカウントの作成</h3><p>早速、Ubiquitiのシングルサインオンアカウントを作成しましょう。アカウントの作成は無償です。</p><p><a href="https://account.ui.com/register">https://account.ui.com/register</a></p><p>ユーザー名、メールアドレス、パスワードが必要です。ユーザー名は他のユーザーと重複しない名前が必要です。一度決定するとこのユーザー名でローカル環境もログインする事になります。</p><img src="/new-technology/2022/09/23/unifi-network-application/unifi4.png" class="" width="360" title="alt"><p>登録が完了すると以下の画面になります。</p><img src="/new-technology/2022/09/23/unifi-network-application/unifi6.png" class="" width="360" title="alt"><p>登録したメールアドレスに”Email Verification”が行きますのでVerifyしてください。</p><h2 id="UniFi-Consoleの要件"><a href="#UniFi-Consoleの要件" class="headerlink" title="UniFi Consoleの要件"></a>UniFi Consoleの要件</h2><ul><li>2 GHz dual core processor(2vCPU)</li><li>4 GiB RAM (system memory)</li><li>64 GB Disk</li></ul><p>UniFi Network Applicationに対してはユーザーからのWebサービス、スイッチからネットワークアプリケーションへの接続などがあり、いくつかのサーバーPortをオープンしておく必要があります。Ubuntuと言われるとWindows上のWSL2を思い浮かべますが、WindowsOS上にPort Forwardの設定を行う必要があり、通常のUbuntuより余計な手間が掛かるためWSL2はお勧めしません。</p><p>UniFi Network ApplicationではMongoDB&#x2F;Java11を使います。これらのミドルウェアの利用はアプリケーション内部の組み込み型モジュールとして考えるべきでもあり、セキュリティの観点からは可能な限りUbuntu上の公開ポートを制限すべきです。従い、UbuntuはUniFiネットワークアプリケーション専用として利用し、必要なPort以外は閉じます。</p><p>実際のインストールは有志が作成した素晴らしいシェルスクリプトが公開されており、悩むことなくセットアップは完了します。</p><p>UniFi Network Applicationのバージョンアップはインストール同様にシェルスクリプトを動作させます。また、UniFi Network Applicationはロールバックに対応していないため、何か問題があった場合に旧環境に戻すにはアンインストール、インストールをするかESXiのレベルでスナップショットからの戻し、または仮想マシンごとのバックアップからの戻しをします。ESXiによるOSのロールバックは非常に手軽なため、万が一の際はOSレベルでのレストアが早く確実です。</p><blockquote><p>Oracle Java<br> <a href="https://www.oracle.com/jp/java/technologies/java-se-support-roadmap.html">https://www.oracle.com/jp/java/technologies/java-se-support-roadmap.html</a></p></blockquote><blockquote><p>MongoDB<br> <a href="https://www.mongodb.com/support-policy/lifecycles">https://www.mongodb.com/support-policy/lifecycles</a></p></blockquote><h2 id="Ubuntuの事前準備"><a href="#Ubuntuの事前準備" class="headerlink" title="Ubuntuの事前準備"></a>Ubuntuの事前準備</h2><p>ここでは「<a href="/2022/09/23/ubuntu22-04lts/" title="Ubuntu22.04LTSをESXiにセットアップする">Ubuntu22.04LTSをESXiにセットアップする</a>」で記載したようにUbuntuがESXi上にセットアップされ、ESXiのUbuntuにVMware Remote Consoleで接続して操作する事を前提としています。ESXiのWebUIにログインし、Ubuntuの仮想マシンに対してVMRCで接続するか、ブラウザから、<code>vmrc://ユーザー名@esxiのホスト名/?moid=[仮想マシンのID]</code>で接続します（VMRCウィンドウが起動します）。クライアントへのVMRCのインストールはESXiのWebUIからダウンロードできます。</p><h3 id="Ubuntuの固定IPアドレスの設定"><a href="#Ubuntuの固定IPアドレスの設定" class="headerlink" title="Ubuntuの固定IPアドレスの設定"></a>Ubuntuの固定IPアドレスの設定</h3><p>UniFiの機器から、或いはWeb Consoleとして常に同一のIPアドレスに接続するために固定IPアドレス、またはDHCPの配布でmacアドレスを元に常に同じIPアドレスを配布するように設定します。Ubuntu上で固定IPにするには、<mark class="label primary">設定</mark>画面の<mark class="label primary">ネットワーク</mark>で固定IPを設定します。</p><img src="/new-technology/2022/09/23/unifi-network-application/unifi15.png" class="" width="640" title="alt"><p>UniFi Network Applicationでは現時点でIPv4のみを利用しIPv6は未対応と考えてください。個々のスイッチ&#x2F;APはもちろんIPv6通信に対応していますが、機器本体の管理をIPv4で行います。</p><h3 id="ufwの設定"><a href="#ufwの設定" class="headerlink" title="ufwの設定"></a>ufwの設定</h3><p>UniFi Consoleで最低限のPortを開けるため、UbuntuのFirewallであるufwを設定します。Ubuntuの<mark class="label primary">端末</mark>を起動します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw status</span><br><span class="line">状態: 非アクティブ</span><br><span class="line">$</span><br></pre></td></tr></table></figure><p>ufwを有効にします。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw <span class="built_in">enable</span></span><br><span class="line">ファイアウォールはアクティブかつシステムの起動時に有効化されます。</span><br></pre></td></tr></table></figure><p>再度状態確認します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw status</span><br><span class="line">状態: アクティブ</span><br><span class="line">$</span><br></pre></td></tr></table></figure><div class="note danger"><p>ESXiやVMRCを使わずSSHで接続しufwを有効にする場合は、SSHポート（22&#x2F;TCP)を許可しておかないと新しいSSHの接続ができません。再起動などのタイミングでSSHできず面倒になるのでご注意ください。なお、UniFi Network Applicationのセットアップ途中でSSHポートを開けます。</p></div><p>ufwを有効化しただけでは外部へ接続する方向へは制限しませんが、UbuntuのFirefoxでInternetに接続可能な状態である事を確認します。セキュリティ機器やFirewall機器で<strong>Outbound通信</strong>に厳密な管理をされている方は以下の記事を参考に必要なPortを開けてください。UniFi Network ApplicationのセットアップにはInternetへの接続が必要です。Internetから内部にポート解放する必要はありません。</p><blockquote><p>UniFi - Setting Up a UniFi OS Console<br> <a href="https://help.ui.com/hc/en-us/articles/4416276882327-UniFi-Setting-Up-a-UniFi-OS-Console">https://help.ui.com/hc/en-us/articles/4416276882327-UniFi-Setting-Up-a-UniFi-OS-Console</a></p></blockquote><h2 id="UniFi-Network-Applicationのインストール"><a href="#UniFi-Network-Applicationのインストール" class="headerlink" title="UniFi Network Applicationのインストール"></a>UniFi Network Applicationのインストール</h2><p>スクリプトの情報は、Ubiquiti本国のコミュニティにあります。<br><a href="https://community.ui.com/questions/UniFi-Installation-Scripts-or-UniFi-Easy-Update-Script-or-UniFi-Lets-Encrypt-or-UniFi-Easy-Encrypt-/ccbc7530-dd61-40a7-82ec-22b17f027776">https://community.ui.com/questions/UniFi-Installation-Scripts-or-UniFi-Easy-Update-Script-or-UniFi-Lets-Encrypt-or-UniFi-Easy-Encrypt-/ccbc7530-dd61-40a7-82ec-22b17f027776</a></p><p>セットアップで失敗した際にすぐに戻れるように、このタイミングでESXiのスナップショット、またはバックアップの取得をお勧めします。</p><p>実行は3ステップです。Ubuntuの<mark class="label primary">端末</mark>から、以下のコマンドを実行します。</p><ol><li><p>管理者になります</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo -i</span><br></pre></td></tr></table></figure></li><li><p>証明書などのダウンロードをします。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ apt-get update; apt-get install ca-certificates wget -y</span><br></pre></td></tr></table></figure></li><li><p>ネットワークアプリケーションのセットアップを行います。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">rm</span> unifi-latest.sh &amp;&gt; /dev/null; wget https://get.glennr.nl/unifi/install/install_latest/unifi-latest.sh &amp;&amp; bash unifi-latest.sh</span><br></pre></td></tr></table></figure><p>必要なモジュールをインストールし、最新のUniFi Network Applicationをインストールしていきます。何回かユーザーとコマンド上の対話があります。全て”Y”を回答します。</p></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Do you want to keep the script on your system after completion? (Y/n)</span></span><br></pre></td></tr></table></figure><p>“Y”を入力しEnterを押下します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Do you want to proceed with updating your system? (Y/n)</span></span><br></pre></td></tr></table></figure><p>“Y”を入力しEnterを押下します。その後いくつかのモジュールがセットアップされていきます。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Preparing for MongoDB installation...</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Adding key for MongoDB 3.6...</span></span><br><span class="line"><span class="comment"># Successfully added key for MongoDB 3.6!</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Running apt-get update...</span></span><br><span class="line"><span class="comment"># Successfully ran apt-get update!</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Installing mongodb-org version 3.6...</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Preparing OpenJDK 8 installation...</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Installing openjdk-8-jre-headless...</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Installing your UniFi Network Application ( 7.2.94 )...</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Downloading the UniFi Network Application...</span></span><br><span class="line"><span class="comment"># Successfully downloaded application version 7.2.94!</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Installing the UniFi Network Application...</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Would you like to update the UniFi Network Application via APT?</span></span><br><span class="line"><span class="comment"># Do you want the script to add the source list file? (Y/n)</span></span><br></pre></td></tr></table></figure><p>“Y”を入力しEnterを押下します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Is/will your application only be used locally ( regarding device discovery )? (Y/n)</span></span><br></pre></td></tr></table></figure><p>あなたのアプリケーションはディスカバリにおいてローカル環境だけで使いますか？という質問ですが、これはスクリプトの中身を見る限りは、”Y”を選択しないと、ufwの10001&#x2F;udpを開けないので、”Y”を選択します。10001&#x2F;UDPを開けないとローカル環境のUniFi機器を見つけられません。AWSなどのクラウド上にネットワークアプリケーションをセットアップする場合、ローカルのUniFi機器を直接UniFi Network Applicationに向かわせる方法もあり、その場合はクラウド上のローカルネットワークに不要なポートを公開しないための設定と考えられます。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Do you want to add the required ports for your UniFi Network Application? (Y/n)</span></span><br></pre></td></tr></table></figure><p>“Y”を入力しEnterを押下します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Successfully added port 3478/udp to UFW.</span></span><br><span class="line"><span class="comment"># Successfully added port 8080/tcp to UFW.</span></span><br><span class="line"><span class="comment"># Successfully added port 8443/tcp to UFW.</span></span><br><span class="line"><span class="comment"># Successfully added port 8880/tcp to UFW.</span></span><br><span class="line"><span class="comment"># Successfully added port 8843/tcp to UFW.</span></span><br><span class="line"><span class="comment"># Successfully added port 6789/tcp to UFW.</span></span><br><span class="line"><span class="comment"># Successfully added port 10001/udp to UFW.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Your SSH port ( 22 ) doesn&#x27;t seem to be in your UFW list..</span></span><br><span class="line"><span class="comment"># Do you want to add your SSH port to the UFW list? (Y/n)</span></span><br></pre></td></tr></table></figure><p>UniFiに必要なポートを開け、さらにSSHも開けますか？と聞かれるので”Y”を入力しEnterを押下します。</p><p>最後に以下の表示でスクリプトは終了します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># UniFi Network Application 7.2.94 has been installed successfully</span></span><br><span class="line"><span class="comment"># Your application address: https://192.168.xxx.222:8443</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># UniFi is active ( running )</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Author   |  Glenn R.</span></span><br><span class="line"><span class="comment"># Email    |  glennrietveld8@hotmail.nl</span></span><br><span class="line"><span class="comment"># Website  |  https://GlennR.nl</span></span><br></pre></td></tr></table></figure><p>とても素晴らしいシェルスクリプトです。Glenn R氏に深謝です。<br>最後の”Your application address:”にあるように、クライアントのブラウザから<code>https://UbuntuのIPアドレス:8443</code>に接続します。</p><h2 id="UniFi-ネットワークアプリケーションのセットアップ"><a href="#UniFi-ネットワークアプリケーションのセットアップ" class="headerlink" title="UniFi ネットワークアプリケーションのセットアップ"></a>UniFi ネットワークアプリケーションのセットアップ</h2><p>ここからはしばらくUbuntuは操作しません。WindowsやmacOS、スマホなどのクライアントから<code>https://UbuntuのIPアドレス:8443</code>に接続します。独自証明書のため、ブラウザのエラーが表示されますが、「危険を理解して進む」などをクリックして画面を開きます。UniFi Network ApplicationのSSL対応は別の機会に記事を書きます。</p><p>以下では規約に同意するチェックを入れ、”Next”で進みます。</p><img src="/new-technology/2022/09/23/unifi-network-application/unifi7.png" class="" width="480" title="alt"><p>ここでは、<mark class="label primary">Switch to Advanced Setup</mark>をクリックします。</p><img src="/new-technology/2022/09/23/unifi-network-application/unifi8.png" class="" width="480" title="alt"><mark class="label primary">Advanced remote and local access</mark>では、以下のようにリモートアクセスとUIシングルサインオンアカウントのトグルスイッチをOnにした状態で"Next"で進みます。<img src="/new-technology/2022/09/23/unifi-network-application/unifi8-1.png" class="" width="480" title="alt"><p>UIシングルサインオンアカウントでログインします。</p><img src="/new-technology/2022/09/23/unifi-network-application/unifi8-2.png" class="" width="480" title="alt"><p>ここではバックアップを有効にします。</p><img src="/new-technology/2022/09/23/unifi-network-application/unifi8-3.png" class="" width="480" title="alt"><p>デバイスセットアップです。ここで新しいUniFiのハードウェアがネットワークアプリケーションのサブネット内で接続状態であれば、自動的に検出します。ただし、ネットワークアプリケーションで最初にネットワークアドレスを設定する必要があり、ここではデバイスのセットアップをせずに、”Next”で進みます。</p><img src="/new-technology/2022/09/23/unifi-network-application/unifi9.png" class="" width="640" title="alt"><p>WiFiセットアップです。UniFiのAPがある場合はここでWiFiセットアップが可能ですが、スキップし”Next”で進みます。</p><img src="/new-technology/2022/09/23/unifi-network-application/unifi10.png" class="" width="640" title="alt"><p>確認画面です。所在地である日本を選択し、”Finish”で完了します。</p><img src="/new-technology/2022/09/23/unifi-network-application/unifi11.png" class="" width="800" title="alt"><p>ここまで完了すると初期画面が表示されます。</p><img src="/new-technology/2022/09/23/unifi-network-application/unifi12.png" class="" width="800" title="alt"><h2 id="UniFi-ネットワークアプリケーションの初期設定"><a href="#UniFi-ネットワークアプリケーションの初期設定" class="headerlink" title="UniFi ネットワークアプリケーションの初期設定"></a>UniFi ネットワークアプリケーションの初期設定</h2><p>最初にUniFiネットワークアプリケーションのネットワークアドレスと動作モードを設定します。<br>ネットワークアプリケーションの左下の歯車アイコンをクリックし、<mark class="label primary">Networks</mark>を選択します。</p><img src="/new-technology/2022/09/23/unifi-network-application/unifi13.png" class="" width="800" title="alt"><p>最初のネットワークアドレスは”192.168.1.0&#x2F;24”となっていますのでこれを修正します。</p><img src="/new-technology/2022/09/23/unifi-network-application/unifi13-1.png" class="" width="480" title="alt"><mark class="label primary">Auto Scale Network</mark>のチェックを外し、実際のルーターのLAN側IPアドレスを入力します。<img src="/new-technology/2022/09/23/unifi-network-application/unifi13-2.png" class="" width="480" title="alt"><p>続いて<mark class="label primary">Advanced Configuration</mark>では、今回のようにセキュリティゲートウェイなどのUniFi Consoleがありませんが、デフォルトではセキュリティゲートウェイがDHCPを提供するDHCPサーバーモードとなっています。</p><img src="/new-technology/2022/09/23/unifi-network-application/unifi13-3.png" class="" width="480" title="alt"><p>ここでは、DHCPモードを”無し”にし、”Apply Changes”で変更を完了させます。</p><img src="/new-technology/2022/09/23/unifi-network-application/unifi13-4.png" class="" width="480" title="alt"><p>左側の丸い二重丸のアイコン（UniFiAPのシンボルです）からは、新しいUniFi機器のAdoptが可能な状態になっています。</p><img src="/new-technology/2022/09/23/unifi-network-application/unifi14.png" class="" width="480" title="alt"><p>Ubuntuを再起動後してみてください。再度ブラウザでUniFi管理画面にログインできること、UbuntuにSSH可能である事を確認しましょう。<br>7.4.156からは日本語UIが使えるようになりました。</p><p>これでUniFiネットワークアプリケーションの設定は一旦完了です。もちろんこの段階で検出したスイッチを採用（Adopt）できますが、管理の主体はスマホアプリで可能なため、スマホアプリをインストールしていきましょう。</p><h2 id="UniFi-ネットワーク-スマホアプリ"><a href="#UniFi-ネットワーク-スマホアプリ" class="headerlink" title="UniFi ネットワーク スマホアプリ"></a>UniFi ネットワーク スマホアプリ</h2><p>UniFiの使い勝手の良さはスマホアプリにあります。スマホアプリからUniFiネットワークアプリケーションを制御します。普段はスマホアプリがあれば大抵は事足ります。アプリストアから”UniFi Network&#x2F;Ubiquiti Inc”を見つけスマホにアプリをインストールします。</p><ul><li><p>Apple iOS</p> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKUAAAClCAAAAAAYQGIGAAAB90lEQVR42u3a0W7DIAxG4b7/S2d3mzQFc36Stg46XHUqK18rEYzt12s+jt/x9+dwyr/J9aeczVsdKlV+R3mMBiXQrzR8txaoVNlcebbccKV6Mti79MGhUuVOyuFKgBWtoVLldsrhIZq/UqlyE2UdXy4ef/U3vD0KVqny40p6tr3v1U0ZGJUqP6k84KDnGN2nRzJUqmypBHstQtOzMlpXpcqWymHaL0qBL558dc5x/DOqVNlCuXj/ispQUXWX/KAqVbZQggxEdExGm5/GoSpV9lWCPEbe5FAfrHVtaxIAq1TZRxkluekVbfEWhy95KlV+W0n7FmiNqQ5VF8tVKlW2VNZ58HylesdGrUmT7L9KlX2U0edfrk9lNzaVKh+ljPb9PQHlJHWpUmUz5WL5NbqigZgzK02pVNlCmd+XorwIzUxM5qlU2VYZpekWWyBApEmaIVSq7KO8nA8E8qgtYvyQUKmyrRLs7LzvCISloKFVpconKPGGm8eXeTF2kp1XqfJRSrpwvQhNhEyeNypVNlMecFzJkkcVqNPJKlV2VNIMXV64ilL79D9UquymBG11N27qPFuhUmVzZdTfsJgyzFMiKlVuosx3O2ifoJUqlSo3UdJmCFywBXyVKtsq6/gyajkC8SVti1CpsrkyCvZAkSq6f9EAVaXKZsofDWwJqEp4wN0AAAAASUVORK5CYII=" alt="UniFi Network" title="" class="title: UniFi Network"><p> <a href="https://apps.apple.com/jp/app/unifi-network/id1057750338">https://apps.apple.com/jp/app/unifi-network/id1057750338</a></p></li><li><p>Android</p> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALkAAAC5CAAAAABRxsGAAAACV0lEQVR42u3bS46EMAxF0dr/pqtnNUAkuc9BLRHfjFrF74CEcRz357Me39+4/Ha3y2Xc7Ty8Bt0ZD+XKz5CDC893Kd4SuIfFscqVt5HTt53e0vzm5k8HqJQrV559vOeBY54+3KUZypUrr8YW8BuVD73KlSvPJsAgeoAUAGx9cmahXPnr5Xn96T/+eqg6p1z5m+XRLPiZ2AK++QSkXHkHOXifd77qxdozXrNSrvxwOV31yddq6fnAhtudlSvvIM9XaUBsmacKO7UwUv5Wrvw0efTxBlXjPCsHbVfjHEK58nPltKWCzn2jdVkadMZPWrnyw+Xzrzp42yPlfM4N8vPbAKNc+bnyyAGy7bwWVg0wypW3kRe/9OAwKgfhTLnyjvJ5sRmUogvJxkZ+vphGK1d+rpy+1BG6GKboDEG58mby6GBQbAaxCjSDkNK5cuXnyvP2p6gqBq4BWjTImZUrP00ODo6WZIuVssJ1lSvvJQeOqC0i6nKKopZy5crJ/5p+1iPvlaK3rlx5H/lOsXln8hy1d1zPolx5B3lhgr0m7Eyoo1ZK5cpbyHEH0rqRgk6F6aLSIvVQrryNHLzZeQ9U1H+RNUIpV95anndO0AJ0VJlePDHlytvI8+ZB2iAxjw9RzUy58mbyLxzZK79eWaI5xDgdUa68g5y+ylnaDFOAfBk5ikHKlR8ip+cCX/VqAlKMLcqVt5HnjQ9Rsap4cyS2KFeunG4F7RjzZADUwZUrV57FlnwrnRKQdSLlyjvIix2EO7GFZgnjnZUr7yCPsmM6g366ql0YypW/Xf4Hl2yz0I8KdVwAAAAASUVORK5CYII=" alt="UniFi Network" title="" class="title: UniFi Network"><p> <a href="https://play.google.com/store/apps/details?id=com.ubnt.easyunifi&amp;hl=en_US&amp;gl=US">https://play.google.com/store/apps/details?id=com.ubnt.easyunifi&amp;hl=en_US&amp;gl=US</a></p></li></ul><p>ここではiPhoneで操作します。”Set up a New Device”をタップします</p><img src="/new-technology/2022/09/23/unifi-network-application/app1.png" class="" width="280" title="alt"><p>ネットワークを検索しに行きます</p><img src="/new-technology/2022/09/23/unifi-network-application/app2.png" class="" width="280" title="alt"><p>UniFi OS Consoleは存在していないので見つけられません。”Set up a connection by IP address”でUniFi Network ApplicationのIPアドレスを指定します。</p><img src="/new-technology/2022/09/23/unifi-network-application/app3.png" class="" width="280" title="alt"><p>UniFi Network ApplicationのIPアドレス、UIシングルサインオンアカウントのIDとパスワードを指定します。</p><img src="/new-technology/2022/09/23/unifi-network-application/app4.png" class="" width="280" title="alt"><p>しばらく経ってから、UniFi Network Applicationを見つけるので、”Proceed”をタップします。</p><img src="/new-technology/2022/09/23/unifi-network-application/app5.png" class="" width="280" title="alt"><p>無事ログインが完了し、早速Adopt可能なデバイスが表示されます。Adoptしてみます。”Set Up”をタップします。</p><img src="/new-technology/2022/09/23/unifi-network-application/app6.png" class="" width="280" title="alt"><p>“Next”をタップします。</p><img src="/new-technology/2022/09/23/unifi-network-application/app7.png" class="" width="280" title="alt"><p>デバイスを採用中です。しばらく待ちます。少し時間が掛かります。ここではデバイスの採用と最新ファームウェアのダウンロード、適用が行われます。</p><img src="/new-technology/2022/09/23/unifi-network-application/app8.png" class="" width="280" title="alt"><p>デバイスの採用が完了すると、以下の画面になります。”Go to Dashboard”をタップします。</p><img src="/new-technology/2022/09/23/unifi-network-application/app9.png" class="" width="280" title="alt"><p>Top画面です</p><img src="/new-technology/2022/09/23/unifi-network-application/app10.png" class="" width="280" title="alt"><p>UniFiデバイスの画面をタップすると、採用されたスイッチが見えます。</p><img src="/new-technology/2022/09/23/unifi-network-application/app11.png" class="" width="280" title="alt"><p>スイッチのPortの状況です。GbEでアップリンク（上流のネットワーク）に接続されています。</p><img src="/new-technology/2022/09/23/unifi-network-application/app12.png" class="" width="280" title="alt"><p>アプリの歯車アイコン（System）から”Network Application Configuration”を選択します。以下のHostname&#x2F;IPとなっている場所にネットワークアプリケーションのIPアドレスを設定しておきます。</p><img src="/new-technology/2022/09/23/unifi-network-application/app12-1.png" class="" width="280" title="alt"><h2 id="UniFiネットワーク経由のログイン"><a href="#UniFiネットワーク経由のログイン" class="headerlink" title="UniFiネットワーク経由のログイン"></a>UniFiネットワーク経由のログイン</h2><p>UniFiスマホアプリを終了し、Wi-Fiをオフにしてから再びアプリを起動します。今度は”Log in to Your UI Account”をタップし、UIシングルサインオンアカウントでログインします。</p><img src="/new-technology/2022/09/23/unifi-network-application/app13.png" class="" width="280" title="alt"><p>接続に少し時間が掛かりますが、Ubiquitiのクラウド経由でローカルのUniFiネットワークアプリケーションに接続され、スイッチや接続されたクライアントの状態が把握可能となります。厳密にはUbiquitiクラウドからスマホのパブリックIPアドレスを取得し、UniFi Network Applicationからスマホアプリへの直接接続を行うようです。</p><h2 id="2要素認証"><a href="#2要素認証" class="headerlink" title="2要素認証"></a>2要素認証</h2><p>ハイブリッドクラウドで外部からログインができるようになったので、2要素認証を設定します。ブラウザで<code>&lt;https://account.ui.com/&gt;</code>に接続します。</p><p>“My Security”をタップします。</p><img src="/new-technology/2022/09/23/unifi-network-application/verify1.png" class="" width="280" title="alt"><p>Multi Factor Authentication(MFA)をEnableにします。</p><img src="/new-technology/2022/09/23/unifi-network-application/verify2.png" class="" width="280" title="alt"><p>”UI Verify”アプリを選択します。</p><img src="/new-technology/2022/09/23/unifi-network-application/verify3.png" class="" width="280" title="alt"><p>UI VerifyアプリをダウンロードしAppを構成します。</p><img src="/new-technology/2022/09/23/unifi-network-application/verify4.png" class="" width="280" title="alt"><p>2要素認証が完了し、アプリが使えない場合のメールアドレスへの通知が2要素認証のバックアップとして利用されます。</p><img src="/new-technology/2022/09/23/unifi-network-application/verify5.png" class="" width="280" title="alt"><p>これで2要素認証が必須となり、UniFi Networkスマホアプリでは初回の認証時にUI Verifyアプリへのプッシュ通知が行われます。ユーザーが確認の応答を実施しログインが完了します。ローカル環境でブラウザなどからネットワークアプリケーションにログインする際や、UIアカウントサイトにログインする場合も2要素認証が求められ、UI Verifyアプリで応答する必要があります。</p><img src="/new-technology/2022/09/23/unifi-network-application/verify6.png" class="" width="280" title="alt"><h2 id="ufwのGUI"><a href="#ufwのGUI" class="headerlink" title="ufwのGUI"></a>ufwのGUI</h2><p>Ubuntuで今回設定したufwの設定を追加する場合、GUIによるツールを導入しておくと便利です。<mark class="label primary">Ubuntu Software</mark>から”gufw”を探し、インストールします。</p><img src="/new-technology/2022/09/23/unifi-network-application/ubuntu1.png" class="" width="640" title="alt"><h2 id="SSH"><a href="#SSH" class="headerlink" title="SSH"></a>SSH</h2><p>ここではUbuntuにSSHする説明は割愛しますが、Ubiquiti日本語ガイドにSSHについての記載がありますので参照してください。</p><blockquote><p>UniFi - SSHでログイン（高度）<br> <a href="https://help.jp.ui.com/articles/204909374/">https://help.jp.ui.com/articles/204909374/</a></p></blockquote><h2 id="セットアップの完了"><a href="#セットアップの完了" class="headerlink" title="セットアップの完了"></a>セットアップの完了</h2><p>ここまででUniFiのセットアップは完了です。ESXiのスナップショットを取得していらした方はスナップショットの管理から「すべて削除」し、一旦、Ubuntu全体のバックアップを取得される事をお勧めします。次の記事「<a href="/2022/10/23/unifi-network-application2/" title="UniFi Network Applicationの運用">UniFi Network Applicationの運用</a>」で、UniFi Network Applicationの運用全般（設定のバックアップ、アップデート、通知）を紹介します。</p><h2 id="リソース"><a href="#リソース" class="headerlink" title="リソース"></a>リソース</h2><p>以下の日本語ヘルプ、コミュニティがUniFiの構築には大いに参考になります。</p><blockquote><p>Ubiquiti コミュニティ（日本）<br> <a href="https://www.facebook.com/groups/uijapan">https://www.facebook.com/groups/uijapan</a></p></blockquote><blockquote><p>UI 日本語ヘルプ記事<br> <a href="https://help.jp.ui.com/categories/6583256751383/">https://help.jp.ui.com/categories/6583256751383/</a></p></blockquote><blockquote><p>Ubiquiti Community（米国中心）<br> <a href="https://community.ui.com/">https://community.ui.com/</a></p></blockquote>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2022/09/23/unifi-network-application/unifi1.png&quot; class=&quot;&quot; width=&quot;1024&quot; title=&quot;alt&quot;&gt;

&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;

&lt;p&gt;米国Ubiquiti（ユビキティ）社のUniFi製品であるネットワークスイッチ、Wi-Fiアクセスポイントを利用するには、管理コンソールとしてUniFi OS ConsoleまたはUniFi Network Applicationが必要となります。UniFi Network ApplicationはUbiquitiより無償提供されており、管理・運用においてはUniFiクラウドサービスと連携します。一般的にはこのようなサービスはサブスクリプション費用が必要ですが、この費用も掛かりません。UniFi製品はネットワークの見える化に特化しているため、管理コンソールの24時間稼働が理想です。最初からハード組み込みのセキュリティ機器（UniFi Security Gateway等）やUniFi Cloud Keyを購入すればすぐにUniFi製品を使い始めることができますが、これらのハードウェアを購入しなくとも、ネットワークやLinuxの知識がある人はUniFi Network Applicationをセットアップし、使い始めることができます。&lt;/p&gt;</summary>
    
    
    
    <category term="Network" scheme="https://yoshi0808.github.io/new-technology/categories/Network/"/>
    
    
    <category term="UniFi" scheme="https://yoshi0808.github.io/new-technology/tags/UniFi/"/>
    
  </entry>
  
  <entry>
    <title>Ubuntu22.04LTSをESXiにセットアップする</title>
    <link href="https://yoshi0808.github.io/new-technology/2022/09/23/ubuntu22-04lts/"/>
    <id>https://yoshi0808.github.io/new-technology/2022/09/23/ubuntu22-04lts/</id>
    <published>2022-09-22T15:00:00.000Z</published>
    <updated>2023-06-17T23:25:32.356Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2022/09/23/ubuntu22-04lts/title.png" class="" width="1024" title="alt"><p class="onepoint">この記事で実現すること</p><p>この記事では24時間稼働させるサーバーとして、intel&#x2F;AMDの<strong>ESXi</strong>上にUbuntuをセットアップするケースを想定しています。従来のSSHで接続するコマンドラインベースだけではなく、WindowsやmaOSから<strong>GUIで接続するUbuntu環境</strong>になります。長期サポートの最新バージョンであるUbuntu22.04LTSを仮想環境であるESXi7.0上に導入します。リモートデスクトップに相当するクライアントソフトウェアはESXiに付属する<strong>VMware Remote Console</strong>(VMRC)を使います。Ubuntu22.04LTSのEOLは2027年4月であり、十分に長い期間のサポートがあります。</p><span id="more"></span><h2 id="ESXiにおけるUbuntuのセットアップのポイント"><a href="#ESXiにおけるUbuntuのセットアップのポイント" class="headerlink" title="ESXiにおけるUbuntuのセットアップのポイント"></a>ESXiにおけるUbuntuのセットアップのポイント</h2><p>サーバーとして動作させるUbuntuをESXiおよびVMRCで仮想マシンを操作する事のメリットはトラブルに強いという事でしょうか。直接ハードウェアにインストールする（いわゆるベアメタル）方式ですと、IPアドレス周りの設定変更で失敗するとSSHで繋がらなくなり、ディスプレイに本体を繋いでリカバリするなど面倒です。VMRCはESXi本体に接続し操作するため、仮想マシン上のネットワークがダウンしていても操作可能です。特に複数VLANに跨いだ環境を構築したり、ファイアウォール(ufw)を設定する場合はトラブルになりやすいため、復旧しやすい構成を目指します。</p><p>Requirements:</p><p>Ubuntu Desktop Edition<br>2 GHz dual core processor<br>4 GiB RAM (system memory)<br>25 GB (8.6 GB for minimal) of hard-drive space (or USB stick, memory card or external drive but see LiveCD for an alternative approach)<br>VGA capable of 1024x768 screen resolution<br>Either a CD&#x2F;DVD drive or a USB port for the installer media<br>Internet access is helpful</p><blockquote><p>Ubuntu documentation<br> <a href="https://help.ubuntu.com/community/Installation/SystemRequirements">https://help.ubuntu.com/community/Installation/SystemRequirements</a></p></blockquote><p>実際には、動かすアプリケーションを想定し、CPU、メモリ、ストレージを増やしておくことになるでしょう。ここでは、一例として、2vCPU、4GBメモリ、64GBストレージで進めます。</p><p>また、Ubuntuのパッチ管理のために、Ubuntu Oneアカウントの申請および、ライセンス（個人利用は無償）の取得が必要となります（後述します）。</p><p>環境面の前提としては、仮想マシンからDHCPでIPアドレスおよびDNSが取得でき、インターネットに接続可能な環境とします。</p><h2 id="Ubuntu22-04LTSのダウンロード"><a href="#Ubuntu22-04LTSのダウンロード" class="headerlink" title="Ubuntu22.04LTSのダウンロード"></a>Ubuntu22.04LTSのダウンロード</h2><p>最初にUbuntu22.04LTSのダウンロードを行います。日本語Remix版を利用します。</p><blockquote><p>Ubuntu 22.04 LTS 日本語Remix<br> <a href="https://www.ubuntulinux.jp/News/ubuntu2204-ja-remix">https://www.ubuntulinux.jp/News/ubuntu2204-ja-remix</a><br> ファイル名は「ubuntu-ja-22.04-desktop-amd64.iso」です。</p></blockquote><h2 id="ESXiで仮想マシンを作成する"><a href="#ESXiで仮想マシンを作成する" class="headerlink" title="ESXiで仮想マシンを作成する"></a>ESXiで仮想マシンを作成する</h2><h3 id="ESXiへのisoファイルのアップロード"><a href="#ESXiへのisoファイルのアップロード" class="headerlink" title="ESXiへのisoファイルのアップロード"></a>ESXiへのisoファイルのアップロード</h3><p>ESXiのWebUIにログインします。<br>ESXiの左ペインメニューの<mark class="label primary">ストレージ</mark>から<mark class="label primary">データストアブラウザ</mark>を開き、そこにダウンロードしたUbuntuのisoファイル（ubuntu-ja-22.04-desktop-amd64.iso)をアップロードします。</p><h3 id="ネットワークポートグループの作成（任意）"><a href="#ネットワークポートグループの作成（任意）" class="headerlink" title="ネットワークポートグループの作成（任意）"></a>ネットワークポートグループの作成（任意）</h3><p>Ubuntuのネットワークで使うESXiのポートグループを用意します。新しく作成する場合は、左ペインメニューの<mark class="label primary">ネットワーク</mark>から<mark class="label primary">ポートグループの追加</mark>を選択し、該当するvSwitch上に新しいポートグループを作成します。</p><h3 id="仮想マシンの作成"><a href="#仮想マシンの作成" class="headerlink" title="仮想マシンの作成"></a>仮想マシンの作成</h3><p>左ペインメニューの<mark class="label primary">仮想マシン</mark>から、<mark class="label primary">仮想マシンの作成/登録</mark>をクリックし、<mark class="label primary">新規仮想マシンの作成</mark>を選択します。ここでは仮想マシンの名前と仮想マシンのバージョンによる互換性とゲストOSの種類を指定します。互換性は特に理由がなければ一番新しいものを選んでください。<mark class="label primary">ゲストOSファミリ</mark>は”Linux”を、<mark class="label primary">ゲストOSのバージョン</mark>は”Ubuntu Linxu(64ビット）”を選択します。</p><img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu1.png" class="" width="800" title="alt"><p>続いて仮想マシンを作成するストレージを選択します。</p><img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu1-1.png" class="" width="800" title="alt"><mark class="label primary">設定のカスタマイズ</mark>では、<mark class="label primary">仮想ハードウェア</mark>と<mark class="label primary">仮想マシンオプション</mark>があります。<mark class="label primary">仮想ハードウェア</mark>のタブでは、CPU、メモリ、ディスク、ネットワークアダプタ（上記で作成したポートグループ）を指定し、CD/DVDドライブの場所でUbuntuのisoファイルを選択します。ネットワークアダプタが10GbEの場合は、<mark class="label primary">ネットワークアダプタ1</mark>のプルダウンをクリックして"VMXNET3"が選択されていることを確認してください。<img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu2.png" class="" width="800" title="alt"><mark class="label primary">仮想マシンオプション</mark>の画面に移動し、VMWare Toolsのプルダウンを開き、<mark class="label primary">Toolsのアップグレード</mark>の<mark class="label primary">パワーオン前に毎回VMware Toolsをチェックしてアップグレード</mark>のチェックボックスをオンにします。また、<mark class="label primary">起動オプション</mark>では<mark class="label primary">ファームウェア</mark>に"EFI"を選択し、<mark class="label primary">この仮想マシンに対してUEFIセキュア ブートを有効にするかどうかを指定します</mark>のチェックボックスをオンにします。セキュアブートは必須ではありませんが、セキュリティ向上のためにお勧めします。<img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu3.png" class="" width="800" title="alt"><p>完了させたら、左ペインメニューの<mark class="label primary">仮想マシン</mark>から、対象の仮想マシンを起動します。もし、クライアント端末（Windows,macOS）にVMRCをダウンロードしていなければダウンロードし、クライアント上でセットアップしておきます。</p><img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu3-1.png" class="" width="800" title="alt"><mark class="label primary">仮想マシン</mark>を<mark class="label primary">パワーオン</mark>し、<mark class="label primary">リモートコンソールを起動</mark>します。VMRCのセットアップが完了していれば以下のようなウィンドウがブラウザから独立して起動します。<img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu4.png" class="" width="800" title="alt"><mark class="label primary">Ubuntuをインストール</mark>を選択します。<h3 id="Ubuntuのセットアップ"><a href="#Ubuntuのセットアップ" class="headerlink" title="Ubuntuのセットアップ"></a>Ubuntuのセットアップ</h3><p>最初は、キーボードレイアウトを選択します。下記の例ではJapanese(Macintosh)が選択されていますが、日本語キーボードのmacOSや一般的なWindowsの日本語キーボードは一番上の”Japanese”が一般的です。<mark class="label primary">キーボード入力をここで試してください</mark>で実際のキー入力が確認できるのでここで試してから選択しましょう。インストール後にいつでも変更できます。</p><img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu5.png" class="" width="800" title="alt"><p>ここでは<mark class="label primary">最小インストール</mark>を選択します。なお、ESXiの場合、サードパーティのドライバはここでは選択する必要はありません。最初の仮想マシン作成時に、VMware Toolsをインストールするように指示しましたから、”open-vm-tools”が自動的にインストールされます。</p><img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu6.png" class="" width="800" title="alt"><p>ここでは<mark class="label primary">ディスクを削除してUbuntuをインストール</mark>を選択し”インストール”ボタンをクリックします。仮想マシン作成時に設定した64GBのディスクを初期化します。</p><img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu7.png" class="" width="800" title="alt"><p>住んでいる場所を指定します。</p><img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu8.png" class="" width="800" title="alt"><p>ホスト名、ユーザー名を設定します。ここで設定するホスト名・ユーザー名を使ってSSHで接続します。</p><img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu9.png" class="" width="800" title="alt"><img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu9-1.png" class="" width="800" title="alt"><p>インストールは完了です。再起動後、下記の画面が表示されるので、一旦Enterを押下します。</p><img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu9-2.png" class="" width="800" title="alt"><p>最初の起動画面です。ウェルカム画面というのでしょうか。初期案内のウィンドウが表示されます。</p><img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu10.png" class="" width="800" title="alt"><p>ここでは、Ubuntuシングルサインオンを行います。一旦、Ubuntuはこのままにして、クライアントのブラウザからUbuntuのOneアカウントサイトにアクセスします。</p><blockquote><p>One account for everything on Ubuntu<br> <a href="https://login.ubuntu.com/">https://login.ubuntu.com</a></p></blockquote><p>ここでは、以下のようにアカウントを作成します。メールアドレス、フルネーム、ユーザー名、パスワードを入力します。このユーザー名はUbuntuへのログインユーザーと同じである必要はありません。</p><img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu12.png" class="" width="800" title="alt"><p>“Create account”ボタンをクリックし、アカウントを作成すると、登録したメールにコンファーメーションが行きますのでそこで確認のリンクをクリックしUbuntu Oneアカウントの登録は完了します。</p><img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu13.png" class="" width="800" title="alt"><p>続いて、再びUbuntuの画面に戻り、今作成したUbuntu Oneアカウントをここで入力します。</p><img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu11.png" class="" width="800" title="alt"><p>アカウントの照合がうまくいくと、キーリングの登録になります。これは第2パスワードというべき位置付けでもあり、Ubuntuにログインしていても重要な操作の前にはこのキーリングを求められます。Ubuntuをサーバーとして使うのであればGUIでログインする場合は設定変更が主な作業でしょうから、それなりの頻度で求められることになるためパスワード管理ソフトありきの長い覚えられないパスワードにすると実際の運用で大変になってしまうので注意してください。</p><img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu13-1.png" class="" width="800" title="alt"><p>さて、続いてUbuntuにパッチを適用する際のライセンスが必要です。Ubuntu22からはLivePatchに制限が付きます。個人アカウントは3台のUbuntuまでLivePatchが適用できます。このLivePatchが有効になっていると、可能な限りリブートなく最新パッチが自動的に更新される素晴らしい仕組みとなっています。<br><strong>UbuntuのFirefoxを起動</strong>し、Ubuntu Advantageにアクセスします。</p><blockquote><p>Ubuntu Advantage<br> <a href="https://ubuntu.com/advantage">https://ubuntu.com/advantage</a></p></blockquote><p>Ubuntu Oneアカウントでログインします。</p><img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu15.png" class="" width="800" title="alt"><mark class="label primary">Free for personal use</mark>の"Register"をクリックします。<img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu16.png" class="" width="800" title="alt"><p>これで、パーソナルトークンが作成されました。<mark class="label primary">Token</mark>に記載のある文字列をマウスで選択し、右クリックからコピーを選びます。</p><p>ウェルカム画面でUbuntu Oneのシングルサインオン完了後に次の画面に進むと、<mark class="label primary">LivePatchのセットアップ</mark>に進みます。別の方法として、”ソフトウェアの更新”アプリケーションから<mark class="label primary">設定</mark>をクリックし、<mark class="label primary">LivePatch</mark>のタブを選択することでも可能です。</p><img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu20.png" class="" width="800" title="alt"><img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu21.png" class="" width="800" title="alt"><mark class="label primary">LivePatchは再起動することなく。..</mark>の表示とトグルスイッチがありますので、これをオンにします。<img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu22.png" class="" width="800" title="alt"><p>Ubuntu Advantageのトークンを貼り付けします。Ubuntu Advantageの更新は少しタイムラグがあるようで、Tokenの作成直後は登録がうまく行かない場合があるので、その場合は数時間待ってください。</p><img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu19.png" class="" width="800" title="alt"><h3 id="Open-SSH-Serverのインストール"><a href="#Open-SSH-Serverのインストール" class="headerlink" title="Open SSH Serverのインストール"></a>Open SSH Serverのインストール</h3><p>UbuntuにSSHするために必ず必要なモジュールです。GUIでコマンドを扱うには<mark class="label primary">端末</mark>というアプリケーションを起動します。 そこからopensshをインストールします。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt update</span><br><span class="line">$ sudo apt install openssh-server</span><br><span class="line"></span><br><span class="line">パッケージリストを読み込んでいます... 完了</span><br><span class="line">依存関係ツリーを作成しています... 完了</span><br><span class="line">状態情報を読み取っています... 完了</span><br><span class="line">以下の追加パッケージがインストールされます:</span><br><span class="line">  ncurses-term openssh-sftp-server ssh-import-id</span><br><span class="line">提案パッケージ:</span><br><span class="line">  molly-guard monkeysphere ssh-askpass</span><br><span class="line">以下のパッケージが新たにインストールされます:</span><br><span class="line">  ncurses-term openssh-server openssh-sftp-server ssh-import-id</span><br><span class="line">アップグレード: 0 個、新規インストール: 4 個、削除: 0 個、保留: 0 個。</span><br><span class="line">751 kB のアーカイブを取得する必要があります。</span><br><span class="line">この操作後に追加で 6,046 kB のディスク容量が消費されます。</span><br><span class="line">続行しますか? [Y/n] Y</span><br></pre></td></tr></table></figure><p>Ubuntuで<mark class="label primary">端末</mark>アプリケーションを起動する場合、キーボードショートカットによる起動が便利です。セットアップ時のキーボードの選択によって内容は変わりますが、Widnowsは”Ctrl”+”Alt”+”T”で起動します。macOSでは”option”+”control”+”T”で起動します。</p><h2 id="任意設定"><a href="#任意設定" class="headerlink" title="任意設定"></a>任意設定</h2><h3 id="VMRCとクライアントとのCopy-Paseteを連携する"><a href="#VMRCとクライアントとのCopy-Paseteを連携する" class="headerlink" title="VMRCとクライアントとのCopy -Paseteを連携する"></a>VMRCとクライアントとのCopy -Paseteを連携する</h3><p>WindowsやmacOSでブラウザで検索した結果をUbuntu上で貼り付けたい場合があります。この場合は仮想マシンをシャットダウンし、仮想マシンのオプションから以下のパラメータを設定します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">isolation.tools.copy.disable          FALSE</span><br><span class="line">isolation.tools.paste.disable         FALSE</span><br><span class="line">isolation.tools.setGUIOptions.<span class="built_in">enable</span>  TRUE</span><br><span class="line"></span><br></pre></td></tr></table></figure><img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu25.png" class="" width="800" title="alt"><blockquote><p>Copy &amp; Pasetを有効にする<br> <a href="https://kb.vmware.com/s/article/57122">https://kb.vmware.com/s/article/57122</a></p></blockquote><h3 id="フォルダのパスを英語に変更する"><a href="#フォルダのパスを英語に変更する" class="headerlink" title="フォルダのパスを英語に変更する"></a>フォルダのパスを英語に変更する</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ LANG=C xdg-user-dirs-gtk-update</span><br></pre></td></tr></table></figure><img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu24.png" class="" width="480" title="alt"><mark class="label primary">Don't ask me this again</mark>をチェックし、"Update Names"をクリックします。<h2 id="VMRCの便利な起動方法"><a href="#VMRCの便利な起動方法" class="headerlink" title="VMRCの便利な起動方法"></a>VMRCの便利な起動方法</h2><p>ESXiで該当する仮想マシンを開き、URLを確認すると、URLの末尾に仮想マシンNoとも言える2桁の番号が振られています。</p><img src="/new-technology/2022/09/23/ubuntu22-04lts/esxi1.png" class="" width="640" title="alt"><p>この数字を使って以下のURLをブラウザのお気に入りに登録しておくことによって、ESXiの画面にログインしてから仮想マシンにアクセスすることなく、直接VMRCを起動し仮想マシンにアクセスできます。</p><p><code>vmrc://[ユーザー名]@[ESXiのホスト名]/?moid=[仮想マシンNo]</code><br>例：<br><code>vmrc://root@192.168.1.1/?moid=20</code></p><h3 id="セットアップ完了"><a href="#セットアップ完了" class="headerlink" title="セットアップ完了"></a>セットアップ完了</h3><p>ESXiにおけるUbuntu22.04LTSのセットアップは完了です。最後に、仮想マシンのバックアップを取得されることをお勧めします。Linuxには個人ユーザー向けの有力なウィルス対策ソフトが存在しないため、色々なサイトをブラウジングするには多少抵抗がありますが、限られたパッケージシステムのみをインストールし、自宅内のサーバーとして利用するにはESXiとの組み合わせは最適です。バックアップやスナップショットを活用し、トラブル時には迅速にロールバックできる環境はとても便利です。</p><ul><li><a href="/2020/10/11/esxi-backup/" title="VMware ESXiの仮想マシンをバックアップする">VMware ESXiの仮想マシンをバックアップする</a></li><li><a href="/2021/03/06/esxi-nakivo/" title="無償版ESXiの高度なバックアップ">無償版ESXiの高度なバックアップ</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2022/09/23/ubuntu22-04lts/title.png&quot; class=&quot;&quot; width=&quot;1024&quot; title=&quot;alt&quot;&gt;

&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;

&lt;p&gt;この記事では24時間稼働させるサーバーとして、intel&amp;#x2F;AMDの&lt;strong&gt;ESXi&lt;/strong&gt;上にUbuntuをセットアップするケースを想定しています。従来のSSHで接続するコマンドラインベースだけではなく、WindowsやmaOSから&lt;strong&gt;GUIで接続するUbuntu環境&lt;/strong&gt;になります。長期サポートの最新バージョンであるUbuntu22.04LTSを仮想環境であるESXi7.0上に導入します。リモートデスクトップに相当するクライアントソフトウェアはESXiに付属する&lt;strong&gt;VMware Remote Console&lt;/strong&gt;(VMRC)を使います。Ubuntu22.04LTSのEOLは2027年4月であり、十分に長い期間のサポートがあります。&lt;/p&gt;</summary>
    
    
    
    <category term="Software" scheme="https://yoshi0808.github.io/new-technology/categories/Software/"/>
    
    
    <category term="ESXi" scheme="https://yoshi0808.github.io/new-technology/tags/ESXi/"/>
    
    <category term="Ubuntu" scheme="https://yoshi0808.github.io/new-technology/tags/Ubuntu/"/>
    
  </entry>
  
  <entry>
    <title>Ubiquiti UniFiの世界</title>
    <link href="https://yoshi0808.github.io/new-technology/2022/08/27/ubiquiti-unifi/"/>
    <id>https://yoshi0808.github.io/new-technology/2022/08/27/ubiquiti-unifi/</id>
    <published>2022-08-26T23:40:00.000Z</published>
    <updated>2023-06-03T01:39:30.829Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2022/08/27/ubiquiti-unifi/title.png" class="" width="1024" title="alt"><p class="onepoint">この記事で実現すること</p><p>米国Ubiquiti（ユビキティ）社のネットワーク製品群であるUniFiを紹介します。Ubiquiti社はAppleにも在籍経験のあるロバートJ・ペラ氏が立ち上げた会社でWi-Fiネットワークの製品に強みを持っています。NY証券取引所にも上場しており、ビジネス向けのネットワーク機器販売が主力のビジネスです。<br>Ubiquitiにもいくつか製品群があり、このうちUniFiという製品群では、ネットワーク、監視カメラ、入退室管理などの製品があります。法人向けと個人向けのちょうど中間に位置するこの製品群は、ビジネスグレードという位置付けながら廉価です。Ubiquti製品群でも上級者向けのEdgeMaxシリーズがあり、初級者〜中級者向けをターゲットとしているのがUniFiです（ネットワークの知識は必要です）。ここではネットワーク製品のうちスイッチとWi-Fiにフォーカスを当ててどのような機能・サービスがあるのか説明していきます。ペラ氏はカリフォルニア大学において日本語の学士号を保有されており、親近感を覚えます。</p><blockquote><p>UniFiの世界へようこそ<br> <a href="https://help.jp.ui.com/">https://help.jp.ui.com</a></p></blockquote><span id="more"></span><h2 id="UniFi製品の特徴"><a href="#UniFi製品の特徴" class="headerlink" title="UniFi製品の特徴"></a>UniFi製品の特徴</h2><p>UniFiはネットワークの「見える化」をテーマとした製品群と言えます。複数のネットワーク機器や個々の端末を集中管理することに長けています。代表的なのは特にWi-Fiですが、クライアントの通信量や電波の届き具合、通信量、どこのアクセスポイントに接続されているか把握・管理が容易です。ネットワークスイッチも同様でネットワークトポロジーが明瞭で設定内容やトラフィック量が把握できます。インターネットに接続するルーターの役目を果たすセキュリティゲートウェイはどのようなサイトに接続しているか、どれくらいのトラフィック量なのかが非常に見やすくなっています。また、直感的に分かりやすいGUIによる管理が可能で、難しい従来のコマンドラインは必要ありません（※詳細の情報把握にSSHでコマンド確認することも可能です）</p><p>カメラや電話などのネットワーク製品を除いた、UniFiにおけるコアネットワーク製品を管理するためにはUniFi OS ConsoleまたはUniFiネットワークアプリケーションが必要です。</p><h3 id="UniFi-OS-Console"><a href="#UniFi-OS-Console" class="headerlink" title="UniFi OS Console"></a>UniFi OS Console</h3><img src="/new-technology/2022/08/27/ubiquiti-unifi/console.png" class="" width="1024" title="alt"><p>UniFi OS ConsoleはUniFi環境において各ネットワーク機器を集中管理するために必要なものです。Wi-FiのAPやネットワークスイッチはそれぞれGUIなど持ち合わせていないため、GUI管理のためのConsoleが必要となります。UniFiコンソールをさらに分類するとUniFiゲートウェイがあります。 UniFiゲートウェイはUniFi Dream Machine(UDM)やUDM Proはセキュリティゲートウェイと各ネットワーク機器を管理するConsole機能を持ちます。Dream Machineはセキュリティゲートウェイ、Wi-Fi（日本では11ac対応）、Consoleとが一体になっています。UDM Proは、Wi-Fiの機能は持ちませんが、LAN&#x2F;WANに10GbE SFP+を持ち、IDS(侵入検知システム）&#x2F;IPS(侵入防止システム）のスループットが3.5Gbpsあります（iperf3で計測しているとの記載があります）。</p><p>残念ながら、私はUniFiゲートウェイ製品のDream MachineやUDM Proを保有していないので、ここでUniFiの魅力的な製品の1つであるセキュリティ製品の説明ができません。現時点においては、UniFiのセキュリティゲートウェイは日本の環境におけるMAP-EやDS-Liteに対応していないように見えます。UDM ProなどはIPv6 Delegationに対応しており魅力的ですが、日本においてはプロバイダを選ぶ（具体的にはフレッツなどでひかり電話を契約し&#x2F;56などの複数のIPv6プレフィックスの割り当てが必要）ことになり、かなり利用環境が限定されます。ただし、日本でもUDM Proを動作させているユーザーもいらっしゃるようで、このあたりは日本のUbiquitコミュニティが参考になります。また、UniFiの監視カメラなどを導入されたい場合は、ハードディスクをセッティングする必要がありUniFiの専用ハードウェアが必要です。この場合は、UDMシリーズや後述するCloud Key Gen2 Plusを導入する必要があります。</p><p>なお、ゲートウェイの機能としてUDMやUDM ProはIDS&#x2F;IPS、DPI（ディープパケットインスペクション）の機能を持ち、DNSフィルタやパケットのシグネチャを検査する仕組みを持っています。現時点では暗号化されたSSL&#x2F;TSL通信を解読できません。セキュリティゲートウェイではVPNはPPTP、L2TPに加え、最近Teleport VPNに対応しています。</p><blockquote><p>UDM Pro<br> <a href="https://jp.store.ui.com/collections/UniFi-network-UniFi-os-consoles/products/udm-pro">https://jp.store.ui.com/collections/UniFi-network-UniFi-os-consoles/products/udm-pro</a><br> <img src="/new-technology/2022/08/27/ubiquiti-unifi/udmpro.png" class="" width="480" title="alt"></p></blockquote><blockquote><p>Dream Machine<br> <a href="https://jp.store.ui.com/collections/UniFi-network-UniFi-os-consoles/products/UniFi-dream-machine">https://jp.store.ui.com/collections/UniFi-network-UniFi-os-consoles/products/UniFi-dream-machine</a><br> <img src="/new-technology/2022/08/27/ubiquiti-unifi/udm.png" class="" width="240" title="alt"></p></blockquote><p>Cloud Key Gen2は35,000円ほどしますが、監視カメラを導入する場合は必要です。予め1TBのHDDが用意されているので特に難しいセットアップは不要でUniFiの運用を開始できます。</p><blockquote><p>Cloud Key Gen2 Plus<br> <a href="https://jp.store.ui.com/collections/UniFi-network-UniFi-os-consoles/products/UniFi-cloudkey-gen2-plus-1">https://jp.store.ui.com/collections/UniFi-network-UniFi-os-consoles/products/UniFi-cloudkey-gen2-plus-1</a><br> <img src="/new-technology/2022/08/27/ubiquiti-unifi/cloudkey.png" class="" width="240" title="alt"></p></blockquote><p>UniFi OS Consoleを購入しなくとも、WindowsやmacOSでUniFi Network Applicationをセットアップできます。別途、Java11のインストールが必要です。もし、仮想環境のESXiをお持ちであれば（一定のネットワークの知識があることが前提です）、ESXi上にUbuntuなどを導入し、そこにUniFi Network Applicationをセットアップできます。ネットワークアプリケーションのロールバックはサポートされておらず、旧バージョンを再インストールするか、ESXiによるバックアップからロールバックすることになります。UniFi本来のメリットを享受するためには見える化が大事ですから24時間365日の稼働とトラフィック収集が重要です。もちろんカジュアルユーザーは設定変更時だけ都度PCを起動し、UniFi Network Applicationを起動し、設定変更する方法もあります。</p><p>自分でUniFi Network Applicationをセットアップする場合は自身で用意するハードウェア以外の費用はかかりません。UniFiソフトウェアは無償ですし、サブスクリプションなどの定額支払いもありません。Linuxの場合、最低2GByteのメモリ、HDDは最低10Gバイトが必要です。私はUbuntu Desktop上に構築しており、4Gバイトのメモリ、HDDは40Gバイトにしています。UniFiのセットアップやバージョンアップにGUIは不要ですが、ハードウェアスペックに余裕のある方はGUI(Ubuntu Desktop)をお薦めします。</p><blockquote><p>UniFi Help Center<br> <a href="https://help.ui.com/hc/en-us/articles/360012282453-UniFi-Network-Self-Hosting-your-UniFi-Network-Without-a-Console-Advanced-">https://help.ui.com/hc/en-us/articles/360012282453-UniFi-Network-Self-Hosting-your-UniFi-Network-Without-a-Console-Advanced-</a></p></blockquote><h3 id="UniFiの管理画面"><a href="#UniFiの管理画面" class="headerlink" title="UniFiの管理画面"></a>UniFiの管理画面</h3><p>UniFiの管理画面は新旧の2種類あります。旧画面は日本語にも対応していますが、最新機器の製品名が表示されないなどちょっと中途半端な対応状況です。デザイン的にも少し洗練された新画面はまだまだ機能が不足しているというデメリットもありますが、徐々に機能拡充されていきます。これから利用を開始するユーザーは新画面で利用されることをお勧めします。</p><p>新画面の抜粋</p><img src="/new-technology/2022/08/27/ubiquiti-unifi/unifi1.png" class="" width="1024" title="alt"><img src="/new-technology/2022/08/27/ubiquiti-unifi/unifi2.png" class="" width="1024" title="alt"><img src="/new-technology/2022/08/27/ubiquiti-unifi/unifi3.png" class="" width="1024" title="alt"><p>旧画面</p><img src="/new-technology/2022/08/27/ubiquiti-unifi/unifi4.png" class="" width="1024" title="alt"><img src="/new-technology/2022/08/27/ubiquiti-unifi/unifi5.png" class="" width="1024" title="alt"><h3 id="スマホアプリ"><a href="#スマホアプリ" class="headerlink" title="スマホアプリ"></a>スマホアプリ</h3><p>UniFiの管理システムはハイブリッドクラウドのような仕組みがあり、無償で利用できます。完全なオンプレミスも可能ですが、外出先から自宅内のネットワーク機器を手軽にコントロールできるのは魅力的です。</p><p>特にスマホアプリから行うWi-Fi機器やスイッチ機器のモニタリング、設定変更が容易で秀逸です。コントローラは2要素認証に対応しており、自宅でコントローラにログインすると、スマホにPush通知が来ますのでこれに応答することによりログインが完了します。アプリからはLANの直接接続、或いはUbiquitiのクラウド経由で自宅のConsoleまたはネットワークアプリケーションと接続されますが、クラウド経由の場合でも自宅のFirewallやルーターで特定のPortで待ち受ける（Port解放する）ことなく、UniFi Console（ネットワークアプリケーション）側からUbiquitiのクラウドにアクセスし、最終的にはコントローラーからスマホへ接続する形態です。セキュリティ的にも一段レベルが上で、ダイナミックDNSなどの準備が不要であることが特徴です。</p><p>UniFi Networkアプリ（iOS&#x2F;Android)<br>UniFiのシングルサインオンアカウントを使ってスマホアプリにログインします。自宅内でも自宅外であってもVPNなど意識することなく簡単かつ素早くUniFi機器の管理ができます。</p><img src="/new-technology/2022/08/27/ubiquiti-unifi/app1.png" class="" width="360" title="alt"><img src="/new-technology/2022/08/27/ubiquiti-unifi/app2.png" class="" width="360" title="alt"><img src="/new-technology/2022/08/27/ubiquiti-unifi/app3.png" class="" width="360" title="alt"><p>新しい機器をスイッチポートに接続する際にはどのVLANに属するか設定しますが、この場合はスマホアプリからConsoleを経由し大抵のことができます。SFP＋のDDM(Digital Diagnostic Monitoring)の値も取れますし、スイッチによっては機器本体の温度も把握できます。</p><p>このスマホアプリではARという機能があり、UniFiスイッチの第2世代以降は以下のビデオのようにスマホで実際のスイッチ機器をかざすことによって接続された端末がVR的にマッピングされたものを見られます。UniFiスイッチを一躍有名にした機能でもあります。</p><video src='ar.mov' type='video/mp4' controls='controls'  width='45%' height='45%'></video><p> UI Verifyアプリ（iOS&#x2F;Android)<br> これはConsoleやUbiquitiのサイトにログインする際の2要素認証のためのワンタイムパスワードのスマホアプリです。</p><img src="/new-technology/2022/08/27/ubiquiti-unifi/verify1.png" class="" width="360" title="alt"><p>これを導入してシングルサインオンの設定をしておくとPCなどからログインした際にはプッシュ通知がされます。</p><img src="/new-technology/2022/08/27/ubiquiti-unifi/verify2.png" class="" width="360" title="alt"><p>これで2要素認証も簡単に対応できます。</p><h3 id="その他管理"><a href="#その他管理" class="headerlink" title="その他管理"></a>その他管理</h3><ul><li><p>Syslog&#x2F;SNMP<br>UniFi Console、各機器それぞれが統合管理されるので、1箇所のSyslogサーバにログを書き出せます。あくまでsyslogなので、UniFiシステムの障害切り分けに使うレベルのものです。また、SNMPv3の管理機能を持ちます。</p></li><li><p>SSH<br> スイッチの詳細情報を確認できます、パスワード認証、公開鍵認証が可能です。私はYubicoのYubiKeyで公開鍵認証を使っています。</p></li><li><p>バックアップ<br> 構成情報を定期的にバックアップできます。</p></li><li><p>通知<br> メール、アプリにイベントを通知できます。ファームウェア更新の通知（自動更新も可能）、スイッチやWi-Fiを対象にすればクライアント（インタフェース）の新規接続、切断、ローミングが通知されます。他にもリスク管理の通知機能があります。</p></li></ul><h3 id="オンラインストア"><a href="#オンラインストア" class="headerlink" title="オンラインストア"></a>オンラインストア</h3><p>UniFi製品は日本のオンラインストアがあります。製品はワールドワイドに展開されていますが、ONUと接続する可能性のあるセキュリティゲートウェイや電波を出すWi-Fi製品は技適マークもありますし、ネットワークスイッチの電源コードはPSEマークも付与されており安心して購入できます（電源ケーブルは3PINとなっており、日本のコンセントに合うように2PIN変換アダプタが別途必要です）。</p><blockquote><p>Ubiquit Japan Store<br> <a href="https://jp.store.ui.com/">https://jp.store.ui.com</a></p></blockquote><p>世界的にはUbiquitiの製品・パーツは非常に廉価です。日本においては今年に円安のため2回ほど価格改定があり、以前と比べると特別廉価とは感じなくなっています。</p><ul><li>MMモジュール（10Gbpsマルチモード光学モジュール）2つで6,299円</li><li>10GSFP+ RJ45モジュール10,009円</li></ul><p>日本のサイトでは今のところ送料が無料です。UbiquitiのMMモジュールは様々な機器に繋いでいますが、特段問題が発生したことはありません。Ubiquitiのスイッチに限りませんが、SFP&#x2F;SFP+の互換性の問題が出る場合があり、純正のMMモジュールまたは信頼のあるSFPベンダーからの購入をお勧めします。</p><p>ケーブルに関してはUbiquitiの純正のOM3ケーブルは部屋と部屋とを繋ぐにしては短すぎるものばかりなので別途FSやAmazonなどで調達する必要があります。</p><p>UbiquitiのRJ45ケーブル（Cat6)はコネクタ付近で曲げることができるユニークなパッチケーブルです。基本的にCat6Aはなく、Cat6のケーブルのみの取り扱いですが、最大8メートルのパッチケーブルであれば10GbEでも問題が出ることはありません。</p><img src="/new-technology/2022/08/27/ubiquiti-unifi/cat6.png" class="" width="280" title="alt"><h3 id="ネットワークスイッチ"><a href="#ネットワークスイッチ" class="headerlink" title="ネットワークスイッチ"></a>ネットワークスイッチ</h3><p>ここ数ヶ月、このブログでは省電力化および低発熱を目的としてSFP＋の説明をしてきましたが、UniFiスイッチを簡単に紹介します。</p><p>UniFiスイッチはL2の製品群が主流です。設定はGUIのみで行います。SSHでスイッチに接続し、設定変更は行えますが再起動のタイミングにおいて、GUIで設定した内容に上書きされます。見える化やスイッチ全体の一括管理のために、全てのスイッチをUniFiのものに統一したくなりますが、部分的にUniFiスイッチを導入できます。UniFiスイッチはハードウェア自体は一般的なL2スイッチとあまり違いは無いので異なるメーカーのL2スイッチをUniFiスイッチに接続し、VLANで相互に運用できます。</p><p>個人で利用する場合、無理にVLANを切る必要もありませんが、マルチプルVLANも対応しているので、1つのネットワークアドレスで複数のVLANに属する形を取ればネットワーク分離も簡単に行えます。</p><p>一部の製品にはL3に対応したスイッチも存在しますが、IPv6に対応していないことや、アクセスコントロール（ACL）が行えないというものであり、L3としてはまだ使えるレベルには達していません。</p><h4 id="USW-Aggregation"><a href="#USW-Aggregation" class="headerlink" title="USW-Aggregation"></a>USW-Aggregation</h4><img src="/new-technology/2022/08/27/ubiquiti-unifi/USW-Aggregation.png" class="" width="280" title="alt"><p>ファンレスL2スイッチです。SFP＋ポートを8つ持ちます。小規模なネットワークにも向いていますが、アグリゲーションという名前が付くだけあって、本来はいくつかのスイッチを束ねる目的のスイッチでもあります。MikroTikの8Portスイッチと値段も同程度でもあり、良く比較される対象になっています。奥行きは短いですが、基本は19インチラックに合うように作られているので結構幅があります。あまりIT機器のようにも見えないデザインでもあり、リビングに単独で置いても違和感はありません。</p><h4 id="USW-Pro-Aggregation"><a href="#USW-Pro-Aggregation" class="headerlink" title="USW-Pro-Aggregation"></a>USW-Pro-Aggregation</h4><img src="/new-technology/2022/08/27/ubiquiti-unifi/USW-Aggregation-PRO.png" class="" width="280" title="alt"><p>L3スイッチです。10G SFP＋ポートを28ポート、および25G SFP28ポートを4ポート持っています。私は寝室にあるクローゼットにこのスイッチを置いており、ファンの音はしますが、クローゼットのドアを閉めれば全く気にならない程度で静音といえます。L3は前述したように本来のL3としては制約がありますが、セグメント超えのiperf3を実行しても殆どスループットは落ちません。ここはさすがL3スイッチです。</p><h4 id="USW-Enterprise-8-PoE"><a href="#USW-Enterprise-8-PoE" class="headerlink" title="USW-Enterprise-8-PoE"></a>USW-Enterprise-8-PoE</h4><img src="/new-technology/2022/08/27/ubiquiti-unifi/USW-Enterprise-8-PoE.png" class="" width="280" title="alt"><p>L3スイッチです。Enterpriseという割には小ぶりでリビングに似合いそうなスイッチです。SFP＋を2ポート、2.5GbE（1GbE、100Base）のRJ45ポートを8ポート持ちます。ファンの音は殆どわかりません。実際にフロントのLCDパネルでファンの回転数を引き上げられ、その際はさすがにファンの音はするものの、やがて自動運転ではかなりの抑えた風量に戻るようです。米国ではTVとかオーディオなど色々な専用セグメントが必要だったりするのでL3が必要なのでしょうか。これはPoEスイッチでもあり、UniFiの世界では小型スイッチやWi-FiがPoE、つまりLANケーブル1本で通信と給電とが行われます。家が小さい日本ではあまり馴染みがないテクノロジですが、アメリカのように大きい家ではLANケーブル1本で各部屋まで配線し、天井や壁にWi-Fiやスイッチを埋め込む形でLANを構築していく事が多いのでPoEが重宝されます。RJ45の8ポートが2.5GbEであると同時にPoEによる給電が可能です。かなりの発熱で筐体上部は50℃ほどあり、コンソールからは70℃以上の熱を示しています。この温度であればファンが回っても良さそうな雰囲気ですが、LCDパネル上のファン回転数は80rpmで静かです。普段の運用ではファンが回るイメージがありません。</p><h4 id="Switch-Flex-Mini"><a href="#Switch-Flex-Mini" class="headerlink" title="Switch Flex Mini"></a>Switch Flex Mini</h4><img src="/new-technology/2022/08/27/ubiquiti-unifi/USW-Flex-Mini.png" class="" width="280" title="alt"><p>小型の1G RJ45を5ポート持つ小型スイッチです。4,794円と廉価です（最近の円安で値上がりしました）。UniFiではトランクポートとして設定する場合、複数のVLANを選択しグループ化しますが、トランクポートは全てのVLANが対象となる制約があります。一応L2対応になっています。洗練されたデザインで小型のこのスイッチは発熱が小さく安定しており気に入ってます。しかし、気に入っている割には無造作にマジックテープを裏面にべったり貼り付け、TVの後ろに貼り付けています。PoEの入力が可能なので、PoEスイッチから電源を取っています。最初から小さい電源アダプタも付属していますがケーブルの本数を減らしたい方はPoEは便利です。100Base-TXのLANを持つテレビなどは目立たないこのスイッチに集約させ、多くの長いLANケーブルから解放されるのに便利です。4,794円でUniFiの世界をテストドライブしてみるのも良いかもしれません。</p><h3 id="Wi-Fi"><a href="#Wi-Fi" class="headerlink" title="Wi-Fi"></a>Wi-Fi</h3><p>米国ではUniFiのWi-Fiシステムは非常に多くの製品が発売されていますが、日本で販売されている利用可能な製品はWi-Fi5、Wi-Fi6の有線接続を必須とする数製品に絞られます。日本のメーカーとは異なった魅力のあるアクセスポイント（AP）です。主流の11ax対応製品については、3製品あります。Lite、Pro、LR（ロングレンジ）になります。中継機としてExtender、メッシュ用としてU6 Meshが存在します。</p><img src="/new-technology/2022/08/27/ubiquiti-unifi/U6-Pro1.png" class="" width="280" title="alt"><p>基本的に壁に固定し、LANケーブルのPoEから電源を取ります。これまでのWi-Fiルータを棚やテーブルに置くという方法ではなく、電源コンセントの制約が無いため、自由度が高く、壁などに取り付けられます。APの設置は壁にねじ止めするのが本来の姿ですが、小心者の私は100均で売っている壁にメモを留めるようなピンを打ち付けてAPを固定しています。APを取り外した後も壁紙の補修液を塗り込めば壁の穴は目立ちません。</p><p>UniFiのWi-Fi製品は、ネットワークスイッチのPoEまたはPoEインジェクタを別途購入し接続することになります。</p><img src="/new-technology/2022/08/27/ubiquiti-unifi/poe.png" class="" width="280" title="alt"><p>壁掛けで1本のLANケーブルのみであれば部屋に馴染み、さほど気になるものでもありません。<br>Fast Roaming(802.11r)を前提として、APの切り替えがスムーズに行えます。一般的には端末を持つ人が移動した時のローミングを目的としていますが、家族が普段通りにスマホを使っていながら接続APを切り替えられます。私の場合、自宅の1階にU6-Proを、2階にU6-Liteを設置していますが、どちらのAPからも家じゅう電波は届きます。APの故障対策のためというよりは、私が色々なことをやってAPやスイッチの設定を変更したりリブートしたりするので、自宅内で家族向けに安定的なWi-Fiサービスの提供のためにはとても便利な機能です。AP毎の周波数を設定し、お互いが競合しないようにするなど、より細かい設定ができます。</p><p>ハードウェアスペックとしては一般的ですが、端末がどのAPに接続されているか、それぞれの端末の電波状況などがわかります。また時間でSSID単位に停波させることも可能で、私は夜間は11gの最小限の送信出力に絞り11axは止めています。スマホは夜間に勝手に11gに切り替わり最低限の通信は可能になっています。</p><p>日本のWiーFiルーターも多機能で、当たり前のようにあるWPSプッシュボタンによるクライアント登録（認証）や子供の端末を管理するなどの機能はUniFiは持っていません。下手に長いWi-Fiパスワードにしてしまうと、UniFiではIoTに対するパスワード入力が困難です。UniFiと国内のWi-Fiルーターとは目指す方向が違う事になり、基本性能という意味では殆ど変わらないものとお考えください。</p><p>ホームゲートウェイやスイッチなどが揃っている環境でUniFiのWi-Fi製品のみを導入できます。</p><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>ここではUniFiの製品群を説明しました。製品としては荒削りなところもあり、それなりに不具合や未対応の箇所を抱えながら少しづつ機能強化しているというプロダクトの特徴があります。特に見える化という観点で、ネットワーク環境を変える予定のある方は検討の候補になるかもしれません。私が保有しているスイッチを簡単に紹介しましたがSFP+に偏っており、他にも魅力的なスイッチがありますので、是非Ubiquitオンラインストアにアクセスされてみることをお勧めします。</p><p>このブログでは仮想環境のESXi上にUbuntuをセットアップし、UniFi Network Applicationを運用する方法を紹介しています。</p><ul><li>「<a href="/2022/09/23/ubuntu22-04lts/" title="Ubuntu22.04LTSをESXiにセットアップする">Ubuntu22.04LTSをESXiにセットアップする</a>」</li><li>「<a href="/2022/09/23/unifi-network-application/" title="UniFi Network Applicationのセットアップ">UniFi Network Applicationのセットアップ</a>」</li><li>「<a href="/2022/10/23/unifi-network-application2/" title="UniFi Network Applicationの運用">UniFi Network Applicationの運用</a>」</li><li>「<a href="/2022/11/23/unifi-switch/" title="UniFiスイッチ">UniFiスイッチ</a>」</li><li>「<a href="/2022/12/31/unifi-ap/" title="UniFi Wi-Fiシステム">UniFi Wi-Fiシステム</a>」</li></ul><h2 id="リソース"><a href="#リソース" class="headerlink" title="リソース"></a>リソース</h2><p>以下の日本語ヘルプ、コミュニティがUniFiの構築には大いに参考になります。</p><blockquote><p>Ubiquiti コミュニティ（日本）<br> <a href="https://www.facebook.com/groups/uijapan">https://www.facebook.com/groups/uijapan</a></p></blockquote><blockquote><p>UI 日本語ヘルプ記事<br> <a href="https://help.jp.ui.com/categories/6583256751383/">https://help.jp.ui.com/categories/6583256751383/</a></p></blockquote><blockquote><p>Ubiquiti Community（米国中心）<br> <a href="https://community.ui.com/">https://community.ui.com/</a></p></blockquote>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2022/08/27/ubiquiti-unifi/title.png&quot; class=&quot;&quot; width=&quot;1024&quot; title=&quot;alt&quot;&gt;

&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;

&lt;p&gt;米国Ubiquiti（ユビキティ）社のネットワーク製品群であるUniFiを紹介します。Ubiquiti社はAppleにも在籍経験のあるロバートJ・ペラ氏が立ち上げた会社でWi-Fiネットワークの製品に強みを持っています。NY証券取引所にも上場しており、ビジネス向けのネットワーク機器販売が主力のビジネスです。&lt;br&gt;Ubiquitiにもいくつか製品群があり、このうちUniFiという製品群では、ネットワーク、監視カメラ、入退室管理などの製品があります。法人向けと個人向けのちょうど中間に位置するこの製品群は、ビジネスグレードという位置付けながら廉価です。Ubiquti製品群でも上級者向けのEdgeMaxシリーズがあり、初級者〜中級者向けをターゲットとしているのがUniFiです（ネットワークの知識は必要です）。ここではネットワーク製品のうちスイッチとWi-Fiにフォーカスを当ててどのような機能・サービスがあるのか説明していきます。ペラ氏はカリフォルニア大学において日本語の学士号を保有されており、親近感を覚えます。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;UniFiの世界へようこそ&lt;br&gt; &lt;a href=&quot;https://help.jp.ui.com/&quot;&gt;https://help.jp.ui.com&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="Hardware" scheme="https://yoshi0808.github.io/new-technology/categories/Hardware/"/>
    
    <category term="Network" scheme="https://yoshi0808.github.io/new-technology/categories/Network/"/>
    
    
    <category term="SFP+" scheme="https://yoshi0808.github.io/new-technology/tags/SFP/"/>
    
    <category term="10GbE" scheme="https://yoshi0808.github.io/new-technology/tags/10GbE/"/>
    
    <category term="Wi-Fi" scheme="https://yoshi0808.github.io/new-technology/tags/Wi-Fi/"/>
    
    <category term="UniFi" scheme="https://yoshi0808.github.io/new-technology/tags/UniFi/"/>
    
  </entry>
  
  <entry>
    <title>SFP+の2.5GbE対応</title>
    <link href="https://yoshi0808.github.io/new-technology/2022/07/30/sfp-plus-nbaset/"/>
    <id>https://yoshi0808.github.io/new-technology/2022/07/30/sfp-plus-nbaset/</id>
    <published>2022-07-29T21:20:00.000Z</published>
    <updated>2023-05-16T12:03:51.706Z</updated>
    
    <content type="html"><![CDATA[<p class="onepoint">この記事で実現すること</p><p>スイッチングハブのSFP&#x2F;SFP+ポートは2.5Gbps&#x2F;5Gbpsに対応していない製品が多いです。元々、10GBase-T&#x2F;1000Base-Tなどもスイッチに対し無理やり10G Base-SRのように見せかけて動作させており、SFPの世界にはNBase-Tが一般的に存在しません。ビジネス向けスイッチではそもそもの対応がされていない製品も多く、ホームユーザー向けもSFPがあまり一般的ではないことから2.5GbEのサポートは普及していません。しかしながら対応モジュールを組み合わせることで回避することは可能です。</p><span id="more"></span><h2 id="SFP-スイッチの2-5Gbpsサポート"><a href="#SFP-スイッチの2-5Gbpsサポート" class="headerlink" title="SFP+スイッチの2.5Gbpsサポート"></a>SFP+スイッチの2.5Gbpsサポート</h2><p>一般的なSFP＋スイッチは1G&#x2F;10Gのみのインタフェースとなります。また、10GBase-Tモジュールでは「ASF-10G-T」という型番のSFP＋モジュールが一般的に良く知られています。日本のAmazonだと10GTek、ipolexの取り扱いがあります。これは内部のチップにMarvell社の88X3310が使われています。これはNBase-Tに対応したチップが使われており、スイッチ側をオートネゴシエーションにしておくとスイッチ上は10Gと認識していますが、端末側の速度に合わせ2.5G、100Base-TXもリンクアップします。</p><p>必ずしも全てのモジュールがオートネゴシエーションでリンクアップするわけではありません。例えば、Broadcomチップで80m対応の省電力モジュール「Cisco SFP-10G-T-80互換」は<strong>2.5GbEに対応したスイッチ</strong>で2.5GbEと認識し正しく通信できますが、オートネゴシエーションモードではリンクアップしません。10GBase-Tで慣れている方はNBase-T対応が当然でもあり、少し違和感があるのでは無いでしょうか。</p><p>SFPモジュールの2.5Gbps対応状況について、まずは結論です。</p><table><thead><tr><th>10GBase-Tモジュール</th><th>メーカー</th><th>2.5GbE速度</th><th>2.5GbEオートネゴ</th><th>発熱</th></tr></thead><tbody><tr><td>ASF-10G-T</td><td>ipolex,10GTek</td><td>×</td><td>◯</td><td>◯</td></tr><tr><td>Cisco SFP-10G-T-80互換</td><td>各社</td><td>◯</td><td>×</td><td>◯</td></tr><tr><td>2.5GBase-Tモジュール</td><td>FSなど各社</td><td>◯</td><td>×</td><td>◎</td></tr><tr><td>S+RJ10</td><td>MikroTik</td><td>◯</td><td>◯</td><td>×</td></tr><tr><td>Aquantiaモジュール</td><td>Supermicro,FS</td><td>◯</td><td>◯</td><td>◯</td></tr></tbody></table><p>スイッチのPortをオートネゴ（10gbps）とし、モジュール側で2.5GbEをサポートする場合の制限は2つあります。1つ目は熱の問題で、2.5Gや100Baseであってもチップ自身は10Gbpsですから、消費電力および発熱量は高くなります。<br>2つ目は相手を2.5Gbpsと認識しているのはモジュール内部のチップだけであり、スイッチはその事実を全く知らないため、10Gbpsの速度でスイッチからSFP+モジュールに対してデータ送信します。このためSFP+モジュールはキャパオーバーとなり、データバッファが溢れ、データ再送が繰り返される事になります。つまり、一般的によく出回っているASF-10G-T（Marvell社の88X3310チップ）は2.5GbEとしては全く実用的ではありません。</p><p>実際に問題となるケースを説明します。クライアントは2.5GBase-Tを持つWindows10で10GBase-TのSFPモジュールを使いSFP＋スイッチにオートネゴモードで接続されています。サーバーはUbuntu20で10GbpsのSFP+DACケーブルで同じスイッチに接続されています。サーバーからデータをダウンロード、アップロードすることを想定し、iperf3を実行します。</p><img src="/new-technology/2022/07/30/sfp-plus-nbaset/nbase-t.drawio.png" class="" width="640" title="alt"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># クライアントで実行：上り</span></span><br><span class="line"></span><br><span class="line">C:\Users\yoshi&gt;iperf3 -c 192.168.x.181</span><br><span class="line">Connecting to host 192.168.x.181, port 5201</span><br><span class="line">[  4] <span class="built_in">local</span> 192.168.x.164 port 62653 connected to 192.168.x.181 port 5201</span><br><span class="line">[ ID] Interval           Transfer     Bandwidth</span><br><span class="line">[  4]   0.00-1.00   sec   283 MBytes  2.37 Gbits/sec</span><br><span class="line">[  4]   1.00-2.00   sec   282 MBytes  2.37 Gbits/sec</span><br><span class="line">[  4]   2.00-3.00   sec   282 MBytes  2.37 Gbits/sec</span><br><span class="line">[  4]   3.00-4.00   sec   283 MBytes  2.37 Gbits/sec</span><br><span class="line">[  4]   4.00-5.00   sec   282 MBytes  2.37 Gbits/sec</span><br><span class="line">[  4]   5.00-6.00   sec   282 MBytes  2.37 Gbits/sec</span><br><span class="line">[  4]   6.00-7.00   sec   281 MBytes  2.36 Gbits/sec</span><br><span class="line">[  4]   7.00-8.00   sec   282 MBytes  2.37 Gbits/sec</span><br><span class="line">[  4]   8.00-9.00   sec   282 MBytes  2.37 Gbits/sec</span><br><span class="line">[  4]   9.00-10.00  sec   282 MBytes  2.37 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[ ID] Interval           Transfer     Bandwidth</span><br><span class="line">[  4]   0.00-10.00  sec  2.76 GBytes  2.37 Gbits/sec                  sender</span><br><span class="line">[  4]   0.00-10.00  sec  2.76 GBytes  2.37 Gbits/sec                  receiver</span><br><span class="line"></span><br><span class="line">iperf Done.</span><br><span class="line"></span><br><span class="line"><span class="comment"># クライアントで実行：下り</span></span><br><span class="line">C:\Users\yoshi&gt;iperf3 -c 192.168.x.181 -R</span><br><span class="line">Connecting to host 192.168.x.181, port 5201</span><br><span class="line">Reverse mode, remote host 192.168.x.181 is sending</span><br><span class="line">[  4] <span class="built_in">local</span> 192.168.x.164 port 62643 connected to 192.168.x.181 port 5201</span><br><span class="line">[ ID] Interval           Transfer     Bandwidth</span><br><span class="line">[  4]   0.00-1.00   sec   184 MBytes  1.54 Gbits/sec</span><br><span class="line">[  4]   1.00-2.00   sec   153 MBytes  1.29 Gbits/sec</span><br><span class="line">[  4]   2.00-3.00   sec   127 MBytes  1.06 Gbits/sec</span><br><span class="line">[  4]   3.00-4.00   sec   121 MBytes  1.02 Gbits/sec</span><br><span class="line">[  4]   4.00-5.00   sec   120 MBytes  1.01 Gbits/sec</span><br><span class="line">[  4]   5.00-6.00   sec   121 MBytes  1.02 Gbits/sec</span><br><span class="line">[  4]   6.00-7.00   sec   123 MBytes  1.03 Gbits/sec</span><br><span class="line">[  4]   7.00-8.00   sec   121 MBytes  1.02 Gbits/sec</span><br><span class="line">[  4]   8.00-9.00   sec   120 MBytes  1.00 Gbits/sec</span><br><span class="line">[  4]   9.00-10.00  sec   119 MBytes  1.00 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[ ID] Interval           Transfer     Bandwidth       Retr</span><br><span class="line">[  4]   0.00-10.00  sec  1.28 GBytes  1.10 Gbits/sec  16710             sender</span><br><span class="line">[  4]   0.00-10.00  sec  1.28 GBytes  1.10 Gbits/sec                  receiver</span><br><span class="line"></span><br><span class="line">iperf Done.</span><br></pre></td></tr></table></figure><p>Windows（クライアント：2.5Gbps）からUbuntu(サーバー:10Gbps)へのアップロードは2.5Gbps相当の速度が出ていますが、Ubuntu(サーバー:10Gbps)からWindows(クライアント：2.5Gbps)にダウンロードする方向で1Gbps程度の速度に落ち込みます。ubuntuの送信リトライの数が16710と大きな数字になっています。</p><p>上記のiperf3の実行結果についてクライアント側でネットワークアナライザのWireSharkを使い、下りデータをキャプチャしたものが以下のグラフです。</p><p>まずは、往復遅延時間（Round trip）です。</p><img src="/new-technology/2022/07/30/sfp-plus-nbaset/latency-ipolex.png" class="" width="800" title="alt"><p>X軸が時間の経過で10秒間、Y軸が往復遅延時間です。<br>問題は2つあります。1つ目は1ms（ミリ秒）を超える遅延（青いドット）がいくつか発生しています。2つ目は0ms〜1msの間に青いドットが集約され、青い帯のように見えます。LANの通信で帯に見える場合は数百μs（マイクロ秒）のレイテンシが発生し断続的に遅延が発生しています。レイテンシが小さいなら太い実線程度であり帯のようには見えません。</p><p>次に、スループットです。</p><img src="/new-technology/2022/07/30/sfp-plus-nbaset/throughput-ipolex.png" class="" width="800" title="alt"><p>X軸は時間の経過、Y軸は2つあり、茶色の実線および右の目盛りはスループットを表します。青色の点および左の目盛りは受信したデータ長を表します。<br>茶色のスループットは最初1.5Gbpsまでは上がり、その後スループットが落ち込んでいきます。グラフ上部の青い水平線はTCPのデータ1460バイトの点がプロットされたものが集まっており、実線に見えます。また、パケットが欠損するとこのように全体に青いドットが散らばり、中途半端なバイト数の受信を示します。</p><p>実際のパケットの中身を確認してみます。</p><img src="/new-technology/2022/07/30/sfp-plus-nbaset/capture-ipolex.png" class="" width="1024" title="alt"><p>IPの末尾181がubuntu、IPの末尾164がWindowsです。No307,309,310と1460バイトのTCPデータが受信されていますが、No311で318バイトを受信しています。ここで恐らくパケットが欠損したと思われます。その次の受信は、No313でシーケンス365001、No314でシーケンス366461を受信しています。受け損ねたと思われるNo311のシーケンスは360621です。(366461-360621)&#x2F;1460&#x3D;4とちょうど割り切れるため、サーバー側はTCP1460バイトを連続で送っていたものとみられます。No311で318バイトの残り1142バイトをロストし、次のシーケンス363541も1460バイト全体をロストしたのでしょう。</p><p>この後、クライアントは、あくまで自身が欲しいパケットのシーケンスは欠損した360621なのでDup ACKを送出しこれを要求しますが、要求している間にもどんどん次のトラフィックが送信されてきます。最終的には、360621の再送要求がサーバーに届き、サーバーは優先度を上げて360621を再送しますが、それまでに結構なタイムロスがあります。</p><p>iperf3など同一LAN内であれば、再送によるレイテンシも小さく済みますが、相手サーバーがInternet経由だとレイテンシが数ミリ秒〜数十ミリ秒あります。このためハイトラフィックテストや大きなファイルのダウンロードは更に落ち込む事になります。私の環境では200Mbpsが精一杯でした。</p><p>要約すると以下の通りです。</p><div class="note info"><ul><li>SFP＋スイッチの2.5GbEサポート状況はメーカー次第</li><li>SFP＋ 10GBase-Tモジュールのいくつかは2.5GbEをサポートするが、対応状況は不明瞭</li><li>スイッチが2.5GbEに対応しない場合、10GBase-Tモジュールで2.5GbEを認識する場合があるが、片側の速度が1Gbps未満に落ち込むモジュールが大半</li><li>2.5GbE接続であっても10GbEチップを使えば発熱量は増える</li></ul></div><blockquote><p>WireShark<br> <a href="https://www.wireshark.org/">https://www.wireshark.org</a></p></blockquote><h2 id="FS社のAquantiaチップ特注モジュール"><a href="#FS社のAquantiaチップ特注モジュール" class="headerlink" title="FS社のAquantiaチップ特注モジュール"></a>FS社のAquantiaチップ特注モジュール</h2><p>FS社では特にホームページで記載されていないものの、実はAquantiaチップを使ったRJ45 10GbEモジュールを特注で提供してくれます。Aquantiaチップのモジュールは、数年前よりSupermicro社が提供するRJ45モジュールで唯一の2.5GbE&#x2F;5GbE対応のものと言われていましたが、$200と高価なものでした。</p><img src="/new-technology/2022/07/30/sfp-plus-nbaset/aquantia.png" class="" width="800" title="alt"><p>（ラベルは至って普通。でも特注です）</p><p>SFP+スイッチでこのモジュールを10GbEオートネゴで使い、上記の2.5Gbpsのテストをやってみたところ、十分な速度が出ました。今回はリトライもありません。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Connecting to host 192.168.x.181, port 5201</span><br><span class="line">Reverse mode, remote host 192.168.x.181 is sending</span><br><span class="line">[  4] <span class="built_in">local</span> 192.168.x.164 port 54413 connected to 192.168.x.181 port 5201</span><br><span class="line">[ ID] Interval           Transfer     Bandwidth</span><br><span class="line">[  4]   0.00-1.00   sec   279 MBytes  2.34 Gbits/sec</span><br><span class="line">[  4]   1.00-2.00   sec   283 MBytes  2.37 Gbits/sec</span><br><span class="line">[  4]   2.00-3.00   sec   283 MBytes  2.38 Gbits/sec</span><br><span class="line">[  4]   3.00-4.00   sec   283 MBytes  2.37 Gbits/sec</span><br><span class="line">[  4]   4.00-5.00   sec   283 MBytes  2.37 Gbits/sec</span><br><span class="line">[  4]   5.00-6.00   sec   283 MBytes  2.38 Gbits/sec</span><br><span class="line">[  4]   6.00-7.00   sec   283 MBytes  2.37 Gbits/sec</span><br><span class="line">[  4]   7.00-8.00   sec   283 MBytes  2.37 Gbits/sec</span><br><span class="line">[  4]   8.00-9.00   sec   283 MBytes  2.37 Gbits/sec</span><br><span class="line">[  4]   9.00-10.00  sec   283 MBytes  2.37 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[ ID] Interval           Transfer     Bandwidth       Retr</span><br><span class="line">[  4]   0.00-10.00  sec  2.76 GBytes  2.37 Gbits/sec    0             sender</span><br><span class="line">[  4]   0.00-10.00  sec  2.76 GBytes  2.37 Gbits/sec                  receiver</span><br><span class="line"></span><br><span class="line">iperf Done.</span><br></pre></td></tr></table></figure><p>Aquantiaチップの特性でデータロストから耐えられたように見えます。<br>スループットを見てみましょう。</p><img src="/new-technology/2022/07/30/sfp-plus-nbaset/throughput-fs.png" class="" width="800" title="alt"><p>茶色の実線のスループットは最初の1秒で2Gbpsまで順調に伸びています。1460バイトのTCPデータが連続して受信されている事が青色の実線でわかります。制御のためのデータ送受信もあり、全てが1460バイトにはなりませんが、中途半端なレングスのパケットが点在していません。iperf3の結果だけ見るとすこぶる結果は良好ですが、実際のグラフにしてみるとそれなりに速度の変動は発生しています。</p><p>次にRound tripです。</p><img src="/new-technology/2022/07/30/sfp-plus-nbaset/latency-fs.png" class="" width="800" title="alt"><p>iperf3の開始直後は5msを超える遅延（青いドット）がいくつか発生しています。断続的に1msに近いレイテンシは10秒間の全体を通して発生しています。見た目だけですと最初の「ASF-10G-T」よりも悪くなっているように見えますが、遅延が0に近い場所の青い線の厚みがあることで「ASF-10G-T」よりは遅延の数が少ないと想定されます。何よりスループットは十分な速度が出ていますので許容範囲と考えるべきでしょう。10Gbpsと2.5Gbpsという速度差から発生するギャップがあり、TCP通信の初期段階で通信速度の差をある程度調整することになりますが、一定の数の調整を無くすことはできません。</p><h2 id="スイッチのフローコントロール"><a href="#スイッチのフローコントロール" class="headerlink" title="スイッチのフローコントロール"></a>スイッチのフローコントロール</h2><p>2.5GbEに対応していないSFP+スイッチであっても、Aquantiaモジュール側の2.5Gbpsの自動認識および速度調整によって上手くいくことが確認できました。それはスイッチの<strong>フロー制御</strong>によっても支えられています。「フローコントロール」を無効にしてみます。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ iperf3 -c 192.168.x.1 -R</span><br><span class="line">Connecting to host 192.168.x.2, port 5201</span><br><span class="line">Reverse mode, remote host 192.168.x.2 is sending</span><br><span class="line">[  5] <span class="built_in">local</span> 192.168.x.1 port 49780 connected to 192.168.x.2 port 5201</span><br><span class="line">[ ID] Interval           Transfer     Bitrate</span><br><span class="line">[  5]   0.00-1.00   sec   176 MBytes  1.47 Gbits/sec</span><br><span class="line">[  5]   1.00-2.00   sec   172 MBytes  1.45 Gbits/sec</span><br><span class="line">[  5]   2.00-3.00   sec   159 MBytes  1.34 Gbits/sec</span><br><span class="line">[  5]   3.00-4.00   sec   163 MBytes  1.37 Gbits/sec</span><br><span class="line">[  5]   4.00-5.00   sec   170 MBytes  1.42 Gbits/sec</span><br><span class="line">[  5]   5.00-6.00   sec   183 MBytes  1.54 Gbits/sec</span><br><span class="line">[  5]   6.00-7.00   sec   176 MBytes  1.47 Gbits/sec</span><br><span class="line">[  5]   7.00-8.00   sec   183 MBytes  1.53 Gbits/sec</span><br><span class="line">[  5]   8.00-9.00   sec   194 MBytes  1.63 Gbits/sec</span><br><span class="line">[  5]   9.00-10.00  sec   183 MBytes  1.53 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[ ID] Interval           Transfer     Bitrate         Retr</span><br><span class="line">[  5]   0.00-10.00  sec  1.73 GBytes  1.48 Gbits/sec  13430             sender</span><br><span class="line">[  5]   0.00-10.00  sec  1.72 GBytes  1.48 Gbits/sec                  receiver</span><br><span class="line"></span><br><span class="line">iperf Done.</span><br></pre></td></tr></table></figure><p>汎用モジュールの「ASF-10G-T」ほど数字は落ち込みませんが、AquantiaチップのSFP＋モジュールでも2.5Gbpsのレートは出ません。こちらはRetrの数字が大きいことから、スイッチのフロー制御が無いまま、TCPの世界でリトライが多発しているように見えます。これはスイッチによっても差がでます。</p><p>スイッチのフローコントロールは、<strong>送信側</strong>にPauseフレームをマルチキャスト送信し、送信側を一時停止させます。システムの速度差が問題を引き起こすため、何らかの理由でスイッチのバッファが溢れそうになる時にはスイッチのフローコントロールによってネットワーク全体が安定的に動作します。ここまでの検証で、Aquantiaチップは十分なバッファを持っていることである程度は大量のトラフィックに耐えますが、バッファが溢れそうになった段階でスイッチに限界を通知し、スイッチにPauseフレーム送信を促すことにより通信が安定するものとみられます。</p><h2 id="FSでのAquantia-10GbE-SFP＋モジュール（RJ45）の指定方法"><a href="#FSでのAquantia-10GbE-SFP＋モジュール（RJ45）の指定方法" class="headerlink" title="FSでのAquantia　10GbE SFP＋モジュール（RJ45）の指定方法"></a>FSでのAquantia　10GbE SFP＋モジュール（RJ45）の指定方法</h2><p>これはFS社から教わりましたが、注文時に備考欄に  <mark class="label primary">Aquantia方案</mark>と記載して欲しいとのこと。この指定が無ければMarvellチップのモジュールになります。受注生産とのことで納品まで1か月程度掛かりますが、これはホームユーザーにとって強い味方になると思われます。</p><img src="/new-technology/2022/07/30/sfp-plus-nbaset/fs.png" class="" width="800" title="alt"><h2 id="2-5GbE-SFP＋モジュール（RJ45）"><a href="#2-5GbE-SFP＋モジュール（RJ45）" class="headerlink" title="2.5GbE SFP＋モジュール（RJ45）"></a>2.5GbE SFP＋モジュール（RJ45）</h2><p>スイッチが2.5GbEに対応しているなら、日本ではあまり見かけない2.5Gbase-Tモジュールが利用できる可能性があります。これはスイッチの対応状況に依存するため、事前にモジュールメーカーへ問い合わせが必須となります。スイッチのパフォーマンスを最大限活かせること、10GbEのチップほど温度が上がらないメリットがあります。モジュール自体の価格も10GBase-Tのものよりは安価です。</p><img src="/new-technology/2022/07/30/sfp-plus-nbaset/fs25.png" class="" width="480" title="alt"><h2 id="モジュールの温度"><a href="#モジュールの温度" class="headerlink" title="モジュールの温度"></a>モジュールの温度</h2><p>モジュールの温度に関して具体的な数値の記録は以下の通りです。</p><p>前回記事「<a href="/2022/05/28/sfp-plus/" title="10GネットワークとSFP+">10GネットワークとSFP+</a>」と同様にモジュールの表面に金属センサーを接触させ計測しています。</p><ul><li>ファンレススイッチでオートネゴによる10Gbpsと2.5Gbpsでのリンクアップの違い</li></ul><table><thead><tr><th>10GBase-Tモジュール</th><th>速度</th><th>温度</th></tr></thead><tbody><tr><td>ASF-10G-T</td><td>2.5Gbps</td><td>46℃</td></tr><tr><td>Aquantia10Gモジュール</td><td>2.5Gbps</td><td>45℃</td></tr><tr><td>ASF-10G-T</td><td>10Gbps</td><td>49.4℃</td></tr><tr><td>Aquantia10Gモジュール</td><td>10Gbps</td><td>49.5℃</td></tr><tr><td>（室温29℃）</td><td></td><td></td></tr></tbody></table><p> Marvell、Aquantiaのモジュールは温度に関して違いは見られません。そういえば、Aquantiaは3年前にMarvellに買収されましたね。今となってはMarvell、Aquantiaという名前で比較するにはふさわしく無いのかもしれません。</p><ul><li>ファン付きスイッチで2.5GbEチップと10GbEチップ（2.5Gbpsオートネゴ接続）との比較</li></ul><table><thead><tr><th>モジュール(2.5Gbpsで接続)</th><th>温度</th></tr></thead><tbody><tr><td>Cisco SFP-10G-T-80互換</td><td>37.7℃</td></tr><tr><td>Aquantia 10Gモジュール</td><td>38℃</td></tr><tr><td>Marvell 2.5Gモジュール</td><td>35.8℃</td></tr><tr><td>（室温31℃）</td><td></td></tr></tbody></table><p> Cisco SFP-10G-T-80互換のBroadcomチップは低発熱で使いやすいモジュールですが、やはり2.5Gbps専用チップに軍配が上がります。</p><h2 id="補足"><a href="#補足" class="headerlink" title="補足"></a>補足</h2><p>2.5Gbps対応スイッチとオートネゴのASF-10G-Tとの遅延を比較したグラフのスケールを拡大して比較したものを載せておきます。上記ではレイテンシの幅について「帯」という表現をしましたが、拡大してみるとレイテンシの状況にはかなりの違いが見られます。</p><img src="/new-technology/2022/07/30/sfp-plus-nbaset/compare.png" class="" width="1024" title="alt"><p>左：2.5Gbpsモジュール（フローコントロール無し）<br>右：ASF-10G-T（2.5GbEオートネゴシエーション）</p><p>0.5秒前後を切り取っただけであり、どちらのモジュールも1msを超える大きな遅延はあります。順調なケースと問題を抱えているケースとしての比較です。左はかなり良い状態を切り取っています。どのモジュールでも数百μsの遅延は定期的に発生します。しかし帯と表現した右側のグラフでは、300μsを超えるレイテンシが継続して発生しており、何らかの問題を抱えていることがわかります。<br>遅延だけでなく、スループットを併せて見ることで遅延は無いが送る量が少ないケースも見極める必要があります。</p><p>iperf3の出力結果だけでもある程度の状況は把握できますが、WireSharkで厳密にスループットのグラフや往復遅延時間を確認し、スイッチやモジュールの能力を見極められます。</p>]]></content>
    
    
    <summary type="html">&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;

&lt;p&gt;スイッチングハブのSFP&amp;#x2F;SFP+ポートは2.5Gbps&amp;#x2F;5Gbpsに対応していない製品が多いです。元々、10GBase-T&amp;#x2F;1000Base-Tなどもスイッチに対し無理やり10G Base-SRのように見せかけて動作させており、SFPの世界にはNBase-Tが一般的に存在しません。ビジネス向けスイッチではそもそもの対応がされていない製品も多く、ホームユーザー向けもSFPがあまり一般的ではないことから2.5GbEのサポートは普及していません。しかしながら対応モジュールを組み合わせることで回避することは可能です。&lt;/p&gt;</summary>
    
    
    
    <category term="Hardware" scheme="https://yoshi0808.github.io/new-technology/categories/Hardware/"/>
    
    <category term="Network" scheme="https://yoshi0808.github.io/new-technology/categories/Network/"/>
    
    
    <category term="SFP+" scheme="https://yoshi0808.github.io/new-technology/tags/SFP/"/>
    
  </entry>
  
</feed>
