<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>New technologies in our life</title>
  
  <subtitle>Device,Network,Code,etc...</subtitle>
  <link href="https://yoshi0808.github.io/new-technology/atom.xml" rel="self"/>
  
  <link href="https://yoshi0808.github.io/new-technology/"/>
  <updated>2024-02-14T22:00:16.542Z</updated>
  <id>https://yoshi0808.github.io/new-technology/</id>
  
  <author>
    <name>阿部　吉伸(Yoshinobu ABE)</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>VMWare 無償版ESXiの提供終了について（第2報）</title>
    <link href="https://yoshi0808.github.io/new-technology/2024/02/14/EOS-Free-esxi2/"/>
    <id>https://yoshi0808.github.io/new-technology/2024/02/14/EOS-Free-esxi2/</id>
    <published>2024-02-14T05:09:13.000Z</published>
    <updated>2024-02-14T22:00:16.542Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2024/02/14/EOS-Free-esxi2/vm1.png" class="" width="1024" title="alt"><span id="more"></span><h2 id="VMWareからの告知"><a href="#VMWareからの告知" class="headerlink" title="VMWareからの告知"></a>VMWareからの告知</h2><p>2024-02-09ごろに、以下のKBが告知されました。</p><blockquote><p>End Of General Availability of the Free vSphere Hypervisor (ESXi 7.x and 8.x) (2107518)<br> <a href="https://kb.vmware.com/s/article/2107518?lang=en_us">https://kb.vmware.com/s/article/2107518?lang=en_us</a></p></blockquote><blockquote><p>要約：<br> 無償版ESXiはVMWareのWebサイトではもはや利用できません。</p></blockquote><blockquote><p>解決方法：<br> 永久ライセンスから新しいサブスクリプション製品への移行の一環として、無償版ESXiは EOGA (End of General Availability) となりました。現時点では、同等の代替製品はありません。 </p></blockquote><p>つまり、無償版ESXiのインストールモジュールはすでにダウンロードできなくなりました。<br>なお、パッチについては、VMWareのカスタマーコネクトにログインした上で、従来通り、製品パッチをダウンロードできます。2&#x2F;14 20時においてダウンロードできました。</p><img src="/new-technology/2024/02/14/EOS-Free-esxi2/cc.png" class="" width="1024" title="alt"><p>1月30日に書いた記事「<a href="/new-technology/2024/01/30/EOS-Free-esxi/" title="VMWare 無償版ESXiの提供終了について">VMWare 無償版ESXiの提供終了について</a>」では、今後もESXiを新規利用またはアップグレードされる方はISOファイルのダウンロードとライセンスの取得をお勧めしていましたが、あまりに期間も短くお役に立てなかったかもしれません。</p><p>これにはもはや抗うことはできないようです。</p><h2 id="ESXiの代替の検討"><a href="#ESXiの代替の検討" class="headerlink" title="ESXiの代替の検討"></a>ESXiの代替の検討</h2><p>既に稼働済みの無償版ESXiは定期的なオンライン認証などがあるわけではないので当面の間利用は継続できますが、移行について検討しなければなりません。</p><h2 id="Proxmox-VE"><a href="#Proxmox-VE" class="headerlink" title="Proxmox VE"></a>Proxmox VE</h2><img src="/new-technology/2024/02/14/EOS-Free-esxi2/proxmox.png" class="" width="400" title="alt"><p>ProxmoxはLinuxユーザー、個人を中心に人気のあるプロダクトです。大学や団体の利用実績もあります。ドイツの2名の開発者からスタートした企業です。ESXiは比較的ネットワークカードやNVMeの種類を選びましたから、手軽に始められる仮想環境としてはまずはProxmoxが挙げられます。</p><blockquote><p>Proxmox Virtual Environment<br> <a href="https://www.proxmox.com/en/proxmox-virtual-environment/overview">https://www.proxmox.com/en/proxmox-virtual-environment/overview</a></p></blockquote><img src="/new-technology/2024/02/14/EOS-Free-esxi2/proxmox1.png" class="" width="1024" title="alt"><p>上記は取り急ぎproxmoxをセットアップして動作させたブラウザ画面のキャプチャです。現時点では、Ubuntu22をセットアップした程度でほとんど検証ができていません。</p><p>モニタ類も非常に見やすいです。</p><img src="/new-technology/2024/02/14/EOS-Free-esxi2/proxmox2.png" class="" width="800" title="alt"><p>Proxmoxにはバックアップサーバーという製品もありますが、Proxmox VE単独でバックアップのスケジューリングができます。これは無償版ESXiと比べて良い点です。SynologyNASのNFS4.1をマップしてバックアップしています。私のセットアップではまだGmail宛の通知がうまくいっていません。</p><img src="/new-technology/2024/02/14/EOS-Free-esxi2/proxmox3.png" class="" width="640" title="alt"><p>スナップショットもESXi同等にメモリの状態まで確保できます（ZFSファイルシステムで実行）。</p><p>少し気になる点としては無償で利用するには開発用リポジトリを使うことになり、有償のリポジトリはより安全にテストされたものが利用できる仕組みです。GUIでもモジュールは更新できますが、更新の単位は<code>apt update</code>と同様の感覚です。リモートワークなどに利用しているVMがあるのであればその点は留意する必要があります。</p><p>まだ十分な検証ができていませんが、手軽にESXiからの移行を始めるにはProxmoxの環境で検証をスタートさせるのも良いかもしれません。<br>Proxmox自体、セキュアブートでインストールでき、VMもセキュアブートの設定ができます。</p><p>設定はややLinux寄りです。結局はLinuxのコマンドをGUIにうまく形を変えているとも言えます。ESXiで慣れていると少しギャップがあります。ESXiのVMWare Remote Consoleは素晴らしい製品でしたが、そこまでは行かずとも、別ウィンドウでVNCから暗号化通信でコンソールにアクセスするなど操作性はとても良く、先進的であると感じさせます。</p><h2 id="XCP-NG（XEN-Orchestra）"><a href="#XCP-NG（XEN-Orchestra）" class="headerlink" title="XCP-NG（XEN Orchestra）"></a>XCP-NG（XEN Orchestra）</h2><img src="/new-technology/2024/02/14/EOS-Free-esxi2/xcpng.png" class="" width="800" title="alt"><p>新しいプロダクトではありませんが、Citrixが提供しているXen Serverから派生したオープンソースシステムでVatesという会社が提供しています。2012年にフランスで設立されています。おそらく規模は小さい会社のように見えます。こちらは企業中心、またホームラボでも利用されています。<br>仮想化という概念では素晴らしいものをXenから継承しており、本格的なHypervisorです。ProxmoxはHypervisorとも言えますが、VMが明確に独立しておらずDMAなどのメモリへのアクセスはかなり自由です。一方、XCP-NGは厳格にセパレートされておりセキュリティが高く、安定度も高い物と考えられます。その犠牲になるのは速度ですが、XEN Orchestraという有償のGUI管理ツールはわかりやすいため、ESXiユーザーはこちらの方が気にいるかもしれません。</p><blockquote><p>XCP-NG<br> <a href="https://xcp-ng.org/#easy-to-install">https://xcp-ng.org/#easy-to-install</a></p></blockquote><p>Xen OrchestraのGUIツールは有償ですが、個人が使うためのソースコードが提供されており、自身でコンパイルして利用する分には無償です。有償のプロダクトはXOA（Xen Orchestra Apliance）、ソースコードからビルドしたものはXOと呼ばれ区別されています。</p><p>Proxmoxと比べると少しグラフィカルな面は見劣りするでしょうか。</p><img src="/new-technology/2024/02/14/EOS-Free-esxi2/xo1.png" class="" width="1024" title="alt"><p>ネットワークなどは簡単にVLANを作成できて一覧として確認できるので管理しやすく思えます。</p><img src="/new-technology/2024/02/14/EOS-Free-esxi2/xo2.png" class="" width="1024" title="alt"><p>これはMellanox Connect X-3の１つのPort（ネイティブVLAN&#x3D;1）にさらに仮想のVLAN110を加えています。</p><p>こちらもバックアップはスケジューリングできます。ESXiのようにバックアップもブロック単位の差分で取得できます。<br>バックアップのメール通知は以下のような形で行われます。</p><img src="/new-technology/2024/02/14/EOS-Free-esxi2/xo3.png" class="" width="480" title="alt"><p>VMはブラウザから操作することになりますが、メニューの大きさも相まって、少し使いづらいと感じます。クライアントのVNCからXenOrchestraにSSHしてPort Forwardingすることによって暗号化した上で単独のVNCクライアントから操作できるようですが、こちらはまだ未確認です。</p><img src="/new-technology/2024/02/14/EOS-Free-esxi2/xo4.png" class="" width="1024" title="alt"><p>XCP-NG本体は特に難しいところもなくインストールができます。8.2.1はまだセキュアブートのセットアップはできません。VM自体はセキュアブートの設定ができます。また、Xen Orchestraの管理ツール自体は別ノードからアクセスする方が好ましく、最初からノード単位のフェールオーバーなどを考えて作られています。現在私のセットアップではXen OrchestraをESXiで、昔使っていたintelのPCにXCP-NGをセットアップしています。</p><p>XCP-NGの最新バージョンは現在8.2.1ですが、Ryzen環境で動作させると応答速度やネットワーク速度が遅く、Communityの情報を見ながら、古いintel core i7マシン（Intel(R) Core(TM) i7-8700 CPU @ 3.20GHz）に再インストールするなど、少し回り道してしまいました。8.3はまだベータ版ですが、そこではRyzen版の速度改善が見込めるようなのでこちらはまた少し時間を置いてから検証を開始するつもりです。なお、P-Core&#x2F;E-CoreのCPUは仮想環境でどのようにCPUが使われるのか読めないと考えられ、難しさを感じています。</p><p>XCP-NGはスナップショットやバックアップが少し古い時代を感じさせるところがあります。稼働中のVMをバックアップした後にレストアすると、OSをブートするところから始まります。つまり、メモリの内容が廃棄されてしまいます。オープンしていたファイルがどうなるのか、恐らくロールバックされるとは思いますが、検証をしっかりと行いたい箇所ではあります。</p><p>XO自体のリポジトリはGitHubにあり、かなり細かい単位でMasterブランチ（メインのソースコードの配置場所）がCommitされていきます。どこかでそれらの更新部分を取り込むには改めてXOのソースコードのコンパイルから必要になります。但し、これは簡単なスクリプトで手間をかけずに対処可能です。</p><p>私がXCP-NGに期待しているのはシステムの安定度です。ESXiも本当に安定していて、これまでハードウェアの故障以外でハングしたりすることは全くありませんでした。また、Xen Orchestraは、企業で数十台の仮想サーバを管理することを想定して作られており、管理のしやすさを感じます。</p><p>Proxmox、XCP-NGともに良いプロダクトのようで、最終的にはどちらかの仮想環境をメインに使い、2台構成でライブマイグレーション（仮想マシンのノード間の移動）まで実現できればと考えています。</p><p>海外のホームラボのパワーユーザーはどちらかといえば、XCP-NGを好むようにも見えます。これは簡単なProxmoxは面白くないということなのかもしれません。ESXiの代替としてはXCP-NGが今脚光を浴びているように見えます。</p><p>XCP-NG、Xen Orchestraへの理解を深めるには、ローレンスシステムズのTom氏が解説しているYouTubeビデオがわかりやすいと思います。</p><blockquote><p>Understanding How The XCP-NG &amp; Xen Orchestra Open Source Virtualization Platform Works<br> <a href="https://www.youtube.com/watch?v=CEUFHudLO1g&amp;t=447s">https://www.youtube.com/watch?v=CEUFHudLO1g&amp;t=447s</a></p></blockquote><p>今後、Xen Orchestraのセットアップ手順などを整理していきたいと考えています。</p>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2024/02/14/EOS-Free-esxi2/vm1.png&quot; class=&quot;&quot; width=&quot;1024&quot; title=&quot;alt&quot;&gt;</summary>
    
    
    
    
    <category term="ESXi" scheme="https://yoshi0808.github.io/new-technology/tags/ESXi/"/>
    
  </entry>
  
  <entry>
    <title>VMWare 無償版ESXiの提供終了について</title>
    <link href="https://yoshi0808.github.io/new-technology/2024/01/30/EOS-Free-esxi/"/>
    <id>https://yoshi0808.github.io/new-technology/2024/01/30/EOS-Free-esxi/</id>
    <published>2024-01-30T02:00:00.000Z</published>
    <updated>2024-02-14T22:08:39.021Z</updated>
    
    <content type="html"><![CDATA[<h2 id="VMWare製品の買い切りモデルからサブスクリプションモデルへの移行"><a href="#VMWare製品の買い切りモデルからサブスクリプションモデルへの移行" class="headerlink" title="VMWare製品の買い切りモデルからサブスクリプションモデルへの移行"></a>VMWare製品の買い切りモデルからサブスクリプションモデルへの移行</h2><p>VMWareのKBで以下のタイトルの文書が2024&#x2F;1&#x2F;22に公開されています。</p><blockquote><p>VMware End Of Availability of Perpetual Licensing and SaaS Services (96168)<br> <a href="https://kb.vmware.com/s/article/96168?lang=en_US">https://kb.vmware.com/s/article/96168?lang=en_US</a></p></blockquote><p>第2報については、「<a href="/new-technology/2024/02/14/EOS-Free-esxi2/" title="VMWare 無償版ESXiの提供終了について（第2報）">VMWare 無償版ESXiの提供終了について（第2報）</a>」を参照してください。</p><span id="more"></span><p>VMWareはスタンドアロン製品の提供を終了し、サブスクリプションモデルに変更されるとのこと。無償版ESXiは対象外ではという期待もありましたが、上記のKBを補足する形のブログとして以下が公開されています。</p><blockquote><p>VMware End Of Availability of Perpetual Licensing and SaaS Services (VMWare Blog)<br> <a href="https://blogs.vmware.com/cloud-foundation/2024/01/22/vmware-end-of-availability-of-perpetual-licensing-and-saas-services/">https://blogs.vmware.com/cloud-foundation/2024/01/22/vmware-end-of-availability-of-perpetual-licensing-and-saas-services/</a></p></blockquote><p>このページではサブスクリプションへの移行可否を判断可能なプロダクト一覧があります。残念ながら、表の中の移行対象外プロダクトとして、「VMware vSphere Hypervisor (free edition)」の記載があります。</p><p>そもそもの発表は2023年12月11日の発表に遡ります。</p><blockquote><p>VMware by Broadcom、製品ラインアップとライセンス モデルを大幅に簡素化<br> <a href="https://news.vmware.com/company/vmware-by-broadcom-business-transformation">https://news.vmware.com/company/vmware-by-broadcom-business-transformation</a></p></blockquote><p> 正式にサブスクリプションモデルに移行する事が発表された後の製品の明確化という事ですが、ソフトウェアのダウンロード自体はいつ出来なくなっても不思議ではない状態となっています。一方、昨年末の発表でも改めて触れられていますが、すぐにサポート終了というわけではなく、あらかじめ定められたサポート期限（ジェネラルサポート期限）まではパッチなども提供されるとのことです。</p><h2 id="無償版ESXiのサポート期限"><a href="#無償版ESXiのサポート期限" class="headerlink" title="無償版ESXiのサポート期限"></a>無償版ESXiのサポート期限</h2><p>無償版ESXiに関するサポート期限は以下の通りです。</p><img src="/new-technology/2024/01/30/EOS-Free-esxi/lifecycle.png" class="" width="1024" title="alt"><blockquote><p>Product Lifecycle Matrix<br> <a href="https://lifecycle.vmware.com/#/?advancedFilter=checkbox_sup&amp;filters=%7B%22name%22:%22esxi%22,%22lifecycle_policy%22:null,%22text%22:null%7D">https://lifecycle.vmware.com/#/?advancedFilter=checkbox_sup&amp;filters=%7B%22name%22:%22esxi%22,%22lifecycle_policy%22:null,%22text%22:null%7D</a></p></blockquote><p>まず見るべきはパッチ提供が行われるGeneral Supportの期限です。ESXi7は2025&#x2F;4&#x2F;2であり、あと1年と少しです。また、ESXi8については、2027&#x2F;10&#x2F;11と3年半の猶予があります。</p><p>もちろん、今後それなりの費用を支払ってESXiを使う事も選択肢としては挙げられますが、ホームユーザーにとっては高額となるライセンス費用を払ってまでESXiに拘る方は少ないものと考えられます。</p><h2 id="現時点で考えられるアクションプラン"><a href="#現時点で考えられるアクションプラン" class="headerlink" title="現時点で考えられるアクションプラン"></a>現時点で考えられるアクションプラン</h2><p>このような状況からは以下のように考えられるでしょうか。</p><ul><li><p>新規にESXiをインストールしてみたいと考えているユーザー向け<br> 残念ながら、無償での利用終了が覆る事は無いと考えられるため新規にホームユーザーがESXiを覚えようとする事は仕事で利用する等の理由がない限りお勧めできません。</p></li><li><p>既にFree ESXiを運用しているユーザー向け</p><ol><li>代替ソフトウェアを速やかに探し、移行する</li><li>ESXi8のライフサイクルが長いプロダクトにアップグレードの上、当面は情報収集し、ESXiの運用を継続する</li></ol></li></ul><p>なお、既にESXiを運用されている方であっても、何らかのトラブルでクリーンインストールが必要となる可能性は残ります。<br>このため、以下のアクションは速やかに行っておくべきです。またアップグレードでもISOファイルは利用できます。</p><ol><li>無償版ESXi8のモジュール（ISOファイル）をダウンロードしておくこと</li><li>無償版ESXi8のライセンスを取得しておくこと</li></ol><p>詳細は、「<a href="/new-technology/2023/06/18/esxi-upgrade8/" title="VMware ESXiを8.0にアップグレードする">VMware ESXiを8.0にアップグレードする</a>」、「<a href="/new-technology/2023/07/07/building-setup-esxi8/" title="ESXi8.0をRyzen5 5600Gで構築">ESXi8.0をRyzen5 5600Gで構築</a>」の記事を参照してください。</p><h2 id="今後のアクションプラン"><a href="#今後のアクションプラン" class="headerlink" title="今後のアクションプラン"></a>今後のアクションプラン</h2><p>これは各個人によって仮想環境の利用方法や考え方やが異なりますので、コメントは難しいところですがポイントになる点を列挙してみます。</p><ul><li><p>仮想環境のバックアップを主眼にする場合<br>　私の場合はNASのソフトウェアでVMの定期バックアップを取得しており、仮想環境の一番のメリットと感じています。<br>　NASによる仮想環境のバックアップはESXiおよびHyper-V Serverが対象です。<br>　Hyper-V Server 2019も移行対象にはなりますが、既にメインストリームの終了を2024年1月に迎えており、短命と考えられます。</p><blockquote><p>Microsoft Lifecycle<br> <a href="https://learn.microsoft.com/ja-jp/lifecycle/products/hyperv-server-2019">https://learn.microsoft.com/ja-jp/lifecycle/products/hyperv-server-2019</a></p></blockquote><ul><li>今後NASのソフトウェアや他のバックアップソリューションが別の仮想環境システムに対応してくればそれが選択の候補になり得ます。</li><li>Windows Serverのライセンス購入も選択肢となりますが、やはり個人向けには高価で集約するコストメリットが無くなってしまいます。</li><li>Linuxの全体バックアップをNASで確保しつつ、LinuxのKVMで個別の仮想マシンを管理するという方法も考えられます。</li></ul></li><li><p>その他の仮想環境への移行を主眼にする場合<br> 仮想化ソフトウェアの信頼性を見極める必要があります。<br> リモートワークの一部に利用している製品であれば、信頼性（安全性、可用性）が必要ですから、仮想化ソフトウェアが期待に満たない場合はベアメタルに移行する事も必要でしょう。</p></li><li><p>コンテナへの移行など別の技術を活用する場合<br> バージョンアップなどの移行が容易であればよりリソースが少なく済む可能性はあります。最新パッチの当たったイメージが開発ベンダーから提供されるならそれ以上言うことありません。セキュリティ製品などOS単位でのソフトウェアや、VLANや仮想ネットワークなど、ネットワークが主眼である場合は、他のソリューションも視野に入れることとなります。</p></li></ul><h2 id="補足"><a href="#補足" class="headerlink" title="補足"></a>補足</h2><p>VMWareのコミュニティの中心的存在であるVMWareのWilliam氏（lamw）は、定期的なブログのポスト、Community(Flings)でのCommunity Driverなどの再整理など今年に入ってからも意欲的に活動されています。</p><blockquote><p>Wiliam Lam氏のブログ<br> <a href="https://williamlam.com/">https://williamlam.com/</a></p></blockquote><blockquote><p>VMWare Community(Flings)<br> <a href="https://communities.vmware.com/t5/Flings/ct-p/77">https://communities.vmware.com/t5/Flings/ct-p/77</a></p></blockquote><p>私個人としては当面情報収集をし、急いで他のシステムに移行する事は考えていませんが、継続して代替策は検討していきたいと考えています。</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;VMWare製品の買い切りモデルからサブスクリプションモデルへの移行&quot;&gt;&lt;a href=&quot;#VMWare製品の買い切りモデルからサブスクリプションモデルへの移行&quot; class=&quot;headerlink&quot; title=&quot;VMWare製品の買い切りモデルからサブスクリプションモデルへの移行&quot;&gt;&lt;/a&gt;VMWare製品の買い切りモデルからサブスクリプションモデルへの移行&lt;/h2&gt;&lt;p&gt;VMWareのKBで以下のタイトルの文書が2024&amp;#x2F;1&amp;#x2F;22に公開されています。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;VMware End Of Availability of Perpetual Licensing and SaaS Services (96168)&lt;br&gt; &lt;a href=&quot;https://kb.vmware.com/s/article/96168?lang=en_US&quot;&gt;https://kb.vmware.com/s/article/96168?lang=en_US&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;第2報については、「&lt;a href=&quot;/new-technology/2024/02/14/EOS-Free-esxi2/&quot; title=&quot;VMWare 無償版ESXiの提供終了について（第2報）&quot;&gt;VMWare 無償版ESXiの提供終了について（第2報）&lt;/a&gt;」を参照してください。&lt;/p&gt;</summary>
    
    
    
    
    <category term="ESXi" scheme="https://yoshi0808.github.io/new-technology/tags/ESXi/"/>
    
  </entry>
  
  <entry>
    <title>ZikeDrive Z666 USB4エンクロージャー</title>
    <link href="https://yoshi0808.github.io/new-technology/2024/01/13/ZikeDrive-Z666/"/>
    <id>https://yoshi0808.github.io/new-technology/2024/01/13/ZikeDrive-Z666/</id>
    <published>2024-01-12T15:56:03.000Z</published>
    <updated>2024-02-10T01:05:36.883Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2024/01/13/ZikeDrive-Z666/title.png" class="" width="1024" title="alt"><p class="onepoint">この記事で実現すること</p><p>USB4 40Gbpsに対応したNVMe　M.2対応のSSDエンクロージャーを紹介します。いわゆる外付けディスクです。ノートPCの外付けとして直近のNVMe M.2 SSDの状況を鑑みつつ、USB4&#x2F;Thunderbolt4&#x2F;Thunderbolt3などプロトコルの違い、実運用における速度を見ていきます。</p><span id="more"></span><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>2023年はSSDがとても廉価だった年でした。非常に高性能なNANDフラッシュメモリが台頭してきた事もあり、外付けSSDとしての利用価値が高まってきています。USB-Cのコネクタ形状はiPhone15での対応もあり、最近デファクトになりつつある規格ですが、一方で新しいPCやMacではUSB4&#x2F;Thunderbolt4への対応が進んでいます。OS本体のストレージとは別に目的やジャンル別のデータ保存に外付けディスクを”切り替える”使い方もあろうかと思います。特にノートPCのディスク容量は大きくないですし、あまり使わないデータは外付けディスクで管理したいところです。</p><p>これまでUSB-CのSSDエンクロージャーといえば、USB3.2 Gen2の10Gbpsで接続可能なもの、一般的にはRealtekのRTL9210チップを搭載した安価なものが多くを占めます。今回のZIKE Z666は40Gbps対応となり、今のNVMeの能力を活かすことが期待できます。</p><h2 id="ZIKE-Z666"><a href="#ZIKE-Z666" class="headerlink" title="ZIKE Z666"></a>ZIKE Z666</h2><p>ZIKEはアメリカ発のベンチャー企業で、2021年に起業したアメリカのデラウェア州にある企業です。</p><ul><li>ZIKE<br> <a href="https://ziketech.com/">https://ziketech.com</a></li></ul><p>商品説明のページでは、Z666は3,811MB&#x2F;sの読み取り速度と3,199 MB&#x2F;sの書き込み速度があるとの事。1USB3.2Gen2のSSD外付けドライブの3倍速です。ASMediaのAS2464PDチップを備え、USB4ケーブルが付属、NVMeの取り付けに工具不要。ケースそのものはアルミで作られ、その周りを透明なABS樹脂で覆ったものとなっています。サイズは112×66.8×18(mm)、重さ245gとなっており従来のエンクロージャと比べれば大きめです。外への持ち出しを考えられて作られてます。50度を超え70度にもなるNVMeを直接アルミで放熱することは機械にとっては良くても、人にとっては優しくないわけですが、一般消費者向けに（きちんと）作られた製品です。</p><img src="/new-technology/2024/01/13/ZikeDrive-Z666/zike-1.png" class="" width="1024" title="alt"><p>ストレージの制限があるノート、特にMacbookのユーザーから人気があります。エンクロージャに取り付け可能な短いケーブルが付属します。Z666はあくまでエンクロージャーですので、中身のNVMeは別途購入する必要があります。<br>スペックの概略は以下の通りです。</p><table><thead><tr><th>各スペック</th><th>説明</th></tr></thead><tbody><tr><td>インタフェース</td><td>USB4 40Gbps Thunderbolt3&#x2F;4互換、USB3.2Gen2 10Gbps、USB3.2Gen1 5Gbps、USB2.0 480Mbps</td></tr><tr><td>SSD形状</td><td>M.2 M-Key PCIe Gen 4x4&#x2F;2280</td></tr><tr><td>容量</td><td>1、2、4、16TBまたはそれ以上</td></tr><tr><td>互換性</td><td>Windows,MacOS,Linux,iPad,PlayStation</td></tr></tbody></table><p>AS2464PDチップとNVMeとの間がPCIe Gen4x4というのが魅力です。<br>ファームウェアのアップデートもウェブサイトで公開されており、質問やユーザーレポートの投稿も可能です。</p><p>詳細は、Zikeのウェブサイトで確認してください。</p><ul><li>Z666<br> <a href="https://ziketech.com/products/zikedrive-worlds-first-and-fastest-usb4-ssd-drive?variant=42809341608097">https://ziketech.com/products/zikedrive-worlds-first-and-fastest-usb4-ssd-drive?variant=42809341608097</a></li></ul><h2 id="ベンチマーク"><a href="#ベンチマーク" class="headerlink" title="ベンチマーク"></a>ベンチマーク</h2><p>ここで利用するSSDについて紹介します。速度だけでいえば、WD_Black SN850X NVMeやSamsungの990Proがメジャーです。しかし、ケーブル接続する外付けディスクの利用目的としてはそこまで速度を求めるものでもないでしょうから、それに準ずる比較的廉価な製品を選定して確認していきます。Gen4x4の速度が必要であればマザーボードに直接NVMeをセットされる事をお勧めします。</p><p>まずは、SK hynix Platinum P41 NVMe 2TBで確認します。</p><img src="/new-technology/2024/01/13/ZikeDrive-Z666/p41.png" class="" width="480" title="alt"><p>Platinum P41は990Pro、SN850Xと比較し価格は少し廉価ですが、2TBのモデルで速度はRead 7,000MB&#x2F;s、Write 6,500MB&#x2F;sであり、990ProのRead 7,450MB&#x2F;s、Write Write 6,900MB&#x2F;sの速度に迫り実力としては十分です。このモデルはDRAMを持っているので、ベンチマークには有利です。</p><h3 id="Windows-CrystalDiskmark"><a href="#Windows-CrystalDiskmark" class="headerlink" title="Windows CrystalDiskmark"></a>Windows CrystalDiskmark</h3><img src="/new-technology/2024/01/13/ZikeDrive-Z666/CrystalDiskMark.png" class="" width="480" title="alt"><p>ハードウェアはMinisForum UM790 Pro(Windows11 Home)で、USB4ポートで確認しました。フォーマットはexFATです。スペック通りの速度です（書き込みはスペック以上の速度です）。</p><p>デバイスマネージャーから取り外しポリシーを高パフォーマンスに変更するとランダム書き込みの値が改善します。これは普段から接続しっぱなしの方にお勧めの設定です。</p><img src="/new-technology/2024/01/13/ZikeDrive-Z666/policy.png" class="" width="480" title="alt"><img src="/new-technology/2024/01/13/ZikeDrive-Z666/HighPerformance.png" class="" width="480" title="alt"><h3 id="macOSのベンチマーク"><a href="#macOSのベンチマーク" class="headerlink" title="macOSのベンチマーク"></a>macOSのベンチマーク</h3><img src="/new-technology/2024/01/13/ZikeDrive-Z666/AmorphousDiskMark.png" class="" width="480" title="alt"><p>Macbook Pro(M2)のThunderbolt4ポートで確認しました。フォーマットはAPFSです。Windowsよりは速度は落ちますが、アプリケーションが違うものなので単純比較は難しいところです。macOSでは他にBlackmagicというDiskパフォーマンスベンチマークソフトがあります。</p><img src="/new-technology/2024/01/13/ZikeDrive-Z666/Blackmagic.png" class="" width="480" title="alt"><p>前回の記事「<a href="/new-technology/2023/12/16/MiniSSDCase/" title="iPhoneに繋がるミニSSDケース">iPhoneに繋がるミニSSDケース</a>」で書いた小型のRTL9210エンクロージャではRead&#x2F;Writeともに980MB&#x2F;s程度でしたから格段に速度が向上しています。<br>もちろん、USB4に対応していないUSB3.x Gen2のホストにZ666を接続した場合は10Gbpsと速度は落ちますが、アクセス可能です。</p><p>USB3.2 Gen2のエンクロージャーをご利用されている方は、読み込み書き込み共にCrystalDiskMarkのシーケンシャルで1,000MB&#x2F;s前後の数字を目にされているのでは無いでしょうか。これは8Gbps前後になりますので、USBを経由する実効速度は理論値よりは2割ほど落ちます。</p><p>今回は最も遅い箇所が40Gbpsのケーブルですから5GB&#x2F;sが理論値となり、それの8割とすれば4GB&#x2F;sです。Windowsの結果を見れば大体このような数字なのかなと感じます。</p><h2 id="Z666のケース構造"><a href="#Z666のケース構造" class="headerlink" title="Z666のケース構造"></a>Z666のケース構造</h2><p>Z666のフタはプラでパチンと嵌め込む形になっているので、手で押し開けます。</p><img src="/new-technology/2024/01/13/ZikeDrive-Z666/zike-2.png" class="" width="1024" title="alt"><p>上蓋には3mm厚程度のサーマルパッドがあります。本体内部下部にはNVMeを支える2つの長方形のクッションが糊付けされています。<br>NVMeはラバープラグを回転させて固定させる方式です。お世辞にもしっかりと固定されるとはいえませんが蓋を閉めるので大丈夫ということでしょうか。頻繁にNVMeの入れ替えを行う場合を想定して便利に作られています。<br>内部のクッションは剥がせそうではありますが、基本的に片面実装（チップが片方のみあるもの）のNVMeを想定しているようです。<br>また上蓋にサーマルパッドがあることから、ヒートシンク付きのNVMeは使えません。物理的には接続可能ですが、その場合は蓋が閉まりません。</p><p>ケースはABS樹脂とアルミの隙間があるため、ここから熱を逃すようです。ケースの外側はほんのり暖かい程度で熱さは感じません。</p><h2 id="Z666の購入"><a href="#Z666の購入" class="headerlink" title="Z666の購入"></a>Z666の購入</h2><p>ZIKEのWebサイトから海外通販で購入することになります。shopPayがあるので、Ubiquitiなどの他の通販で利用されている場合は再度住所の登録が不要です。日本からは送料無料で1月初旬で18,000円弱です（為替で変動するようです）。</p><p>レビューを見ていると結構楽しいです。皆さんCrystalDiskMarkの画面ショットを貼り付けていらして、このような光景は世界共通ですね。<br>速いのでLaptopでSQL Serverに使えるというコメントがあったり、M2 Ultra Mac Studioに990Proを付けて3200&#x2F;3100のBlackMagicベンチマーク結果で「こんなものなのかな」というコメントなど、平和ですね。</p><h2 id="SSDの進化"><a href="#SSDの進化" class="headerlink" title="SSDの進化"></a>SSDの進化</h2><p>NVMeに限らず、SSDにはDRAMキャッシュがあるもの、ないものと2種類の製品が存在します。</p><p>以下は、Platinum P41　2TBを横から撮影したものです。</p><img src="/new-technology/2024/01/13/ZikeDrive-Z666/NVMe.png" class="" width="1024" title="alt"><p>右側のM.2コネクタから順に、コントローラー、DRAM、NANDフラッシュ2枚が並んでいます。M.2コネクタから近い順に速いチップを配置していくのが基本です。<br>各社凌ぎを削っている部分ですが、このような配置だとNANDフラッシュは1TBづつ配置されている事になります。<br>コントローラー、DRAMキャッシュ、NANDフラッシュと片面実装にするためにギリギリで詰め込まれているのがわかります。<br>176層というNANDフラッシュ1つに1TB、それを2個搭載する事で2TBという容量を実現しています。</p><p>ただ、このデザインから見えるように、すでに基盤上はチップで埋まっているので、これ以上NANDフラッシュメモリを追加できません。さらに片面のまま4TBの容量とするには微細化が求められることになります。Platinum P41の製品バリエーションとして最大容量は2TBとなっています。<br>WD SN850Xの4TBはいくつかの第三者レビューを見る限りではNANDフラッシュが裏面に2枚あるそうで両面実装となっています。</p><p>Samsungの990Proの4TBは片面実装になっています。王者の貫禄というか、意地でしょうか。凄まじさを感じさせます。</p><blockquote class="blockquote-center"><p>4TB NVMe Laptop Upgrade<br>It’s the one and only on the market—the 990 PRO 4TB is now compatible with laptops. Thanks to Samsung’s NAND Stacking technology, 990 PRO is the first 4TB m.2 NVMe Internal SSD with a single-sided form—meaning it fits easily in the most popular laptops for an instant upgrade in high-performing storage.</p><p>4TB NVMeラップトップ・アップグレード<br>990 PRO 4TBがラップトップに唯一無二の存在となりました。サムスンのNANDスタッキング・テクノロジーのおかげで、990 PROは、片面実装の初の4TB  M.2 NVMe内蔵SSDとなりました。<br>つまり、高性能ストレージを即座にアップグレードするために、最も人気のあるラップトップに簡単に収まることを意味します。</p></blockquote><ul><li>Samsung<br> <a href="https://www.samsung.com/us/computing/memory-storage/solid-state-drives/990-pro-pcie-4-0-nvme-ssd-4tb-mz-v9p4t0b-am/">https://www.samsung.com/us/computing/memory-storage/solid-state-drives/990-pro-pcie-4-0-nvme-ssd-4tb-mz-v9p4t0b-am/</a></li></ul><h2 id="SSDの選択"><a href="#SSDの選択" class="headerlink" title="SSDの選択"></a>SSDの選択</h2><p>先ほど紹介したZIKEの掲示板では高額なホストに高額なNVMe(990Pro)を付けたからといって大したパフォーマンスの向上は見込めないように見えます。</p><p>ケーブルやUSBを経由するオーバーヘッドがある場合には、SSD側のDRAMキャッシュがある程度有効になります。NANDフラッシュへの遅い書き込みをカバーするために、できるだけ応答を早く返すことで遅いケーブル上での待ちを少なくすることが重要です。</p><p>速度以外にも、容量の確保、発熱を抑えることも、コストを抑えることも大事です。</p><p>ZIKEの掲示板でもLexarのNM790というNVMeが紹介されていました。Lexarは昔からカメラを趣味にしている人であればよく知られているブランドで世界的にも有名です。</p><p>このNM790はYMTCの232層NANDフラッシュとMaxioのMAP1602Aコントローラーを使ったNVMeです。他社でもこの組み合わせのNVMeは大量に出回っています。</p><p>このモデルは、DRAMレスとなっており、SK hynixのものよりは1回り小さいNANDチップが4枚片面に乗せられています。コントローラーも1回りサイズが小さくなっており、うまく片面に乗せられたという感じです。このコントローラーは4多重で動作でき、負荷分散ができます。RAIDシステムで分散して処理速度を稼ぐのと同じ考え方ですね。ローテクな感じですが、負荷分散によりボトルネックが小さく、DRAMキャッシュの複雑な機構も不要ですので、廉価で低発熱が期待できます。</p><h3 id="各SSDをZ666で速度テスト"><a href="#各SSDをZ666で速度テスト" class="headerlink" title="各SSDをZ666で速度テスト"></a>各SSDをZ666で速度テスト</h3><p>手元には以下のNVMeを用意し、Macbookで速度検証してみます。</p><ul><li>Samsung 970EVO Plus 1TB</li><li>SK hynix Platinum P41 2TB</li><li>Lexar NM790 2TB</li></ul><p>テスト結果は以下のとおりです。</p><table><thead><tr><th>テスト項目</th><th>Samsung</th><th>SK hynix</th><th>Lexar</th></tr></thead><tbody><tr><td></td><td>970EVO Plus</td><td>Platinum P41</td><td>NM790</td></tr><tr><td>SEQ1M Q8　Read</td><td>3368</td><td>3386</td><td>3379</td></tr><tr><td>SEQ1M Q1　Read</td><td>2901</td><td>3120</td><td>3028</td></tr><tr><td>RND4K QD64　Read</td><td>890</td><td>916</td><td>905</td></tr><tr><td>RND4k QD1　Read</td><td>62</td><td>65</td><td>68</td></tr><tr><td>SEQ1M Q8　Write</td><td>1312</td><td>3178</td><td>2679</td></tr><tr><td>SEQ1M Q1　Write</td><td>1176</td><td>2677</td><td>2887</td></tr><tr><td>RND4K QD64　Write</td><td>262</td><td>305</td><td>221</td></tr><tr><td>RND4k QD1　Write</td><td>46</td><td>44</td><td>31</td></tr><tr><td>コントローラー温度</td><td>65</td><td>61</td><td>47</td></tr><tr><td>DRAM温度</td><td>84</td><td>72</td><td>-</td></tr><tr><td>NAND温度</td><td>72</td><td>60</td><td>50</td></tr></tbody></table><p>※パフォーマンスのテスト数値はMB&#x2F;s、温度は摂氏となります。DiskMarkを2回実行し、赤外線で計測するタイプの温度計でチップ表面を計測し、一番温度の高い数値を採用しています。</p><ul><li>970EVO Plus（PCIe3x4）のSEQ Readはカタログスペック3,500MBなので読み込みのボトルネックは発生していない。</li><li>970EVO Plus（PCIe3x4）のSEQ Writeはカタログスペック3,300MBなのでこの環境では半分以下に落ち込んでいる。逆に言えば、ホスト、ADMediaチップ、NVMeのコントローラーがPCIe4x4で揃っていればボトルネックが生まれにくい。</li><li>PCIe4x4対応のPlatinum P41とNM790のシーケンシャル処理はReadにせよWriteにせよ3,300MBあたりが壁になっている。Macbook本体やASMediaチップがPCIe4x4（理論値64Gbps）であってもケーブルが最大40Gbpsの制約、プロトコル変換のオーバーヘッドに加え、Macbook&#x2F;macOSが持つ何らかの要因によるオーバーヘッドがあると考えられる（Windwos11と比較しても遅く見える）。</li><li>DRAMキャッシュがないNM790は大量のランダムな書き込みには特に弱い。PCIe3x4の970EVO Plusを下回る。</li><li>970EVO Plusは速度が頭打ちになっているにも関わらず発熱量はかなり大きい。</li><li>NM970はかなり温度が低い。DRAMを使わない分処理が単純なのとNANDチップが高性能というのも一理あるかもしれない。</li></ul><p>廉価にPCIe4x4のNVMeを使える機会があるのであれば無理にPCIe3x4の970EVO Plusを使う意味は無さそうです。<br>なお、容量が4TBとなると、この3つのうちではNM790が候補になります。</p><p>あくまでベンチマークだけの話なので参考に留めていただけると幸いです。WindowsのCrystalDiskMarkはスレッド数（多重度）も指定できましたが、macOS版では特に指定がありません。1スレッドという事なのかもしれません。</p><h4 id="大きなサイズのファイルコピー"><a href="#大きなサイズのファイルコピー" class="headerlink" title="大きなサイズのファイルコピー"></a>大きなサイズのファイルコピー</h4><p>ESXiの仮想マシンvmdkファイル42.95GByteを対象とし、macOSからZ666へ書き込みます。</p><table><thead><tr><th>テスト項目</th><th>970EVO Plus</th><th>Platinum P41</th><th>NM790</th></tr></thead><tbody><tr><td>42.95GBファイルをMac→Z666へコピー</td><td>31秒</td><td>13秒</td><td>16秒</td></tr></tbody></table><p>この結果を見る限りではやはりPCIe4x4のチームが有利ですね。外付けDiskで40GByteのファイルが10秒台というのは魅力的です。Platinum P41でベンチマークのシーケンシャルWrite処理を超える3.3GB&#x2F;sという数値が出ています。素晴らしい結果ですが、やっぱりMacBook Pro（M2）では何かしらの3.3GBの壁があるように見えます。</p><h4 id="小さなサイズの多くの数のファイルコピー"><a href="#小さなサイズの多くの数のファイルコピー" class="headerlink" title="小さなサイズの多くの数のファイルコピー"></a>小さなサイズの多くの数のファイルコピー</h4><p>このブログで使っているモジュール群のNode Moduleやgitは細かいファイルをたくさん生成します。<br>2.07GBのフォルダに、54,301ファイルが存在しています。</p><table><thead><tr><th>テスト項目</th><th>970EVO Plus</th><th>Platinum P41</th><th>NM790</th></tr></thead><tbody><tr><td>54,301個のファイルをMac→Z666へコピー</td><td>23秒</td><td>23秒</td><td>23秒</td></tr></tbody></table><table><thead><tr><th>テスト項目</th><th>970EVO Plus</th><th>Platinum P41</th><th>NM790</th></tr></thead><tbody><tr><td>54,301個のファイルをZ666→Macへコピー</td><td>21秒</td><td>21秒</td><td>22秒</td></tr></tbody></table><p>OS処理のオーバーヘッドが大きいようで各NVMeでほぼ同じ時間となりました。ランダムに弱いという点はベンチマークではありましたが、バックアップ目的での小さなファイルコピーを中心に利用するならばあまりメディアの違いは関係なさそうです。速度はおおよそ90MB&#x2F;sです。</p><p>RTL9210の10Gbps対応のエンクロージャにNM790をセットして書き込んでみます。<br>結果は26秒でした。OSが細かいファイルを処理する事はやはりオーバーヘッドが大きいため、90MB&#x2F;s程度の速度であれば高速デバイスのメリットは活かしきれず、USB3.2 Gen2とUSB4との違いはありません。</p><p>今回のケースでは敢えて極端な例を示していますが、一般的によく利用される写真、動画、文書などのファイルであれば効率的にZ666のパフォーマンスを活かせます。</p><h2 id="USB-Thunderboltと対応PC"><a href="#USB-Thunderboltと対応PC" class="headerlink" title="USB&#x2F;Thunderboltと対応PC"></a>USB&#x2F;Thunderboltと対応PC</h2><p>USBについてのおさらいです。</p><table><thead><tr><th>USB規格名</th><th>データ転送速度</th><th>旧名称</th><th>マーケティング名</th></tr></thead><tbody><tr><td>USB3.2 Gen1</td><td>5Gbps</td><td>USB3.1 Gen1、USB3.0</td><td>USB　5Gbps、旧（SuperSpeedUSB、SSマーク）</td></tr><tr><td>USB3.2 Gen2</td><td>10Gbps</td><td>USB3.1 Gen2</td><td>USB　10Gbps、旧（同上）</td></tr><tr><td>USB3.2 Gen2x2、USB4 Gen2x2</td><td>20Gbps</td><td></td><td>USB  20Gbps、旧（SuperSpeed USB 20Gbps、USB4  20Gbps）</td></tr><tr><td>USB4 Gen3x2</td><td>40Gbps</td><td></td><td>USB 40Gbps、旧（USB4 40Gbps）</td></tr><tr><td>USB4 Ver2.0</td><td>80Gbps</td><td></td><td></td></tr></tbody></table><p>まずZ666を利用するにあたり、最低限度の必要な確認です。お使いのPCでUSB4(Thunderbolt4&#x2F;Thunderbolt3)に対応していなければZ666のメリットは活かしきれません。私はUSB3.2Gen2x2のホストを保有していないので確認できませんが、ASMediaのASM2464PDの紹介ページではUSB3.2、USB2.0の後方互換があると記載されています。USB-Cがあってもお使いのPCがUSB3.2 Gen2止まりであれば従来のRealtekのRTL9210のエンクロージャーで十分です。</p><ul><li>ASMedia ASM2464PD<br> <a href="https://www.asmedia.com.tw/product/802zX91Yw3tsFgm4/C64ZX59yu4sY1GW5">https://www.asmedia.com.tw/product/802zX91Yw3tsFgm4/C64ZX59yu4sY1GW5</a></li></ul><p>USB4はThunderbolt3をベースに作られています。同じUSB-Cの形状でもUSBポート、Thunderbolt3&#x2F;4ポートの違いがあり、それぞれのプロトコルの違いがあるので一層理解が難しくなっているのが現状です。</p><p>Thunderbolt3は40Gbps対応とはいえ、Requirement（要求事項）は最低16GbpsのPCIeデータのサポートが求められています。Altモードでデータ、ディスプレイへの出力の合計で40Gbpsです。</p><table><thead><tr><th></th><th>Thundrerbolt4</th><th>Thunderbolt3</th></tr></thead><tbody><tr><td>総帯域幅</td><td>40Gbps</td><td>40Gbps</td></tr><tr><td>データ転送の最小帯域幅</td><td>32Gbps</td><td>16Gbps</td></tr><tr><td>ディスプレイ</td><td>4K  モニター最大 2 台、または 8K モニター 1 台</td><td>4K モニター 1 台</td></tr></tbody></table><p>2018年以降のmacbookをお使いの方はThunderbolt3対応になっていると思います。Windows(intel)のノートPCではThunderbolt3に対応した機種もあります。新しいWindowsノートPCはUSB4に対応したモデルも出てきていますね。外付けディスクだけを考えた場合、Thunderbolt3対応というのはデータ転送において最低16Gbpsを満たす事ですから、外付けディスクで16Gbpsの速度しか出なくても文句は言えません。但し、Requirementと実装とは異なることも多いので個別のホストを確認しないと分かりません。</p><p>macのポートの対応については以下を確認してください。</p><ul><li>Apple Macのポートを調べる<br> <a href="https://support.apple.com/ja-jp/HT201736">https://support.apple.com/ja-jp/HT201736</a></li></ul><p> M1 MacなどはThunderbolt&#x2F;USB4と記載があります。本当はThunderbolt4と書きたいところだったんでしょうけれども何か規格に満たないものがあり、こういった表現に留めているのだと思われます。</p><p>Z666はUSB4に対応したモデルであり、Thunderboltプロトコルとは互換性があります。<br>MacBook ProでZ666とを接続し、システム情報を参照するとThunderbolt4ではなくUSB4モードで接続されています。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">製造元名:Gopod Group Limited.</span><br><span class="line">装置名:USB4 NVMe SSD Pro Enclosure</span><br><span class="line">モード:USB4</span><br><span class="line">装置ID:0xD666</span><br><span class="line">製造元ID:0x2D01</span><br><span class="line">デバイスのリビジョン:0x5A</span><br><span class="line">ファームウェアのバージョン:1.87</span><br><span class="line">状況:装置は接続済み</span><br><span class="line">リンクの状況:0x2</span><br><span class="line">速度:最高40Gb/秒×1</span><br><span class="line">現在のリンク幅:0x2</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>一方、2019年のintel版Macbook AirはUSB4には対応していませんが、Thunderbolt3には対応しています。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">製造元名:Gopod Group Limited.</span><br><span class="line">装置名:USB4 NVMe SSD Pro Enclosure</span><br><span class="line">モード:Thunderbolt 3</span><br><span class="line">装置ID:0xD666</span><br><span class="line">製造元ID:0x1CA</span><br><span class="line">デバイスのリビジョン:0xE3</span><br><span class="line">ファームウェアのバージョン:1.87</span><br><span class="line">状況:装置は接続済み</span><br><span class="line">リンクの状況:0x2</span><br><span class="line">速度:最高40Gb/秒×1</span><br><span class="line">現在のリンク幅:0x2</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>intel版Macbook AirをDiskMarkで確認してみます。</p><img src="/new-technology/2024/01/13/ZikeDrive-Z666/MBAir.png" class="" width="480" title="alt"><p>もしかしたら遅くなるのかなと考えていましたが、Requirement（16Gbps）以上の良いパフォーマンスを発揮しました。少なくとも32Gbpsは対応してそうです。</p><h3 id="ケーブルについて"><a href="#ケーブルについて" class="headerlink" title="ケーブルについて"></a>ケーブルについて</h3><p>80cmのThunderbolt3ケーブルはUSB4で問題なく使えます。1mを超えるThunderbolt3のパッシブケーブルは20Gbpsですので、十分なパフォーマンスが出ない場合があります。距離が必要であれば少し高額ですが、2mのThunderbolt4アクティブケーブルを用意することになります。私はPlugableのThunderboltケーブルを好んで使っています（Amazonで購入できます）。iPhoneの充電には白色のAmazon Basicのケーブル（通信速度480Mbps）、データ通信用はPD充電（100W）を兼ねて黒色のThunderboltケーブルと使い分けています。</p><p>Z666を使う分には別途ケーブルを購入する必要はありませんが、微妙な接触不良などが思わぬトラブルの原因になるため、事前の確認をお勧めします。Z666に限らず、エンクロージャーを動かしたら切断警告が出たという経験をお持ちの方も多いのではないでしょうか。Z666に付属のケーブルも短すぎてエンクロージャを動かした時に端子に負担を掛けます。しなやかなで、ある程度の長さがあり、端子に負担を掛けないケーブルを利用されることをお勧めします。</p><h2 id="SSDの暗号化"><a href="#SSDの暗号化" class="headerlink" title="SSDの暗号化"></a>SSDの暗号化</h2><p>メディアの持ち出しなどのためにWindowsであれば<strong>Bitlocker To Go</strong>、macOSであれば<strong>APFS（暗号化）</strong>でのフォーマットをお勧めします。</p><p>Bitlocker To GoはWindows Homeでは使えない機能ですが、一度Proで作成してしまえば、Windows Homeでもファイルの読み込み・書き込みが可能です（将来的にはHomeでは使えなくなる可能性があります）。パフォーマンスについてはDiskMarkを見ている限りではランダムは少し速度が落ちますが、シーケンシャルはMac OS、Windowsともに暗号化しない時と殆ど変わりません。</p><p>macOS、Windowsとともに、次回からパスワードを省略できます（macOSはキーチェーンに保存）ので自宅PCでの利用においてはパスワードを意識する事なく便利です。</p><h2 id="Windowsにおける実運用"><a href="#Windowsにおける実運用" class="headerlink" title="Windowsにおける実運用"></a>Windowsにおける実運用</h2><p>Z666にBitLocker ToGoで暗号化された2TBのLexar NM790をセットして書き込みのテストを実施してみます。<br>エクスプローラーでコピーし、対象は写真・動画で、209GBのフォルダサイズです。</p><p>まずはDiskの取り外しポリシーをクイック取り外し（既定：キャッシュ無し）の通常のコピーをパフォーマンスモニターで記録しました。<br>項目はDisk Write Bytes&#x2F;secおよびCurrent Disk Queue Lengthです。Disk Queue Lengthは一般的に2を超える数値だとディスクにボトルネックがあると伝統的に言われています。ハードディスク時代のサーバー管理における一般論ですのであくまで参考値です。<br>4分25秒でコピーが完了しています。</p><h3 id="Lexar-NM790-書き込みキャッシュ無し"><a href="#Lexar-NM790-書き込みキャッシュ無し" class="headerlink" title="Lexar NM790 書き込みキャッシュ無し"></a>Lexar NM790 書き込みキャッシュ無し</h3><img src="/new-technology/2024/01/13/ZikeDrive-Z666/perfmon-nocache.png" class="" width="640" title="alt"><p>緑色のグラフはDisk Write Bytes&#x2F;secで、左の凡例の10の数が1,000Mbpsを示します。<br>赤色のグラフはDisk Queue Lengthで、左の凡例の10の数が1を示します。</p><p>計算上は約788MB&#x2F;sでファイルがコピーされていますが、実際にNVMeに書き込んだ内容は860MB&#x2F;sです。凡そ1,000MB&#x2F;sでコピーしており、最後の20秒で速度が落ちています。速度が落ちた理由はNVMeのSLCバッファが枯渇したものと思われ、200MB&#x2F;sあたりまで落ち込み、Disk Queue Lengthも2のままが継続する比率が高くなっています（青色の枠で囲った部分）。SLCバッファの枯渇はSSDの宿命とも言え、やむを得ませんが、取り外しポリシーがクイック取り外し、暗号化、数MB単位の小さいファイルもあれば、これくらいの速度が現実的です。</p><p>Disk Queue Lengthは取り外しポリシーの制約があり、Diskへの負担はあまり大きくありません。</p><h3 id="Lexar-NM790-書き込みキャッシュ有り"><a href="#Lexar-NM790-書き込みキャッシュ有り" class="headerlink" title="Lexar NM790 書き込みキャッシュ有り"></a>Lexar NM790 書き込みキャッシュ有り</h3><p>取り外しポリシーを高パフォーマンスにします。コピー時間は凡そ1分50秒で2分35秒の短縮です。計算上は約1,900MB&#x2F;sです。</p><img src="/new-technology/2024/01/13/ZikeDrive-Z666/perfmon-cache.png" class="" width="640" title="alt"><p>前回同様、後半はSLCバッファが枯渇して数値が落ち込むと考えられますが、グラフを見る限りは後半を除けば2,000MB&#x2F;s〜3,000MBの速度でNVMeに書き込んでいます。最初から4〜6あたりのDisk Queue Lengthが発生しており、十分NVMeへの負荷も確認できます。但し、断続的に高止まりしているわけではなく、0〜8の間で行ったり来たりしていますから、ファイルサイズが変化する状況で速度に変化があると考えられます。<br>グラフを眺めていると、後半30秒はDisk Write Bytes&#x2F;secの値が落ち込むと同時にDisk Queue Lengthの数値は若干高い傾向が見られます（青色の枠で囲った部分）。最後の5秒はDisk Write Bytes&#x2F;secがかなり落ち込みNVMeに対する信頼性として一瞬不安になりますが、実際の書き込み量が減るものの、Queueは発生していないのでボトルネックは発生していないと考えられます。</p><p>10gbpsのエンクロージャーを使った場合は、取り外しポリシーを高パフォーマンスの時のDisk Write Bytes&#x2F;secは凡そ950MB&#x2F;sで、クイック取り外しの時は600MB&#x2F;sでした（後半の処理速度低下部分を除く）。</p><h3 id="SK-hynix-Platinum-P41"><a href="#SK-hynix-Platinum-P41" class="headerlink" title="SK hynix Platinum P41"></a>SK hynix Platinum P41</h3><p>Platinum P41の高パフォーマンスでの結果です。コピーの結果は1分35秒でNM790よりは15秒ほど高速でした。</p><img src="/new-technology/2024/01/13/ZikeDrive-Z666/perfmon-p41.png" class="" width="640" title="alt"><p>このNVMeの特性として、初動はスロースタートです。Disk Queue Lengthがいきなり8まで上がります。これはmacOSのベンチマークで確認した際にも少し気になりました。<br>Disk Queue LengthはNM790よりはやや低い数値で安定しています。NM790はQueueが0と8の間を絶えず行ったり来たりしています。一方、P41のQueueは2と3が中心で、時々0になったり4以上となり変動が少ない状況です。これらはDRAMキャッシュの効果といえます。実際のコピー時間として見た場合はNM790と比較してそれほど顕著な差は見受けられません。単純にコピーではない、動画編集処理やゲームなど低レイテンシが求められるような用途には向いていると考えられます。</p><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>最後のWindowsでのテストはリアルな速度を示しました。SSDの容量が埋まっている場合はSLCバッファの数も足りなくなり、これよりもパフォーマンスは落ち込むものと考えられますが、今回の検証の目的からも外れるため、ここまでといたします。</p><p>結論として、外付けディスクの速度を上げるためには、デバイスコントローラー（AS2464PD）、ケーブル（Thunderbolt4／USB4）、NVMeメディア（PCIe4x4）、ホストコントローラー（PC本体）のすべての速度をバランス良く高める必要があります。</p><p>私は4TBのNM790でMacbookのバックアップ（TimeMachine）のパーティションを1TB、その他動画・写真の管理・編集および映画や音楽、モジュールのダウンロードなどを3TBとしてシンプルな用途で使っています。色々なデータでTimeMachineのバックアップが膨らんでいくのも避けたいと考えています。</p><p>ZIKEDRIVE Z666が登場したこと、高速なNVMeが登場したことで、外付けディスクは実運用でかなり快適に使えるようになりました。</p><h2 id="補足"><a href="#補足" class="headerlink" title="補足"></a>補足</h2><p>2024-02-10 更新</p><p>Z666のファームウェアアップデータの提供は取り下げになったようです。今はZIKEのホームページで表示がされていません。<br>なお、同じAS2464のチップを搭載したJEYIのエンクロージャーはeBayで購入できます。こちらの製品はファームウェアがきちんと提供されています。実際に私もeBayで購入したものをファームウェアアップデートして利用しています。Z666とJEYIのものとは私の環境においては違いは見受けられません。</p><blockquote><p>Jeyi ASM2464 USB4 Enclosure Firmware<br><a href="https://www.jeyi.com/pages/downloads?spm=..index.header_1.1">https://www.jeyi.com/pages/downloads?spm=..index.header_1.1</a></p></blockquote><p>ーーー</p><p>Z666のファームウェアは2024年1月3日に更改されたものの、アップデータとしてのConfigが誤っているようでアップデートが出来ません。<br>単にファームのファイル名が誤っているように見えて、Configを修正すれば実行できるとは思いますが、他のパラメータもたくさんあり、一旦はZIKE社に問い合わせています。また情報が得られたら記事をアップデートしたいと思います。</p>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2024/01/13/ZikeDrive-Z666/title.png&quot; class=&quot;&quot; width=&quot;1024&quot; title=&quot;alt&quot;&gt;
&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;

&lt;p&gt;USB4 40Gbpsに対応したNVMe　M.2対応のSSDエンクロージャーを紹介します。いわゆる外付けディスクです。ノートPCの外付けとして直近のNVMe M.2 SSDの状況を鑑みつつ、USB4&amp;#x2F;Thunderbolt4&amp;#x2F;Thunderbolt3などプロトコルの違い、実運用における速度を見ていきます。&lt;/p&gt;</summary>
    
    
    
    <category term="Hardware" scheme="https://yoshi0808.github.io/new-technology/categories/Hardware/"/>
    
    
    <category term="M.2 NVMe" scheme="https://yoshi0808.github.io/new-technology/tags/M-2-NVMe/"/>
    
    <category term="ZikeDrive" scheme="https://yoshi0808.github.io/new-technology/tags/ZikeDrive/"/>
    
    <category term="USB4" scheme="https://yoshi0808.github.io/new-technology/tags/USB4/"/>
    
    <category term="Thunderbolt3" scheme="https://yoshi0808.github.io/new-technology/tags/Thunderbolt3/"/>
    
    <category term="Thunderbolt4" scheme="https://yoshi0808.github.io/new-technology/tags/Thunderbolt4/"/>
    
    <category term="MinisForum UM790 Pro" scheme="https://yoshi0808.github.io/new-technology/tags/MinisForum-UM790-Pro/"/>
    
    <category term="Lexar NM790" scheme="https://yoshi0808.github.io/new-technology/tags/Lexar-NM790/"/>
    
    <category term="SK hynix Platinum P41" scheme="https://yoshi0808.github.io/new-technology/tags/SK-hynix-Platinum-P41/"/>
    
  </entry>
  
  <entry>
    <title>iPhoneに繋がるミニSSDケース</title>
    <link href="https://yoshi0808.github.io/new-technology/2023/12/16/MiniSSDCase/"/>
    <id>https://yoshi0808.github.io/new-technology/2023/12/16/MiniSSDCase/</id>
    <published>2023-12-15T17:40:54.000Z</published>
    <updated>2024-01-06T22:35:18.436Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2023/12/16/MiniSSDCase/iPhone.png" class="" title="alt"><p>iPhone15のUSB-Cに繋がるミニSSDケースを紹介します。これは、M2-2230という小型のSSDが組み込めるケースです。iPhoneは破損防止のためにケースを使っていらっしゃる方が多いとは思いますが、ケースとUSB-C接続端子とが競合し、USB-C端子が本体に挿さりきらないという問題がありますが、このケースはやや長めの端子になっており、スマホケースを使う前提に作られているようです。</p><span id="more"></span><h2 id="SDカードの速度"><a href="#SDカードの速度" class="headerlink" title="SDカードの速度"></a>SDカードの速度</h2><p>SDカードはちょっとしたデータの受け渡しに使え便利ですが速度という意味では少し取り残されてきた感があります。長期保存にも向きませんが、安価なのでOSのセットアップなどではまだまだ主流です。もっともSDカードは、ビデオカメラで動画を撮るのが主目的ですので、その速度とは常に動画の解像度と比較されることになります。</p><p>分かりやすい目安の表が SD Associationから提示されている以下の図になります。</p><img src="/new-technology/2023/12/16/MiniSSDCase/speedclass.png" class="" title="alt"><blockquote><p> Copyright © SD Association. All Rights Reserved.<br><a href="https://www.sdcard.org/ja/developers-2/sd-standard-overview/speed-class/">https://www.sdcard.org/ja/developers-2/sd-standard-overview/speed-class/</a></p></blockquote><p>フルHDの動画であれば、UHS-3を使えば一般的に問題無いというレベルです。4K動画となると、解像度に加え、フレームレートも大きく関わってきますから、少し留意が必要となってきます。</p><p>こういった一般用途に加え、機器の持つデータの移行やバックアップなどが通常の利用用途に必要な方は、少しSDカードでは物足りなくなり、データ量としてカバーできるポータブルHDDの出番になります。</p><h2 id="M2-2230のSSDケース"><a href="#M2-2230のSSDケース" class="headerlink" title="M2.2230のSSDケース"></a>M2.2230のSSDケース</h2><p>PCで一般的に用いられるM.2-2280を使えば高速化でき便利ですが、これだと少し大きさとしてポケットに入るとまでは言いづらく、嵩張ります。M.2-2230という小さなSSDであれば随分小型化できます。今回それにぴったりのSSDケースを紹介します。</p><p>中国メーカーのITGZという会社の製品です。秋葉原のラジオデパートにあるテクノハウス東映に入荷したという情報から、10月ごろに店舗に足を運んだのですが、あっさり売り切れということでした。Amazonでも販売しているようですが、結局は中国からの発送なのか時間も掛かるようでしたので、いつものeBayで落札し、1ヶ月ほど待つことにしました。</p><p>ケースは金属製で、ヒートシンク代りにもなり、放熱しやすい仕組みになっています。放熱のサーマルパッドも2枚付属しています。<br>ケース付属のドライバーでケースを分解し、SSDを取り付けます。</p><img src="/new-technology/2023/12/16/MiniSSDCase/case.png" class="" width="800" title="alt"><ul><li>SSDケース　US$15.95（eBay 送料込み）</li></ul><h2 id="M-2-SSD"><a href="#M-2-SSD" class="headerlink" title="M.2 SSD"></a>M.2 SSD</h2><p>M.2 SSD自体もeBayで落札しました。WD SN740の1TBモデルです。</p><p>上記の写真はサーマルパッドをつけてSSDを組み込んだところです。もう1枚のサーマルパッドを付けると上蓋が閉まりきらなかったので付けないことにしました。もちろん、SSD側のシールを剥がして対応する事も出来なくはありませんが、よくシールを剥がしてミスって破損させるケースもあるようなので、原則はSSDのシールはそのままにします。WesternDigital社はこのシールを剥がすと保証対象外とするようですね。私の場合はeBay購入なのでそもそも保証はありませんが。。。</p><p>M.2 2230自体があまり普及していないようですがAmazonなら数社ほどメーカーのSSDは入手できます。10月にテクノハウス東映に訪問した際は、確かトランセンド社とMicron社を筆頭に、いくつかのメーカーのSSDが廉価に販売されていたと記憶しています。</p><h2 id="Macbookでのベンチマーク"><a href="#Macbookでのベンチマーク" class="headerlink" title="Macbookでのベンチマーク"></a>Macbookでのベンチマーク</h2><p>MacBookのAmorphousDiskMarkでベンチマークを計測してみます。</p><img src="/new-technology/2023/12/16/MiniSSDCase/diskmark.png" class="" width="480" title="alt"><p>想定通り、シーケンシャルは8Gbps(980MB&#x2F;s)程度と良い数値が出ています。SDインタフェースの90MB&#x2F;sを大きく凌駕しています。10GbEのネットワークを持つNASに繋いだ時とほぼ同程度の速度です（ネットワークレイテンシが無いぶんランダムの書き込みはSSDが高速です）。</p><p>インターネット、NAS、ポータブルSSDと10Gbpsでそれぞれの速度差が無いと使い勝手が格段に良くなります。Wi-Fiも6Eで高速にはなりましたが、1.6Gbps程度でレイテンシも大きいので、大きなデータを扱う際は、PCなどをLANに繋ぎ直すという行為はまだ当面続きそうです。</p><p>なお、スマホケースに組み込まれたiPhoneに接続することを想定しているのか少しUSB-Cの端子が長めになっています。よって、MacBookなどに繋げた際は、少し本体とケースの間に隙間ができます。</p><img src="/new-technology/2023/12/16/MiniSSDCase/macbook.png" class="" width="480" title="alt"><h2 id="発熱"><a href="#発熱" class="headerlink" title="発熱"></a>発熱</h2><p>高速な通信には発熱は避けられません。MacでDiskMarkを2回実行し、ケースの温度を測ったところ51度ありました。</p><img src="/new-technology/2023/12/16/MiniSSDCase/temp.png" class="" width="480" title="alt"><p>51度は指でケースを触れてだいたい3秒程度我慢できるくらいでしょうか。</p><h2 id="iPhoneでのProRes撮影"><a href="#iPhoneでのProRes撮影" class="headerlink" title="iPhoneでのProRes撮影"></a>iPhoneでのProRes撮影</h2><p>なお、iPhone15 ProでApple ProResエンコーディングでの動画撮影をしてみました。自動的にUSBCに動画を保存するようになります。一応、撮影&#x2F;保存は出来るんですが、複数回、動画を撮影しようとするとiPhoneのカメラアプリが固まってしまいます。RTL9210チップとの相性なのか、再初期化（OSからのファイルのクローズ、再オープン）に無応答となるようですので、このケースではiOSのProRes撮影に正式に対応できていない可能性があります。30秒の4K&#x2F;30FPSの撮影で3GB強の容量が消費されます。MacBookで再生するときちんと録画はされているようです。またiOSの”ファイル”アプリケーションでUSB-Cへのファイルのコピーも問題なく可能なことを確認しています。</p><p>また、この際のケース温度は46度でした。普通の人が普通に使うとしたら、この熱量に驚くでしょうが、高速通信に慣れている方であれば許容範囲なのでしょうか。</p><h2 id="その他"><a href="#その他" class="headerlink" title="その他"></a>その他</h2><p>最近、円安も少し落ち着いてきましたね。来年春くらいにはさらに円安が落ち着くことを期待したいところです。以前に「<a href="/new-technology/2022/06/28/multi-currency-account/" title="マルチカレンシー口座 WISE">マルチカレンシー口座 WISE</a>」の記事でマルチカレンシー口座について記事を書きました。ドル決済を利用される方はeBayの為替手数料抑制のためにWISEの利用を検討されることをお勧めします。売買の都度、円から外貨に自動で交換し決済を完了させることができ、カード会社の手数料やPayPalの手数料よりは廉価です。</p>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2023/12/16/MiniSSDCase/iPhone.png&quot; class=&quot;&quot; title=&quot;alt&quot;&gt;

&lt;p&gt;iPhone15のUSB-Cに繋がるミニSSDケースを紹介します。これは、M2-2230という小型のSSDが組み込めるケースです。iPhoneは破損防止のためにケースを使っていらっしゃる方が多いとは思いますが、ケースとUSB-C接続端子とが競合し、USB-C端子が本体に挿さりきらないという問題がありますが、このケースはやや長めの端子になっており、スマホケースを使う前提に作られているようです。&lt;/p&gt;</summary>
    
    
    
    <category term="Hardware" scheme="https://yoshi0808.github.io/new-technology/categories/Hardware/"/>
    
    
    <category term="M.2 NVMe" scheme="https://yoshi0808.github.io/new-technology/tags/M-2-NVMe/"/>
    
  </entry>
  
  <entry>
    <title>Sophos Firewall v20</title>
    <link href="https://yoshi0808.github.io/new-technology/2023/11/12/xg-v20/"/>
    <id>https://yoshi0808.github.io/new-technology/2023/11/12/xg-v20/</id>
    <published>2023-11-11T19:01:00.000Z</published>
    <updated>2023-11-12T04:31:09.127Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2023/11/12/xg-v20/Title.png" class="" title="alt"><h2 id="Sophos-Firewall-v20"><a href="#Sophos-Firewall-v20" class="headerlink" title="Sophos Firewall v20"></a>Sophos Firewall v20</h2><p>Sophos Firewall v20が2023年11月06日に発表されました。個人向けとしては、IPv6 DHCP Prefix Delegationのサポートがなされています。</p><span id="more"></span><h2 id="主なエンハンスの内容"><a href="#主なエンハンスの内容" class="headerlink" title="主なエンハンスの内容"></a>主なエンハンスの内容</h2><ul><li>IPv6 DHCP Prefix Delegation</li><li>IPv6 BGPv6</li><li>Synchronized Securityの強化</li><li>VPN管理の強化</li></ul><p>v20の詳細な説明はSophos Communityを参照してください。</p><blockquote><p><a href="https://community.sophos.com/sophos-xg-firewall/b/blog/posts/sophos-firewall-v20-is-now-available">https://community.sophos.com/sophos-xg-firewall/b/blog/posts/sophos-firewall-v20-is-now-available</a></p></blockquote><p>リリースノートはこちらです</p><blockquote><p><a href="https://docs.sophos.com/releasenotes/index.html?productGroupID=nsg&amp;productID=xg&amp;versionID=20.0">https://docs.sophos.com/releasenotes/index.html?productGroupID=nsg&amp;productID=xg&amp;versionID=20.0</a></p></blockquote><h2 id="Sophos-Firewallのアップデート"><a href="#Sophos-Firewallのアップデート" class="headerlink" title="Sophos Firewallのアップデート"></a>Sophos Firewallのアップデート</h2><p>XGの管理画面にログイン後、左ペインメニューの<mark class="label primary">バックアップ＆ファームウェア</mark>の<mark class="label primary">ファームウェアの確認</mark>でアップデートの案内が順次来ます。個別にバージョンアップのファイルを入手するには、以下のURLからダウンロードします。</p><p><a href="https://support.sophos.com/support/s/article/KB-000043162?language=ja">https://support.sophos.com/support/s/article/KB-000043162?language=ja</a></p><ol><li>上記画面で<mark class="label primary">ファームウェア</mark>の<mark class="label primary">ソフトウェア</mark>のLinkをクリックします。</li><li>“SW-20.0.0_GA.SFW-222.sig”をダウンロードします。</li><li>Sophos Firewallの管理画面にログインし、左ペインメニューの<mark class="label primary">バックアップ＆ファームウェア</mark>の<mark class="label primary">ファームウェアのタブメニュー</mark>から以下の画面に赤丸で囲った矢印のアイコンをクリックし、ダウンロードしたモジュールをアップロードします。</li></ol><img src="/new-technology/2023/11/12/xg-v20/verup.png" class="" width="800" title="alt"><p>ダウンロードしたファームウェアを指定します。</p><img src="/new-technology/2023/11/12/xg-v20/update.png" class="" width="480" title="alt"><p>アップロード＆再起動ボタンをクリックし、v20へのアップグレードを完了させます。</p><h2 id="auひかりのIPv6-DHCP-Prefix-Delegation"><a href="#auひかりのIPv6-DHCP-Prefix-Delegation" class="headerlink" title="auひかりのIPv6 DHCP Prefix　Delegation"></a>auひかりのIPv6 DHCP Prefix　Delegation</h2><p>ようやくIPv6のPrefix委任が使えるようになりました。これは日本だけではなく、世界のホームユーザーからしても待ち望んでいた対応です。これでSophos FirewallのIPv6での苦肉の策である、ULAからIPv6NATという方式から解放されます。ただ個人的には、私の利用しているauひかりの場合残念ながらPrefix Delegationが使えません。いや、正確には64ビットのサブネットが1つだけ割り振られるようではあるのですが、本来、Prefix Delegationは60ビットや56ビットなどの複数のサブネットを受け取り、個々のネットワークに割り当てることになりますから、1つだけあるというのは正規のDelegationという意味合いも少し違います。</p><p>とはいえ、auひかり以外のユーザーのために中身を確認していきます。</p><p>ネットワークの設定からWANを選び、モードは<mark class="label primary">手動</mark>にして<mark class="label primary">DHCPプレフィックスの委任</mark>を選択します。</p><img src="/new-technology/2023/11/12/xg-v20/ipv6-1.png" class="" width="480" title="alt"><mark class="label primary">優先する委任プレフィックス</mark>はホームユーザーは固定IPで予め指定されたPrefixがあるわけでは無いので設定せずOFFのままで構いません。法人の場合など、固定IPv6を保有する場合、Prefixと委任されるレングスとを入力しますが、デフォルトでは空です。私の場合、4バイト目でauひかりから1を貰っていたので、16ビット分のサブネットが使えるかもしれないと試行錯誤で設定しましたが、その情報が消せずに残っています。<p>続いて、LANの設定です。</p><img src="/new-technology/2023/11/12/xg-v20/ipv6-2.png" class="" width="640" title="alt"><p>ここでは、<mark class="label primary">IPの割り当て</mark>に<mark class="label primary">委任</mark>を選びます。続いて、<mark class="label primary">アップストリームのインターフェース</mark>として、WANであるPort2を選びます。<br>auひかりでは、ISP は、IPv6 プレフィックスを委任していませんと警告メッセージが表示されてしまいますが、NTT系などでは56ビットのPrefix委任が行われ設定が可能となるはずです。この中でLANに任意の64ビットのネットワークを割り当てることになります。</p><p>余談ですが、Sophos Firewallv20のEarly Accessプログラムで私は事前検証していたのですが、Sophos Firewallでは&#x2F;48, &#x2F;52, &#x2F;56, そして &#x2F;60がサポートされ、それ以外はサポートされないというSophos側からの回答でした。</p><p>実はEarly Accessのv20ではもう少し挙動が異なり、64ビットは受け取れていました。Sophosの話ではありませんが、Ubiquiti関係のコミュニティでもauひかりからIPv6のDHCPv6-PDは<strong>出来ない事もない</strong>という情報共有もあり64ビット１つは割り当て可能という事実は認識していました。</p><img src="/new-technology/2023/11/12/xg-v20/ea.png" class="" width="480" title="alt"><p>auひかりのWANのPrefixの4バイト目は”1”であり、LANのDelegationで確認したPrefix4バイト目は”2”でした。せめてサブネット１つだけでもIPv6 Delegationが出来ればと思いましたが、残念ながら製品版では、エラーチェックが強化された上で&#x2F;64は排除されてしまいました。</p><p>いっそのこと気前よく&#x2F;48くらい割り当てて貰えないかなと思いつつ、一応auひかりのサポート窓口にDHCPv6 Delegationに対応してほしいという要望は出しておきました。</p><h2 id="アクティブな脅威対応"><a href="#アクティブな脅威対応" class="headerlink" title="アクティブな脅威対応"></a>アクティブな脅威対応</h2><p>Firewallの左ペインメニューでは<mark class="label primary">アクティブな脅威対応</mark>というメニューがあります。<br>ここでは2種類の脅威対応があります。１つは名称変更でATP (Advanced Threat Protection) という旧機能がSophos X-Ops 脅威フィードに名称が変更されています。過去、ログを見ても殆どこのATPに関するログは見ることはありませんでした。</p><p>もう1つは、MDR脅威フィードという機能です。外部の MDR アナリストがネットワークの脅威フィードを特定し、自動的にファイアウォールにプッシュし、複数のファイアウォールモジュールが、これらのフィードに基づいてトラフィックをブロックするとのことです。</p><p>この２つの機能はログでもアクティブな脅威対応という項目で確認できます。</p><div class="note info"><p>仮想環境（ESXi）上にFirewallをインストールされている方はアップグレードの前に、「<a href="/new-technology/2020/10/11/esxi-backup/" title="VMware ESXiの仮想マシンをバックアップする">VMware ESXiの仮想マシンをバックアップする</a>」を参考に、バックアップを確保される事をお勧めします。</p></div>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2023/11/12/xg-v20/Title.png&quot; class=&quot;&quot; title=&quot;alt&quot;&gt;

&lt;h2 id=&quot;Sophos-Firewall-v20&quot;&gt;&lt;a href=&quot;#Sophos-Firewall-v20&quot; class=&quot;headerlink&quot; title=&quot;Sophos Firewall v20&quot;&gt;&lt;/a&gt;Sophos Firewall v20&lt;/h2&gt;&lt;p&gt;Sophos Firewall v20が2023年11月06日に発表されました。個人向けとしては、IPv6 DHCP Prefix Delegationのサポートがなされています。&lt;/p&gt;</summary>
    
    
    
    <category term="Security" scheme="https://yoshi0808.github.io/new-technology/categories/Security/"/>
    
    
    <category term="XG Firewall" scheme="https://yoshi0808.github.io/new-technology/tags/XG-Firewall/"/>
    
  </entry>
  
  <entry>
    <title>iPhone15 ProとWiFi6E</title>
    <link href="https://yoshi0808.github.io/new-technology/2023/10/21/iPhone15pro/"/>
    <id>https://yoshi0808.github.io/new-technology/2023/10/21/iPhone15pro/</id>
    <published>2023-10-20T22:00:00.000Z</published>
    <updated>2023-10-20T22:37:34.927Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2023/10/21/iPhone15pro/Title.png" class="" width="1024" title="alt"><p class="onepoint">この記事で実現すること</p>iPhone15 Proを購入しました。代表的なものはWi-Fi6Eへの対応ですが、色々なものに繋いだ所感を書いていきます。<span id="more"></span><h2 id="Wi-Fi-6E"><a href="#Wi-Fi-6E" class="headerlink" title="Wi-Fi 6E"></a>Wi-Fi 6E</h2><p>ネットワークに興味がある方としては、iPhone15 Pro&#x2F;Pro MAXがWi-Fi 6Eに対応した事が大きいですね。160MHz幅で接続可能です。 MacbookであればTimeMachineでバックアップの時間短縮できるなど明らかなメリットがあるのですが、スマホではそのメリットが感じにくいところではあります。撮影した4K動画のNASへのアップロードが短縮できることや、画面のリフレッシュ速度も向上し端末全体が高速化しているので、Webブラウジングもより快適に感じます。</p><ul><li><p>SpeedTest</p><img src="/new-technology/2023/10/21/iPhone15pro/speedtest.png" class="" width="360" title="alt"></li><li><p>iPerf3</p><img src="/new-technology/2023/10/21/iPhone15pro/iperf3.png" class="" width="360" title="alt"></li></ul><p>まずまずの速度が出ています。私の環境ではInternet向けにはFirewallが入っていることもあり、一般的にはもう少し速度が出るかもしれません。</p><p>なお、iOSに限らず、macOSでもそうなんですが、Appleデバイス全般の注意事項としては、Wi-Fi 6E単独のチャンネルでは安定せず、2.4GHz、5GHz、6GHz全てを有効にしたSSIDを作成する必要があります。</p><blockquote><p>Apple 製デバイスで Wi-Fi 6E ネットワークを利用する<br> <a href="https://support.apple.com/ja-jp/HT213433">https://support.apple.com/ja-jp/HT213433</a></p></blockquote><p>単独のWi-Fi6EではSpeedtestでも安定せず途中でテストが終了したり不安定です。これはMacbook Pro(2023)でも同じです。<br>6E単独で接続した場合は、iOSで以下の警告が表示されます。</p><img src="/new-technology/2023/10/21/iPhone15pro/ios.png" class="" width="400" title="alt"><p>制約のように見えますが、Wi-Fi6Eの電波の見つけ方の方法によってこのような挙動になります。Apple製品のように、必ずしもWi-Fi6Eのみに接続されていない5GHzの端末ともスムーズに連携するためには必要なのでしょう。</p><h2 id="Wi-Fi-ローミング"><a href="#Wi-Fi-ローミング" class="headerlink" title="Wi-Fi ローミング"></a>Wi-Fi ローミング</h2><p>Wi-Fiローミングというのは同一SSIDで異なるアクセスポイント（AP)に自動で切り替わることです。最近の無線ルーターではメッシュ機能を持つものが増えてきました。例えば、1階から2階に移動した時に近くにあるアクセスポイントに自動的に切り替わり、より快適に使えるようになるというものです。</p><p>このローミングについて説明しだすとかなり長くなるのでここでは簡単にiPhoneに関して説明します。<br>iPhoneはWi-Fiの電波が-70dBmを下回ると、他のAPにローミングしようとします（厳密には他のAPを探すという工程も含まれます）。その際、高速にローミングが行えるかどうかというのがスマホの使い勝手では重要です。</p><p>一般的にスマホがWi-Fiに繋がる場合は、無線に接続する際の認証が行われ、DHCPによってIPアドレスを割り当てるという手順が入ります。この手順をAPが変わるたびに実施していたのでは最低でも1秒程度の切断が発生します。つまり通話中にフロアを移動していると途中でパケットの再送が入りますが、IPアドレスの再取得をやっていたのでは通話、アプリが切断されることになります。これらに対処するものが高速ローミングです。</p><p>高速ローミングは認証情報がキャッシュされることが必須です。私たちが一般的に使うようなSSID毎のパスワードであったり、企業で使われるRADIUS認証によるユーザー認証情報をキャッシュし、別のAPで速やかにIPアドレス引き継ぎと高速な再認証が必要です。</p><p>このような方法によって、高速ローミングが実現し、数十ミリ〜遅くとも100ミリ程度でAPが切り替わり、その際に通話が途絶えることはありません。パケットの再送は確実に行われますが、スマホやリモート会議などでは1秒近くのバッファリングがあるので再送による遅延にユーザーが気づくことはあまりありません。</p><p>お使いのAPによって挙動は変わりますが、以下は私が自宅で1階から2階に移動した時のPingの結果です。PingPlotterというアプリでGoogleまでのラウンドトリップを計測しています。最初に他のAPを探すところで第1段階の遅延、切り替わるところで第2段階の遅延が発生します。</p><img src="/new-technology/2023/10/21/iPhone15pro/plotter.png" class="" width="480" title="alt"><p>丸を2つ示していますが、左側が最初の遅延で250ミリ秒近くあります。これはAPを探している状態に入っています。このタイミングではAPー端末間の通信が保留になり遅延が発生します。本当にタイミングが悪ければパケットを取りこぼすこともあり再送が入ります。が、極めて小さな時間でありTCP&#x2F;IPやアプリケーションの再送機能によって大半はカバーされます。これはやや悪いケースの計測結果であり、一旦情報がキャッシュされるなどしていて、良いケースではその半分程度まで遅延が軽減されます。<br>右側の丸辺りで実際にローミングしています。これは20ミリ秒程度の遅延です。スマホのWi-Fiのアンテナ表示が変わったタイミングを目視により確認しました。</p><p>なお、APを探すところで250ミリあるのは私の環境の問題にも関わっており、iPhoneがAPから離れすぎた状況（-75dBmを下回る）のためと考えられます。電波の強さと端末との距離を考えながらAPの配置を行う必要があり、これには計測とトライアンドエラーの繰り返しが必要です。ちょうど家の端の階段の辺りが電波の弱いところで、そこにAPをさらに置いても良いのですが、100ミリ秒程度の改善でそこまで対応する気にもならずそのままにしています。</p><p>iPerf3を実行しながらフロアを移動した場合、瞬間的にはAPを探すところで数十Mbpsまでに落ち込むケースもありますが、完全に0となったりエラーになることはありません。</p><p>これ以上の話は複雑なのでまた別の機会があれば触れてみたいと思いますが、リビングでTeamsやZoomなどのリモート会議をしていて、家族が帰ってきてバタバタと2階に移動する際にも相手の発言が途切れることはありません。</p><p>iPhone15Proは、以前のiPhone11やiPhone12よりも電波を掴む力は強いように感じます。5GHzの電波ではまれに公衆回線に切り替わっていたお風呂でのブラウジングが捗ります😊</p><h2 id="有線バックホールとメッシュWi-Fi"><a href="#有線バックホールとメッシュWi-Fi" class="headerlink" title="有線バックホールとメッシュWi-Fi"></a>有線バックホールとメッシュWi-Fi</h2><p>APは一般的に有線で接続され、前述したようにローミング機能を提供しますが、個人向けのメーカーでは有線バックホールという名前が使われる場合があります。AP同士のコミュニケーションや通信を有線によって行うためです。一方、この有線バックホールを使わず、AP同士が無線で接続する形態をメッシュと呼んでいるようです。</p><p>このメッシュも独立したチャンネルを使う方法や端末と同一のチャンネルを使う方法など色々あり、各社のマニュアルを見ても、それについてはあまり明確に記載されていないものが多いようです。</p><p>なお、一般的にビジネスで用いられるローミング方式（有線バックホール）では、AP同士は異なる周波数（チャネル）にするのが基本です。<strong>異なるAP</strong>で<strong>同じ周波数</strong>を使っていると、昔の中継機と同じで<strong>それぞれのAPが出す電波同士で干渉してしまい、パフォーマンスが出ません</strong>。メッシュにすると遅くなるという感覚をお持ちの方も多いのではないでしょうか。</p><p>高速なローミングとWi-Fiの最大限のパフォーマンスを引き出すにはAP同士は異なるチャンネルを設定する必要があります。これは製品によって対応できないものもあるようですので確認をお勧めします。</p><p>有線バックホールを使わないケース、これは4LDK以上の広いフロアで物理配線が引けないなどの制約がある場合にやむなくAPをメッシュで分散配置する事については意味があります。ただそのような環境では後述するDFSを除けば、Wi-Fi6Eとなるメリットはあまり見出せないかもしれません。5GHzよりは6GHzの方が壁を通す力は落ちますから、5GHzの方がより電波は強力です。</p><h2 id="メッシュWi-FiとDFS"><a href="#メッシュWi-FiとDFS" class="headerlink" title="メッシュWi-FiとDFS"></a>メッシュWi-FiとDFS</h2><p>個人向けの5GHzでは割り当てられた電波の幅によって80MHz単位で使うことが一般的ですが、5.2GHz帯のみDFSが無く、5.3GHz、5.6GHzはDFSがあります。レーダーを受信するとAPが停波してしまうことになりますから、レーダー回避のために6GHzを使うのは有効です。</p><h2 id="私の環境"><a href="#私の環境" class="headerlink" title="私の環境"></a>私の環境</h2><p>私の環境ではUbiquitiのUniFi製品を利用しています。<br>以下はUniFiのトポロジーで自動的に構成されたネットワーク図です。上流のインターネット回線は、auひかり（10GbE）を使っています。</p><img src="/new-technology/2023/10/21/iPhone15pro/unifi.png" class="" width="800" title="alt"><p>APはU6 Enterpriseという製品で、PoEで2.5GbEのLAN接続と併せてスイッチから電源を取ります。<br>よくよく考えてみれば、クライアントが繋がっているスイッチからいきなりローミングして別のスイッチに切り替われば、スイッチは「いきなり別のスイッチポートから同じMACアドレスの端末のデータが届きネットワークループしてるのではないか」と混乱するはずです。しかし、そこはきちんと制御され、ローミングしたクライアントについて、接続されたすべてのスイッチのMACアドレステーブルを瞬時に更新しにいくようです。</p><blockquote><p>U6 Enterpriseアクセスポイント<br> <a href="https://jp.store.ui.com/collections/unifi-network-wireless/products/u6-enterprise">https://jp.store.ui.com/collections/unifi-network-wireless/products/u6-enterprise</a></p></blockquote><blockquote><p>Switch Enterprise 8 PoE スイッチ<br> <a href="https://jp.store.ui.com/collections/unifi-network-switching/products/switch-enterprise-8-poe">https://jp.store.ui.com/collections/unifi-network-switching/products/switch-enterprise-8-poe</a></p></blockquote><p>UniFi製品については、このブログでも取り上げています。</p><ul><li>「<a href="/new-technology/2022/08/27/ubiquiti-unifi/" title="Ubiquiti UniFiの世界">Ubiquiti UniFiの世界</a>」</li><li>「<a href="/new-technology/2022/11/23/unifi-switch/" title="UniFiスイッチ">UniFiスイッチ</a>」</li><li>「<a href="/new-technology/2022/12/31/unifi-ap/" title="UniFi Wi-Fiシステム">UniFi Wi-Fiシステム</a>」</li></ul><h2 id="公衆回線（5G）"><a href="#公衆回線（5G）" class="headerlink" title="公衆回線（5G）"></a>公衆回線（5G）</h2><p>公衆回線（5G)においては、iPhoneの実力というよりは公衆回線の環境が色濃く出ると思いますが、どうでしょうか。<br>海外サイトのSpeedSmartでは、5Gの速度テストにおいて、iPhone15 ProはiPhone14 Proよりも24％速いとレポートしています。</p><blockquote><p>SpeedSmart.net<br> <a href="https://speedsmart.net/blog/post/2005/iPhone-15-Pro-up-to-24-Faster-5G-Download-Speeds">https://speedsmart.net/blog/post/2005/iPhone-15-Pro-up-to-24-Faster-5G-Download-Speeds</a></p></blockquote><p>米国での5G速度は300Mbpsオーバーとの事です。<br>都内の某所（勤務先）で帰宅時に計測してみました。5G(5Gオート）と4Gとそれぞれ切り替えて計測してみます。</p><p>5G</p><img src="/new-technology/2023/10/21/iPhone15pro/5G.png" class="" width="360" title="alt"><p>4G</p><img src="/new-technology/2023/10/21/iPhone15pro/4G.png" class="" width="360" title="alt"><p>都心ではまずまずの速度です（5Gでは500Mbps超えると期待していましたが）。ビルの中に入っても100Mbps程度しか落ち込みません。</p><p>最も混雑する時間帯と言われる12時過ぎの状況は以下の通りです。</p><p>5G</p><img src="/new-technology/2023/10/21/iPhone15pro/5G1.png" class="" width="360" title="alt"><p>4G</p><img src="/new-technology/2023/10/21/iPhone15pro/4G1.png" class="" width="360" title="alt"><p>5Gは快適ですが、4Gは少し苦しいですね。やはりお昼時は4Gのユーザーがまだまだ多く速度が落ち込むようです。<br>もちろん、地下鉄では4Gですし、5G網も郊外に行くと4Gに切り替わったり途端に数十Mbps程度まで落ち込みます。また、私の計測した場所は「都内でたまたま計測した場所」ですので、ご参考に留めていただければと思います。</p><h2 id="USBハブに繋げてみる"><a href="#USBハブに繋げてみる" class="headerlink" title="USBハブに繋げてみる"></a>USBハブに繋げてみる</h2><p>iPhone15 ProはUSB-Cに対応しました。USB 3.2 Gen2に（USB3.1 Gen2と同義）対応し、10Gbpsの速度が出ます。パッケージに付属してくるUSB-CケーブルはUSB 2.0に対応（480Mbps)との事で高速通信のメリットは活かせません。</p><blockquote><p>Apple iPhone 15 の USB-C コネクタで充電および接続する<br> <a href="https://support.apple.com/ja-jp/HT213839">https://support.apple.com/ja-jp/HT213839</a></p></blockquote><p>「Belkin 7 in 1 USB-C 2.5Gbpsイーサネットハブ」に繋いでみます。</p><img src="/new-technology/2023/10/21/iPhone15pro/hub.png" class="" width="800" title="alt"><p>iPhoneの画面はUSBハブからHDMIで接続されたモニタにも映し出されますし、ネットワーク通信も可能で2.5GbEでの速度が当たり前のように出ます（ハブはUSB-PD電源に接続しています）。</p><img src="/new-technology/2023/10/21/iPhone15pro/speedtesthub.png" class="" width="360" title="alt"><p>念の為、無線を利用しないように機内モードに設定しています。</p><p>スマホの写真をNASに大量にアップロードする時などは、WiFi6Eが速いと言っても、2.5GbEの有線はレイテンシが小さいことによって高速にアップロード可能です。今回、NASにある無駄な写真や動画を一旦削除してスマホから整理済みの全ての写真・動画をSynologyのPhoto Mobileというアプリを使って再アップしたのですが、非常に高速でした。感覚的ですがWiFi6Eの2、3倍といった感じです。アプリの作りにもよりますけれども、写真または動画を1枚単位にアップロードする仕組みのアプリケーションでは、5本も6本ものスレッドで分散してアップロードはしないと思われますのでハードウェアでカバーできる一例でしょうか。こういったケースは今回のようなスマホ入れ替え時など滅多に発生しないケースですが、USB 3.2 Gen2（10GbE）となった事で非常に便利になりました。</p><blockquote><p>Belkin<br> <a href="https://www.belkin.com/jp/usb-c-7-in-1%E3%83%9E%E3%83%AB%E3%83%81%E3%83%9D%E3%83%BC%E3%83%88%E3%82%A2%E3%83%80%E3%83%97%E3%82%BF%E3%83%BC/INC009btSGY.html">https://www.belkin.com/jp/usb-c-7-in-1マルチポートアダプター/INC009btSGY.html</a></p></blockquote><h2 id="Macbookに繋げてみる"><a href="#Macbookに繋げてみる" class="headerlink" title="Macbookに繋げてみる"></a>Macbookに繋げてみる</h2><p>Macbookはテザリングの逆、iOSにネットワーク機能を提供できます。</p><img src="/new-technology/2023/10/21/iPhone15pro/mac.png" class="" width="480" title="alt"><p>実用性を考えると利用するシチュエーションはなかなか見出せませんが、Macbookが10GbEのネットワークに接続されている環境があれば、iPhone15 Proはさらに高速に通信が可能となります。</p><img src="/new-technology/2023/10/21/iPhone15pro/speedtestmac.png" class="" width="360" title="alt"><p>USB 3.2 Gen2やネットワークも10Gbpsとなればそれを基準と考え、その他周辺機器ともできるだけ速度差を無くしたいものです。例えばUSBメモリやSDカードはどうでしょうか？昔ながらにOSのセットアップなどに使ってきた経緯がありますが、技術の進歩でSDカードが大容量になったとしても速度とのバランスが悪いのではないでしょうか。今は10GbpsのUSBのSSDケース（M2.2280）が2、3千円で買えますので、廉価となったNVMeのSSDを挿して使うのはいかがでしょうか？USB3.2 Gen2であれば読み込み、書き込み共に10Gbps出ますし、NASのキャッシュ用で使っていた余りなどがあればそれを再利用するのも良いですね。</p><h2 id="Apple-CarPlay"><a href="#Apple-CarPlay" class="headerlink" title="Apple CarPlay"></a>Apple CarPlay</h2><p>Apple CarPlayは既に知られたサービスでiPhone15 Proになったからといって何かが変わるわけではありません。iOS17からはSharePlayという機能が追加され、車の中で搭乗者が（iPhoneを持っていれば）Apple Musicのセッションに参加し、搭乗者の好きな音楽を運転者のiPhoneのCar Playで再生できるようになりました。仕組みとしてはこれまであったAir Playに近いものがありますね。仲間で音楽もシェアする、時代を感じさせるサービスです。Siriの機能と組み合わせてマップの到着予定時刻を家族に共有できます。<br>iPhoneが車載のBluetoothに接続するとiOSの集中モードが自動的に運転モードに変わり通知などを制限できるようにもできます。<br>CarPlayも地道なアプリケーションの改善によってかなり使い勝手の良いシステムとなっています。</p><img src="/new-technology/2023/10/21/iPhone15pro/carplay.png" class="" width="1024" title="alt"><p>個人的にはThunderbolt3ケーブルでiPhoneとカーナビとを繋いでいるという事実が感慨深いものがあります。。。</p><h2 id="画面との距離"><a href="#画面との距離" class="headerlink" title="画面との距離"></a>画面との距離</h2><p>iPhone15 Proと直接関係ありませんが、iOS17からFaceIDに関連する機能追加として<strong>画面との距離</strong>があります。これはスマホに顔を近づけすぎると眼精疲労警告のため、画面全体が警告メッセージで覆われるというものです。これは子供の視力悪化対策に有用です。iPadでFaceIDに対応している製品は最新のiPad Proしかない（他はTouchID）ので、iOSのタブレットでこの機能を使いたければ（子供に利用させたければ）iPad Proを購入することになるのでしょうか。。。</p><img src="/new-technology/2023/10/21/iPhone15pro/screendistance.png" class="" width="360" title="alt">]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2023/10/21/iPhone15pro/Title.png&quot; class=&quot;&quot; width=&quot;1024&quot; title=&quot;alt&quot;&gt;

&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;
iPhone15 Proを購入しました。代表的なものはWi-Fi6Eへの対応ですが、色々なものに繋いだ所感を書いていきます。</summary>
    
    
    
    <category term="Hardware" scheme="https://yoshi0808.github.io/new-technology/categories/Hardware/"/>
    
    <category term="Network" scheme="https://yoshi0808.github.io/new-technology/categories/Network/"/>
    
    
  </entry>
  
  <entry>
    <title>Synology NASでESXi仮想マシンのバックアップを取得する</title>
    <link href="https://yoshi0808.github.io/new-technology/2023/09/16/Synology-abb/"/>
    <id>https://yoshi0808.github.io/new-technology/2023/09/16/Synology-abb/</id>
    <published>2023-09-15T15:44:10.000Z</published>
    <updated>2023-09-16T00:44:28.464Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2023/09/16/Synology-abb/install.png" class="" width="1024" title="alt"><p class="onepoint">この記事で実現すること</p><p>SynologyのNASでは無償版ESXiの仮想マシン（VM）バックアップが可能なActive Backup for Business(ABB)というソフトウェアが提供されています。Microsoft Hyper-V2016および2019にも対応しています。無償版ESXiのバックアップソフトは「<a href="/new-technology/2021/03/06/esxi-nakivo/" title="無償版ESXiの高度なバックアップ">無償版ESXiの高度なバックアップ</a>」で書いた有償のもの（1年期限の無償版）は存在します。無償バックアップソフトは無償版ESXiに対応していないという難しい状況でしたが、NASが必須という前提はあるものの、追加コストゼロでESXi仮想マシンのバックアップが可能です。エージェントレスで、ESXi本体やVMには何もインストールする必要はありません。</p><blockquote><p>Synology<br> <a href="https://www.synology.com/ja-jp/dsm/feature/active-backup-business/virtual-machine">https://www.synology.com/ja-jp/dsm/feature/active-backup-business/virtual-machine</a></p></blockquote><span id="more"></span><h2 id="稼働条件"><a href="#稼働条件" class="headerlink" title="稼働条件"></a>稼働条件</h2><p>ABBは基本はSynologyNASのPlusモデルで、Btrfsでフォーマットされたファイルシステムが必要です。一部のPlusモデルにはBtrfsに対応しない製品もあるので事前の確認をお勧めします。</p><p><a href="https://www.synology.com/ja-jp/dsm/packages/ActiveBackup">https://www.synology.com/ja-jp/dsm/packages/ActiveBackup</a></p><h2 id="ABBの主要な機能について"><a href="#ABBの主要な機能について" class="headerlink" title="ABBの主要な機能について"></a>ABBの主要な機能について</h2><p>ここでは、ESXi仮想マシンのバックアップに目的を絞って説明します。</p><ol><li>ESXi7.0、8.0対応</li><li>VMのバックアップを複数世代管理</li><li>ジョブスケジューリング機能<br> ワンタイム、定期、日次、週次、月次を利用できます。</li><li>重複排除<br> VMWareのChange Block Trackingに対応。</li><li>暗号化転送</li><li>バックアップデータの暗号化</li></ol><h2 id="Synology-NASの事前準備"><a href="#Synology-NASの事前準備" class="headerlink" title="Synology NASの事前準備"></a>Synology NASの事前準備</h2><h3 id="ABBのインストール"><a href="#ABBのインストール" class="headerlink" title="ABBのインストール"></a>ABBのインストール</h3><p>NASのWeb画面に管理者としてログインし、パッケージセンターから”Active Backup for Business”をインストールします。</p><img src="/new-technology/2023/09/16/Synology-abb/install.png" class="" width="1024" title="alt"><p>上記はインストール済みの状態ですが、<mark class="label primary">「インストール」ボタン</mark>をクリックしてインストールします。<br>NASのFirewallを利用している場合は自動的にPort5510を開けるようにFirewallにルールが追加されます。</p><h2 id="可用性および機密性向上のために"><a href="#可用性および機密性向上のために" class="headerlink" title="可用性および機密性向上のために"></a>可用性および機密性向上のために</h2><ul><li>フォルダの容量制限（クォータ）についてはABBでは推奨されていません。</li><li>ESXiに対してSSHでの接続が必要です。セキュリティ向上のためroot相当の専用ユーザーをESXiに新規作成されることをお勧めします。</li></ul><h2 id="ESXiの事前準備"><a href="#ESXiの事前準備" class="headerlink" title="ESXiの事前準備"></a>ESXiの事前準備</h2><p>ESXiには以下の設定が必要です。</p><ol><li>VMWare Toolsのインストールが必要です。</li><li>ABBからESXiに対しHTTPS(Port443)、SSH(Port22)を使って接続可能なようにサービスを設定します。</li><li>ABBで無償版ESXiをバックアップするためにはCBT(Changed Block Tracking)を手動で有効にする必要があります。</li><li>（任意）セキュリティ向上のため、ESXi上に管理者アカウントを作成します。</li><li>（任意）セキュリティ向上のため、Port22,443で接続可能なIPアドレスをESXi上のFirewall設定で絞ります。</li></ol><h2 id="ESXi上でHTTPS、SSHの解放"><a href="#ESXi上でHTTPS、SSHの解放" class="headerlink" title="ESXi上でHTTPS、SSHの解放"></a>ESXi上でHTTPS、SSHの解放</h2><p>無償版ESXiを使う場合はブラウザから基本はvSphere Web Clientを使いますので、HTTPS(Pprt443)の解放は特に意識する必要はありません。ESXiのファイアウォールで接続可能なIPアドレスを絞っている場合はNASのIPアドレスから接続できるようにしておきます。</p><p>SSH(Port22)についてはESXiはデフォルトでサービス停止されている状態ですので、シェルおよびSSHのサービスを起動します。<br>左ペインメニューの<mark class="label primary">ホスト</mark>ー<mark class="label primary">管理</mark>の<mark class="label primary">サービスタブ</mark>から<mark class="label primary">TSM</mark>および<mark class="label primary">TSM-SSH</mark>を起動します。<br> <img src="/new-technology/2023/09/16/Synology-abb/esxi1.png" class="" width="800" title="alt"><br>この2つのサービスは右クリックメニューの<mark class="label primary">ポリシー</mark>から<mark class="label primary">ホストと連動して起動および停止します</mark>をチェックしておく事でESXiの起動時に自動的にサービスが起動するようになります。</p><h2 id="VMのChanged-Block-Trackingの設定"><a href="#VMのChanged-Block-Trackingの設定" class="headerlink" title="VMのChanged Block Trackingの設定"></a>VMのChanged Block Trackingの設定</h2><p>ESXiの機能であるChanged Block Tracking(CBT)はVMが稼働していて前回バックアップしたものから未更新のディスクブロックをスキップして差分のみバックアップする機能です。バックアップに必要な領域を削減できます。途中で別のバックアップ製品によるバックアップ、例えばghettoVCBなどでバックアップされると、次回のバックアップはフルバックアップを行います。</p><p>この設定にあたり、事前にVMのデータを退避することをお勧めします。VMを停止のうえで、データストアブラウザからVMの入っているフォルダ毎別の場所にコピーしてください。もし、設定の変更でVMを壊してしまった場合は、当該フォルダの<code>VM名.vmx</code>を右クリックから「VMの登録」で再登録できます。</p><h3 id="設定方法"><a href="#設定方法" class="headerlink" title="設定方法"></a>設定方法</h3><p>最初にVMがインストールされているディスクを調べ、そのSCSI-IDを確認します。<br>ESXi管理画面のVMを選択し右クリックして<mark class="label primary">設定の編集</mark>をクリックします。</p><img src="/new-technology/2023/09/16/Synology-abb/esxi2.png" class="" width="640" title="alt"><mark class="label primary">ハードディスク</mark>の詳細を開き、<mark class="label primary">コントローラの場所</mark>でSCSI-IDを確認します（SCSI(0:0)など）。<ol><li>VMを停止します。</li><li>ESXi管理画面のVMを右クリックして、<mark class="label primary">設定の編集</mark>をクリックします。</li><li><mark class="label primary">VMオプション</mark>タブをクリックします。</li><li><mark class="label primary">詳細</mark>セクションを開き <mark class="label primary">設定パラメータ</mark>の<mark class="label primary">設定の編集</mark>をクリックします。<mark class="label primary">設定パラメータ</mark>ダイアログが開きます。</li><li><mark class="label primary">パラメータの追加</mark>をクリックします。</li><li><code>ctkEnabled</code>パラメータを追加して、その値を<code>true</code>に設定します。</li><li>さらに<mark class="label primary">パラメータの追加</mark>をクリックし、<code>scsi0:0.ctkEnabled</code>を追加して、その値を<code>true</code>に設定します（環境に合わせて<code>scsi0:0</code>の内容は変更してください）。</li><li>OKボタンをクリックし設定を完了させます。</li><li>VMを起動します。</li><li>SSHでESXiに入り、VMが配置されているディレクトリで、<code>VM名-ctk.vmdk</code>ファイルがあることを確認します。</li></ol><p>CBTを無効にする場合はこの逆の手順、ctkEnabledの値をfalseに設定します。<br>VMWareによるCBTの説明は以下を参照してください。</p><blockquote><p>VMware VM上の変更ブロックのトラッキング（CBT） (1020128)<br> <a href="https://kb.vmware.com/s/article/1031873?lang=ja&amp;queryTerm=changed+block+tracking">https://kb.vmware.com/s/article/1031873?lang=ja&amp;queryTerm=changed+block+tracking</a></p></blockquote><h2 id="（任意）管理者アカウントの作成"><a href="#（任意）管理者アカウントの作成" class="headerlink" title="（任意）管理者アカウントの作成"></a>（任意）管理者アカウントの作成</h2><p>セキュリティの観点からrootはできるだけ使わない事をお勧めします。これは一般論でありrootがよく知られたユーザー名だからです。以下の手順で管理者アカウントを作成します。</p><ol><li>管理メニューの左ペイン<mark class="label primary">ホスト</mark>ー<mark class="label primary">管理</mark>から<mark class="label primary">セキュリティとユーザー</mark>に進み、<mark class="label primary">ユーザー</mark>から<mark class="label primary">ユーザーの追加</mark>をクリックします。<img src="/new-technology/2023/09/16/Synology-abb/esxi5.png" class="" width="800" title="alt"></li><li>ABBから接続する専用のユーザー名とパスワードを登録してユーザーの作成を終えます。</li><li>管理メニューの左ペイン<mark class="label primary">ホスト</mark>から<mark class="label primary">アクション</mark>を選択し、プルダウンの<mark class="label primary">権限</mark>をクリックします。</li><li>さらに<mark class="label primary">ユーザーの追加</mark>を選択します。実際には上記で作成したユーザーと同一名のユーザー名を入力します。ロールについては”システム管理者”を選択します。<img src="/new-technology/2023/09/16/Synology-abb/esxi4.png" class="" width="800" title="alt"></li></ol><p>これで新しいユーザーが作成できたので、Web管理画面からログイン可能か確認してください。</p><h2 id="（任意）SSH、Web-Clientのために接続可能なIPアドレスを絞る"><a href="#（任意）SSH、Web-Clientのために接続可能なIPアドレスを絞る" class="headerlink" title="（任意）SSH、Web Clientのために接続可能なIPアドレスを絞る"></a>（任意）SSH、Web Clientのために接続可能なIPアドレスを絞る</h2><p>この機能はESXiではファイアウォールと呼ばれ、Linuxのiptablesやufwと同様にシンプルなものです。ホームユーザーはシンプルなLANで閉じられたアクセスですが、安全のために特にSSHは設定を検討すべきです。<br>Web管理画面の左ペインメニューの <mark class="label primary">ネットワーク</mark>を選択し、<mark class="label primary">ファイアウォール</mark>タブをクリックして見つける事ができます。デフォルトでは一切の制約なく接続可能になっていますので、ここでSSHとWeb Clientに接続可能なIPを登録できます。</p><img src="/new-technology/2023/09/16/Synology-abb/esxi5.png" class="" title="alt"><h2 id="ABBの利用について"><a href="#ABBの利用について" class="headerlink" title="ABBの利用について"></a>ABBの利用について</h2><p>ABBの使い方については公式のクイックガイドが提供されています。</p><blockquote><p>Active Backup for Business クィック スタート ガイド<br> <a href="https://kb.synology.com/ja-jp/DSM/tutorial/Quick_Start_Active_Backup_for_Business">https://kb.synology.com/ja-jp/DSM/tutorial/Quick_Start_Active_Backup_for_Business</a></p></blockquote><p>ABBでは管理者（Administratorsグループ）ユーザーのみが操作できます。</p><h2 id="仮想マシンのABBへの登録"><a href="#仮想マシンのABBへの登録" class="headerlink" title="仮想マシンのABBへの登録"></a>仮想マシンのABBへの登録</h2><p>DSMからABBを起動します。</p><img src="/new-technology/2023/09/16/Synology-abb/abb1.png" class="" title="alt"><p>仮想マシンを対象にします。</p><img src="/new-technology/2023/09/16/Synology-abb/abb2.png" class="" title="alt"><p>最初にバックアップ対象となるESXiを登録します。</p><img src="/new-technology/2023/09/16/Synology-abb/abb3.png" class="" width="640" title="alt"><p>バックアップ対象となるESXiのIPアドレス、アカウントを入力します。</p><img src="/new-technology/2023/09/16/Synology-abb/abb4.png" class="" width="640" title="alt"><p>ESXiに有効な証明書が設定されていないとワーニングが出ますが、ここはそのまま進みます。</p><img src="/new-technology/2023/09/16/Synology-abb/abb5.png" class="" width="640" title="alt"><p>ESXiへの接続が確認されチェックがOKであれば状態が<strong>成功</strong>となります。</p><img src="/new-technology/2023/09/16/Synology-abb/abb6.png" class="" width="640" title="alt"><p>エラーとなった場合は、ESXi側の設定、またはネットワークを確認してください。</p><h2 id="バックアップタスクの登録"><a href="#バックアップタスクの登録" class="headerlink" title="バックアップタスクの登録"></a>バックアップタスクの登録</h2><p>無事にESXiの情報がABBに取り込まれると、仮想マシンの情報が出力されます。</p><img src="/new-technology/2023/09/16/Synology-abb/abb7.png" class="" width="640" title="alt"><p>現在はバックアップが取得されておらず、タスクなしとなっています。</p><p>上記の<mark class="label primary">タスクの作成</mark>ボタンをクリックします。</p><p>仮想マシンが選択されます。</p><img src="/new-technology/2023/09/16/Synology-abb/abb8.png" class="" width="640" title="alt"><p>ここでタスク名を入力します。ここでは、ESXi8のUbuntu22のバックアップを取るのでESXi8.Ubuntu22とします。</p><p>続いてバックアップするフォルダを選択します。デフォルトでは、<mark class="label primary">ActiveBackupforBusiness</mark>になります。</p><img src="/new-technology/2023/09/16/Synology-abb/abb9.png" class="" width="640" title="alt"><p>最初のバックアップ時にフォルダの暗号化&#x2F;圧縮を設定します。私の場合すでに設定済みでありここでは変更できません。</p><img src="/new-technology/2023/09/16/Synology-abb/abb10.png" class="" width="640" title="alt"><p>バックアップオプションを選択します。Windows、Linuxのバックアップ時には<mark class="label primary">アプリケーション対応バックアップを有効化</mark>にチェックすることが推奨されます。<br>また、ESXiのCBTが有効である場合は<mark class="label primary">変更ブロック　トラッキングを有効化</mark>のチェックが有効になります。</p><img src="/new-technology/2023/09/16/Synology-abb/abb11.png" class="" width="640" title="alt"><p>改めて構成チェックが行われます。</p><img src="/new-technology/2023/09/16/Synology-abb/abb12.png" class="" width="640" title="alt"><p>続いて定期的なバックアップの設定です。</p><img src="/new-technology/2023/09/16/Synology-abb/abb13.png" class="" width="640" title="alt"><p>保持ポリシーを選定します。これはディスクの容量やバックアップ期間などに合わせて設定します。</p><img src="/new-technology/2023/09/16/Synology-abb/abb14.png" class="" width="640" title="alt"><p>復元を許可するユーザーを設定します。</p><img src="/new-technology/2023/09/16/Synology-abb/abb15.png" class="" width="640" title="alt"><p>最後のサマリで確認をし完了させます。今すぐバックアップを取得することもできます。</p><img src="/new-technology/2023/09/16/Synology-abb/abb16.png" class="" width="640" title="alt"><h2 id="仮想マシンのバックアップ実行"><a href="#仮想マシンのバックアップ実行" class="headerlink" title="仮想マシンのバックアップ実行"></a>仮想マシンのバックアップ実行</h2><p>64GBのシックプロビジョニングのUbuntu22の仮想マシンを手動でバックアップをしてみました。バックアップ速度についても計測してみます。</p><p><strong>環境</strong></p><p>ESXi8</p><table><thead><tr><th>パーツ</th><th>製品名</th></tr></thead><tbody><tr><td>CPU</td><td>AMD Ryzen5 5600G 6コア&#x2F;12スレッド 3.9-4.4GHz</td></tr><tr><td>メモリ</td><td>16GB(8GB×2) DDR4-3200</td></tr><tr><td>NVMe</td><td>WesternDigital Blue 500GB SSD &#x2F; NVMe M.2[PCIe 3.0×4]</td></tr><tr><td>NIC</td><td>Mellanox Connect X5(MCX512A-ACAT) SFP28 2Port</td></tr></tbody></table><p>Synology 1621+</p><table><thead><tr><th>パーツ</th><th>製品名</th></tr></thead><tbody><tr><td>CPU</td><td>AMD Ryzen V1500B クアッド コア 2.2 GHz</td></tr><tr><td>メモリ</td><td>8GB(4GB×2)</td></tr><tr><td>SSD</td><td>Samsung 870EVO 4TB(MZ-77E4T0B&#x2F;IT) &#x2F; SATA x 6(RAID5)</td></tr><tr><td>NIC</td><td>Mellanox Connect X4(MCX4121A-ACAT) SFP28 2Port</td></tr></tbody></table><p>SFP28(25GbE)のスイッチポートにそれぞれDACケーブルで接続しています。</p><p>ログの結果も非常に詳細で分かりやすいです。ここはさすがソフトウェアが売りのSynologyですね。</p><img src="/new-technology/2023/09/16/Synology-abb/time.png" class="" width="800" title="alt"><p>開発者が障害切り分けのために利用するログではなく、ユーザーに価値のある情報（ログ）を提供しています。これは他のメーカーとは根本的に出来が違います。</p><p>通知設定しているとメールも届きます。</p><blockquote><p>**** のバックアップタスク ESXi8.Ubuntu22 が完了しました。<br> 開始時間：2023-09-02 12:46<br> 終了時間：2023-09-02 12:47<br> 転送サイズ：24.7 GB<br> デバイス リスト：Ubuntu22</p></blockquote><p> 送信元 ****</p><p>まずは圧縮効果が出ており、64GBの仮想マシンが24.7GBとなっています。</p><p>さらに30分後、もう一度バックアップを取得してみます。今度は数秒で終了しました。通知では3.1MBとなっていました。これはESXiのCBTが有効で差分のみバックアップするためわずかの量に収まっていることになります。仮想マシンの稼働時間が長くなるとそれだけバックアップ量も増えることになります。</p><p>ちなみに、同一の環境でghettoVCBスクリプトでバックアップを取得した場合は以下の通り35秒でした。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">2023-09-03 01:27:50 -- info: ============================== ghettoVCB LOG START ==============================</span><br><span class="line">2023-09-03 01:27:52 -- info: Creating Snapshot <span class="string">&quot;ghettoVCB-snapshot-2023-09-03&quot;</span> <span class="keyword">for</span> Ubuntu22</span><br><span class="line">Destination disk format: VMFS thin-provisioned</span><br><span class="line">Cloning disk <span class="string">&#x27;/vmfs/volumes/datastore1/Ubuntu22/Ubuntu22.vmdk&#x27;</span>...</span><br><span class="line">2023-09-03 01:28:23 -- info: Removing snapshot from Ubuntu22 ...</span><br><span class="line">2023-09-03 01:28:23 -- info: Backup Duration: 31 Seconds</span><br><span class="line">2023-09-03 01:28:23 -- info: Successfully completed backup <span class="keyword">for</span> Ubuntu22!</span><br><span class="line"></span><br><span class="line">2023-09-03 01:28:25 -- info: <span class="comment">###### Final status: All VMs backed up OK! ######</span></span><br><span class="line"></span><br><span class="line">2023-09-03 01:28:25 -- info: ============================== ghettoVCB LOG END ================================</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="ABBの実行内容について"><a href="#ABBの実行内容について" class="headerlink" title="ABBの実行内容について"></a>ABBの実行内容について</h2><p>ABBの実行している内容は、ghettoVCBとほぼ変わりません。ESXiのAPIでESXiのスナップショットを取得しつつ、無償版ESXiではバックアップ関係のAPIが使えないためSSHで各種操作をして仮想マシンの情報を吸い上げています。<br>普段私はESXiにSSHで接続する際にはrootで公開鍵認証をしています（YubiKeyに秘密鍵を入れています）。ABBでは公開鍵認証は使えないようですので、今回示したように、別アカウントでパスワードを設定しています。ESXiのパスワードは他の用途を含めてABB以外では使うことがなく操作ミスなどによるパスワード漏洩の心配も不要です。</p><h2 id="復元"><a href="#復元" class="headerlink" title="復元"></a>復元</h2><p>ABBでバックアップを取得した日時（スナップショット）毎にESXiに復元します。</p><p>ABBの左ペインのメニューから仮想マシンを選択し、さらに実際に復元する仮想マシンを選択します。</p><img src="/new-technology/2023/09/16/Synology-abb/abb17.png" class="" width="1024" title="alt"><p>仮想マシンを選択した状態では背景が薄いグレーになりますので、ここで<mark class="label primary">復元</mark>ボタンをクリックします。</p><p>続いて、復元ポイント（バックアップを取得した日付と時刻）を選択し、<mark class="label primary">VMWare VSphereへの復元</mark>を選択し、次に進みます。<br>注釈で「ゲストOSファイル（Windows&#x2F;Linux）の復元の場合、Active Backup for Business Portalに進んでください」とありますが、これはファイル単位で復元したい場合です。ここではスナップショット単位に戻す事を目的としていますのでこの説明は省略します。</p><p>続いて復元の仕方を選択します。</p><img src="/new-technology/2023/09/16/Synology-abb/abb18.png" class="" width="640" title="alt"><mark class="label primary">仮想マシンの完全復元</mark>と<mark class="label primary">即時復元</mark>との2種類があります。ここでは完全復元の例について記載します。<p>なお、即時復元はNAS上で重複排除されてバックアップされたそのままの情報がESXiから見えるようになります。そこで仮想マシンを登録するなどすれば、すぐに仮想マシンを起動しその内容にアクセス可能となります。ただし、仮想マシンの実態はNAS上にあるのでパフォーマンスは落ちます。</p><p>復元モードを選択します。</p><img src="/new-technology/2023/09/16/Synology-abb/abb19.png" class="" width="640" title="alt"><mark class="label primary">元の場所に復元</mark>と<mark class="label primary">新しい場所に復元、或いは異なる設定で復元</mark>との2種類があります。<p>一般的にはMACアドレスはESXi上で動的に生成されますが、元の場所、つまりこれまでの仮想マシン同様のIPアドレス、構成で戻すのであればIPアドレスの引き継ぎなども鑑み、元のMACアドレスで戻すことになります。新しい場所、つまり新しい仮想マシンとして複製するのであれば、後者を選択します。</p><p>なお、MACアドレスが静的な場合のオプションもありますがここでは割愛します。</p><p>この例では元の場所に戻します（仮想マシンの稼働中に復元します）。</p><p>最後に構成の最終確認をして実行します。</p><img src="/new-technology/2023/09/16/Synology-abb/abb20.png" class="" width="640" title="alt"><p>対象のデータストア、ネットワーク（VLAN）を念のため確認してください。</p><mark class="label primary">復元後、自動的にVMの電源をオンにします</mark>のチェックは手前が省けるのでオンで良いでしょう。構成を変更したい場合は外すなど状況に合わせて選択します。<p>ちなみに、私の構成では、<code>vmfs/volumes/datastore1</code>にUbuntu22というフォルダが作成され、その中に仮想マシンの関連ファイルが登録されています（新規に仮想マシンを作成した一般的な構成です）。</p><p>ESXiの稼働中の画面は以下の通りです。</p><img src="/new-technology/2023/09/16/Synology-abb/esxi6.png" class="" width="1024" title="alt"><p>さて、実行中のアラートが表示されますがOKで続行します。</p><img src="/new-technology/2023/09/16/Synology-abb/abb21.png" class="" width="360" title="alt"><p>実行結果です。</p><img src="/new-technology/2023/09/16/Synology-abb/time2.png" class="" width="800" title="alt"><p>普通にUbuntuにESXi管理コンソール経由で接続でき、SSHも問題ありません。仮想MACアドレスは同一のもので復元されておりIPアドレスも前回と同じものでした。<br>復元動作は完璧です。</p><p>さて、復元では留意する点として、仮想マシンのESXi上の管理IDが変わる事が挙げられます。</p><p>復元後のフォルダ構成を確認しましたが、特にフォルダパスも変更はなく、復元前とは変更されたようには見受けられません。復元のログではテンポラリのフォルダを作成しているように見えますが、最終的には<code>vmfs/volumes/datastore1</code>にUbuntu22というフォルダにて復元されています。</p><p>ESXiの管理IDは特に意識しない場合も多いのですが、ブラウザからESXiの管理コンソールを起動せずにいきなり仮想マシンを起動する場合は、<code>vmrc://ユーザーID@ホスト名/?moid=管理ID</code>　ですぐに仮想マシン（GUI）にアクセスできますが、このIDが変更されているので、ESXi管理コンソールで新しいIDを確認する必要があります。</p><p>なお、これによってABBでバックアップしていた構成も変わることになるので、これまでタスク化されているバックアップは失敗することになりますので改めて仮想マシンの登録情報を編集しておく必要があります。</p><blockquote><p>警告,2023-09-03 12:42:22,前回のバージョンからのディスク [[datastore1] Ubuntu22&#x2F;Ubuntu22.vmdk] が見つかりません。それは削除されたか、あるいはパススルー、RDM、あるいは独立したディスクへ変更された可能性があります。バックアップ タスクはディスクをバックアップしません。</p></blockquote><p>このエラーは構成情報の変更を検知したという事でしょう。私はこの対策として、旧環境でのバックアップの定期的な実行を取りやめる設定に変更し、新しいバックアップタスクを改めて作成するようにしています。それでしばらく時間が経過してから古いバックアップファイルを削除することにしています。</p><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>非常に簡単なGUI操作で後は殆ど気にすることなく定期的な仮想マシンのバックアップが行えます。速度も必要十分で特に指摘する点は見つかりません。仮想マシンの一部のファイルを取り出したいなどのニーズにも応えられますし、本格的なバックアップソフトウェアです。小規模なビジネスやホームユーザーには十分すぎる機能を持ち合わせていると言えるでしょう。</p><p>仮想環境としてESXiを選定するメリットとして、第一に使いやすさと安定性、セキュリティレベルが高いということが挙げられますが、こういったスタンダードなNASがESXiのバックアップをサポートしている事も大きなメリットではないでしょうか。</p>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2023/09/16/Synology-abb/install.png&quot; class=&quot;&quot; width=&quot;1024&quot; title=&quot;alt&quot;&gt;

&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;

&lt;p&gt;SynologyのNASでは無償版ESXiの仮想マシン（VM）バックアップが可能なActive Backup for Business(ABB)というソフトウェアが提供されています。Microsoft Hyper-V2016および2019にも対応しています。無償版ESXiのバックアップソフトは「&lt;a href=&quot;/new-technology/2021/03/06/esxi-nakivo/&quot; title=&quot;無償版ESXiの高度なバックアップ&quot;&gt;無償版ESXiの高度なバックアップ&lt;/a&gt;」で書いた有償のもの（1年期限の無償版）は存在します。無償バックアップソフトは無償版ESXiに対応していないという難しい状況でしたが、NASが必須という前提はあるものの、追加コストゼロでESXi仮想マシンのバックアップが可能です。エージェントレスで、ESXi本体やVMには何もインストールする必要はありません。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Synology&lt;br&gt; &lt;a href=&quot;https://www.synology.com/ja-jp/dsm/feature/active-backup-business/virtual-machine&quot;&gt;https://www.synology.com/ja-jp/dsm/feature/active-backup-business/virtual-machine&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="Network" scheme="https://yoshi0808.github.io/new-technology/categories/Network/"/>
    
    <category term="Software" scheme="https://yoshi0808.github.io/new-technology/categories/Software/"/>
    
    
    <category term="ESXi" scheme="https://yoshi0808.github.io/new-technology/tags/ESXi/"/>
    
    <category term="10GbE" scheme="https://yoshi0808.github.io/new-technology/tags/10GbE/"/>
    
    <category term="25GbE" scheme="https://yoshi0808.github.io/new-technology/tags/25GbE/"/>
    
    <category term="Synology" scheme="https://yoshi0808.github.io/new-technology/tags/Synology/"/>
    
  </entry>
  
  <entry>
    <title>Sophos Firewall v19.5 MR-3</title>
    <link href="https://yoshi0808.github.io/new-technology/2023/08/20/xg-v195mr3/"/>
    <id>https://yoshi0808.github.io/new-technology/2023/08/20/xg-v195mr3/</id>
    <published>2023-08-19T15:00:00.000Z</published>
    <updated>2023-08-20T00:20:19.429Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2023/08/20/xg-v195mr3/title.png" class="" title="alt"><h2 id="Sophos-Firewall-v19-5-MR3"><a href="#Sophos-Firewall-v19-5-MR3" class="headerlink" title="Sophos Firewall v19.5 MR3"></a>Sophos Firewall v19.5 MR3</h2><p>Sophos Firewall v19.5 MR3が2023年8月2日に発表されました。</p><span id="more"></span><h2 id="主なエンハンスの内容"><a href="#主なエンハンスの内容" class="headerlink" title="主なエンハンスの内容"></a>主なエンハンスの内容</h2><p>MR3では65以上のパフォーマンスおよび安定化・セキュリティ向上に対応しています。また、今後、リモートアクセス製品であるZTNAのセキュアアクセスに対応させる予定とのこと。<br>私の所感としては、これまでのSophos FirewallのVPNではそれなりに便利に活用していますが、ZTNAで透過的にリモートアプリケーションが利用できるようになるとの事であれば期待が持てます。但し、ZTNAの導入にはSophos Centralが必要であること（無料）、ZTNAの価格についてホームユーザーの扱いがどうなるかはまだ判明しないように見えます。<br>システム構成としてはActive Directoryとの統合連携など法人向けには必須の要件が含まれているので、ホームユーザーからは少し遠い存在になってしまうかもしれません。</p><p>v19.5 MR3の詳細な説明はRelease Notesを参照してください。</p><blockquote><p><a href="https://docs.sophos.com/releasenotes/index.html?productGroupID=nsg&amp;productID=xg&amp;versionID=19.5">https://docs.sophos.com/releasenotes/index.html?productGroupID=nsg&amp;productID=xg&amp;versionID=19.5</a></p></blockquote><p>Ipsec-VPNでSSL&#x2F;TLSインスペクションが動作しないという不具合の改善も含まれています。</p><h2 id="Sophos-Firewallのアップデート"><a href="#Sophos-Firewallのアップデート" class="headerlink" title="Sophos Firewallのアップデート"></a>Sophos Firewallのアップデート</h2><p>XGの管理画面にログイン後、左ペインメニューの<mark class="label primary">バックアップ＆ファームウェア</mark>の<mark class="label primary">ファームウェアの確認</mark>に通知が来る場合があります(以下はMR-2の画面です)。</p><img src="/new-technology/2023/08/20/xg-v195mr3/notice.png" class="" width="480" title="alt"><p>また、アップデートの案内が来ていなくても、MySophosにログインし、バージョンアップの差分モジュールをダウンロードします。</p><ol><li>Sophosのサイトの上部の「ソフォスについて」のプルダウンメニューから、<mark class="label primary">ライセンスとアカウント</mark>をクリックします。<blockquote><p><a href="https://www.sophos.com/ja-jp.aspx">https://www.sophos.com/ja-jp.aspx</a></p></blockquote></li><li>Sophos IDをお持ちでなければIDを作成します。</li><li>ログイン後、<mark class="label primary">Network Protection</mark>をクリックします。</li><li><mark class="label primary">Firmware Updates</mark>をクリックします。</li><li>「製品名&#x2F;OSを使った検索」で”Firewall”を選択し、その後現れるプルダウンは”Software”を選択します。</li><li><mark class="label primary">Show Available Downloads</mark>ボタンをクリックします。</li></ol><img src="/new-technology/2023/08/20/xg-v195mr3/mysophos.png" class="" width="800" title="alt"><ol><li>上記画面で”SW-19.5.3_MR-3.SFW-652.sig”というアップデータが表示されますのでダウンロードします。</li><li>MY Sophosはここで終了してXGの管理画面にログインし、左ペインメニューの<mark class="label primary">バックアップ＆ファームウェア</mark>の<mark class="label primary">ファームウェアのタブメニュー</mark>から以下の画面に赤丸で囲った矢印のアイコンをクリックし、ダウンロードしたモジュールをアップロードします。</li></ol><img src="/new-technology/2023/08/20/xg-v195mr3/verup.png" class="" width="800" title="alt"><p>アップロード＆再起動ボタンをクリックし、v19.5 MR3へのアップグレードを完了させます。</p><img src="/new-technology/2023/08/20/xg-v195mr3/upgrade.png" class="" width="800" title="alt"><div class="note info"><p>仮想環境（ESXi）上にFirewallをインストールされている方はアップグレードの前に、「<a href="/new-technology/2020/10/11/esxi-backup/" title="VMware ESXiの仮想マシンをバックアップする">VMware ESXiの仮想マシンをバックアップする</a>」を参考に、バックアップを確保される事をお勧めします。</p></div>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2023/08/20/xg-v195mr3/title.png&quot; class=&quot;&quot; title=&quot;alt&quot;&gt;

&lt;h2 id=&quot;Sophos-Firewall-v19-5-MR3&quot;&gt;&lt;a href=&quot;#Sophos-Firewall-v19-5-MR3&quot; class=&quot;headerlink&quot; title=&quot;Sophos Firewall v19.5 MR3&quot;&gt;&lt;/a&gt;Sophos Firewall v19.5 MR3&lt;/h2&gt;&lt;p&gt;Sophos Firewall v19.5 MR3が2023年8月2日に発表されました。&lt;/p&gt;</summary>
    
    
    
    <category term="Security" scheme="https://yoshi0808.github.io/new-technology/categories/Security/"/>
    
    
    <category term="XG Firewall" scheme="https://yoshi0808.github.io/new-technology/tags/XG-Firewall/"/>
    
  </entry>
  
  <entry>
    <title>Synology DS1621+（DSM7.2）とSSD</title>
    <link href="https://yoshi0808.github.io/new-technology/2023/07/27/Synology1621plus-ssd/"/>
    <id>https://yoshi0808.github.io/new-technology/2023/07/27/Synology1621plus-ssd/</id>
    <published>2023-07-27T02:00:00.000Z</published>
    <updated>2023-07-27T11:37:57.655Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2023/07/27/Synology1621plus-ssd/synology-title.png" class="" width="1024" title="alt"><p class="onepoint">この記事で実現すること</p><p>サイバー攻撃の話題が相変わらず賑やかな状況下、これまで使っていたNASのソフトウェアの安定性やセキュリティ面の不安があり、安定感のあるSynologyのNASにリプレースしました。昨今SSDが安くなってきた事もあり、節電兼ねてALL SSDのNASをセットアップしてみました。</p><span id="more"></span><h2 id="前提（私の使い方）"><a href="#前提（私の使い方）" class="headerlink" title="前提（私の使い方）"></a>前提（私の使い方）</h2><p>私のNASの用途は、写真や動画のバックアップ、複数のPCで使う文書・PDFなどの同期兼バックアップ、仮想マシンやモジュールのバックアップ用途です。このブログなどはプライベートなものではないので、自宅で保存するよりGitHubのパブリッククラウドに置いておくほうがより現実的ではありますが、操作ミスで消えるリスクも鑑みNASにバックアップを取得しています。</p><p>今のところ、TVや映画などの動画を保存する用途にはしていないので、容量だけでいえば1ベイか2ベイのNASで10TBあれば十分です。特殊要素があるとすれば、仮想マシンのバックアップを頻繁に取得するので、できるだけバックアップ速度を求めます。そういう意味では10GbEのネットワークは必須です。</p><p>NASでは仮想マシンを稼働させる事もできますが、私の用途としてはESXiを一般的なPCにセットアップし、複数の仮想マシンを稼働させているので、NASはストレージがメインです。Windowsファイル共有（SMB）、NFS、iSCSI、せいぜいsyslog、SQLデータベースあたりまで使うといったところです。Ubuntuは個人向けにウィルス対策ソフトが存在しないので、Ubuntuのブラウザでインターネットにアクセスする事は殆どなく、モジュールのダウンロードは（ウィルス対策ソフトが有効な）macOSかWindowsでダウンロードしたものをSMBで共有してUbuntuで利用することが殆どです。</p><p>NASの使い方は利用者によって様々でしょうから、あくまで一例ということでご覧ください。</p><h2 id="Synology機種選定"><a href="#Synology機種選定" class="headerlink" title="Synology機種選定"></a>Synology機種選定</h2><p>6ベイ〜8ベイ程度のNASでそろそろ新モデルが出るかなと思い、年初くらいからウォッチしていましたが、発表されたのはDS1823xs+で、30万円と高額でした。周辺機器の互換性としてEnterpriseクラスの製品が中心で、個人向けとしては少し不向きだなと感じました。メモリは厳格に互換性を重視しつつも、SSDは必ずしも互換性のドライブでなくても良いかと考えていましたが、Enterpriseクラスの厳格性で10万円超えクラスの製品レベルを求められるとコスト面でかなり厳しいと感じました。現行モデルとの比較は以下の通りです。最初からSFP+のネットワークカードを増設する前提で、それなりにCPUパワーのある機種の比較です。10GbE以上の場合、どこまでスループットが出るかという期待も含めての選定です。</p><table><thead><tr><th>機種</th><th>CPU</th><th>CPU TDP</th><th>製造プロセス</th><th>ベイ</th><th>実売価格</th></tr></thead><tbody><tr><td>DS1823xs+</td><td>AMD Ryzen V1780B クアッド コア 3.35 GHz</td><td>45W</td><td>14nm</td><td>8</td><td>30万円</td></tr><tr><td>DS1821+</td><td>AMD Ryzen V1500B クアッド コア 2.2 GHz</td><td>16W</td><td>14nm</td><td>8</td><td>16万円</td></tr><tr><td>DS1621+</td><td>AMD Ryzen V1500B クアッド コア 2.2 GHz</td><td>16W</td><td>14nm</td><td>6</td><td>12.5万円</td></tr></tbody></table><p>意外にも、最新機種のDS1823xs+の製造プロセスは14nmで現行モデルと変わりません。DS1621+&#x2F;DS1821+の現行モデルは発売後2年半が経過しています。それなりに長期間使うことになるNASはEOSLを気にする必要があります。ただし、2012年モデルでもセキュリティパッチはきちんと提供されているので、Synologyのソフトウェア保守に対する考え方は非常にしっかりとしています。2018年に発表されたDS1618+（CPU:intel Atom C3538）は発売後5年でDiscontinuedになっていますが、あくまで製造中止であって、サポートはフルに提供されています。さらに、DS1621+&#x2F;DS1821+は新発表されたDS1823xs+とCPU世代が同じなので、長期的なサポート継続が行われると考えられます。</p><p>ちなみに、V1500BやV1780Bは2つの10GbEチップを内蔵しているんですね。ただし、DS1621+&#x2F;DS1821+には10GbEの口はありません。DS1823xs+は1つの10GbE(RJ45)があるのでその10GbEを活用しているということでしょうか。</p><p>ということで、Synologyはソフトウェアが秀逸である反面、少し高いというイメージを持っていたのですが、実売価格として廉価なDS1621+を購入することにしました。メモリが4GBなので、純正ECCメモリ（1.5万円）4GBを追加し8GBとしました。</p><p>Synologyの保守に関する注意点としては、購入後の保証期間が過ぎたハードウェアの有償修理は行われないという点です。特殊なハードウェアだと電源やファンなど代替品というのも簡単には見つからないのでそこだけが留意する点でしょうか。故障が気になる方は延長保証を検討する必要があります。私は故障した場合は「さだめ」と割り切って新しいハードウェアを買う理由が見つかるので延長保証にはしていません笑</p><blockquote><p>Synology 製品サポート状況<br> <a href="https://www.synology.com/ja-jp/products/status">https://www.synology.com/ja-jp/products/status</a></p></blockquote><h2 id="SSD"><a href="#SSD" class="headerlink" title="SSD"></a>SSD</h2><img src="/new-technology/2023/07/27/Synology1621plus-ssd/870evo.png" class="" width="320" title="alt"><p>Synologyとしては公式には互換性確認が取れていないSamsungの870EVO 4TB(MZ-77E4T0B&#x2F;IT)が28,000円程度だったこともあり、6つ購入しました（最初に1台購入し、動作確認の上で追加を5台買いました）。仕様は以下の通りTLCで速度、耐久性を重要視しました。</p><ul><li>インターフェース (転送速度・規格値）：SATA 3.0(6Gbps) ※SATA 2.0(3Gbps)およびSATA 1.0(1.5Gbps)互換フォームファクタ：7mm厚2.5インチHDD互換［搭載デバイス］NANDフラッシュ：Samsung 3bit MLC (TLC) V-NANDコントローラ：Samsung MKXコントローラキャッシュメモリ：2GB LPDDR4［パフォーマンス］シーケンシャル：読み出し560 MB&#x2F;s、書き込み：530 MB&#x2F;s</li><li>5年間または最大2,400TBWの限定保証</li></ul><p>4TBのSSDといえば、つい昨年は8万円くらいしていたと記憶していますが、廉価になるスピードも早いですね。世の中では半導体が不足していると言われる一方で、個人向けPCの販売不振によって、SSDなどのパーツが余剰在庫で値崩れしていると聞きますので、SSD全般に関しては今はお得な時期と言えるでしょう。</p><p>DS1621+にはM.2-2280のNVMeキャッシュも搭載可能ですが、SSD RAID5の分散であればキャッシュを必要としない程度に十分な速度が出るものと見込んでいます。キャッシュだけだと見かけのベンチマークは良い数字が出るでしょうが、安定して読み込み・書き込み速度を出すにはSSDでシンプルな構成が一番と考えます。</p><p>なお、このストレージのセットアップ時には互換性の無いDiskである警告メッセージが表示されます。また、Synologyアカウントのページには以下の記載があります。</p><blockquote><p>以下の状況ではテクニカル サポート サービスは提供されません。<br> Synology互換性リストに記載されていないデバイス（ドライブ、メモリモジュール、PCIeカードなど）を使用する。</p></blockquote><p>一度セットアップした後は警告メッセージは表示されていません。</p><p>NASというグループではなく、ConsumerというクラスでSynologyの互換性について検索すると、850EVO、860EVOが一覧に表示されます。何れ870EVOがサポート対象になるのを願うことにします。</p><blockquote><p>Synology 製品互換リスト（機種指定なし）<br> <a href="https://www.synology.com/ja-jp/compatibility?search_by=category&amp;category=hdds_no_ssd_trim&amp;filter_brand=Samsung&amp;filter_class=Consumer&amp;display_brand=other">https://www.synology.com/ja-jp/compatibility?search_by=category&amp;category=hdds_no_ssd_trim&amp;filter_brand=Samsung&amp;filter_class=Consumer&amp;display_brand=other</a></p></blockquote><p>なお、Synologyの互換性試験を軽んじているわけではありませんし、なるべくは互換性のあるものを使おうと考えてはいます。ただし、DS1621+に関してSSDはサードパーティ製で認められたものはなく、SynologyのEnterpriseドライブのみで4TBだと価格が15万円&#x2F;個なので、これは個人で購入するのは困難でしょう。<br>メモリやSSDキャッシュ用途であれば流石に互換性を重視した製品選定をしますが。。。</p><h2 id="NIC"><a href="#NIC" class="headerlink" title="NIC"></a>NIC</h2><img src="/new-technology/2023/07/27/Synology1621plus-ssd/mellanox.png" class="" width="640" title="alt"><p>このブログでは定番のMellanox Connect X4(MCX4121A-ACAT)を選定しました。ebayで1枚$70〜$80（日本円で約1万円）程度です。Synologyで正式に互換性検証されたものは、intel X710-T4がありますが、Connect X4は互換性リストにはありません。1つ昔のモデルのDS1618+はConnect X3には対応しているようです。Connect X4がダメなら純正のSFP28カードを購入するつもりでした。</p><p>前出の互換性リストを見ると、Mellanox Connect X4に対応しているSynology NASもそれなりの数があるようです。</p><blockquote><p>Synology 製品互換リスト<br> <a href="https://www.synology.com/ja-jp/compatibility?search_by=category&amp;category=network_interface_cards&amp;display_brand=other">https://www.synology.com/ja-jp/compatibility?search_by=category&amp;category=network_interface_cards&amp;display_brand=other</a></p></blockquote><h2 id="ハードウェアインストール"><a href="#ハードウェアインストール" class="headerlink" title="ハードウェアインストール"></a>ハードウェアインストール</h2><h3 id="メモリ"><a href="#メモリ" class="headerlink" title="メモリ"></a>メモリ</h3><p>筐体の底の部分に蓋があり、それを外すとメモリモジュールを挿すところがあります。シール付きの別売りモジュール（4GByte）を装着したところです。</p><img src="/new-technology/2023/07/27/Synology1621plus-ssd/memory.png" class="" width="640" title="alt"><h2 id="DiskStationManager（DSM）セットアップ"><a href="#DiskStationManager（DSM）セットアップ" class="headerlink" title="DiskStationManager（DSM）セットアップ"></a>DiskStationManager（DSM）セットアップ</h2><p>DS1621+は今更珍しいハードウェアでも無いですし、DSMのセットアップ情報も世の中に多くあるので、手順については省略します。最初はLAN1にRJ45のCat6ケーブルを接続しセットアップしました。インターネットに接続されている環境で無事DSM7.2のセットアップが完了しました。</p><p>論理Disk（ストレージプール）は初心者向けのSynology Hybrid RAID、または通常のRAIDを選択できますが、速度を重視し、RAID5としました。ダウンタイムを気にしてRAID6にするほど安全第一という事もなく、かといって、RAID0にして故障の際に大掛かりなリカバリのリスクを抱えたくも無いということで無難な選択です。6台のSSDすべてを1つの論理DISKとしてパリティの分散によって障害リスクの抑制、高速化を目指すことにします。</p><p>以前のNASでは、こういった論理ボリュームを作成後、利用するアプリケーションや目的毎のデータサイズによってストレージプールの中にそれぞれのボリュームを作成していました。例えば、macOSのバックアップであるTimeMachineなどでは、決められたディスクサイズの中で最新世代のバックアップを確保する仕組みとなっており、ディスクの容量を事前に決めておかないと（クオータ）、肥大し続ける事になります。PCで言えばパーティションのようなものですね。<br>また、別の目的では仮想マシンのバックアップなどは世代管理も含めて、どれだけのDisk容量を確保すべきかある程度運用しないとわかりません。意外と圧縮が効いて無駄にボリュームの空きができてしまう事はよくある課題です。また、複数ボリュームを作成するとスループットは落ちます。</p><p>NASはこの辺りの事前の計画がとても難しいのですが、DSM7では単一ボリュームに共有フォルダを作成する時にフォルダのサイズ制限を設定できます。これができればわざわざ複数ボリュームを悩みながら作成する事も不要です。これが実現できるのはSynologyがアピールするBtrfs（バターエフエス）ファイルシステムのおかげです。Btrfsではスナップショットを取得してバックアップする際、バックアップ中にファイルが更新されて一貫性が失われないとのことです。ファイルシステムもデータベースの仕組みに近くなっていくんでしょうか。</p><blockquote><p>Synology ナレッジセンター</p></blockquote><p> <a href="https://kb.synology.com/ja-jp/DSM/help/DSM/AdminCenter/file_share_create?version=7#sharedfolderquota">https://kb.synology.com/ja-jp/DSM/help/DSM/AdminCenter/file_share_create?version=7#sharedfolderquota</a><br> <div class="note info"><p>ストレージがBtrfsファイル システムを使用している場合に限り、共有スペースに共有スペースの割り当てを有効にするオプションをできますます。</p></div></p><p>ESXiの仮想マシンのバックアップのために、 SynologyのActive Backup for Businessを使うつもりですので、これは64ビットOSとBtrfsが必須となります。Disk構成は以下のようになりました。</p><img src="/new-technology/2023/07/27/Synology1621plus-ssd/volume.drawio.png" class="" width="480" title="alt"><img src="/new-technology/2023/07/27/Synology1621plus-ssd/synology1.png" class="" width="800" title="alt"><h2 id="消費電力"><a href="#消費電力" class="headerlink" title="消費電力"></a>消費電力</h2><p>SSD6台、Mellanox Connect X4を装着した状態で、ワットチェッカーで計測してみました。以下の通り、おおよそ33W-35W程度で安定しています。なかなかの省電力です。以前に利用していたNASは4台のHDDという事もあり、70W-100W程度でかなり発熱も大きかったのがかなり改善されました。</p><ul><li><p>Synology（SSDx6、Mellanox Connect X4）<br> （33W-35W）</p> <img src="/new-technology/2023/07/27/Synology1621plus-ssd/wchecker1.png" class="" width="360" title="alt"></li><li><p>旧NAS（HDDx4、Mellanox Connect X3）<br> （70W-100W）</p> <img src="/new-technology/2023/07/27/Synology1621plus-ssd/wchecker2.png" class="" width="360" title="alt"></li></ul><h2 id="ネットワーク"><a href="#ネットワーク" class="headerlink" title="ネットワーク"></a>ネットワーク</h2><p>セットアップ終了後、無事Connect X4はNASに以下のように認識されていました。</p><blockquote><p><code>25000 Mbps, 全二重, MTU 1500</code></p></blockquote><p>2つのPortがあるので、1つは25GbE、もう1つは10GbEとして使ってみます。</p><p>お決まりのiperf3の計測です。Connect X4をSFP28でスイッチに接続します。クライアントはWindows11でこちらもConnect X4です。<br>Synologyのコミュニティから提供されているSynoCli Monitor Toolsというパッケージがあり、これをインストールして使ってみます。<br>この組み合わせでは上り、下り共に19〜21Gbps程度であり、及第点という感じでした。</p><p>Windows -&gt; Synology（多重度2）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[ ID] Interval           Transfer     Bitrate</span><br><span class="line">[SUM]   0.00-10.00  sec  22.3 GBytes  19.1 Gbits/sec                  sender</span><br><span class="line">[SUM]   0.00-10.00  sec  22.3 GBytes  19.1 Gbits/sec                  receiver</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>Synology NASとESXi上のUbuntuのiPerf3の結果は上り、下り共に十分なパフォーマンスが出ています。</p><p>Synology -&gt; Ubuntu</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[ ID] Interval           Transfer     Bitrate</span><br><span class="line">[  5]   0.00-1.00   sec  2.33 GBytes  20.0 Gbits/sec</span><br><span class="line">[  5]   1.00-2.00   sec  2.59 GBytes  22.3 Gbits/sec</span><br><span class="line">[  5]   2.00-3.00   sec  2.72 GBytes  23.4 Gbits/sec</span><br><span class="line">[  5]   3.00-4.00   sec  2.59 GBytes  22.2 Gbits/sec</span><br><span class="line">[  5]   4.00-5.00   sec  2.71 GBytes  23.3 Gbits/sec</span><br><span class="line">[  5]   5.00-6.00   sec  2.72 GBytes  23.4 Gbits/sec</span><br><span class="line">[  5]   6.00-7.00   sec  2.73 GBytes  23.4 Gbits/sec</span><br><span class="line">[  5]   7.00-8.00   sec  2.70 GBytes  23.2 Gbits/sec</span><br><span class="line">[  5]   8.00-9.00   sec  2.70 GBytes  23.2 Gbits/sec</span><br><span class="line">[  5]   9.00-10.00  sec  2.69 GBytes  23.1 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[ ID] Interval           Transfer     Bitrate         Retr</span><br><span class="line">[  5]   0.00-10.00  sec  26.5 GBytes  22.7 Gbits/sec   22             sender</span><br><span class="line">[  5]   0.00-10.00  sec  26.5 GBytes  22.7 Gbits/sec                  receiver</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="Disk速度"><a href="#Disk速度" class="headerlink" title="Disk速度"></a>Disk速度</h2><p>定番のCrystal Diskmarkのベンチマークを実施します。</p><h3 id="25GbE-SFP28-で計測"><a href="#25GbE-SFP28-で計測" class="headerlink" title="25GbE(SFP28)で計測"></a>25GbE(SFP28)で計測</h3><img src="/new-technology/2023/07/27/Synology1621plus-ssd/DiskMark25gbE.png" class="" width="480" title="alt"><p>読み込みは17Gbps、書き込みは14.3Gbpsと、かなり高いスループットが出ています。11Gbps-12Gbps程度であれば省電力を優先し10Gbpsで使おうと考えていましたが、迷いどころです。私が速度を重視するメインの使い道はESXiの仮想マシンのバックアップですので、それはまた別の機会に計測してみます。</p><h3 id="10GbE-SFP-で計測"><a href="#10GbE-SFP-で計測" class="headerlink" title="10GbE(SFP+)で計測"></a>10GbE(SFP+)で計測</h3> <img src="/new-technology/2023/07/27/Synology1621plus-ssd/DiskMark10gbE.png" class="" width="480" title="alt"><p> 10GbEの場合は、読み込み、書き込みともにワイヤレートが出ており、バランスの良い組み合わせでしょうか。NICをSFP+の10GbEにして、もう5W程度省電力を狙うというのも良いですね。</p><h3 id="25GbE-SFP28-にパケット署名を付けて計測"><a href="#25GbE-SFP28-にパケット署名を付けて計測" class="headerlink" title="25GbE(SFP28)にパケット署名を付けて計測"></a>25GbE(SFP28)にパケット署名を付けて計測</h3> <img src="/new-technology/2023/07/27/Synology1621plus-ssd/DiskMark25GbE-PacketSign.png" class="" width="480" title="alt"><p>ビジネスではセキュリティの観点からほぼ必須と指摘されるSMBのパケット署名ですが、意外と落ち込まないですね。これも実運用するには十分な速度が出ています。</p><h2 id="その他、素晴らしい機能"><a href="#その他、素晴らしい機能" class="headerlink" title="その他、素晴らしい機能"></a>その他、素晴らしい機能</h2><p>以前のNASからリプレースして便利に感じた機能をいくつか挙げてみます。</p><ul><li>2要素認証（TouchID、Windows Hello）<br> DSMに2要素認証でログインする場合は、圧倒的に便利です。パスワードレスでTouchID、Windows Helloのみの認証にもできます。<br> なお、YubiKeyのFIDO2も使えますが、PINもあって少し不便に感じます。YubiKeyはDSMへのSSHを公開鍵認証で使っています。iOSアプリのSecure SignInは自宅にいない場合に公衆回線を通じて2要素認証のためのサインインの通知が来るのは良いのですが、許可をタップするとNASへ直接接続しようとするようで、自宅のWi-Fiに接続していない場合は認証がうまく動作しません。これはいずれ機能アップして修正されることを期待します。SynologyのNASはTailScaleのアプリがインストールできるので、これを組み合わせる事で対応できるかもしれません。</li></ul><blockquote><p>tailscale<br>  <a href="https://tailscale.com/">https://tailscale.com</a></p></blockquote><ul><li>ログセンター（Syslog）<br> グラフィカルで分かりやすいです。ネットワーク機器のログを集めるのに使っています。このおかげでSyslogのために別の仮想マシンを用意する必要は無さそうです。以前のNASではフィルタ機能が十分でなく、使っていませんでした。Synologyでは演算子を使っていろいろな条件で絞り込みができます。個人でのログ確認には必要十分です。<img src="/new-technology/2023/07/27/Synology1621plus-ssd/syslog.png" class="" width="800" title="alt"></li></ul><p> 絞り込みも優秀で、ホスト名を入力させるのではなく、すでにログ出力されているホスト名から選択できます。<br>  <img src="/new-technology/2023/07/27/Synology1621plus-ssd/syslog2.png" class="" width="800" title="alt"></p><ul><li><p>ストレージアナライザー</p> <img src="/new-technology/2023/07/27/Synology1621plus-ssd/analyzer.png" class="" width="1024" title="alt">  <p> ファイルサイズの大きいもの順に確認できたり、重複ファイルを確認、削除できます。データの見える化ができて、とても便利です。</p></li><li><p>ファイアウォール<br> これはアプリケーションの自動ブロックと連動していて、このブロックが働いた時、つまり明らかな不正ログインの懸念がある場合のみ通知されます。ですので、普段から通知されることはありません。以前のNASでは許可していないサービスにIPレベルでパケットが到達した段階でエラーとカウントして膨大な件数の拒否カウントが定期的に通知されており、結局通知を止めていたのですが、こちらは現実的なファイアウォール機能となっています。</p><blockquote><p>さまざまなサービスとパッケージが自動ブロックをサポートします。例：DSM、SSH、Telnet、rsync、ネットワーク バックアップ、共有フォルダの同期、FTP、SMB、WebDAV、File Station、Audio Station、Video Station、Download Station、Mail Server、Mail Station、MailPlus、MailPlus Server、VPN Server、Synology Drive Server、および Synology モバイル アプリ。</p></blockquote></li><li><p>Synology Drive<br>　NASでは一般的な機能で、複数クライアント端末とファイル同期を取るソリューションです。以前のNASでは小さいモジュールがたくさん存在するフォルダ、特にGitで使うようなソースコードや小さいモジュールのファイルは、<em>conflict</em>(0)のような競合ファイルがたくさん発生してしまい、全く使えずにいました。GitHubへのプッシュする際に大量の誤ったプッシュ候補のファイルが表示されてしまい、泣く泣く変更したファイルをロールバックする羽目になりました。他の端末との同時更新などの競合がある訳ではなかったのですが、それ以来、一般的な文書のみに使っていました。今回、SynologyのNASになってからはまだ日が浅いですが、このような小さいモジュール群も安定して複製してくれ、複数端末で同期が取れています。</p></li><li><p>DSM画面のレスポンスが良いこと<br>　どのアプリケーションを稼働させても、ウィンドウがもたつくことはありません。</p></li></ul><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>SSDが安くなったおかげで、今回は廉価にNASのリプレースが出来ました。SSDキャッシュはベンチマークこそ良い成績が出ますが、実際の運用においてはなかなか効果を感じづらいところがあります。NVMeではなくSATAなので大きな期待はしていませんでしたが、かなりの速度が出ることを確認できました。私の利用方法は少し特殊と考えられますが、Synologyのソフトウェアが素晴らしいことで、NASを利用している時のストレスが本当に減りました。<br>前述したSyslogや重複ファイルのチェックなど、本当にユーザーフレンドリーで使いやすく他社のNASから乗り換えた時にはこのDSM7.2を使うと、その使い勝手の良さに驚かれるでしょう。またストレージの消費量もかなり低く抑えられています。最近、SynologyはエントリーモデルにおいてもBtrfsに対応するようになったので廉価でも高性能なNASとして利用できそうです。今はNASのバックアップを外付けのHDDにしていますが、あまりに使い勝手が良いので廉価なビジネスモデルにリモートコピーでバックアップを取得するのでも良いかなと思い始めています。</p>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2023/07/27/Synology1621plus-ssd/synology-title.png&quot; class=&quot;&quot; width=&quot;1024&quot; title=&quot;alt&quot;&gt;

&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;

&lt;p&gt;サイバー攻撃の話題が相変わらず賑やかな状況下、これまで使っていたNASのソフトウェアの安定性やセキュリティ面の不安があり、安定感のあるSynologyのNASにリプレースしました。昨今SSDが安くなってきた事もあり、節電兼ねてALL SSDのNASをセットアップしてみました。&lt;/p&gt;</summary>
    
    
    
    <category term="Hardware" scheme="https://yoshi0808.github.io/new-technology/categories/Hardware/"/>
    
    <category term="Network" scheme="https://yoshi0808.github.io/new-technology/categories/Network/"/>
    
    
    <category term="10GbE" scheme="https://yoshi0808.github.io/new-technology/tags/10GbE/"/>
    
    <category term="25GbE" scheme="https://yoshi0808.github.io/new-technology/tags/25GbE/"/>
    
    <category term="Synology" scheme="https://yoshi0808.github.io/new-technology/tags/Synology/"/>
    
  </entry>
  
  <entry>
    <title>ESXi8.0をRyzen5 5600Gで構築</title>
    <link href="https://yoshi0808.github.io/new-technology/2023/07/07/building-setup-esxi8/"/>
    <id>https://yoshi0808.github.io/new-technology/2023/07/07/building-setup-esxi8/</id>
    <published>2023-07-07T00:58:48.000Z</published>
    <updated>2024-01-30T05:33:58.738Z</updated>
    
    <content type="html"><![CDATA[<p class="onepoint">この記事で実現すること</p><p>1年半前に、「<a href="/new-technology/2022/02/27/building-setup-esxi7/" title="ESXI7.0をRyzen7 5700Gで構築">ESXI7.0をRyzen7 5700Gで構築</a>」の記事で、Ryzen7 5700GでESXi7のセットアップをしました。今回はESXi8.0の動作確認も含めてRyzen5 5600Gでセットアップしました。</p><span id="more"></span><h2 id="ご注意事項"><a href="#ご注意事項" class="headerlink" title="ご注意事項"></a>ご注意事項</h2><p>2024&#x2F;1&#x2F;22に発表されたVMWareブログによりますと、スタンドアロン製品の提供を終了し、サブスクリプションモデルに変更されることとなりました。この無償版ESXiは今後提供停止となりますが、サポートは継続されるとの事です。<br>無償版ESXiの利用にあたっては、まずこちらの記事「<a href="/new-technology/2024/01/30/EOS-Free-esxi/" title="VMWare 無償版ESXiの提供終了について">VMWare 無償版ESXiの提供終了について</a>」を参照されることをお勧めします。</p><h2 id="ESXi8のためのハードウェア選定検討"><a href="#ESXi8のためのハードウェア選定検討" class="headerlink" title="ESXi8のためのハードウェア選定検討"></a>ESXi8のためのハードウェア選定検討</h2><p>実は最初からESXi8をセットアップするつもりはなく、WindowsPCを新調するつもりでした。私はゲームはやらないので、せいぜい4Kのビデオが見られれば十分というPCの使い方をしており、ビデオカードを購入する事は殆どありません。パソコン工房で「STYLE-S0P5-R55G-EZX」という5600Gを積んだ機種が8万円台と安かった事もあり、あまり深くは考えずに注文しました。</p><blockquote><p>パソコン工房<br> <a href="https://www.pc-koubou.jp/">https://www.pc-koubou.jp</a></p></blockquote><h2 id="ハードウェア構成"><a href="#ハードウェア構成" class="headerlink" title="ハードウェア構成"></a>ハードウェア構成</h2><p>注文したPCは以下の構成でした。<br>【OS】Windows 11 Home<br>　【プロセッサー】AMD Ryzen 5 5600Gプロセッサー (3.9-4.4GHz&#x2F;6コア&#x2F;12スレッド&#x2F;16MBキャッシュ&#x2F;TDP 65W)<br>　【CPU冷却グリス】【熱伝導率： 9W&#x2F;m K】 シルバーグリスArctic Silver 5塗布サービス<br>　【CPUクーラー】静音CPUクーラー Wraith Stealth[トップフロー]<br>　【グラフィックアクセラレーター】Radeon Graphics(CPU統合グラフィックス）<br>　【メインメモリ】16GB(8GB×2)[DDR4-3200 &#x2F; デュアルチャンネル］<br>　【1stストレージ［OSインストール］】500GB SSD &#x2F; NVMe M.2[PCIe 3.0×4]<br>　【チップセット】AMD B550チップセット<br>　【サウンド機能】High Definition Audio subsystem<br>　【内蔵ネットワークカード】有線：1000BASE-T ※無線機能はついておりません<br>　【光学ドライブ】DVDスーパーマルチドライブ［LG GH24NSxx]<br>　【電源】400W[80PLUS BRONZE認証］&#x2F; TFX電源<br>　【ケース】スリムタイプMicroATXケースHEC 7KJC[フロントUSB3.0]ブラック</p><p>さて、PCが届いてから、ハードウェアを確認したところ、NVMeはウェスタンデジタルのBlueが組み込まれていました。また、マザーボードはASRock社のものです。そういえば、前回のESXi7.0のセットアップでは、セキュアブートは断念していました。Win11 Homeがセットアップされているモデルでしたが、WDのBlue（SN570）が入っていた事もあり、ふつふつとESXi8.0をインストールしたいと思い始め、ESXi8をクリーンインストールする事にしました。</p><h3 id="ストレージ"><a href="#ストレージ" class="headerlink" title="ストレージ"></a>ストレージ</h3><p>前回は、VMware Commmunityで鉄板だった970EVO Plusでした。ESXiではSamsungが確実という印象でしたが、980 Pro NVMeでは、ファームウェアの不具合で故障率が高いという報告が上がっています。ESXiはNVMeストレージの種類を選ぶため事前調査が必要ですが、今回、何となくうまく行くだろう感があってBlue（SN570）にESXi8をセットアップしました。結果、全く問題ありませんでした。なぜかESXiの事例としてあまり出てこないのが不思議です。。。</p><p>うまく行かなければ、William Lam氏のNVMeに関する情報で、SabrentのRocket Plus NVMeを試そうと思っていたところでした。<br><a href="https://williamlam.com/2023/02/quick-tip-additional-nvme-vendors-sk-hynix-sabrent-for-esxi-homelab.html">https://williamlam.com/2023/02/quick-tip-additional-nvme-vendors-sk-hynix-sabrent-for-esxi-homelab.html</a></p><h3 id="ネットワークカード"><a href="#ネットワークカード" class="headerlink" title="ネットワークカード"></a>ネットワークカード</h3><p>前回は、intelのX710のSFP+4Portを使いましたが、今回はSFP28の検証も兼ねてMellanox Connect X-5を選定しました。Connect X-4はWindowsやNASで使おうと計画してます。前回はセキュアブートがうまく行かなかった点は課題でしたが、実はそれが功を奏したところもありました。X710のESXiのドライバーはデフォルトではフローコントロール（pauseパラメータ）がオフになっています。それで、ブート時に、<code>/etc/rc.local.d/local.sh</code>にpauseパラメータを有効にする設定を加えていました。もし、セキュアブートであれば、<code>/etc/rc.local.d/local.sh</code>にスクリプトを記述しても無視されます。</p><h3 id="UEFIの設定"><a href="#UEFIの設定" class="headerlink" title="UEFIの設定"></a>UEFIの設定</h3><p>さて、UEFIのリベンジです。色々な情報をこれまで収集し、セキュアブートの初期化をすればセキュアブートが可能と調べがついていました。</p><p>最初、Secure Boot Modeを<mark class="label primary">Custom</mark>に変更し、<mark class="label primary">Install default Secure Boot keys</mark>を実施した上でセットアップしましたが、セキュアブートでインストールされませんでした。以下のページでGIGABYTEのマザーということでセキュアブートに関する情報がありました。</p><p><a href="https://support.pcdiy.newx.co.jp/hc/ja/articles/6572156997657--GIGABYTE%E3%83%9E%E3%82%B6%E3%83%BC%E3%83%9C%E3%83%BC%E3%83%89%E5%85%A8%E8%88%AC-Secure-Boot-%E3%81%AE%E8%A8%AD%E5%AE%9A%E6%96%B9%E6%B3%95%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">https://support.pcdiy.newx.co.jp/hc/ja/articles/6572156997657--GIGABYTEマザーボード全般-Secure-Boot-の設定方法について</a></p><blockquote><p><strong>Restore Factory Keys</strong> を選択していただき、ポップアップが表示されますのでYes(はい)を選択してください</p></blockquote><p>今回のマザーボードはASRockですが、以下の手順でセキュアブートにできました。</p><ol><li><mark class="label primary">Secure Boot Mode</mark>を<mark class="label primary">Normal</mark>から<mark class="label primary">Custom</mark>に変更する。</li><li><mark class="label primary">Clear Secure Boot Keys</mark>を実行する</li><li><mark class="label primary">Install default Secure Boot keys</mark>を実行する。</li><li><mark class="label primary">Secure Boot Mode</mark>を<mark class="label primary">Normal</mark>に戻す。</li></ol><p>この手順を踏んでセットアップ開始したところ、無事セキュアブートが可能になりました。無償版ESXiはTPMは使えませんので、単に改ざん防止という事になります。<br>簡単な確認方法として、セキュアブートが有効である場合、ESXiの管理コンソールの<mark class="label primary">セキュリティとユーザー</mark>の許容レベルをパートナーからコミュニティに変更できなくなります。また、前述した<code>local.sh</code>もスキップされます。</p><h2 id="インストール"><a href="#インストール" class="headerlink" title="インストール"></a>インストール</h2><p>これまで同様、Rufusで32GBのUSBメモリにISOファイルを登録しUSBブートからESXi8.0Update1aをセットアップします。<br>なお、セットアップされる場合はVMWareのサイトで最新のバージョンを確認下さい。</p><p>VMWare ESXi8.0<br><a href="https://customerconnect.vmware.com/jp/evalcenter?p=free-esxi8">https://customerconnect.vmware.com/jp/evalcenter?p=free-esxi8</a></p><img src="/new-technology/2023/07/07/building-setup-esxi8/esxi1.png" class="" width="800" title="alt"><p>メーカーはiiyamaなのに、なんでMouseComputerなんだろう。。。</p><h2 id="ネットワーク"><a href="#ネットワーク" class="headerlink" title="ネットワーク"></a>ネットワーク</h2><p>ドライバーはnmlx5_coreとなっています。SFP28のDACケーブルをスイッチに接続し、vmnic0が25Gbpsでリンクアップしています。</p><img src="/new-technology/2023/07/07/building-setup-esxi8/esxi2.png" class="" width="800" title="alt"><p>ESXi8にセットアップしたUbuntu22ではOS上は10GbEと認識していますが、速度は23Gbps近くは出ています。</p><img src="/new-technology/2023/07/07/building-setup-esxi8/ubuntu1.png" class="" width="640" title="alt"><p>Ubuntuからの送信</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">yoshi@ub22:~$ iperf3 -c 192.168.x.20</span><br><span class="line">Connecting to host 192.168.x.20, port 5201</span><br><span class="line">[  5] <span class="built_in">local</span> 192.168.x.182 port 47676 connected to 192.168.x.20 port 5201</span><br><span class="line">[ ID] Interval           Transfer     Bitrate         Retr  Cwnd</span><br><span class="line">[  5]   0.00-1.00   sec  2.61 GBytes  22.4 Gbits/sec  6519    967 KBytes</span><br><span class="line">[  5]   1.00-2.00   sec  2.54 GBytes  21.9 Gbits/sec  5013   1.01 MBytes</span><br><span class="line">[  5]   2.00-3.00   sec  2.50 GBytes  21.4 Gbits/sec  3376    667 KBytes</span><br><span class="line">[  5]   3.00-4.00   sec  2.57 GBytes  22.1 Gbits/sec  5961    612 KBytes</span><br><span class="line">[  5]   4.00-5.00   sec  2.53 GBytes  21.8 Gbits/sec  4767    648 KBytes</span><br><span class="line">[  5]   5.00-6.00   sec  2.57 GBytes  22.1 Gbits/sec  6294    765 KBytes</span><br><span class="line">[  5]   6.00-7.00   sec  2.55 GBytes  21.9 Gbits/sec  4271    489 KBytes</span><br><span class="line">[  5]   7.00-8.00   sec  2.56 GBytes  22.0 Gbits/sec  3493    573 KBytes</span><br><span class="line">[  5]   8.00-9.00   sec  2.55 GBytes  21.9 Gbits/sec  5756    789 KBytes</span><br><span class="line">[  5]   9.00-10.00  sec  2.58 GBytes  22.2 Gbits/sec  4816    546 KBytes</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[ ID] Interval           Transfer     Bitrate         Retr</span><br><span class="line">[  5]   0.00-10.00  sec  25.6 GBytes  22.0 Gbits/sec  50266             sender</span><br><span class="line">[  5]   0.00-10.00  sec  25.6 GBytes  22.0 Gbits/sec                  receiver</span><br><span class="line"></span><br><span class="line">iperf Done.</span><br></pre></td></tr></table></figure><p>Ubuntuの受信</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">yoshi@ub22:~$ iperf3 -c 192.168.x.20 -R</span><br><span class="line">Connecting to host 192.168.x.20, port 5201</span><br><span class="line">Reverse mode, remote host 192.168.x.20 is sending</span><br><span class="line">[  5] <span class="built_in">local</span> 192.168.x.182 port 44930 connected to 192.168.x.20 port 5201</span><br><span class="line">[ ID] Interval           Transfer     Bitrate</span><br><span class="line">[  5]   0.00-1.00   sec  2.68 GBytes  23.0 Gbits/sec</span><br><span class="line">[  5]   1.00-2.00   sec  2.73 GBytes  23.4 Gbits/sec</span><br><span class="line">[  5]   2.00-3.00   sec  2.72 GBytes  23.4 Gbits/sec</span><br><span class="line">[  5]   3.00-4.00   sec  2.73 GBytes  23.4 Gbits/sec</span><br><span class="line">[  5]   4.00-5.00   sec  2.73 GBytes  23.4 Gbits/sec</span><br><span class="line">[  5]   5.00-6.00   sec  2.73 GBytes  23.4 Gbits/sec</span><br><span class="line">[  5]   6.00-7.00   sec  2.73 GBytes  23.4 Gbits/sec</span><br><span class="line">[  5]   7.00-8.00   sec  2.73 GBytes  23.4 Gbits/sec</span><br><span class="line">[  5]   8.00-9.00   sec  2.73 GBytes  23.4 Gbits/sec</span><br><span class="line">[  5]   9.00-10.00  sec  2.73 GBytes  23.4 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[ ID] Interval           Transfer     Bitrate         Retr</span><br><span class="line">[  5]   0.00-10.00  sec  27.2 GBytes  23.4 Gbits/sec  279             sender</span><br><span class="line">[  5]   0.00-10.00  sec  27.2 GBytes  23.4 Gbits/sec                  receiver</span><br><span class="line"></span><br><span class="line">iperf Done</span><br></pre></td></tr></table></figure><p>受信は25Gbpsのワイヤレートが出ています。<br>Ubuntuからの送信側では再送が多いようです。これはまだESXiの構成または設定の問題なのか私の環境の問題なのかは分かっていません。<br>NVidiaのサイトのInboxドライバの情報はESXi8.0向けは4.23.0.36-8vmwという事になっています。</p><blockquote><p>NVIDIA Native Drivers for VMware ESXi Inbox Drivers Release Notes<br> <a href="https://docs.nvidia.com/networking/display/VMwareESXiInboxDriversReleaseNotes">https://docs.nvidia.com/networking/display/VMwareESXiInboxDriversReleaseNotes</a></p></blockquote><p>なお、最新のESXi8.0Update1aでのMellanoxのドライバのバージョンは以下の通りです。NVidiaのサイトのものよりも新しいですね。これはまた次回にドライバが更新されるかもしれません。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost:~] esxcli software vib list | grep nmlx</span><br><span class="line">nmlx5-core                     4.23.0.36-14vmw.801.0.0.21495797     VMW     VMwareCertified   2023-04-29    host</span><br><span class="line">nmlx5-rdma                     4.23.0.36-14vmw.801.0.0.21495797     VMW     VMwareCertified   2023-04-29    host</span><br></pre></td></tr></table></figure><p>色々な情報を探してみてもやはりESXi7.0の情報は充実しており、まだESXi8.0は安定というには早いかなと感じます。</p><h2 id="ESXiにおけるNICのフローコントロールについて"><a href="#ESXiにおけるNICのフローコントロールについて" class="headerlink" title="ESXiにおけるNICのフローコントロールについて"></a>ESXiにおけるNICのフローコントロールについて</h2><p>ESXiにはフローコントロールの制御について、送信、受信のpauseパラメータを設定できます。<br>Connect X-5を使っている状況でESXiにSSHし、以下のコマンドでpauseパラメータの状況が確認できます。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost:~] esxcli network nic pauseParams list</span><br><span class="line">NIC     Pause Params Supported  Pause RX  Pause TX  Auto Negotiation  Auto Negotiation Resolution Avail  RX Auto Negotiation Resolution  TX Auto Negotiation Resolution</span><br><span class="line">------  ----------------------  --------  --------  ----------------  ---------------------------------  ------------------------------  ------------------------------</span><br><span class="line">vmnic0                    <span class="literal">true</span>      <span class="literal">true</span>      <span class="literal">true</span>             <span class="literal">false</span>                              <span class="literal">false</span>                           <span class="literal">false</span>                           <span class="literal">false</span></span><br><span class="line">vmnic1                    <span class="literal">true</span>      <span class="literal">true</span>      <span class="literal">true</span>             <span class="literal">false</span>                              <span class="literal">false</span>                           <span class="literal">false</span>                           <span class="literal">false</span></span><br></pre></td></tr></table></figure><p><code>Pause Params Supported</code>が<code>true</code>の場合は、フローコントロールの機能を持っています。Pause RXがfalseだとスイッチからpauseフレームの通知を無視してしまいます。またPause TXがfalseだと自身が飽和した時にpauseフレームを送信しません。上記ではデフォルトでフローコントロールがオンになっています。</p><p>一方、ESXi7.0のintel x710では、以下の結果になりました。Pause RX&#x2F;TXがfalseとなっています。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@esxi2:~] esxcli network nic pauseParams list</span><br><span class="line">NIC     Pause Params Supported  Pause RX  Pause TX  Auto Negotiation  Auto Negotiation Resolution Avail  RX Auto Negotiation Resolution  TX Auto Negotiation Resolution</span><br><span class="line">------  ----------------------  --------  --------  ----------------  ---------------------------------  ------------------------------  ------------------------------</span><br><span class="line">vmnic0                    true     false     false             false                              false                           false                           false</span><br><span class="line">vmnic1                    true     false     false             false                              false                           false                           false</span><br><span class="line">vmnic2                    true     false     false             false                              false                           false                           false</span><br><span class="line">vmnic3                    true     false     false             false                              false                           false                           false</span><br></pre></td></tr></table></figure><p>この場合は、前述した、<code>/etc/rc.local.d/local.sh</code>にフローコントロールをOnにするコマンドを列挙します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">esxcli network nic pauseParams set -n vmnic0 -t t -r t</span><br><span class="line">esxcli network nic pauseParams set -n vmnic1 -t t -r t</span><br><span class="line">esxcli network nic pauseParams set -n vmnic2 -t t -r t</span><br><span class="line">esxcli network nic pauseParams set -n vmnic3 -t t -r t</span><br></pre></td></tr></table></figure><p>繰り返しですが、これはセキュアブートではない場合にのみ設定が可能です。<br>10GbEとWi-Fiなど、<strong>速度差がある端末同士で効率の良い通信を行うためにはフローコントロールは必要</strong>と言えます。フローコントロールが無い場合、私の環境ではWi-Fi6のiperf3の例では900Mbps→750Mbps程度には劣化します。Wi-Fi電波の範囲ギリギリとかWi-Fiの別のAPへのローミングなどセンシティブな箇所で安定度が高まるとお考えください。</p><p>フローコントロールはこのようにホスト側での設定とネットワークスイッチ側と双方で有効にしておく必要があります。</p><p>なお、ESXiにおいて少し高度な話としては、Single Root I&#x2F;O Virtualization（SR-IOV）による仮想マシンにNIC（NICが持つ仮想機能）を直接割り当てる方法で高速化する方法もあります。Windows ServerやRed Hat Enterprise LinuxなどOSを選びますが今後機会があればテストしてみます。</p><img src="/new-technology/2023/07/07/building-setup-esxi8/esxi3.png" class="" width="800" title="alt"><p>※ESXi上のUbuntuはSR-IOVに対応していません。</p><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>25GbEはあくまで実験的に検証しているものであり、私自身がパワーユーザーではない事もあり、今のところメインは10GbEとし、スイッチ間を25GbEで使うつもりでいます。ただし、アプリケーション同士で9Gbps程度の速度が25GbE環境下で出ているからといって、ネットワークを10Gbpsに変更しても影響が出ないかと言われるとそうでもなく、7Gbps程度に落ち込むケースも確認できています。今後色々検証していきたいと考えています。このブログで紹介している25GbEは簡単に接続できているように見えますが、私の使っているネットワークスイッチ（Ubiquiti PRO Aggregationスイッチ）とMellanox Connect Xカードとの相性が良い事もあります。</p>]]></content>
    
    
    <summary type="html">&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;

&lt;p&gt;1年半前に、「&lt;a href=&quot;/new-technology/2022/02/27/building-setup-esxi7/&quot; title=&quot;ESXI7.0をRyzen7 5700Gで構築&quot;&gt;ESXI7.0をRyzen7 5700Gで構築&lt;/a&gt;」の記事で、Ryzen7 5700GでESXi7のセットアップをしました。今回はESXi8.0の動作確認も含めてRyzen5 5600Gでセットアップしました。&lt;/p&gt;</summary>
    
    
    
    <category term="Hardware" scheme="https://yoshi0808.github.io/new-technology/categories/Hardware/"/>
    
    
    <category term="ESXi" scheme="https://yoshi0808.github.io/new-technology/tags/ESXi/"/>
    
    <category term="25GbE" scheme="https://yoshi0808.github.io/new-technology/tags/25GbE/"/>
    
  </entry>
  
  <entry>
    <title>VMware ESXiを8.0にアップグレードする</title>
    <link href="https://yoshi0808.github.io/new-technology/2023/06/18/esxi-upgrade8/"/>
    <id>https://yoshi0808.github.io/new-technology/2023/06/18/esxi-upgrade8/</id>
    <published>2023-06-17T22:00:00.000Z</published>
    <updated>2024-01-30T05:47:22.321Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2023/06/18/esxi-upgrade8/title.png" class="" width="1024" title="alt"><p class="onepoint">この記事で実現すること</p><p>無償版ESXi（VMware vSphere Hypervisor）について、ESXi8.0U1にアップグレードします。最新のESXiは8.0U2となっています。</p><span id="more"></span><h2 id="ご注意事項"><a href="#ご注意事項" class="headerlink" title="ご注意事項"></a>ご注意事項</h2><p>2024&#x2F;1&#x2F;22に発表されたVMWareブログによりますと、スタンドアロン製品の提供を終了し、サブスクリプションモデルに変更されることとなりました。この無償版ESXiは今後提供停止となりますが、サポートは継続されるとの事です。<br>無償版ESXiの利用にあたっては、まずこちらの記事「<a href="/new-technology/2024/01/30/EOS-Free-esxi/" title="VMWare 無償版ESXiの提供終了について">VMWare 無償版ESXiの提供終了について</a>」を参照されることをお勧めします。</p><h2 id="ESXiのアップグレード"><a href="#ESXiのアップグレード" class="headerlink" title="ESXiのアップグレード"></a>ESXiのアップグレード</h2><p>まず正式なアップグレードに関するドキュメントがVMwareより提供されており、こちらでポイントを確認します。アップデートとアップグレードとは異なります。<br>ESXiのバージョン体系は、”x”.”y” update “z” ビルド番号 という並びで表現されます。</p><ul><li>アップグレードは、前2桁（x,y）を上げることを指します。</li><li>アップデートは、前2桁が変わりません。それ以降の数字があるケース、またはUpdate”z”などの形式があります。Update2を省略してU2、さらにU2a、U2cなど英数字が上がっていきます。</li></ul><p><strong>アップデート</strong>によってこれまで動いていたハードウェアが動かなくなるという事は大々的にはおきません（ドライバーの更新によって認識しなくなったりうまく動作しないという一般的な理由はあります）。<strong>アップグレード</strong>ではハードウェアのサポート対象の見直しが入ります。</p><blockquote><p>ESXiのアップグレード<br> <a href="https://docs.vmware.com/jp/VMware-vSphere/8.0/vsphere-esxi-80-upgrade-guide.pdf">https://docs.vmware.com/jp/VMware-vSphere/8.0/vsphere-esxi-80-upgrade-guide.pdf</a></p></blockquote><p>例によってVMwareのマニュアルは法人向けにvCenter Serverを中心に記載されているのでポイントを無償版ESXiに絞ります。</p><ul><li>VMWare互換性ガイドでアップグレードが可能か確認する（P8）</li><li>ESXi8のハードウェア要件（P17）</li><li>アップグレード後はDiskのパーティション要件にてロールバック不可（P19）</li><li>esxcliコマンドまたはISOブートからのアップグレードの2種類がある（P37,P70）</li><li>アップグレードには新たにESXi8.0向けの（無償版ESXiの）ライセンスを登録する（P87）</li><li>仮想マシンとVMware Toolsのアップグレード（P11）</li></ul><p>注意点は以下の通りです。</p><blockquote><p>esxcliコマンドを使用してアップグレードすると、古いバージョンのESXiは新しいVIBのインストールを実行するため、署名が保存されずセキュアブートは実行できません。ISOを使用してアップグレードすると、新しいVIBは署名を保存できます。（P88）</p></blockquote><p>上記の注意点の通り、UEFIのセキュアブートで稼働しているESXiのバージョンアップにはISOを使用してアップグレードすべきと読めます。一方、セキュアブートでなければ、<code>esxcli software profile update --depot=&lt;depot_location&gt; --profile=&lt;profile_name&gt; </code>のコマンドでアップグレード可能です。詳細は、「<a href="/new-technology/2020/06/14/esxi67-patch/" title="VMware ESXiにパッチを適用する">VMware ESXiにパッチを適用する</a>」の記事を参照してください。但し、ESXi8.0におけるハードウェア互換性が維持できるか慎重に確認するためには、ISOでのアップグレードを検討してください。</p><p>VMware互換性ガイドは個人向けのハードウェアが殆ど列挙されておらずチェックが困難なのが実態です。ハードウェアが準拠しているかどうかのチェックについては後述します。</p><p>また、上記マニュアルには注意点としての記載がありませんが、スナップショットを取得していない状態でアップグレードされる事をお勧めします。</p><p>ESXi8にアップグレードする例を記載しています。厳密なアップグレードパスについては以下を確認してください。</p><img src="/new-technology/2023/06/18/esxi-upgrade8/upgradepath.png" class="" width="640" title="alt"><p><a href="https://interopmatrix.vmware.com/Upgrade?productId=1363">https://interopmatrix.vmware.com/Upgrade?productId=1363</a></p><blockquote><p>vCenter Server Back-in-time release<br> <a href="https://kb.vmware.com/s/article/67077#vCenterServer_7.0.x_to_8.0_upgrade_matrix">https://kb.vmware.com/s/article/67077#vCenterServer_7.0.x_to_8.0_upgrade_matrix</a></p></blockquote><h2 id="仮想マシンのバックアップ（任意）"><a href="#仮想マシンのバックアップ（任意）" class="headerlink" title="仮想マシンのバックアップ（任意）"></a>仮想マシンのバックアップ（任意）</h2><p>バージョンアップの前には仮想マシンのバックアップを別の筐体またはメディアに取得される事をお勧めします。「<a href="/new-technology/2020/10/11/esxi-backup/" title="VMware ESXiの仮想マシンをバックアップする">VMware ESXiの仮想マシンをバックアップする</a>」の記事を参照してください。ghettoVCBを使ったバックアップでは、ESXiにsshした上で、次のコマンドで全ての仮想マシンのバックアップ取得が可能です。<code>/bin/sh ./ghettoVCB.sh -a</code></p><h2 id="アップグレード対象のESXi8-0を確認する"><a href="#アップグレード対象のESXi8-0を確認する" class="headerlink" title="アップグレード対象のESXi8.0を確認する"></a>アップグレード対象のESXi8.0を確認する</h2><p>ESXiのISOインストーラのダウンロードは、2023年9月23日時点ではESXi8.0 Update2となっています。</p><blockquote><p>VMware vSphere Hypervisor 8.0 ダウンロード センター(※VMware Customer Connectへログインが必要です)<br> <a href="https://customerconnect.vmware.com/jp/evalcenter?p=free-esxi8">https://customerconnect.vmware.com/jp/evalcenter?p=free-esxi8</a></p></blockquote><h2 id="ESXi8-0インストールメディア（USB）の作成"><a href="#ESXi8-0インストールメディア（USB）の作成" class="headerlink" title="ESXi8.0インストールメディア（USB）の作成"></a>ESXi8.0インストールメディア（USB）の作成</h2><p>ここではUSBメモリを用意し、ESXi8.0のインストーラーをセットアップします。<br>事前にハードウェア互換リストを元に互換性があるかチェックしたいところですが、実際に個人向けのハードウェアは殆ど列挙されていません。</p><blockquote><p>VMware Compatibility Guide<br> <a href="https://www.vmware.com/resources/compatibility/search.php">https://www.vmware.com/resources/compatibility/search.php</a></p></blockquote><p>以前は検証のためにUSB上にESXi7.0をセットアップできましたが、 ESXi8からはUSBへのテストセットアップできなくなっています。ハードウェアが準拠せずアップグレード後起動しない、NICが利用できない可能性があるため、仮想マシンのバックアップを確保される事をお勧めします。なお、個人向けのハードウェアで関係するところは、Mellanox Connect X-3がサポート対象外となりました。Mellanoxユーザーとしては、Connect X-4&#x2F;X-5を使う事になるでしょう。</p><h3 id="ESXi8-0-インストーラーのダウンロード"><a href="#ESXi8-0-インストーラーのダウンロード" class="headerlink" title="ESXi8.0 インストーラーのダウンロード"></a>ESXi8.0 インストーラーのダウンロード</h3><p>以下からISOをダウンロードします。</p><p><a href="https://customerconnect.vmware.com/jp/web/vmware/evalcenter?p=free-esxi8">https://customerconnect.vmware.com/jp/web/vmware/evalcenter?p=free-esxi8</a></p><p>ダウンロードは、”VMware vSphere Hypervisor (ESXi ISO) image”をダウンロードします。</p><p>また、製品のライセンスキーが表示されていますので、メモを取っておいてください。</p><h3 id="Rufusによるisoメディアの作成"><a href="#Rufusによるisoメディアの作成" class="headerlink" title="Rufusによるisoメディアの作成"></a>Rufusによるisoメディアの作成</h3><p>以下のサイトからRufusをWindowsでダウンロードし実行します。</p><blockquote><p>Rufus<br> <a href="https://rufus.ie/ja/">https://rufus.ie/ja/</a></p></blockquote><p> 以下のオプションでUSBメディアにESXi8のインストーラーを書き込みます。</p> <img src="/new-technology/2023/06/18/esxi-upgrade8/rufus1.png" class="" width="480" title="alt"><p> UEFIのセキュアブートに対応させるためにはGPTとUEFIを選択してください。</p><h2 id="ESXi8-0へのアップグレード"><a href="#ESXi8-0へのアップグレード" class="headerlink" title="ESXi8.0へのアップグレード"></a>ESXi8.0へのアップグレード</h2><p>以下の動画を参考にしてください。特に難しいものはありません。途中、新規インストールかアップグレードか選択する箇所があります。この動画では新規インストールを選択していますが、アップグレードを選んでください。</p><blockquote><p><a href="https://www.youtube.com/watch?v=eiZn54GPfzI">https://www.youtube.com/watch?v=eiZn54GPfzI</a></p></blockquote><img src="/new-technology/2023/06/18/esxi-upgrade8/install.png" class="" width="1024" title="alt"><p>アップグレードが終了し、再起動する際にはUSBメディアは外してください。</p><p>無事再起動したら管理画面にログインします。<br>sshでESXiに接続し、<code>esxcli system version get</code>を実行し確認します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost:~] esxcli system version get</span><br><span class="line">   Product: VMware ESXi</span><br><span class="line">   Version: 8.0.1</span><br><span class="line">   Build: Releasebuild-21495797</span><br><span class="line">   Update: 1</span><br><span class="line">   Patch: 0</span><br><span class="line">[root@localhost:~]</span><br></pre></td></tr></table></figure><p>管理画面でもESXi8になっていることは確認できますし、<code>vmware -l</code>コマンドでも確認できますが、Versionとビルド番号で見るには上記コマンドを使います。</p><h2 id="後処理"><a href="#後処理" class="headerlink" title="後処理"></a>後処理</h2><p>無事アップグレードが成功したら、以下の作業を行います。</p><ol><li>ESXi8.0のライセンス登録<br> ESXiにログイン後、左ペインメニューの<mark class="label primary">ホスト</mark>-<mark class="label primary">管理</mark>から<mark class="label primary">ライセンスタブ</mark>を選択し、<mark class="label primary">ライセンスの割り当て</mark>でダウンロード時に控えたライセンスキーを登録します。</li><li>ESXi8.0の最新パッチ適用<br> ESXiのパッチ適用については、「<a href="/new-technology/2020/06/14/esxi67-patch/" title="VMware ESXiにパッチを適用する">VMware ESXiにパッチを適用する</a>」を参照してください。</li><li>ESXi8.0の構成情報のバックアップ（任意）</li></ol><h2 id="仮想マシンのアップグレード（任意）"><a href="#仮想マシンのアップグレード（任意）" class="headerlink" title="仮想マシンのアップグレード（任意）"></a>仮想マシンのアップグレード（任意）</h2><p>ESXiのバージョンアップ後、仮想マシンのバージョンをアップグレードできます。</p><p>アップグレードしたESXi8.0VMware Toolsよりも新しいバージョンがある場合は以下のように表示されます。</p><img src="/new-technology/2023/06/18/esxi-upgrade8/vmwaretools2.png" class="" width="640" title="alt"><p>この場合はWebUIで左ペインの<mark class="label primary">仮想マシン</mark>で対象仮想マシンを選択し、<mark class="label primary">アクション</mark>メニュー→<mark class="label primary">ゲストOS</mark>から<mark class="label primary">VMware Toolsのアップグレード</mark>を実行します。</p><p>詳細は以下の内容を参照してください。</p><blockquote><p>VMware Tools のアップグレード<br> <a href="https://docs.vmware.com/jp/VMware-Tools/11.3.0/com.vmware.vsphere.vmwaretools.doc/GUID-A2491004-1C67-4E14-B47B-807E20C19108.html">https://docs.vmware.com/jp/VMware-Tools/11.3.0/com.vmware.vsphere.vmwaretools.doc/GUID-A2491004-1C67-4E14-B47B-807E20C19108.html</a></p></blockquote><p>VMware Toolsを最新にした後、仮想マシンハードウェアをアップグレードすることができます。ただし、下記のドキュメントに注意書きがある通り、新しいハードウェアバージョンの付属機能が必要な場合のみ実行することとあり、これはESXiのアップグレードに対して必須事項ではありません。</p><blockquote><p>仮想マシンの互換性の手動アップグレード<br> <a href="https://docs.vmware.com/jp/VMware-vSphere/7.0/com.vmware.vsphere.vm_admin.doc/GUID-60768C2F-72E1-42E0-8A17-CA76849F2950.html">https://docs.vmware.com/jp/VMware-vSphere/7.0/com.vmware.vsphere.vm_admin.doc/GUID-60768C2F-72E1-42E0-8A17-CA76849F2950.html</a></p></blockquote><div class="note warning"><ul><li>仮想マシン ハードウェアをアップグレードすると、一部のアプリケーションまたはオペレーティング システムが適切に動作しなくなることがあります。ハードウェア バージョンのアップグレードは、新しいハードウェア バージョンの付属機能が必要な場合のみ実行します。</li><li>Microsoft Windows 仮想マシンで VMware Tools をアップグレードする前に互換性をアップグレードすると、仮想マシンのネットワーク設定が失われることがあります。</li></ul></div><p>この操作は以下の通りWebUIで左ペインの<mark class="label primary">仮想マシン</mark>で対象仮想マシンを選択し、<mark class="label primary">アクション</mark>メニューから<mark class="label primary">仮想マシンの互換性のアップグレード</mark>を実行します。</p><img src="/new-technology/2023/06/18/esxi-upgrade8/upgrade-vm.png" class="" width="800" title="alt"><h2 id="構成情報のバックアップ（任意）"><a href="#構成情報のバックアップ（任意）" class="headerlink" title="構成情報のバックアップ（任意）"></a>構成情報のバックアップ（任意）</h2><p>今後、パッチ適用を重ねていきますが、ある時点にロールバックしたいと思った時に、ホスト構成バックアップから戻す必要が出てきます。パッチを当てる度に構成情報のバックアップを取得されることをお勧めします。</p><p>参考にするドキュメントはこちらです。</p><blockquote><p>ESXi ホストの構成のバックアップ方法 (2042141)<br> <a href="https://kb.vmware.com/s/article/2042141?lang=ja">https://kb.vmware.com/s/article/2042141?lang=ja</a></p></blockquote><ol><li>SSHでESXiに接続します。</li><li>ストレージの確実な同期のためのコマンド<code>vim-cmd hostsvc/firmware/sync_config</code>を実行します。</li><li>バックアップコマンド<code>vim-cmd hostsvc/firmware/backup_config</code>を実行します。</li><li>画面にダウンロードパスが表示されるのでそのURLにブラウザから接続し構成情報をダウンロードします。</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@esxi:~] vim-cmd hostsvc/firmware/sync_config</span><br><span class="line">[root@esxi:~] vim-cmd hostsvc/firmware/backup_config</span><br><span class="line">Bundle can be downloaded at : http://*/downloads/52ce000f-cad4-20c0-078d-a111fa1ad82x/configBundle-esxi.local.tgz</span><br><span class="line">[root@esxi:~]</span><br></pre></td></tr></table></figure><p>先頭に<code>http://*/</code>とありますが、ここはESXiのホスト名またはIPアドレスを指定しブラウザからアクセスします。例えば、<code>http://192.168.1.1/downloads〜</code>という具合です。万が一レストアが必要になってしまった場合はバックアップを取得したバージョンのパッチを適用の上、メンテナンスモードに移行してから<code>vim-cmd hostsvc/firmware/restore_config /your_backup_location/configBundle-esxi.local.tgz</code>で戻します。バックアップを取得してから既にハードウェア構成が変わっていたりする場合は戻せない場合があります。仮想マシンはデータストアブラウザから再登録する必要があります。詳細は上記VMwareのドキュメントを参照してください。</p>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2023/06/18/esxi-upgrade8/title.png&quot; class=&quot;&quot; width=&quot;1024&quot; title=&quot;alt&quot;&gt;
&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;

&lt;p&gt;無償版ESXi（VMware vSphere Hypervisor）について、ESXi8.0U1にアップグレードします。最新のESXiは8.0U2となっています。&lt;/p&gt;</summary>
    
    
    
    <category term="Software" scheme="https://yoshi0808.github.io/new-technology/categories/Software/"/>
    
    
    <category term="ESXi" scheme="https://yoshi0808.github.io/new-technology/tags/ESXi/"/>
    
  </entry>
  
  <entry>
    <title>Sophos Firewall v19.5 MR-2</title>
    <link href="https://yoshi0808.github.io/new-technology/2023/05/16/xg-v195mr2/"/>
    <id>https://yoshi0808.github.io/new-technology/2023/05/16/xg-v195mr2/</id>
    <published>2023-05-16T03:00:00.000Z</published>
    <updated>2023-05-16T12:39:00.659Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2023/05/16/xg-v195mr2/title.png" class="" title="alt"><h2 id="Sophos-Firewall-v19-5-MR2"><a href="#Sophos-Firewall-v19-5-MR2" class="headerlink" title="Sophos Firewall v19.5 MR2"></a>Sophos Firewall v19.5 MR2</h2><p>Sophos Firewall v19.5 MR2が2023年5月8日に発表されました。</p><span id="more"></span><h2 id="主なエンハンスの内容"><a href="#主なエンハンスの内容" class="headerlink" title="主なエンハンスの内容"></a>主なエンハンスの内容</h2><p>MR2ではセキュリティ向上と4,000のマルチキャストグループのルーティングに対応しています。ホームユーザーにとって新機能が無いのは少し寂しいですが、安定性はv19以降でかなり向上しています。<br>WANセグメントに管理画面を開放している場合、ACLで厳格にアクセスリストを求められるようになります。部門のFirewallを想定しているのかもしれませんね。個人ではWANに管理画面を開放するようなことはありませんが。。。</p><p>v19.5 MR2の詳細な説明はRelease Notesを参照してください。</p><blockquote><p><a href="https://docs.sophos.com/releasenotes/index.html?productGroupID=nsg&amp;productID=xg&amp;versionID=19.5">https://docs.sophos.com/releasenotes/index.html?productGroupID=nsg&amp;productID=xg&amp;versionID=19.5</a></p></blockquote><h2 id="Sophos-Firewallのアップデート"><a href="#Sophos-Firewallのアップデート" class="headerlink" title="Sophos Firewallのアップデート"></a>Sophos Firewallのアップデート</h2><p>XGの管理画面にログイン後、左ペインメニューの<mark class="label primary">バックアップ＆ファームウェア</mark>の<mark class="label primary">ファームウェアの確認</mark>に通知が来る場合があります。</p><img src="/new-technology/2023/05/16/xg-v195mr2/notice.png" class="" width="480" title="alt"><p>また、アップデートの案内が来ていなくても、MySophosにログインし、バージョンアップの差分モジュールをダウンロードします。</p><ol><li>Sophosのサイトの上部の「ソフォスについて」のプルダウンメニューから、<mark class="label primary">ライセンスとアカウント</mark>をクリックします。<blockquote><p><a href="https://www.sophos.com/ja-jp.aspx">https://www.sophos.com/ja-jp.aspx</a></p></blockquote></li><li>Sophos IDをお持ちでなければIDを作成します。</li><li>ログイン後、<mark class="label primary">Network Protection</mark>をクリックします。</li><li><mark class="label primary">Firmware Updates</mark>をクリックします。</li><li>「製品名&#x2F;OSを使った検索」で”Firewall”を選択し、その後現れるプルダウンは”Software”を選択します。</li><li><mark class="label primary">Show Available Downloads</mark>ボタンをクリックします。</li></ol><img src="/new-technology/2023/05/16/xg-v195mr2/mysophos.png" class="" width="800" title="alt"><ol><li>上記画面で”SW-19.5.2_MR-3.SFW-624.sig”というアップデータが表示されますのでダウンロードします。</li><li>MY Sophosはここで終了してXGの管理画面にログインし、左ペインメニューの<mark class="label primary">バックアップ＆ファームウェア</mark>の<mark class="label primary">ファームウェアのタブメニュー</mark>から以下の画面に赤丸で囲った矢印のアイコンをクリックし、ダウンロードしたモジュールをアップロードします。</li></ol><img src="/new-technology/2023/05/16/xg-v195mr2/verup.png" class="" width="800" title="alt"><p>アップロード＆再起動ボタンをクリックし、v19.5 MR2へのアップグレードを完了させます。</p><img src="/new-technology/2023/05/16/xg-v195mr2/upgrade.png" class="" width="800" title="alt"><div class="note info"><p>仮想環境（ESXi）上にFirewallをインストールされている方はアップグレードの前に、「<a href="/new-technology/2020/10/11/esxi-backup/" title="VMware ESXiの仮想マシンをバックアップする">VMware ESXiの仮想マシンをバックアップする</a>」を参考に、バックアップを確保される事をお勧めします。</p></div>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2023/05/16/xg-v195mr2/title.png&quot; class=&quot;&quot; title=&quot;alt&quot;&gt;

&lt;h2 id=&quot;Sophos-Firewall-v19-5-MR2&quot;&gt;&lt;a href=&quot;#Sophos-Firewall-v19-5-MR2&quot; class=&quot;headerlink&quot; title=&quot;Sophos Firewall v19.5 MR2&quot;&gt;&lt;/a&gt;Sophos Firewall v19.5 MR2&lt;/h2&gt;&lt;p&gt;Sophos Firewall v19.5 MR2が2023年5月8日に発表されました。&lt;/p&gt;</summary>
    
    
    
    <category term="Security" scheme="https://yoshi0808.github.io/new-technology/categories/Security/"/>
    
    
    <category term="XG Firewall" scheme="https://yoshi0808.github.io/new-technology/tags/XG-Firewall/"/>
    
  </entry>
  
  <entry>
    <title>L2ネットワークとESXi</title>
    <link href="https://yoshi0808.github.io/new-technology/2023/04/29/l2-esxi/"/>
    <id>https://yoshi0808.github.io/new-technology/2023/04/29/l2-esxi/</id>
    <published>2023-04-28T15:00:00.000Z</published>
    <updated>2023-04-28T23:27:23.360Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2023/04/29/l2-esxi/title.png" class="" title="alt"><p class="onepoint">この記事で実現すること</p><p>ネットワークの教本といえば、TCP&#x2F;IP、つまりレイヤ3が中心の解説が中心です。ここでは、普段なかなか目にすることのないL2ネットワークの基礎、 ESXiにおけるネットワークの設定について説明するものです。</p><span id="more"></span><h2 id="L2ネットワークとIPアドレス"><a href="#L2ネットワークとIPアドレス" class="headerlink" title="L2ネットワークとIPアドレス"></a>L2ネットワークとIPアドレス</h2><p>個人向けのWi-Fiルーターなどを使い、PCやスマホ、またはNASや仮想環境などを使うようになれば、IPアドレスやDHCP、そして個々の端末が保有するMACアドレスというところは良く目にすることでしょう。Wi-Fiルーターと無線接続する端末だけだと、なかなかL2レイヤは気にすることは無いかもしれません。ネットワークを高度化して、ESXiなどの仮想環境を使い始めると、L2レイヤの知識が必要となってきます。何となくは理解して仮想環境を使われている方が多いかと思いますが、L2スイッチとVLAN、スタンドアロン（無償版）ESXiのvSwitchなどの具体的な設定などを確認していきます。</p><h2 id="スイッチングハブ"><a href="#スイッチングハブ" class="headerlink" title="スイッチングハブ"></a>スイッチングハブ</h2><p>個人向けに販売されているスイッチングハブといえば、一般的にL2スイッチを指します。TCP&#x2F;IPのルーティングができるL3スイッチもありますが、高額です。L2スイッチも大まかには2種類あり、VLANの設定ができるタイプと、設定が出来ないタイプとの2種類あります。スイッチングハブのネーミングの理由としては、指定されたMACアドレスがあるポートにのみデータを転送する機能を持つものです。昔のハブは電気的に全てのポートにデータを送っており、さらに半二重通信（片方が送信している時は相手側は送信できない。Wi-Fiと同様）でしたが、今のスイッチングハブといえば、全二重で双方向通信が可能であり、複数端末の同時通信でデータ送受信の競合がないようになっています（半二重通信ができる製品もあります）。スイッチングハブではない昔ながらのハブはダムハブやリピーターハブと呼ばれましたが昨今ではむしろその製品を探すのが難しくなっています（ダムハブは隣の端末の通信を傍受できるのでパケットキャプチャとしての使い道はあります）。</p><p>スイッチングハブをタイプ別と特徴で示すと以下の通りです。</p><table><thead><tr><th>タイプ</th><th>説明</th><th>特徴</th></tr></thead><tbody><tr><td>アンマネージ</td><td>電源OnしてLANケーブルを繋いですぐに使える製品。設定画面などは一切ない。</td><td>安価</td></tr><tr><td>スマートスイッチ</td><td>管理画面があり、VLAN、MACアドレスフィルタやパケットの優先度設定などが可能</td><td>個人向けには少ない</td></tr><tr><td>マネージド</td><td>VLAN、高度な管理（SNMP、Portミラーリング、コマンドライン）</td><td>やや高額。L2スイッチではスマートスイッチとマネージドとの区別が付けづらくなってきている</td></tr><tr><td>L3スイッチ</td><td>DHCP機能、ネットワークアドレスを分離し、ルーティングが可能。マネージドスイッチの扱い。</td><td>高額。ネットワークの知識が必要な難解なコマンドライン中心の製品が多い。</td></tr></tbody></table><p>ホームユーザーとしては、こういった情報よりも、10GbEとか2.5GbEなどのポートの速度を優先したり、発熱を気にしてファンレスか否か、ファンがどれだけ静かなのかをポイントにしてスイッチングハブを購入されていることでしょう。単にネットを使うだけであればそれで充分で、普段はL2ネットワークの事を気にする必要はありません。</p><p>リモートワークで家の機器と会社の機器とを分離したい場合、一般的にWi-Fiルーターではゲスト用ネットワーク（ゲスト用SSID）があるので、昔ほどVLANを必要としなくなっています。こういった単にネットを使うだけで何も管理できないスイッチをアンマネージスイッチと呼びます。</p><h3 id="スイッチング能力"><a href="#スイッチング能力" class="headerlink" title="スイッチング能力"></a>スイッチング能力</h3><p>スイッチの性能の一つにスイッチング能力、別名、スイッチングファブリックというものがあります。比較サイトでも必ずスペックとして出ているものですが、この数値は、基本的に全てのポートが全二重でブロッキングせずにデータを送信できるものとして計算された数値となっています。8Portで全て10GbEなら以下の通りです。</p><ul><li>10Gbps×8(Port)×2（全二重）&#x3D; 160Gbps</li></ul><p>10GbEが4Port、1GbEが8Portの製品なら、96Gbpsという具合です。ですので、製品を比較して「こちらのハブのスループットが高そうだ」という事にはなりません。</p><h3 id="スマートスイッチ・マネージドスイッチ"><a href="#スマートスイッチ・マネージドスイッチ" class="headerlink" title="スマートスイッチ・マネージドスイッチ"></a>スマートスイッチ・マネージドスイッチ</h3><p>全く管理画面が無いL2スイッチはIPアドレスを持ちませんが、スマートスイッチ・マネージドスイッチと呼ばれている製品はIPアドレスを持ちます。この”スマート”や”マネージド”というネーミングも実は明確な定義はありません。各社によって呼び名が少しづつ異なっており、はっきり言えばマーケティング用語です。Webの管理画面があってもVLANが無いL2スイッチもあります。</p><p>IPアドレスを持っているとはいえ、スイッチ経由で通信をする際に、ルーターのようにスイッチのIPアドレスを経由する訳ではありません。以下のように見えないPort0番にAmazon Fire Stickをさらに小さくしたような組み込み機器で独立したOSが接続されていて、そこに最低限のネットワーク通信と管理のためのOSの機能を持っていると考えてください。スイッチングハブとしてパケットを転送している機能はハードウェアであるASIC(Application Specific Integrated Circuit)が担っており、この小さな機器は殆ど使われません。最近のWi-Fi機器もこういった形になっており、管理画面の遷移が遅いからといって転送能力が劣っているという訳でもありません。PCなどからスイッチへのpingを打つと、このPort0番に着信して応答を返す仕組みになります（pingの応答速度も一般的に遅いです）。</p><img src="/new-technology/2023/04/29/l2-esxi/sw3.drawio.png" class="" width="360" title="alt"><p>日本では、全くITの知識が無い人向けに分かりやすくスイッチを提供するという事が主眼に置かれているため、アンマネージスイッチが主力製品として販売されていますが、値段なりの品質です。仮想環境やNASなど24時間の運用を前提で考えるのであれば、スイッチにもそれなりの品質を求めるべきです。アンマネージで不具合が出ると回収するしかありません。ファームウェアの更新ができるもの、かつ、きちんと定期的にアップデートが行われている製品を選定されることをお勧めします。</p><h3 id="L2ネットワークとMACアドレス"><a href="#L2ネットワークとMACアドレス" class="headerlink" title="L2ネットワークとMACアドレス"></a>L2ネットワークとMACアドレス</h3><p>L2スイッチはMACアドレスを宛先として判断し、パケットを目的のポートに転送します。この世界ではIPアドレスはデータの中身として扱われ、宛先として使われることはありません。例えば、以下のPCとL2スイッチとの関係で確認してみます。</p><img src="/new-technology/2023/04/29/l2-esxi/net1.drawio.png" class="" width="640" title="alt"><p>PC1からPC2にpingを打つこととします。</p><pre class="mermaid">sequenceDiagramparticipant pc1 as PC1participant sw as SWitchparticipant pc2 as PC2Note over pc1: 1.PC2へのpingコマンド投入pc1 -&gt;&gt; sw : 2.ARP Request(PC2)をブロードキャストNote over sw: 3.PC1のMACを自己学習sw -&gt;&gt; pc2 : 4.ARP Requestをブロードキャストpc2 --&gt;&gt; sw : 5.ARP Reply(PC2のMAC)Note over sw: 6.PC2のMACを自己学習sw --&gt;&gt; pc1 : 7.ARP Reply(PC2のMAC)pc1 -&gt;&gt; sw : 8.ICMP Echo Requestsw -&gt;&gt; pc2 : 9.ICMP Echo Requestpc2 --&gt;&gt; sw : 10.ICMP Echo Replysw --&gt;&gt; pc1 : 11.ICMP Echo ReplyNote over pc1: 12.ping応答</pre><p>このシーケンスの実行の結果は以下の通りです。</p><p>PC1のarpテーブルは以下になります(Windowsでの実行を想定)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\yoshi&gt;arp -a</span><br><span class="line"></span><br><span class="line">インターフェイス: 192.168.100.129 --- 0x10</span><br><span class="line"> インターネット アドレス 物理アドレス           種類</span><br><span class="line">  192.168.100.161       04-69-f8-aa-bb-cc      動的</span><br><span class="line">  255.255.255.255       ff-ff-ff-ff-ff-ff     静的</span><br></pre></td></tr></table></figure><p>PC2のARPテーブルは以下になります(macOSでの実行を想定)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ arp -a</span><br><span class="line">? (192.168.100.129) at 30:59:b7:00:11::22 on en0 ifscope [ethernet]</span><br></pre></td></tr></table></figure><p>そして、スイッチ上のMACアドレステーブルは、MACアドレスと接続されているPortの組み合わせが登録されています（ここではUbiquiti社のPro Aggregationスイッチを使っています。各社、機種毎に取得方法は異なります）。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(UBNT) &gt;show mac-addr-table</span><br><span class="line"></span><br><span class="line">VLAN ID  MAC Address         Interface              IfIndex  Status</span><br><span class="line">-------  ------------------  ---------------------  -------  ------------</span><br><span class="line">1        30:59:B7:00:11:22   0/1                    1        Learned</span><br><span class="line">1        04:69:F8:AA:BB:CC   0/28                   28       Learned</span><br></pre></td></tr></table></figure><p>VLANはデフォルトVLANが1の製品が大半です。MACアドレステーブルにはVLANのIDが必要ですが、詳細説明は割愛します（機種により実装の違いがあります）。</p><p>さて、このようにして、PC同士はL3レイヤ（IPアドレス）からL2レイヤ（MACアドレス）への変換の情報をお互いに持ち、スイッチはMACアドレスとそれがどのPortに接続されているかを管理しています。</p><p>スイッチ自身に管理画面がないと、スイッチの中身がどうなっているか分からないんですが、アンマネージスイッチでは管理IPアドレスを持たないだけで、しっかりとMACアドレステーブルの管理は行われています。</p><p>ちなみに、MACアドレスは6バイトでコロン区切りかハイフン区切りとなっています。先頭の3バイトがVendorIDとなっていて、上記の例だと、<code>30:59:B7</code>はMicrosoft社であり、<code>04:69:F8</code>はApple社になります。</p><p>ご自身のPCでも<code>arp -a</code>を実行してみてください。LANにあるさまざまな端末のIPアドレスとMACアドレスの一覧が確認できるはずです。</p><blockquote><p>Ubiquiti Switch Pro Aggregation<br> <a href="https://jp.store.ui.com/collections/unifi-network-switching/products/unifi-switch-aggregation-pro">https://jp.store.ui.com/collections/unifi-network-switching/products/unifi-switch-aggregation-pro</a></p></blockquote><h2 id="ESXiのL2ネットワーク"><a href="#ESXiのL2ネットワーク" class="headerlink" title="ESXiのL2ネットワーク"></a>ESXiのL2ネットワーク</h2><p>ここではVSphere Hypervisor（無償版ESXi）についての説明になります。ESXiは仮想環境として端末を動作させる機能とvSwitchという仮想ネットワークスイッチの機能を持っています。実際は1つのネットワークカードに対して、複数の仮想マシンを動作させることが可能となっています。</p><h3 id="仮想マシンのNIC"><a href="#仮想マシンのNIC" class="headerlink" title="仮想マシンのNIC"></a>仮想マシンのNIC</h3><p>仮想マシンの構成としての一例を挙げます。</p><img src="/new-technology/2023/04/29/l2-esxi/vm1.png" class="" width="1024" title="alt"><p>この仮想マシンはUbuntuで、1つの仮想ネットワークアダプタを持っています。最もシンプルな構成です。MACアドレスの先頭3バイトは<code>00:0c:29</code>となっており、これはVMwareのVenderIDです。下位3バイトは仮想マシンの構成時に自動的に振られます。</p><p>続いて、仮想ネットワークスイッチの説明です。</p><img src="/new-technology/2023/04/29/l2-esxi/vsw1.png" class="" width="1024" title="alt"><p>この例では仮想スイッチ1つに物理アダプタを1つ加えています。ESXi本体のハードウェアに付属するネットワークカードが物理アダプタです。</p><img src="/new-technology/2023/04/29/l2-esxi/vsw2.png" class="" width="640" title="alt"><p>この物理アダプタには当然ですが物理MACアドレスがあります。仮想ネットワークアダプタに到達するためには、この物理アダプタを経由する必要があります。しかし、ESXiのネットワークドライバのレベルで仮想ネットワークアダプタがNICの物理デバイスと接続されており、物理ネットワークアダプタ<code>80:61:5f:xx:xx:xx</code>は使わず、仮想MACアドレス<code>00:0c:29:4f:2e:05</code>が仮想マシンに接続されています。<code>80:61:5f:xx:xx:xx</code>は使われていないと書きましたが、ESXiを構成すると、vmnic0の物理MACアドレスはESXiのVMKernelのvmk0に使われるようになっています。ESXiの世界ではネットワークの障害時の切り替えなども考慮し、物理MACアドレスはあまり重要ではありません。</p><p>過去の技術ですが、物理MACアドレスがデータを受け取って仮想MACアドレスに変換して受け渡す、いわゆるNATの技術も実際には存在します。しかし、今のESXiでは物理NICから実際の仮想MACアドレスのデータが流れていきます。</p><p>一例として、私の保有しているスイッチでPort19のESXiの物理NICとESXiの仮想MACアドレステーブルを表示させると以下のようになっています。<br>（物理MACアドレスの値と一部のVLANの値は修正しています）<br>前述したように、先頭３バイトが<code>00:0C:29</code>のものが仮想マシンです。</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(UBNT) <span class="comment">#show mac-addr-table | include Interface|00:0C:29|80:61:5F</span></span><br><span class="line"></span><br><span class="line">VLAN ID  MAC Address         Interface              IfIndex  Status</span><br><span class="line">200      00:0C:29:4F:2E:05   0/19                   19       Learned</span><br><span class="line">200      00:0C:29:C8:1F:97   0/19                   19       Learned</span><br><span class="line">200      80:61:5F:00:00:03   0/19                   19       Learned</span><br></pre></td></tr></table></figure><p>VLAN200の２つの仮想マシンが存在している事が分かります、スイッチはこのようにして仮想マシンのMACアドレス１つ１つを管理し、適切なスイッチポートに転送していることがわかります。</p><p>ちなみに物理スイッチを多段接続した場合にも、1つのポートから先のスイッチ経由で複数の端末が接続されていれば同様に1つのポートに複数の端末のMACアドレスがテーブルに管理されます。</p><h3 id="vSwitch"><a href="#vSwitch" class="headerlink" title="vSwitch"></a>vSwitch</h3><p>vSwitchでは物理NICを経由して仮想マシンと接続するためのポートグループが必要です。仮想マシンにネットワークアダプタを加える時にはこのポートグループが必要です。ESXiのセットアップ完了後は、<mark class="label primary">vSwitch0</mark>  がデフォルトのvSwitchとして作成されており、ポートグループとして、<mark class="label primary">Management Network</mark>および<mark class="label primary">VM Network</mark>の2つが作成されています。</p><img src="/new-technology/2023/04/29/l2-esxi/vsw3.png" class="" width="480" title="alt"><mark class="label primary">Management Network</mark>は、ESXiのWebにログインしたり制御のためのポートグループです。このグループの中にデフォルトで<mark class="label primary">VMKernel NIC</mark>として<mark class="label primary">vmk0</mark>が自動作成されています。VMKernel NICはESXiのWebサービスを始めとする管理系のサービス提供のためのIPアドレスを持ちます。前述したL2スイッチの説明ではPort0として小さな組み込み機器としてOSが稼働していると表現しましたが、それと目的は同じです。VMKernelはvSwitchを制御するというよりは、ネットワークセグメント単位に持ち、ESXiを管理するためのIPアドレスとなります。<mark class="label primary">VM Network</mark>もポートグループです。仮想マシンが何もない初期状態では特に仮想IPアドレスも保有していません。仮想マシンを作成し、ネットワークアダプタを追加する際に、この<mark class="label primary">VM Network</mark>を選択することになります。そうすると自動的に仮想IPアドレスが振られます。もちろん、新規にポートグループを作成し、仮想マシンにネットワークアダプタを追加する事もできます。また、ポートグループという”グループ”の意味としては、複数の仮想マシンを同一のポートグループに追加できます。この際、MACアドレスが同じになったりはしません。<div class="note info"><p>ポートグループ1つで複数の仮想NICと接続できます。仮想マシン作成時、仮想MACアドレスは自動的に割り当てられます。物理NICを2つ以上保有する場合、障害対策と負荷分散ができます。負荷分散の際、ESXiのデフォルトでは、ポートグループ単位に複数の物理NICを使い負荷分散をします。</p></div><div class="note info"><p><mark class="label primary">Management Network</mark>と<mark class="label primary">VM Network</mark>のポートグループが分かれているのは、本来、マネジメントネットワークとクライアントやサーバーがある仮想マシンのネットワークとは分離すべきという考えに基づいています。</p></div><p>なお、仮想マシンをバックアップから戻した場合には、既存の仮想マシンと同一のMACアドレスで復元してしまうと通信が正しく行えなくなります。従って、仮想マシンの復元後、初期起動時には以下のダイアログが表示され、<mark class="label primary">コピーしました</mark>を選択すると、新しい仮想MACアドレスが割り当てられます。</p><img src="/new-technology/2023/04/29/l2-esxi/esxi3.png" class="" width="640" title="alt"><h4 id="特殊な設定"><a href="#特殊な設定" class="headerlink" title="特殊な設定"></a>特殊な設定</h4><p>vSwitchには以下の2つの特殊な仮想マシンのための追加設定ができます。</p><img src="/new-technology/2023/04/29/l2-esxi/vsw4.png" class="" width="480" title="alt"><ul><li><mark class="label primary">無差別モードを許可</mark><p> ファイアウォールやIPS&#x2F;IDS（Intrusion Prevention System&#x2F;Intrusion Detection System）などセキュリティ製品におけるブリッジモードのように、同一LAN内でパケットの検証をする際にはこれを<mark class="label primary">はい</mark>に変更します。セキュリティ製品の先に接続されている端末も同一のL2ネットワークとして全てパケットを転送してあげる動作です。自分宛のMACアドレスでなくとも受け取る挙動であり、仮想マシンはダムハブに見えるわけです。また、仮想マシンのネットワークキャプチャを行う場合に使えます。</p></li><li><mark class="label primary">偽装転送を許可/MAC変更を許可</mark><p> 上記と同じようにセキュリティ製品（ゲートウェイ）がバックヤードにある端末のパケットを相互にやりとりするわけですから、自分自身のMACアドレスではないMACアドレスを持ったデータを送信する事になります。一般的にはセキュリティ上認めていないものですが、セキュリティ製品では<mark class="label primary">MAC変更を許可</mark>を<mark class="label primary">はい</mark>を、<mark class="label primary">偽装転送を許可</mark>を<mark class="label primary">はい</mark>にします。</p></li></ul><p>これらはいずれもセキュリティ強化のためにデフォルトでは<mark class="label primary">いいえ</mark>になっています。<br>これらの機能の詳細はVMwareの以下のドキュメントを参照してください。</p><blockquote><p>vSphere 標準スイッチのセキュリティ強化<br> <a href="https://docs.vmware.com/jp/VMware-vSphere/7.0/com.vmware.vsphere.security.doc/GUID-3507432E-AFEA-4B6B-B404-17A020575358.html">https://docs.vmware.com/jp/VMware-vSphere/7.0/com.vmware.vsphere.security.doc/GUID-3507432E-AFEA-4B6B-B404-17A020575358.html</a></p></blockquote><h2 id="ESXiのVLAN"><a href="#ESXiのVLAN" class="headerlink" title="ESXiのVLAN"></a>ESXiのVLAN</h2><p>無償版ESXiではVLAN設定が可能です。<br>ESXiにおけるデフォルトVLAN（タグ無し）はVLAN ID＝0となります。通常のスイッチはVLAND ID＝1のものが多いのですが、基本的にタグ無し同士の通信であれば問題になりません。デフォルトVLANを変更し、さらにそれをネイティブVLAN（タグ無し）にする時は少し考える必要がありますが、ホームユーザー向けではそこまで考えることも無いでしょう。</p><table><thead><tr><th>ESXiのVLANのタイプ</th><th>説明</th></tr></thead><tbody><tr><td>EST</td><td>通常のタグ無し。物理スイッチのアクセスポートに接続する場合でスイッチ側でタグが外される事を期待。</td></tr><tr><td>VST</td><td>タグ付き（1〜4094）。物理スイッチからタグ付きで接続する場合。</td></tr><tr><td>VGT</td><td>タグ付き（4095）。仮想マシンに複数のタグ付きパケットを流す場合</td></tr></tbody></table><p>3種類それぞれのネーミングがあります。</p><p>EST（タグ無し）はVLANを意識しないモードです。<br>タグ無しでvSwitchのポートグループに渡されることを期待している設定です。物理スイッチがアクセスポートの場合は、タグが外されるのでvSwtichおよびポートグループでは特に何もしませんし、仮想マシンでも何も意識しません。</p><p>VSTは、VLAN IDをポートグループに設定します。<br>例えば、ESXiのマネジメントネットワークはタグ無し、仮想マシンはユーザー側ネットワークとする場合にvSwitchで2つのセグメントのデータを受け入れ、VMKernelはタグ無しのまま、仮想マシンはポートグループでIDに200を指定します。この場合はVLAN200について、vSwitchでタグが外され仮想マシンにパケットが届きますので仮想マシンでVLANの意識はしません。</p><p>VGTは物理スイッチにおけるトランクポートの役割と同等です。ポートグループに4095を設定します。仮想マシン自身がタグVLANを解釈できる場合に複数のVLANのタグ付きパケットを流し、仮想マシン側でタグを外すような使い方となります。また、VSTではESXiの仕様として1〜4094とありますが、一般的にタグありのVLANは2〜1005の間で作成しますし、個人向け環境のVLANはネットワークアドレスの第3オクテットの数字と合わせるのが無難です。<code>192.168.xxx.0/24</code><br>全てのVLANデータが流れて不要なものは仮想マシン側で破棄する事になるので負荷が高くなりやすく、物理スイッチからは必要なVLANのみのデータを流すことが求められます。</p><img src="/new-technology/2023/04/29/l2-esxi/vsw3.png" class="" width="480" title="alt"><p>VSTの例ですが、Win10ProのVLAN IDを300とすると、ポートグループの設定でVLANの値を明示します。</p><img src="/new-technology/2023/04/29/l2-esxi/vsw5.png" class="" width="640" title="alt"><p>このvSwitchの例で言えば、タグ300のパケットは、VGT（ID&#x3D;4095）、300と明示した2つの仮想マシンのみに転送されます。VLAN ID0のVM NetworkおよびManagement Networkにはタグ300のパケットは流れません。</p><p>このように、vmnic0に接続されたvSwitchネットワークはvmk0のIPネットワークが<code>192.168.1.0/24</code>だとすれば、全ての仮想マシンが<code>192.168.1.0/24</code>のIPアドレスを持つのがシンプルな構成ですが、このようにタグVLANを組み合わせることで、物理NICの数が少なくても複数のVLAN、つまり複数のネットワークセグメントのデータを通すことができます。</p><p>VGTの場合は、物理スイッチ側のMACアドレステーブルは以下のようになっています。仮想マシン自体がVLANのトランクポートを扱えるため、１つのMACアドレスに複数のVLANが割り当てられている事が分かります。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">VLAN ID  MAC Address         Interface              IfIndex  Status</span><br><span class="line">1        00:0C:29:EB:B3:CC   0/15                   15       Learned</span><br><span class="line">200      00:0C:29:EB:B3:CC   0/15                   15       Learned</span><br><span class="line">300      00:0C:29:EB:B3:CC   0/15                   15       Learned</span><br><span class="line">4040     00:0C:29:EB:B3:CC   0/15                   15       Learned</span><br></pre></td></tr></table></figure><p>ESXiのVLANタグについては以下のドキュメントを参照してください。英語ですが3つのVLANについての解説ビデオもあります。</p><blockquote><p>VMware VLAN 構成<br> <a href="https://docs.vmware.com/jp/VMware-vSphere/7.0/com.vmware.vsphere.networking.doc/GUID-7225A28C-DAAB-4E90-AE8C-795A755FBE27.html?hWord=N4IghgNiBcIBwAYBMA6AjARRAXyA">https://docs.vmware.com/jp/VMware-vSphere/7.0/com.vmware.vsphere.networking.doc/GUID-7225A28C-DAAB-4E90-AE8C-795A755FBE27.html?hWord=N4IghgNiBcIBwAYBMA6AjARRAXyA</a></p></blockquote>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2023/04/29/l2-esxi/title.png&quot; class=&quot;&quot; title=&quot;alt&quot;&gt;

&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;

&lt;p&gt;ネットワークの教本といえば、TCP&amp;#x2F;IP、つまりレイヤ3が中心の解説が中心です。ここでは、普段なかなか目にすることのないL2ネットワークの基礎、 ESXiにおけるネットワークの設定について説明するものです。&lt;/p&gt;</summary>
    
    
    
    <category term="Network" scheme="https://yoshi0808.github.io/new-technology/categories/Network/"/>
    
    
    <category term="ESXi" scheme="https://yoshi0808.github.io/new-technology/tags/ESXi/"/>
    
  </entry>
  
  <entry>
    <title>Mellanox Connect XとWindows11</title>
    <link href="https://yoshi0808.github.io/new-technology/2023/03/25/Mellanox-ConnectXandWindows11/"/>
    <id>https://yoshi0808.github.io/new-technology/2023/03/25/Mellanox-ConnectXandWindows11/</id>
    <published>2023-03-24T15:00:01.000Z</published>
    <updated>2023-07-07T09:59:55.337Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2023/03/25/Mellanox-ConnectXandWindows11/title.png" class="" width="1024" title="alt"><p class="onepoint">この記事で実現すること</p><p>この記事ではSFP+のネットワークカードである、Mellanox Connect XについてWindows11の対応状況やWindowsでのファームウェアアップデートなどを記します。</p><span id="more"></span><h2 id="安価なMellanox-Connect-Xカード"><a href="#安価なMellanox-Connect-Xカード" class="headerlink" title="安価なMellanox Connect-Xカード"></a>安価なMellanox Connect-Xカード</h2><p>すでに販売終了となったConnect X-3はeBayで5,000円弱で売られています。MellanoxのConnect Xシリーズは脆弱性の指摘も見かけず、安定しているNICでしょうか。intelに比べればマイナーですが、SFP＋で安価に入手可能となっており、ホームユーザーにとっても大変ありがたい存在です。<br>Connect X-3はWindows10までのドライバはNvidiaのサイトに掲載されていますがWindows11ではドライバの存在はありません。</p><p>しかしながら、Windows11ではConnect Xを認識してWindowsとして用意されたドライバのインストールが行われ、すぐに使えます。いわゆる、Windows11に標準で付属しているinboxドライバになります。逆にNVidiaサイトにあるWindows10用のドライバはWindows11ではエラーが発生し動きません。後述のNVidiaフォーラムの投稿をご確認ください。</p><p>最近、2PortのMellanox Connect X-4 LxをeBayでちらほら見かけるようになってきました。販売終了した製品ですが、サポートはされています。</p><p><strong>MCX4121A-ACAT</strong>という型番は、<strong>Mellanox ConnectX-4 LX 25GBE SFP28 2ポートPCIeイーサネット アダプター</strong>となっており、eBayで15,000円ほどで購入できます。SFP28はSFP+とモジュール接続口の互換性があります。SFP＋のダイレクトアタッチケーブル（DAC）やOM3ケーブルと共に使うSFP+短距離マルチモードファイバ（MM SR）モジュール等の10GbE SFP+で問題なく10Gbps通信できます。もちろん25GbEとしても使えますが、PCなどホスト端末に挿して使うには他の機器との速度差が大きすぎて使いにくいものです。intel製のNICは在庫不足から回復傾向にあるようですが、まだまだ高額です。</p><p>詳しいスペックは以下のリンクを参照してください。PCIe3 x8となっています。</p><blockquote><p>Mellanox Connect X-4<br> <a href="https://network.nvidia.com/files/doc-2020/pb-connectx-4-lx-en-card.pdf">https://network.nvidia.com/files/doc-2020/pb-connectx-4-lx-en-card.pdf</a></p></blockquote><p>Connect X-3はやや個人向けの色合いが強かったですが、Connect X-4あたりからはサーバー製品としての要素が強くなっていきます。OEM版（HPE、DELL向け等）は避けることをお勧めします。これはベンダーロックインが掛かっている可能性が高く、ファームウェアの強制書き込みなどが必要になります。また、それでうまくいく保証もありません。また、Connect X-4はいろいろなホストインタフェースがありますので、Ethernet、PCIeというところに気をつけてください。PCIeスロットに挿すだけですぐにWindows11で使えるMCX4121A-ACATはお勧めです。</p><p>2Portも要らないといっても、eBayでは意外と1Portものが出ていません。また、他カードとの兼ね合い（x16が埋まっている）でPCIe x4までという方は一般論としてConnect X-3（MCX311A-XCAT）が向いています。</p><blockquote><p>Nvidia ConnectX-4 Lx 製品概要<br> <a href="https://www.nvidia.com/ja-jp/networking/ethernet/connectx-4-lx/">https://www.nvidia.com/ja-jp/networking/ethernet/connectx-4-lx/</a></p></blockquote><blockquote><p>NVidiaフォーラムでConnect X-3のWin11のドライバが無いことをNVidiaのテクニカルサポートが示唆<br> <a href="https://forums.developer.nvidia.com/t/connectx-3-cx311a-xcat-for-win11-crashed/205962">https://forums.developer.nvidia.com/t/connectx-3-cx311a-xcat-for-win11-crashed/205962</a></p></blockquote><h2 id="Windows11でのデバイスドライバ"><a href="#Windows11でのデバイスドライバ" class="headerlink" title="Windows11でのデバイスドライバ"></a>Windows11でのデバイスドライバ</h2><h3 id="Connect-X-3"><a href="#Connect-X-3" class="headerlink" title="Connect X-3"></a>Connect X-3</h3><p>Connect X-3をPCIeにセットしてWin11を起動します。デバイスドライバを見てみます。</p><img src="/new-technology/2023/03/25/Mellanox-ConnectXandWindows11/x3.png" class="" width="480" title="alt"><p>2019年のinboxドライバが自動的に取り込まれます。このドライバに脆弱性が出てしまえば、リスクがあり別の製品に買い替えが必要となりますが、脆弱性データベースでもなかなかMellanoxの名前を見ることはありません。</p><p>お約束ですが、ESXi上のUbuntuとのiperf3を実行してみます。MTUは1,500のデフォルト、スイッチはフローコントロールをオンにしています。<br>多重度3でUbuntuからダウンロードする方向（-Rオプション）に実行して以下の通りです。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[ ID] Interval           Transfer     Bitrate         Retr</span><br><span class="line">[  5]   0.00-10.05  sec  3.81 GBytes  3.26 Gbits/sec  615             sender</span><br><span class="line">[  5]   0.00-10.00  sec  3.81 GBytes  3.27 Gbits/sec                  receiver</span><br><span class="line">[  7]   0.00-10.05  sec  3.46 GBytes  2.96 Gbits/sec  423             sender</span><br><span class="line">[  7]   0.00-10.00  sec  3.46 GBytes  2.97 Gbits/sec                  receiver</span><br><span class="line">[  9]   0.00-10.05  sec  3.79 GBytes  3.24 Gbits/sec  623             sender</span><br><span class="line">[  9]   0.00-10.00  sec  3.78 GBytes  3.25 Gbits/sec                  receiver</span><br><span class="line">[SUM]   0.00-10.05  sec  11.1 GBytes  9.45 Gbits/sec  1661             sender</span><br><span class="line">[SUM]   0.00-10.00  sec  11.1 GBytes  9.49 Gbits/sec                  receiver</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>(Ryzen 7 5700G、メモリDDR4-3200 DIMM (PC4-25600)32GByte)<br>このPCにはPCIe×16のスロットにConnect X-4を、PCIe x4のスロットにConnect X-3を挿しています。</p><p>少しリトライが多いようですが、9.49Gbpsです。<code>-R -P3</code>オプションとして逆方向の送信（ダウンロード）、多重度3のみ、それ以外のオプションは指定していません。Windows10時代でも多重度は4程度から9.3Gbpsをマークしていたと記憶しているので、まずまずでしょうか。Windows11側がダウンロード側ですのでUbuntu側の送信速度に少し追いついていないようです。これはドライバが最適化されていない可能性もあります。しかし、実運用として使うのであれば十分でしょう。</p><h3 id="Connect-X-4"><a href="#Connect-X-4" class="headerlink" title="Connect X-4"></a>Connect X-4</h3><p>Connect X-4はWindows11で自動導入されるドライバは2020年のものですが、新しいドライバをNvidiaからダウンロードできます。</p><img src="/new-technology/2023/03/25/Mellanox-ConnectXandWindows11/x4.png" class="" width="480" title="alt"><p>NVidiaではSoftwareのEthernetの分類でドライバを検索することになります。<br><a href="https://developer.nvidia.com/networking/ethernet-software">https://developer.nvidia.com/networking/ethernet-software</a></p><p>具体的には、以下のWinOF-2がWin10以降のドライバとなります。</p><blockquote><p>MLNX_OFED for Windows - WinOF &#x2F; WinOF-2<br> <a href="https://network.nvidia.com/products/adapter-software/ethernet/windows/winof-2/">https://network.nvidia.com/products/adapter-software/ethernet/windows/winof-2/</a></p></blockquote><p>Connect X-4は2023年2月2日に発表されたRevision3.20.50010が最新のようですが、実際のドライバは上記のキャプチャの通り、3.2.25がインストールされます。</p><p>セットアップはただインストーラの指示に従い、進めていくだけなので何も難しいものはありません。</p><img src="/new-technology/2023/03/25/Mellanox-ConnectXandWindows11/setup.png" class="" width="480" title="alt"><h2 id="Connect-X-4のスループット"><a href="#Connect-X-4のスループット" class="headerlink" title="Connect X-4のスループット"></a>Connect X-4のスループット</h2><p>PCのConnect X-4（SFP28スロット）にSFP＋モジュールを挿入し、対向もスイッチに挿します。</p><p>Connect X-3もConnect X-4も同じ10GbEとして使うなら変わらないように思えますが、ドライバの違いもさることながら能力は結構違います。<br>多重度1でUbuntuに対して実行した結果です。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">Connect X-4 flow control send</span><br><span class="line"></span><br><span class="line">[ ID] Interval           Transfer     Bitrate</span><br><span class="line">[  5]   0.00-1.00   sec  1.11 GBytes  9.51 Gbits/sec</span><br><span class="line">[  5]   1.00-2.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   2.00-3.00   sec  1.10 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   3.00-4.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   4.00-5.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   5.00-6.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   6.00-7.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   7.00-8.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   8.00-9.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   9.00-10.00  sec  1.10 GBytes  9.49 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[ ID] Interval           Transfer     Bitrate</span><br><span class="line">[  5]   0.00-10.00  sec  11.1 GBytes  9.49 Gbits/sec                  sender</span><br><span class="line">[  5]   0.00-10.04  sec  11.0 GBytes  9.45 Gbits/sec                  receiver</span><br><span class="line"></span><br><span class="line">Connect X-4 flow control recv</span><br><span class="line"></span><br><span class="line">[ ID] Interval           Transfer     Bitrate</span><br><span class="line">[  5]   0.00-1.00   sec  1.11 GBytes  9.51 Gbits/sec</span><br><span class="line">[  5]   1.00-2.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   2.00-3.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   3.00-4.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   4.00-5.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   5.00-6.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   6.00-7.00   sec  1.10 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   7.00-8.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   8.00-9.00   sec  1.10 GBytes  9.48 Gbits/sec</span><br><span class="line">[  5]   9.00-10.00  sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[ ID] Interval           Transfer     Bitrate         Retr</span><br><span class="line">[  5]   0.00-10.05  sec  11.1 GBytes  9.45 Gbits/sec    0             sender</span><br><span class="line">[  5]   0.00-10.00  sec  11.1 GBytes  9.49 Gbits/sec                  receiver</span><br></pre></td></tr></table></figure><p>非常に安定していますね。Windowsのiperf3のシングルプロセスでRetryが0です。<br>ちなみにこれだけ安定しているならということでスイッチのフローコントロールを外してみます。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">Connect X-4 no flow control send</span><br><span class="line"></span><br><span class="line">[ ID] Interval           Transfer     Bitrate</span><br><span class="line">[  5]   0.00-1.00   sec  1.11 GBytes  9.52 Gbits/sec</span><br><span class="line">[  5]   1.00-2.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   2.00-3.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   3.00-4.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   4.00-5.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   5.00-6.00   sec  1.10 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   6.00-7.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   7.00-8.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   8.00-9.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   9.00-10.00  sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[ ID] Interval           Transfer     Bitrate</span><br><span class="line">[  5]   0.00-10.00  sec  11.1 GBytes  9.50 Gbits/sec                  sender</span><br><span class="line">[  5]   0.00-10.04  sec  11.1 GBytes  9.45 Gbits/sec                  receiver</span><br><span class="line"></span><br><span class="line">Connect X-4 no flow control recv</span><br><span class="line"></span><br><span class="line">[ ID] Interval           Transfer     Bitrate</span><br><span class="line">[  5]   0.00-1.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   1.00-2.00   sec  1.10 GBytes  9.47 Gbits/sec</span><br><span class="line">[  5]   2.00-3.00   sec  1.10 GBytes  9.47 Gbits/sec</span><br><span class="line">[  5]   3.00-4.00   sec  1.10 GBytes  9.47 Gbits/sec</span><br><span class="line">[  5]   4.00-5.00   sec  1.10 GBytes  9.47 Gbits/sec</span><br><span class="line">[  5]   5.00-6.00   sec  1.10 GBytes  9.47 Gbits/sec</span><br><span class="line">[  5]   6.00-7.00   sec  1.10 GBytes  9.47 Gbits/sec</span><br><span class="line">[  5]   7.00-8.00   sec  1.10 GBytes  9.47 Gbits/sec</span><br><span class="line">[  5]   8.00-9.00   sec  1.10 GBytes  9.47 Gbits/sec</span><br><span class="line">[  5]   9.00-10.00  sec  1.10 GBytes  9.45 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[ ID] Interval           Transfer     Bitrate         Retr</span><br><span class="line">[  5]   0.00-10.05  sec  11.0 GBytes  9.42 Gbits/sec    0             sender</span><br><span class="line">[  5]   0.00-10.00  sec  11.0 GBytes  9.47 Gbits/sec                  receiver</span><br></pre></td></tr></table></figure><p>フローコントロール無しでこれは良い結果です。もっとも、アプリケーション（iperf3）が再送を必要としていないだけであって、NIC同士がオフロードして送受信管理するのでOSまでその情報は見えていないと考えられます。昔はとても高価かつ使いこなすのが難しいNICでしたが、シンプルに使うだけであれば、容易にその高い性能がホームユーザーにも享受できるようになってきました。</p><h2 id="Connect-Xのファームウェア更新（Windows版）"><a href="#Connect-Xのファームウェア更新（Windows版）" class="headerlink" title="Connect Xのファームウェア更新（Windows版）"></a>Connect Xのファームウェア更新（Windows版）</h2><p>特にMellanoxのNICで脆弱性という話を聞いたことはなく、頻繁にパッチが出ないので本当に運用が楽ではありますが購入時にファームウェアを更新しておきましょう。「<a href="/new-technology/2022/04/02/nic-firmware/" title="ESXiでネットワークカードのファームウェアを更新する">ESXiでネットワークカードのファームウェアを更新する</a>」ではネットに接続されていない前提としてパッチを個別にダウンロードしましたが、Windowsの場合はネットに接続されている事が前提でしょうから、もう少し手間は省けます（ESXiホスト自身はNTPなど限定されたサービスを除きインターネットアクセスしないのが一般的です）。</p><p>WindowsにおいてMellanoxカードのファームウェアの更新にはMFTとmlxupの2つのツールが必要です。<br>まずMFTのインストールになります。以下のURLからMFTをダウンロードします。</p><blockquote><p>NVIDIA Firmware Tools (MFT)<br> <a href="https://network.nvidia.com/products/adapter-software/firmware-tools/">https://network.nvidia.com/products/adapter-software/firmware-tools/</a></p></blockquote><p>2023-3-25時点では、2023-1-31リリースの4.23.0が最新のようです。<br>MFTもインストーラーで特に悩むこともなくセットアップを完了させます。OSを再起動するとMFTツールは自動起動されますが、再起動しなくともコマンドプロンプトから<code>mst server start</code>でサービスが起動します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\yoshi&gt;mst server start</span><br><span class="line"></span><br><span class="line">C:\Users\yoshi&gt;Waiting for connection on port 23108</span><br></pre></td></tr></table></figure><p>引き続き、管理者権限のコマンドプロンプトを開き、<code>mst status</code>を実行するとNICの情報が得られます。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">C:\Windows\System32&gt;mst status</span><br><span class="line">MST devices:</span><br><span class="line">------------</span><br><span class="line"></span><br><span class="line">  mt4117_pciconf0</span><br><span class="line"></span><br><span class="line">C:\Windows\System32&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>続いてmlxupのダウンロードです。これはexeファイルそのものなので、ブラウザからのダウンロード時に警告が出るかもしれません。</p><blockquote><p>mlxup - Update and Query Utility<br> <a href="https://network.nvidia.com/support/firmware/mlxup-mft/">https://network.nvidia.com/support/firmware/mlxup-mft/</a></p></blockquote><p>ダウンロードしたら、コマンドプロンプトにて<code>mlxup.exe --query</code>を実行します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mlxup --query</span><br><span class="line"></span><br><span class="line">Querying Mellanox devices firmware ...</span><br><span class="line"></span><br><span class="line">Device #1:</span><br><span class="line">----------</span><br><span class="line"></span><br><span class="line">  Device Type:      ConnectX4LX</span><br><span class="line">  Part Number:      MCX4121A-ACA_Ax</span><br><span class="line">  Description:      ConnectX-4 Lx EN network interface card; 25GbE dual-port SFP28; PCIe3.0 x8; ROHS R6</span><br><span class="line">  PSID:             MT_2420110034</span><br><span class="line">  PCI Device Name:  mt4117_pciconf0</span><br><span class="line">  Base MAC:         0c42a1000000</span><br><span class="line">  Versions:         Current        Available</span><br><span class="line">     FW             14.25.1020     14.32.1010</span><br><span class="line">     PXE            3.5.0701       3.6.0502</span><br><span class="line">     UEFI           14.18.0019     14.25.0017</span><br><span class="line"></span><br><span class="line">  Status:           Update required</span><br></pre></td></tr></table></figure><p>するとこのようにファームウェアの情報とアップデート可能か否かの情報が得られます。<br>実際のファームウェアの更新は<code>mlxup --online</code>です。これで適切なファームウェアがダウンロードされ適用されます。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\yoshi\Downloads&gt;mlxup --online</span><br><span class="line">Querying Mellanox devices firmware ...</span><br><span class="line"></span><br><span class="line">Device #1:</span><br><span class="line">----------</span><br><span class="line"></span><br><span class="line">  Device Type:      ConnectX4LX</span><br><span class="line">  Part Number:      MCX4121A-ACA_Ax</span><br><span class="line">  Description:      ConnectX-4 Lx EN network interface card; 25GbE dual-port SFP28; PCIe3.0 x8; ROHS R6</span><br><span class="line">  PSID:             MT_2420110034</span><br><span class="line">  PCI Device Name:  mt4117_pciconf0</span><br><span class="line">  Base MAC:         0c42a1000000</span><br><span class="line">  Versions:         Current        Available</span><br><span class="line">     FW             14.25.1020     14.32.1010</span><br><span class="line">     PXE            3.5.0701       3.6.0502</span><br><span class="line">     UEFI           14.18.0019     14.25.0017</span><br><span class="line"></span><br><span class="line">  Status:           Update required</span><br><span class="line"></span><br><span class="line">Release notes for the available Firmware:</span><br><span class="line">-----------------------------------------</span><br><span class="line"></span><br><span class="line">  For more details, please refer to the following FW release notes:</span><br><span class="line">    1- ConnectX3 (2.42.5000):    http://www.mellanox.com/pdf/firmware/ConnectX3-FW-2_42_5000-release_notes.pdf</span><br><span class="line">    2- ConnectX3Pro (2.42.5000): http://www.mellanox.com/pdf/firmware/ConnectX3Pro-FW-2_42_5000-release_notes.pdf</span><br><span class="line">    3- Connect-IB (10.16.1200):  http://www.mellanox.com/pdf/firmware/ConnectIB-FW-10_16_1200-release_notes.pdf</span><br><span class="line">    4- ConnectX4 (12.28.2006):   http://docs.mellanox.com/display/ConnectX4Firmwarev12282006</span><br><span class="line">    5- ConnectX4Lx (14.32.1010): http://docs.mellanox.com/display/ConnectX4LxFirmwarev14321010</span><br><span class="line">    6- ConnectX5 (16.35.2000):   http://docs.mellanox.com/display/ConnectX5Firmwarev16352000</span><br><span class="line">    7- ConnectX6 (20.36.1010):   http://docs.mellanox.com/display/ConnectX6Firmwarev20361010</span><br><span class="line">    8- ConnectX6Dx (22.36.1010):   http://docs.mellanox.com/display/ConnectX6DxFirmwarev22361010</span><br><span class="line">    9- ConnectX6Lx (26.36.1010):   http://docs.mellanox.com/display/ConnectX6LxFirmwarev26361010</span><br><span class="line">    10- BlueField2 (24.35.2000):   http://docs.mellanox.com/display/BlueField2Firmwarev24352000</span><br><span class="line">    11- ConnectX7 (28.36.1010):   http://docs.mellanox.com/display/ConnectX7Firmwarev28361010</span><br><span class="line"></span><br><span class="line">---------</span><br><span class="line">Found 1 device(s) requiring firmware update...</span><br><span class="line"></span><br><span class="line">Perform FW update? [y/N]: y</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CMD: mlxup -u --log-on-update --ssl-certificate C:\Users\yoshi\AppData\Local\Temp\sfxter_yoshi_3512\mlxup-dir\ca-bundle.crt --current-dir C:\Users\yoshi\Downloads\  --online</span><br><span class="line">Querying Mellanox devices firmware ...</span><br><span class="line"></span><br><span class="line">Device #1:</span><br><span class="line">----------</span><br><span class="line"></span><br><span class="line">  Device Type:      ConnectX4LX</span><br><span class="line">  Part Number:      MCX4121A-ACA_Ax</span><br><span class="line">  Description:      ConnectX-4 Lx EN network interface card; 25GbE dual-port SFP28; PCIe3.0 x8; ROHS R6</span><br><span class="line">  PSID:             MT_2420110034</span><br><span class="line">  PCI Device Name:  mt4117_pciconf0</span><br><span class="line">  Base MAC:         0c42a1000000</span><br><span class="line">  Versions:         Current        Available</span><br><span class="line">     FW             14.25.1020     14.32.1010</span><br><span class="line">     PXE            3.5.0701       3.6.0502</span><br><span class="line">     UEFI           14.18.0019     14.25.0017</span><br><span class="line"></span><br><span class="line">  Status:           Update required</span><br><span class="line"></span><br><span class="line">Release notes for the available Firmware:</span><br><span class="line">-----------------------------------------</span><br><span class="line"></span><br><span class="line">  For more details, please refer to the following FW release notes:</span><br><span class="line">    1- ConnectX3 (2.42.5000):    http://www.mellanox.com/pdf/firmware/ConnectX3-FW-2_42_5000-release_notes.pdf</span><br><span class="line">    2- ConnectX3Pro (2.42.5000): http://www.mellanox.com/pdf/firmware/ConnectX3Pro-FW-2_42_5000-release_notes.pdf</span><br><span class="line">    3- Connect-IB (10.16.1200):  http://www.mellanox.com/pdf/firmware/ConnectIB-FW-10_16_1200-release_notes.pdf</span><br><span class="line">    4- ConnectX4 (12.28.2006):   http://docs.mellanox.com/display/ConnectX4Firmwarev12282006</span><br><span class="line">    5- ConnectX4Lx (14.32.1010): http://docs.mellanox.com/display/ConnectX4LxFirmwarev14321010</span><br><span class="line">    6- ConnectX5 (16.35.2000):   http://docs.mellanox.com/display/ConnectX5Firmwarev16352000</span><br><span class="line">    7- ConnectX6 (20.36.1010):   http://docs.mellanox.com/display/ConnectX6Firmwarev20361010</span><br><span class="line">    8- ConnectX6Dx (22.36.1010):   http://docs.mellanox.com/display/ConnectX6DxFirmwarev22361010</span><br><span class="line">    9- ConnectX6Lx (26.36.1010):   http://docs.mellanox.com/display/ConnectX6LxFirmwarev26361010</span><br><span class="line">    10- BlueField2 (24.35.2000):   http://docs.mellanox.com/display/BlueField2Firmwarev24352000</span><br><span class="line">    11- ConnectX7 (28.36.1010):   http://docs.mellanox.com/display/ConnectX7Firmwarev28361010</span><br><span class="line"></span><br><span class="line">---------</span><br><span class="line">Found 1 device(s) requiring firmware update...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Please wait while downloading MFA(s) ...</span><br><span class="line">Device #1: Updating FW ...</span><br><span class="line"></span><br><span class="line">FSMST_INITIALIZE -   OK</span><br><span class="line"></span><br><span class="line">Writing Boot image component -   0%</span><br><span class="line">Writing Boot image component -   1%</span><br><span class="line">Writing Boot image component -   2%</span><br><span class="line">(省略)</span><br><span class="line">Writing Boot image component - 100%</span><br><span class="line">Writing Boot image component -   OK</span><br><span class="line">Done</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Restart needed for updates to take effect.</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>最後にOSをリブートして完了です。ESXiよりはずいぶん簡単ですね。</p><p>個別のファームウェアを適用したい場合は、mlxupのダウンロードページにUser Manualのリンクがありますので参照してください。</p><h2 id="PCIe-x4スロット"><a href="#PCIe-x4スロット" class="headerlink" title="PCIe x4スロット"></a>PCIe x4スロット</h2><p>さて、エイプリールフールも近いのでネタを1つご紹介します。<br>今回紹介したMellanox Connect X-4の必要レーン数は、PCIe x8です。グラフィックカードをPCIe x16に挿していらっしゃる方は残りのPCIe x4のスロットしか使えず、最初からPCIe x8のネットワークカードは候補に上がらないと思います。</p><p>私のもう1台のPC（Ryzen5 5600G）のPCIe x4のスロットです（PCIe3 x4で動作）。物理的なスロットは長いですが、接続端子がx4の部分までしかありません（画像をクリックして拡大できます）。</p><img src="/new-technology/2023/03/25/Mellanox-ConnectXandWindows11/pci1.png" class="" width="1024" title="alt"><p>Connect X-4を挿すところです。どう見てもレーン数が不足しています。</p><img src="/new-technology/2023/03/25/Mellanox-ConnectXandWindows11/pci2.png" class="" width="1024" title="alt"><p>とりあえずはスロットにConnect X-4を差し込み、Windows11を起動すると無事にカードは認識されています。<strong>SFP28モジュール</strong>とOM3ケーブルとを使ってスイッチに繋いでみます。</p><img src="/new-technology/2023/03/25/Mellanox-ConnectXandWindows11/unifi1.png" class="" width="1024" title="alt"><p>（UbiquitiのSwitch Pro Aggregationスイッチは4つのSFP28ポートを持っています。見た目はSFP+と区別がつきませんが、右側の4PortがSFP28です）</p><p>iperf3のテストです。Windows11同士、それぞれがConnectx-4で片方がPCIe x4です。多重度は2です。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">iperf3 PCIe x4 Ryzen5(SFP28) &lt;- Ryzen7(SFP28)</span><br><span class="line"></span><br><span class="line">C:\Users\yoshi&gt;iperf3 -c 192.168.x.165 -R -P2</span><br><span class="line">Connecting to host 192.168.x.165, port 5201</span><br><span class="line">Reverse mode, remote host 192.168.x.165 is sending</span><br><span class="line">[  5] <span class="built_in">local</span> 192.168.x.112 port 49813 connected to 192.168.x.165 port 5201</span><br><span class="line">[  7] <span class="built_in">local</span> 192.168.x.112 port 49814 connected to 192.168.x.165 port 5201</span><br><span class="line">[ ID] Interval           Transfer     Bitrate</span><br><span class="line">[  5]   0.00-1.00   sec  1.37 GBytes  11.8 Gbits/sec</span><br><span class="line">[  7]   0.00-1.00   sec  1.35 GBytes  11.6 Gbits/sec</span><br><span class="line">[SUM]   0.00-1.00   sec  2.72 GBytes  23.3 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[  5]   1.00-2.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class="line">[  7]   1.00-2.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class="line">[SUM]   1.00-2.00   sec  2.76 GBytes  23.7 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[  5]   2.00-3.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class="line">[  7]   2.00-3.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class="line">[SUM]   2.00-3.00   sec  2.76 GBytes  23.7 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[  5]   3.00-4.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class="line">[  7]   3.00-4.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class="line">[SUM]   3.00-4.00   sec  2.76 GBytes  23.7 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[  5]   4.00-5.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class="line">[  7]   4.00-5.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class="line">[SUM]   4.00-5.00   sec  2.76 GBytes  23.7 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[  5]   5.00-6.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class="line">[  7]   5.00-6.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class="line">[SUM]   5.00-6.00   sec  2.76 GBytes  23.7 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[  5]   6.00-7.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class="line">[  7]   6.00-7.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class="line">[SUM]   6.00-7.00   sec  2.76 GBytes  23.7 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[  5]   7.00-8.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class="line">[  7]   7.00-8.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class="line">[SUM]   7.00-8.00   sec  2.76 GBytes  23.7 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[  5]   8.00-9.00   sec  1.35 GBytes  11.6 Gbits/sec</span><br><span class="line">[  7]   8.00-9.00   sec  1.39 GBytes  11.9 Gbits/sec</span><br><span class="line">[SUM]   8.00-9.00   sec  2.74 GBytes  23.5 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[  5]   9.00-10.00  sec  1.39 GBytes  11.9 Gbits/sec</span><br><span class="line">[  7]   9.00-10.00  sec  1.35 GBytes  11.6 Gbits/sec</span><br><span class="line">[SUM]   9.00-10.00  sec  2.73 GBytes  23.5 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[ ID] Interval           Transfer     Bitrate</span><br><span class="line">[  5]   0.00-10.00  sec  13.8 GBytes  11.8 Gbits/sec                  sender</span><br><span class="line">[  5]   0.00-10.00  sec  13.8 GBytes  11.8 Gbits/sec                  receiver</span><br><span class="line">[  7]   0.00-10.00  sec  13.8 GBytes  11.8 Gbits/sec                  sender</span><br><span class="line">[  7]   0.00-10.00  sec  13.8 GBytes  11.8 Gbits/sec                  receiver</span><br><span class="line">[SUM]   0.00-10.00  sec  27.5 GBytes  23.6 Gbits/sec                  sender</span><br><span class="line">[SUM]   0.00-10.00  sec  27.5 GBytes  23.6 Gbits/sec                  receiver</span><br><span class="line"></span><br><span class="line">iperf Done.</span><br></pre></td></tr></table></figure><p>中途半端な繋ぎ方ですが、25GbEワイヤレートの速度がしっかり出ています。25GbEの全二重通信の検証まではやっていませんが、そもそもPCIe x8で25GbEが2Portならば、PCIe x4で25GbEの1Portはいけるでしょうし、10GbEなら2Portともに大丈夫でしょう。</p><p>まるでギャンブルですが、エイプリールフールでした、、、ということではありません。Mellanox Connect X-4はこういった接続方法に対応しています。</p><img src="/new-technology/2023/03/25/Mellanox-ConnectXandWindows11/mellanox.png" class="" width="480" title="alt"><p>冒頭で紹介した製品スペックのPDFでは、赤枠で囲ったところに、オートネゴシエートとあります。理論上、PCIe3 x4では帯域が32Gbpsですから25Gbpsの通信は可能ということになります。</p><p>どうしても先入観があって、x4のスロットにx8のカードを挿そうと思いませんよね。</p><p>PCIeのレーン数はご利用のマザーボードによって様々な仕様がありますので事前のご確認をお勧めします。</p>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2023/03/25/Mellanox-ConnectXandWindows11/title.png&quot; class=&quot;&quot; width=&quot;1024&quot; title=&quot;alt&quot;&gt;
&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;

&lt;p&gt;この記事ではSFP+のネットワークカードである、Mellanox Connect XについてWindows11の対応状況やWindowsでのファームウェアアップデートなどを記します。&lt;/p&gt;</summary>
    
    
    
    <category term="Hardware" scheme="https://yoshi0808.github.io/new-technology/categories/Hardware/"/>
    
    <category term="Network" scheme="https://yoshi0808.github.io/new-technology/categories/Network/"/>
    
    
    <category term="SFP+" scheme="https://yoshi0808.github.io/new-technology/tags/SFP/"/>
    
    <category term="10GbE" scheme="https://yoshi0808.github.io/new-technology/tags/10GbE/"/>
    
    <category term="25GbE" scheme="https://yoshi0808.github.io/new-technology/tags/25GbE/"/>
    
  </entry>
  
  <entry>
    <title>Sophos Firewall v19.5 MR-1</title>
    <link href="https://yoshi0808.github.io/new-technology/2023/02/23/xg-v195mr1/"/>
    <id>https://yoshi0808.github.io/new-technology/2023/02/23/xg-v195mr1/</id>
    <published>2023-02-22T21:34:42.000Z</published>
    <updated>2023-02-23T06:48:44.000Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2023/02/23/xg-v195mr1/title.png" class="" title="alt"><h2 id="Sophos-Firewall-v19-5-MR1"><a href="#Sophos-Firewall-v19-5-MR1" class="headerlink" title="Sophos Firewall v19.5 MR1"></a>Sophos Firewall v19.5 MR1</h2><p>Sophos Firewall v19.5 MR1が2023年2月15日に発表されました。</p><span id="more"></span><h2 id="主なエンハンスの内容"><a href="#主なエンハンスの内容" class="headerlink" title="主なエンハンスの内容"></a>主なエンハンスの内容</h2><p>Home Editionとしてはバグフィックスのみで機能向上はなさそうです。新機能が無いのは少し寂しいですが、安定性はv19以降でかなり向上したと感じます。</p><p>v19.5 MR1の詳細な説明はRelease Notesを参照してください。</p><blockquote><p><a href="https://docs.sophos.com/releasenotes/index.html?productGroupID=nsg&amp;productID=xg&amp;versionID=19.5">https://docs.sophos.com/releasenotes/index.html?productGroupID=nsg&amp;productID=xg&amp;versionID=19.5</a></p></blockquote><h2 id="Sophos-Firewallのアップデート"><a href="#Sophos-Firewallのアップデート" class="headerlink" title="Sophos Firewallのアップデート"></a>Sophos Firewallのアップデート</h2><p>XGの管理画面にログイン後、左ペインメニューの<mark class="label primary">バックアップ＆ファームウェア</mark>の<mark class="label primary">ファームウェアの確認</mark>ではただちに全てのユーザーにアップデートの案内が来るわけでは無いので、アップデートにはMySophosにログインし、バージョンアップの差分モジュールをダウンロードします。</p><ol><li>Sophosのサイトの右上のプルダウンメニューから、<mark class="label primary">ライセンスとアカウント</mark>をクリックします。<blockquote><p><a href="https://www.sophos.com/ja-jp.aspx">https://www.sophos.com/ja-jp.aspx</a></p></blockquote></li><li>Sophos IDをお持ちでなければIDを作成します。</li><li>ログイン後、<mark class="label primary">Network Protection</mark>をクリックします。</li><li><mark class="label primary">ファームウェアの更新</mark>をクリックします。</li><li>「製品名&#x2F;OSを使った検索」で”ファイアーウォール”を選択し、その後現れるプルダウンは”ソフトウェア”を選択します。</li><li><mark class="label primary">選択可能なダウンロードを表示</mark>ボタンをクリックします。</li></ol><img src="/new-technology/2023/02/23/xg-v195mr1/mysophos.png" class="" width="800" title="alt"><ol><li>上記画面で”SW-19.5.1_MR-1.SFW-278.sig”というアップデータが表示されますのでダウンロードします。</li><li>MY Sophosはここで終了してXGの管理画面にログインし、左ペインメニューの<mark class="label primary">バックアップ＆ファームウェア</mark>の<mark class="label primary">ファームウェアのタブメニュー</mark>から以下の画面に赤丸で囲った矢印のアイコンをクリックし、ダウンロードしたモジュールをアップロードします。</li></ol><img src="/new-technology/2023/02/23/xg-v195mr1/verup.png" class="" width="800" title="alt"><p>アップロード＆再起動ボタンをクリックし、v19.5へのアップグレードを完了させます。</p><img src="/new-technology/2023/02/23/xg-v195mr1/upgrade.png" class="" width="800" title="alt"><div class="note info"><p>仮想環境（ESXi）上にFirewallをインストールされている方はアップグレードの前に、「<a href="/new-technology/2020/10/11/esxi-backup/" title="VMware ESXiの仮想マシンをバックアップする">VMware ESXiの仮想マシンをバックアップする</a>」を参考に、バックアップを確保される事をお勧めします。</p></div>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2023/02/23/xg-v195mr1/title.png&quot; class=&quot;&quot; title=&quot;alt&quot;&gt;

&lt;h2 id=&quot;Sophos-Firewall-v19-5-MR1&quot;&gt;&lt;a href=&quot;#Sophos-Firewall-v19-5-MR1&quot; class=&quot;headerlink&quot; title=&quot;Sophos Firewall v19.5 MR1&quot;&gt;&lt;/a&gt;Sophos Firewall v19.5 MR1&lt;/h2&gt;&lt;p&gt;Sophos Firewall v19.5 MR1が2023年2月15日に発表されました。&lt;/p&gt;</summary>
    
    
    
    <category term="Security" scheme="https://yoshi0808.github.io/new-technology/categories/Security/"/>
    
    
    <category term="XG Firewall" scheme="https://yoshi0808.github.io/new-technology/tags/XG-Firewall/"/>
    
  </entry>
  
  <entry>
    <title>auひかり BL3000HM</title>
    <link href="https://yoshi0808.github.io/new-technology/2023/01/28/bl3000hm/"/>
    <id>https://yoshi0808.github.io/new-technology/2023/01/28/bl3000hm/</id>
    <published>2023-01-27T15:00:00.000Z</published>
    <updated>2023-02-23T07:12:09.000Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2023/01/28/bl3000hm/bl3000hm.png" class="" width="240" title="alt"><p class="onepoint">この記事で実現すること</p><p>auひかりの新しいホームゲートウェイ（HGW)に交換してみたのでレポートします。ONUと一体型となったモデルです。Wi-Fi6Eにも対応しています。私はauひかりのWi-Fiは契約していないため、Wi-Fi以外の基本性能・機能について紹介します。</p><span id="more"></span><h2 id="auひかりホームユーザー向け、HGW交換の案内"><a href="#auひかりホームユーザー向け、HGW交換の案内" class="headerlink" title="auひかりホームユーザー向け、HGW交換の案内"></a>auひかりホームユーザー向け、HGW交換の案内</h2><p>auひかりではこれまでもユーザーの希望によるホームゲートウェイの交換について、半導体不足により一時的に交換を停止していましたが、昨年末に再開するという案内がありました。</p><blockquote><p>2022&#x2F;12&#x2F;22 auひかり ホームゲートウェイ：お客さまのご要望による交換（希望交換）の再開について<br> <a href="https://www.au.com/information/notice_internet/service/20221220-01/">https://www.au.com/information/notice_internet/service/20221220-01/</a></p></blockquote><p>私はこれまでホーム5ギガユーザーとしてBL1000HW（HGW）と10G-PON（ONU）をレンタルで利用していましたが、ONU一体型のHGWになるということで多少のレイテンシと消費電力の改善期待があり早速交換のお願いをしました。交換には3,300円掛かるとの記載があります。電話回線が2回線ある場合はBL3000HMには交換できないようです。<br>インターネット回線によるスピードテストでも3ギガ程度は出ており全く不満はありませんが、5ギガと10ギガの差額が月額780円なので、10ギガの契約に併せて変更もしました。</p><h2 id="auひかりホーム10ギガ・5ギガについて"><a href="#auひかりホーム10ギガ・5ギガについて" class="headerlink" title="auひかりホーム10ギガ・5ギガについて"></a>auひかりホーム10ギガ・5ギガについて</h2><p>auひかりのホーム10ギガ・5ギガサービスは関東圏の一部エリアのみ提供となっています。IPv4&#x2F;IPv6デュアルスタックで複雑な設定が不要で高速インターネットが利用できます。<br>ホーム10ギガ・5ギガのサービス説明は以下を参照してください。</p><blockquote><p>auひかり ホーム10ギガ・5ギガ<br> <a href="https://www.au.com/internet/auhikari_10-5g/">https://www.au.com/internet/auhikari_10-5g/</a></p></blockquote><p>基本情報、マニュアルは以下を参照してください。</p><blockquote><p>auひかり ホームゲートウェイ Aterm BL3000HM<br> <a href="https://www.au.com/support/service/internet/guide/modem/bl3000hm/">https://www.au.com/support/service/internet/guide/modem/bl3000hm/</a></p></blockquote><h2 id="BL3000HM"><a href="#BL3000HM" class="headerlink" title="BL3000HM"></a>BL3000HM</h2><p>年末に申し込んで年明け早々にBL3000HM（BL3000：右側）が届きました。BL1000（左側）も大きかったですがBL3000はかなり大きいと感じます。交換は自分で行います。</p><img src="/new-technology/2023/01/28/bl3000hm/bl3000-1.png" class="" width="1024" title="alt"><p>横幅28cm程度もありますね。私の場合はクローゼットの中に収まるので大きさは特に気になりませんが、リビングに配置するとなると少し目立つサイズです。</p><p>BL3000には、上記写真にある通り、ひかり回線と接続するコネクタ付きのシングルモードファイバケーブル（約3m）が既に取り付けられています。説明書には約3mと書いてありますが、これ3mもあるかな。。。その他付属品として電源ケーブル（アース無し）とLANケーブル（1.5m）があります。</p><table><thead><tr><th>機種</th><th>消費電力</th><th>アース</th><th>LANケーブル</th></tr></thead><tbody><tr><td>BL3000HM</td><td>45W（最大）</td><td>無し</td><td>Cat6A STP</td></tr><tr><td>BL1000HW</td><td>34W(最大)</td><td>無し</td><td>Cat6A STP</td></tr><tr><td>10G-EPON</td><td>14.3W以下</td><td>無し</td><td>Cat6A STP</td></tr></tbody></table><p>最大消費電力だけで見るとBL1000とONUとを合計したものとBL3000と比較した場合は大して変わりません。BL1000、BL3000共にWi-Fi機能を持ちますから、Wi-Fiを使わない場合はそれなりに電力が抑えられているものと思います。付属のケーブルは前回も今回も変わらず、Cat6Aのシールドツイストペア（STP）です。STPを使う場合には正しいアースが云々というご意見もあるようですが、短いケーブルについて気にすることは無いということでしょう。LAN4というRJ45の口が10GbEですが、5G&#x2F;2.5G&#x2F;1G&#x2F;100Base-TXにも対応しています。</p><p>早速、BL3000のファイバケーブルを光回線に接続し直し、LANケーブルを10GbEポートに接続し、電源を入れてみます。</p><img src="/new-technology/2023/01/28/bl3000hm/wchecker.png" class="" width="360" title="alt"><p>普段のアイドル状態で16.35w、2.5Gbps程度のアップロード時で16.5Wです。やはりネットワーク機器なのでNATやフィルタ処理などを除いたルーティングは通信専用のチップ（ASIC）が対応するため通信量と電力とは殆ど関係ありません。</p><h2 id="回線速度"><a href="#回線速度" class="headerlink" title="回線速度"></a>回線速度</h2><p>さて、いつものSpeedtestです。HGWとスイッチとをRJ45で接続し、スイッチとMacBook-AirとをSFP+で接続して計測してみます。平日の夕方に計測しました。</p><p>HGWのLANに接続</p><img src="/new-technology/2023/01/28/bl3000hm/speedtest1.png" class="" width="360" title="alt"><p>Sophos Firewall（TLS／SSLインスペクション有り）を通した速度</p><img src="/new-technology/2023/01/28/bl3000hm/speedtest2.png" class="" width="360" title="alt"><p>HGWのLANに接続した場合は5Gbps以上の速度が出ています。一方、FirewallのTLS&#x2F;SSLインスペクションを通しても下りはさほど落ちていません。上りは流石にデータ漏洩の観点から厳しくチェックするのでこれくらいには落ちてしまうのは仕方がないところでしょうか。自宅内のFirewallを通してもレイテンシ（Ping）が3ミリ秒という表示になっており、かなりの低遅延のネットワークになっていると言えそうです。これまでは4ミリ秒でした。</p><p>朝方の計測はHGW直結で5Gbps〜6Gbps程度の速度です。</p><h2 id="ログ機能"><a href="#ログ機能" class="headerlink" title="ログ機能"></a>ログ機能</h2><p>今回のHGWは簡単なログ機能が付いています。HGWのデフォルトのLANのIPアドレスは<code>192.168.0.1/24</code>です。</p><img src="/new-technology/2023/01/28/bl3000hm/log.png" class="" width="800" title="alt"><h2 id="スイッチ部分"><a href="#スイッチ部分" class="headerlink" title="スイッチ部分"></a>スイッチ部分</h2><p>BL1000HWと同様、BL3000HMも10GbEが1Port、1GbEが3Portとなります。</p><img src="/new-technology/2023/01/28/bl3000hm/sw.png" class="" width="360" title="alt"><p>一般的に、スイッチ機能を持つ1Gのチップ（PHY）は4Port単位で組まれることが多いです。10GbEと1GbEと合わせて4Portというのは、実際に10GbEに対応した4PortのPHYに1GbEの3Portが接続されているのでは？と妄想してしまいます。</p><p>10Gポートと1Gポートとのスループットはどうでしょうか。10Gポートには、Mellanox Connect-X3(10G SFP+)を挿したUbuntu22をSFP+スイッチ経由で接続し、1GポートにはMacBook-AirにPlaggableのUSBアダプタを挿してiperf3を実行してみます。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">yoshi@ub22:~$ iperf3 -c 192.168.0.3</span><br><span class="line">Connecting to host 192.168.0.3, port 5201</span><br><span class="line">[  5] <span class="built_in">local</span> 192.168.0.4 port 48032 connected to 192.168.0.3 port 5201</span><br><span class="line">[ ID] Interval           Transfer     Bitrate         Retr  Cwnd</span><br><span class="line">[  5]   0.00-1.00   sec   115 MBytes   963 Mbits/sec    0   3.77 MBytes</span><br><span class="line">[  5]   1.00-2.00   sec   112 MBytes   944 Mbits/sec    0   3.77 MBytes</span><br><span class="line">[  5]   2.00-3.00   sec   112 MBytes   944 Mbits/sec    0   3.96 MBytes</span><br><span class="line">[  5]   3.00-4.00   sec   111 MBytes   933 Mbits/sec    0   3.96 MBytes</span><br><span class="line">[  5]   4.00-5.00   sec   112 MBytes   944 Mbits/sec    0   3.96 MBytes</span><br><span class="line">[  5]   5.00-6.00   sec   112 MBytes   944 Mbits/sec    0   3.96 MBytes</span><br><span class="line">[  5]   6.00-7.00   sec   112 MBytes   944 Mbits/sec    0   3.96 MBytes</span><br><span class="line">[  5]   7.00-8.00   sec   112 MBytes   944 Mbits/sec    0   3.96 MBytes</span><br><span class="line">[  5]   8.00-9.00   sec   111 MBytes   933 Mbits/sec    0   3.96 MBytes</span><br><span class="line">[  5]   9.00-10.00  sec   112 MBytes   944 Mbits/sec    0   3.96 MBytes</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[ ID] Interval           Transfer     Bitrate         Retr</span><br><span class="line">[  5]   0.00-10.00  sec  1.10 GBytes   944 Mbits/sec    0             sender</span><br><span class="line">[  5]   0.00-10.03  sec  1.10 GBytes   941 Mbits/sec                  receiver</span><br></pre></td></tr></table></figure><p>文句なしのパフォーマンスです。このタイミングでワットチェッカーを確認してみました。</p><img src="/new-technology/2023/01/28/bl3000hm/wchecker2.png" class="" width="360" title="alt"><p>10GbEに加え、1GbEのRJ45をBL3000HMに接続しているため、ベースの消費電力は16.787Wとなっています。10GbEのみと比べ、0.43W消費電力が増えています。<br>これにiperf3を実行したタイミングでは、16.84Wとなり、僅か0.07W弱の消費電力が上昇しています。非常に誠実な作りであると思われます。</p><p>10GのPHYは単体であったり、2Port、4Portと様々な種類がありますが、他の製品のHGWやWi-Fiルーターで1GbEが4Port、10GbEが1Portある製品を見た時には、それらを繋ぐのはどうやっているのかな？と気になります。ASICではなくCPU（ソフトウェア）で相互にパケットをやり取りしている製品もあるらしく、10GbEと1GbEの通信のパフォーマンスが出ないそうです。</p><h2 id="レイテンシとアプリケーション"><a href="#レイテンシとアプリケーション" class="headerlink" title="レイテンシとアプリケーション"></a>レイテンシとアプリケーション</h2><p>私は10Gbpsのトラフィックを必要としていませんが、こういった多段のセグメントを介するネットワーク構成(VLAN)&#x2F;仮想環境&#x2F;Firewall&#x2F;アンチウィルス&#x2F;アプリケーションFirewallを組み合わせているため、少しでもレイテンシが大きくなるのを防ぎたいという狙いがあります。こうやって全体を俯瞰して見ると、セキュリティのためとはいえ、レイテンシが大きくなるような事ばかりしているわけです。</p><p>私の使っているアンチウィルスソフトのBitDefenderはそれ単体でTLS&#x2F;SSLインスペクションを実行するため、なおさら遅くなります。</p><p>最近のファイル転送プロトコルであればファイルのやり取りに高度な並列処理を実施することでトータルのデータ転送量を稼ぎますが、アプリケーションによっては単一のTCPセッションによるやり取りとなります。そのようなアプリケーションはいくら回線が太くても、到底大きな転送量はこなせません。数10Mbps程度の速度でもレイテンシが大きく関係するようになります。</p><p>高速回線と聞けば、ストリーミングビデオを思いつく方が多いでしょうか。4Kの映画や音楽配信サービスなどは負担が大きそうに思えるかもしれません。しかしこのようなサービスはデータの先読みができて、いくらでもバッファに積めます。1秒後どころか1分後に再生すべきであろうデータは全て読み込んでおけるので回線が多少不安定でも並列度を高めてデータ受信することで全く問題ありません。<br>しかし、電話であればそうはいきません。データの安定度を高めるために0.2秒程度のバッファは持ちますが、それ以上のバッファを持ち、遅延させると電話による会話が噛み合わなくなります。現代のリモートワークでも同時に発言してお互い譲り合うというのは見慣れた光景かもしれません。ホームユーザーであれば、リモートワークはもちろん、オンライン授業・コミュニティや友人・家族・親戚とのビデオ通話などが該当するでしょう。こういったビデオ通話ではデータの先読みが殆ど出来ないため、ネットワークの品質とレイテンシが大きく影響します。</p><p>私はオンラインゲームはしませんが、これもビデオ会議と同様でしょう。TCP通信では遅すぎるのでUDP通信でアプリケーション固有のプロトコルでやりとりすることになるでしょうか。私は自宅の環境でパケットロスを認識できるほどの経験はありませんが、回線の太さ以前に、パケット損失が大きく出てしまうプロバイダや回線業者もあるようです。私が10ギガネットワークを使いたいというのは光回線で、通信業者自体が持つバックボーンに（レイテンシが極めて小さい）大型ネットワーク機器が収容されていることを期待しています。さらに言えば、Apple、Googleなどの主要IT、CloudflareやAkamaiなどのCDN（コンテンツ・デリバリ・ネットワーク）、AWSやAzureなどのクラウドサービスにネットワーク的に近い環境が好ましいとも言えます。</p><p>私が利用しているSophos Firewallではレポート機能でビデオ会議のトラフィックを確認できます。</p><img src="/new-technology/2023/01/28/bl3000hm/sophos.png" class="" width="1024" title="alt"><mark class="label primary">Conferencing</mark> でフィルタすると、Teams会議、Zoom会議がクラウドアプリケーションとして判定され、サーバーIPアドレスも列挙されます。<p>実例として、Microsoft365のTeamsのサーバーにpingでレイテンシを計測してみます。</p><img src="/new-technology/2023/01/28/bl3000hm/ping.png" class="" width="1024" title="alt"><p>10分程度、pingの往復レイテンシを計測しています。平均4.6msであり、非常に低レイテンシでスパイクもせいぜい20ms以下ですから安定していると言えます。サーバーIPアドレスをGeo Locationで見ると場所は米国のマイクロソフト社になりますが、レイテンシから鑑みると関東近辺のデータセンターになると思われます。私の感覚的なものですが、米国の西海岸までは純粋なネットワークだけで往復100msのレイテンシ、東海岸までは往復150ms程度はあるはずです。実際のサーバーとの往復だと数百msにはなるようです。</p><p>なお、PCをWi-Fi6接続に変更すると、6.8msとなり、2.2ms遅延が追加されます。</p><h2 id="auひかりのホーム5ギガ、ホーム10ギガの違い"><a href="#auひかりのホーム5ギガ、ホーム10ギガの違い" class="headerlink" title="auひかりのホーム5ギガ、ホーム10ギガの違い"></a>auひかりのホーム5ギガ、ホーム10ギガの違い</h2><p>今回、HGWの交換によって若干のレイテンシ改善は確認できましたが、スループットとして大きく変わるような結果はありません。恐らく地域によって結果は大きく異なると思われます。なお、auひかりの場合は増速の際には事前の調査が必要なようで、混雑している地域だと10ギガへの変更が行えないとの事。ここ2、3年で1ギガを超える光回線の提供も随分浸透してきたと思われるので、時間帯によって帯域制限が加わっているような感覚をお持ちの方は一度確認されてはいかがでしょうか。</p><h2 id="契約変更"><a href="#契約変更" class="headerlink" title="契約変更"></a>契約変更</h2><p>機器交換には3,300円必要とauのホームページには記載がありましたが、以下の案内が事後に郵送されてきました。3,300円の交換に加えて2,000円の交換手数料が掛かるがそれは無料ということなのか、そもそも3,300円ではなく2,000円になるのか、或いは都合良く解釈すれば機器交換は無料なのか。。。また、プロバイダがau one netで10ギガに増速した場合、12ヶ月の間、780円（税込858円）を割り引くとの事です。こちらも次月の請求がわかったところでアップデートしたいと思いますが、そもそもの最初の契約の仕方によって人それぞれで割引プランが異なるのかもしれませんね。<br>（私はプロバイダはau one netでどこのアフェリエイトも通さず、直接auひかりに申し込みしています）</p><img src="/new-technology/2023/01/28/bl3000hm/au.png" class="" width="1024" title="alt"><p>(2023-2-23更新）<br>1月の請求を確認しました。キャンペーンの月額割引は日割りもあり、ピッタリ一致していませんが、計算上は780円の割引になっていました。また、機器交換の請求は現時点でありませんでした。</p><h2 id="補足"><a href="#補足" class="headerlink" title="補足"></a>補足</h2><p>新しいHGWを接続してから、しばらくしてIPv6アドレスが割り当てられていない事に気づきました。結局は翌日の昼頃に特にHGWを再起動したわけでもないですが、IPv6が割り当てられていました。環境変更後、少し時間が掛かるようです。</p>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2023/01/28/bl3000hm/bl3000hm.png&quot; class=&quot;&quot; width=&quot;240&quot; title=&quot;alt&quot;&gt;
&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;

&lt;p&gt;auひかりの新しいホームゲートウェイ（HGW)に交換してみたのでレポートします。ONUと一体型となったモデルです。Wi-Fi6Eにも対応しています。私はauひかりのWi-Fiは契約していないため、Wi-Fi以外の基本性能・機能について紹介します。&lt;/p&gt;</summary>
    
    
    
    <category term="Hardware" scheme="https://yoshi0808.github.io/new-technology/categories/Hardware/"/>
    
    <category term="Network" scheme="https://yoshi0808.github.io/new-technology/categories/Network/"/>
    
    
    <category term="10GbE" scheme="https://yoshi0808.github.io/new-technology/tags/10GbE/"/>
    
  </entry>
  
  <entry>
    <title>UniFi Wi-Fiシステム</title>
    <link href="https://yoshi0808.github.io/new-technology/2022/12/31/unifi-ap/"/>
    <id>https://yoshi0808.github.io/new-technology/2022/12/31/unifi-ap/</id>
    <published>2022-12-30T15:00:01.000Z</published>
    <updated>2023-06-17T23:26:14.393Z</updated>
    
    <content type="html"><![CDATA[<p class="onepoint">この記事で実現すること</p><p>この記事ではホームユーザー向けにUniFi AP(Wi-Fiアクセスポイント）の設定ができるようになることを目的としています。</p><span id="more"></span><h2 id="最近のWi-Fi事情"><a href="#最近のWi-Fi事情" class="headerlink" title="最近のWi-Fi事情"></a>最近のWi-Fi事情</h2><p>2022年9月にWi-Fiで6GHzも利用できるよう法律が変更されました（Wi-Fi6E）。国内のメーカーはこの6GHzとメッシュを謳い文句にWi-Fiルータの販売強化を図っているようです。しかしながら、端末側は今年に発売するiPhoneで6Eの対応が見送られた事であまり盛り上がってはいないようです。</p><p>Wi-Fiの難しいところはその住居の形や家の周りの電波状態に大きく左右されてしまう点で、これがベストという構成を見出せません。私の例で言えば、凡庸な建売の木造2階建であり、無線APが1つだけでも、それなりに無難にWi-Fiが使えるという環境です。</p><p>最近販売され始めた無線ルーターは、メッシュ対応のものが多く出てきました。メッシュは複数台のAPと無線でデータをやり取りできる機能です。無線の中継機は常に親機に集約されていましたが、メッシュは複数台のAPと相互に接続します。一般的には中継専用のSSIDを用いお互いにデータを中継します。</p><p>最近のメッシュWi-Fiルーターでは高速ローミング（802.11k、802.11r、802.11v）に対応している製品も出てきており、端末を持ちながら移動した場合に、アクセスポイント（AP）間を高速ローミングすることで切断時間を短くし、近くのAPに接続できます。また、それぞれのAPがメッシュ（無線）ではなく、有線接続して互いの情報を交換できる<strong>イーサネットバックホール（有線バックホール）</strong>という機能に対応している製品を複数の部屋に設置することでずいぶん快適になるでしょう。</p><p>なお、6EはDFSの影響を受けないチャンネルなので、自宅の間取りで6GHzが効率よく使える環境下であれば利便性は増します。私は6GHzの無線APは保有していないので、どのくらい電波が届くものなのかは今後機会があれば評価してみたいと考えています。周波数が上がるにつれて障害物によって遠くに届きづらくなるとは考えられます。各部屋に有線がなく、イーサネットバックホールが使えないケースでは、AP同士を6Eの独立チャンネルで接続する事で中継機能が改善することが期待されます（これまでは親機と中継機が同一のチャンネルを使うことで効率が大幅に落ちるケースがありました）。</p><p>また、端末側の6E対応状況が進捗するまではしばらくはWi-Fi6（5GHz）のままというのが現状でしょうか。</p><h2 id="UniFi-APのスペック"><a href="#UniFi-APのスペック" class="headerlink" title="UniFi APのスペック"></a>UniFi APのスペック</h2><p>日本国内で販売されているUniFi APはルーター機能を持たず、アクセスポイントに特化したハードウェアです。UniFiネットワークアプリケーションまたはUniFiコンソールを介して情報連携が行われます。</p><table><thead><tr><th>機種</th><th>U6 Pro</th><th>U6 Lite</th></tr></thead><tbody><tr><td>有線</td><td>GbE RJ45ポート x1</td><td>GbE RJ45ポート x1</td></tr><tr><td>給電方法</td><td>PoE</td><td>PoE</td></tr><tr><td>最大消費電力</td><td>13W</td><td>13.5W</td></tr><tr><td>最大送信パワー2.4GHz</td><td>22dBm</td><td>23dBm</td></tr><tr><td>最大送信パワー5GHz</td><td>23dBm※</td><td>23dBm</td></tr><tr><td>MIMO 2.4GHz</td><td>2x2</td><td>2x2</td></tr><tr><td>MIMO 5GHz</td><td>4x4</td><td>2x2</td></tr></tbody></table><p>※U6 Proのスペック上は26dBmが上限ですが、日本国内で利用する場合は上限が23dBmとなります。</p><p>Wi-FiのスペックとしてはU6 Proで日本国内のやや高性能モデルに相当するでしょうか。アンテナ数を見ても、国内のWi-Fi機器と比較して特段優れている項目はありません。U6 Liteも一般的なスペックです。</p><p>上記以外にも、11axに対応した中継機である、U6 Extender、メッシュ接続を前提とした、U6 Meshアクセスポイントなどが販売されています。商品の詳細は日本のオンラインストアを参照してください。</p><blockquote><p>Ubiquiti オンラインストア<br> <a href="https://jp.store.ui.com/collections/unifi-network-wireless">https://jp.store.ui.com/collections/unifi-network-wireless</a></p></blockquote><h2 id="UniFi-APの実速度"><a href="#UniFi-APの実速度" class="headerlink" title="UniFi APの実速度"></a>UniFi APの実速度</h2><p>iPhone11を使ってAPに1mの距離まで近づけて、iperf3を実行した時の結果は以下の通りです。</p><blockquote><p>U6 Pro<br> <img src="/new-technology/2022/12/31/unifi-ap/u6-pro3.png" class="" width="360" title="alt"></p></blockquote><blockquote><p>U6 Lite<br> <img src="/new-technology/2022/12/31/unifi-ap/u6-lite3.png" class="" width="360" title="alt"></p></blockquote><p>参考までに、Aterm WX6000HPの場合は以下です。</p><blockquote><img src="/new-technology/2022/12/31/unifi-ap/aterm.png" class="" width="360" title="alt"></blockquote><p>U6 Proの個性として、iperf3の起動直後は少しスロースタートに見えます。省電力の最適化に重きを置いているのでしょうか。</p><p>また、私の自宅の1階において、macOSのWi-Fi Explorerで電波の強さを計測してみました。1階にはU6 ProとAterm、2階にはU6 Liteが配置されています。</p><img src="/new-technology/2022/12/31/unifi-ap/wifi-explorer.png" class="" width="1024" title="alt"><p>電波の強さだけであればAtermのWX6000HPが素晴らしい結果を出しています。しかしiperf3の最高速度という観点についてはU6 Proの方が良いスコアです。</p><p>pingのレイテンシも見てみましょう。iPhoneからNASへのping応答速度です。iOSやmacOSはpingのレイテンシ数値が高く出てしまう傾向にあります。実は上記のiperf3を含めてL3スイッチ経由でルーティングしてNASのiperf3サーバーに接続しており、1ホップあります。</p><ul><li><p>Aterm pingレイテンシ</p> <img src="/new-technology/2022/12/31/unifi-ap/aterm4.png" class="" width="360" title="alt"></li><li><p>U6 Pro pingレイテンシ</p> <img src="/new-technology/2022/12/31/unifi-ap/u6-pro4.png" class="" width="360" title="alt"></li></ul><blockquote><p>PingPlotterによる計測<br> <a href="https://www.pingman.com/">https://www.pingman.com</a></p></blockquote><p>U6 Proの方が電波の出力は低いものの、レイテンシは15msあたりで上限が整っています。一方、Atermは時々、20msを超えるスパイクが発生しています。U6 Proの速度が出る理由はレイテンシが低い事と想定されます。スマホやノートPCの一般的な操作では100Mbpsを超えたあたりから殆どその差については分からなくなってきますが、リモートワークのビデオ会議の安定性を考えるとレイテンシは意識したいところです。</p><p>UniFi APはWi-Fi設定が非常に詳細まで行えることがメリットであり、電波が届かないなどの対策としての購入用途には向いていません。</p><h2 id="UniFi-APの設置"><a href="#UniFi-APの設置" class="headerlink" title="UniFi APの設置"></a>UniFi APの設置</h2><p>具体的にAPのセットアップの前に一度日本語ガイドのページをご覧になることをお勧めします。<br>これは最近拡充されてきたリソースですが、本来は私がブログで書きたかった、メーカーに依存しない無線LANに必要な知見が整理されており、とても貴重な内容となっています。</p><blockquote><p>UniFi Network - ワイヤレスクライアントの接続性を最適化する<br> <a href="https://help.jp.ui.com/articles/221029967/">https://help.jp.ui.com/articles/221029967/</a></p></blockquote><blockquote><p>UniFi Network - ワイヤレスネットワーク速度の最適化<br> <a href="https://help.jp.ui.com/articles/360012947634/">https://help.jp.ui.com/articles/360012947634/</a></p></blockquote><blockquote><p>UniFi Network - 最適なワイヤレスメッシュネットワークにするための検討事項<br> <a href="https://help.jp.ui.com/articles/115002262328/">https://help.jp.ui.com/articles/115002262328/</a></p></blockquote><p>私もどこかで自分なりの考えをまとめて記事にしたいとは考えています。</p><p>さて、APの設置についてです。</p><p>電源を取るのはPoEアダプタまたはPoEスイッチからというのが独特です。これによってLANケーブルのみでデータ送受信と送電が行え、美観を損ねる事なく、壁の上部にAPを配置し、障害物を避けた効率の良い電波の発信が行えます。Wi-Fiはハードウェアスペックも関係ありますが、こういった物理的な配置も重要です。有線バックホールを使わずにPoEの電力だけを使い、メッシュにすることもできます。この場合、UniFi APは有線接続されている他のUniFi APにメッシュで接続してくれます。</p><p>有線バックホールの一例です。</p><p>（U6 Liteを2階に設置）</p><img src="/new-technology/2022/12/31/unifi-ap/u6-lite.png" class="" width="640" title="alt"><p>コアスイッチから2階のこの部屋までは光で通し、SFP+スイッチ（usw-Aggregation)から1GbEでAPに接続しています。このスイッチにはPoE機能はないため、別途PoEアダプタを使ってAPに給電しています。</p><img src="/new-technology/2022/12/31/unifi-ap/poe.png" class="" width="640" title="alt"><p>PoEアダプタを電源に繋ぎ、LANをusw-AggregationにRJ45で接続し、POEをU6 LiteにRJ45で接続します。</p><p>（私の環境の場合）電波の弱い階段のエリアにまで電波を届かせるために出来るだけ障害物を避けるAPの配置の工夫をしました。階を移動した時にスムーズなローミングができ、ビデオ会議で相手の声がなるべく途切れない事を目的としています。</p><img src="/new-technology/2022/12/31/unifi-ap/u6-lite2.png" class="" width="640" title="alt"><p>2階の各部屋に電波を届けつつ、立体的に見て、壁と2階の床を抜ける箇所を想定し、試行錯誤しながら配置を決めていきます。</p><h2 id="UniFi-Wi-Fi設定"><a href="#UniFi-Wi-Fi設定" class="headerlink" title="UniFi Wi-Fi設定"></a>UniFi Wi-Fi設定</h2><p>ここでは、UniFiコンソールやUniFiネットワークアプリケーションが既にセットアップされている事を前提に説明します。<br>UniFiネットワークアプリケーションを最初からセットアップされる方は以下の記事を参照してください。</p><ul><li>「<a href="/new-technology/2022/08/27/ubiquiti-unifi/" title="Ubiquiti UniFiの世界">Ubiquiti UniFiの世界</a>」</li><li>「<a href="/new-technology/2022/09/23/ubuntu22-04lts/" title="Ubuntu22.04LTSをESXiにセットアップする">Ubuntu22.04LTSをESXiにセットアップする</a>」</li><li>「<a href="/new-technology/2022/09/23/unifi-network-application/" title="UniFi Network Applicationのセットアップ">UniFi Network Applicationのセットアップ</a>」</li><li>「<a href="/new-technology/2022/10/23/unifi-network-application2/" title="UniFi Network Applicationの運用">UniFi Network Applicationの運用</a>」</li></ul><p>ネットワークアプリケーションの<mark class="label primary">SETTINGS</mark>から<mark class="label primary">WiFi</mark>の画面を開くと以下の表示となります。</p><img src="/new-technology/2022/12/31/unifi-ap/wifi1.png" class="" width="640" title="alt"><p>画面上部のWiFiについては、既存のSSID一覧が表示されます。画面下部の<mark class="label primary">Global AP Settings</mark>では、複数台のAPに共通設定を指定します。</p><p>メインとなる5GHzの無線設定では、DFSのこともあり、一般的には80MHzを指定します。日本の製品ではアンテナ数で上り2、下り2として2x2という表現がされている事が多いでしょうか。スマホなど多くは80MHzになります。高性能なWiFiクライアントをお持ちの場合は160MHzも設定可能です（U6 Liteは80MHzが上限です）。</p><mark class="label primary">Transmit Power</mark>は環境に応じて、Auto、High、Medium、Low、Custom（固定数値指定）と設定できます。<p>有線バックホール無しでAPを設置する場合は、<mark class="label primary">Wireless Connectivity</mark>の<mark class="label primary">Wireless Meshing</mark>のチェックボックスをOnにします。私は普段は有線バックホールで運用していますが、U6 Proでは有線LANへ接続せずにメッシュ接続が行えました。</p><p>続いて、SSIDの設定です。</p><img src="/new-technology/2022/12/31/unifi-ap/wifi2.png" class="" width="800" title="alt"><p>SSIDの名前、パスワード、ネットワーク、そのSSIDにどのAPを参加させるかを決めます。ここでは個人向けのWi-Fiとして一般的なWPA2パーソナルまたはWPA3パーソナルを前提としています。</p><p>続いて、マニュアル設定でSSIDの詳細を設定していきます。</p><img src="/new-technology/2022/12/31/unifi-ap/wifi3.png" class="" width="480" title="alt"><img src="/new-technology/2022/12/31/unifi-ap/wifi4.png" class="" width="480" title="alt"><table><thead><tr><th>項目名</th><th>説明</th></tr></thead><tbody><tr><td>WiFi Band</td><td>2.4GHz&#x2F;5GHzを選択します。両方を有効にもできます。</td></tr><tr><td>WiFi Type</td><td>通常はStandardです。カフェのように外部にWiFiを解放する場合はGuest Hotspotを選択します。</td></tr><tr><td>Band Steering</td><td>バンドステアリング。Bandで2.4GHz、5GHzを指定した場合に設定でき、電波状態によって自動で切り替わります。</td></tr><tr><td>Bandwidth Profile</td><td>帯域制限を指定します。</td></tr><tr><td>Multicast Management</td><td>通常必要ありませんので説明は割愛します。</td></tr><tr><td>Client Device Isolation</td><td>クライアントをお互いに接続できないようにします。Guest扱い。</td></tr><tr><td>Proxy ARP</td><td>混雑している環境ではWiFiデバイスの代わりにAPが代理応答します。</td></tr><tr><td>BSS Transition</td><td>AP同士でクライアントの状況を共有します。デフォルト有効。</td></tr><tr><td>UAPSD</td><td>省電力に関するパラメータです。古いデバイスでは問題が出る場合があります。</td></tr><tr><td>Fast Roaming</td><td>Fast Roamingに対応している端末であれば有効にすべきです。逆に言えば、Fast Roamingに対応した端末専用のSSIDにすべきです。</td></tr><tr><td>802.11 DTIM Period</td><td>デフォルト有効。Autoを推奨。説明は割愛します。</td></tr><tr><td>Minimum Data Rate Control</td><td>デフォルト有効。最低通信量を定め、それを下回る場合クライアントにAP切り替えを促すはずですが、私の環境ではあまり有効に機能しません。</td></tr><tr><td>Security Protocol</td><td>WPA2、WPA3の指定をします。WPA Enterpriseを指定することでRADIUS認証（ユーザー認証）が可能です。子供が友達にWi-Fiパスワード共有することに対策したいというこだわりのある方などチャレンジされてはいかがでしょうか。SynologyのNASなどでRADIUSサーバを稼働させられます</td></tr><tr><td>PMF</td><td>保護された管理フレーム。WPA3では必須。WPA2では任意にすることも可能。必須にすると古い端末は繋がらない可能性があリます。</td></tr><tr><td>Group Rekey Interval</td><td>暗号化キーの交換を定期的に行います。デフォルトは3600秒（＝1時間）です。</td></tr><tr><td>Hide WiFi Name</td><td>使うメリットはありません。説明は割愛します。</td></tr><tr><td>MAC Address Filter</td><td>MACアドレスのホワイトリスト、ブラックリストを指定します。</td></tr><tr><td>RADIUS MAC Authentication</td><td>説明は割愛します。</td></tr></tbody></table><p>WiFi Schedulerは夜間など使わない時の時間を設定できます。私は夜間は弱い2.4GHzのみ利用し、日中使っている5GHzは止めています。</p><h2 id="AP単位の設定"><a href="#AP単位の設定" class="headerlink" title="AP単位の設定"></a>AP単位の設定</h2><p>UniFiのDevice画面の<mark class="label primary">Settings</mark>から、AP本体の設定を変更します。主にはIPアドレス、無線のチャンネルを指定します。</p><img src="/new-technology/2022/12/31/unifi-ap/u6-pro5-1.png" class="" width="360" title="alt"><p>５GHzについては、APを2つ設置するならば、メインはDFSを受けないチャンネル、サブは別のチャンネルにするとお互い競合せずに安定した電波の受信ができます。2.4GHzはChannel幅は20MHzとし、1、6、11という具合に５づつスライドさせてAP毎に電波が重ならないように設定します。AP毎に電波の出力も変更できますし、きめ細かい設定が行えるのもUniFi APの特徴です。</p><h3 id="VLAN"><a href="#VLAN" class="headerlink" title="VLAN"></a>VLAN</h3><img src="/new-technology/2022/12/31/unifi-ap/u6-pro5-2.png" class="" width="360" title="alt"><p>このAP自体が属するマネジメント用のVLANを指定します。Wi-Fi設定ではSSID毎にVLANを設定できるので、APに接続するスイッチは、マネジメントVLANを含む全てのVLAN IDを含めるようにトランクポートとして設定する必要があります。</p><p>VLANを使った設定の一例です。</p><p>デバイスの管理をデフォルトVLAN（かつネイティブVLAN）、一般端末をVLAN100、会社用・ゲストをVLAN500とした、よくある一般的なシナリオです。</p><img src="/new-technology/2022/12/31/unifi-ap/network.drawio.png" class="" width="1024" title="alt"><p>UniFIでは複数VLANのペアを作って、そのうちの１つをネイティブVLANとして指定します。この例ではマネジメントVLANをDefault（VLAN ID＝1）、かつ、ネイティブVLAN（タグ無し）としています。会社のPCやゲスト用端末はClient Device IsolationをEnableにして互いの機器の通信を拒否します。スイッチ間のトランクポートは必ず通信するVLAN IDのタグを含めてあげる必要があります。</p><h2 id="APのファームウェア"><a href="#APのファームウェア" class="headerlink" title="APのファームウェア"></a>APのファームウェア</h2><p>UniFi APの最新のOfficialのファームウェアは、ローミングの切り替わりが安定しないように見えますが、現在リリース候補となっている、6.5.40は遅延の少ないローミングが成功しているように見えます。また、Wi-Fi6Eに対応したU6 Enterpriseもいよいよ発売されるようです。</p><h2 id="通知機能"><a href="#通知機能" class="headerlink" title="通知機能"></a>通知機能</h2><p>通知はUniFiコンソールまたはUniFiネットワークアプリケーションの機能ですが、APに関して通知機能は以下の通りです。</p><img src="/new-technology/2022/12/31/unifi-ap/wifi5.png" class="" width="800" title="alt"><p>DFSを受信した時にアラートが受けられるのと、自宅付近に同じSSIDを持つAPを発見した場合通知してくれます。特に後者はセキュリティ上有用です。これは試験的にUniFi以外のAPを同じSSIDで起動して検知させています。</p><img src="/new-technology/2022/12/31/unifi-ap/wifi6.png" class="" width="360" title="alt"><p>通知はメールとスマホアプリと2種類あり、選択できます。<mark class="label primary">Hotspot Client Connection Change</mark>は、端末の接続&#x2F;切断を検知したり、ローミングの切り替わり状況を通知してくれます。家族の自宅への出入りも把握できます。ただし、通知数が多くなるので、メール通知は避け、アプリ通知にした方が良さそうです。本来の趣旨は知らないMACアドレスからの接続があった時に検知するものです。</p><p>これらの機能はハイブリッドクラウド機能を持つUniFi製品の特徴ですが、これらが無償で利用できるというのは本当にありがたい存在です。</p><h2 id="リソース"><a href="#リソース" class="headerlink" title="リソース"></a>リソース</h2><p>以下の日本語ヘルプ、コミュニティがUniFiの構築には大いに参考になります。</p><blockquote><p>Ubiquiti コミュニティ（日本）<br> <a href="https://www.facebook.com/groups/uijapan">https://www.facebook.com/groups/uijapan</a></p></blockquote><blockquote><p>UI 日本語ヘルプ記事<br> <a href="https://help.jp.ui.com/categories/6583256751383/">https://help.jp.ui.com/categories/6583256751383/</a></p></blockquote><blockquote><p>Ubiquiti Community（米国中心）<br> <a href="https://community.ui.com/">https://community.ui.com/</a></p></blockquote>]]></content>
    
    
    <summary type="html">&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;

&lt;p&gt;この記事ではホームユーザー向けにUniFi AP(Wi-Fiアクセスポイント）の設定ができるようになることを目的としています。&lt;/p&gt;</summary>
    
    
    
    <category term="Hardware" scheme="https://yoshi0808.github.io/new-technology/categories/Hardware/"/>
    
    <category term="Network" scheme="https://yoshi0808.github.io/new-technology/categories/Network/"/>
    
    
    <category term="UniFi" scheme="https://yoshi0808.github.io/new-technology/tags/UniFi/"/>
    
  </entry>
  
  <entry>
    <title>Sophos Firewall v19.5</title>
    <link href="https://yoshi0808.github.io/new-technology/2022/12/03/xg-v195/"/>
    <id>https://yoshi0808.github.io/new-technology/2022/12/03/xg-v195/</id>
    <published>2022-12-02T15:01:00.000Z</published>
    <updated>2022-12-11T10:16:39.000Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2022/12/03/xg-v195/title.png" class="" title="alt"><h2 id="Sophos-Firewall-v19-5"><a href="#Sophos-Firewall-v19-5" class="headerlink" title="Sophos Firewall v19.5"></a>Sophos Firewall v19.5</h2><p>Sophos Firewall v19.5が2022年11月16日に発表されました。</p><span id="more"></span><h2 id="主なエンハンスの内容"><a href="#主なエンハンスの内容" class="headerlink" title="主なエンハンスの内容"></a>主なエンハンスの内容</h2><ul><li>SD-WAN Load Balancingの強化</li><li>OSPFv3 (IPv6)の対応</li></ul><p>ホームユーザーにはあまり関係しない機能でしょうか。</p><p>v19.5の詳細な説明はSophos Communityを参照してください。</p><blockquote><p><a href="https://community.sophos.com/sophos-xg-firewall/b/blog/posts/sophos-firewall-v195-is-now-available">https://community.sophos.com/sophos-xg-firewall/b/blog/posts/sophos-firewall-v195-is-now-available</a></p></blockquote><h2 id="Sophos-Firewallのアップデート"><a href="#Sophos-Firewallのアップデート" class="headerlink" title="Sophos Firewallのアップデート"></a>Sophos Firewallのアップデート</h2><p>XGの管理画面にログイン後、左ペインメニューの<mark class="label primary">バックアップ＆ファームウェア</mark>の<mark class="label primary">ファームウェアの確認</mark>ではただちに全てのユーザーにアップデートの案内が来るわけでは無いので、アップデートにはMySophosにログインし、バージョンアップの差分モジュールをダウンロードします。</p><ol><li>Sophosのサイトの右上のプルダウンメニューから、<mark class="label primary">ライセンスとアカウント</mark>をクリックします。<blockquote><p><a href="https://www.sophos.com/ja-jp.aspx">https://www.sophos.com/ja-jp.aspx</a></p></blockquote></li><li>Sophos IDをお持ちでなければIDを作成します。</li><li>ログイン後、<mark class="label primary">Network Protection</mark>をクリックします。</li><li><mark class="label primary">ファームウェアの更新</mark>をクリックします。</li><li>「製品名&#x2F;OSを使った検索」で”ファイアーウォール”を選択し、その後現れるプルダウンは”ソフトウェア”を選択します。</li><li><mark class="label primary">選択可能なダウンロードを表示</mark>ボタンをクリックします。</li></ol><img src="/new-technology/2022/12/03/xg-v195/mysophos.png" class="" width="800" title="alt"><ol><li>上記画面で”SW-19.5.0_GA.SFW-197.sig”というアップデータが表示されますのでダウンロードします。</li><li>MY Sophosはここで終了してXGの管理画面にログインし、左ペインメニューの<mark class="label primary">バックアップ＆ファームウェア</mark>の<mark class="label primary">ファームウェアのタブメニュー</mark>から以下の画面に赤丸で囲った矢印のアイコンをクリックし、ダウンロードしたモジュールをアップロードします。</li></ol><p>アップロード＆再起動ボタンをクリックし、v19.5へのアップグレードを完了させます。</p><div class="note info"><p>仮想環境（ESXi）上にFirewallをインストールされている方はアップグレードの前に、「<a href="/new-technology/2020/10/11/esxi-backup/" title="VMware ESXiの仮想マシンをバックアップする">VMware ESXiの仮想マシンをバックアップする</a>」を参考に、バックアップを確保される事をお勧めします。</p></div><p>Relase Notesを見るとセキュリティ観点ではOpenSSL (CVE-2022-1292)の脆弱性対応が行われています。他にもかなりの数の不具合が修正されていますが、コメントがサラッとしており、どういう事象なのかまでは判明しないものが多いようです。</p><p>IPSec-VPN、SSL&#x2F;TLSインスペクション、マルウェアチェック（EICAR Testファイル）などを検証し、2週間程度運用していますが、スループット含めて特段の問題は見つかっていません。</p><p>（2022-12-11追記）<br>SophosからSophos Firewallのv19以前の脆弱性について12-06にレポートが公開されています。<br>以下の脆弱性に対応したものであり、v19以前のユーザーはv19.5にアップグレードが必要との事です。<br>CVE-2022-3236<br>CVE-2022-3226<br>CVE-2022-3713<br>CVE-2022-3696<br>CVE-2022-3709<br>CVE-2022-3711<br>CVE-2022-3710</p><blockquote><p>Sophos Firewall v19.5 GA Resolves Security Vulnerabilities<br> <a href="https://www.sophos.com/en-us/security-advisories/sophos-sa-20221201-sfos-19-5-0">https://www.sophos.com/en-us/security-advisories/sophos-sa-20221201-sfos-19-5-0</a></p></blockquote><p>大幅に機能が更新されていないにも関わらず、v19からv19.5となり、リリースノートでの表現も控え目で何が変わったのか良くわかりませんでしたが結局のところ脆弱性の対応が中心ということですね。</p><p>私は「<a href="/new-technology/2020/06/24/protect-xg/" title="XG Firewall自身を防御する">XG Firewall自身を防御する</a>」の記事で、そもそもFirewall自身を守るためのセキュアな設定が必要と記載しており、パッチやバージョンアップを速やかに実施することも必要ですが、セキュアな環境のために追加の設定をお勧めしています。</p><p>過去からの経緯を見ていると、v18で大きくアーキテクチャが変更になったものの、管理画面を中心とした機能は大きな変更が行われていません。過去からの脆弱性、特にUI周りのクロスサイトスクリプティング、およびDBアクセス機能におけるSQLインジェクションのサニタイズが不十分であり、指摘されては都度修正しているという活動を繰り返しているように見えます。<br>ユーザー側の自主的な防御として、余計な機能はインターネット向けには提供しない事をお勧めします。つまりSophos Firewallの管理画面や入力項目を持つユーザーポータルはLANからのアクセスのみに限定すべきで、WAN、DMZはもちろん、可能であればVPNからもアクセス不可にしておく事をお勧めします。今回のエンハンスでSQLインジェクションなどが全て撲滅されたかどうかは不明です。</p><img src="/new-technology/2022/12/03/xg-v195/manage.png" class="" width="1024" title="alt">]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2022/12/03/xg-v195/title.png&quot; class=&quot;&quot; title=&quot;alt&quot;&gt;

&lt;h2 id=&quot;Sophos-Firewall-v19-5&quot;&gt;&lt;a href=&quot;#Sophos-Firewall-v19-5&quot; class=&quot;headerlink&quot; title=&quot;Sophos Firewall v19.5&quot;&gt;&lt;/a&gt;Sophos Firewall v19.5&lt;/h2&gt;&lt;p&gt;Sophos Firewall v19.5が2022年11月16日に発表されました。&lt;/p&gt;</summary>
    
    
    
    <category term="Security" scheme="https://yoshi0808.github.io/new-technology/categories/Security/"/>
    
    
    <category term="XG Firewall" scheme="https://yoshi0808.github.io/new-technology/tags/XG-Firewall/"/>
    
  </entry>
  
  <entry>
    <title>UniFiスイッチ</title>
    <link href="https://yoshi0808.github.io/new-technology/2022/11/23/unifi-switch/"/>
    <id>https://yoshi0808.github.io/new-technology/2022/11/23/unifi-switch/</id>
    <published>2022-11-22T15:00:00.000Z</published>
    <updated>2023-06-05T10:30:51.488Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2022/11/23/unifi-switch/title.png" class="" width="1024" title="alt"><p class="onepoint">この記事で実現すること</p><p>この記事ではホームユーザー向けにUniFiスイッチの設定ができるようになることを目的としています。</p><span id="more"></span><h2 id="UniFiスイッチの特徴"><a href="#UniFiスイッチの特徴" class="headerlink" title="UniFiスイッチの特徴"></a>UniFiスイッチの特徴</h2><p>UniFiネットワークスイッチの特徴としては、どちらかといえばスモールビジネス向けの製品が中心ではあります。<br>スモールオフィスの基幹ネットワークを構成しながら、監視カメラやWi-Fiシステムを導入し、トータルソリューションが売りになります。<br>ネットワークスイッチ単独の機能として見ると、以下の特徴があります。</p><ol><li>Wi-FiにRJ45ケーブルで通信と電力出力を兼ねるPoE</li><li>SFP＋などの10GbEネットワーク</li><li>UniFiネットワークアプリケーションによる集中管理</li></ol><p>ホームユーザー向けとして自宅内のネットワークを10GbEかつSFP+を選択する場合は、いくつかの魅力的なネットワークスイッチが候補に上がります。<br>発熱対策のために各部屋にSFP+でOM3などの光ケーブルを通す場合は、個人向けのネットワークスイッチではPortが不足してしまうのが実態です。<br>機器の価格帯が個人向け、かつ消去法でいくとMikroTikかUniFiが選択肢に上がります。円安で昔ほどは安いと思えなくなりましたが、SFP+スイッチは廉価です。</p><h2 id="基本設定"><a href="#基本設定" class="headerlink" title="基本設定"></a>基本設定</h2><p>基本設定です。UniFiスイッチを新規導入する際には、ネットワークアプリケーションに登録（採用）する必要があります。初期セットアップについては、以下の記事を参照してください。UniFi製品群の標準の考え方ではセキュリティゲートウェイをインターネットルーターの役割として配置し、そこに各UniFi製品群をぶら下げることになります。私はSophos Firewallを利用しており、UniFiセキュリティゲートウェイは不要としているため、集中管理のためのUniFiネットワークアプリケーションを導入しています。</p><ul><li><a href="/new-technology/2022/08/27/ubiquiti-unifi/" title="Ubiquiti UniFiの世界">Ubiquiti UniFiの世界</a></li><li><a href="/new-technology/2022/09/23/unifi-network-application/" title="UniFi Network Applicationのセットアップ">UniFi Network Applicationのセットアップ</a></li><li><a href="/new-technology/2022/10/23/unifi-network-application2/" title="UniFi Network Applicationの運用">UniFi Network Applicationの運用</a></li></ul><p>UniFiスイッチが採用（Adoption）されると、ネットワークアプリケーションから管理できるようになります。</p><p>スイッチ毎の<mark class="label primary">Settings</mark>では、<mark class="label primary">Service</mark>で基本設定を、<mark class="label primary">Network</mark>でIPアドレスを設定できます。</p><img src="/new-technology/2022/11/23/unifi-switch/netapp2.png" class="" width="360" title="alt"><mark class="label primary">Service</mark>では、スイッチ自身がどのネットワーク（VLAN）に属するのかを決め、Flow ControlやJumbo Frameの設定が可能です。デフォルトでFlow ControlはOffです。ネットワーク速度が異なる端末を接続する場合は、Flow ControlはOnの方が良いでしょう。もちろん、送信側端末のネットワークカードがFlow Controlに対応している必要はあります。最近、UniFiネットワークアプリケーションではスイッチのGlobalSettingが可能となり、スイッチ毎にこれらの設定が不要になっています。<img src="/new-technology/2022/11/23/unifi-switch/netapp3.png" class="" width="360" title="alt"><mark class="label primary">Network</mark>では、静的IPアドレスを設定することもできます。<p>その他、<mark class="label primary">Settings</mark>からは、スイッチの再起動が可能です。</p><h2 id="スイッチポート確認"><a href="#スイッチポート確認" class="headerlink" title="スイッチポート確認"></a>スイッチポート確認</h2><p>スイッチ毎の<mark class="label primary">Ports</mark>からはPortの稼働状況が確認できます。</p><img src="/new-technology/2022/11/23/unifi-switch/netapp4.png" class="" width="360" title="alt"><table><thead><tr><th>項目名</th><th>内容</th></tr></thead><tbody><tr><td>Status</td><td>実際に接続されている速度を示します。稀にファームウェアのアップデートのタイミングで誤った認識になる場合があります</td></tr><tr><td>Tx&#x2F;Rx</td><td>送信(Tx)、受信(Rx)量を示します</td></tr><tr><td>Profile</td><td>UniFiのVLANは複数のネットワークを指定した上で纏めたトランクポートを複数種類作成可能です。ネットワークアプリケーション7.4からは仮想ネットワークバインディングという概念があり、このProfileは使わなくても済むようになりました（もちろん使っても構いません）。</td></tr><tr><td>Uplink</td><td>上流の機器を示します。UniFiがInternetへのルーティングを解析し、Internet接続ルーターを上流として自動的にUplinkポートを判別します</td></tr></tbody></table><p>その他、SFPモジュールの情報などが出力されています。</p><h2 id="スイッチポート設定"><a href="#スイッチポート設定" class="headerlink" title="スイッチポート設定"></a>スイッチポート設定</h2><p>スイッチ毎の<mark class="label primary">Ports</mark>からさらに<mark class="label primary">Port Management</mark>を選択すると、個々のPortの設定を行えます。</p><img src="/new-technology/2022/11/23/unifi-switch/netapp5.png" class="" width="1024" title="alt"><p>これはPro-Aggregationの例ですが、Portごとに接続されているクライアントが表示されています。ここで個別のPortを選択すると、ポートの速度やVLANを設定できます。</p><h3 id="Portの設定変更"><a href="#Portの設定変更" class="headerlink" title="Portの設定変更"></a>Portの設定変更</h3><p>Portの物理的な設定変更は以下の<mark class="label primary">Port Profile Override</mark>から行います。</p><img src="/new-technology/2022/11/23/unifi-switch/netapp7.png" class="" width="360" title="alt"><table><thead><tr><th>項目名</th><th>内容</th></tr></thead><tbody><tr><td>Operation</td><td>Switching または、Aggregate（複数のPortを束ねて帯域を増やす）、Mirrorを選択します。</td></tr><tr><td>Link Speed</td><td>オートネゴ、10Gbps、2.5Gbpsなどの速度固定を選択します。なお、2.5Gはオートネゴでは動作しません</td></tr><tr><td>Port Isolation</td><td>Uplinkポートのみトラフィックを転送します</td></tr><tr><td>Storm Control</td><td>ブロードキャスト、マルチキャストなどの飽和を某防止します</td></tr><tr><td>LLDP</td><td>ディスカバリプロトコルを有効にします（デフォルトON）</td></tr><tr><td>Spanning Tree Protocol</td><td>スパニングツリーを有効にします（デフォルトON）</td></tr></tbody></table><p>ミラーPortはトラブル時の確認のために使います。トラブルのあるPort番号を指定し、ミラーに設定することで同じデータが流れます。ノートPCなどを接続し、WireSharkなどを使いパケット解析します。</p><p>SFP+の製品であっても、USW-AggregationスイッチやUSW-Enterprise-8-PoEのSFP+ポートは2.5GbEに対応していません。過去記事「<a href="/new-technology/2022/07/30/sfp-plus-nbaset/" title="SFP+の2.5GbE対応">SFP+の2.5GbE対応</a>」で書いたように、10GbEを2.5GbEとして偽装させる特殊なSFP+モジュールが必要になります（もっとも、USW-Enterprise-8-PoEは2.5GbEのRJ45ポートを備えているので運用上困ることはありませんが）。</p><h2 id="VLANを設定"><a href="#VLANを設定" class="headerlink" title="VLANを設定"></a>VLANを設定</h2><p>VLANを作成するにはネットワークアプリケーションの<mark class="label primary">SETTINGS</mark>から<mark class="label primary">NETWORKS</mark>を選択し、<mark class="label primary">Create New Network</mark>をクリックします。</p><p>L3スイッチではなく、単にVLANを作成したい場合は、ここで<mark class="label primary">VLAN-only Network</mark>のチェックボックスをONにし、VLAN IDを決定します。</p><img src="/new-technology/2022/11/23/unifi-switch/netapp8.png" class="" width="360" title="alt"><p>こういったネットワーク構成全般の変更を行うと、全てのスイッチに対してコンフィグの転送が行われ、スイッチの再構成が実行されます。</p><p>トランクポートとして使う場合は２つの方法があります。</p><ol><li>仮想ネットワークバインディングで許可するVLANまたはブロックするVLANを指定します。</li><li>予め作成した複数のネットワークを束ねたProfileを作成した上でそれを指定します。</li></ol><h3 id="仮想ネットワークバインディングを使う方法"><a href="#仮想ネットワークバインディングを使う方法" class="headerlink" title="仮想ネットワークバインディングを使う方法"></a>仮想ネットワークバインディングを使う方法</h3><p>ネットワークアプリケーションv7.4から導入された仮想ネットワークバインディングは、従前のように、トランクポートのネットワークの組み合わせをわざわざProfileで作成しなくて済むというメリットがあります。</p><img src="/new-technology/2022/11/23/unifi-switch/netapp10.png" class="" width="1024" title="alt"><p>タグなしのメインのネットワーク（ネイティブVLAN）を決めた上で、タグ付きのVLANについては、許可する、ブロックするの分類を指定します。ファイアウォールのように許可かブロックかを選択するというものではなく、ネイティブVLAN以外のタグ付きVLANを全て列挙し、許可またはブロックの何れかに分類するという方が近いでしょう。</p><p>仮想ネットワークバインディングで<mark class="label primary">該当なし</mark>を選択すると、そのポートには全てのデータが流れることになるようです。Switch Flex MiniのようにProfileを割り当てできない小型スイッチではこの該当なしを選択してアップリンクのスイッチからタグ無し、タグ有りのパケットをそのまま送受信する事になります。</p><h3 id="従来からのProfileを使う方法"><a href="#従来からのProfileを使う方法" class="headerlink" title="従来からのProfileを使う方法"></a>従来からのProfileを使う方法</h3><p>Profile作成時には指定する複数のネットワークのうちどれか1つをネイティブVLANとしてタグ無しに設定します。昨今、デフォルトVLANを変えることがセキュリティ上優位であるとも思えないので、私は管理用VLANは無条件にデフォルトVLAN（VLAN ID&#x3D;1）で管理するようにしています。</p><p>Profileを使う方式では、このようにネイティブVLANがどのネットワークか定め、タグ付きのVLANを追加で選択していきます。</p><img src="/new-technology/2022/11/23/unifi-switch/netapp6.png" class="" width="1024" title="alt"><p>Profileを作成後、スイッチポートの設定にて、<mark class="label primary">イーサネットポートプロファイル</mark>のチェックボックスをオンにしてリストボックスからProfileを指定します。</p><img src="/new-technology/2022/11/23/unifi-switch/netapp11.png" class="" width="480" title="alt"><p>この例では、 UniFi-APはデフォルトVLANで接続し、AP同士の制御用パケットは全てデフォルトVLAN配下に流れます。また、タグ付きネットワークでVLAN-XXX（一般端末向け）とGuestがありますが、UniFi-APは複数のネットワークに属することができますので1つのAPで複数のネットワークに対してWi-Fiサービス提供できるようになります。</p><p>ネットワーク機器のLANをデフォルトVLAN、かつ、ネイティブVLAN（タグ無し）としているのは何らかのトラブル時に復旧させやすいという点もあります。</p><h2 id="SSH"><a href="#SSH" class="headerlink" title="SSH"></a>SSH</h2><p>UniFiスイッチは廉価なSwitch Flex Miniを除き、大半のスイッチはSSH接続が可能です。ネットワークアプリケーションで設定したID&#x2F;パスワードでも接続できますし、公開鍵認証でも接続可能です。スイッチにSSHすると Linuxのインタフェースのように見えます。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">$ ssh xxx</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BusyBox v1.25.1 () built-in shell (ash)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  ___ ___      .__________.__</span><br><span class="line"> |   |   |____ |__\_  ____/__|</span><br><span class="line"> |   |   /    \|  ||  __) |  |   (c) 2010-2022</span><br><span class="line"> |   |  |   |  \  ||  \   |  |   Ubiquiti Inc.</span><br><span class="line"> |______|___|  /__||__/   |__|</span><br><span class="line">            |_/                  https://www.ui.com</span><br><span class="line"></span><br><span class="line">      Welcome to UniFi USW-Aggregation!</span><br><span class="line"></span><br><span class="line">********************************* NOTICE **********************************</span><br><span class="line">* By logging <span class="keyword">in</span> to, accessing, or using any Ubiquiti product, you are     *</span><br><span class="line">* signifying that you have <span class="built_in">read</span> our Terms of Service (ToS) and End User   *</span><br><span class="line">* License Agreement (EULA), understand their terms, and agree to be       *</span><br><span class="line">* fully bound to them. The use of SSH (Secure Shell) can potentially      *</span><br><span class="line">* harm Ubiquiti devices and result <span class="keyword">in</span> lost access to them and their data. *</span><br><span class="line">* By proceeding, you acknowledge that the use of SSH to modify device(s)  *</span><br><span class="line">* outside of their normal operational scope, or <span class="keyword">in</span> any manner             *</span><br><span class="line">* inconsistent with the ToS or EULA, will permanently and irrevocably     *</span><br><span class="line">* void any applicable warranty.                                           *</span><br><span class="line">***************************************************************************</span><br><span class="line"></span><br><span class="line">USW-Aggregation-US.6.3.13<span class="comment"># cd /var/log</span></span><br><span class="line">USW-Aggregation-US.6.3.13<span class="comment"># vi messages</span></span><br><span class="line">USW-Aggregation-US.6.3.13<span class="comment"># ping 192.168.x.100</span></span><br><span class="line">PING 192.168.x.100 (192.168.x.100): 56 data bytes</span><br><span class="line">64 bytes from 192.168.x.100: <span class="built_in">seq</span>=0 ttl=64 time=0.000 ms</span><br><span class="line">64 bytes from 192.168.x.100: <span class="built_in">seq</span>=1 ttl=64 time=10.000 ms</span><br><span class="line">64 bytes from 192.168.x.100: <span class="built_in">seq</span>=2 ttl=64 time=10.001 ms</span><br><span class="line">64 bytes from 192.168.x.100: <span class="built_in">seq</span>=3 ttl=64 time=10.000 ms</span><br><span class="line">64 bytes from 192.168.x.100: <span class="built_in">seq</span>=4 ttl=64 time=10.001 ms</span><br></pre></td></tr></table></figure><p><code> /var/log/messages</code>にはsyslogがありますので、たまには中身を確認されることをお勧めします（viコマンドなどで開きます）。表向き、SFPモジュールが動作しているように見えても、互換性の問題でエラーを吐いている場合もあります。ダイレクトアタッチケーブルなどを対向の端末を繋がずスイッチに接続している場合など定期的にLinkDownのアラートが出ている場合もあります。RJ45とは動きは異なります。</p><p>上記はUSW-Aggregationに接続した状態ですが、pingも動作しますが、レスポンスは悪いです。LAN内の機器の応答に10ms掛かっていますが驚かないでください。スイッチのデータ転送は専用チップ（ASIC）が行うため、機器のCPUがスイッチの実力にはなりません。OSに割り当てるCPUリソースの関係でしょうか、このpingの応答速度は「ご参考」として割り切った方が良さそうです。</p><h3 id="スイッチの詳細情報について"><a href="#スイッチの詳細情報について" class="headerlink" title="スイッチの詳細情報について"></a>スイッチの詳細情報について</h3><p>Linuxのコンソールから、<code>cli</code>コマンドを投入することで、Ciscoライクなスイッチのコマンドモードに入ることができます。<br>コマンド入力途中でタブを押下するとコマンドが補完されます。<br><code>show  running-config</code>などそのまま使えます。<code>copy running-config startup-config</code>なども実行できそうですが、UniFiではネットワークアプリケーションから完全同期されていることが大前提であり、コマンドモードで設定しても再起動時にはネットワークアプリケーションから上書きされてしまいます。<br>ややこしいのは、スイッチ毎にコマンドの互換性が殆どないことです。コマンドの途中で<code>&quot;？&quot;</code>を入力すると、実行できるパラメータが列挙されるので推測でコマンドを補完しながら入力することになります。私の知る限り、機種毎のコマンドラインのマニュアルは存在しないようです。</p><h3 id="USW-Pro-Aggregation-L3スイッチ"><a href="#USW-Pro-Aggregation-L3スイッチ" class="headerlink" title="USW-Pro-Aggregation(L3スイッチ)"></a>USW-Pro-Aggregation(L3スイッチ)</h3><p>このスイッチは比較的コマンドが充実しています。<code>cli</code>でコマンドモードに入り、<code>en</code>で特権モードに入ります。<br>Portの状況を見るには以下のコマンドを使います。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(UBNT) #show interface ethernet 0/x</span><br></pre></td></tr></table></figure><p>これだと100行余りの結果が表示されるのでパイプ（｜）で区切り、必要な項目だけフィルタできます。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">(UBNT) #show interface ethernet 0/x | include Error|Collision|Discard</span><br><span class="line"></span><br><span class="line">Total Packets Received Without Errors.......... 43388669</span><br><span class="line">Receive Packets Discarded...................... 0</span><br><span class="line">Total Packets Received with MAC Errors......... 0</span><br><span class="line">Alignment Errors Received...................... 0</span><br><span class="line">FCS Errors Received............................ 0</span><br><span class="line">URPF Discards.................................. 0</span><br><span class="line">Transmit Packets Discarded..................... 0</span><br><span class="line">Total Transmit Errors.......................... 0</span><br><span class="line">FCS Errors Transmitted......................... 0</span><br><span class="line">Total Transmit Packets Discarded............... 0</span><br><span class="line">Single Collision Frames........................ 0</span><br><span class="line">Multiple Collision Frames...................... 0</span><br><span class="line">Excessive Collision Frames..................... 0</span><br><span class="line"></span><br><span class="line">(UBNT) #</span><br></pre></td></tr></table></figure><p>このようにして重要な情報のみ取得できます。あくまで一般的なパラメータとしていますが、現代の全二重の通信前提であればCollisionまで見る必要はないですね。一般的にはReceiveでエラーがあるときはケーブルを最初に疑ってみること、Transmit Packets Discardedの場合はVLANの設定が間違っている可能性があることでしょうか。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clear counters all</span><br></pre></td></tr></table></figure><p>カウンタをクリアします。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show fiber-ports optics-info all</span><br></pre></td></tr></table></figure><p>モジュールのメーカーやシリアル番号を表示します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">(UBNT) #show fiber-ports optics all</span><br><span class="line"></span><br><span class="line">                                                 Output   Input</span><br><span class="line">Port    Physical Port/  Temp  Voltage  Current   Power    Power     TX     LOS</span><br><span class="line">        Lane Number     [C]   [Volt]     [mA]    [dBm]    [dBm]     Fault</span><br><span class="line">------  --------------  ----  -------  -------   -------  -------   -----  ---</span><br><span class="line">0/4     0/4-Lane1       34.2    3.328     10.2    -3.370   -2.496   No     No</span><br><span class="line">0/5     0/5-Lane1       34.5    3.265     10.4    -2.976   -3.373   No     No</span><br><span class="line">0/8     0/8-Lane1       34.0    3.360     10.2    -3.799   -1.643   No     No</span><br><span class="line">0/9     0/9-Lane1        N/A      N/A      N/A       N/A      N/A   N/A    N/A</span><br><span class="line">0/12    0/12-Lane1       N/A      N/A      N/A       N/A      N/A   N/A    N/A</span><br><span class="line">0/15    0/15-Lane1       N/A      N/A      N/A       N/A      N/A   N/A    N/A</span><br><span class="line">0/18    0/18-Lane1       N/A      N/A      N/A       N/A      N/A   N/A    N/A</span><br><span class="line">0/19    0/19-Lane1       N/A      N/A      N/A       N/A      N/A   N/A    N/A</span><br><span class="line">0/22    0/22-Lane1       N/A      N/A      N/A       N/A      N/A   N/A    N/A</span><br><span class="line">0/26    0/26-Lane1      33.3    3.235      6.0    -3.002   -3.002   No     No</span><br><span class="line"></span><br><span class="line"> Temp - Internally measured transceiver temperatures.</span><br><span class="line"> Voltage - Internally measured supply voltage.</span><br><span class="line"> Current - Measured TX bias current.</span><br><span class="line"> Output Power - Measured optical output power relative to 1mW.</span><br><span class="line"> Input Power - Measured optical power received relative to 1mW.</span><br><span class="line"> TX Fault - Transmitter fault.</span><br><span class="line"> LOS - Loss of signal.</span><br><span class="line"></span><br><span class="line">(UBNT) #</span><br></pre></td></tr></table></figure><p>モジュールのDDM（温度、光の強さ）を表示します。</p><h3 id="USW-Aggregation-SFP-8Port"><a href="#USW-Aggregation-SFP-8Port" class="headerlink" title="USW-Aggregation(SFP+ 8Port)"></a>USW-Aggregation(SFP+ 8Port)</h3><p>このスイッチは<code>cli</code>でコマンドモードに入ったら、すぐに大半のコマンドが実行できます。代表的なのは以下のものです。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show interfaces TenGigabitEthernet x</span><br></pre></td></tr></table></figure><p>Port xのPort状況を表示します。パケットカウントやコリジョンなどの数を示します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clear interfaces TenGigabitEthernet  x counters</span><br></pre></td></tr></table></figure><p>Port xのカウンタをクリアします。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show fiber-transceiver-info interfaces  TenGigabitEthernet  x</span><br></pre></td></tr></table></figure><p>SFPモジュールの種類やシリアル番号を表示します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show fiber-transceiver interfaces  TenGigabitEthernet x</span><br></pre></td></tr></table></figure><p>SFPモジュールのDDM（信号の強さ、温度）を示します。</p><h2 id="L3スイッチの制約"><a href="#L3スイッチの制約" class="headerlink" title="L3スイッチの制約"></a>L3スイッチの制約</h2><p>UniFiのL3スイッチはDHCP機能を持ちますが、管理機能やルーティングについてはIPv6には対応していません。スイッチ自身はIPv6アドレスを持てるようですが、現段階でIPv6のL3ルーティングできるようにはなっていません。別のルーターでDHCPv6を割り当て、そちらをゲートウェイにするなどが必要です。L2スイッチを含めてIPv6通信が行えないということではありません。</p><h2 id="SFPモジュール"><a href="#SFPモジュール" class="headerlink" title="SFPモジュール"></a>SFPモジュール</h2><p>Ubiquitiのモジュール群は廉価なため、光モジュールは純正が間違いないでしょう。OM3ケーブルやDACはさまざまなメーカーのものを使いましたが、UniFi製品で問題が発生したことはありません。RJ45モジュールは特に10GbEのものは低電力を踏まえるとSFPメーカーの製品の選定も視野に入ります。</p><img src="/new-technology/2022/11/23/unifi-switch/module.png" class="" width="640" title="alt"><p>1GbE tp-link TL-SM331<br>一般的なMarvell社88E1111などを使ったモジュールが通常使用（Typical）で1.05Wの消費電力なのに対し、その半分以下の0.5Wとなっており、発熱もかなり抑えられています。最近、国内でも発売になったようですが、私は今年の5月に米Amazonで$19.99で購入し、問題なく使えています。</p><blockquote><p>tp-link<br> <a href="https://www.tp-link.com/jp/service-provider/switch-accessory/tl-sm331t/">https://www.tp-link.com/jp/service-provider/switch-accessory/tl-sm331t/</a></p></blockquote><p>10GbE Fiber mall SFP-10G-T-UB-80m<br>80mまで対応した省電力の10GbEモジュールです。こちらも米Amazonで購入しました。＄68.99でした。BroadcomのBCM84891のチップを採用している80mに対応したモジュールはいくつか存在します。Cisco用のモジュール（SFP-10G-TS80）についてはメーカーの公表ではDDMに対応していないと記載があるものの、UniFiスイッチ上では、モジュールの温度などのパラメータが出力されています。</p><blockquote><p>Fiber mall<br> <a href="https://www.fibermall.com/ja/news/10g-copper-sfp.htm">https://www.fibermall.com/ja/news/10g-copper-sfp.htm</a></p></blockquote><p>英語ですが、ぜひAmazonのカスタマーレビューを見てください。より詳細で素晴らしい知見に基づいたコメントが見られます。</p><blockquote><p>米Amazon Customer Review<br> <a href="https://www.amazon.com/gp/customer-reviews/RLHW2OL4I1QZP/ref=cm_cr_dp_d_rvw_ttl?ie=UTF8&amp;ASIN=B0B18BY1XK">https://www.amazon.com/gp/customer-reviews/RLHW2OL4I1QZP/ref=cm_cr_dp_d_rvw_ttl?ie=UTF8&amp;ASIN=B0B18BY1XK</a></p></blockquote><h2 id="PoE"><a href="#PoE" class="headerlink" title="PoE"></a>PoE</h2><p>スイッチにおけるPoEもネットワークアプリケーションから設定できます。USW-Enterprise-8-PoEの例では、Switch Flex MiniおよびAPのU6 Proに給電している状況が確認できます。</p><img src="/new-technology/2022/11/23/unifi-switch/netapp9.png" class="" width="640" title="alt"><p>Port ManagementからPoEのOn&#x2F;Offが可能となっています。</p><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>これらのように、ネットワークスイッチをただ単に繋げるための道具ではなく、ITやネットワークを見える化するという目的においては非常に有用な機器になります。セキュリティ観点ではできることは限られていますが、ホームユーザーにとっても有用な機能は活用できると思われます。</p><p>Ubiquiti 日本語ガイドのスイッチに関する記事は以下が参考になります。</p><blockquote><p>UniFi Network - 有線ネットワーク速度の最適化<br> <a href="https://help.jp.ui.com/articles/6949005136919/">https://help.jp.ui.com/articles/6949005136919/</a></p></blockquote><h2 id="リソース"><a href="#リソース" class="headerlink" title="リソース"></a>リソース</h2><p>以下の日本語ヘルプ、コミュニティがUniFiの構築には大いに参考になります。</p><blockquote><p>Ubiquiti コミュニティ（日本）<br> <a href="https://www.facebook.com/groups/uijapan">https://www.facebook.com/groups/uijapan</a></p></blockquote><blockquote><p>UI 日本語ヘルプ記事<br> <a href="https://help.jp.ui.com/categories/6583256751383/">https://help.jp.ui.com/categories/6583256751383/</a></p></blockquote><blockquote><p>Ubiquiti Community（米国中心）<br> <a href="https://community.ui.com/">https://community.ui.com/</a></p></blockquote>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2022/11/23/unifi-switch/title.png&quot; class=&quot;&quot; width=&quot;1024&quot; title=&quot;alt&quot;&gt;
&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;

&lt;p&gt;この記事ではホームユーザー向けにUniFiスイッチの設定ができるようになることを目的としています。&lt;/p&gt;</summary>
    
    
    
    <category term="Hardware" scheme="https://yoshi0808.github.io/new-technology/categories/Hardware/"/>
    
    <category term="Network" scheme="https://yoshi0808.github.io/new-technology/categories/Network/"/>
    
    
    <category term="SFP+" scheme="https://yoshi0808.github.io/new-technology/tags/SFP/"/>
    
    <category term="10GbE" scheme="https://yoshi0808.github.io/new-technology/tags/10GbE/"/>
    
    <category term="UniFi" scheme="https://yoshi0808.github.io/new-technology/tags/UniFi/"/>
    
  </entry>
  
  <entry>
    <title>UniFi Network Applicationの運用</title>
    <link href="https://yoshi0808.github.io/new-technology/2022/10/23/unifi-network-application2/"/>
    <id>https://yoshi0808.github.io/new-technology/2022/10/23/unifi-network-application2/</id>
    <published>2022-10-23T01:38:49.000Z</published>
    <updated>2023-06-03T01:53:08.442Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2022/10/23/unifi-network-application2/unifi1.png" class="" width="1024" title="alt"><p class="onepoint">この記事で実現すること</p><p>前回記事「<a href="/new-technology/2022/09/23/unifi-network-application/" title="UniFi Network Applicationのセットアップ">UniFi Network Applicationのセットアップ</a>」では、UniFi Network ApplicationをUbuntu上にセットアップし、UniFiネットワーク製品の登録（Adoption）までを行いました。この記事ではホームユーザーがUniFi製品を運用していくにあたり、必要な操作ができるようになることを目的としています。</p><span id="more"></span><h2 id="日本語ガイド"><a href="#日本語ガイド" class="headerlink" title="日本語ガイド"></a>日本語ガイド</h2><p>セットアップが完了し、運用開始するにあたり、日本の公式のガイドとして以下のリソースがあります。</p><blockquote><p>UniFi - アップデート<br> <a href="https://help.jp.ui.com/articles/7605005245975/">https://help.jp.ui.com/articles/7605005245975/</a></p></blockquote><blockquote><p>接続の課題などのFAQ<br> <a href="https://help.jp.ui.com/articles/7258465146519/">https://help.jp.ui.com/articles/7258465146519/</a></p></blockquote><h2 id="UniFiデバイス一覧およびアップデート"><a href="#UniFiデバイス一覧およびアップデート" class="headerlink" title="UniFiデバイス一覧およびアップデート"></a>UniFiデバイス一覧およびアップデート</h2><p><code>https://UniFi Network Application Host:8443/</code>に接続すると左にカテゴリのアイコンが並びます。以下のように左の赤枠で囲った<mark class="label primary">UNIFI DEVICES</mark>一覧では現在のAdoptされているUniFi機器の一覧が確認できます。</p><img src="/new-technology/2022/10/23/unifi-network-application2/u1.png" class="" width="1024" title="alt"><p>バージョンアップの通知があれば、ここで<mark class="label primary">Click to Update</mark>のように表示されますので、これをクリックしてデバイスのアップデートが行えます。<br>リリースの情報については本国のCommunityを参照することになります。</p><blockquote><p>UniFi リリース一覧<br> <a href="https://community.ui.com/releases/">https://community.ui.com/releases/</a></p></blockquote><img src="/new-technology/2022/10/23/unifi-network-application2/rel.png" class="" width="1024" title="alt"><p>ここでは、<mark class="label primary">Official</mark>または<mark class="label primary">Release Candidate(リリース候補）</mark>と区分されています。Network Applicationの初期設定では、Officialのものが自動的にアップデートされる仕組みになっています。後に説明する設定画面で、Official,Release Candidate,Early Accessと3つの区分を選択可能です。</p><p>実際のリリースのポストを参照すると先頭には簡単なリリースノーツが記述されており、それ以下でユーザーによるレポートが続きます。前回も記載しましたが、マニュアルがないことや製品提供機能やUbiquitiの今後の方向性があまり見えてこないこともあり、他のプロダクトと比較しても、ユーザーからは辛辣な意見が寄せられる事が多いです。単なる不満（ユーザーのスキル不足や、製品への過剰な期待や思い込みが原因である事も多いように感じられます）の投稿によって重要な情報を見失わないようにすることが大事です。詳細な検証結果など貴重な情報を提供してくれるユーザーも存在しています。</p><p>デバイスを選択すると個々のデバイスのトラフィック状況などが確認できます。<mark class="label primary">Settings</mark>に進むとバージョンアップや再起動、ファームウェアのロールバックなどが実行できます。また、デバイスをリセットする場合や他のネットワークに使う場合は、<mark class="label primary">Forget</mark>を選択します。</p><img src="/new-technology/2022/10/23/unifi-network-application2/u2.png" class="" width="360" title="alt"><p>ファームウェアをロールバック（ダウングレード）する場合は、該当製品のファームウェアバージョンのURLを指定します。ここで説明している使い方は、Ubiquitiクラウド連携を前提としており、UniFiネットワークアプリケーション、スイッチ共にインターネットへ接続可能である必要があります。リリース一覧は以下のURLから確認します。</p><blockquote><p>UniFi APなど<br><a href="https://www.ui.com/download/unifi/">https://www.ui.com/download/unifi/</a></p></blockquote><blockquote><p>UniFi スイッチ<br><a href="https://www.ui.com/download/unifi-switching-routing">https://www.ui.com/download/unifi-switching-routing</a></p></blockquote><img src="/new-technology/2022/10/23/unifi-network-application2/dl.png" class="" width="1024" title="alt"><p>左メニューのプルダウンから製品を選択すると以下のように最新バージョンが表示されます。ここから<mark class="label primary">PAST FIRMWARE</mark>を選択し、具体的なバージョンを指定してから、ダウンロードを選択するとURLが示されるので、そのURLをネットワークアプリケーションのデバイスのURLに貼り付け、Updateを実行します。</p><img src="/new-technology/2022/10/23/unifi-network-application2/rel1.png" class="" width="800" title="alt"><p>ここまでの作業はスマホアプリ（UniFi Network）でも同様の操作が可能です。</p><h2 id="クライアントデバイス一覧"><a href="#クライアントデバイス一覧" class="headerlink" title="クライアントデバイス一覧"></a>クライアントデバイス一覧</h2><p>以下のように左の赤枠で囲った<mark class="label primary">CLIENT DEVICES</mark>では現在のUniFiネットワークに接続されているクライアント一覧が確認できます。</p><img src="/new-technology/2022/10/23/unifi-network-application2/u3.png" class="" width="1024" title="alt"><p>ここではIPアドレス、クライアントが所属するVLAN、接続しているWi-Fiの情報、トラフィックなどが確認できます。もし、UniFiのL3スイッチがあれば、L3スイッチにDHCP機能があるので、この画面からスタティックIPアドレスを設定可能です。</p><p>この画面もスマホアプリで同様の操作と確認ができます。</p><h2 id="設定"><a href="#設定" class="headerlink" title="設定"></a>設定</h2><p>以下のように左の赤枠で囲った<mark class="label primary">SETTINGS</mark>ではUniFi製品群の全般的な設定をします。なおこの記事のUniFiの構成では、UDM Proなどのセキュリティゲートウェイを保有していない状態であり、単独のUniFi Network Applicationの設定例となります。以下の左側メニューの<mark class="label primary">Internet</mark>、<mark class="label primary">VPN</mark>、<mark class="label primary">Traffic Management</mark>、<mark class="label primary">Firewall & Security</mark>は対象外です。</p><img src="/new-technology/2022/10/23/unifi-network-application2/u4.png" class="" width="1024" title="alt"><h3 id="WiFi"><a href="#WiFi" class="headerlink" title="WiFi"></a>WiFi</h3><p>WiFi設定では名前、所属するVLAN、チャンネルなど設定します。UniFiは集中型管理であるため、個々のAP毎に設定するよりはネットワーク全体でどのように管理するかを決めるモデルとなります。</p><ul><li><p>Global AP Settings<br> この設定で、複数APを立てることを想定し、全般設定を行います。</p></li><li><p>Channel Width<br> 2.4GHz、5GHzそれぞれでバンド幅を設定します。ここは個人の好みによりますが、一般的なデバイスのために2.4GHzは20MHzを、5GHzでは80MHzを設定することをお勧めします。もちろん、PCなども無線でできるだけ速度を求める方は160MHzの設定が可能です。こういった場合は、AP単位にバンド幅を個別設定し、クライアント単位に接続させるAPを固定させる事ができます。</p></li><li><p>Transmit Power<br> 無線の送信出力を決めます。Auto&#x2F;High&#x2F;Medium&#x2F;Lowが選択できます。</p></li><li><p>AP Site Settings<br> Wiress Meshingの項目がありますが、メッシュ製品（無線によるバックホール接続）は現在日本では発売されていません。</p></li><li><p>Nightly Channel Optimization<br> 夜間に外部のWiFiの電波状況を見ながらUniFi側でWiFiチャネルの最適化を行います。比較的近い距離で同一のチャンネルを選択していると競合することになるのでこれは実際にテストしながら選択されることをお勧めします。</p></li></ul><p>これより詳細のWiFi設定についてはまた別の機会があれば書きたいと思います。</p><h3 id="Networks"><a href="#Networks" class="headerlink" title="Networks"></a>Networks</h3><p>Networksでは主にVLANとスイッチの全般設定をします。</p><img src="/new-technology/2022/10/23/unifi-network-application2/u5.png" class="" width="1024" title="alt"><p>今回の記事は概要に留めますが、VLANを構成する場合にはスイッチ単位ではなく、ネットワークアプリケーションでネットワーク全体の構成を決めることになります。もし、UniFiのL3スイッチがあり、L3ネットワークにするのであれば、L3のDHCPを有効にします。L3スイッチがない場合で単にL2のVLANを作成する場合は、<mark class="label primary">VLAN Only Network</mark>としてVLANを作成し、ルーティングやDHCP機能はFirewallやルータに任せることになります。</p><p>一旦ネットワークアプリケーションでVLANを定義すると、どのスイッチからもそのVLANが利用できるようになります。</p><p>以下はFirewallを利用する場合の一例です。インターネット接続がホームゲートウェイとなる場合、もちろんFirewallとHGWとを直結しても構いませんが、トラフィックを把握するためにVLANを定義し、FirewallのWANとHGWとをスイッチに接続します。こういった場合にはUniFiスイッチではFirewallの外側（ホームゲートウェイ側）と内側（LAN）のネットワークとを分離するため、VLAN OnlyでWANのVLANを作成することになります。</p><img src="/new-technology/2022/10/23/unifi-network-application2/switch.drawio.png" class="" width="480" title="alt"><p>UniFiネットワークアプリケーション7.4.156からは、VLANの概念は仮想ネットワークという概念に変わっています。メインのネットワーク（タグ無し）と許可&#x2F;禁止するネットワーク（VLAN）として定義することになり、ネットワーク専門用語ではなく、UniFiの世界の用語へと変わっていくようです。</p><ul><li><p>Global Network Settings<br> ネットワーク設定全般を行います。スイッチの共通設定部分になります。</p></li><li><p>Multicast DNS<br> Apple AirPlayやGoogle Chromecastのためにネットワークセグメントを超えてmDNS(Bonjour)の名前解決およびデータ配信を支援します。</p></li><li><p>IGMP Snooping<br> 本来は、マルチキャストトラフィックを使っていないクライアントに対してはパケットの転送を抑制するためのものですが、スイッチでPackets Discardedのカウンタが増えるのが気になり私は無効にしています。WiFiネットワークがあるセグメントにひかりTVなど、対象セグメントに一定量のマルチキャストトラフィックを流すのが気になる場合はセグメントをVLANで分離する方がお勧めです。</p></li><li><p>Global Switch Settings<br> 複数スイッチの共通設定を指定します。主には、Flow Control、Jumbo Framesがあります。また固有のスイッチだけフローコントロールを外すとか個別設定が可能なように、<mark class="label primary">Switch Exclusion</mark>から該当するスイッチを選択できます。</p></li></ul><h3 id="System"><a href="#System" class="headerlink" title="System"></a>System</h3><p>Systemでは主にネットワークアプリケーション全般設定をします。</p><img src="/new-technology/2022/10/23/unifi-network-application2/u6.png" class="" width="1024" title="alt"><mark class="label primary">Network Notification</mark>で通知設定ができます。これはメール、スマホアプリへの通知、ネットワークアプリケーション画面上での通知が選択できます。ファームウェア通知、APのレーダー受信、クライアントの接続/切断通知など設定項目は多岐にわたります。<p>その他主要項目を抜粋します。</p><ul><li><p>Updates<br> ここではデバイスのファームウェア情報についての設定です。ネットワークアプリケーション自身のアップデートがある場合、デバイスのアップデートがある場合は通知できます。ここで接続チャネル（Officail&#x2F;Release Candidate&#x2F;Early Access）が選べます。なお、ネットワークアプリケーションはインストールで実施したようにShellスクリプトで実施することになります（後述します）。</p></li><li><p>Device Auto Updates<br> デバイスを自動的にアップデートするか選択します。最新ファームウェアが公開されると時刻に関係なくアップデートされるので、ここはオフに設定し、<mark class="label primary">Schedule Device Updates</mark>で週末などにアップデートする設定を追加することをお勧めします。</p> <img src="/new-technology/2022/10/23/unifi-network-application2/u7.png" class="" width="240" title="alt"></li><li><p>Backup<br> ネットワークアプリケーションの設定のバックアップです。日次、週次、月次でバックアップ可能です。トラフィックログも併せてバックアップが可能です。</p></li><li><p>System Logging<br> デバイスのログをsyslogに転送できます。syslogサーバのIPアドレスとPort（一般的に514）を設定します。</p></li><li><p>Network Device SSH Authentication<br> スイッチやAPに対しSSH可能です。スイッチの詳細なカウンタを取得するために必要です。カウンタのエラーが無いか、切断回数などを確認するために使います。パスワード認証または公開鍵を設定することでUniFiデバイスへ接続可能になります。</p> <img src="/new-technology/2022/10/23/unifi-network-application2/u8.png" class="" width="480" title="alt"></li><li><p>Other Configuration<br> NTPの設定、メールサーバーの設定ができます。メールサーバーはCloudを選択するとUbiquitiクラウドからメール通知が行われます。</p></li></ul><h2 id="Network-Applicationのバージョンアップ"><a href="#Network-Applicationのバージョンアップ" class="headerlink" title="Network Applicationのバージョンアップ"></a>Network Applicationのバージョンアップ</h2><p>Network ApplicationはこのGUIから更新することはできず、前回記事「<a href="/new-technology/2022/09/23/unifi-network-application/" title="UniFi Network Applicationのセットアップ">UniFi Network Applicationのセットアップ</a>」で説明したLinuxのシェルからアップデートスクリプトを実行することになります。Windows、macOSでお使いの方は最新モジュールをダウンロードし、セットアップを実行することになります。ここではUbuntuのアップデートの例を記載します。</p><p>スクリプトの情報は、コミュニティにあります。<br><a href="https://community.ui.com/questions/UniFi-Installation-Scripts-or-UniFi-Easy-Update-Script-or-UniFi-Lets-Encrypt-or-UniFi-Easy-Encrypt-/ccbc7530-dd61-40a7-82ec-22b17f027776">https://community.ui.com/questions/UniFi-Installation-Scripts-or-UniFi-Easy-Update-Script-or-UniFi-Lets-Encrypt-or-UniFi-Easy-Encrypt-/ccbc7530-dd61-40a7-82ec-22b17f027776</a></p><p>セットアップで失敗した際にすぐに戻れるように、このタイミングでESXiのスナップショット、またはバックアップの取得をお勧めします。</p><p>実行は3ステップです。Ubuntuの<mark class="label primary">端末</mark>から、以下のコマンドを実行します。</p><ol><li><p>管理者になります</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo -i</span><br></pre></td></tr></table></figure></li><li><p>証明書などのダウンロードをします。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ apt-get update; apt-get install ca-certificates wget -y</span><br></pre></td></tr></table></figure></li><li><p>ネットワークアプリケーションのアップデートを行います。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">rm</span> unifi-update.sh &amp;&gt; /dev/null; wget https://get.glennr.nl/unifi/update/unifi-update.sh &amp;&amp; bash unifi-update.sh</span><br></pre></td></tr></table></figure></li></ol><p>上記のCommunityでは、個別のバージョンのスクリプトシェルへのリンクもありますので、unifi-updates.shの代わりに、バージョンを指定したスクリプトでインストールすることもできます。ロールバックは対応していないとの情報があるので、私はESXiでのバックアップを保存するようにしています。</p><p>日本語ガイドにもアップデートに関する言及があります。</p><blockquote><p>UniFi Network - 他社製の非コンソールUniFi Networkアプリケーションをアップデートする（Linux - 高度）<br> <a href="https://help.jp.ui.com/articles/220066768/">https://help.jp.ui.com/articles/220066768/</a></p></blockquote><h2 id="リソース"><a href="#リソース" class="headerlink" title="リソース"></a>リソース</h2><p>以下の日本語ヘルプ、コミュニティがUniFiの構築には大いに参考になります。</p><blockquote><p>Ubiquiti コミュニティ（日本）<br> <a href="https://www.facebook.com/groups/uijapan">https://www.facebook.com/groups/uijapan</a></p></blockquote><blockquote><p>UI 日本語ヘルプ記事<br> <a href="https://help.jp.ui.com/categories/6583256751383/">https://help.jp.ui.com/categories/6583256751383/</a></p></blockquote><blockquote><p>Ubiquiti Community（米国中心）<br> <a href="https://community.ui.com/">https://community.ui.com/</a></p></blockquote>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2022/10/23/unifi-network-application2/unifi1.png&quot; class=&quot;&quot; width=&quot;1024&quot; title=&quot;alt&quot;&gt;

&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;

&lt;p&gt;前回記事「&lt;a href=&quot;/new-technology/2022/09/23/unifi-network-application/&quot; title=&quot;UniFi Network Applicationのセットアップ&quot;&gt;UniFi Network Applicationのセットアップ&lt;/a&gt;」では、UniFi Network ApplicationをUbuntu上にセットアップし、UniFiネットワーク製品の登録（Adoption）までを行いました。この記事ではホームユーザーがUniFi製品を運用していくにあたり、必要な操作ができるようになることを目的としています。&lt;/p&gt;</summary>
    
    
    
    <category term="Network" scheme="https://yoshi0808.github.io/new-technology/categories/Network/"/>
    
    
    <category term="UniFi" scheme="https://yoshi0808.github.io/new-technology/tags/UniFi/"/>
    
  </entry>
  
</feed>
