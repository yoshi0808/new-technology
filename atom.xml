<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>New technologies in our life</title>
  
  <subtitle>Device,Network,Code,etc...</subtitle>
  <link href="https://yoshi0808.github.io/new-technology/atom.xml" rel="self"/>
  
  <link href="https://yoshi0808.github.io/new-technology/"/>
  <updated>2025-06-03T09:26:04.782Z</updated>
  <id>https://yoshi0808.github.io/new-technology/</id>
  
  <author>
    <name>阿部　吉伸(Yoshinobu ABE)</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Sophos Firewall v21.5</title>
    <link href="https://yoshi0808.github.io/new-technology/2025/05/31/xg-v215/"/>
    <id>https://yoshi0808.github.io/new-technology/2025/05/31/xg-v215/</id>
    <published>2025-05-30T20:37:33.000Z</published>
    <updated>2025-06-03T09:26:04.782Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2025/05/31/xg-v215/Title.png" class="" title="alt"><h2 id="Sophos-Firewall-v21-5"><a href="#Sophos-Firewall-v21-5" class="headerlink" title="Sophos Firewall v21.5"></a>Sophos Firewall v21.5</h2><p>Sophos Firewall v21.5が2025年5月29日に発表されました。VPNのスケーラビリティの向上、その他の機能向上として、ホームエディションのRAM制限の撤廃、DHCPプレフィックス委任緩和（&#x2F;48〜&#x2F;64のプレフィックスに対応）が挙げられます。無償のホームユーザーに対しても積極的な機能提供が行われています。</p><span id="more"></span><h2 id="v21-5の説明と新機能"><a href="#v21-5の説明と新機能" class="headerlink" title="v21.5の説明と新機能"></a>v21.5の説明と新機能</h2><p>v21.5の詳細な説明はSophos Communityを参照してください。</p><blockquote><p><a href="https://community.sophos.com/sophos-xg-firewall/b/blog/posts/sophos-firewall-v21-5-is-now-available">https://community.sophos.com/sophos-xg-firewall/b/blog/posts/sophos-firewall-v21-5-is-now-available</a></p></blockquote><p>リリースノートはこちらです</p><blockquote><p><a href="https://docs.sophos.com/releasenotes/index.html?productGroupID=nsg&productID=xg&versionID=21.5">https://docs.sophos.com/releasenotes/index.html?productGroupID=nsg&amp;productID=xg&amp;versionID=21.5</a></p></blockquote><p>NDR EssentialsというSSL&#x2F;TLSインスペクション無しにリスクを判定する新機能が加えられていますが、ホームエディションでは今の所使えません。DNS Protectionという機能も追加されていますが、ホームユーザーは使えるようにはなっていないようです。また、Sophos Communityによれば、VPNの新しいWindows向けクライアントが6月初旬に発表されるようです。</p><h3 id="RAM制限の撤廃"><a href="#RAM制限の撤廃" class="headerlink" title="RAM制限の撤廃"></a>RAM制限の撤廃</h3><p>これまでCPU4コア、メモリ6GBの制限がありましたが、メモリの制限が撤廃となりました。これはv21の状態においても再起動するだけでロックが解除されるようになっています。CPUの上限は4つのまま、変わらずです。</p><h3 id="DHCPプレフィックス委任"><a href="#DHCPプレフィックス委任" class="headerlink" title="DHCPプレフィックス委任"></a>DHCPプレフィックス委任</h3><p>IPv6は2023年11月のv20より、Prefix Delegationに対応しています。私のISPはauひかりですが、これは&#x2F;64のPrefix Delegationとなっており、Sophos Firewallはこの&#x2F;64には対応していませんでした。よって、私はIPv4同等にIPv6サイトにアクセスするために、NAT6での対応を行なっていました。私が使っているネットワーク機器のUbiquiti製品のゲートウェイは&#x2F;64のPrefix Delegationに対応できていますが、やはり私が求めているのはビジネスグレードのセキュリティゲートウェイなので、Sophos Firewallは外せません。auホームゲートウェイ（HGW）→UniFiゲートウェイ→Sophos Firewallというのはちょっとやりすぎですね。<br>Linux、FreeBSDでルーターを作る上級者の方はもちろん、NAT6で稼働しているケースは少なくないと思います。内部はユニークローカルアドレス（ULA）を割り当て、InternetへのアクセスはNAT6の構成で運用上の不都合は全くありません。また、LANの内部のIPv6アドレスが変わるというのは思いの外、管理が大変です。DHCPを使いIPv4とIPv6とでアドレスの末尾の数字を合わせておけば、ULAは例えば、<code>fd12:3456:7890:1::1</code> と記述でき、Prefixの最初で区別が付くことに加え、後半のインターフェースIDも3桁くらいに抑えることで、IPv6アドレス自体も短く、Firewallログを見た際にもどのクライアントか特定しやすいというメリットがあります。<br><code>240f:3456:7890:2:ed68:b033:e59b:3f1b</code>などのパブリックなIPv6アドレスで、後半64ビットがランダムに割り振られ、端末の再起動毎にインターフェースIDが変わるのはやっぱりログを見ていくのが大変です※。</p><p>それでもIPv6が作られた背景を考えると、その広大なアドレス空間からもNATは不要という考え方があります。折角の機能ですからIPv6アドレスの追跡が困難になることをメリットと考え設定するのも良いのかもしれません。</p><p>※最近のクライアントではIPv6アドレスは２つ割り当てられ、インタフェースIDが変わらないものと、端末の再起動時に変わるものと２つあり、クライアントとしてInternetにアクセスしに行くのは後者の方で、Firewallのログでは毎回インターフェースIDが変わります。</p><h3 id="Sophos-DNS-Protection"><a href="#Sophos-DNS-Protection" class="headerlink" title="Sophos DNS Protection"></a>Sophos DNS Protection</h3><p>Sophosが提供するDNS Protectionです。Sophos Centralと呼ばれる集中型管理コンソールの機能があり、DNSはそこで提供されるサービスです。Sophos Firewallから一般的にはISPが提供するDNSに名前解決を要請しますが、この機能ではCentralのDNSにリレーすることになります。<br>私は既にCentralにFirewallを登録していますが、DNS Protectionの機能は出てこないので、別途ライセンスが必要なのでしょうか。<br>いずれは個人向けにも提供されるような気がしますが、もう少し状況をウォッチしていきたいと考えています。</p><h2 id="Sophos-Firewallのアップデート"><a href="#Sophos-Firewallのアップデート" class="headerlink" title="Sophos Firewallのアップデート"></a>Sophos Firewallのアップデート</h2><p>ここでは、アップデート方法について記載します。</p><p>管理画面にログイン後、左ペインメニューの<mark class="label primary">バックアップ＆ファームウェア</mark>の<mark class="label primary">ファームウェアの確認</mark>でアップデートの案内が順次来ます。直ちにファームウェアのアップグレードの案内が来るわけでは無さそうです。ファームウェア公開後すぐの場合は個別にバージョンアップのファイルを入手します。</p><p>個別にバージョンアップのファイルを入手するには、以下のURLからダウンロードします。</p><p><a href="https://support.sophos.com/support/s/article/KBA-000007972?language=ja">https://support.sophos.com/support/s/article/KBA-000007972?language=ja</a></p><ol><li>上記画面で<mark class="label primary">Sophos Firewall</mark>の<mark class="label primary">ファームウェア</mark>の<mark class="label primary">ソフトウェア</mark>のLinkをクリックします。</li><li>“SW-21.5.0_GA.SFW-171.sig”をダウンロードします。</li><li>Sophos Firewallの管理画面にログインし、左ペインメニューの<mark class="label primary">バックアップ＆ファームウェア</mark>の<mark class="label primary">ファームウェアのタブメニュー</mark>から以下の画面に赤丸で囲った矢印のアイコンをクリックし、ダウンロードしたモジュールをアップロードします。</li></ol><img src="/new-technology/2025/05/31/xg-v215/verup.png" class="" width="800" title="alt"><p>アップロード＆再起動ボタンをクリックし、v21.5へのアップグレードを完了させます。</p><h2 id="Prefix-Delegationの設定"><a href="#Prefix-Delegationの設定" class="headerlink" title="Prefix Delegationの設定"></a>Prefix Delegationの設定</h2><p>具体的な設定方法です。WAN側ではHGWやISPからIPv6アドレスを割り当てられますが、この際以下の赤枠で囲った分のトグルスイッチをOnにします。</p><img src="/new-technology/2025/05/31/xg-v215/v6-1.png" class="" width="640" title="alt"><p>この状態で、IPv6のWAN側に割り当てられたIPv6アドレスが表示されます（アドレスを取得するまで少し時間が掛かります）。</p><p>続いてLAN側です。こちらは、<mark class="label primary">委任</mark>を選び、WANのインターフェースを指定します。</p><img src="/new-technology/2025/05/31/xg-v215/v6-2.png" class="" width="640" title="alt"><p>そうすると委任されたサブネットが表示されます。私の環境では64ビット委任となっています。前半64ビットのPrefixが自動で表示されていますが、一般的に&#x2F;56や&#x2F;60などの多くのサブネットがある場合は、ここで当該LANのサブネットを何にするかプルダウンから選ぶことになるようですね。そして、後半64ビットのインターフェースIDについては1などの具体的なアドレスを設定して、FirewallのIPv6アドレスを確定させます。WAN側のIPアドレスに変更があった場合は、Prefix部分も自動で更新されます。</p><p>さて、これでDHCPv6もIPv6ルーターアドバタイズも自動で構成されます。<br>DHCPv6は以下の構成になっています。</p><img src="/new-technology/2025/05/31/xg-v215/v6-3.png" class="" width="640" title="alt"><p>自動的に<mark class="label primary">デバイスのDNS設定を使用</mark>にチェックが入り、ISP（私の場合はHGW）からのDNS IPv6アドレスが割り当てられます。私の場合は自宅内にESXiやNASなどのホストがあり、その名前解決にIPv4ローカルIPアドレスを使っている関係で、別のサブネットにIPv6ULAを割り当て、そのDNSを参照するようにしています。私のクライアントはAppleデバイス、Windowsが中心ですが、IPv6&#x2F;IPv4のデュアルスタックであり、クライアントがIPv6で直接外部のDNSにIPv4アドレスの名前解決もしようとするため、プライベートIPv4アドレスが返ってきませんので、少し工夫をしています。本来は、委任によって割り当てたLAN側のIPv6アドレスをDNSとするのでしょうが、Prefix Delegationのデザインからすれば、WAN側アドレスは変更される事を想定しておかないといけませんから、パブリックのIPv6アドレスをDNSとしてクライアントに固定で配布することは難しいのです。</p><p>本来のIPv6デザインとしては、パブリックのIPアドレスとULAとが1つのインタフェース上に同居でき、内部通信はULAを使い、Internetへルーティングする際は、パブリックなIPアドレスを使うというのが一般的な考え方です。しかしあまりデザインにこだわりすぎて、端末1台づつスタティックにULAを割り当てるのも面倒すぎますので、こういった方法を取っています。</p><p>RAも同様に自動生成され、特に設定することはありません。</p><img src="/new-technology/2025/05/31/xg-v215/ra.png" class="" width="1024" title="alt"><p>さて、次はFirewallルールの見直しです。従来のULAからはNAT前提だったので、MASQの指定によってv6NATしていましたが、IPv6 DelegationではNATが不要です。ですので該当のSNATは削除します。</p><img src="/new-technology/2025/05/31/xg-v215/nat.png" class="" width="1024" title="alt"><p>私の環境ではパブリックのIPv6サブネットをFamily用として割り当てています。そして会社端末やIoTなどのGuestネットワークについてはULAとしてMASQのNATを残してあります。</p><p>余談ですが、こちらが指定したDNSを無視して直接InternetにDNS参照するようなケースは一般的にはそのDNSをブロック（Drop）する事も考えられますが、それだとサービス自体が動かなくなってしまう事もありえます。上記では、”Redirect DNS”とありますが、NATを使い、Firewallの内部インタフェースのDNSに変換して結果としてFirewall上のDNSを強制的に使っています。</p><p>なお、基本的なFirewallのIPv6で通信を許可する基本設定も必要です。</p><img src="/new-technology/2025/05/31/xg-v215/rule.png" class="" width="1024" title="alt"><p>赤枠で囲った全てを通すルールがあればInernetへの疎通は行えますが、クライアントによって制御したいルールなどもあるでしょう。その際は、クライアントのMACアドレスを<mark class="label primary">ホストとサービス</mark>メニューから<mark class="label primary">IPホスト</mark>として MACアドレスで判別できるように登録しておき、子供のネットに制限を掛けたり、SSL&#x2F;TLSインスペクションの有無などを切り替えると良いでしょう。そうしておけば、IPv6アドレスが変わったとしてもFirewallルールの影響を受けません。</p><p>さて、IPv6の割り当て確認のため、テストしましょう。</p><blockquote><p>test-ipv6<br> <a href="https://www.test-ipv6.com/index.html.ja_JP">https://www.test-ipv6.com/index.html.ja_JP</a></p></blockquote> <img src="/new-technology/2025/05/31/xg-v215/test.png" class="" width="1024" title="alt"><p> ULAの詳細は別ページで説明しているので興味のある方は参照してください。</p><ul><li><a href="/new-technology/2020/04/18/ipv6/" title="IPv6のUnique Local Addressを生成する">IPv6のUnique Local Addressを生成する</a></li><li><a href="/new-technology/2021/06/26/ipv6-first/" title="IPv6のULAをIPv4より優先する">IPv6のULAをIPv4より優先する</a></li><li><a href="/new-technology/2020/04/25/xg-ipv6-1/" title="XG FirewallでIPv6の設定を行う（前半）">XG FirewallでIPv6の設定を行う（前半）</a></li><li><a href="/new-technology/2020/04/29/xg-ipv6-2/" title="Sophos FirewallでIPv6の設定を行う（後半）">Sophos FirewallでIPv6の設定を行う（後半）</a></li></ul><h2 id="フィッシングやマルウェア対策"><a href="#フィッシングやマルウェア対策" class="headerlink" title="フィッシングやマルウェア対策"></a>フィッシングやマルウェア対策</h2><p>私はDNSについては、DoHとしてNextDNSを使っており、危険なサイトおよび広告についてカットしています。また、自宅のサーバー群はQuad9を参照するようにSophos Firewallに設定しています。NextDNSのGoogleセーフサーチや新しいドメインに接続しないという設定は最近流行りのフィッシングサイト対策としては有用です。Sophos Firewallでも使われていないドメイン”ParkedDomain”や”Newly Registerd Websites”をWEBフィルタで止めることで抑止力にはなります。但しフィッシングサイトはそれはもうタケノコのように次から次へと新しいURLが出てきます。フィッシングサイトが発生してから速やかに、当該企業から委託されたセキュリティベンダー等が対処し、無効化されることになりますが、その情報が伝搬されて主要なセキュリティベンダーが共有するにはそれなりの時間が掛かります。そういう意味ではFirewallのWebフィルタではテイクダウンまでの情報収集速度に限界もあるので、Sophos社はDNSサービスを提供し始めたのでしょう。</p><p>キヤノンITソリューションズと合弁した日本法人「イーセットジャパン株式会社」が提供するESET製品はTLS&#x2F;SSLインスペクションを搭載しており、Windows環境では有用です。日本で発生するフィッシングサイトもかなりの精度で止められています。但し、Mac版のESETでは同じ製品か？と思うくらい止められていません（ネットワークフィルタの機能が入っていますが、HTTPSはチェックしません）。なので、私はmacOSについては、セキュリティソフトはBitdefenderを使っています。</p><p>NextDNSはデバイス共通のDNSとして自宅、自宅外でも利用できますし、新しいドメインを止めたり、Googleセーフサーチを活用できたりするので、こちらもほぼフィッシングは止められます。Xなどでポストされてから6時間以降経過したものはほぼ止められているという感覚があります。海外サービスでありながら、日本のフィッシングサイトに対するその精度の高さには驚きます。</p><p>私の場合、NextDNS、Quad9、Sophos Firewallの併用でかなり精度が高いブロックが実現しています。是非この機会にパブリックDNSにも目を向けていただき、信頼できるか否かを見極め、活用されることをお勧めいたします。</p><blockquote><p>NextDNS<br> <a href="https://nextdns.io/">https://nextdns.io</a></p></blockquote><blockquote><p>Quad9<br> <a href="https://quad9.net/">https://quad9.net</a></p></blockquote>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2025/05/31/xg-v215/Title.png&quot; class=&quot;&quot; title=&quot;alt&quot;&gt;

&lt;h2 id=&quot;Sophos-Firewall-v21-5&quot;&gt;&lt;a href=&quot;#Sophos-Firewall-v21-5&quot; class=&quot;headerlink&quot; title=&quot;Sophos Firewall v21.5&quot;&gt;&lt;/a&gt;Sophos Firewall v21.5&lt;/h2&gt;&lt;p&gt;Sophos Firewall v21.5が2025年5月29日に発表されました。VPNのスケーラビリティの向上、その他の機能向上として、ホームエディションのRAM制限の撤廃、DHCPプレフィックス委任緩和（&amp;#x2F;48〜&amp;#x2F;64のプレフィックスに対応）が挙げられます。無償のホームユーザーに対しても積極的な機能提供が行われています。&lt;/p&gt;</summary>
    
    
    
    <category term="Security" scheme="https://yoshi0808.github.io/new-technology/categories/Security/"/>
    
    
    <category term="XG Firewall" scheme="https://yoshi0808.github.io/new-technology/tags/XG-Firewall/"/>
    
  </entry>
  
  <entry>
    <title>VMware ESXi8 Update3eのパッチを適用する</title>
    <link href="https://yoshi0808.github.io/new-technology/2025/04/12/ESXi8U3e-Patch/"/>
    <id>https://yoshi0808.github.io/new-technology/2025/04/12/ESXi8U3e-Patch/</id>
    <published>2025-04-11T15:30:47.000Z</published>
    <updated>2025-04-12T03:07:17.018Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2025/04/12/ESXi8U3e-Patch/title.png" class="" title="alt"><p class="onepoint">この記事で実現すること</p><p>無償版ESXi（VMware vSphere Hypervisor）について、2025-4-10にESXi8 Update3eが発表されています。今回、Broadcomサポートサイトからisoファイルをダウンロードできるようになっています。また、ESXi8 Update3dの時と同様にVMWareのサイトから製品パッチをESXi本体から直接ダウンロードし、ESXi上でパッチを適用する方法も（推奨されませんが）存在します。従来は、BroadcomからパッチのZIPファイルをダウンロードしESXiに適用する方法でしたが、ESXi8 Update3eではISOによるファイルのダウンロードおよび、（非推奨の）コマンドからのUpdateについて説明します。</p><span id="more"></span><h2 id="Broadcomのパッチのダウンロードについて"><a href="#Broadcomのパッチのダウンロードについて" class="headerlink" title="Broadcomのパッチのダウンロードについて"></a>Broadcomのパッチのダウンロードについて</h2><p>2025-04-12の時点でESXi8.0は　Update3eのパッチが提供されています。但しこれはISOファイルであって、従来コマンドでパッチを適用していたZIPファイルではありません。おそらくユーザーのESXiはヘッドレス環境（モニタがない）で運用されているでしょうから、USBメモリにISOを書き込みブートしてから画面操作というのはなかなか面倒でしょう。しかし、正式にBroadcomからESXiの最新版のISOファイルが再び提供されるようになったのは喜ばしいことです。</p><p>ISOファイルのダウンロード手順は下記の通りです。</p><ol><li>Broadcomサポートポータルに接続し、ログインします。<br>　<a href="https://support.broadcom.com/">https://support.broadcom.com/</a></li><li>以下でVMwareのメニューを選択します。</li></ol> <img src="/new-technology/2025/04/12/ESXi8U3e-Patch/bc1.png" class="" width="1024" title="alt"><ol><li>左ペインの<mark class="label primary">My Downloads</mark>をクリックすると、<mark class="label primary">Free Software Downloads available HERE</mark>と表示されますのでリンクをクリックします。</li></ol> <img src="/new-technology/2025/04/12/ESXi8U3e-Patch/bc2.png" class="" width="1024" title="alt"><ol><li>FreeDownloadsの画面から<mark class="label primary">Search Product Name</mark>の入力ボックスに”vSphere”と入力します。</li></ol> <img src="/new-technology/2025/04/12/ESXi8U3e-Patch/bc3.png" class="" width="1024" title="alt"><ol><li>以下のようにvSphereの項目が表示されますのでさらにクリックします。</li></ol> <img src="/new-technology/2025/04/12/ESXi8U3e-Patch/bc4.png" class="" width="1024" title="alt"><ol><li>vSphereからさらに次のページのLinkをクリックします。</li></ol> <img src="/new-technology/2025/04/12/ESXi8U3e-Patch/bc5.png" class="" width="1024" title="alt"><ol><li>“8.0U3e”のリンクが表示されますのでさらにLinkをクリックします。</li></ol> <img src="/new-technology/2025/04/12/ESXi8U3e-Patch/bc6.png" class="" width="1024" title="alt"><ol><li>以下のダウンロードリンクをクリックします。Agreementと共に個人情報を入力する画面が出る場合があります。</li></ol> <img src="/new-technology/2025/04/12/ESXi8U3e-Patch/bc7.png" class="" width="1024" title="alt"><p>ISOファイルがダウンロードできたら、USBメモリに焼いてESXiのマシンにおいてUSBブート、アップグレード（実際にはアップデート）を実施します。ESXiに対するISOを使ったアップグレードの手順については、以下のESXiセットアップ動画を参考にしてください。特に難しいものはありません。途中、新規インストールかアップグレードかを選択する箇所があります。この動画では新規インストールを選択していますが、アップグレードを選んでください。<br><a href="https://www.youtube.com/watch?v=eiZn54GPfzI">https://www.youtube.com/watch?v=eiZn54GPfzI</a></p><h2 id="Broadcomのサイトから直接のダウンロード（非推奨）"><a href="#Broadcomのサイトから直接のダウンロード（非推奨）" class="headerlink" title="Broadcomのサイトから直接のダウンロード（非推奨）"></a>Broadcomのサイトから直接のダウンロード（非推奨）</h2><div class="note warning"><h4 id="今回のパッチ適用方法についてのご注意事項"><a href="#今回のパッチ適用方法についてのご注意事項" class="headerlink" title="今回のパッチ適用方法についてのご注意事項"></a>今回のパッチ適用方法についてのご注意事項</h4><p>今回はパッチ適用にあたり、暫定方式（一部メーカーが明確に推奨していない方法を含む）を紹介していますので、リスクをご理解の上で利用されているESXiへのパッチ適用をおすすめします。</p></div><h2 id="ESXi8-Update3e"><a href="#ESXi8-Update3e" class="headerlink" title="ESXi8 Update3e"></a>ESXi8 Update3e</h2><p>このリリースでは、新たに発見された脆弱性（CVE）はありませんが、未然防止としてのセキュリティパッチと不具合修正が含まれています。<br>CVEは発行されていないといっても、重要度についてはCriticalとなっていますので、迅速なパッチ適用が求められます。</p><blockquote><p>パッチ情報（Broadcom）<br><a href="https://techdocs.broadcom.com/us/en/vmware-cis/vsphere/vsphere/8-0/release-notes/esxi-update-and-patch-release-notes/vsphere-esxi-80u3e-release-notes.html">https://techdocs.broadcom.com/us/en/vmware-cis/vsphere/vsphere/8-0/release-notes/esxi-update-and-patch-release-notes/vsphere-esxi-80u3e-release-notes.html</a></p></blockquote><h2 id="パッチの内容について"><a href="#パッチの内容について" class="headerlink" title="パッチの内容について"></a>パッチの内容について</h2><p>前述したパッチ情報によれば、今回のProfileは以下の4つです。<br>Image Profile Name<br>ESXi-8.0U3e-24674464-standard<br>ESXi-8.0U3e-24674464-no-tools<br>ESXi-8.0U3se-24659227-standard<br>ESXi-8.0U3se-24659227-no-tools<br>ここではセキュリティパッチ＋バグに対応したもの、かつ、VMware Tools込みのものを適用します（ESXi-8.0U3e-24674464-standard）。</p><p>現在稼働しているESXiのバージョンについては、ESXiにSSHし、以下のコマンドで確認できます（任意）。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost:~] esxcli software profile get</span><br><span class="line">(Updated) ESXi-8.0U3d-24585383-standard</span><br></pre></td></tr></table></figure><p>ESXi上でSSH Serverを起動するには以下で行います。<br> ESXiの左ペインの<mark class="label primary">ホストー管理</mark>から、”サービス”のタブをクリックし、”TSM-SSH”を選択し”起動”ボタンをクリックし、SSHを有効にします。<br> </p><p>これまではオフラインバンドル、つまりESXiはセキュリティのために最小限のアクセスに留めるべく、インターネットに接続するのは最低限度（NTPのみ）という構成を前提としていました。一旦Broadcomからパッチをダウンロードし、それをESXiにアップロード、パッチ適用という流れです。しかし、現時点ではこれまでの方法が取れません。ESXi本体にSSHし、ESXiのコマンドにて直接VMwareサイト（実際はBroadcom）からのパッチの確認、ダウンロードします。このために少しハックが必要です。</p><h2 id="ESXCLIコマンドの修正（ハック）"><a href="#ESXCLIコマンドの修正（ハック）" class="headerlink" title="ESXCLIコマンドの修正（ハック）"></a>ESXCLIコマンドの修正（ハック）</h2><p>William氏のブログでは以下のコマンドパッチを適用することでコマンドエラーが無くなるとのことです。まずはESXiにSSHした上で以下の５つのコマンドパッチを投入してください。なお、再起動などで今回のコマンドパッチはリセットされますので改めて設定が必要です。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost:~] esxcli system settings advanced <span class="built_in">set</span> -o /VisorFS/VisorFSPristineTardisk -i 0</span><br><span class="line">[root@localhost:~] <span class="built_in">cp</span> /usr/lib/vmware/esxcli-software /usr/lib/vmware/esxcli-software.bak</span><br><span class="line">[root@localhost:~] sed -i <span class="string">&#x27;s/mem=300/mem=500/g&#x27;</span> /usr/lib/vmware/esxcli-software.bak</span><br><span class="line">[root@localhost:~] <span class="built_in">mv</span> /usr/lib/vmware/esxcli-software.bak /usr/lib/vmware/esxcli-software -f</span><br><span class="line">[root@localhost:~] esxcli system settings advanced <span class="built_in">set</span> -o /VisorFS/VisorFSPristineTardisk -i 1</span><br></pre></td></tr></table></figure><blockquote><p>William Lam氏の該当記事<br> <a href="https://williamlam.com/2024/03/quick-tip-using-esxcli-to-upgrade-esxi-8-x-throws-memoryerror-or-got-no-data-from-process.html">https://williamlam.com/2024/03/quick-tip-using-esxcli-to-upgrade-esxi-8-x-throws-memoryerror-or-got-no-data-from-process.html</a></p></blockquote><h2 id="パッチ情報の確認"><a href="#パッチ情報の確認" class="headerlink" title="パッチ情報の確認"></a>パッチ情報の確認</h2><p>最初にESXiからhttpクライアントをFirewallで通すため、ESXiにSSHしたあと、以下のコマンドを投入します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">esxcli network firewall ruleset <span class="built_in">set</span> -e <span class="literal">true</span> -r httpClient</span><br></pre></td></tr></table></figure><p>すでにリリースノートで、パッチのProfileは<code>ESXi-8.0U3e-24674464-standard</code>と判明していますが、SSHから確認してみます（任意）。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost:~] esxcli software sources profile list -d https://hostupdate.vmware.com/software/VUM/PRODUCTION/main/vmw-depot-index.xml | grep ESXi-8.0U3e</span><br></pre></td></tr></table></figure><p>数分、時間がかかる場合があります。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ESXi-8.0U3e-24674464-no-tools     VMware, Inc.  PartnerSupported  2025-04-10T00:00:00  2025-04-10T00:00:00</span><br><span class="line">ESXi-8.0U3e-24674464-standard     VMware, Inc.  PartnerSupported  2025-04-10T00:00:00  2025-04-10T00:00:00</span><br></pre></td></tr></table></figure><p>情報に相違はないことが確認できました。セキュリティパッチのみの方は、Profile名が”ESXi-8.0U3se”なのでgrepの結果抽出されていません。</p><h2 id="パッチ適用の事前準備"><a href="#パッチ適用の事前準備" class="headerlink" title="パッチ適用の事前準備"></a>パッチ適用の事前準備</h2><ol><li>仮想マシンを全てシャットダウンします</li><li>ESXiをメンテナンスモードに切り替えます</li></ol> <img src="/new-technology/2025/04/12/ESXi8U3e-Patch/esxi2.png" class="" title="alt"><p>さて、最後にパッチ適用のコマンドを投入しますが、前述したWilliam氏のブログでのコメントも認識しておいてください。いつまでこの方法が通用するかはわかりません。</p><blockquote class="blockquote-center"><p>これがあなたのホームラボであり、私のようなESXiホストが1つしかない場合、オンラインのVMwareパッチリポジトリを引き続き使用できるようにする回避策を見つけることができましたが、これは間違いなく公式にはサポートされていません。</p></blockquote><ol start="3"><li>SSHから以下のコマンドを投入します。</li></ol> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">esxcli software profile update -p ESXi-8.0U3e-24674464-standard -d https://hostupdate.vmware.com/software/VUM/PRODUCTION/main/vmw-depot-index.xml</span><br></pre></td></tr></table></figure><ol start="4"><li>実行後しばらくしてから、結果が表示されます。</li></ol> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Update Result</span><br><span class="line">  Message: The update completed successfully, but the system needs to be rebooted for the changes to be effective.</span><br><span class="line">  ...</span><br><span class="line">  Reboot Required: true</span><br></pre></td></tr></table></figure><ol start="5"><li><p>再びESXiのFirewallでhttpsアクセスを閉じます。<br>　<code>esxcli network firewall ruleset set -e false -r httpClient</code></p></li><li><p><code>reboot</code>とし、ESXiを再起動します。</p></li></ol><p>再起動完了後、ESXiにログインします。左ペインメニューの”ホスト”をクリックし、バージョンの表記に今回パッチを当てたビルド番号が表示されている事を確認してください。今回はU3eとなっているはずです。</p><img src="/new-technology/2025/04/12/ESXi8U3e-Patch/esxi4.png" class="" width="1024" title="alt"><p>または、sshでESXiに接続し、<code>vmware -v</code>を実行し確認します。</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost:~] vmware -v</span><br><span class="line">VMware ESXi 8.0.3 build-24674464</span><br></pre></td></tr></table></figure><h2 id="事後作業"><a href="#事後作業" class="headerlink" title="事後作業"></a>事後作業</h2><p>これまで実施してきたメンテナンス準備とは反対の作業をします。メンテナンスモードの終了・SSHの無効化・仮想マシンの起動と続けます。</p>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2025/04/12/ESXi8U3e-Patch/title.png&quot; class=&quot;&quot; title=&quot;alt&quot;&gt;
&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;

&lt;p&gt;無償版ESXi（VMware vSphere Hypervisor）について、2025-4-10にESXi8 Update3eが発表されています。今回、Broadcomサポートサイトからisoファイルをダウンロードできるようになっています。また、ESXi8 Update3dの時と同様にVMWareのサイトから製品パッチをESXi本体から直接ダウンロードし、ESXi上でパッチを適用する方法も（推奨されませんが）存在します。従来は、BroadcomからパッチのZIPファイルをダウンロードしESXiに適用する方法でしたが、ESXi8 Update3eではISOによるファイルのダウンロードおよび、（非推奨の）コマンドからのUpdateについて説明します。&lt;/p&gt;</summary>
    
    
    
    <category term="Software" scheme="https://yoshi0808.github.io/new-technology/categories/Software/"/>
    
    
    <category term="ESXi" scheme="https://yoshi0808.github.io/new-technology/tags/ESXi/"/>
    
  </entry>
  
  <entry>
    <title>Sophos Firewall v21 MR1</title>
    <link href="https://yoshi0808.github.io/new-technology/2025/03/16/xg-v21mr1/"/>
    <id>https://yoshi0808.github.io/new-technology/2025/03/16/xg-v21mr1/</id>
    <published>2025-03-15T20:47:16.000Z</published>
    <updated>2025-04-11T23:28:46.310Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2025/03/16/xg-v21mr1/Title.png" class="" title="alt"><h2 id="Sophos-Firewall-v21-MR1"><a href="#Sophos-Firewall-v21-MR1" class="headerlink" title="Sophos Firewall v21 MR1"></a>Sophos Firewall v21 MR1</h2><p>Sophos Firewall v21 MR1が2025年03月13日に発表されました。VPNのエンハンス、DHCPのエラーからの回復機能追加などが挙げられます。IPv6のみのクライアント（IPv4を持たない）に対しIPv6からのNAT機能でIPv4サイトを閲覧できるProxy機能が加えられました。<br>また、 2025年3月31日にバグフィックスされたMR1-Build277が発表されています。</p><span id="more"></span><p>v21 MR1の詳細な説明はSophos Communityを参照してください。</p><blockquote><p><a href="https://community.sophos.com/sophos-xg-firewall/b/blog/posts/sophos-firewall-os-v21-mr1-rerelease-build-272-is-now-available">https://community.sophos.com/sophos-xg-firewall/b/blog/posts/sophos-firewall-os-v21-mr1-rerelease-build-272-is-now-available</a></p></blockquote><p>リリースノートはこちらです。</p><blockquote><p><a href="https://docs.sophos.com/releasenotes/index.html?productGroupID=nsg&productID=xg&versionID=21.0">https://docs.sophos.com/releasenotes/index.html?productGroupID=nsg&amp;productID=xg&amp;versionID=21.0</a></p></blockquote><p>MR1-Build277では、PPPoEユーザー名（NC-153892）に特殊文字「#」がある場合、PPPoEインターフェイスが接続されないという孤立した問題が見られたためそれの解決策が適用されています。</p><h2 id="Sophos-Firewallのアップデート"><a href="#Sophos-Firewallのアップデート" class="headerlink" title="Sophos Firewallのアップデート"></a>Sophos Firewallのアップデート</h2><p>管理画面にログイン後、左ペインメニューの<mark class="label primary">バックアップ＆ファームウェア</mark>の<mark class="label primary">ファームウェアの確認</mark>でアップデートの案内が順次来ます。ただし、これはかなり時間が経過してから通知が行われるのが通常のようです。</p><img src="/new-technology/2025/03/16/xg-v21mr1/mr1-1.png" class="" width="800" title="alt"><p>※上記はv21 MR1のファームウェアが通知されたところです。</p><p>個別にバージョンアップのファイルを入手するには、以下のURLからダウンロードします。</p><p><a href="https://support.sophos.com/support/s/article/KB-000043162?language=en_US">https://support.sophos.com/support/s/article/KB-000043162?language=en_US</a></p><ol><li>上記画面で<mark class="label primary">Sophos Firewall</mark>の<mark class="label primary">ファームウェア</mark>の<mark class="label primary">ソフトウェア</mark>のLinkをクリックします。</li><li>“SW-21.0.1_MR-1.SFW-277.sig”をダウンロードします。</li><li>Sophos Firewallの管理画面にログインし、左ペインメニューの<mark class="label primary">バックアップ＆ファームウェア</mark>の<mark class="label primary">ファームウェアのタブメニュー</mark>から以下の画面に赤丸で囲った矢印のアイコンをクリックし、ダウンロードしたモジュールをアップロードします。</li></ol><img src="/new-technology/2025/03/16/xg-v21mr1/verup.png" class="" width="800" title="alt"><p>アップロード＆再起動ボタンをクリックし、v21 MR1へのアップグレードを完了させます。</p><h2 id="補足"><a href="#補足" class="headerlink" title="補足"></a>補足</h2><p>実は、v21 MR1は2025-02-18に一度リリースされましたが、Let’s Encryptで証明書の生成に関する問題が発生していました。ホームユーザーにとってはLet’s Encryptの再登録はそれなりに手間で大変助かる機能ですので、これの適用は一旦見送っていました。今回無事に改修された新たなv21 MR1が提供されました。</p>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2025/03/16/xg-v21mr1/Title.png&quot; class=&quot;&quot; title=&quot;alt&quot;&gt;

&lt;h2 id=&quot;Sophos-Firewall-v21-MR1&quot;&gt;&lt;a href=&quot;#Sophos-Firewall-v21-MR1&quot; class=&quot;headerlink&quot; title=&quot;Sophos Firewall v21 MR1&quot;&gt;&lt;/a&gt;Sophos Firewall v21 MR1&lt;/h2&gt;&lt;p&gt;Sophos Firewall v21 MR1が2025年03月13日に発表されました。VPNのエンハンス、DHCPのエラーからの回復機能追加などが挙げられます。IPv6のみのクライアント（IPv4を持たない）に対しIPv6からのNAT機能でIPv4サイトを閲覧できるProxy機能が加えられました。&lt;br&gt;また、 2025年3月31日にバグフィックスされたMR1-Build277が発表されています。&lt;/p&gt;</summary>
    
    
    
    <category term="Security" scheme="https://yoshi0808.github.io/new-technology/categories/Security/"/>
    
    
    <category term="XG Firewall" scheme="https://yoshi0808.github.io/new-technology/tags/XG-Firewall/"/>
    
  </entry>
  
  <entry>
    <title>VMware ESXi8 Update3dのパッチを適用する</title>
    <link href="https://yoshi0808.github.io/new-technology/2025/03/08/ESXi8-Patch/"/>
    <id>https://yoshi0808.github.io/new-technology/2025/03/08/ESXi8-Patch/</id>
    <published>2025-03-07T19:00:55.000Z</published>
    <updated>2025-03-08T06:35:47.971Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2025/03/08/ESXi8-Patch/title.png" class="" title="alt"><p class="onepoint">この記事で実現すること</p><p>無償版ESXi（VMware vSphere Hypervisor）について、VMWareのサイトから製品パッチをESXi本体から直接ダウンロードし、ESXi上でパッチを適用します。この記事ではESXi8.0を対象にしていますが、コマンド自体はESXi7.0も変わりません。従来は、BroadcomからパッチをダウンロードしESXiに適用する方法でしたが、ESXi8 Update3dから、少し対応しづらくなってきたので別の方法を紹介します。</p><span id="more"></span><h2 id="Broadcomのパッチのダウンロードについて"><a href="#Broadcomのパッチのダウンロードについて" class="headerlink" title="Broadcomのパッチのダウンロードについて"></a>Broadcomのパッチのダウンロードについて</h2><p>2025-03-08の時点でESXi8.0は　Update3dのパッチが提供されています。しかしながら、私のBroadcomアカウントが個人のgmailで登録していたためか、Broadcomのサイトからパッチがダウンロードできなくなっています。個人のProfileを構成しなくてはなりませんが、「non-corporate email domain」はProfileが構成できないとのことです。無償ユーザーは少しづつ制約が加えられてきていることをひしひしと感じます。昨年末まではパッチをダウンロードできていましたが、現時点ではこれまで紹介してきた方法では実施できなくなっています。とはいえ、このブログは個人のためのものであり、自分が勤めている会社のメールを登録するつもりは全くありませんし、他の方法を模索しなくてはなりません。</p><div class="note warning"><h4 id="今回のパッチ適用方法についてのご注意事項"><a href="#今回のパッチ適用方法についてのご注意事項" class="headerlink" title="今回のパッチ適用方法についてのご注意事項"></a>今回のパッチ適用方法についてのご注意事項</h4><p>今回はパッチ適用にあたり、暫定方式（一部メーカーが明確に推奨していない方法を含む）を紹介していますので、リスクをご理解の上で利用されているESXiへのパッチ適用をおすすめします。</p></div><h2 id="ESXi8-Update3d"><a href="#ESXi8-Update3d" class="headerlink" title="ESXi8 Update3d"></a>ESXi8 Update3d</h2><p>このリリースは、CVE-2025-22224、CVE-2025-22225、CVE-2025-22226の脆弱性に対応したものです。</p><table><thead><tr><th><strong>脆弱性ID</strong></th><th><strong>対象製品</strong></th><th><strong>概要</strong></th><th><strong>深刻度 (CVSSv3.1)</strong></th><th><strong>既知の悪用</strong></th></tr></thead><tbody><tr><td>CVE-2025-22224</td><td>VMware ESXi、Workstation</td><td>TOCTOU（Time-of-Check Time-of-Use）レースコンディションにより、ヒープオーバーフローが発生し、境界外書き込みが可能となる脆弱性。これにより、ローカルの管理者権限を持つ攻撃者が、ホスト上でVMXプロセスとしてコードを実行できる可能性があります。</td><td>9.3 (Critical)</td><td>確認されています。</td></tr><tr><td>CVE-2025-22225</td><td>VMware ESXi</td><td>VMXプロセス内で権限を持つ攻撃者が、任意のカーネル書き込みをトリガーし、サンドボックスを回避する可能性がある脆弱性。</td><td>8.2 (Important)</td><td>確認されています。</td></tr><tr><td>CVE-2025-22226</td><td>VMware ESXi、Workstation、Fusion</td><td>HGFSにおける境界外読み取りにより、情報漏洩が発生する脆弱性。仮想マシン上でローカルの管理者権限を持つ攻撃者が、VMXプロセスのメモリ内容を取得する可能性があります。</td><td>7.1 (Important)</td><td>確認されています。</td></tr></tbody></table><p>これは、すでに仮想マシンのゲストOSを侵害し、特権アクセス（管理者またはルート）を取得した攻撃者がハイパーバイザー自体に移動できる状況です。詳細は以下の「脆弱性に関する追加情報」を参照してください。すでに悪用が確認されていること、過去の脆弱性から鑑みても今回はかなりインパクトのある脆弱性と考えられます。</p><blockquote><p>脆弱性に関する追加情報（GitHub）<br> <a href="https://github.com/vmware/vcf-security-and-compliance-guidelines/tree/main/security-advisories/vmsa-2025-0004">https://github.com/vmware/vcf-security-and-compliance-guidelines/tree/main/security-advisories/vmsa-2025-0004</a> </p></blockquote><blockquote><p>パッチ情報（Broadcom）<br><a href="https://techdocs.broadcom.com/us/en/vmware-cis/vsphere/vsphere/8-0/release-notes/esxi-update-and-patch-release-notes/vsphere-esxi-80u3d-release-notes.html">https://techdocs.broadcom.com/us/en/vmware-cis/vsphere/vsphere/8-0/release-notes/esxi-update-and-patch-release-notes/vsphere-esxi-80u3d-release-notes.html</a></p></blockquote><h2 id="パッチの内容について"><a href="#パッチの内容について" class="headerlink" title="パッチの内容について"></a>パッチの内容について</h2><p>前述したパッチ情報によれば、今回のProfileは以下の2つです。</p><ul><li>ESXi-8.0U3d-24585383-standard</li><li>ESXi-8.0U3d-24585383-no-tools</li></ul><p>いつものようにシンプルなパッチのプロファイルであり、通常はVMware Tools込みのものを適用します。<br>現在稼働しているESXiのバージョンについては、ESXiにSSHし、以下のコマンドで確認できます（任意）。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost:~] esxcli software profile get</span><br><span class="line">(Updated) ESXi-8.0U3c-24414501-standard</span><br></pre></td></tr></table></figure><p>ESXi上でSSH Serverを起動するには以下で行います。<br> ESXiの左ペインの<mark class="label primary">ホストー管理</mark>から、”サービス”のタブをクリックし、”TSM-SSH”を選択し”起動”ボタンをクリックし、SSHを有効にします。<br> <img src="/new-technology/2025/03/08/ESXi8-Patch/esxi1.png" class="" title="alt"></p><p>これまではオフラインバンドル、つまりESXiはセキュリティのために最小限のアクセスに留めるべく、インターネットに接続するのは最低限度（NTPのみ）という構成を前提としていました。一旦Broadcomからパッチをダウンロードし、それをESXiにアップロード、パッチ適用という流れです。しかし、現時点ではこれまでの方法が取れません。ESXi本体にSSHし、ESXiのコマンドにて直接VMwareサイト（実際はBroadcom）からのパッチの確認、ダウンロードします。このために少しハックが必要です。</p><h3 id="ESXCLIコマンドの修正（ハック）"><a href="#ESXCLIコマンドの修正（ハック）" class="headerlink" title="ESXCLIコマンドの修正（ハック）"></a>ESXCLIコマンドの修正（ハック）</h3><p>注意点は2点あります。</p><ol><li>パッチを適用するためのProfileは、&lt;hostupdate.vmware.com&gt;にあります。これはDNSでLookupすると、IPv4とIPv6のホストが存在します。</li><li>VMware改め、Broadcomの社員である有名なWilliam LAM氏のブログによれば、ESXi8でESXCLIコマンドでメモリエラーが出るケースに遭遇するとのこと。それらの対策のためにいくつかのコマンドをESXi本体にSSHして実行する必要があります。</li></ol><h4 id="hostupdate-vmware-com"><a href="#hostupdate-vmware-com" class="headerlink" title="hostupdate.vmware.com"></a>hostupdate.vmware.com</h4><p>ESXi8にSSHしてからnslookupしてみると以下の通りです。IPアドレスは伏せてあります。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost:~] nslookup hostupdate.vmware.com</span><br><span class="line">Server:192.168.x.x</span><br><span class="line">Address:192.168.x.x:53</span><br><span class="line"></span><br><span class="line">Non-authoritative answer:</span><br><span class="line">hostupdate.vmware.comcanonical name = hostupdate.broadcom.com</span><br><span class="line">hostupdate.broadcom.comcanonical name = hostupdate.broadcom.com.cdn.cloudflare.net</span><br><span class="line">Name:hostupdate.broadcom.com.cdn.cloudflare.net</span><br><span class="line">Address: 2606:xxxx:xxxx::xxxx</span><br><span class="line">Name:hostupdate.broadcom.com.cdn.cloudflare.net</span><br><span class="line">Address: 2a06:xxxx:xxxx::xxxx</span><br><span class="line"></span><br><span class="line">Non-authoritative answer:</span><br><span class="line">hostupdate.vmware.comcanonical name = hostupdate.broadcom.com</span><br><span class="line">hostupdate.broadcom.comcanonical name = hostupdate.broadcom.com.cdn.cloudflare.net</span><br><span class="line">Name:hostupdate.broadcom.com.cdn.cloudflare.net</span><br><span class="line">Address: x.x.x.x</span><br><span class="line">Name:hostupdate.broadcom.com.cdn.cloudflare.net</span><br><span class="line">Address: x.x.x.x</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>これまで直接パッチのProfileを確認したり、ダウンロードするには、<code>hostupdate.vmware.com</code>を使っていましたが、今後もそのまま使えるようではあります。ただ、どうもホストのどれかには情報が乗っていないサーバーがあるのか、<code>Got no data from process.</code>という結果が返ったりします。私はこれまでESXiではIPv4のみ利用していましたが、X（Twitter）でIPv6でしか情報が取れないなどのポストがあったので改めてESXiにIPv6を設定して実行しています。</p><p>もし、IPv6が必要そうなのであれば、これはESXiのWebコンソールの左ペイン<mark class="label primary">ネットワーク</mark>から、ESXiのマネジメントインタフェース、おそらくvSwitch0のVMKernelであるvmk0が対象と思われますが、ご自身のマネジメントネットワークを選択の上、設定を編集し、IPv6を有効にしてください。<br> <img src="/new-technology/2025/03/08/ESXi8-Patch/esxi3.png" class="" title="alt"></p><h4 id="ESXCLIコマンドのパッチ"><a href="#ESXCLIコマンドのパッチ" class="headerlink" title="ESXCLIコマンドのパッチ"></a>ESXCLIコマンドのパッチ</h4><p>William氏のブログでは以下のコマンドパッチを適用することでコマンドエラーが無くなるとのことです。まずはESXiにSSHした上で以下の５つのコマンドパッチを投入してください。なお、新しいESXiパッチを適用すると今回のコマンドパッチはリセットされますので改めて設定が必要です。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost:~] esxcli system settings advanced <span class="built_in">set</span> -o /VisorFS/VisorFSPristineTardisk -i 0</span><br><span class="line">[root@localhost:~] <span class="built_in">cp</span> /usr/lib/vmware/esxcli-software /usr/lib/vmware/esxcli-software.bak</span><br><span class="line">[root@localhost:~] sed -i <span class="string">&#x27;s/mem=300/mem=500/g&#x27;</span> /usr/lib/vmware/esxcli-software.bak</span><br><span class="line">[root@localhost:~] <span class="built_in">mv</span> /usr/lib/vmware/esxcli-software.bak /usr/lib/vmware/esxcli-software -f</span><br><span class="line">[root@localhost:~] esxcli system settings advanced <span class="built_in">set</span> -o /VisorFS/VisorFSPristineTardisk -i 1</span><br></pre></td></tr></table></figure><blockquote><p>William Lam氏の該当記事<br> <a href="https://williamlam.com/2024/03/quick-tip-using-esxcli-to-upgrade-esxi-8-x-throws-memoryerror-or-got-no-data-from-process.html">https://williamlam.com/2024/03/quick-tip-using-esxcli-to-upgrade-esxi-8-x-throws-memoryerror-or-got-no-data-from-process.html</a></p></blockquote><h2 id="パッチ情報の確認"><a href="#パッチ情報の確認" class="headerlink" title="パッチ情報の確認"></a>パッチ情報の確認</h2><p>最初にESXiからhttpクライアントをFirewallで通すため、ESXiにSSHしたあと、以下のコマンドを投入します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">esxcli network firewall ruleset <span class="built_in">set</span> -e <span class="literal">true</span> -r httpClient</span><br></pre></td></tr></table></figure><p>すでにリリースノートで、パッチのProfileは<code>ESXi-8.0U3d-24585383-standard</code>と判明していますが、SSHから確認してみます（任意）。数分、時間がかかります。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost:~] esxcli software sources profile list -d https://hostupdate.vm</span><br><span class="line">ware.com/software/VUM/PRODUCTION/main/vmw-depot-index.xml | grep ESXi-8.0U3d</span><br><span class="line">ESXi-8.0U3d-24585383-no-tools     VMware, Inc.  PartnerSupported  2025-03-04T00:00:00  2025-03-04T00:00:00</span><br><span class="line">ESXi-8.0U3d-24585383-standard     VMware, Inc.  PartnerSupported  2025-03-04T00:00:00  2025-03-04T00:00:00</span><br></pre></td></tr></table></figure><p>情報に相違はないことが確認できました。</p><h2 id="パッチ適用の事前準備"><a href="#パッチ適用の事前準備" class="headerlink" title="パッチ適用の事前準備"></a>パッチ適用の事前準備</h2><ol><li>仮想マシンを全てシャットダウンします</li><li>ESXiをメンテナンスモードに切り替えます</li></ol> <img src="/new-technology/2025/03/08/ESXi8-Patch/esxi2.png" class="" title="alt"><p>さて、最後にパッチ適用のコマンドを投入しますが、前述したWilliam氏のブログでのコメントも認識しておいてください。いつまでこの方法が通用するかはわかりません。</p><blockquote class="blockquote-center"><p>これがあなたのホームラボであり、私のようなESXiホストが1つしかない場合、オンラインのVMwareパッチリポジトリを引き続き使用できるようにする回避策を見つけることができましたが、これは間違いなく公式にはサポートされていません。</p></blockquote><ol start="3"><li>SSHから以下のコマンドを投入します。</li></ol> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">esxcli software profile update -p ESXi-8.0U3d-24585383-standard -d https://hostupdate.vmware.com/software/VUM/PRODUCTION/main/vmw-depot-index.xml</span><br></pre></td></tr></table></figure><ol start="4"><li>実行後しばらくしてから、結果が表示されます。</li></ol> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Update Result</span><br><span class="line">  Message: The update completed successfully, but the system needs to be rebooted for the changes to be effective.</span><br><span class="line">  ...</span><br><span class="line">  Reboot Required: true</span><br></pre></td></tr></table></figure><ol start="5"><li><p>再びESXiのFirewallでhttpsアクセスを閉じます。<br>　<code>esxcli network firewall ruleset set -e false -r httpClient</code></p></li><li><p><code>reboot</code>とし、ESXiを再起動します。</p></li></ol><p>再起動完了後、ESXiにログインします。左ペインメニューの”ホスト”をクリックし、バージョンの表記に今回パッチを当てたビルド番号が表示されている事を確認してください。今回はU3dとなっているはずです。</p><img src="/new-technology/2025/03/08/ESXi8-Patch/esxi4.png" class="" width="640" title="alt"><p>または、sshでESXiに接続し、<code>vmware -v</code>を実行し確認します。</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost:~] vmware -v</span><br><span class="line">VMware ESXi 8.0.3 build-24585383</span><br></pre></td></tr></table></figure><h2 id="事後作業"><a href="#事後作業" class="headerlink" title="事後作業"></a>事後作業</h2><p>これまで実施してきたメンテナンス準備とは反対の作業をします。メンテナンスモードの終了・SSHの無効化・仮想マシンの起動と続けます。</p>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2025/03/08/ESXi8-Patch/title.png&quot; class=&quot;&quot; title=&quot;alt&quot;&gt;
&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;

&lt;p&gt;無償版ESXi（VMware vSphere Hypervisor）について、VMWareのサイトから製品パッチをESXi本体から直接ダウンロードし、ESXi上でパッチを適用します。この記事ではESXi8.0を対象にしていますが、コマンド自体はESXi7.0も変わりません。従来は、BroadcomからパッチをダウンロードしESXiに適用する方法でしたが、ESXi8 Update3dから、少し対応しづらくなってきたので別の方法を紹介します。&lt;/p&gt;</summary>
    
    
    
    <category term="Software" scheme="https://yoshi0808.github.io/new-technology/categories/Software/"/>
    
    
    <category term="ESXi" scheme="https://yoshi0808.github.io/new-technology/tags/ESXi/"/>
    
  </entry>
  
  <entry>
    <title>UniFiスイッチ アクセスコントロール</title>
    <link href="https://yoshi0808.github.io/new-technology/2025/02/11/unifi-sw-l3/"/>
    <id>https://yoshi0808.github.io/new-technology/2025/02/11/unifi-sw-l3/</id>
    <published>2025-02-10T18:13:30.000Z</published>
    <updated>2025-02-11T08:09:10.290Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2025/02/11/unifi-sw-l3/title.png" class="" width="1024" title="alt"><p class="onepoint">この記事で実現すること</p><p>この記事ではホームユーザー向けにUniFiスイッチのL3レイヤおよびL2レイヤアクセスコントロール（ACL）の機能を紹介します。</p><span id="more"></span><h2 id="UniFiスイッチの一般的な使い方"><a href="#UniFiスイッチの一般的な使い方" class="headerlink" title="UniFiスイッチの一般的な使い方"></a>UniFiスイッチの一般的な使い方</h2><p>UniFiスイッチにはPro AggregationなどのL3スイッチ機能を持つものがあり、異なるサブネットへのルーティングが出来ます。もっとも個人向けのUniFiではDream MachineなどのUniFiゲートウェイを中心として複数のサブネットにルーティングするデザインが一般的です。<br>それに対して、CloudKey+などのゲートウェイ無しのコンソールで配下のスイッチ・AP・監視カメラを管理するスタイルで別途ホームゲートウェイに接続したり、別のセキュリティゲートウェイ（firewall）を用意するケースもあるでしょう。</p><p>Ubiqutiがお勧めするのは前者であり、UniFiゲートウェイで配下の端末やアクセスコントロールを集中管理できるのがメリットとしています。管理がとても楽なのは間違いありません。</p><h2 id="L3ネットワーク"><a href="#L3ネットワーク" class="headerlink" title="L3ネットワーク"></a>L3ネットワーク</h2><p>少し煩雑でもできるだけ用途別のトラフィックを1つのサブネットに留めておきたいというニーズはあると思います。必ずしもインターネットを利用しない端末やサーバーのバックアップなど、仮想マシンから複数の足を出してユーザーが利用するネットワーク、バックアップ専用ネットワークと使い分けたりします。こういった用途はスイッチの単位でトラフィックを閉じ込める事もできますが、ゲストや家族向けなど複数のスイッチに跨ってアクセスコントロールが必要な場合もあります。</p><p>以下は一例（私の自宅の環境）です。</p><img src="/new-technology/2025/02/11/unifi-sw-l3/L3.drawio.png" class="" width="480" title="alt"><ul><li>Serverセグメントには仮想サーバー群、NASが設置してあります</li><li>FamilyセグメントはiOS、Windowsを中心に家族が利用する端末があります。</li><li>GuestセグメントはIoT、会社の端末が接続します。</li></ul><p>これらは全てタグ有り（デフォルト1以外のタグ）のネットワークで構成されています。タグ無しのデフォルトネットワークはUniFiのCloudkeyと監視カメラ、メインの仮想マシン（ESXi）が接続されています。こういったセグメント構成は個人向けとしてはよくある形ではないかと思います。<br>それでGuestは当然、ServerやFamilyと繋ぐ必要はない一方で、FamilyからServerへのアクセスは必要となります。セグメントを超える場合（ルーティングする場合）はすべからくゲートウェイ（firewall）を経由するネットワークデザインも有りなんですが、macOSからNASへのバックアップ（TimeMachine）などやはり様々なデータフローがあるので、全てをゲートウェイ経由というのは少しやりすぎではないかと思うのです。そこで私の場合は、L3スイッチを効果的に使うべく、FamilyからServerへのセグメント越えはL3スイッチを使ったルーティングにしています。</p><h2 id="L3ネットワークの作成"><a href="#L3ネットワークの作成" class="headerlink" title="L3ネットワークの作成"></a>L3ネットワークの作成</h2><p>以下のようにコンソールのネットワークを開きます。</p><img src="/new-technology/2025/02/11/unifi-sw-l3/network1.png" class="" width="800" title="alt"><p>すでに構成されたセグメントを見るとわかるように、どのL3スイッチ上にL3ネットワークを作るかを指定します。<br>作り方は簡単で、<mark class="label primary">New Virtual Network</mark>をクリックし、赤枠で囲ったL3スイッチを選択し、新たなセグメントで割り当てるスイッチ自身のIPアドレス、VLAN IDを指定するだけです。</p><img src="/new-technology/2025/02/11/unifi-sw-l3/network2.png" class="" width="1024" title="alt"><mark class="label primary">Auto-Scale Network</mark>のチェックは外し、Host IP Addressを新しいセグメントのIPアドレスを指定します。一般的な24ビットのネットワークであれば第3オクテットの数字を10などとしてスイッチのIPを決めます。またVLAN IDもそれに合わせておいた方がわかりやすいですね。<p>なお、UniFiのL3スイッチはDHCP機能を持ちますので、簡易にIPv4アドレスをホストに割り当てたい場合には利用できます。但し、DHCPオプションの高度な事はできませんし、IPv6の割り当て機能もありません。</p><p>インターネットにルーティングするためのデフォルトゲートウェイの指定以外に、このようにL3スイッチ経由で特定のセグメントにルーティングするならばスタティックルーティングの設定が個々の端末に必要になります。このためにはDCHPサーバーにOption121によるスタティックルーティングの情報を登録する必要があるのですが、今のUniFi Consoleにはそれを設定する機能がありません。<br>そういうわけで私はスイッチのDHCPを使わず、firewallのDHCPを利用してスタティックルーティングの情報を各端末に配布しています。同様にIPv6もfirewall側で配布しています。</p><p>なお、UniFiのL3にはInter-VLANと呼ばれる、UniFi以外のゲートウェイにルーティングするための専用VLAN（4040）が存在します。L3スイッチから直接ゲートウェイの指定IPにルーティングする機能があり、これを併用すれば端末のデフォルトゲートウェイをスイッチにしてさえおけば、個別のスタティックルーティングの設定は不要になります。今回の記事ではこの説明は割愛します。</p><h2 id="L3アクセスコントロール"><a href="#L3アクセスコントロール" class="headerlink" title="L3アクセスコントロール"></a>L3アクセスコントロール</h2><p>さて、本題です。UniFiではL3レイヤのACLとL2レイヤのACLが可能です。L3レイヤのACLは当然L3スイッチを対象としていますが、L2の方は、USW-Flex-Miniなどの小型スイッチ以外のL2スイッチについて対応しています。</p><p>L3の方は簡単です。<mark class="label primary">L3 Network Isolation (ACL)</mark>で、<mark class="label primary">Source Network</mark>から見て、<strong>接続できない（Isolate）</strong>ネットワークを指定するだけです。</p><img src="/new-technology/2025/02/11/unifi-sw-l3/network3.png" class="" width="800" title="alt"><p>ここでは、Guestから隣接するL3ネットワーク全てに接続できないという指定をしています。<mark class="label primary">L3 Network Isolation</mark>から<mark class="label primary">Create Entry</mark>をクリックして作成します。</p><img src="/new-technology/2025/02/11/unifi-sw-l3/network4.png" class="" width="480" title="alt"><p>これでGuestセグメントから他のセグメントへのルーティングは出来なくなりました。</p><h2 id="L2アクセスコントロール"><a href="#L2アクセスコントロール" class="headerlink" title="L2アクセスコントロール"></a>L2アクセスコントロール</h2><p>今度はL2、MACアドレスレベルのACLです。今や端末のMACアドレスを指定してアクセス制御するというのは手間が大変なので実施しなくなってきています。唯一使うケースはゲートウェイを除いて他の端末とは相互にアクセスしない(Isolated)、これに尽きるのではないでしょうか。ゲストネットワークではそれを利用するニーズがあるでしょう。</p><p>元々Wi-FiのレベルではIsolationを有効にする機能はありました。たとえば飲食店向けにWi-Fiをゲストに開放し、管理用端末は有線LANとしておくことで目的は達成できます。</p><img src="/new-technology/2025/02/11/unifi-sw-l3/network5.png" class="" width="480" title="alt"><p>これは対象Wi-Fiに<mark class="label primary">Client Device Isolation</mark>のチェックをするだけでとても簡単に実現できていました。</p><p>しかしながら自宅でゲスト向けの有線端末を使う場合は、無線端末と有線端末とは相互にアクセスできる状況にありました。私の場合、会社の端末やIoTは私の情報資産があるネットワークと分離できていることが必須と考えていましたが、自宅のIoTと会社の端末が同一ネットワークで相互にアクセス可能なのは少し気になるところでした。</p><p>これは、UniFiゲートウェイを利用されている方はとても簡単で、前述した<mark class="label primary">Network</mark>の<mark class="label primary"> Switch Isolation Settings</mark>の<mark class="label primary">Device Isolation(ACL)</mark>にチェックを入れるだけで実現できます。<br>これでインターネットへの接続は可能な状態で同一セグメントの端末同士のアクセスが行えなくなります。</p><p>独自のfirewallなどのゲートウェイを使っている方は少し工夫が必要です。前述した方法だと、UniFiはどのMacアドレスがゲートウェイなのか理解できないため、ゲートウェイ宛のパケット（およびDHCPなどのIP割り当て）もフィルタされてしまいます。</p><p>私のように独自ゲートウェイ（firewall）を利用している方は、別の方法でACLを実現します。</p><p>UniFiの<mark class="label primary">Security</mark>メニューから<mark class="label primary">ACL</mark>を選びます。<br>以下の赤枠で囲ったところが相互にアクセスできないようにするACLのリストです。</p><img src="/new-technology/2025/02/11/unifi-sw-l3/network6.png" class="" width="1024" title="alt"><p>まず、ここでは、ゲートウェイのMACアドレスは”00:0c:29:02:7c:96”とします（私の仮想環境ESXi上のFirewall兼DNS兼DHCP）。<br>L2 ACLルールの中身は以下の通りです。</p><ol><li>Source Any(全ての端末)からDestination”firewall”のアクセスを許可します。</li><li>Source　”firewall”からDestination Anyのアクセスを許可します。</li><li>Source AnyからDestination MACアドレスff:ff:ff:ff:ffのアクセスを許可します。これはarpによるIPアドレスからMACアドレスの解決に必要です。</li><li>Source AnyからDestination Anyを拒否します。</li></ol><p>なお、スイッチにSSHして確認すると以下のように定義されています。（GuestのVLAN IDは***としています）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mac access-list extended global_mac_acl</span><br><span class="line">permit any 00:0c:29:02:7c:96 00:00:00:00:00:00 vlan eq ***</span><br><span class="line">permit 00:0c:29:02:7c:96 00:00:00:00:00:00 any vlan eq ***</span><br><span class="line">permit any ff:ff:ff:ff:ff:ff 00:00:00:00:00:00 vlan eq ***</span><br><span class="line">deny any any vlan eq ***</span><br><span class="line">permit any any</span><br></pre></td></tr></table></figure><p>これで対象のネットワークでインターネットだけを許可し、その他無線、有線違いのアクセスはできなくなります（Flex miniを除いては）。<br>この設定は2024年11月7日のUNA8.6.9（Official）から有効になったようです。</p><blockquote><p>UniFi リリース<br> <a href="https://community.ui.com/releases/UniFi-Network-Application-8-6-9/e4bd3f71-a2c4-4c98-b12a-a8b0b1c2178e">https://community.ui.com/releases/UniFi-Network-Application-8-6-9/e4bd3f71-a2c4-4c98-b12a-a8b0b1c2178e</a><br> Fixed an issue where MAC ACLs didn’t function correctly when using any as source or destination.</p></blockquote><p>私の自宅にはUniFi Switchが6台とAPが2台ありますが、Flex miniを除き、一括で全てのスイッチにコンフィグを流し込んでくれるのは改めて便利だなと感じるところです。</p><p>なお、ご参考までに、IPv4単位のフィルタも可能です。先ほどのACLに最終2行に記載してあります。</p><ol><li>192.168.1.128&#x2F;25から192.168.2.0&#x2F;24を許可</li><li>192.168.1.0&#x2F;24から192.168.2.0&#x2F;24を拒否</li></ol><p>このように、192.168.1.0&#x2F;24の後半128個のサブネットから192.168.2.0&#x2F;24セグメントへのアクセスは許可し、192.168.1.0&#x2F;24の前半のサブネットから192.168.2.0&#x2F;24へのアクセスは拒否するといったACLが実現可能です。</p>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2025/02/11/unifi-sw-l3/title.png&quot; class=&quot;&quot; width=&quot;1024&quot; title=&quot;alt&quot;&gt;
&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;

&lt;p&gt;この記事ではホームユーザー向けにUniFiスイッチのL3レイヤおよびL2レイヤアクセスコントロール（ACL）の機能を紹介します。&lt;/p&gt;</summary>
    
    
    
    <category term="Hardware" scheme="https://yoshi0808.github.io/new-technology/categories/Hardware/"/>
    
    <category term="Network" scheme="https://yoshi0808.github.io/new-technology/categories/Network/"/>
    
    
    <category term="UniFi" scheme="https://yoshi0808.github.io/new-technology/tags/UniFi/"/>
    
  </entry>
  
  <entry>
    <title>Sophos Firewall v21でLet&#39;s Encrypt™️と3rdパーティ脅威情報を使う</title>
    <link href="https://yoshi0808.github.io/new-technology/2024/10/27/xg-v21/"/>
    <id>https://yoshi0808.github.io/new-technology/2024/10/27/xg-v21/</id>
    <published>2024-10-26T23:00:00.000Z</published>
    <updated>2024-11-01T23:06:39.199Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2024/10/27/xg-v21/Title.png" class="" title="alt"><h2 id="Sophos-Firewall-v21"><a href="#Sophos-Firewall-v21" class="headerlink" title="Sophos Firewall v21"></a>Sophos Firewall v21</h2><p>Sophos Firewall v21が2024年10月17日に発表されました。今回はビジネスユーザーはもちろん、ホームユーザーにとっても大きな進化がありました。Let’s Encryptの自動更新を含む対応と3rdパーティの脅威情報（こちらも自動更新）を取り込め、積極的な通信遮断を行えるようになっています。</p><span id="more"></span><p>v21の詳細な説明はSophos Communityを参照してください。</p><blockquote><p><a href="https://community.sophos.com/sophos-xg-firewall/b/blog/posts/sophos-firewall-v21-is-now-available">https://community.sophos.com/sophos-xg-firewall/b/blog/posts/sophos-firewall-v21-is-now-available</a></p></blockquote><p>リリースノートはこちらです</p><blockquote><p><a href="https://docs.sophos.com/releasenotes/index.html?productGroupID=nsg&productID=xg&versionID=21.0">https://docs.sophos.com/releasenotes/index.html?productGroupID=nsg&amp;productID=xg&amp;versionID=21.0</a></p></blockquote><h2 id="Sophos-Firewallのアップデート"><a href="#Sophos-Firewallのアップデート" class="headerlink" title="Sophos Firewallのアップデート"></a>Sophos Firewallのアップデート</h2><p>さて、最初にSophos Firewallのアップデート方法について記載します。</p><p>管理画面にログイン後、左ペインメニューの<mark class="label primary">バックアップ＆ファームウェア</mark>の<mark class="label primary">ファームウェアの確認</mark>でアップデートの案内が順次来ます。直ちにファームウェアのアップグレードの案内が来るわけでは無さそうです。ファームウェア公開後すぐの場合は個別にバージョンアップのファイルを入手します。</p><p>個別にバージョンアップのファイルを入手するには、以下のURLからダウンロードします。</p><p><a href="https://support.sophos.com/support/s/article/KBA-000007972?language=ja">https://support.sophos.com/support/s/article/KBA-000007972?language=ja</a></p><ol><li>上記画面で<mark class="label primary">Sophos Firewall</mark>の<mark class="label primary">ファームウェア</mark>の<mark class="label primary">ソフトウェア</mark>のLinkをクリックします。</li><li>“SW-21.0.0_GA.SFW-169.sig”をダウンロードします。</li><li>Sophos Firewallの管理画面にログインし、左ペインメニューの<mark class="label primary">バックアップ＆ファームウェア</mark>の<mark class="label primary">ファームウェアのタブメニュー</mark>から以下の画面に赤丸で囲った矢印のアイコンをクリックし、ダウンロードしたモジュールをアップロードします。</li></ol><img src="/new-technology/2024/10/27/xg-v21/verup.png" class="" width="800" title="alt"><p>アップロード＆再起動ボタンをクリックし、v21へのアップグレードを完了させます。</p><h2 id="Let’s-Encrypt"><a href="#Let’s-Encrypt" class="headerlink" title="Let’s Encrypt"></a>Let’s Encrypt</h2><p>Let’s Encrypt は、非営利団体のInternet Security Research Group(ISRG)が提供する認証局でTLS暗号用の証明書を無償で提供しています。ただし、有効期限が90日と短めで頻繁に証明書の再生成が必要です。</p><p>Sophos Firewallの画面上にアクセスする際に独自ホスト名やそもそもIPアドレスでのアクセスをしているとユーザーに対する警告メッセージを表示する際に証明書エラーと表示されてしまいます。自分だけが利用するなら無視もできますが、家族で使ってもらっていてエラーの度に証明書エラーで不安にさせては本末転倒です。</p><p>Sophos Firewallの広告ブロック時のお馴染みの画面です。既にLet’s Encryptの証明書が有効になっていますが、この一手間を掛けないとコンテンツブロック時にブラウザに証明書エラーの表示がされてしまいます。</p><img src="/new-technology/2024/10/27/xg-v21/block.png" class="" width="800" title="alt"><p>生成にはLet’s Encrypt独自のお作法があり、正当なネームサーバーの管理下にサーバーが実在していることが求められます。そこにISRGからインターネットで接続可能な状態になければなりません。これはいくつかの方法がありますが、よく利用されるケースでは、 ISRGから提供される証明書生成ツールを使い、そのサーバー上にWebサーバープロセスを立ち上げ、ISRGからのリクエストに応答するというものです。ISRGがWebサーバーに到達できることが確認できたら証明書を生成してくれます。</p><p>結局、ホームユーザーはこれをするために、ダイナミックDNS（DDNS）の契約や個別ドメインを契約したり、Let’s Encryptが面倒ということで有償の独自SSL&#x2F;TLSを取得したりして手間とコストが掛かっていました。私の場合は、NO-IPで無償DDNSを利用し、Sophos FirewallでパブリックIPアドレスの自動更新をさせていました。そして90日に一度、手作業でLet’s Encryptのスクリプトを起動させて証明書を更新していました。</p><p>その際の手順としては、UbuntuでLet’s Encryptスクリプトを起動し、Sophos FirewallではDNAT（Destination NAT）を手動設定し、 InternetからFirewallのPort80に着信したら、Ubuntuに振り向けるようにしていました。さらにUbuntuで証明書が出来たら一旦、クライアントに証明書セットをダウンロードし、それをFirewallにアップロードしていました。生産性としては今ひとつです。SynologyのNASなどは全自動でやってくれますね。</p><p>これがv21からは最初に設定さえしておけば、Let’s Encryptの期限が来ると自動更新までやってくれ、とても便利です。<br>Webサーバーを立ち上げていらっしゃる方はIDS&#x2F;IPS代わりにSophos Firewall上でTLS暗号化されたPort443として受信し、リクエストを内部のWebサーバー(http)に転送することで、WebサーバーのTLS&#x2F;SSL証明書の取得の手間を省くことも容易です。</p><h3 id="Firewall上でのLet’s-Encryptの設定"><a href="#Firewall上でのLet’s-Encryptの設定" class="headerlink" title="Firewall上でのLet’s Encryptの設定"></a>Firewall上でのLet’s Encryptの設定</h3><p>まず管理者画面にログイン後、左ペインの<mark class="label primary">証明書</mark>のメニューに入ります。<br>新しく「Let’s Encrypt™️」のタブが新たに登場していますのでそのタブを選択します。</p><img src="/new-technology/2024/10/27/xg-v21/le1.png" class="" width="800" title="alt"><mark class="label primary">アカウントの登録</mark>ボタンをクリックし、登録が完了します。<p>続いて証明書のタブに戻ります。</p><p>以下のように<mark class="label primary">アクション</mark>では<mark class="label primary">Let's Encrypt証明書のリクエスト</mark>を選択し、<mark class="label primary">ドメイン</mark>の箇所にはDDNSまたはDNSのAレコードとして登録されたホスト名＋ドメイン名（いわゆるFQDN）を登録し、<mark class="label primary">ホスト型アドレス</mark>の場所はWANのPortを指定します。</p><img src="/new-technology/2024/10/27/xg-v21/le2.png" class="" width="800" title="alt"><p>これで保存すると、証明書の生成が行われます。</p><p>登録が終わったら左ペインの<mark class="label primary">管理</mark>のメニューから<mark class="label primary">管理者とユーザーの設定</mark>の<mark class="label primary">管理コンソールとエンドユーザー間の操作</mark>の証明書にLet’s Encryptの証明書を指定します。</p><img src="/new-technology/2024/10/27/xg-v21/le3.png" class="" width="800" title="alt"><mark class="label primary">別のホスト名を指定する</mark>の場所で生成した今回のサーバー名（FQDN）を指定します。<p>なお、Firewallのコンソール（Advanced Shell）から、<code>/log/letsencrypt.log</code>、<code>/log/applog.log</code>でログを確認できます。<br>以下は、letsencrypt.logの結果です。</p><img src="/new-technology/2024/10/27/xg-v21/le4.png" class="" width="800" title="alt"><p>とっても簡単ですね。Firewallの上位にホームゲートウェイ（HGW）がある方は、HGWがInternetからPort80の着信の際にはSophos FirewallのWAN側IPアドレスに転送することを忘れないでください。</p><p>Sophosから、これらを動画にしたものが提供されています。</p><blockquote><p>Sophos Firewall v21:Let’s Encrypt™️<br> <a href="https://techvids.sophos.com/watch/guYyvqKk6ciCkG1A2eHXoR">https://techvids.sophos.com/watch/guYyvqKk6ciCkG1A2eHXoR</a></p></blockquote><h2 id="3rdパーティの脅威情報を活用する"><a href="#3rdパーティの脅威情報を活用する" class="headerlink" title="3rdパーティの脅威情報を活用する"></a>3rdパーティの脅威情報を活用する</h2><p>これまでもSophos Firewallには2種類の脅威フィードが実装されていました。無償のSophos X-Ops脅威フィードと有償のMDR脅威フィードです。セキュリティベンダーはここの情報の鮮度が売りであり、セキュリティビジネスとしてはここの情報がまさに「金の成る木」でしょうか。<br>MDRを契約されている法人ユーザーであれば十分なのかもしれませんが、業界の情報共有などがあるケースもあり、3rdパーティの情報を取り込<br>め、更新される都度、自動で定期的に取り込める機能が付いたのは価値が大きいです。</p><p>Sophos Firewallではマルウェアとして定義された情報がWebポリシーで防御出来たり、ProxyやVPNなどはアプリケーションフィルタでそれなりに未然防御は出来ます。</p><p>個人が無償で高度なセキュリティ情報が得られるほど甘くはありませんが、それでもリスクを減らすことはできるので前向きに考えたいところです。</p><p>Sophos Firewallに取り込める3rdパーティの脅威情報をここでいくつか紹介していきます。</p><h2 id="GreyNoise"><a href="#GreyNoise" class="headerlink" title="GreyNoise"></a>GreyNoise</h2><p>GreyNoiseはインターネット上で悪意あるスキャンや攻撃を行っているIPアドレスを特定し、その活動に関する情報を収集・分析することを支援する脅威インテリジェンスを提供するプラットフォームです。</p><img src="/new-technology/2024/10/27/xg-v21/greynoise.png" class="" width="1024" title="alt"><p>GreyNoiseはWebUIとAPIで使う方法があります。WebUIは以下のURLです。</p><blockquote><p>Grey Noise Web UI<br> <a href="https://viz.greynoise.io/">https://viz.greynoise.io/</a></p></blockquote><p>本日の情報を見てみると国別で多い順にブラジル、中国、インド、アメリカ、ロシアと続きますね。</p><img src="/new-technology/2024/10/27/xg-v21/greynoise1.png" class="" width="1024" title="alt"><p>ブラジルはオリンピックでサイバー攻撃が増えてしまったようですね。ホームユーザーにとってはロシアと中国は殆どアクセス不要だと考えればFirewallの国別フィルタでガッサリとブロックしてしまうのもアリだと思います。<br>左下を見ていくと、最も活動が多いのはクローラー（巡回）で脆弱性を探すタイプですね。ホームユーザーは無闇にポートを解放せず、脆弱性の無いVPNで守っておけば特にクローラー系は怖くはありません。</p><p>ホームユーザーからしてもクローラーやIoTを狙うボットなど、きちんとパッチを当てることに加え、VLANを切ってIoTは別セグメントにしておけば、個人の情報資産が脅かされるリスクは低いですが、取り敢えずこの画面の左下で目につくMiraiについては有名どころですし、クライアントがアクセスした際に感染するリスクがありますからこれは防御しておいても損はありません。Miraiはマルウェアとして活動していて、毎時6,000件の活動が見られるようです。</p><blockquote><p>Miraiについて<br> IoT機器に感染した機器同士を連携させて１つの攻撃対象に一斉攻撃を仕掛ける体制（ボットネット）を作成します。攻撃者は外部のC&amp;Cサーバーから、そのボットネットに指示を出すことでDDoS（Distributed Denial of Service attack）攻撃を行います。</p></blockquote><p>IoTの攻撃よりもランサムウェアの方が個人にとっては脅威です。今回はMiraiを対象にしましたが、今後定期的に見直しをしていくつもりです。</p><img src="/new-technology/2024/10/27/xg-v21/greynoise2.png" class="" width="1024" title="alt"><p>GreyNoiseはサインアップすると、1つのタグだけは無償でFirewallに取り込むことができます。<br>BLOCKLIST URLの右側のコピーアイコンをクリックするとAPIのパスが取得できます。</p><p>サインアップ<br><a href="https://viz.greynoise.io/signup">https://viz.greynoise.io/signup</a></p><h2 id="CrowdSec"><a href="#CrowdSec" class="headerlink" title="CrowdSec"></a>CrowdSec</h2><p>CrowdSecも同様にセキュリティベンダーです。コミュニティにも理解があり、無償のセキュリティエンジンなどを提供しています。しかしこちらもやはり価値のあるブロックリストは有償が基本であってコミュニティベースで寄せられた情報のみがコミュニティに無償で提供されます。</p><img src="/new-technology/2024/10/27/xg-v21/Crowdsec1.png" class="" width="800" title="alt"><p>アカウントを作成、ログインしてから左上のBlockListsを選択すると、BlockListのカタログを選択することになります。<br>Freeで絞り込むとTorのBlockListカタログなどを見つけられます（Proxyといっても差し支えありませんが、Torが頻繁に更新されることを考えると価値はあるでしょう）。タイミングによってでしょうけれども、CrowdSecが提供しているPHPの脆弱性（CVE-2024-4577）に対応したカタログなどがFreeとして公開されていますね。これは最近、日本国内の某フードデリバリーの企業でも問題になったマイニングマルウェアのRedTailが該当しますね。</p><img src="/new-technology/2024/10/27/xg-v21/Crowdsec3.png" class="" width="800" title="alt"><blockquote><p>Torについて<br> 通信の秘匿性を担保するために作られた技術ですが、現在はサイバー攻撃などを中心にダークウェブへのアクセス手段として利用されています。善良な民間人は興味本位で近づかないことをお勧めします。</p></blockquote><p> サインアップ<br> <a href="https://app.crowdsec.net/signup">https://app.crowdsec.net/signup</a></p><h3 id="ブロックリストの購読"><a href="#ブロックリストの購読" class="headerlink" title="ブロックリストの購読"></a>ブロックリストの購読</h3><p>ブロックリストの購読をした後（最大３つ）、インテグレーションを行い、Sophos Firewallに取り込み準備をします。</p><img src="/new-technology/2024/10/27/xg-v21/Crowdsec4.png" class="" width="1024" title="alt"><mark class="label primary">Blocklists</mark>→<mark class="label primary">Integrations</mark>→<mark class="label primary">Add Integration</mark>と進みます。<mark class="label primary">Where do you want to use blocklists?</mark>と聞かれますので、<mark class="label primary">Sophos</mark>を選択します。続いて<mark class="label primary">Create</mark>ボタンをクリックして生成します。<p>以下のようにダイアログが表示されますのでこれを後述するSophos Firewallの設定でコピーペーストして設定を完了させることになります。</p><img src="/new-technology/2024/10/27/xg-v21/Crowdsec5.png" class="" width="640" title="alt"><h2 id="その他"><a href="#その他" class="headerlink" title="その他"></a>その他</h2><p>その他はURLhausやDigitalSide Threat-Intelといったコミュニティベースの情報をFirewallに取り込めます。</p><blockquote><p>URLhaus<br> <a href="https://urlhaus.abuse.ch/">https://urlhaus.abuse.ch</a></p></blockquote><blockquote><p>DigitalSide Threat-Intel<br> <a href="https://osint.digitalside.it/">https://osint.digitalside.it/</a> </p></blockquote><p>ここでは詳細説明を割愛します。これら２つはサインアップ不要で脅威フィードを公開しています。<br>そのレベルとしては、MicrosoftのEdgeブラウザで提供されているスマートスクリーン相当とお考えください。<br>それでもSophos Firewall単体で取りこぼすケースもカバーしています（無論、古すぎる情報で無視して良いものもたくさんあります）。</p><h2 id="Firewallに3rdパーティの脅威情報を取り込む"><a href="#Firewallに3rdパーティの脅威情報を取り込む" class="headerlink" title="Firewallに3rdパーティの脅威情報を取り込む"></a>Firewallに3rdパーティの脅威情報を取り込む</h2><p>Firewallの左ペインメニューから<mark class="label primary">アクティブな脅威対応</mark>を選択します。</p><img src="/new-technology/2024/10/27/xg-v21/sf1.png" class="" width="1024" title="alt"><p>サードパーティの脅威フィードは、ブロックと監視対象との2種類があります。前述したOSINTなどは数も多いので一旦は監視対象にしていきなりブロックはせずに様子を見る事もできます。</p><p>ここで追加ボタンをクリックして前述した3rdパーティの脅威情報を取り込みます。</p><img src="/new-technology/2024/10/27/xg-v21/sf2.png" class="" width="480" title="alt"><mark class="label primary">アクション</mark>は前述したブロックかモニタを選択します。<mark class="label primary">インジケータの種類</mark>は、Grey NoiseやCrowdSecはIPv4アドレスを指定します。その他の脅威フィードではドメインやURLを指定する場合もあります（私は、URL_HausとOSINTではURLを指定しています）。<mark class="label primary">外部URL</mark>は、Grey Noise、CrowdSecで指定されたURL（APIのパス）を指定します。<mark class="label primary">承認</mark>は認証の有無です。GreyNoiseは認証無し、CrowdSecは前述したようにインテグレーションしたIDとパスワードを指定します。<mark class="label primary">ポーリング間隔</mark>は、GreyNoiseは1時間を、CrowdSecはCommunityユーザーは2時間に1度のフェッチが（今の所）認められているので、6時間を指定します。<p>私の場合、これら４つの脅威情報を取り込み、現時点では11,362IPアドレス、46722URLが登録されています。</p><h2 id="脅威情報の留意点"><a href="#脅威情報の留意点" class="headerlink" title="脅威情報の留意点"></a>脅威情報の留意点</h2><p>前述したようにSophos FirewallでIPアドレスは取り込めますが、現時点ではIPアドレスはIPv4のものだけであることに注意が必要です。</p><p>また、URLで取り込む場合、これはURLhaus、OSINTなどがURLで提供してくれていますが、サイトがhttps（SSL&#x2F;TLS）の場合はURLも暗号化されていますからSSL&#x2F;TLSインスペクションの機能が必要になります。すなわち、SSL&#x2F;TLSインスペクションの対応クライアント（Fierwallの自己証明書をクライアントに取り込めている場合）のみがURLのブロックが行えることに注意する必要があります。<br>私の環境では、Apple製品（iOS,iPad,macbook）、Windows、Linux（Ubuntu）で動作確認しています。Android、ChromeBook、IoTはSSL&#x2F;TLSインスペクションは利用できません。</p><p>SSL&#x2F;TLSインスペクションについては、以下の記事で解説、またSophos Firewallでの具体的な設定についてまとめています。それなりに手間が掛かることになりますから、面倒な方はURLではなく、IPアドレスで取り込む方法でも代替にはなります（IPv6は対象となりませんが）。</p><ul><li><a href="/new-technology/2020/03/20/ssl-inspection/" title="SSLインスペクションについて">SSLインスペクションについて</a></li><li><a href="/new-technology/2020/03/20/ssl-inspection1/" title="XG Firewall v18のSSL&#x2F;TLSインスペクションの設定">XG Firewall v18のSSL&#x2F;TLSインスペクションの設定</a></li><li><a href="/new-technology/2020/03/21/ssl-inspection2/" title="XG Firewall v18のSSLインスペクションの動作確認と調整">XG Firewall v18のSSLインスペクションの動作確認と調整</a></li></ul><h2 id="ログ出力"><a href="#ログ出力" class="headerlink" title="ログ出力"></a>ログ出力</h2><p>Firewallのログにも<mark class="label primary">アクティブな脅威対応</mark>のフィルタが追加されています。</p><img src="/new-technology/2024/10/27/xg-v21/sf3.png" class="" width="1024" title="alt"><p>これらのように、httpsであっても検出できていることやDrop、Alertという区別がついています。OSINT、URL_Hausともに重複して検知しているケースも確認できます。</p>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2024/10/27/xg-v21/Title.png&quot; class=&quot;&quot; title=&quot;alt&quot;&gt;

&lt;h2 id=&quot;Sophos-Firewall-v21&quot;&gt;&lt;a href=&quot;#Sophos-Firewall-v21&quot; class=&quot;headerlink&quot; title=&quot;Sophos Firewall v21&quot;&gt;&lt;/a&gt;Sophos Firewall v21&lt;/h2&gt;&lt;p&gt;Sophos Firewall v21が2024年10月17日に発表されました。今回はビジネスユーザーはもちろん、ホームユーザーにとっても大きな進化がありました。Let’s Encryptの自動更新を含む対応と3rdパーティの脅威情報（こちらも自動更新）を取り込め、積極的な通信遮断を行えるようになっています。&lt;/p&gt;</summary>
    
    
    
    <category term="Security" scheme="https://yoshi0808.github.io/new-technology/categories/Security/"/>
    
    
    <category term="XG Firewall" scheme="https://yoshi0808.github.io/new-technology/tags/XG-Firewall/"/>
    
  </entry>
  
  <entry>
    <title>Xiaomi Smart Band 9を活用する</title>
    <link href="https://yoshi0808.github.io/new-technology/2024/09/23/miband9/"/>
    <id>https://yoshi0808.github.io/new-technology/2024/09/23/miband9/</id>
    <published>2024-09-22T23:28:19.000Z</published>
    <updated>2024-10-31T11:24:19.777Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2024/09/23/miband9/title.png" class="" width="1024" title="alt"><h2 id="MIスマートバンド9（MI-band9）"><a href="#MIスマートバンド9（MI-band9）" class="headerlink" title="MIスマートバンド9（MI band9）"></a>MIスマートバンド9（MI band9）</h2><p>2024年に発売となったXiaomi Smartband 9（Band9）を使って健康促進のための使い方を初級者向けに紹介します。このブログでも過去にBand 5,6はレビューしてきて、久しぶりのMI bandです。これまではZepp Lifeと呼ばれるスマホアプリで操作していましたが、Band8からはMI Fittnessというアプリに変わっています。ここでは昨年発売されたBand8との比較もします。</p><span id="more"></span><h2 id="Band9の主な機能"><a href="#Band9の主な機能" class="headerlink" title="Band9の主な機能"></a>Band9の主な機能</h2><p>主な機能としては以下の通りです。</p><table><thead><tr><th>大項目</th><th>分類</th><th>機能</th></tr></thead><tbody><tr><td>バッテリー接続時間</td><td>通常使用時</td><td>21日間</td></tr><tr><td></td><td>Display ON</td><td>9日間</td></tr><tr><td>ヘルス</td><td></td><td>日々の活動記録</td></tr><tr><td></td><td></td><td>心拍数モニタリング</td></tr><tr><td></td><td></td><td>血中酸素モニタリング</td></tr><tr><td></td><td></td><td>睡眠モニタリング</td></tr><tr><td></td><td></td><td>ストレスモニタリング</td></tr><tr><td></td><td></td><td>月経周期リマインド</td></tr><tr><td></td><td></td><td>深呼吸トレーニング</td></tr><tr><td>スポーツ</td><td></td><td>150以上のスポーツモード</td></tr><tr><td>機能</td><td></td><td>ミュージックコントロール</td></tr><tr><td></td><td></td><td>アラーム</td></tr><tr><td></td><td></td><td>タイマー</td></tr><tr><td></td><td></td><td>ストップウォッチ</td></tr><tr><td></td><td></td><td>フラッシュライト</td></tr><tr><td></td><td></td><td>天気</td></tr><tr><td></td><td></td><td>イベント</td></tr><tr><td></td><td></td><td>タスク</td></tr><tr><td></td><td></td><td>スマホを探す</td></tr><tr><td></td><td></td><td>世界時計</td></tr><tr><td></td><td></td><td>集中</td></tr><tr><td></td><td></td><td>カメラシャッター</td></tr></tbody></table><p>スペックは以下の通りです。</p><table><thead><tr><th>項目</th><th>内容</th></tr></thead><tbody><tr><td>サイズ</td><td>46.53 × 21.63 × 10.95 mm（ストラップ除く）</td></tr><tr><td>重量</td><td>15.8g（ストラップ除く）、27g（ストラップ含む、実測）</td></tr><tr><td>ストラップ</td><td>TPU（シリコン）</td></tr><tr><td>ディスプレイ</td><td>1.62インチ</td></tr><tr><td>解像度</td><td>192 × 490 ピクセル</td></tr><tr><td>輝度</td><td>最大1200nits（調節可）</td></tr><tr><td>バッテリー</td><td>最大21日間</td></tr><tr><td>バッテリー容量</td><td>233mAh</td></tr><tr><td>防水性能</td><td>5ATM</td></tr></tbody></table><p>引き続きGPSは搭載していません。厳密な距離を測るならスマホも同時に持ち出す必要があります。ですが、スマホがなくとももちろん十分活用可能です。何より寝ている時も身につけることを考えると軽くてサイズが小さく、バンドがしなやかなものが最適です。</p><h3 id="Band8と9との比較"><a href="#Band8と9との比較" class="headerlink" title="Band8と9との比較"></a>Band8と9との比較</h3><table><thead><tr><th>項目</th><th>Band9</th><th>Band8</th></tr></thead><tbody><tr><td>ボディ素材</td><td>アルミニウム</td><td>強化ファイバーポリマー</td></tr><tr><td>画面輝度</td><td>1200ニト</td><td>600ニト</td></tr><tr><td>バッテリー</td><td>233mAh</td><td>190mAh</td></tr><tr><td>Bluetooth</td><td>5.4</td><td>5.1</td></tr><tr><td>重さ</td><td>15.8g</td><td>13.5g</td></tr><tr><td>センサー</td><td>ジャイロスコープ、加速度</td><td>高精度 6 軸</td></tr></tbody></table><p>機能的にはBand9とBand8との違いは殆どありません。<br>大きさとしては、Band9の方が1mmほどディスプレイが小さいのですが、殆ど気づくことはありませんし、Band9の方が2gほど重いのですがこれもまた気づきません。<br>バッテリーの持ちは使い方によって大きく変わってきますが、今回この記事で推奨するモニタリングの方法は、ディスプレイは自動点灯（ジャイロセンサーでバンドを見た時に反応）、各種モニタは殆ど詳細機能を有効にし、通知は10件程度&#x2F;日という前提でBand8で7日間弱の持ち、Band9で10日間の持ちでした（毎日1時間弱のウォーキング、12,000歩前後の活動で、シャワー時以外は装着状態で計測しました）。<br>Band8ではジャイロスコープと加速度がセットで6軸センサーになっていたものがBand9では分離していますが、使い勝手に違いは殆ど感じません。若干Band9の方が反応は良さそうですが、気になりません。<br>1200ニトの画面輝度は夏場の日差しがよほど強い状況でなければ視認性には問題ありません。</p><p>曇りの日で外に撮った写真で比較しています。右がBand8、左がBand9です。</p><img src="/new-technology/2024/09/23/miband9/nito.png" class="" width="1024" title="alt"><p>こうやってみると違いはありますが、決定的な違いはありません。バッテリー持ちの違いも合わせて検討する必要がありますが、24時間、睡眠の詳細までフルに記録して1週間程度持ってくれるならBand8でもBand9でもどちらでも殆ど違いはないと考えて良いのではないでしょうか。値段でみると海外通販ではBand8は3,000円台で売っており、Band9は5,000円台ですが、これもまた大きな違いはありません。<br>そもそも、この値段で健康に役立つと考えるならば殆ど誤差でしょう。<br>少しBand9の方が良いと思われる点はデフォルトのディスプレィの表示項目です。左がBand8、右がBand9です。</p><img src="/new-technology/2024/09/23/miband9/display.png" class="" width="320" title="alt"><p>私の場合、実際の消費カロリーや歩数などは具体的数字があった方がありがたいです。Band8のようにオレンジ、黄色、青色のアクティブ指標の視覚的な表示にここまで領域を多く使わなくても良いかなとは感じます。もちろんバンドディスプレイは気に入ったものに変更できます。<br>でもデフォルトが一番良いんですよね。。。</p><p>機能的にBand9のみ持つ機能としては、ランニングコースという機能で、基礎ラン、脂肪燃焼ラン、MIITランなどレベル、強度に合わせたランニングモードを搭載している点です。</p><p>ここから先はBand9を中心に説明しますが、目的は健康になることに主眼を置き使い方を見ていきます。</p><h2 id="健康管理にSmart-Bandを活用する"><a href="#健康管理にSmart-Bandを活用する" class="headerlink" title="健康管理にSmart Bandを活用する"></a>健康管理にSmart Bandを活用する</h2><p>XiaomiのSmart Bandに興味のある方はトレーニングを趣味としているよりは健康に少し気を使いたいユーザーになるかと思います。このブログでも心拍数の機械的な厳格さなどを記載の目的にしていません。どのように健康に活用できるかをテーマにしたいので初級者向けの記事になります。10kmを週3回は走るのが趣味という方は恐らくもっと高度なスマートウォッチなどを利用されていることでしょう。</p><ul><li>運動不足と感じる方</li><li>痩せたいと考えている方</li><li>心拍機能を強化したい方</li><li>健康管理全般（血圧、ストレス、睡眠）</li></ul><p>私もコロナ禍の時は大半がリモートワークだったので、5kmくらいを30分強程度でゆっくりと走っていましたが、今は殆ど出社していることもあり、殆ど走らなくなってしまいました。特にデスクワークの方は気付かないうちに運動不足になっていってしまいます。</p><p>私の場合、運動（減量）しようと決めた期間は24時間バンドは着けたままにしています。睡眠も大事です。運動不足だと良い睡眠も取れない実感があります。目標が達成したら、寝ている時は外したりもしますが着けている限りは努力しようというか少し気が引き締まる感じもあります。</p><p>いきなり走るのは。。。と躊躇される方もいらっしゃるかと思います。ウォーキングだけでも十分効果はあります。Smart Bandでは心拍機能の向上を目指したり運動強度の分類も確認できるようになっていますが、ここではできるだけ体に大きな無理をせずに健康になることを目指したいと思います。何より怪我をしては元も子もありません。最初はウォーキング、そして軽いジョギングまでを説明していきます。</p><p>今年の夏も、早朝であっても暑くて運動するのは難しかったですが、9月になり朝や夕方は随分涼しくなってきました。夏はエアコンの部屋で大人しくしていた方も良い季節になりましたのでSmart Bandを活用されてはいかがでしょうか。</p><h2 id="Smart-Bandのセットアップ"><a href="#Smart-Bandのセットアップ" class="headerlink" title="Smart Bandのセットアップ"></a>Smart Bandのセットアップ</h2><p>パッケージの内容は以下になります。</p><img src="/new-technology/2024/09/23/miband9/package.png" class="" width="480" title="alt"><p>バンドの充電のためにUSB Type-Aの充電器が必要です。最初にバンドの電源をOnにするには充電開始する必要があります。充電が開始されるとバンドの電源がOnになります。</p><p>バンドで日本語を選択すると、スマホアプリのセットアップのためにQRコードが表示されます。</p><img src="/new-technology/2024/09/23/miband9/setup1.png" class="" width="320" title="alt"><p>ここからMi Fitnessアプリをダウンロードします。ここではiPhoneでの操作を説明しています。</p><img src="/new-technology/2024/09/23/miband9/setup2.png" class="" width="320" title="alt"><p>Mi Fitnessを起動し、アカウントを作成します。その後、バンドとスマホとを接続します。スマホのBluetoothを有効にしておきます。</p><img src="/new-technology/2024/09/23/miband9/setup3.png" class="" width="320" title="alt"><mark class="label primary">ウェアラブル</mark>から<mark class="label primary">デバイスの追加</mark>とタップし、バンドとペアリングします。<img src="/new-technology/2024/09/23/miband9/setup4.png" class="" width="320" title="alt"><p>続いてバンドのファームウェアをアップデートします。バンドへのダウンロードに15分程度掛かるのでそのまま待ちましょう。</p><img src="/new-technology/2024/09/23/miband9/setup5.png" class="" width="480" title="alt"><p>バンドが再起動してアップデートが実行されます。</p><h2 id="Smart-Bandの初期設定"><a href="#Smart-Bandの初期設定" class="headerlink" title="Smart Bandの初期設定"></a>Smart Bandの初期設定</h2><p>ここから初期設定に入ります。設定の紹介をしながらお勧めの設定をしていきます。</p><ul><li>12日程度の電池持ちを前提（Band9）、6日〜7日程度の電池持ちを前提（Band8）</li><li>24時間詳細情報のモニタリング</li><li>スマホアプリ通知などを設定</li><li>夜間の通知しない時間帯、目覚ましの設定</li></ul><p>Mi Fitnessの<mark class="label primary">デバイス</mark>メニューからバンドが接続されていることを確認します。</p><img src="/new-technology/2024/09/23/miband9/setup6.png" class="" width="320" title="alt"><p>以下のメニューの表示順にセットアップしていきます。</p><img src="/new-technology/2024/09/23/miband9/setup7.png" class="" width="320" title="alt"><p>最初の<mark class="label primary">ランニングモードを切り替える</mark>の項目は初期のバンドモードのままにします（リストバンドとして心拍を計測します）。</p><h2 id="通知と通話"><a href="#通知と通話" class="headerlink" title="通知と通話"></a>通知と通話</h2><p>（設定を推奨）Mi Fitnessの<mark class="label primary">デバイス</mark>メニューの<mark class="label primary">通知と通話</mark>では、電話やメッセージなどをスマホで受信した際にバンドに通知します。仕事中など、必要なメッセージだけをバンドに通知されるのはとても便利です。なお、バンドで電話は受けられませんし、メッセージを送信できません。あくまでメッセージ本文が通知されバンドで読める機能です。</p><img src="/new-technology/2024/09/23/miband9/setup8.png" class="" width="320" title="alt"><mark class="label primary">アプリ通知</mark>、<mark class="label primary">スリープ解除</mark>、<mark class="label primary">装着時のみ通知</mark>を有効にします。個別に通知を受信するためのアプリを選択します。電話、メッセージ、メールの基本設定など、これは受信したいメッセージアプリを有効にしていきます。LINE、Gmail、Outlookなど様々なアプリが登録できます。ここに登録が無いものは<mark class="label primary">その他</mark>を選ぶとスマホの通知が全てバンドに通知されます。なお、カレンダー（イベント）は別の項目で設定します。<h2 id="フィットネスと健康"><a href="#フィットネスと健康" class="headerlink" title="フィットネスと健康"></a>フィットネスと健康</h2><p>Mi Fitnessの<mark class="label primary">デバイス</mark>メニューの<mark class="label primary">フィットネスと健康</mark>では、以下のメニューがあります。</p><img src="/new-technology/2024/09/23/miband9/setup9.png" class="" width="320" title="alt"><h3 id="心拍数"><a href="#心拍数" class="headerlink" title="心拍数"></a>心拍数</h3><p>（推奨）連続モニタリングはデフォルトで<mark class="label primary">スマート</mark>となっています。自動という事ですね。ワークアウト中は頻繁な連続モニタリングを行いますが、動きがない場合は少し間隔を空けてモニタリングします。この設定はバンド本体のみでも行えます。<br>（任意）心拍数が異常値の場合、アラートを通知します。</p><h3 id="睡眠"><a href="#睡眠" class="headerlink" title="睡眠"></a>睡眠</h3><p>（推奨）<mark class="label primary">高度なモニタリング</mark>、<mark class="label primary">呼吸数</mark>を有効にします。これで睡眠の詳細、呼吸数が記録され、眠りの深さや安静時心拍数がわかるようになります。</p><h3 id="血中酸素レベル"><a href="#血中酸素レベル" class="headerlink" title="血中酸素レベル"></a>血中酸素レベル</h3><p>（推奨）<mark class="label primary">高度なモニタリング</mark>、<mark class="label primary">呼吸数</mark>を有効にします。血中酸素レベルは90％以上で十分と言われます。健康な方なら90％を割ることは殆ど無いと思われます。また、ジョギング中でもこういった数値が異常値になる経験はありませんが、何かしらの気づきになる可能性もあるので有効にしておきましょう。</p><h3 id="ストレス"><a href="#ストレス" class="headerlink" title="ストレス"></a>ストレス</h3><p>（推奨）<mark class="label primary">終日モニタリング</mark>、<mark class="label primary">リラックスリマインダー</mark>を有効にします。ストレスを感じた際は気分転換する機会が得られます。あまりストレスを感じていると熟睡できなくなりますので有効にしておきましょう。</p><h3 id="スタンディング"><a href="#スタンディング" class="headerlink" title="スタンディング"></a>スタンディング</h3><p>（任意）<mark class="label primary">立ち上がることをリマインド</mark>を有効にします。デスクワークの方は、気分転換を兼ねてストレッチをする機会が得られます。なお、通知の開始、終了時刻が設定できます。<mark class="label primary">DND</mark>という項目があり、これはDo Not Disturb（知らせない）の略ですが、昼休みなど本当に休む場合で起こされたくない場合は追加設定しておきます。なお、夜間に通知してほしくないことも当然ですが、これは別の項目で設定します。</p><h3 id="統計"><a href="#統計" class="headerlink" title="統計"></a>統計</h3><p>（必須）ここでは毎日の目標を設定し、目標達成したらリマインダーで通知できます。MI Fitnessからバンドを登録した時に最初に目標設定を促されますが、この項目でいつでも変更可能です。カロリーについてはあまり目安というのは難しいのですが（体重や運動強度などもあり複雑）、以下で紹介する「健康づくりのための身体活動・運動ガイド2023（概要）」の成人のケースに基づき、以下の設定ではいかがでしょうか。</p><table><thead><tr><th>項目</th><th>目標</th></tr></thead><tbody><tr><td>カロリー</td><td>300キロカロリー</td></tr><tr><td>歩数</td><td>8000歩</td></tr><tr><td>中高強度の運動</td><td>60分</td></tr></tbody></table><p>カロリーは以下の文献から<strong>1日、300キロカロリー</strong>を目安としています。</p><blockquote><p>厚生労働省　身体活動・運動<br> (注）1日1万歩の根拠<br>　海外の文献から週当たり2000kcal（1日当たり約300kcal）以上のエネルギー消費に相当する身体活動が推奨されている6)。歩行時のエネルギー消費量を求めるためのアメリカスポーツ医学協会が提示する式を用いて、体重60kgの者が、時速4km(分速70m)、歩幅70cm、で10分歩く（700m、1000歩）場合を計算すると、消費エネルギーは30kcalとなる。つまり1日当たり300kcalのエネルギー消費は、1万歩に相当する。<br> <a href="https://www.mhlw.go.jp/www1/topics/kenko21_11/b2.html">https://www.mhlw.go.jp/www1/topics/kenko21_11/b2.html</a></p></blockquote><p> ※1日1万歩と記載があり、これは多い気がしますが、分速70mというのは強度が少し低めです。ここではもう少し歩く距離を減らし、速度を上げる方向で記載しています。</p><p>健康づくりのための身体活動・運動ガイド2023（概要）<br><a href="https://www.mhlw.go.jp/content/001204942.pdf">https://www.mhlw.go.jp/content/001204942.pdf</a></p><p>以下の厚生労働省のWebページでは成人、老人、子供、または慢性疾患がある場合の方向けにどの程度の強度の運動をすべきか記載されているので、一読されることをお勧めします。</p><blockquote><p>厚生労働省　身体活動・運動の推進<br><a href="https://www.mhlw.go.jp/stf/seisakunitsuite/bunya/kenkou_iryou/kenkou/undou/index.html">https://www.mhlw.go.jp/stf/seisakunitsuite/bunya/kenkou_iryou/kenkou/undou/index.html</a></p></blockquote><p>これらの設定はかなり意識して実行しないと達成しません。中高強度の運動が60分と言われると少し厳しい感じがしますが、普通の人が達成できない目標でもありません。運動不足の方でも最初はウォーキングからしっかりと目標を立てて頑張って取り組みましょう。</p><h3 id="活力スコアの設定"><a href="#活力スコアの設定" class="headerlink" title="活力スコアの設定"></a>活力スコアの設定</h3><p>（推奨）<mark class="label primary">活力スコアの設定</mark>は、<mark class="label primary">目標達成通知</mark>、<mark class="label primary">7日間のプログレス</mark>、<mark class="label primary">毎日のプログレス</mark>とあり、それぞれ通知設定が可能です。</p><p>この活力スコアについては、MI Fitnessの不具合なのかアプリから詳細をタップするとアプリが落ちてしまいます。ヘルプを見る限りでは、WHOガイドラインに基づき、1週間で100という指標を目指すものとなっています。つまり過去7日間で継続的に100を達成していることが目標になります。MI Fitnessのヘルプに基けば「成人の場合、大きな健康効果を得るためには、週に150〜300分の中強度の有酸素活動、75〜150分の高強度の有酸素活動、または中強度と高強度の活動を同量ずつ組み合わせて行うことが望ましいとされています」とのこと。<br>昔のMI Bandで用いられていたPAIに相当するものになるでしょうか。一応、ウォーキングだけでもそれなりに数値は上がっているので高強度の運動までは厳しいと感じる方でも参考になるでしょう。MI Fitnessに慣れてきて週3回くらい高強度の運動をする方は目安として強度が不足、または回数が不足していることなどの気づきになるでしょう。</p><p>2024-09-29 追記<br>最新ファームウェアのアップデートがあり、このアプリが落ちるのは解消されました。<br>日付ごとに活力スコアが確認できます。ここでは心肺機能の強化を目的としているのか、中強度、高強度の運動も求められます。こちらはワークアウトが習慣化された後に大事になってくる項目になるでしょう。</p><h2 id="アプリ"><a href="#アプリ" class="headerlink" title="アプリ"></a>アプリ</h2><p>アプリというのは、バンド上の機能です。機能単位にアプリという形で管理されています。以下の項目が設定できます。</p><img src="/new-technology/2024/09/23/miband9/setup10.png" class="" width="320" title="alt"><h3 id="アラーム"><a href="#アラーム" class="headerlink" title="アラーム"></a>アラーム</h3><p>（推奨）アラームはもちろん個人のライフスタイルによって任意項目ですが、就寝時にもバンドを着けている方にとっては便利なのでお勧めです。曜日指定ができますし、<mark class="label primary">スマート起床</mark>を選ぶと睡眠サイクルで適切なタイミングでバンドが振動してお知らせします。</p><img src="/new-technology/2024/09/23/miband9/setup11.png" class="" width="320" title="alt"><p>個人的にはスマホなどのアラームの音で驚いて目覚めるよりはバンドの振動で起こされた方が目覚めは良いです。余談ですが、さらにその10分前くらいに、Amazon Echoで最小ボリュームで鳥の鳴き声（Apple Music）を再生するようにしています。睡眠に入る時も静かな音楽をタイマーで30分ほど流しますが、こういった組み合わせによってより深い眠りができる気がしています。</p><h3 id="イベントを同期"><a href="#イベントを同期" class="headerlink" title="イベントを同期"></a>イベントを同期</h3><p>（推奨）カレンダー登録されたものはこの設定を有効にすることで通知されます。仕事に没頭していてもリマインダーとして便利です。</p><h3 id="その他"><a href="#その他" class="headerlink" title="その他"></a>その他</h3><p>タスクリマインダー、天気、世界時計（アプリはデフォルトで非表示）があります。Band9のデフォルトの画面では一番下に天気が表示されています。最低気温と最高気温までが青色のゲージ表示になっており、今の気温がわかるようになっており便利です。</p><h2 id="システム設定"><a href="#システム設定" class="headerlink" title="システム設定"></a>システム設定</h2><p>以下の設定ができます。</p><img src="/new-technology/2024/09/23/miband9/setup12.png" class="" width="320" title="alt"><h3 id="ウィジェット"><a href="#ウィジェット" class="headerlink" title="ウィジェット"></a>ウィジェット</h3><p>デフォルトではバンド上で設定する項目、気温、音楽、睡眠・心拍数などのショートカットがウィジェットとしてまとめられています。これはバンドのディスプレイから左右のスワイプでより詳細の機能にアプローチできます。バンドを右から左にスワイプするとデフォルトでは睡眠と心拍数の2つが表示されるウィジェットとなっています。私はこの2つセットのウィジェットを削除し、心拍数のみを登録しています。例えば通勤時にいつもの階段を登りきった後、心拍数をみて普段より過度に心拍数が上昇していないか体調のバロメータとしてよく使います。ワークアウトを開始せずともスワイプ一度で心拍数が見られる（計測スタートする）のはとても便利です。</p><h3 id="アプリを並び替える"><a href="#アプリを並び替える" class="headerlink" title="アプリを並び替える"></a>アプリを並び替える</h3><p>バンドのディスプレイを下から上にスワイプさせるとアプリが表示されます。このアプリの順番を変えたり、アプリを追加したり非表示にしたりできます。</p><img src="/new-technology/2024/09/23/miband9/setup13.png" class="" width="120" title="alt"><h3 id="スリープモード"><a href="#スリープモード" class="headerlink" title="スリープモード"></a>スリープモード</h3><p>（推奨）大体寝る時間と起きる時間が決まっている方は、ここでスリープモードの時間帯を有効にしておくと、腕を上げる時にディスプレイが点灯しません。タップすると点灯します。これで寝返りを打っても勝手にディスプレイがOnになりその明るさで目覚めるという事がなくなります。なお、<mark class="label primary">目覚ましアラーム</mark>の機能がありますが、ここでは有効にしないことをお勧めします。前述したアラームの方が高機能で、この目覚ましアラームは毎日が原則ですので使い勝手が悪いです。</p><h2 id="追加設定"><a href="#追加設定" class="headerlink" title="追加設定"></a>追加設定</h2><p>このメニューではバンドのファームウェアアップデートができます。またバンドに関する使い方のヘルプもここから確認します。</p><h2 id="バンドの装着"><a href="#バンドの装着" class="headerlink" title="バンドの装着"></a>バンドの装着</h2><p>安定して心拍数を測るためにはそれなりに密着させてバンドを締める必要があります。女性の方など手首が細い方（13cm以下の方）は隙間が空いてしまうかもしれません。AliExpressなどにマジックテープで留めるタイプのバンドが数百円で売っていたりするので、そちらで調整することをお勧めします。</p><h2 id="バンド本体の設定"><a href="#バンド本体の設定" class="headerlink" title="バンド本体の設定"></a>バンド本体の設定</h2><p>バンドのディスプレイを右にスワイプし、<mark class="label primary">設定</mark>→<mark class="label primary">ディスプレイ</mark>→<mark class="label primary">持ち上げてスリープ解除</mark>を選ぶと、デフォルトで開始が8：00、終了が22：00になっているはずです。この設定を前述したスリープモードの時間帯と合わせておくことをお勧めします。</p><p>また、<mark class="label primary">設定</mark>→<mark class="label primary">自動検出</mark>というメニューがあるので、自動検出をOffに、ワークアウトの終了を検出をOnにすることをお勧めします。ワークアウトは実施の前にご自身で開始されるでしょうし、これが有効であると通勤時に誤判定されるので不便です。</p><h2 id="ワークアウト（ウォーキング）"><a href="#ワークアウト（ウォーキング）" class="headerlink" title="ワークアウト（ウォーキング）"></a>ワークアウト（ウォーキング）</h2><p>MI Fitnessの<mark class="label primary">ワークアウト</mark>からウォーキングを選ぶか、バンドのディスプレイを下から上にスワイプして、<mark class="label primary">ワークアウト</mark>、<mark class="label primary">ウォーキング</mark>と進みます。アプリの権限で位置情報を「常に許可」（iOSの場合）にしておく必要があります。恐らく、スマホを使わずともバンド操作で十分でしょう。時間のある時にゆっくり分析する時にはMI Fitnessアプリを使うことになります。</p><img src="/new-technology/2024/09/23/miband9/walk1.png" class="" width="360" title="alt"><mark class="label primary">GO</mark>をタップして早速ウォーキングしてみましょう。<img src="/new-technology/2024/09/23/miband9/walk2.png" class="" width="120" title="alt"><p>バンドのディスプレイには上から小さく現在時刻（小さくてワークアウト中には読み取れません）、ワークアウトの経過時間、距離、心拍数、その下にスワイプしていくと、現在のペース、平均ペースなどが表示されます。ウォーキングなどの速度を表すペースは時速◯キロ（km&#x2F;h）の表記ではなく、1kmあたり◯分という表記になります。</p><p>ウォーキングで良く言われるのは、ゆっくり歩いていてはトレーニングにならないという事です。MI Smart Bandでの心拍数は、ウォームアップ、インデンシブ、有酸素、無酸素、最大酸素摂取量という具合に強度が分かれています。効率良く脂肪燃焼を行うにはインテンシブ〜有酸素の心拍数の幅が脂肪燃焼ゾーンと言われています。この分類、つまり心拍数の幅は人によって異なりますが、ざっくりと言うと、最大心拍数の40％〜60％程度です。最大心拍数は単純計算で220 - 年齢で求められます。40歳なら220 - 40 &#x3D; 180が最大心拍数の目安であり、脂肪燃焼ゾーンは72〜108です。</p><p>仮に最大心拍数の50％だとすれば90あたりでしょうか。</p><p>減量（体脂肪の減少）実験とバンドの電池持ちの確認を兼ねて17日間（バンド8で7日、バンド9で10日）毎日4km〜5km程度のウォーキングをしてみました。</p><p>17日経過し、体重は-1.7kg、体組成計（体重計）では筋肉量が＋1.4kg、体脂肪が-3.1kgでした。また、普段あまり血圧は気にしていませんでしたがこの期間も継続して計測してみました。週間平均115&#x2F;82→113&#x2F;79と微減しました。ウォーキングだけでなく、食事では糖質を控えめ（米、パン、麺などの炭水化物を抑制）し、タンパク質を多めに摂取しました。朝食なら、豆腐、納豆、ヨーグルト、それ以外にたまに海藻類という具合です。夜は2日に1度の頻度でお酒（糖質低めのハイボール）は飲みました。夜は肉、魚、野菜を積極的に摂りご飯は白米から玄米に変えるという感じです。3食はしっかりと食べており厳しい食事制限は一切していませんし、お酒も常識的な頻度で飲んでこの程度は達成できるということはわかりました（この間1度だけ会食があり、糖質の高い日本酒などを飲むことになり実験を台無しにしそうでしたが、なんとか持ち直しました笑）。この程度であれば多くの方が気軽にチャレンジできる内容ではないでしょうか。<br>今回はSmart Bandの記事なので食事のコツについては割愛しますが、食べないだけのダイエットや極端な糖質ダイエットは体の水分を抜くだけで筋肉量が落ちます。すぐに体重が減ってもリバウンドしやすいと言えます。しかし血糖値の急上昇を抑えることなど<strong>精製された加工度の高い炭水化物</strong>を抑制することは意味があり（ケーキやジュースなど）、糖尿病とは無縁とお考えの方でも、糖尿病対策についてよく調べていくと糖質を抑えることは健康のために効果が高いことが分かります。<br>また、糖質、タンパク質が4kcal&#x2F;gに対して、脂質は9kcal&#x2F;gであることから脂質には留意する必要があります。<br>結局のところカロリーコントロールが大切であり、生活習慣病対策となります。つまり、極端なことをせずとも、お酒や間食を減らし運動・睡眠・喫煙をきちんと考えた結果、適正な体重になっていくことは間違いありません。</p><p>適正な食事量に加え、運動量及び日中の疲れをぐっすり寝て体を癒すことの2つは、MI Smart Bandで見える化できます。</p><p>さて、個人によって歩く速度（運動強度）は異なるものの、ウォーキングの速度の1つの目安としてkmあたり10分という時間は男性・女性ともに共通の目線です。これは明らかに運動している状態の速度であり、この速度で長時間歩くとこの季節は汗もかきます。しかしこの速度は、足がもつれたり、呼吸が厳しくなるような状況には到底なりません。喋りながら歩き続けられるレベルです（個人差はあります）。</p><p>バンドの表記の上部にある経過時間を見ていれば、10分経過した時に、その距離が1kmであれば10分&#x2F;kmの速度であり、適切なペースということになります。この時の心拍数がご自身の脂肪燃焼ゾーンに足りない場合は、軽いジョギングに移行されることを検討します（子ども、高齢者はこの限りではありません）。</p><p>ウォーキングが終了したらバンドを左から右にスワイプし、終了ボタンを2秒ほど長押し（ロングタップ）してワークアウトを終了します。</p><p>後からスマホアプリでワークアウトの結果を確認できます。以下は約10分&#x2F;kmのペースで5kmウォーキングした結果です。</p><img src="/new-technology/2024/09/23/miband9/walk3.png" class="" width="360" title="alt"><img src="/new-technology/2024/09/23/miband9/walk4.png" class="" width="360" title="alt"><img src="/new-technology/2024/09/23/miband9/walk5.png" class="" width="360" title="alt"><img src="/new-technology/2024/09/23/miband9/walk6.png" class="" width="360" title="alt"><img src="/new-technology/2024/09/23/miband9/walk7.png" class="" width="360" title="alt"><p>このように心拍数、ペース、ケイデンス（回転数、この場合は歩数）、ストライド（歩幅）が明瞭にわかります。</p><p>ストライド（歩幅）は一般的に身長　- 100cmが目安と言われています。速度を上げるためにケイデンスを上げるよりも少し大股で歩く意識で腕を振り、リズムを重視した方が速度アップに繋がります。</p><p>これらの結果を見ながら自分に合った強度や速度を見つけていくことになります。いきなり10分&#x2F;kmで歩き出すのではなく、ゆっくりの速度から始め、少しづつ速度を上げていきましょう。体組成計があれば、筋力の上昇が確認できますから、それを見ながら（筋力の上昇が安定したら）強度を少しづつ上げていきましょう。<br>一番下の回復という項目で4時間と表記されていますが、次のワークアウトまで4時間は間を空けるようにすべきとの助言になっています。休息を取りながら時間に余裕のある範囲でウォーキングを継続しましょう。</p><p>ウォーキングの最中、バンドの表記がインテンシブではなくずっとウォームアップの状態なのであれば強度が足りません。<br>これは歩き方にもポイントがあって、歩くときに踵から着地し、足の母指球で蹴り上げるように歩く方は足首のスナップを使う形になり、体全体に負荷が掛かりません。腿を上げることを意識し、緩やかな登り階段を上るように大股で歩き、足裏全体で着地し、着地した足を使って体を前にスライドさせ、できるだけ長く足裏全体を地面につけておくことです（つまり足首・母指球で蹴らない）。移動を考えると非効率でスピードも出ませんが、長時間、早く歩けば良いものでもありません。怪我のリスクを抑え効率良く有酸素運動の効果を高めるためには負荷の高いウォーキングを意識してみてください。<br>ほとんど同じ速度で歩いても、腿上げを意識しながら歩くと心拍数は違ってきます。</p><img src="/new-technology/2024/09/23/miband9/walk8.png" class="" width="360" title="alt"><img src="/new-technology/2024/09/23/miband9/walk9.png" class="" width="360" title="alt"><img src="/new-technology/2024/09/23/miband9/walk10.png" class="" width="360" title="alt"><p>平均心拍数は106（インテンシブ）から125（有酸素）に上がり、一部無酸素の状態も含まれています。ペースが全体的に同じであってもワークアウト後半は心拍数が高めになります。</p><h2 id="ランニングコース"><a href="#ランニングコース" class="headerlink" title="ランニングコース"></a>ランニングコース</h2><p>Band9よりランニングコースという機能が追加されています。バンドを下から上にスワイプし、<mark class="label primary">ワークアウト</mark>ではなく、<mark class="label primary">ランニングコース</mark>のメニューを選択します。すると、以下のような項目が表示されます。</p><ul><li>基礎ラン</li><li>上級ラン</li><li>基礎ジョグ</li><li>脂肪燃焼ラン（基礎）</li><li>脂肪燃焼ラン（上級）</li><li>MIITラン</li><li>その他。..</li></ul><p>これらのうち、最も易しいのが基礎ランです。</p><ul><li>ウォーキング　2分×4回</li><li>ジョギング　3分×3回</li></ul><p>ウォーキング→ジョギング→ウォーキングと繰り返して17分のメニューとなっています。ウォーキングからジョギングに切り替える際はまずは易しいこのメニューを使ってはいかがでしょうか？17分だと物足りないので2回行っても良いですね。<br>これで慣れてくれば上級ラン（ジョギングが5分になったもの）に進み、基礎ジョグ（最初と最後の3分のウォーキング、21分のジョギング）ができるように目指すのも良いですね。</p><p>ワークアウト中は、目指す心拍数ゾーンと現在の心拍数が表示されています。</p><img src="/new-technology/2024/09/23/miband9/walk11.png" class="" width="360" title="alt"><p>私の場合、10分以上は走らないと心拍数は高いままで落ち着かないので、あくまで参考までにと割り切っています。</p><p>さて、実際に基礎ランをやってみた結果です。</p><img src="/new-technology/2024/09/23/miband9/walk12.png" class="" width="360" title="alt"><img src="/new-technology/2024/09/23/miband9/walk13.png" class="" width="360" title="alt"><p>MI Fitnessの方でもウォーキングとジョギングのペースが表示されています。なお、心拍数のラベルは不具合があるようで、よくわからない表記になってますね。上からウォームアップ、インデンシブ、有酸素、無酸素、最大酸素摂取量は変わらないので色の分類でも何となくわかるでしょうか。こちらも不具合報告は上げておきました。</p><p>こちらはジョギングを3kmやった結果です。</p><img src="/new-technology/2024/09/23/miband9/run1.png" class="" width="360" title="alt"><img src="/new-technology/2024/09/23/miband9/run2.png" class="" width="360" title="alt"><img src="/new-technology/2024/09/23/miband9/run3.png" class="" width="360" title="alt"><p>kmあたり8分のペースでゆっくりと走っています。このペースだと会話しながら余裕でジョギングできます。私の場合、ジョギングで楽だなと感じる時は心拍数135あたりが目安ですが、MI Fitnessの結果では大部分の時間が無酸素に割り当てられています。ここは自分の感覚と違和感があります。無酸素程度の速度だとかなり言葉少なで走ることになります。バンドの有酸素運動か無酸素運動かの違いはあくまで参考としてご自身の心拍数を見ていくのが良いのではないかと思います。</p><p>走ると膝が痛くなるという方は、走るフォームの見直しで改善する場合があります。サポーターなどはほぼ気休めだと思います。特に猫背の方で重心が前にあったりする人は1kmほど走ると膝が痛むようになるという声が多いようです。足の着地は体の真下で膝下は地面に垂直近くというのが基本です。ジョギングは速度を出さないので、着地の後、足を母指球で蹴らず、足裏全体で体を前にスライドさせ進みます。膝が曲がっている状態で着地するとジャンプから着地する力と前に進む方向に対してブレーキを掛ける力も加わり、相当の負担を膝で受け止めることになります。</p><p>余談ですが、ゴルフをやる方は、左膝を痛めている方がとても多いですよね（右利きの場合）。ボールを飛ばすのも地面との反発力ですが（プロゴルファーのショットの瞬間、上半身を縮めて足元が地面から浮き上がる様は凄いですよね）。ランニングも同様、地面の反発がとても大事ですが、早く走ろうとするとやはり膝を痛めやすいです。腿を振り上げても着地の瞬間まで足を体の真下まで引き寄せ反発を使えば、前述した足裏で体を送るなんてことをしなくとも勝手にポンポンと体が前に進んで気持ちよく走れます。</p><p>自分の目標に合わせた負荷でワークアウトができるようにバンドを活用してみてください。</p><h2 id="ゴルフ"><a href="#ゴルフ" class="headerlink" title="ゴルフ"></a>ゴルフ</h2><p>ゴルフの計測もやってみました。スループレーで途中休憩無し、カートでホール間の移動は行うものの、プレー中はカートを一切使わず歩き（または小走り）での計測です。</p><img src="/new-technology/2024/09/23/miband9/golf1.png" class="" width="360" title="alt"><p>特にスイング回数が分かるでもなく、また歩数が表示されるでもなく、心拍数のみ記録がされています。スマホはカートのキャディバッグの中に置いてあったので、プレー中は度々スマホとのBluetooth切断と再接続が行われ、その度にバンドが振動するので結構気になりました。後で歩数を確認しましたが、16,000歩程度でした。早めのウォーキングを意識したり、芝生の上なので大きな歩幅で走ったりしていたので、歩数自体は思ったよりも少なくカウントされていました。まぁゴルフは特にワークアウトにしなくても良いかな、、という感想です。</p><h2 id="山登り（トレッキング）"><a href="#山登り（トレッキング）" class="headerlink" title="山登り（トレッキング）"></a>山登り（トレッキング）</h2><p>おおよそ110分、2.8kmのコースの山登りを計測してみました。休日ともあって人が多く、渋滞で127分掛かりました。</p><img src="/new-technology/2024/09/23/miband9/trekking1.png" class="" width="360" title="alt"><p>ここでのペースの表記は時速（km&#x2F;h）となっています。山登りなのでインテンシブ、有酸素、無酸素、最大酸素摂取量とバランス良い数字ですね。但し、この無酸素47分とか最大酸素摂取量が17分とかはなかなかキツいものがあります。しんどいですが行き交う方々と「こんにちは〜」と挨拶しながらの山登りは良いものですね。早く登ることを目的としていませんが、山登りの記録としても残せるのは良いですね。</p><h2 id="睡眠-1"><a href="#睡眠-1" class="headerlink" title="睡眠"></a>睡眠</h2><p>バンドを手首につけたまま寝ると、翌朝には睡眠分析が表示されます。</p><img src="/new-technology/2024/09/23/miband9/sleep1.png" class="" width="360" title="alt"><img src="/new-technology/2024/09/23/miband9/sleep2.png" class="" width="360" title="alt"><img src="/new-technology/2024/09/23/miband9/sleep3.png" class="" width="360" title="alt"><p>実際によく眠れなかったなと感じる時はこの睡眠スコアも悪いわけですが、継続的に統計をとることで、どれだけ寝ているのかあるいは無駄に長く寝ているのかということもわかります。また、最初に可愛いヒグマの絵が出ていますが、7日間連続で睡眠データが取れると、どの動物と似ているかというレポートを出してくれます（他に、サメ、ペンギン、フクロウ、コアラ、ヒツジがあるようです）。</p><img src="/new-technology/2024/09/23/miband9/sleep4.png" class="" width="360" title="alt"><img src="/new-technology/2024/09/23/miband9/sleep5.png" class="" width="360" title="alt"><img src="/new-technology/2024/09/23/miband9/sleep6.png" class="" width="360" title="alt"><p>バンドを日中継続して着けておくことで、ストレスの状況や、夜中に目覚めた回数なども記録されています。寝る前の強度の高い運動も警告されます。</p><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>以上、MI Band9の機能をレポートしてみましたが、いかがでしたでしょうか。厳しい暑さがようやく落ち着いてきた今から、少しダイエットなど取り組もうと考えられている方にはぴったりのデバイスだと思います。電池持ちも十分で小型であることに加え、シリコンバンドも柔らかいのでデスクワークでキータイプしていてもほとんど気になることはありません。</p><p>結局のところ健康になるためには、お酒と間食を減らし、食事を決まった時間に摂り(※)、適度な運動が必要という結論に行き着くのですが、その支援ツールと考えれば費用対効果は高いと思われます。<br>※ 日本の食事は炭水化物が多めですので糖質を摂りすぎと言われます。糖質カットは意識した方が良いでしょう。</p>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2024/09/23/miband9/title.png&quot; class=&quot;&quot; width=&quot;1024&quot; title=&quot;alt&quot;&gt;

&lt;h2 id=&quot;MIスマートバンド9（MI-band9）&quot;&gt;&lt;a href=&quot;#MIスマートバンド9（MI-band9）&quot; class=&quot;headerlink&quot; title=&quot;MIスマートバンド9（MI band9）&quot;&gt;&lt;/a&gt;MIスマートバンド9（MI band9）&lt;/h2&gt;&lt;p&gt;2024年に発売となったXiaomi Smartband 9（Band9）を使って健康促進のための使い方を初級者向けに紹介します。このブログでも過去にBand 5,6はレビューしてきて、久しぶりのMI bandです。これまではZepp Lifeと呼ばれるスマホアプリで操作していましたが、Band8からはMI Fittnessというアプリに変わっています。ここでは昨年発売されたBand8との比較もします。&lt;/p&gt;</summary>
    
    
    
    <category term="SmartWatch" scheme="https://yoshi0808.github.io/new-technology/categories/SmartWatch/"/>
    
    
    <category term="Xiaomi Smart Band 9" scheme="https://yoshi0808.github.io/new-technology/tags/Xiaomi-Smart-Band-9/"/>
    
  </entry>
  
  <entry>
    <title>Sophos Firewall v20 MR2</title>
    <link href="https://yoshi0808.github.io/new-technology/2024/08/25/xg-v20mr2/"/>
    <id>https://yoshi0808.github.io/new-technology/2024/08/25/xg-v20mr2/</id>
    <published>2024-08-25T00:28:23.000Z</published>
    <updated>2024-08-25T09:54:48.081Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2024/08/25/xg-v20mr2/Title.png" class="" title="alt"><h2 id="Sophos-Firewall-v20"><a href="#Sophos-Firewall-v20" class="headerlink" title="Sophos Firewall v20"></a>Sophos Firewall v20</h2><p>Sophos Firewall v20 MR2が2024年07月23日に発表されました。異なるFirewallへの移行を意図したバックアップ、レストアの機能が実装されています。</p><span id="more"></span><p>v20　MR2の詳細な説明はSophos Communityを参照してください。</p><blockquote><p><a href="https://community.sophos.com/sophos-xg-firewall/b/blog/posts/sophos-firewall-os-v20-mr2-is-now-available">https://community.sophos.com/sophos-xg-firewall/b/blog/posts/sophos-firewall-os-v20-mr2-is-now-available</a></p></blockquote><p>リリースノートはこちらです</p><blockquote><p><a href="https://docs.sophos.com/releasenotes/index.html?productGroupID=nsg&productID=xg&versionID=20.0">https://docs.sophos.com/releasenotes/index.html?productGroupID=nsg&amp;productID=xg&amp;versionID=20.0</a></p></blockquote><ul><li>SafeSearch、YouTubeの制限、Google Appのログインドメインの制限、およびAzure ADテナントの制限を強制する際に、システム負荷を軽減してWeb保護のパフォーマンスを強化しました。</li><li>45以上の重要なパフォーマンス、信頼性、安定性、セキュリティの修正を解決します。</li></ul><h2 id="Sophos-Firewallのアップデート"><a href="#Sophos-Firewallのアップデート" class="headerlink" title="Sophos Firewallのアップデート"></a>Sophos Firewallのアップデート</h2><p>管理画面にログイン後、左ペインメニューの<mark class="label primary">バックアップ＆ファームウェア</mark>の<mark class="label primary">ファームウェアの確認</mark>でアップデートの案内が順次来ます。以下はv20 MR1のものですが、ここでMR2の表示がなされます。</p><img src="/new-technology/2024/08/25/xg-v20mr2/mr1-1.png" class="" width="800" title="alt"><p>個別にバージョンアップのファイルを入手するには、以下のURLからダウンロードします。</p><p><a href="https://support.sophos.com/support/s/article/KBA-000007972?language=ja">https://support.sophos.com/support/s/article/KBA-000007972?language=ja</a></p><ol><li>上記画面で<mark class="label primary">Sophos Firewall</mark>の<mark class="label primary">ファームウェア</mark>の<mark class="label primary">ソフトウェア</mark>のLinkをクリックします。</li><li>“SW-20.0.2_MR-2.SFW-378.sig”をダウンロードします。</li><li>Sophos Firewallの管理画面にログインし、左ペインメニューの<mark class="label primary">バックアップ＆ファームウェア</mark>の<mark class="label primary">ファームウェアのタブメニュー</mark>から以下の画面に赤丸で囲った矢印のアイコンをクリックし、ダウンロードしたモジュールをアップロードします。</li></ol><img src="/new-technology/2024/08/25/xg-v20mr2/verup.png" class="" width="800" title="alt"><p>アップロード＆再起動ボタンをクリックし、v20 MR2へのアップグレードを完了させます。</p><p>数年間利用しているSophos Firewallですが、特段の問題なく、仮想環境（ESXi8）配下で安定して稼働しています。そういえば、Sophos Firewallのセットアップに関する私の記事はESXi前提で、現時点でのホームユーザー向けにはProxmox向けの手順を改めて記載すべきと認識しています。但し、Proxmox上のSophos Firewallのセットアップは特段苦労することもありませんので、興味のある方はチャレンジしてみてください。</p>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2024/08/25/xg-v20mr2/Title.png&quot; class=&quot;&quot; title=&quot;alt&quot;&gt;

&lt;h2 id=&quot;Sophos-Firewall-v20&quot;&gt;&lt;a href=&quot;#Sophos-Firewall-v20&quot; class=&quot;headerlink&quot; title=&quot;Sophos Firewall v20&quot;&gt;&lt;/a&gt;Sophos Firewall v20&lt;/h2&gt;&lt;p&gt;Sophos Firewall v20 MR2が2024年07月23日に発表されました。異なるFirewallへの移行を意図したバックアップ、レストアの機能が実装されています。&lt;/p&gt;</summary>
    
    
    
    <category term="Security" scheme="https://yoshi0808.github.io/new-technology/categories/Security/"/>
    
    
    <category term="XG Firewall" scheme="https://yoshi0808.github.io/new-technology/tags/XG-Firewall/"/>
    
  </entry>
  
  <entry>
    <title>UniFi Network Application 8.3.32</title>
    <link href="https://yoshi0808.github.io/new-technology/2024/07/21/una8-3-32/"/>
    <id>https://yoshi0808.github.io/new-technology/2024/07/21/una8-3-32/</id>
    <published>2024-07-20T23:00:00.000Z</published>
    <updated>2024-07-22T09:46:39.821Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2024/07/21/una8-3-32/title.png" class="" width="1024" title="alt"><p class="onepoint">この記事で実現すること</p><p>米国Ubiquiti（ユビキティ）社のUniFi製品のコントローラーとして利用するUniFi Network Application（以下、UNA）の8.3.32(Official)が提供されています。特にゲートウェイにおけるNAT機能において機能強化が図られています。この記事は本バージョンで強化されたNATのセキュリティ対応を纏めています。</p><span id="more"></span><h2 id="UNA8-3"><a href="#UNA8-3" class="headerlink" title="UNA8.3"></a>UNA8.3</h2><p>以下の機能が追加されています。</p><ul><li>柔軟なNAT設定<br> マスカレード、ソース、およびデスティネーションNATでトラフィックを制御します。さらに、すべてまたは特定のネットワークでNATを無効にできます。</li><li>検査モニタリングの一元化<br> 侵入防止、トラフィックおよびファイアウォールルール、広告ブロッキングなどのセキュリティサービスの詳細なアクティビティログを1つのインターフェースで表示します。</li><li>より詳細なスイッチ分離設定<br> ACLルールを使用して、同じネットワーク内または異なるネットワーク間の特定のトラフィックをブロックします。</li></ul><p>UNA8.3.32でダブルNATを回避できるようになりました。これはホームユーザーにとっても期待されていた機能です。</p><h2 id="NATの種類"><a href="#NATの種類" class="headerlink" title="NATの種類"></a>NATの種類</h2><p>一般的にNATというと、自宅で利用するIPv4プライベートIPアドレスをグローバルIPアドレスに変換してインターネットに接続する技術ですが、これは厳密には<strong>ソースNAT</strong>（Source NAT、SNAT）または<strong>IPマスカレード</strong>と呼ばれます。単に送信元のIPアドレスをプライベートからパブリックに変換するだけならSNATですが、IPアドレスとTCP Portの組み合わせでセッションを管理（紐付け）されているのがIPマスカレードです。これに対して、宛先を変換する<strong>宛先NAT</strong>（Destination NAT、DNAT）という機能があります。DNATは宛先のIPアドレスを別のIPアドレスに強制的に変更するものです。</p><p>負荷分散装置で複数あるサーバーに一定ルールで振り分けたり、パブリックIPアドレスを持つサーバーにプライベートネットワークから接続するよう強制的に向き先を変更することなど、DNATは様々な場所で活用されています。</p><p>今回はセキュリティの観点からホームユーザーにも使い道のあるDNATを紹介します。</p><h2 id="クライアントに強制的にUniFi-GatewayのDNSを参照させる"><a href="#クライアントに強制的にUniFi-GatewayのDNSを参照させる" class="headerlink" title="クライアントに強制的にUniFi GatewayのDNSを参照させる"></a>クライアントに強制的にUniFi GatewayのDNSを参照させる</h2><p>この記事の実例は、IoTなど、DHCPでDNSを指定してもそれを無視してクラウドDNS（GoogleDNSなどの8.8.8.8）を参照する機器や行儀の悪いアプリケーションへの対策になります。企業や個人向けのルータでは一般的にHTTPSやDNSが許可されていることを前提に攻撃者はDDos攻撃のシナリオを作成します。また、IoTの許可のない情報収集などは、クラウドのファイルサービスに対して行われるケースもありますが、セキュアなDNSやFirewallで阻止される可能性もあるため、クラウドDNS（Port53）を使って遮断を回避する手口はよく使われます。クラウドDNS（Port53）へのアクセスをFirewallでRejectできますが、IoTのサービスそのものが機能しなくなるのは困ります。そこでクラウドDNSにアクセスしているように騙し、リクエストを横取りするのがこれから説明するDNATによる宛先IPアドレスの変換です。</p><p>つまり、セキュリティを守るために行われる正当かつ原始的な中間者攻撃（Man-in-the-middle Attack）となります。</p><img src="/new-technology/2024/07/21/una8-3-32/dns.drawio.png" class="" width="480" title="alt"><p>なお、今回はDNSについて書いていますが、UNAの<mark class="label primary">ネットワーク</mark>-&gt;「<mark class="label primary">コンテンツフィルタリング</mark>」や<mark class="label primary">セキュリティ</mark>-&gt;<mark class="label primary">広告ブロック</mark>を有効にすると自動的にUniFi Gateway自身のDNS参照が強制されます。ですので、IoT向けにこの2つの機能を外してUCG-Ultraで検証します。</p><h3 id="DNATの設定"><a href="#DNATの設定" class="headerlink" title="DNATの設定"></a>DNATの設定</h3><p>ここではUniFi GatewayのLANを<code>192.168.1.1</code>として設定しています。</p><img src="/new-technology/2024/07/21/una8-3-32/dnat.png" class="" width="1024" title="alt"><p>インタフェースを<strong>Default</strong>、Internetに出ていく宛先、つまり<strong>0.0.0.0&#x2F;0</strong>の宛先、<strong>Port53&#x2F;TCP,UDP</strong>を対象に<mark class="label primary">変換されたIPアドレス</mark>としてGatewayのIPアドレスを指定することで宛先IPアドレスが変換されます。<br>なお、IPv6のNAT機能はまだ実装されていないようなので、DefaultセグメントのIPv6は無効にしておきます。</p><h3 id="検証"><a href="#検証" class="headerlink" title="検証"></a>検証</h3><ul><li>WindowsPCをIoT機器と見立て、LANに接続の上、WindowsのDNSの設定を<code>8.8.8.8</code>に変更します</li><li>UniFiのDNS設定で、仮のホスト”test.home”のエントリを作成します</li></ul> <img src="/new-technology/2024/07/21/una8-3-32/dns.png" class="" width="800" title="alt"><ul><li><code>nslookup test.home</code>を実行します</li></ul><p>実行結果</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\yoshi&gt;nslookup test.home</span><br><span class="line">サーバー:  dns.google</span><br><span class="line">Address:  8.8.8.8</span><br><span class="line"></span><br><span class="line">名前:    test.home</span><br><span class="line">Address:  192.168.100.200</span><br></pre></td></tr></table></figure><p>このようにクライアントはGoogle DNSを参照しているつもりでいますが、DNSからの回答としてプライベートIPアドレスを返します。<br>このDNAT設定をオフにすると以下のようになります。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\yoshi&gt;nslookup test.home</span><br><span class="line">サーバー:  dns.google</span><br><span class="line">Address:  8.8.8.8</span><br><span class="line"></span><br><span class="line">*** dns.google が test.home を見つけられません: Non-existent domain</span><br></pre></td></tr></table></figure><p>このようにDNSを強制的にUniFi Gatewayに向けることができます。</p><h3 id="応用編"><a href="#応用編" class="headerlink" title="応用編"></a>応用編</h3><p>UniFi GatewayのDNSを利用せず、独自にLAN内にセキュアなDNSや内部向けDNSを構築されている環境ではどうでしょうか？別のLANセグメントにDNSがある場合はDNATが有効に機能しますが、UniFi GatewayのLANと同じセグメントにDNSがある場合、少し工夫が必要です。</p><img src="/new-technology/2024/07/21/una8-3-32/dnserror.drawio.png" class="" width="480" title="alt"><p>IoTからリクエストされたDNSクエリは最初にUniFi Gatewayを経由し、DNATされ、DNSにリクエストされます。但し、返りのパケットは、DNSからの応答が直接IoTに返って来ることになり、（IoTがリクエストしていない機器からの）パケットを受信できません。</p><p>この対策として、IPマスカレードを追加することになります。</p><img src="/new-technology/2024/07/21/una8-3-32/dnsmasq.drawio.png" class="" width="480" title="alt"><p>このようにDNSへのリクエストはクライアントからではなく、UniFi GatewayであるようにIPマスカレードすることによって、DNSはクエリの結果をUniFi Gatewayに返し、GatewayはクライアントにDNSクエリの結果を返します。これでエラーが発生せず、クライアントのInternet向けDNSクエリは横取りする事が可能となります。</p><p>設定例です。ここでは、UniFi Gatewayを<code>192.168.2.2</code>、内部DNSを<code>192.168.2.100</code>とします。</p><p>最初にDNATを構成します。</p><img src="/new-technology/2024/07/21/una8-3-32/dnat1.png" class="" width="1024" title="alt"><p>ここでは、DNATの宛先として、DNSサーバーのIPアドレスを指定します。</p><p>続いてマスカレードの設定です。</p><img src="/new-technology/2024/07/21/una8-3-32/masq1.png" class="" width="1024" title="alt"><p>ここで、送信先の<mark class="label primary">IPグループ</mark>で<mark class="label primary">新しい</mark>リンクをクリックし、新しいIPアドレス、つまりDNSサーバーのIPアドレスを登録します。さらに、<mark class="label primary">ポートグループ</mark>で<mark class="label primary">新しい</mark>リンクをクリックし、DNSのPort53を登録します。</p><p>２つの登録を行った結果、DNAT→Masqueradeの順序に並びます。</p><img src="/new-technology/2024/07/21/una8-3-32/nat1.png" class="" width="800" title="alt"><p>これでクライアントからInternetに向けたDNSリクエストは全てLAN内のDNSに強制的に参照されることになります。行儀の悪いIoTやアプリケーションからは「卑怯だぞ」という声が聞こえてきそうです<span class="github-emoji" alias="grin" style="" fallback-src="https://github.githubassets.com/images/icons/emoji/unicode/1f601.png?v8">&#x1f601;</span>。</p><h2 id="ご参考"><a href="#ご参考" class="headerlink" title="ご参考"></a>ご参考</h2><p>Ubiquiti JapanからのUNA8.3の記事では、NAT機能の概要のみが記載されていましたので具体例を記載してみました。なお、まだ発売されていませんが、Cloud Gateway Maxにも言及されていますね。今度は全て2.5Gbpsポートを持つゲートウェイということに加え、監視カメラ（Protect）に対応することにもなり（動画保存用にNVMe SSDというのが素敵です）、個人向けとして楽しみなプロダクトになりそうです。</p><blockquote><p>UI Japan UniFi Networkの進化: Site Manager | Network Application8.3 | クラウドゲートウェイマックス<br> <a href="https://note.com/ui_japan/n/n503fc31a3442">https://note.com/ui_japan/n/n503fc31a3442</a></p></blockquote>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2024/07/21/una8-3-32/title.png&quot; class=&quot;&quot; width=&quot;1024&quot; title=&quot;alt&quot;&gt;

&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;

&lt;p&gt;米国Ubiquiti（ユビキティ）社のUniFi製品のコントローラーとして利用するUniFi Network Application（以下、UNA）の8.3.32(Official)が提供されています。特にゲートウェイにおけるNAT機能において機能強化が図られています。この記事は本バージョンで強化されたNATのセキュリティ対応を纏めています。&lt;/p&gt;</summary>
    
    
    
    <category term="Network" scheme="https://yoshi0808.github.io/new-technology/categories/Network/"/>
    
    
    <category term="UniFi" scheme="https://yoshi0808.github.io/new-technology/tags/UniFi/"/>
    
  </entry>
  
  <entry>
    <title>Ubiquiti Cloud Gateway Ultra</title>
    <link href="https://yoshi0808.github.io/new-technology/2024/06/25/UCG-Ultra/"/>
    <id>https://yoshi0808.github.io/new-technology/2024/06/25/UCG-Ultra/</id>
    <published>2024-06-25T01:20:00.000Z</published>
    <updated>2024-06-26T21:22:07.373Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2024/06/25/UCG-Ultra/0.png" class="" width="1024" title="alt"><p class="onepoint">この記事で実現すること</p><p>UniFiの新しい小型ゲートウェイUniFi Cloud Gatewayのセットアップ、機能紹介、ホームユーザー向けのセキュリティ対策の実例を掲載しています。検証のため製品提供を受けていますのでこの記事はPR要素を含みます。</p><span id="more"></span><h2 id="Cloud-Gateway-Ultra（UCG-Ultra）"><a href="#Cloud-Gateway-Ultra（UCG-Ultra）" class="headerlink" title="Cloud Gateway Ultra（UCG-Ultra）"></a>Cloud Gateway Ultra（UCG-Ultra）</h2><p>3月には、UniFi初心者向けにUniFi Express（UX）の導入に関する記事を記載しました。UXはワンルームなどの比較的限られた範囲のWi-FiとUniFiゲートウェイがAll in oneとなったハードウェアですが、新しく発売されたCloud Gateway Ultraは、 Wi-Fi APやネットワークスイッチなどを追加、拡張することを想定しているゲートウェイです。Ubiquiti製品の一番人気はなんといってもアクセスポイント（Wi-Fi）ですが、複数のAPをはじめ、スイッチも拡張を想定するユーザーが購入対象となるでしょう。米国では$129と極めて廉価です。</p><p>手短にUCG-Ultraを説明すると以下の通りです。</p><blockquote class="blockquote-center"><p>30以上のUniFiデバイス&#x2F;300以上のクライアントサポート、1 Gbps IPSルーティング、およびマルチWANロードバランシングを備えたコンパクトなCloud Gateway</p></blockquote><p> 日本におけるUbiquitiの知名度もだいぶ上がってきたと感じています。これからUniFiを導入したいユーザーとしては、まず通信の見える化のためにUniFiゲートウェイを導入し、随時、人気のあるAPを追加していきたいと考えられているのではないでしょうか。私個人としては、UCG-UltraはIDS&#x2F;IPSも装備されているので自宅環境のセキュリティ面の強化という意味で期待ができるものと考えています。</p><h2 id="UCG-Ultraの説明ページ"><a href="#UCG-Ultraの説明ページ" class="headerlink" title="UCG-Ultraの説明ページ"></a>UCG-Ultraの説明ページ</h2><p>製品の説明ページは以下になります。</p><blockquote><p>UCG-Ultra<br> <a href="https://jp.store.ui.com/jp/ja/pro/category/cloud-gateways-compact/products/ucg-ultra">https://jp.store.ui.com/jp/ja/pro/category/cloud-gateways-compact/products/ucg-ultra</a></p></blockquote><ul><li>WAN:2.5GbE RJ45ポートx 1</li><li>LAN:GbE RJ45ポートx 4</li><li>IDS&#x2F;IPSスループット1Gbps</li><li>LTEバックアップによる追加のインターネットフェイルオーバー</li><li>アプリケーション認識ファイアウォールルール</li><li>シグネチャベースのIDS&#x2F;IPS脅威検出</li><li>コンテンツ、国、ドメイン、広告のフィルタリング</li><li>VLAN&#x2F;サブネットに基づくトラフィックセグメンテーション</li><li>完全なステートフルファイアウォール</li><li>ワンクリックのTeleportおよびIdentity VPN</li></ul><h2 id="この記事でのインターネットの構成"><a href="#この記事でのインターネットの構成" class="headerlink" title="この記事でのインターネットの構成"></a>この記事でのインターネットの構成</h2><p>私はauひかりホーム（10ギガ）を導入しており、貸与されたホームゲートウェイ（HGW）があります。その後ろにUCG-Ultraを配置する形式となります。</p><img src="/new-technology/2024/06/25/UCG-Ultra/diaglam.drawio.png" class="" width="240" title="alt"><h2 id="セットアップ"><a href="#セットアップ" class="headerlink" title="セットアップ"></a>セットアップ</h2><p>UCG-Ultraはスマホだけでセットアップ可能です。アプリをダウンロードし、Bluetoothで接続して行います。</p><p>製品と付属品です。本体、電源ケーブル、30cmのLANケーブルが付属します。</p><img src="/new-technology/2024/06/25/UCG-Ultra/2.png" class="" width="800" title="alt"><p>PortはWAN（2.5Gbps）x1、LAN（1Gbps）x4です。</p><img src="/new-technology/2024/06/25/UCG-Ultra/3.png" class="" width="800" title="alt"><p>さて、説明書のQRコードをiPhoneのカメラで読み込み、スマホアプリ（UniFi）をダウンロードしましょう。</p><p>Ubiquitiのアカウントを作成します。<br><a href="https://account.ui.com/login">https://account.ui.com/login</a></p><p>スマホアプリUniFiを起動後、UIアカウントにログインします。スマホアプリがBluetooth経由でUCG-Ultraを見つけると画面にセットアップ開始を促します。</p><img src="/new-technology/2024/06/25/UCG-Ultra/6.png" class="" width="360" title="alt"><img src="/new-technology/2024/06/25/UCG-Ultra/8.png" class="" width="360" title="alt"><p>UCG-UltraにはWi-Fiは無いので、UCG-Ultraの名前を決めたらセットアップが完了します。また、途中インターネット速度テストが行われ、さらにファームウェアのアップデートが自動で行われていきます。</p><img src="/new-technology/2024/06/25/UCG-Ultra/9.png" class="" width="360" title="alt"><p>WAN　Portの速度である2.5Gbpsの速度がきちんと出ています。</p><img src="/new-technology/2024/06/25/UCG-Ultra/10.png" class="" width="360" title="alt"><p>あっさりとセットアップ完了です。</p><img src="/new-technology/2024/06/25/UCG-Ultra/11.png" class="" width="360" title="alt"><p>ファームウェアの自動更新が行われます。</p><img src="/new-technology/2024/06/25/UCG-Ultra/11-1.png" class="" width="800" title="alt"><p>ここまで、全く迷うことがありません。</p><h2 id="初期画面"><a href="#初期画面" class="headerlink" title="初期画面"></a>初期画面</h2><p>さて、アプリの表記では、HGWのDHCPによって割り当てられた<code>192.168.0.2</code>というUCG-UltraのWAN側IPアドレス、および、LAN側のIPアドレス<code>192.168.1.1</code>が振られています。</p><img src="/new-technology/2024/06/25/UCG-Ultra/12.png" class="" width="360" title="alt"><p>LANのネットワーク、WANの情報が表示されています。LANはデフォルトVLANが1となっています（かつネイティブVLAN（タグ無し）。<br>WANにはバックアップとしてのSecondary表記があります。今回はPrimaryをauひかりに接続していますが、別の回線または公衆回線（SIMを使う無線ルーター）に接続できます。</p><img src="/new-technology/2024/06/25/UCG-Ultra/13.png" class="" width="360" title="alt"><mark class="label primary">設定</mark>から、<mark class="label primary">コンソール</mark>を選択すると、<mark class="label primary">コンソール管理</mark>画面が表示されます。UniFi OSはv3.2.18となっていますが、Networkアプリケーション（UNA）はUpdate可能なようです。早速Updateをタップします。<img src="/new-technology/2024/06/25/UCG-Ultra/14.png" class="" width="360" title="alt"><p>UCG-UltraのUNAはv8.2.93となりました。</p><p>今回は初回操作なので手動でアップデートすることにしましたが、毎日夜中3時に自動でアップデートチェックが行われ、自動でアップデートされます。また、Release Channelについては、”Official”(通常）、”Release Candidate”（リリース候補）、あとはUIアカウントのページから”Early Access”(ベータ版）を有効にすれば、3つのバージョンを選択できます。</p><blockquote><p>UI Account<br> <a href="https://account.ui.com/profile">https://account.ui.com/profile</a></p></blockquote><p>慣れるまではOfficialにしておくのがお勧めです。<br>Early Accessは事前確認する利用条件にある通り、守秘義務が存在します。許可なくその内容を第三者に開示してはいけません。安定しない場合も多く、広くユーザーに互換性を確認してもらうためのものです。</p><p>さて、ここまでで初期セットアップは完了です。<br>この段階でUCG-Ultraはインターネットへ接続可能になっているので、設定で利用したスマホアプリはUbiquitiクラウド経由でUCG-Ultraの操作が可能となっています。自宅でも外出中でもUCG-Ultraを操作できます。Cloud Gatewayという名前に相応しい基本機能です。</p><h2 id="セットアップの補足"><a href="#セットアップの補足" class="headerlink" title="セットアップの補足"></a>セットアップの補足</h2><p>私の環境（auひかり）ではとても簡単にセットアップが完了しました。なお、UniFiのゲートウェイ全般は現在、Officialリリースにおいてインターネットマルチフィード社が提供するtransix IPv4接続 (DS-Lite) への対応はされていますが、その他のIPv4 over IPv6の対応は現時点でサポート外となっています。</p><p>UniFiゲートウェイに関するガイドを以下に記載します。</p><ul><li>ネットワークが不安定、Lineなどでやり取りができなくなる。<br> 以下のガイドにMSS Clampingの設定で解決するという投稿がありますので確認ください。<br> Facebook Ubiquiti日本公式コミュニティ</li></ul><p> <a href="https://www.facebook.com/groups/uijapan/learning_content/?filter=167949146143924&post=3507234616157550">https://www.facebook.com/groups/uijapan/learning_content/?filter=167949146143924&amp;post=3507234616157550</a><br> この設定についてはUCG-Ultraにブラウザでログインし、WANのMSS Clampingの値をCustomの1414や1420等に設定する必要があります。具体的な設定はISPにより異なります。</p><ul><li>IPv6 IPoE transix IPv4 (DS-Lite)の設定手順｜Ubiquiti UniFi</li></ul><p> <a href="https://note.com/ui_japan/n/n3154ff641db5">https://note.com/ui_japan/n/n3154ff641db5</a></p><p>インターネットマルチフィードのDS-Liteは以下のISPが対象となります。</p><ul><li>株式会社インターネットイニシアティブ<br> IIJ IPv6 FiberAccess&#x2F;Fサービス タイプIPoE</li><li>株式会社インターネットイニシアティブ<br> IIJmioひかり</li><li>株式会社インターネットイニシアティブ<br> IIJmio FiberAccess&#x2F;NF</li><li>株式会社インターリンク<br> ZOOT NATIVE</li><li>エキサイト株式会社<br> excite MEC光</li><li>エキサイト株式会社<br> BB.excite光Fit</li><li>エキサイト株式会社<br> BB.exciteコネクトIPoE接続プラン</li><li>スターティア株式会社<br> マネージドゲート2</li><li>メディアウェイブシステムズ株式会社<br> Hybrid64 (ハイブリッド・ろくよん）</li><li>メディアウェイブシステムズ株式会社<br> メディアひかり</li></ul><p>（引用： <a href="https://www.mfeed.ad.jp/transix/customers/">https://www.mfeed.ad.jp/transix/customers/</a>）</p><p>FacebookのUbiquiti日本公式コミュニティの情報によれば、ASAHIネットなど、対応ISPを増やす対応に取り組まれているようです。なお、PPPoEやDS-Liteのデータ転送時に、MSSの調整、すなわちデータ部分を切り詰める必要が発生するのは仕方のない事です。ネットワーク機器は専用チップ（ASIC)が処理する事が基本であり、CPUがデータ処理すると、途端にパフォーマンスがダウンしてしまいます。これは一般的に考えられるよりもネットワーク機器のCPUが非力なためです。UCG-UltraはUXよりCPUが強化され、IDS&#x2F;IPSが実行できるようになりましたが、それでもスマホ相当であり、小型PCと比較しても非力です。</p><table><thead><tr><th>CPU</th><th>CPU Mark</th></tr></thead><tbody><tr><td>ARM Cortex-A53 4 Core 1512 MHz※UCG-Ultra</td><td>472</td></tr><tr><td>Intel   Celeron J1900 @ 1.99GHz</td><td>1,150</td></tr><tr><td>Intel N100</td><td>5,552</td></tr></tbody></table><blockquote><p>Passmark software<br> <a href="https://www.cpubenchmark.net/cpu_list.php">https://www.cpubenchmark.net/cpu_list.php</a></p></blockquote><p>日本は世界の中でも通信速度においては先進的であり、日本のユーザーの目線が高いのは事実です。PPPoEが存在するのは日本に限った話ではありませんが、PPPoEとIDS&#x2F;IPSとを併用するとCPUパワーも必要になりパフォーマンスの問題は発生しやすいようです。<br>UCG-Ultraの技術仕様のIDS&#x2F;IPSの項には「<strong>ISP の実装によって PPPoEでは性能が低下する可能性があります。</strong>」と記載されています。</p><p>私が利用しているauひかりは、PPPoEやDS-Liteを使わず1,500バイトをLAN同様に転送できますので、パフォーマンスの問題は発生しません。他にもCATVなどもこういった問題にはあまり関わる事がありません。一方、DS-LiteなどではIPv6の複数サブネットの配布（Prefix Delegation）は魅力的なのも事実でありISPの選定は悩ましいものがあります。</p><p>なお、ここではIPv6の説明は割愛しますが、auひかりのホームゲートウェイ（HGW）からUXにPrefix DelegationでIPv6サブネットを1つ割り振る設定を以下の記事で記載しています。その他、通知機能やSSH、プライベートDNS、VPNなどの基本設定についても記載しています。</p><ul><li><a href="/new-technology/2024/03/06/unifi-express/" title="UniFi Express">UniFi Express</a></li><li><p>Ubiquiti日本公式コミュニティ</p></li></ul><p> <a href="https://www.facebook.com/groups/uijapan">https://www.facebook.com/groups/uijapan</a></p><p>初期セットアップは終了し、Windows PCをUCG-Ultraに繋いで、IPv4、IPv6の割り当てが確認できました。</p><img src="/new-technology/2024/06/25/UCG-Ultra/wan.png" class="" width="1024" title="alt"><p>Windowsは以下のようにIPアドレスが振られています。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Windows IP 構成</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">イーサネット アダプター イーサネット:</span><br><span class="line"></span><br><span class="line">   接続固有の DNS サフィックス . . . . .: localdomain</span><br><span class="line">   IPv6 アドレス . . . . . . . . . . . .: 240f:103:xxxx:3:17f7:xxxx:xxxx:4c40</span><br><span class="line">   一時 IPv6 アドレス. . . . . . . . . .: 240f:103:xxxx:3:2594:xxxx:xxxx:e4c7</span><br><span class="line">   リンクローカル IPv6 アドレス. . . . .: fe80::7baf:af2:aa9:55a0%18</span><br><span class="line">   IPv4 アドレス . . . . . . . . . . . .: 192.168.1.170</span><br><span class="line">   サブネット マスク . . . . . . . . . .: 255.255.255.0</span><br><span class="line">   デフォルト ゲートウェイ . . . . . . .: fe80::xxxx:xxff:fexx:xxxx%18</span><br><span class="line">                                          192.168.1.1</span><br></pre></td></tr></table></figure><h2 id="UCG-Ultraを利用したセキュリティ強化"><a href="#UCG-Ultraを利用したセキュリティ強化" class="headerlink" title="UCG-Ultraを利用したセキュリティ強化"></a>UCG-Ultraを利用したセキュリティ強化</h2><h3 id="UCG-Ultraは何が出来るのか"><a href="#UCG-Ultraは何が出来るのか" class="headerlink" title="UCG-Ultraは何が出来るのか"></a>UCG-Ultraは何が出来るのか</h3><p>セキュリティに関しては話をシンプルにするため、一旦IPv4のみ割り当てが行われた状態で確認していきます。</p><h4 id="ジオロケーション"><a href="#ジオロケーション" class="headerlink" title="ジオロケーション"></a>ジオロケーション</h4><p>IPアドレスによる国別の認識が出来ています。</p><img src="/new-technology/2024/06/25/UCG-Ultra/geo.png" class="" width="1024" title="alt"><h4 id="トラフィック識別"><a href="#トラフィック識別" class="headerlink" title="トラフィック識別"></a>トラフィック識別</h4><img src="/new-technology/2024/06/25/UCG-Ultra/traffic.png" class="" width="1024" title="alt"><p>IDS&#x2F;IPSの設定をしていない初期設定状態でもトラフィックの識別はできています。この状態でのPCのスピードテストはワイヤレート（下り947Mbps&#x2F;上り942Mbps）の速度が出ています。</p><h4 id="IDS-IPS"><a href="#IDS-IPS" class="headerlink" title="IDS&#x2F;IPS"></a>IDS&#x2F;IPS</h4><p>IDS&#x2F;IPSの説明は以下の通りです。</p><table><thead><tr><th>略称</th><th>名称</th><th>動作</th></tr></thead><tbody><tr><td>IDS</td><td>Intrusion Detection System</td><td>アラートのみ</td></tr><tr><td>IPS</td><td>Intrusion Prevension System</td><td>防御（当該通信をReset）</td></tr></tbody></table><p>一般的にブラウザで利用するトラフィックは一般的に9割以上がhttps通信と言われており、SSL&#x2F;TLSにより暗号化されています。暗号化されている通信はその間にUCG-Ultraが入り込んでも情報を奪取できません。それでもトラフィック識別ができているのは、接続先のIPアドレスに加え、SSL&#x2F;TLSによるハンドシェイク時にリクエストされるSNI（Server Name Indicator）が平文で相手のFQDNをリクエストするため、どんなアプリケーションを利用しているのか判定する事が可能になっています。例えば、Appleのサイトにhttps接続する場合に最初のハンドシェイク時にSNIの情報が確認できます。</p><img src="/new-technology/2024/06/25/UCG-Ultra/wireshark.png" class="" width="1024" title="alt"><p>UCG-Ultraで識別が不能な場合は、UniFiのトラフィック識別においてSSL&#x2F;TLSで一括りとなっています。またhttps通信をTCPではなくUDPを使い高速化したQUICプロトコルもあります。セキュリティレベルの高い事業者では、このQUICを認めないなどもある一方でGoogle系サービス（Gmail、Youtube）や国内の大手報道機関ではQUICプロトコルが採用されています。正直、SSL&#x2F;TLS、QUICが通信の大半と予想されます。</p><p>ユーザーとしては疑わしい通信は排除するIPSが一般的に使われます。しかしながら前述の通り暗号化された通信が大半である環境下において、IPSがシグネチャベースで検出する能力を持っていても、暗号化されたパケットは検査できません。これを実現するならばSSL&#x2F;TLSインスペクションといったSSL&#x2F;TLS解析の仕組みが必要ですが、大量のCPUリソースを使うことや端末毎にCA証明書のインストールが必要であるため個人向けには一般的ではありません。</p><p>マルウェアやウィルスが配布されるような危険なサーバーに接続しようとしたところでDNSやIPS（SNIによる接続先検証）で防御することがまずはホームユーザー向けの対策と言えるでしょう。</p><h4 id="広告ブロック"><a href="#広告ブロック" class="headerlink" title="広告ブロック"></a>広告ブロック</h4><p>UNAの設定（歯車アイコン）から、<mark class="label primary">セキュリティ</mark>を選択します。<br>ここでは<mark class="label primary">広告ブロック</mark>にチェックしておきます。他に追加の設定は不要です。<br>DNSシールドはDNSによる名前解決時にDoH（DNS over HTTPS）を使い、GoogleまたはCloudflareで名前解決するものです。TLS&#x2F;SSLで暗号化されているので、プロバイダや途中の経路において、どこにアクセスしているのか判らないようにする目的があります。日本のISPはDDoS対策のために独自のDNSフィルタを実施していることや、その情報を売却するなどの行為が厳しいために日本においてはDNSシールドの重要性はあまり無いものと考えられます。<br>なお、このDNSフィルタを使っていても、広告ブロックは有効です。</p><h3 id="UCG-Ultraを使ったセキュリティの高め方"><a href="#UCG-Ultraを使ったセキュリティの高め方" class="headerlink" title="UCG-Ultraを使ったセキュリティの高め方"></a>UCG-Ultraを使ったセキュリティの高め方</h3><p>UCG-Ultraを使ってどのようにセキュリティを高めるかという観点では、使える機能は使うべきということになるでしょう。利用することで特にデメリットとなることはパフォーマンスに関する観点くらいだと考えられます。</p><ul><li>IoT機器をお持ちであれば、PCなど多くのInternetとやり取りする機器とはネットワークを分離する。同様にリモートワークで使う会社貸与のPCなども自分が所有するPCとは分離することをお勧めします。これはタグVLANを設定し実現します。UniFiのAPを使うことでさらにSSID毎に属するVLANを変えられます。</li><li>広告フィルタを行う。これは広告サイトが必ずしも安全とは言えないこと、不要なトラフィックが減らせます。</li><li>IPSでリスクのあるサイトをブロックする。不要なVPNサイトが止められリスクを軽減できます。</li><li>国別フィルタを使って不要国を止める。米国から一定量の攻撃がある事からも米国を止めるのは現実的でありませんが、普段アクセスしない国が明確なのであれば停止すべきでしょう。</li></ul><h3 id="国別フィルタ、IPSの具体例"><a href="#国別フィルタ、IPSの具体例" class="headerlink" title="国別フィルタ、IPSの具体例"></a>国別フィルタ、IPSの具体例</h3><p>設定はとても簡単です。一例としては以下の通りです。</p><img src="/new-technology/2024/06/25/UCG-Ultra/ips.png" class="" width="640" title="alt"><p>フィルタリングは通知とブロック（IPS相当）とし、検出感度は高めに設定してあります。<br>さらに、ネットワーク（LAN）の画面からコンテンツフィルタを有効にします。</p><img src="/new-technology/2024/06/25/UCG-Ultra/lan.png" class="" width="640" title="alt"><p>コンテンツフィルタリングは仕事、家族と選択できますが、家族にしておけばVPNを止められます。</p><p>国別フィルタは、フィルタをすり抜ける可能性もあります。中国のメーカーであっても、サーバーをAkamai（セキュリティベンダー）上に構築していたり、コンテンツデリバリネットワーク（CDN）やCloudflareにあれば同様に判定が難しくなります。</p><p>また、危険なサイトに関する情報についてはIPv4に関しては情報共有は積極的に行われるものの、IPv6についてはその情報共有が少ないのが実情です。今後、IPv6のコンテンツフィルタ機能が拡充されたとしても、IPv4だけのネットワークの方がセキュリティ上は安全ともいえるジレンマを抱えることになります。</p><p>UCG-Ultraではロシアや中国企業のWebサイトでアクセスできない（パケットは拒否される）事を確認できています。フィッシングの手口ではこれらの国はよく使われるため、これらの抑止策はフェールセーフとして期待できます。</p><p>私の環境ではこの設定を行った上でのInternet速度テストは以下の通りでした。</p><img src="/new-technology/2024/06/25/UCG-Ultra/speedtest2.png" class="" width="320" title="alt"><p>ダウンロードが947Mbpsから925Mbpsに下がりましたが、殆ど誤差でしょう。私の環境だと、パフォーマンスを意識してセキュリティレベルを下げる必要は無さそうです。</p><p>(2024-06-27追記)<br>なお、UCG-Ultraのスペックシートでは、IPS利用時に1Gbpsのルーティング機能とある通り、LANからWANへのスループットはクライアントを2台同時に利用した場合、上限はスペック通り合計で1Gbps程度です。セットアップ時は特に気にしていなかったのですが、IPSを外してみた場合のクライアント2台でもやはり1Gbps。運用としてはIPSを使う事が前提となるので結果は変わらないのでしょうが、WAN Portが2.5Gbpsであるにも関わらずLAN-WANのスループットが1Gbpsというのは少し疑問が残りました。前述した通り、UCG-Ultra本体からのスピードテストは2.5Gbpsワイヤレートしっかりと出ているのですが。</p><h3 id="アプリケーションのブロックとFirewallのブロック"><a href="#アプリケーションのブロックとFirewallのブロック" class="headerlink" title="アプリケーションのブロックとFirewallのブロック"></a>アプリケーションのブロックとFirewallのブロック</h3><p>UniFiゲートウェイには、アプリケーションタイプでの制御（許可、ブロック）と従来型のFirewallのネットワーク、Port単位の制御の2通りがあります。Ubiquitiはそれぞれ、<mark class="label primary">シンプル</mark>、<mark class="label primary">高度な</mark>と分かれています。<mark class="label primary">シンプル</mark>の方がアクセス統計のアプリから止められるため直感的で簡単です。ネットワークに慣れている方は従来のIPネットワーク、Portで止める方法もあります。ただ、自宅でサーバーを立てる時にPort8443などでWebサーバーを立てる事が多いように、必ずしもSSL&#x2F;TLSがPort443とは限りません。そういう意味ではアプリケーションで止めていく方が時代の流れには沿っていると考えられます。</p><p>シンプルのルール表示の例です。</p><img src="/new-technology/2024/06/25/UCG-Ultra/fw1.png" class="" width="1024" title="alt"><p>高度なルール表示の例です。</p><img src="/new-technology/2024/06/25/UCG-Ultra/fw2.png" class="" width="1024" title="alt"><p>シンプルなルールでInternetに出ていくアプリケーションのうち、DNS(53&#x2F;TCP,UDP)、DoT（DNS over TLS(853&#x2F;TCP)）、DoH（DNS over HTTPS(443&#x2F;TCP)）とを止めるルールです。基本的にDNSはUCG-UltraがInternetに名前解決を問い合わせするため、クライアントがInternetとDNSで直接セッションを張る必要はないとして、ブロックするルールです（ユーザーの考え方次第でこのルールが多くの人に適合するというわけではありません）。</p><img src="/new-technology/2024/06/25/UCG-Ultra/fw3.png" class="" width="640" title="alt"><p>従来型のファイアウォール設定、つまり高度なルールの設定です。Port 53&#x2F;TCP,UDPをInternetに出ていくものをブロックする設定を保険的に明示しています。</p><img src="/new-technology/2024/06/25/UCG-Ultra/fw4.png" class="" width="640" title="alt"><p>高度なルールでDoTはPort853を指定して止める方法はありますが、DoHは暗号化されているのでファイアウォールでは検出不可能です。しかし、UCG-UltraはDoHの接続先（SNI)を見てブロックしているものと考えられ、シンプルなルールを使うことで簡単にアクセス制御ができます。</p><p>最近はサイバーの脅威保護にDNSを使って情報資産を保護する取り組みは多い一方、ブラウザを提供しているITベンダーは広告を回避されたくないためユーザーが指定したDNSを参照せず、ベンダーが提供するDNSを（DoHを使って）参照しようとします。DoHでユーザーが用意したDNSの広告ブロックをバイパスするためです。ただこれがサイバー対策を迂回されてしまうリスクにもなります。</p><p>SSL&#x2F;TLSインスペクションを使ったとしても完璧ではなく、最終的にはセキュリティ機器がどれだけ早く脅威情報を取り込めるかどうかに掛かっています。個人に対するサイバー攻撃で一番多いのはフィッシング詐欺です。このような仕組みでセキュリティを高めることに加え、多要素認証などを組み合わせる事でフィッシングの脅威から保護する事が重要です。</p><blockquote><p>Ubiquiti Deep Dive into Advanced Firewall Rules<br> <a href="https://help.ui.com/hc/en-us/articles/115003173168-Deep-Dive-into-Advanced-Firewall-Rules">https://help.ui.com/hc/en-us/articles/115003173168-Deep-Dive-into-Advanced-Firewall-Rules</a></p></blockquote><h3 id="仮想ネットワーク（VLAN）"><a href="#仮想ネットワーク（VLAN）" class="headerlink" title="仮想ネットワーク（VLAN）"></a>仮想ネットワーク（VLAN）</h3><p>前述した通り、IoT機器などのために、普段使うネットワークと分離するために新しいネットワークを作成できます。私の場合、ChromebookやAmazon Echo、Amazon FireTVなどは全てゲストネットワークとして、PCやスマホで普段使うネットワークとは分離しています。<br>UniFiでは「仮想ネットワーク」としてVLANを定義しています。ネットワークの設定から「新しい仮想ネットワーク」を選択します。</p><img src="/new-technology/2024/06/25/UCG-Ultra/guest.png" class="" width="1024" title="alt"><p>ここでの例はGuestという名前を付けました。ネットワークアドレスは<code>192.168.10.0/24</code>、IPアドレスの第3オクテットに合わせてVLAN IDは10としています。ネットワーク分離を有効にし、Defaultネットワークとはお互いにルーティングできないようにしつつもInternetへのアクセスは可能としています。DHCPも有効になります。</p><p>続いてPortマネージャーから、UCG-Ultraのポートを設定変更します。ここでは単一の端末を接続できるための設定をします。</p><img src="/new-technology/2024/06/25/UCG-Ultra/port.png" class="" width="1024" title="alt"><p>ネイティブVLANネットワークはguestを選択します。つまりタグ10のVLANをネイティブ（タグ無し）として設定します。さらに他のネットワーク（Default)のパケットがタグ付きで外に出て行かないように、タグ付きVLAN管理の項目は<mark class="label primary">すべてをブロック</mark>にチェックを付けておきます。</p><p>この2か所の設定で、Port2に端末を接続することで上記で作成したネットワーク（VLAN&#x3D;10)のIPアドレスが割り当てられます。<br>以下はUCG-UltraのPort2に接続したChromebookの画面です。</p><img src="/new-technology/2024/06/25/UCG-Ultra/chromebook.png" class="" width="480" title="alt"><p>これでIoTはインターネットにはアクセスできますが、自宅の重要な機器とは分離されます。PCがマルウェアに感染し、やがてセキュリティ上脆弱なIoTに感染してしまうということを防止できます。その逆も然りです。</p><p>NASやサーバーがある場合、Default、ゲストだけでなく、サーバー用のVLANを作成し、Defaultとサーバーとは高度なファイアウォールを使用し、最低限度のプロトコルを通すなどすればよりセキュアな環境が整います。</p><p>また、今回は詳細の説明を割愛しますが、ルーティング機能も業務レベルの機能が用意されています。</p><img src="/new-technology/2024/06/25/UCG-Ultra/routing.png" class="" width="1024" title="alt"><p>特定のドメインや地域などでルーティング先を変えるポリシーベースのルーティングやOSPF、L3スイッチなどを追加した場合の静的ルーティングに加え、DNSのカスタム設定（Aレコードだけではなく、MX、CNAME）などネットワーク機器としてはかなり多機能です。</p><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>今回は、Cloud Gateway Ultraをセキュリティの観点から検証してみました。今後APやネットワークスイッチを導入する小型ネットワークを敷設される場合には候補になるプロダクトであると考えられます。</p><blockquote><p>UI Japan Store Cloud Gateway Ultra<br><a href="https://jp.store.ui.com/jp/ja/pro/category/cloud-gateways-compact/products/ucg-ultra">https://jp.store.ui.com/jp/ja/pro/category/cloud-gateways-compact/products/ucg-ultra</a></p></blockquote><p>価格は23,899円です。</p><h2 id="Interop24"><a href="#Interop24" class="headerlink" title="Interop24"></a>Interop24</h2><p>6月12日〜14日の幕張で行われたInterop24でUbiquiti製品が紹介されていましたので、写真を撮ってきました。</p><p>UXG-LiteとUCG-Ultra（これだとサイズ感が分からないですね。。。）</p><img src="/new-technology/2024/06/25/UCG-Ultra/interop1.png" class="" width="1024" title="alt"><p>PoEスイッチ　Switch Ultra</p><img src="/new-technology/2024/06/25/UCG-Ultra/interop2.png" class="" width="1024" title="alt"><p>UCG-UltraはPoEを持っていないので、UniFi APを接続する際は、別途PoEアダプタが必要となります。このSwitch UltraはPoEによる電源供給ができるのでAPや監視カメラなどを将来的に拡張していくのにちょうど良いスイッチかもしれません。</p><blockquote><p>Switch Ultra<br> <a href="https://jp.store.ui.com/jp/ja/pro/category/switching-utility/collections/pro-ultra">https://jp.store.ui.com/jp/ja/pro/category/switching-utility/collections/pro-ultra</a></p></blockquote><h2 id="補足説明"><a href="#補足説明" class="headerlink" title="補足説明"></a>補足説明</h2><blockquote><p>Ubiquiti Japan ホームページ<br> <a href="https://note.com/ui_japan">https://note.com/ui_japan</a></p></blockquote><blockquote><p>Ubiquiti コミュニティ（日本）<br> <a href="https://www.facebook.com/groups/uijapan">https://www.facebook.com/groups/uijapan</a></p></blockquote><blockquote><p>Ubiquiti Community（米国中心）<br> <a href="https://community.ui.com/">https://community.ui.com/</a></p></blockquote><p>（製品提供：Ubiquiti Japan株式会社）</p>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2024/06/25/UCG-Ultra/0.png&quot; class=&quot;&quot; width=&quot;1024&quot; title=&quot;alt&quot;&gt;
&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;

&lt;p&gt;UniFiの新しい小型ゲートウェイUniFi Cloud Gatewayのセットアップ、機能紹介、ホームユーザー向けのセキュリティ対策の実例を掲載しています。検証のため製品提供を受けていますのでこの記事はPR要素を含みます。&lt;/p&gt;</summary>
    
    
    
    <category term="Hardware" scheme="https://yoshi0808.github.io/new-technology/categories/Hardware/"/>
    
    <category term="Network" scheme="https://yoshi0808.github.io/new-technology/categories/Network/"/>
    
    
    <category term="UniFi" scheme="https://yoshi0808.github.io/new-technology/tags/UniFi/"/>
    
  </entry>
  
  <entry>
    <title>Sophos Firewall v20 MR1</title>
    <link href="https://yoshi0808.github.io/new-technology/2024/06/08/xg-v20mr1/"/>
    <id>https://yoshi0808.github.io/new-technology/2024/06/08/xg-v20mr1/</id>
    <published>2024-06-07T19:01:00.000Z</published>
    <updated>2024-06-08T03:15:09.397Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2024/06/08/xg-v20mr1/Title.png" class="" title="alt"><h2 id="Sophos-Firewall-v20"><a href="#Sophos-Firewall-v20" class="headerlink" title="Sophos Firewall v20"></a>Sophos Firewall v20</h2><p>Sophos Firewall v20 MR1が2024年05月15日に発表されました。デバイスからのアクセス制御でAD SSO, Captive Portal, RADIUS SSO, Client Authentication, Chromebookなどの認証制御が細かく設定できること、VPNのエンハンスが挙げられます。 </p><span id="more"></span><p>v20　MR1の詳細な説明はSophos Communityを参照してください。</p><blockquote><p><a href="https://community.sophos.com/sophos-xg-firewall/b/blog/posts/sophos-firewall-os-v20-mr1-is-now-available">https://community.sophos.com/sophos-xg-firewall/b/blog/posts/sophos-firewall-os-v20-mr1-is-now-available</a></p></blockquote><p>リリースノートはこちらです</p><blockquote><p><a href="https://docs.sophos.com/releasenotes/index.html?productGroupID=nsg&productID=xg&versionID=20.0">https://docs.sophos.com/releasenotes/index.html?productGroupID=nsg&amp;productID=xg&amp;versionID=20.0</a></p></blockquote><h2 id="Sophos-Firewallのアップデート"><a href="#Sophos-Firewallのアップデート" class="headerlink" title="Sophos Firewallのアップデート"></a>Sophos Firewallのアップデート</h2><p>管理画面にログイン後、左ペインメニューの<mark class="label primary">バックアップ＆ファームウェア</mark>の<mark class="label primary">ファームウェアの確認</mark>でアップデートの案内が順次来ます。</p><img src="/new-technology/2024/06/08/xg-v20mr1/mr1-1.png" class="" width="800" title="alt"><p>個別にバージョンアップのファイルを入手するには、以下のURLからダウンロードします。</p><p><a href="https://support.sophos.com/support/s/article/KB-000043162?language=en_US">https://support.sophos.com/support/s/article/KB-000043162?language=en_US</a></p><ol><li>上記画面で<mark class="label primary">Sophos Firewall</mark>の<mark class="label primary">ファームウェア</mark>の<mark class="label primary">ソフトウェア</mark>のLinkをクリックします。</li><li>“SW-20.0.1_MR-1.SFW-342.sig”をダウンロードします。</li><li>Sophos Firewallの管理画面にログインし、左ペインメニューの<mark class="label primary">バックアップ＆ファームウェア</mark>の<mark class="label primary">ファームウェアのタブメニュー</mark>から以下の画面に赤丸で囲った矢印のアイコンをクリックし、ダウンロードしたモジュールをアップロードします。</li></ol><img src="/new-technology/2024/06/08/xg-v20mr1/verup.png" class="" width="800" title="alt"><p>アップロード＆再起動ボタンをクリックし、v20 MR1へのアップグレードを完了させます。</p>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2024/06/08/xg-v20mr1/Title.png&quot; class=&quot;&quot; title=&quot;alt&quot;&gt;

&lt;h2 id=&quot;Sophos-Firewall-v20&quot;&gt;&lt;a href=&quot;#Sophos-Firewall-v20&quot; class=&quot;headerlink&quot; title=&quot;Sophos Firewall v20&quot;&gt;&lt;/a&gt;Sophos Firewall v20&lt;/h2&gt;&lt;p&gt;Sophos Firewall v20 MR1が2024年05月15日に発表されました。デバイスからのアクセス制御でAD SSO, Captive Portal, RADIUS SSO, Client Authentication, Chromebookなどの認証制御が細かく設定できること、VPNのエンハンスが挙げられます。 &lt;/p&gt;</summary>
    
    
    
    <category term="Security" scheme="https://yoshi0808.github.io/new-technology/categories/Security/"/>
    
    
    <category term="XG Firewall" scheme="https://yoshi0808.github.io/new-technology/tags/XG-Firewall/"/>
    
  </entry>
  
  <entry>
    <title>Proxmox 8.2へのアップグレード</title>
    <link href="https://yoshi0808.github.io/new-technology/2024/05/02/update-ProxmoxTo82/"/>
    <id>https://yoshi0808.github.io/new-technology/2024/05/02/update-ProxmoxTo82/</id>
    <published>2024-05-02T13:58:30.000Z</published>
    <updated>2024-05-03T00:02:29.363Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2024/05/02/update-ProxmoxTo82/Title.png" class="" title="alt"><p class="onepoint">この記事で実現すること</p><p>2024-04-24にProxmox VE8.2が発表されています。ここではGUIでアップグレード（中身はapt upgrade）で説明するまでもないのですが、既知の不具合があり、ちょうど私のNIC（X710DA4）ではこの不具合の影響を受けることになったため、対応策についてまとめています。</p><span id="more"></span><h2 id="新機能"><a href="#新機能" class="headerlink" title="新機能"></a>新機能</h2><p>新機能については以下の通りです。</p><ul><li>Support for automated and unattended installation</li><li>Import wizard for VMware ESXi VMs</li><li>Modernized Firewall based on nftables</li><li>LXC device passthrough</li><li>Advanced Backup settings</li><li>Support for custom ACME-enabled CAs</li><li>UI improvements</li><li>Debian 12.5 (Bookworm), but using a newer Linux kernel 6.8;</li><li>New versions: QEMU 8.1, Ceph Reef 18.2, LXC 6.0, and Open ZFS 2.2;</li></ul><p>積極的にLinux Kernelのアップデートが行われていますね。</p><blockquote><p>Proxmox VE 8.2 What’s new<br> <a href="https://www.proxmox.com/en/services/videos/proxmox-virtual-environment/whats-new-in-proxmox-ve-8-2">https://www.proxmox.com/en/services/videos/proxmox-virtual-environment/whats-new-in-proxmox-ve-8-2</a></p></blockquote><h2 id="既知の不具合"><a href="#既知の不具合" class="headerlink" title="既知の不具合"></a>既知の不具合</h2><p>不具合については以下のページでまとめられています。</p><blockquote><p>Known Issues &amp; Breaking Changes<br> <a href="https://pve.proxmox.com/wiki/Roadmap#Proxmox_VE_8.2">https://pve.proxmox.com/wiki/Roadmap#Proxmox_VE_8.2</a></p></blockquote><p>IntelのNICでX710シリーズでは以下の影響を受けます。カーネル変更を受けてインタフェース名の末尾に<code>P0</code>という文字列が加わるとのこと。</p><p>Kernel: Change in Network Interface Names<br>Upgrading kernels always carries the risk of network interface names changing, which can lead to invalid network configurations after a reboot. In this case, you must either update the network configuration to reflect the name changes, or pin the network interface to its name beforehand.</p><p>See the reference documentation on how to pin the interface names based on MAC Addresses.</p><p>Currently, the following models are known to be affected at higher rates:</p><p>Models using i40e. Their names can get an additional port suffix like p0 added.</p><p>その他は、以下の項目が挙げられています。</p><ul><li>Kernel: DKMS(it may happen that installed DKMS modules will not build anymore)</li><li>Kernel: Split Lock Detection Slowing Down VMs</li><li>Old Ceph Crash Reports</li></ul><h2 id="アップグレード"><a href="#アップグレード" class="headerlink" title="アップグレード"></a>アップグレード</h2><p>ここでは8.1から8.2へのアップグレードを想定しています。<br>前述した通り、X710シリーズのNICをお持ちの方は、アップグレード後にネットワークインタフェース名の不一致によってネットワーク経由でProxmoxに到達できなくなります。従い、アップグレード後はモニタを接続し、ローカルのShellでネットワークインタフェース名を変更することになります。<br>GUIからは以下の通り実行します。その後再起動が必要です。</p><img src="/new-technology/2024/05/02/update-ProxmoxTo82/pve1.png" class="" title="alt"><p>Proxmoxのノードを選択の上、「アップデート」の項目から再表示し、アップグレードを実行します。</p><p>終了後、再起動させてアップグレード処理を完了させます。</p><h2 id="ネットワークインタフェースの変更"><a href="#ネットワークインタフェースの変更" class="headerlink" title="ネットワークインタフェースの変更"></a>ネットワークインタフェースの変更</h2><p>私の持っているインタフェースは8.1の時は以下の通りでした。</p><img src="/new-technology/2024/05/02/update-ProxmoxTo82/pve2.png" class="" title="alt"><p>8.2では以下になります（修正完了後）</p><img src="/new-technology/2024/05/02/update-ProxmoxTo82/pve3.png" class="" title="alt"><p>４つのインタフェースの末尾にnp0〜np3の文字列が加えられています。</p><p>さて、物理ノードにモニターを接続し、Proxmoxを起動します。</p><ol><li>ip address showで実際のインタフェース名を調べます。<code>ip a</code><br> 以下のように新しいカーネルでのインタフェース名を確認します。</li></ol> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2: enp1s0f0np0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq master vmbr0 state UP group default qlen 1000</span><br><span class="line">   <span class="built_in">link</span>/ether 3c:fd:fe:xx:xx:xx brd ff:ff:ff:ff:ff:ff</span><br></pre></td></tr></table></figure><ol start="2"><li>&#x2F;etc&#x2F;network&#x2F;interfacesファイルを修正します。ファイルのバックアップ取得をしてから実施をお勧めします。</li></ol> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">root@pve1:~# <span class="built_in">cd</span> /etc/network</span><br><span class="line">root@pve1:/etc/network# <span class="built_in">cp</span> interfaces interfaces.bak</span><br><span class="line">root@pve1:/etc/network# vi interfaces</span><br></pre></td></tr></table></figure><p> viなどでinterfacesファイルの以下の項目を見つけインタフェース名を<code>ip a</code>で出力されたインタフェース名に合わせます。<br> ちょうど<code>bridge-ports</code>の行です。これをインタフェースの数だけ修正します（私の場合は4Portなので４つ）。<br> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">auto vmbr0</span><br><span class="line">iface vmbr0 inet static</span><br><span class="line">       address 192.168.2.x/24</span><br><span class="line">       gateway 192.168.2.x</span><br><span class="line">       bridge-ports enp1s0f0</span><br><span class="line">       bridge-stp off</span><br><span class="line">       bridge-fd 0</span><br></pre></td></tr></table></figure><br>3. ネットワークをリスタートします。<code>service networking restart</code></p><p>これで対応は完了です。</p><h2 id="その他（古いカーネルでの起動）"><a href="#その他（古いカーネルでの起動）" class="headerlink" title="その他（古いカーネルでの起動）"></a>その他（古いカーネルでの起動）</h2><p>その他の何らかのトラブルでが発生した場合、古いカーネルで起動したい場合は、Bootメニューに古いカーネルが選択できます（UEFIのGRUB）。<br>今回の8.1からのアップグレードでは、古いカーネルは、6.5.13-5、新しいカーネルは、6.8.4-2でした。</p><p>もししばらく古いカーネルで起動したいということであれば、以下のコマンドで古いカーネルにピン留めできます。<br><code>proxmox-boot-tool kernel pin 6.5.13-5-pve</code></p><p>新しいカーネルに戻す時は以下のコマンドで元に戻します。<br><code>proxmox-boot-tool kernel pin 6.8.4-2-pve</code></p>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2024/05/02/update-ProxmoxTo82/Title.png&quot; class=&quot;&quot; title=&quot;alt&quot;&gt;

&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;

&lt;p&gt;2024-04-24にProxmox VE8.2が発表されています。ここではGUIでアップグレード（中身はapt upgrade）で説明するまでもないのですが、既知の不具合があり、ちょうど私のNIC（X710DA4）ではこの不具合の影響を受けることになったため、対応策についてまとめています。&lt;/p&gt;</summary>
    
    
    
    
    <category term="proxmox" scheme="https://yoshi0808.github.io/new-technology/tags/proxmox/"/>
    
  </entry>
  
  <entry>
    <title>XCP-ngのVM新規作成</title>
    <link href="https://yoshi0808.github.io/new-technology/2024/04/07/xcpng-newvm/"/>
    <id>https://yoshi0808.github.io/new-technology/2024/04/07/xcpng-newvm/</id>
    <published>2024-04-06T15:17:27.000Z</published>
    <updated>2024-05-10T22:14:08.010Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2024/04/07/xcpng-newvm/Title.png" class="" width="1024" title="alt"><p class="onepoint">この記事で実現すること</p>ESXi代替としての仮想環境ソフトウェアのXCP-ng、またそのオペレーションをGUIで支援するXen Orchestraを利用して新規のVMを作成します。<span id="more"></span><h2 id="VMにおけるネットワークの考え方"><a href="#VMにおけるネットワークの考え方" class="headerlink" title="VMにおけるネットワークの考え方"></a>VMにおけるネットワークの考え方</h2><p>前回の記事「<a href="/new-technology/2024/04/07/xcpng/" title="XCP-ngとXen Orchestra">XCP-ngとXen Orchestra</a>」では、PIFs（物理ネットワーク）とPrivate Networkを学びました。基本的にVLANを使わないのであれば、新規VMを構築する場合に物理ネットワークのPortに仮想MACアドレスが自動的に割り当てられます。ユーザーはどのPort（どのネットワーク）を使うか指定するだけです。複数のPortを持つNICがある場合は、VMの作成時にどのPortを使うのか（または複数選択）指定します。</p><h2 id="セットアップの前提条件"><a href="#セットアップの前提条件" class="headerlink" title="セットアップの前提条件"></a>セットアップの前提条件</h2><p>今回ここで新規VMを作成するのはXCP-ng8.3Betaであり、サーバーはRyzen9 7900となります。この操作に関しては8.2.1と違い殆どありません。今回インストールするRocky Linux 9のテンプレートも変わらず使えます。</p><h2 id="ISOsフォルダにisoファイルをアップロード"><a href="#ISOsフォルダにisoファイルをアップロード" class="headerlink" title="ISOsフォルダにisoファイルをアップロード"></a>ISOsフォルダにisoファイルをアップロード</h2><p>前回の記事では”ISOs”というISO専用フォルダをXCP-ng用に作成しました。このフォルダにインストールするISOを入れてみます。<br>左ペインの<mark class="label primary">Import</mark>→<mark class="label primary">Disk</mark>と進みます。</p><img src="/new-technology/2024/04/07/xcpng-newvm/xo1.png" class="" width="1024" title="alt"><mark class="label primary">Select SR</mark>とあるので、対象のXCP-ngのノードに属する"ISOs"フォルダを選択します。そしてそこにISOファイルをDrag&Dropします。ここではRocky Linux（Rocky-9-Workstation...iso）をアップロードしてみます。Rocky LinuxはEnterprise向けであり長期サポートを謳っているプロダクトです。<h2 id="VMの新規構築"><a href="#VMの新規構築" class="headerlink" title="VMの新規構築"></a>VMの新規構築</h2><p>左ペインの<mark class="label primary">New</mark>→<mark class="label primary">VM</mark>と進みます。VMの新規作成画面になります。</p><ol><li>先頭のプルダウンでVMを導入するXCP-ngサーバーを選択します。2台以上のXCP-ngでPoolの設定が行われている場合はPool単位に指定します。</li><li>Info：VMのOSテンプレートを選択します。ここでは”Rocky Linux 9”を選択します。</li><li>Performance: vCPUとメモリの量を決めます。</li><li>Install Settings: アップロードしたISOファイルを選択します。</li></ol><img src="/new-technology/2024/04/07/xcpng-newvm/xo2.png" class="" width="800" title="alt"><ol start="5"><li>Interfaces: 利用するネットワークに応じて”Pool-wide Network associate with ethx” を選択します。”Host Internel…”は選択しません。もし、2つ以上の論理NICを加える場合は、<mark class="label primary">+ Add interface</mark>ボタンをクリックします。</li><li>Disks: 論理Diskの容量を設定します。</li><li><mark class="label primary">Show advanced settings</mark>ボタンをクリックします。</li></ol><img src="/new-technology/2024/04/07/xcpng-newvm/xo3.png" class="" width="800" title="alt"><ol start="8"><li>上記のように”Auto power on”（XCP-ngがBoot時にVM起動）、OSがUEFI対応の場合は、”UEFI”のトグルをONにします。なお、Max vCPUsにデフォルトで1という値が入っているので削除しています。</li></ol><p>さて、準備ができたので、画面右下の”Create”ボタンをクリックしてVMの作成、起動を行います。</p><h2 id="VMの起動（Rocky-Linuxのインストール）"><a href="#VMの起動（Rocky-Linuxのインストール）" class="headerlink" title="VMの起動（Rocky Linuxのインストール）"></a>VMの起動（Rocky Linuxのインストール）</h2><p>自動起動後、XOの当該VMの<mark class="label primary">Console</mark>のタブでは実際のRocky Linuxのインストール画面が見られます。</p><img src="/new-technology/2024/04/07/xcpng-newvm/rocky1.png" class="" width="800" title="alt"><p>GNOMEなので、UbuntuもRocky Linuxも大きくは変わりませんが、Installしていきます。</p><img src="/new-technology/2024/04/07/xcpng-newvm/rocky2.png" class="" width="800" title="alt"><p>Ubuntuライクに管理者は作成せず、新規ユーザーを管理者として設定します。<br>インストール終了後は自身で再起動を選択します。その後、Rocky Linuxが起動してきます。</p><h2 id="VMToolsのインストール"><a href="#VMToolsのインストール" class="headerlink" title="VMToolsのインストール"></a>VMToolsのインストール</h2><p>さて、Rocky Linuxが起動してきた後に、インストールで利用したマウントを解除し、代わりにVMToolsのSRをマウントします。</p><img src="/new-technology/2024/04/07/xcpng-newvm/rocky3.png" class="" width="800" title="alt"><p>プルダウンから”guest-tools.iso”を選択します。その後Rocky Linuxを再起動します。</p><p>端末を起動し、Shellから、以下のコマンドを順に投入します。マウント、Toolsのインストール、アンマウントです。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> mount /dev/cdrom /mnt</span><br><span class="line"><span class="built_in">sudo</span> /mnt/Linux/install.sh</span><br><span class="line"><span class="built_in">sudo</span> umount /dev/cdrom</span><br></pre></td></tr></table></figure><p>これが終われば、特にリブートは不要でVMToolsのインストールが完了します。XCP-ngからリブート、シャットダウンが行え、また<mark class="label primary">Network</mark>のタブではL3の情報（IPアドレス）が表示出来るようになります。</p><img src="/new-technology/2024/04/07/xcpng-newvm/xo4.png" class="" width="1024" title="alt"><p>MACアドレスはVMを作成する時に自動で作成されています。ここでは”3e:2a:a8:24:12:c8”となっています。基本的にこのMACアドレスは不変ですが、バックアップから戻すときなどはまたMACアドレスが生成される事になるので、XCP-ngの管理上はクローンなのかVMの移動なのかを明確にオペレーションすることが求められます。こういう仕組みはESXiでもそうですし常識的な範囲の話ですね。</p><p>これでVMの導入については完了です。</p><h2 id="VMの設定変更"><a href="#VMの設定変更" class="headerlink" title="VMの設定変更"></a>VMの設定変更</h2><p>VMの構築後、<mark class="label primary">Advanced</mark>のタブを見てみます。</p><img src="/new-technology/2024/04/07/xcpng-newvm/xo5.png" class="" width="1024" title="alt"><p>Ubuntu22、Debian12のデスクトップ環境がある場合は、Video RAMの8MiBを16MiBに変更しておいた方が良いです。デフォルト値では画面操作がとても遅い状況になります。</p><mark class="label primary">NIC type</mark>がRealtek...となっていますが、これは気にしなくて良いそうです。基本的にはOS起動時に必要なドライバが組み込まれるので問題ありません。<mark class="label primary">CPU limits</mark>と<mark class="label primary">Memory limits</mark>は、減らす方向であればOSを稼働させたままで変更可能です。起動時の最大値に戻すこともできます。なお、起動時の初期値は動作中には行えず、一度VMを停止する必要があります。<h2 id="モジュールのインストール"><a href="#モジュールのインストール" class="headerlink" title="モジュールのインストール"></a>モジュールのインストール</h2><p>Debian系と異なり、Rocky Linuxでモジュールをインストールする際は<code>sudo dnf -y install module-name</code>を使います。<br>SSHとiperf3はまず基本セットでしょうか。SSHはConfigの設定でPort22を空けるなど多少追加設定が必要です。また、iperf3で待ち受けする場合は、Firewallの設定も必要になってきます。セキュアなOSだけに少し手間が掛かりますね。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">sudo</span> dnf -y install openssh-server</span><br><span class="line">$ <span class="built_in">sudo</span> dnf -y install iperf3</span><br></pre></td></tr></table></figure><h2 id="Ryzen9でのパフォーマンス"><a href="#Ryzen9でのパフォーマンス" class="headerlink" title="Ryzen9でのパフォーマンス"></a>Ryzen9でのパフォーマンス</h2><p>前回記事で記載したように、XCP-ngをRyzenで構築した場合、Ubuntuではiperf3のネットワークパフォーマンス（送信）が2Gbps程度と厳しい状況でした。しかし、Rocky Linux9に関しては、iperf3の上り&#x2F;下り共に9.0Gbps&#x2F;9.3Gbpsであり、Retryは、145&#x2F;0と素晴らしい内容でした。今回は、XCP-ng8.3BetaをRyzen9 7900で、XCP-ng8.2.1に関してはintel CPUでそれぞれセットアップの確認をしており、どちらとも問題はありません。</p><p>個人的にはあと3年半稼働できるESXi8を中心に使いつつ、少しづつProxmoxとXCP-ngも検証を続けていければと考えています。<br>ProxmoxにおけるRocky Linuxのiperf3は上り下り共に9.3Gbps前後出ていますが、送信時のRetryが13,000程度と異常値が出ています。ESXiでは当たり前のように使えていたものがいざ他のものに移ろうとすると、なかなか大変である事を実感しています。</p>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2024/04/07/xcpng-newvm/Title.png&quot; class=&quot;&quot; width=&quot;1024&quot; title=&quot;alt&quot;&gt;

&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;
ESXi代替としての仮想環境ソフトウェアのXCP-ng、またそのオペレーションをGUIで支援するXen Orchestraを利用して新規のVMを作成します。</summary>
    
    
    
    
    <category term="XCP-ng" scheme="https://yoshi0808.github.io/new-technology/tags/XCP-ng/"/>
    
  </entry>
  
  <entry>
    <title>XCP-ngとXen Orchestra</title>
    <link href="https://yoshi0808.github.io/new-technology/2024/04/07/xcpng/"/>
    <id>https://yoshi0808.github.io/new-technology/2024/04/07/xcpng/</id>
    <published>2024-04-06T15:00:00.000Z</published>
    <updated>2024-04-07T08:26:26.357Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2024/04/07/xcpng/title.png" class="" width="1024" title="alt"><p class="onepoint">この記事で実現すること</p>ESXi代替としての仮想環境ソフトウェアのXCP-ng、またそのオペレーションをGUIで支援するXen Orchestraの概要およびセットアップを行います。Xen Orchestraは有償ソフトウェアですが、オープンシステムとして提供されており、コンパイル、ビルドすることで無償で利用できます。<span id="more"></span><h2 id="ESXi代替としてのXCP-ng"><a href="#ESXi代替としてのXCP-ng" class="headerlink" title="ESXi代替としてのXCP-ng"></a>ESXi代替としてのXCP-ng</h2><p>無償版ESXiが新規で利用できなくなった現在、個人向けの仮想化基盤としての代替ソフトウェアはProxmoxが有力です。インストールも簡単でVMの作成までに迷うことが殆どありません。私個人としては、ProxmoxはあくまでPCという領域の範囲で便利なソフトウェアという認識を持っています。モジュールの更新が<code>apt update</code>であったり、バックアップ一覧がファイル名を意識させるものであったり、どこかでLinuxの延長として見てしまうところにあるのでしょうか。<br>個人向けであっても、仮想環境は、運用面における信頼性、保守性は重要と考えるユーザーには、もう1つの選択としてXCP-ngが候補となります。</p><p>XCP-ngはフランスのVatesという会社が提供しているプロダクトで、Citrix社のXenを引き継いで（技術提供を受けて）仮想環境の運用面と安定性を重要視して構築されているオープンシステムです。ESXiやProxmoxと比較し、CPU、メモリなどの基本的なスループットは劣ります。しかし、VM同士が互いに確実に分離され安定性が高いという意味においてはESXi同等です。KVMやProxmoxはメモリアクセスの観点では明確な分離が行われていないのでスループットは高くなります。</p><p>つまりXCP-ng、Proxmoxはそれぞれの良さがあり、選択するのはユーザー次第です。1台のみでお手軽な仮想環境を作るのであれば、Proxmox一択となるでしょう。一方で2台以上、障害時のフェールオーバーを想定したり、バックアップなどの運用を重視するのであればXCP-ngのメリットが出てきます。XCP-ngは単純に仮想マシンが動作するリソースとなるサーバーであり、それを操作するのは別途XenOrchestraというGUIツールが必要でこれは別ノードのLinux上に構築します。従い3台構成が1つの目安となります。1台はProxmoxまたはベアメタルでXenOrchestraをセットアップし、別のノードにXCP-ngをセットアップすることになります。最低構成は2台です。もちろん最終的にXenOrchestraのLinux-VMをXCP-ngにインポートすれば1台でXCP-ng+XenOrchestraを運用可能です（障害発生時はその回復に手間が掛かりますが）。</p><p>ホームユーザーとして本格的な連続稼働を前提として仮想環境を利用される場合に検討対象となります。</p><img src="/new-technology/2024/04/07/xcpng/XCP-ng1.png" class="" width="360" title="alt"><h2 id="現時点で未解決の事項"><a href="#現時点で未解決の事項" class="headerlink" title="現時点で未解決の事項"></a>現時点で未解決の事項</h2><h3 id="Ryzen-CPUと主要Linuxディストリビューション"><a href="#Ryzen-CPUと主要Linuxディストリビューション" class="headerlink" title="Ryzen CPUと主要Linuxディストリビューション"></a>Ryzen CPUと主要Linuxディストリビューション</h3><p>なお、1か月ほどRyzen環境でXCP-ngを試行錯誤しましたが、主要なLinux distribution（Ubuntu,Debian,Mint）のiperf3のスループットが不十分な状況であり、解決できませんでした。インターネットに対する接続のspeedtestは4Gbps-5Gbps程度出ている状況でこちらは全く問題がなく、原因がよく分かっていません。<br>Ryzen5 5600G、Ryzen9 7900と2種類のPCを用意して最新のバージョン8.2.1および8.3ベータで検証しましたがいずれもiperf3では送信ネットワークスループットが2Gbps程度でした。RyzenでもCPUの種類によっては高速に動作するようですが、巷に事例としてあるのは限られたCPUとマザーボードとの組み合わせのみになるようです。例外的に、Rocky LinuxだけはRyzenでも全く問題はなくiperf3でワイヤレートの速度が出ます。Windowsに関しては検証できていません。</p><p>結局、5年ほど前に稼働していたIntel(R) Core(TM) i7-8700 CPU @ 3.20GHz（6Core 12Thread）に加え、新規に12th Gen Intel(R) Core(TM) i5-12400（6Core 12Thread）を購入して主、従の関係を構築しました。なお、XCP-ngではintelのE Coreについて強くお勧めしないとのことです。こういった情報は原則、コミュニティから収集することになります。Vates社は有償サポートで収益を上げるモデルを選択していますが、コミュニティ上での無償サポートも積極的です。</p><h3 id="VMのUEFI"><a href="#VMのUEFI" class="headerlink" title="VMのUEFI"></a>VMのUEFI</h3><p>XCP-ngの検証を始めた時にはVMのセキュアブートは設定できたと記憶しているのですが、現時点で設定可能であるものの、VMの情報からはUEFIに対応していないという表記が出ます。確かにUEFIモードで起動しているようなのですが、現時点でその影響は判明していません。特に運用上実害は出ていません。</p><h2 id="XCP-ngのモジュールや関連プロダクト"><a href="#XCP-ngのモジュールや関連プロダクト" class="headerlink" title="XCP-ngのモジュールや関連プロダクト"></a>XCP-ngのモジュールや関連プロダクト</h2><p>最新モジュールは、8.2.1です。ベータバージョンは8.3となります。8.3ベータはAMD CPU向けに色々追加されているのとIPv6の強化などが含まれています。バージョンの更新は非常にゆっくりと進んでいくので8.3ベータはこれで1年以上検証中の状態が続いています。<br>今後構成されるプロダクトとしてXCP-ngを簡易なGUIで操作するXO Liteというプロダクトがありますが、これはまだ機能的に不足していて使えません。また、過去利用されていたものにXCP-ng Centerというプロダクトがありますが、これも非推奨となっています。</p><blockquote><p>XCP-ng ドキュメント<br> <a href="https://docs.xcp-ng.org/">https://docs.xcp-ng.org</a></p></blockquote><blockquote><p>XCP-ng フォーラム<br> <a href="https://xcp-ng.org/forum/">https://xcp-ng.org/forum/</a></p></blockquote><h2 id="Xen-Orchestra"><a href="#Xen-Orchestra" class="headerlink" title="Xen Orchestra"></a>Xen Orchestra</h2><p>Xen Orchestra(XOA)もVates社が製造しています。</p><img src="/new-technology/2024/04/07/xcpng/xoa.png" class="" width="1024" title="alt"><p>XOAはターンキーアプライアンスという名目ですぐに使えると表現されています（車のキーを回してすぐに動く）。これは有償のソフトウェアであり、CitrixのXen Server、XCP-ngを操作するためのGUIクライアントです。セットアップも簡単でXCP-ngに対してコマンド1つでモジュールを送り込み内部でビルドされます。</p><p>これに対してホームユーザーが利用するものは同じXen Orchestraではありますが、ソースコードからコンパイルすることで無償で利用できます。これは一手間掛かりますが、公式に認められた方法であり、オープンソースという建て付けで無償で提供されているものです。<br>同じ、Xen Orchestraであっても、こちらはXOという表記がなされ、有償版と無償版はそれぞれ、XOA、XOと区別されます。</p><p>ここではXOの導入について説明をしていきます。XOはVMの構築、操作、バックアップ、スナップショット、マイグレーション（ノード間のVMの移動）を行います。</p><blockquote><p>Xen Orchestra ドキュメント<br> <a href="https://xen-orchestra.com/docs/">https://xen-orchestra.com/docs/</a></p></blockquote><p>なお、フォーラムはXCP-ngと共通です。</p><h3 id="XOの操作イメージ"><a href="#XOの操作イメージ" class="headerlink" title="XOの操作イメージ"></a>XOの操作イメージ</h3><p>ここで説明する環境は以下の通りです。</p><img src="/new-technology/2024/04/07/xcpng/xo-xcp.drawio.png" class="" width="640" title="alt"><p>VMに対する操作はWebで行います。</p><img src="/new-technology/2024/04/07/xcpng/xo1.png" class="" width="1024" title="alt"><p>これはUbuntuを動作させているところです。ネットワーク、ディスクの基本構成があります。ここでSSH　as userを選ぶとローカル端末のSSHで接続できます。スナップショットやバックアップはすぐに取得できます。ESXi同様にXCP-ng向けのVMToolを導入することで、IPアドレスの把握やXOからvmのシャットダウン、リブートが可能になります（ESXiとは異なり手動でインストールが必要です）。Advancedタグでは、メモリやCPUの上限などを可変できます。<br>バックアップは自動的にスナップショットを取得します。ログも確認が容易ですし、Google等を経由したメール通知もできます。</p><img src="/new-technology/2024/04/07/xcpng/xo2.png" class="" width="1024" title="alt"><p>私の環境では10GbbpsのネットワークでXCP-ngからXOがデータを吸い上げ、それをNASにNFSで書き込んでいます。106MiB&#x2F;sなのでお世辞にもバックアップが早いとは言えませんが、圧縮しながらなのでこんなところなのでしょうか。基本は日時指定でバックアップを取得することになるのであまり気になるような状況でもないでしょう。複数ノードを1つのジョブでバックアップできるため、ノードが多くあればその分利便性を感じられます。</p><p>XCP-ngは2種類のスナップショットの取得方法があります。通常のスナップショットはメモリの情報を保存しません。バックアップなどはこの方式が選択されます。もう一方はメモリの情報を含んだスナップショットであり、こちらは少しの間VMの応答ができません。セットアップ作業の合間にチェックポイントとして状態を保存したい場合は、後者を選択すると良いでしょう。</p><p>同じCPU（intel）同士であれば、ダウンタイムを最小にするライブマイグレーションが可能です。</p><img src="/new-technology/2024/04/07/xcpng/xo3.png" class="" width="1024" title="alt"><p>表示が見切れているのでわかりづらいですが、ここでは同一のリソースプール（Pool1）における、1号機（XCP-ng1）から2号機（XCP-ng2）に対するマイグレーションを実施します。</p><p>この処理は最初に1号機から2号機への、ノード間でそれぞれのストレージ同士でコピー、その後動作したメモリの差分をコピーして完了させます。</p><p>Wi-Fiに接続されたMacbookから、XCP-ng上のUbuntuにiperf3を実行し、ほぼ同時にマイグレーションを開始してみます。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[  5] 138.01-139.00 sec   174 MBytes  1.47 Gbits/sec</span><br><span class="line">[  5] 139.00-140.00 sec   178 MBytes  1.49 Gbits/sec</span><br><span class="line">[  5] 140.00-141.00 sec   174 MBytes  1.47 Gbits/sec</span><br><span class="line">[  5] 141.00-142.01 sec   179 MBytes  1.50 Gbits/sec</span><br><span class="line">[  5] 142.01-143.01 sec  78.4 MBytes   657 Mbits/sec</span><br><span class="line">[  5] 143.01-144.00 sec  0.00 Bytes  0.00 bits/sec</span><br><span class="line">[  5] 144.00-145.01 sec  0.00 Bytes  0.00 bits/sec</span><br><span class="line">[  5] 145.01-146.01 sec  40.4 MBytes   339 Mbits/sec</span><br><span class="line">[  5] 146.01-147.00 sec  73.2 MBytes   617 Mbits/sec</span><br><span class="line">[  5] 147.00-148.00 sec  97.8 MBytes   818 Mbits/sec</span><br><span class="line">[  5] 148.00-149.01 sec   112 MBytes   938 Mbits/sec</span><br><span class="line">[  5] 149.01-150.00 sec   125 MBytes  1.05 Gbits/sec</span><br><span class="line">[  5] 150.00-151.00 sec   130 MBytes  1.09 Gbits/sec</span><br><span class="line">[  5] 151.00-152.00 sec   136 MBytes  1.14 Gbits/sec</span><br></pre></td></tr></table></figure><p>2分20秒程度で1号機のノードとの応答が途絶え、それから約3秒後に2号機からiperf3の応答が再開されています。TCPセッションは切断されません。<br>もちろん共有Diskがあればもっとマイグレーションは高速になりますが、個人向けの安価なハードウェアでも、ここまで出来るのは素晴らしいことです。</p><h2 id="XCP-ngのインストール"><a href="#XCP-ngのインストール" class="headerlink" title="XCP-ngのインストール"></a>XCP-ngのインストール</h2><p>8.2のインストールイメージは以下からダウンロードします。<br><a href="https://xcp-ng.org/#easy-to-install">https://xcp-ng.org/#easy-to-install</a></p><p>8.3ベータは以下からダウンロードします。<br><a href="https://xcp-ng.org/blog/2024/02/15/xcp-ng-8-3-beta-2/">https://xcp-ng.org/blog/2024/02/15/xcp-ng-8-3-beta-2/</a></p><p>導入にあたっては、ハードウェアサポートのページをまず参照されることをお勧めします。<br><a href="https://docs.xcp-ng.org/installation/hardware/">https://docs.xcp-ng.org/installation/hardware/</a></p><p>ここでは、問題が少ないと思われるintelマシンに対して8.2.1をインストールすることにします。ISOファイルをダウンロードし、RufusなどでUSBメモリにブートイメージを書き込みます。Rufus上でも特殊な設定は不要でデフォルト設定のまま書き込みます。XCP-ngはUEFIブートに対応していませんのでサーバーとなるPCのセキュアブートは無効にします。なお、稼働するVMはUEFIのセキュアブートにできます。</p><img src="/new-technology/2024/04/07/xcpng/usb.png" class="" width="360" title="alt"><p>ハードウェアによって異なりますが、最初にGRUBの画面が表示され、以下の選択になります。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">*install</span><br><span class="line"> install with alterate kernel(kernel-alt)</span><br><span class="line"> no-serial</span><br><span class="line"> safe</span><br><span class="line"> multipath</span><br><span class="line"> shell</span><br></pre></td></tr></table></figure><p>基本は最初の<code>instal</code>で構いませんが、セットアップ時にストレージ（NVMe）が見えずセットアップ出来ない場合は、Alt Kernel（代替カーネル）を選択してみてください。</p><p>セットアップは以下の手順で進めます。</p><img src="/new-technology/2024/04/07/xcpng/xcp1.png" class="" width="800" title="alt"><p>最初にキーボードを選択します。</p><img src="/new-technology/2024/04/07/xcpng/xcp2.png" class="" width="800" title="alt"><p>セットアップの注意書き（お決まり）です。基本的にはこのままOKで進めていきます。</p><img src="/new-technology/2024/04/07/xcpng/xcp3.png" class="" width="800" title="alt"><p>EULAに同意します。</p><img src="/new-technology/2024/04/07/xcpng/xcp4.png" class="" width="800" title="alt"><p>ストレージを選択します（ここではキャプチャ確保のためにProxmox上で動作させているのでQEMUと表示されています）。<br>8.2のストレージはブロックベース（LVM）がデフォルトです。8.3以降はファイルベースになるようです。</p><img src="/new-technology/2024/04/07/xcpng/xcp5.png" class="" width="800" title="alt"><p>インストール元としてlocal media(USB)を選択します。</p><img src="/new-technology/2024/04/07/xcpng/xcp6.png" class="" width="800" title="alt"><p>インストールメディアの検証の確認です。どちらでも構いません。</p><img src="/new-technology/2024/04/07/xcpng/xcp7.png" class="" width="800" title="alt"><p>メディア検証で問題なしというダイアログです。次に進みます。</p><img src="/new-technology/2024/04/07/xcpng/xcp8.png" class="" width="800" title="alt"><p>パスワードを決めます。</p><img src="/new-technology/2024/04/07/xcpng/xcp9.png" class="" width="800" title="alt"><p>IPアドレスを決めます。サーバーになるので、DHCPではなくStaticで固定IPアドレスにします。</p><img src="/new-technology/2024/04/07/xcpng/xcp10.png" class="" width="800" title="alt"><p>XCP-ng自身のhostnameを決めます。hostnameの一部はランダムに命名されていますが、わかりやすいものに変えた方が良いです。DNSサーバーはご自身のDNS（ルーターまたはゲートウェイ）を指定します。</p><img src="/new-technology/2024/04/07/xcpng/xcp11.png" class="" width="800" title="alt"><p>タイムゾーンは、Asia、Tokyoと指定します。</p><img src="/new-technology/2024/04/07/xcpng/xcp12.png" class="" width="800" title="alt"><img src="/new-technology/2024/04/07/xcpng/xcp13.png" class="" width="800" title="alt"><p>NTPを指定します。<br>ご自身の環境から近く、安定しているNTPサーバーを指定します。上記は指定の一例です。</p><img src="/new-technology/2024/04/07/xcpng/xcp14.png" class="" width="800" title="alt"><p>最後に<strong>Install XCP-ng</strong>のボタンを押下します。</p><img src="/new-technology/2024/04/07/xcpng/xcp15.png" class="" width="800" title="alt"><p>セットアップの進捗を示すダイアログが表示されています。</p><img src="/new-technology/2024/04/07/xcpng/xcp16.png" class="" width="800" title="alt"><p>サプリメントパックをインストールするか聞かれますので、ここはNoを答えます。<br>その後インストールが継続します。</p><img src="/new-technology/2024/04/07/xcpng/xcp17.png" class="" width="800" title="alt"><p>セットアップ完了です。USBメディアを取り外し、OKボタンを押下します。</p><p>セットアップ完了後再起動して以下の画面が表示されます。もしここまで上手く表示されない場合は、マザーボードのBIOSのアップデートをお勧めします。</p><p>XCP-ngにはインストール時に設定したマネジメントネットワークが1つ必要です。このマネジメントネットワークに対してXen Orchestraから接続され制御されることになります。<br>この状態でXCP-ngにはSSHできる状態になっています。または、このメニューの<mark class="label primary">Local Command Shell</mark>を起動します。</p><p>VMがUEFIブートを可能とするため、以下のコマンドを入力します。<br><code>$ secureboot-certs install</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[11:31 xcp-ng3 ~]# secureboot-certs install</span><br><span class="line">Downloading https://www.microsoft.com/pkiops/certs/MicCorKEKCA2011_2011-06-24.crt...</span><br><span class="line">Downloading https://www.microsoft.com/pkiops/certs/MicCorUEFCA2011_2011-06-27.crt...</span><br><span class="line">Downloading https://www.microsoft.com/pkiops/certs/MicWinProPCA2011_2011-10-19.crt...</span><br><span class="line">Downloading https://uefi.org/sites/default/files/resources/dbxupdate_x64.bin...</span><br><span class="line">Successfully installed certificates to the XAPI DB <span class="keyword">for</span> pool.</span><br><span class="line">[11:37 xcp-ng3 ~]#</span><br></pre></td></tr></table></figure><p>ここまででXCP-ngのセットアップは一旦完了です。<br>NICを取り外して別のNICを取り付ける場合には、デバイス論理名（ex:eth0）とデバイスとの関連付けがずれてしまう場合があります。この際は以下のページを参考にしてください。</p><p><a href="https://docs.xcp-ng.org/networking/">https://docs.xcp-ng.org/networking/</a></p><p>同じリソースプールでスムーズにVMの移動（ライブマイグレーション）を行う際は、同一の物理インタフェースが必要となります。もちろん同一製品である必要はありませんが、どのセグメントに属するか、速度タイプなどは同一にする必要があります。</p><h2 id="Xen-Orchestraのインストール"><a href="#Xen-Orchestraのインストール" class="headerlink" title="Xen Orchestraのインストール"></a>Xen Orchestraのインストール</h2><p>XOのセットアップにはインターネットに接続されたLinuxが必要です。ここではXCP-ngとは別にUbuntu22を使ってXOのコンパイル、デプロイを実行していきます。<br>まず、ベアメタルかVMとしてのGUIのあるUbuntu Desktopを用意してください。私の例ではマネジメントネットワークに加え、バックアップのセグメント（SynologyへのNFS接続）とのvNICを2つ用意しています。1つのNICのみであってもXOのセットアップは可能です。<br>ここではProxmox上のUbuntuにXOをセットアップします。Proxmox上でのUbuntuのセットアップは「<a href="/new-technology/2024/02/19/Proxmox-new-vm/" title="ProxmoxVEのVM新規作成（Ubuntu24.04LTS）">ProxmoxVEのVM新規作成（Ubuntu24.04LTS）</a>」の記事を参考にしてください（XOをセットアップする想定でUbuntuを構築しています）。</p><p>クライアントからXOにブラウザで接続して使うことになるので、最初にubuntuのIPアドレスは固定IPアドレスにします。設定ーネットワークから有線設定を変更しておきます。<br>また、XOのセットアップ開始にあたり、最初にLinuxそのもののスナップショットを取得しておくとよいでしょう。</p><p>XOのセットアップには有志であるronivay氏が作成したXenOrchestraInstallerUpdaterを利用します。<br><a href="https://github.com/ronivay/XenOrchestraInstallerUpdater">https://github.com/ronivay/XenOrchestraInstallerUpdater</a></p><h3 id="事前準備"><a href="#事前準備" class="headerlink" title="事前準備"></a>事前準備</h3><p>Ubuntuの<mark class="label primary">ソフトウェアとアップデート</mark>を起動し、<mark class="label primary">Ubuntuのソフトウェア</mark>で<mark class="label primary">ソースコード</mark>のチェックをオンにします。</p><img src="/new-technology/2024/04/07/xcpng/xo4.png" class="" width="640" title="alt"><p>また、<mark class="label primary">他のソフトウェア</mark>の一覧で<mark class="label primary">ソースコード</mark>と記載されているものにチェックをオンにします。</p><img src="/new-technology/2024/04/07/xcpng/xo5.png" class="" width="640" title="alt"><p>これ以降はShellでの操作となるので、SSHでクライアントから接続してコマンドを投入していった方が簡単です（コマンドのコピペが出来るので）。SSH ServerがUbuntuに入っていない場合は、以下のコマンドでインストールします。<br><code>$ sudo apt install openssh-server</code></p><p>Ubuntu DesktopでのShell操作、或いはクライアントからsshして以降の作業を行います（<code>ssh username@your-host</code>)。UbuntuのGUIで実施する場合は、<mark class="label primary">端末</mark>を起動します。</p><h4 id="rootになる"><a href="#rootになる" class="headerlink" title="rootになる"></a>rootになる</h4><p><code>$ sudo -i</code></p><h4 id="gitのインストール"><a href="#gitのインストール" class="headerlink" title="gitのインストール"></a>gitのインストール</h4><p>リポジトリを追加し、gitをインストールします。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ add-apt-repository ppa:git-core/ppa</span><br><span class="line">$ apt update; apt install git</span><br></pre></td></tr></table></figure><h3 id="XenOrchestraInstallerUpdaterのダウンロード、XOのインストール"><a href="#XenOrchestraInstallerUpdaterのダウンロード、XOのインストール" class="headerlink" title="XenOrchestraInstallerUpdaterのダウンロード、XOのインストール"></a>XenOrchestraInstallerUpdaterのダウンロード、XOのインストール</h3><p>GitHubからスクリプトをダウンロードし、cfgファイルのサンプルのコピーを作成します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://github.com/ronivay/XenOrchestraInstallerUpdater.git</span><br><span class="line">$ <span class="built_in">cd</span> XenOrchestraInstallerUpdater</span><br><span class="line">~/XenOrchestraInstallerUpdater$ <span class="built_in">cp</span> sample.xo-install.cfg xo-install.cfg</span><br></pre></td></tr></table></figure><p><code>xo-install.cfg</code>ファイルをviで開き、インストールパス、XOが待ち受けるPort、SSL自己証明書を指定します。<br>Ubuntuでは、インストールパスは<code>/usr/lib/</code>配下とします（お好みで変えてください）。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~/XenOrchestraInstallerUpdater$ vi xo-install.cfg</span><br></pre></td></tr></table></figure><p>3箇所の修正ポイントです。以下の行を見つけます。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Port number where xen-orchestra service is bound</span></span><br><span class="line"><span class="comment"># no effect to Xen Orchestra proxy</span></span><br><span class="line">PORT=<span class="string">&quot;80&quot;</span></span><br></pre></td></tr></table></figure><p>PORT&#x3D;”80”をPORT&#x3D;”443”に変更します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Port number where xen-orchestra service is bound</span></span><br><span class="line"><span class="comment"># no effect to Xen Orchestra proxy</span></span><br><span class="line">PORT=<span class="string">&quot;443&quot;</span></span><br></pre></td></tr></table></figure><p>次に以下の行を見つけます。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Base dir for installation and future updates</span></span><br><span class="line">INSTALLDIR=<span class="string">&quot;/opt/xo&quot;</span></span><br></pre></td></tr></table></figure><p>INSTALLDIR&#x3D;”&#x2F;opt&#x2F;xo”をINSTALLDIR&#x3D;”&#x2F;usr&#x2F;lib&#x2F;xo”に変更します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Base dir for installation and future updates</span></span><br><span class="line">INSTALLDIR=<span class="string">&quot;/usr/lib/xo&quot;</span></span><br></pre></td></tr></table></figure><p>次に以下の行を見つけます。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Location of pem certificate/key files. Installation will automatically configure HTTPS if these are defined. Remember to change PORT variable as well.</span></span><br><span class="line"><span class="comment">#PATH_TO_HTTPS_CERT=$INSTALLDIR/xo.crt</span></span><br><span class="line"><span class="comment">#PATH_TO_HTTPS_KEY=$INSTALLDIR/xo.key</span></span><br></pre></td></tr></table></figure><p>証明書のパスについて2箇所コメントを外します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Location of pem certificate/key files. Installation will automatically configure HTTPS if these are defined. Remember to change PORT variable as well.</span></span><br><span class="line">PATH_TO_HTTPS_CERT=<span class="variable">$INSTALLDIR</span>/xo.crt</span><br><span class="line">PATH_TO_HTTPS_KEY=<span class="variable">$INSTALLDIR</span>/xo.key</span><br></pre></td></tr></table></figure><p>以上でファイルの修正は終了ですので、保存しviを終了します。</p><p>Open SSLをインストールします。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ apt-get install openssl</span><br></pre></td></tr></table></figure><p>自己証明書を生成します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ openssl req -newkey rsa:4096 \</span><br><span class="line">            -x509 \</span><br><span class="line">            -sha256 \</span><br><span class="line">            -days 3650 \</span><br><span class="line">            -nodes \</span><br><span class="line">            -out /usr/lib/xo/xo.crt  \</span><br><span class="line">            -keyout /usr/lib/xo/xo.key</span><br></pre></td></tr></table></figure><p>証明書の設定では以下、適当なものを入力しておきます。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Country Name (2 letter code) [AU]:JP</span><br><span class="line">State or Province Name (full name) [Some-State]:anywhere</span><br><span class="line">Locality Name (eg, city) []:anywhere</span><br><span class="line">Organization Name (eg, company) [Internet Widgits Pty Ltd]:yoshi</span><br><span class="line">Organizational Unit Name (eg, section) []:none</span><br><span class="line">Common Name (e.g. server FQDN or YOUR name) []:yoshi</span><br><span class="line">Email Address []:yoshi0808.blog@gmail</span><br></pre></td></tr></table></figure><p>スクリプトを起動します。<code>$ ./xo-install.sh</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Xen Orchestra configuration will be stored to /root/.config/xo-server/config.toml, <span class="keyword">if</span> you don<span class="string">&#x27;t want it to be replaced with every update, set CONFIGUPDATE to false in xo-install.cfg</span></span><br><span class="line"><span class="string">Xen Orchestra Proxy configuration will be stored to /root/.config/xo-proxy/config.toml. Config won&#x27;</span>t be overwritten during update, ever</span><br><span class="line">-----------------------------------------</span><br><span class="line"></span><br><span class="line">1. Install</span><br><span class="line">2. Update</span><br><span class="line">3. Rollback</span><br><span class="line">4. Install proxy</span><br><span class="line">5. Update proxy</span><br><span class="line">6. Exit</span><br><span class="line"></span><br><span class="line">：</span><br></pre></td></tr></table></figure><p>Installの1を入力してEnterを押下します。必要なモジュール、ソースコードをダウンロードし、コンパイルに入ります。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[info] xo-server and xo-web build takes quite a <span class="keyword">while</span>. Grab a cup of coffee and lay back</span><br></pre></td></tr></table></figure><p>ということで、コーヒーを淹れに行き、3分程度待ちます😊。<br>以下の表示が出たところで、rebootします。事後にはLinixのアプリケーションファイアウォールであるufwを有効にして443のみを開けると良いでしょう（GUIもあります）。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[info] Starting xo-server...</span><br><span class="line"> waiting <span class="keyword">for</span> port to be open</span><br><span class="line"></span><br><span class="line">       WebUI started <span class="keyword">in</span> port 443. Make sure you have firewall rules <span class="keyword">in</span> place to allow access.</span><br><span class="line">       Default username: admin@admin.net password: admin</span><br><span class="line"></span><br><span class="line">[info] Installation successful. Enabling xo-server service to start on reboot</span><br><span class="line"></span><br><span class="line">root@xo:~/XenOrchestraInstallerUpdater# reboot</span><br></pre></td></tr></table></figure><p>再起動してインストールは終了です。<br>上記のコメントにある通り、XOの画面からはユーザー:<a href="mailto:&#x61;&#x64;&#x6d;&#105;&#110;&#64;&#97;&#x64;&#109;&#105;&#x6e;&#46;&#x6e;&#x65;&#x74;">admin@admin.net</a>、パスワード：adminでログインします。</p><h3 id="XOの初期設定"><a href="#XOの初期設定" class="headerlink" title="XOの初期設定"></a>XOの初期設定</h3><p>Ubuntuが再起動してきたら、ブラウザから<code>https://XOのIPアドレス/</code>としてXOのGUIに接続します。<br>ブラウザからは自己証明書の警告が表示されますが気にせず継続します。<br>無事、以下のログイン画面が表示されればインストールは成功です。</p><img src="/new-technology/2024/04/07/xcpng/xo6.png" class="" width="360" title="alt"><p>デフォルトアカウントでログインします。</p><img src="/new-technology/2024/04/07/xcpng/xo7.png" class="" width="800" title="alt"><p>ソースコードから作成されたものというダイアログが表示されます。OKをクリックして閉じます。また、画面上部には、”This version is not bundled with any support nor updates. Use it with caution. Why do I see this message?”と表示されていますが、これもサポートなしと理解して使っているので閉じます。そして、左ペインにXOA❓マークがありますが、これをクリックすると、Update❓という表示がされています。この？アイコンは削除できません。XOAはここからアップデートなどの処理が行えますが、これはXOAではなく、XOなのでこのサブメニューは使いません。無視して大丈夫です。</p><h3 id="ユーザーの作成とデフォルトアカウントの削除"><a href="#ユーザーの作成とデフォルトアカウントの削除" class="headerlink" title="ユーザーの作成とデフォルトアカウントの削除"></a>ユーザーの作成とデフォルトアカウントの削除</h3><p>左ペインの<mark class="label primary">Settings</mark>から、<mark class="label primary">Users</mark>を選択します。</p><img src="/new-technology/2024/04/07/xcpng/xo8.png" class="" width="1024" title="alt"><p>上記画面から、ユーザー名、ユーザーの権限は”Admin”を選択、パスワードを入力して<mark class="label primary">Create</mark>ボタンをクリックして管理者を作成します。</p><p>無事作成できたら、左ペインの一番下にあるサインアウトをクリックして、新しい管理者アカウントで入りなおします。<br>ログインできたら、デフォルトのアカウントを右側のゴミ箱アイコンをクリックして削除します。</p><p>任意の作業ですが、最初に仮想環境でスナップショットを取得していれば、ここまでは1つの区切りです。もう一度Linux全体のスナップショットを撮り直す、またはスナップショットは削除して再作成するなどしても良いでしょう。</p><h2 id="Xen-OrchestraからXCP-ngへの接続"><a href="#Xen-OrchestraからXCP-ngへの接続" class="headerlink" title="Xen OrchestraからXCP-ngへの接続"></a>Xen OrchestraからXCP-ngへの接続</h2><p>左ペインの<mark class="label primary">Settings</mark>から<mark class="label primary">Servers</mark>を選択します。</p><img src="/new-technology/2024/04/07/xcpng/xo9.png" class="" width="1024" title="alt"><p>ここでXCP-ngのインストール時に決めたユーザー：root、パスワードをセットします。トグルスイッチの<mark class="label primary">Unauthorized Certificate</mark>は今回作成した自己証明書なのでオンにします。先頭のLabelは自分のメモとしてサーバー名を入力しておきます。</p><mark class="label primary">Connect</mark>ボタンをクリックして接続します。うまくXCP-ngに接続できると<mark class="label primary">Status</mark>がEnableの表示となります。<p>さて、この状態になると、恐らく左ペインの<mark class="label primary">Home</mark>には、！マークが付いていると思われます。</p><mark class="label primary"> Home</mark>→<mark class="label primary">Hosts</mark>と進むとサーバー名が表示されているのでこれをクリックします。<img src="/new-technology/2024/04/07/xcpng/xo10.png" class="" width="1024" title="alt"><mark class="label primary"> Patches</mark>の部分に恐らく数十の数字が書かれていることと思われます。これはXCP-ngでまだ適用されていないパッチの数を示します。<mark class="label primary"> Patches</mark>の項目をクリックして、<mark class="label primary"> Install all patches</mark>ボタンをクリックしてパッチを適用します。適用後は、リブートが必要となります。画面右上のリサイクルマークのようなアイコンが再起動となるのでそれをクリックしてパッチの適用を完了させます。<img src="/new-technology/2024/04/07/xcpng/xo11.png" class="" width="360" title="alt"><p>今はXCP-ngが1台だけですが、複数台を運用することになり、1つのリソースプールに存在する複数台のサーバーに順にパッチを適用する事になります。その際は、常にMasterとなっているサーバーを先にパッチ適用する必要があります。<br>XCP-ngの再起動が完了するとXOは自動的にXCP-ngに接続します。</p><h2 id="XCP-ngネットワークの確認"><a href="#XCP-ngネットワークの確認" class="headerlink" title="XCP-ngネットワークの確認"></a>XCP-ngネットワークの確認</h2><p>XCP-ngへの接続が完了したら、まず<mark class="label primary">Home</mark>→<mark class="label primary">Hosts</mark>と進みます。XCP-ngサーバーをクリックし、CPU&#x2F;メモリ&#x2F;ネットワークを確認しましょう。</p><img src="/new-technology/2024/04/07/xcpng/xo14.png" class="" width="1024" title="alt"><p>ここで、<mark class="label primary">PIFs</mark>というのはPhysical Interfaces（物理インタフェース）の意味です。Private Networkを作成すると、物理Portを指定してそこにVLANを定義するなどできます。そのようにすることで物理インタフェースにVLANタグの付いたパケットが流れます。XCP-ngがスイッチからタグ付きパケットを受け取り、VMにはPrivate Network（論理Port）経由でタグを剥がしてパケットをVMに渡します。またその逆でVMからタグなしのPrivate Network経由でパケットを受け取り、XCP-ngは該当の物理Portにタグ付きでパケットをスイッチに向けて送信します。</p><h2 id="ISOファイルを配置するSRの設定"><a href="#ISOファイルを配置するSRの設定" class="headerlink" title="ISOファイルを配置するSRの設定"></a>ISOファイルを配置するSRの設定</h2><p>VMを作成する前に、OSのISOファイルをアップロードするフォルダが必要です。これはXCP-ng上に作成します。つまりサーバー毎に必要です。大量に利用するなら、NASなどのNFSを用意してそこにマウントできます。ここではとりあえずXCP-ngのローカル上にSR(Storage Repository)を作成します。</p><p>以下のVates社のブログを元に構成します。<br><a href="https://xcp-ng.org/blog/2022/05/05/how-to-create-a-local-iso-repository-in-xcp-ng/">https://xcp-ng.org/blog/2022/05/05/how-to-create-a-local-iso-repository-in-xcp-ng/</a></p><p>ちょうどこの記事を見ていただくと、このブログの最後に記事を書いた方の情報があります。Olivier Lambert氏、Vates社の起業者でありCEOです。Forumにも頻繁にコメントされています。</p><img src="/new-technology/2024/04/07/xcpng/xo12.png" class="" width="480" title="alt"><p>このようにStorage TypeはISO SRのlocalとして作成します。パスは&#x2F;media固定です。</p><p>次に左ペインの<mark class="label primary">Import</mark>→<mark class="label primary">Disk</mark>をクリック、対象のXCP-ngサーバーの指定フォルダ（上記では”ISOs”）を選びます。その画面上でクライアント端末からISOファイルをDrag&amp;Dropできます。</p><p>お疲れ様でした！これでXCP-ngとXEN Orchestraの基本設定は完了です。<br>次の記事で、<strong>New VM</strong>でVMの新規作成を行います。</p><p>この段階でXOがインストールされたUbuntuのOS毎のスナップショットは削除し、一度UbuntuのOSそのもののバックアップを取得されることをお勧めします。</p><h2 id="XOのアップデート"><a href="#XOのアップデート" class="headerlink" title="XOのアップデート"></a>XOのアップデート</h2><p>左ペインの<mark class="label primary">About</mark>からXOのモジュールについてアップデート状況が確認できます。現時点ではコンパイルしたばかりなので、”Your Xen Orchestra is up to date ”という表示になっているはずです。<br>しばらく時間が経過するとこの表記はGitのMasterブランチに対して遅れを取っていきます。”You are not up to date with master. xx commits behind “という表記に変わります。かなり細かい単位でコミットされていきますが、Communityの情報を見ながら適宜アップデートする事になります。この際もコンパイルが必要です。最初にXenOrchestraInstallerUpdaterでInstallを選びましたが、再びスクリプトからUpdateを実行することで常にXOは最新モジュールとなります。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">sudo</span> -i</span><br><span class="line">$ <span class="built_in">cd</span> XenOrchestraInstallerUpdater</span><br><span class="line">$ git pull origin master</span><br><span class="line">$ ./xo-install.sh</span><br></pre></td></tr></table></figure><p>ここで<code>2.Update</code>を選択して更新します。</p><p> GitHub上のXenOrchestraInstallerUpdaterを見る限りは数ヶ月に1度くらいの頻度で更新されているので、毎回<code>git pull 〜</code>は必要ありません。これはGitHubのページなどで情報を確認しながら、適宜アップデートしてください。</p><h2 id="XCP-ngの独自用語"><a href="#XCP-ngの独自用語" class="headerlink" title="XCP-ngの独自用語"></a>XCP-ngの独自用語</h2><p> XCP-ngのホストそのものはXenの世界でdom0と呼ばれます。色々コミュニティを見ていてdom0は何ぞや？と思われる方もいらっしゃると思うので補足です。dom0には色々なツールなどをインストールすることは避けた方が良さそうです(iperf3など)。</p>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2024/04/07/xcpng/title.png&quot; class=&quot;&quot; width=&quot;1024&quot; title=&quot;alt&quot;&gt;

&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;
ESXi代替としての仮想環境ソフトウェアのXCP-ng、またそのオペレーションをGUIで支援するXen Orchestraの概要およびセットアップを行います。Xen Orchestraは有償ソフトウェアですが、オープンシステムとして提供されており、コンパイル、ビルドすることで無償で利用できます。</summary>
    
    
    
    
    <category term="XCP-ng" scheme="https://yoshi0808.github.io/new-technology/tags/XCP-ng/"/>
    
  </entry>
  
  <entry>
    <title>UniFi Express</title>
    <link href="https://yoshi0808.github.io/new-technology/2024/03/06/unifi-express/"/>
    <id>https://yoshi0808.github.io/new-technology/2024/03/06/unifi-express/</id>
    <published>2024-03-06T01:20:08.000Z</published>
    <updated>2024-03-07T09:58:27.830Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2024/03/06/unifi-express/Title.png" class="" width="1024" title="alt"><p class="onepoint">この記事で実現すること</p><p>この記事ではUniFiネットワークの導入未経験の方を対象に、UniFiの新しい小型ゲートウェイUniFi Expressの具体的なセットアップおよび性能確認、機能紹介を目的としています。検証のため製品提供を受けていますのでこの記事はPR要素を含みます。</p><span id="more"></span><h2 id="経緯"><a href="#経緯" class="headerlink" title="経緯"></a>経緯</h2><p>普段からUbiquiti製品を使っている私は、いつもUbiquitiの皆さまには製品サポートなどで大変お世話になっています。一方、FacebookのUbiquiti日本公式コミュニティではユーザーの質問などに微力ながらサポートするように心がけています。いつものようにUbiquitiのご担当者さまから製品設定についてアドバイス頂いていた折、新製品「UniFi Express」の検証はいかがですか？と打診があり、快く引き受けさせていただきました。普段はアクセスポイント（AP）、スイッチは使っていますが、他社製セキュリティゲートウェイがお気に入りでなかなかUniFiのゲートウェイを使う機会がありませんでした。</p><p>UniFiは簡単な操作で分かりやすさを目的としている一方で、パワーユーザーの高度な要求に応えていることもあり、一旦ネットワークの世界の深みに入るといきなり難易度が増す事になります。</p><p>Expressは従来の機能豊富なUniFiゲートウェイから負荷が掛かるIPSなどの処理を省き、できるだけシンプルな形でUniFiのゲートウェイをUniFi初心者にも簡単に使えるようにしたゲートウェイです。</p><p>3月となり、新生活が始まる時期でもあります。引っ越しされて新しい住環境にネットワークを敷設される場合は、小型の置き場所に困らないExpressは使い勝手が良いと思われます。</p><h2 id="UniFi-Express"><a href="#UniFi-Express" class="headerlink" title="UniFi Express"></a>UniFi Express</h2><p>製品の説明ページは以下になります。</p><img src="/new-technology/2024/03/06/unifi-express/0.png" class="" width="1024" title="alt"><blockquote><p>UniFi Express<br> <a href="https://www.ui.com/us/ja/cloud-gateways/wifi-integrated/express">https://www.ui.com/us/ja/cloud-gateways/wifi-integrated/express</a></p></blockquote><h2 id="この記事でのインターネットの構成"><a href="#この記事でのインターネットの構成" class="headerlink" title="この記事でのインターネットの構成"></a>この記事でのインターネットの構成</h2><p>私はauひかりホーム（10ギガ）を導入しており、貸与されたホームゲートウェイ（HGW）があります。その後ろにExpressを配置する形式となります。</p><img src="/new-technology/2024/03/06/unifi-express/diaglam.drawio.png" class="" width="240" title="alt"><h2 id="セットアップ"><a href="#セットアップ" class="headerlink" title="セットアップ"></a>セットアップ</h2><p>Expressはスマホだけでセットアップ可能です。むしろPCのブラウザを使うよりスマホアプリで行う方が便利です。<br>UniFiの製品は説明書というものがありません。いや、あるにはあるのですが、セットアップ方法＝アプリを使う事となっています。</p><img src="/new-technology/2024/03/06/unifi-express/1.png" class="" width="480" title="alt"><p>セットアップに関する説明書は注意書きを除けばこれが全て（That’s all!）です。</p><p>製品と付属品です。本体、電源ケーブル、30cmのLANケーブルが付属します。</p><img src="/new-technology/2024/03/06/unifi-express/2.png" class="" width="800" title="alt"><p>唯一の説明書通りに電源ケーブル、LANポートは2つあります（LAN、WAN）ので、WAN側（地球儀のマークがある方）に接続します。</p><img src="/new-technology/2024/03/06/unifi-express/3.png" class="" width="800" title="alt"><p>私の環境ではこの壁に接続したLANの接続口の先にHGWがあります。</p><p>さて、説明書のQRコードをiPhoneのカメラで読み込み、アプリをダウンロードしましょう。</p><img src="/new-technology/2024/03/06/unifi-express/4.png" class="" width="360" title="alt"><p>※上記の写真のiPhoneはWi-Fiに接続されていますがこれは既存環境のWi-Fiに接続されているものです。</p><img src="/new-technology/2024/03/06/unifi-express/5.png" class="" width="360" title="alt"><p>私の場合、既にUbiquitiのアカウントを保有しアプリにログインできていることや既存のUniFiコンソールに接続されている状態ですが、スマホがBluetooth経由でExpressを見つけると画面にセットアップ開始を促します。</p><img src="/new-technology/2024/03/06/unifi-express/6.png" class="" width="360" title="alt"><p>既存環境があるので選択制となっていますが、「新しいシステムを設定」を選びます。Expressが最初の1台の場合、この画面は出てこないと思われます。</p><p>また、今回の例では既に既存アカウントでアプリにログインしている状態ですが、全く新規の場合は、Ubiquitiのアカウントを新規作成します。</p><img src="/new-technology/2024/03/06/unifi-express/7.png" class="" width="360" title="alt"><p>今回、唯一セットアップしたと思える場所がここだけです。SSIDは既に”UniFi”となっており（変更可能）、ここでWi-Fiパスワードを指定します。</p><img src="/new-technology/2024/03/06/unifi-express/8.png" class="" width="360" title="alt"><p>ここからは眺めているだけです。</p><img src="/new-technology/2024/03/06/unifi-express/9.png" class="" width="360" title="alt"><img src="/new-technology/2024/03/06/unifi-express/10.png" class="" width="360" title="alt"><img src="/new-technology/2024/03/06/unifi-express/11.png" class="" width="360" title="alt"><p>ここで「Wi-Fiネットワークに参加」ボタンをタップします。UniFiアプリはSSID「UniFi」と設定したパスワードをiOSの設定アプリに送り込み自動的にWi-Fi接続が完了します。</p><p>これだけでもうiPhoneはインターネットにアクセスできるようになっています。顧客体験を重要視するUbiquitiらしい仕掛けです。</p><p>さて、アプリの表記では、HGWのDHCPによって割り当てられた<code>192.168.0.2</code>というExpressのWAN側IPアドレス、および、LAN側のIPアドレス<code>192.168.1.1</code>が振られています。</p><img src="/new-technology/2024/03/06/unifi-express/12.png" class="" width="360" title="alt"><p>Wi-Fiを見てみましょう、ExpressはWi-Fiチャンネルを含めて自動という言葉を多く見かけます。5GHzはデフォルトでは40MHzとなっていますが、80MHzに変更できるのでここで変更しておきましょう（最大160MHzにできます）。これ以外の自動は2つあって、Wi-Fiチャンネルおよび出力が自動となっています。日本のWi-Fiの電波出力の上限はざっくり説明すると200mW（23dBm）であり、その上限を超えないような設定となっています。クライアントの接続状況によって適切に電波の出力が調整され省エネにも有効です。</p><img src="/new-technology/2024/03/06/unifi-express/13.png" class="" width="360" title="alt"><p>設定からコンソールを見てみましょう。</p><img src="/new-technology/2024/03/06/unifi-express/14.png" class="" width="360" title="alt"><p>右下の歯車アイコンをタップ→コンソールをタップします。</p><p>ExpressはUniFi OSというOSで動作しており、その中のNetworkApplication（UNA）というアプリが動作しています。基本的にはOSをアップデートすることで内包されているUNAも自動的にアップデートされます。</p><img src="/new-technology/2024/03/06/unifi-express/15.png" class="" width="360" title="alt"><p>最新のUniFiOSにアップデートします。<br>このExpressは、UniFi OSはv3.2.5(Official)となりました。UNAはv8.0.28です。</p><p>今回は初回操作なので手動でアップデートすることにしましたが、毎日夜中3時に自動でアップデートチェックが行われ、自動でアップデートされます。また、Release Channelについては、”Official”(通常）、”Release Candidate”（リリース候補）、あとはUIアカウントのページから”Early Access”(ベータ版）を有効にすれば、3つのバージョンを選択できます。</p><blockquote><p>UI Account<br> <a href="https://account.ui.com/profile">https://account.ui.com/profile</a></p></blockquote><p>慣れるまではOfficialにしておくのがお勧めです。<br>Early Accessは事前確認する利用条件にある通り、守秘義務が存在します。許可なくその内容を第三者に開示してはいけません。安定しない場合も多く、広くユーザーに互換性を確認してもらうためのものです。</p><p>さて、ここまでで初期セットアップは完了です。</p><h2 id="速度チェック"><a href="#速度チェック" class="headerlink" title="速度チェック"></a>速度チェック</h2><p>気になるSpeedtestです。まずはiPhoneでWi-Fiのテストです。</p><img src="/new-technology/2024/03/06/unifi-express/16.png" class="" width="360" title="alt"><p>MTUも何も調整することなく、全くノーマルな状態での実行ですが、十分過ぎる速度です。本体の発熱も少なく、ほんのり暖かい程度です。<br>5GHzで160MHzの帯域を使うのであれば、以下の速度が出ます。</p><img src="/new-technology/2024/03/06/unifi-express/16-1.png" class="" width="360" title="alt"><p>有線とWi-Fiとは一般的に速度差があるので、ネットワーク機器はフローコントロールを有効にするのが普通で、遅いWi-Fiに合わせて有線側を”待たせる”仕組みが必要ですが、ここまで有線とWi-Fiとの速度差が無いとフローコントロールを有効にする必要がありません。<br>実際問題、フローコントロール無しでパケットのドロップが少ないのであればそれが一番効率よく通信でき、速度が出ます。<br>上記のSpeedtestはフローコントロール無しでの結果です。</p><p>Zero wait DFSという機能があり、DFSを回避できる機能もあるようですが、私の環境でタイミング良くレーダーが発生するわけでもなく、この検証は行えませんでした。</p><p>続いてLANケーブルでPCに繋いでみます。MinisforumのUM790Proは最近人気のミニPCですが、Expressはそれより1回り小さいです。</p><img src="/new-technology/2024/03/06/unifi-express/17.png" class="" width="640" title="alt"><p>1Gbpsの帯域をしっかりと使えています。小型ながら性能は大したものです。</p><h2 id="セットアップの補足"><a href="#セットアップの補足" class="headerlink" title="セットアップの補足"></a>セットアップの補足</h2><p>私の環境（auひかり）ではとても簡単にセットアップが完了しました。なお、Expressは現在、Officialリリースにおいてインターネットマルチフィード社が提供するtransix IPv4接続 (DS-Lite) への対応はされていますが、その他のIPv4 over IPv6の対応は現時点でサポート外となっています。</p><p>日本国内の大半がIPv4 over IPv6というわけでもなく、CATVやマンションが提供するLANなども鑑みると、シンプルにExpressを活用できる場所はたくさんあります。</p><p>Expressに関するガイドを以下に記載します。</p><ul><li>ネットワークが不安定、Lineなどでやり取りができなくなる。<br> 以下のガイドにMSS Clampingの設定で解決するという投稿がありますので確認ください。<br> Facebook Ubiquiti日本公式コミュニティ</li></ul><p> <a href="https://www.facebook.com/groups/uijapan/learning_content/?filter=167949146143924&post=3507234616157550">https://www.facebook.com/groups/uijapan/learning_content/?filter=167949146143924&amp;post=3507234616157550</a><br> この設定についてはExpressにブラウザでログインし、WANのMSS Clampingの値をCustomの1414等に設定する必要があります。具体的な設定はISPにより異なります。</p><ul><li>IPv6 IPoE transix IPv4 (DS-Lite)の設定手順｜Ubiquiti UniFi</li></ul><p> <a href="https://note.com/ui_japan/n/n3154ff641db5">https://note.com/ui_japan/n/n3154ff641db5</a></p><p>インターネットマルチフィードのDS-Liteは以下のISPが対象となります。</p><ul><li>株式会社インターネットイニシアティブ<br> IIJ IPv6 FiberAccess&#x2F;Fサービス タイプIPoE</li><li>株式会社インターネットイニシアティブ<br> IIJmioひかり</li><li>株式会社インターネットイニシアティブ<br> IIJmio FiberAccess&#x2F;NF</li><li>株式会社インターリンク<br> ZOOT NATIVE</li><li>エキサイト株式会社<br> excite MEC光</li><li>エキサイト株式会社<br> BB.excite光Fit</li><li>エキサイト株式会社<br> BB.exciteコネクトIPoE接続プラン</li><li>スターティア株式会社<br> マネージドゲート2</li><li>メディアウェイブシステムズ株式会社<br> Hybrid64 (ハイブリッド・ろくよん）</li><li>メディアウェイブシステムズ株式会社<br> メディアひかり</li></ul><p>（引用： <a href="https://www.mfeed.ad.jp/transix/customers/">https://www.mfeed.ad.jp/transix/customers/</a>）</p><p>PPPoEやIPv4 over IPv6など、既存インフラの課題を頑張って解決する接続方式よりも、普通にIPv4、IPv6それぞれデュアルスタックで接続できるISPを選択するのが一番シンプルだと個人的には思います。PPPoEで、MTUからTCPヘッダおよびIPヘッダを除いたMSS1460バイトを1414バイトに詰め直すというのは、CPU負荷を高める原因となります。また、IPv4 over IPv6の接続では、IPアドレスとポートを他のユーザーと共有するため、固定IPアドレスが使用できず、割り当てられたポートしか開放できません。</p><h2 id="auひかりのIPv6"><a href="#auひかりのIPv6" class="headerlink" title="auひかりのIPv6"></a>auひかりのIPv6</h2><h3 id="HGWの設定"><a href="#HGWの設定" class="headerlink" title="HGWの設定"></a>HGWの設定</h3><p>さて、いくらExpressが簡単と言っても、Ubiquiti製品を選びたいというユーザーはやはりIPv6は使いたいと思われているでしょう。グローバルの一般的なIPv6の割り当て方法がUniFiにはあります。auひかりのユーザーはとても簡単にIPv6に接続できます。ここは少しだけ設定が必要です。なお、ここでのHGWの設定はあくまで戸建向けの光回線での実例です。</p><p>auひかりのHGWにブラウザでログインし<mark class="label primary">DHCPv6サーバ設定</mark>をタップします。</p><img src="/new-technology/2024/03/06/unifi-express/18.png" class="" width="360" title="alt"><p>続いて、IPv6アドレスの割り当て方法を選択します。</p><img src="/new-technology/2024/03/06/unifi-express/19.png" class="" width="360" title="alt"><p>Express向けにはいくつかの組み合わせが可能ですが、設定が3つあるうち設定2または3を選びます。<br>設定2ではIPv6アドレス＋DNSをDHCPv6で、PrefixをRAおよびDHCPv6で配布する方法です。DNS情報はDHCPv6で渡すのでRAオプションのDNSアドレス通知は使いません。設定3はPrefixをDHCPv6で配布します。デフォルトゲートウェイはRAの送信元から導きます。ここでは詳細の説明は割愛します。</p><p>最後に画面上部にある保存ボタンをタップして設定を保存してから、HGWはログアウトします。</p><h3 id="Express-WANの設定"><a href="#Express-WANの設定" class="headerlink" title="Express WANの設定"></a>Express WANの設定</h3><p>スマホアプリの右下の鍵マークアイコンの設定から<mark class="label primary">インターネット</mark>→<mark class="label primary">Primary(WAN1)</mark>→<mark class="label primary">高度な設定</mark>→<mark class="label primary">手動</mark>→<mark class="label primary">IPv6接続先</mark>のトグルを有効に、<mark class="label primary">DHCPv6</mark>を選択し、<mark class="label primary">プレフィックス委任サイズ</mark>を<strong>64</strong>にします。</p><img src="/new-technology/2024/03/06/unifi-express/20.png" class="" width="360" title="alt"><img src="/new-technology/2024/03/06/unifi-express/21.png" class="" width="360" title="alt"><p>あれ？と思った方、そうなんです。auひかりの委任は64ビット（サブネット1つだけ）なんです（ひかり電話を契約していても）。実はExpress以前に自分の使っている他社製ゲートウェイで確認したところ、&#x2F;64しか委任で貰えないようなんです。その製品のサポート担当者からは64ビットのような特殊な委任はサポート外と一刀両断されました。そりゃそうですよね。委任するというくらいなんだから最低でも60ビット（&#x2F;64を15個）など複数のサブネットがあるのが普通です。auひかりには「複数のIPv6サブネットの委任をできるようにお願いします」とは昨年秋に伝えましたが。。。</p><p>いずれにしても今回はExpressの世界、本格的な複数サブネット（VLAN）はまた今度にするとして、まずはシンプルなネットワークを作ることに専念しましょう。</p><p>ちなみに、HGWのLAN側IPv6アドレスは以下が割り当てられていました。</p><img src="/new-technology/2024/03/06/unifi-express/21-1.png" class="" width="360" title="alt"><p><code>240f:xxxx:xxxx:1::/64</code>ではない別のPrefix1つが割り当てられることになります。</p><h3 id="Express-LANの設定"><a href="#Express-LANの設定" class="headerlink" title="Express LANの設定"></a>Express LANの設定</h3><p>ExpressのLANのIPv6設定はブラウザ経由でなくてはなりません。<br>EXpressにブラウザでログインします。<br><code>https://unifi/</code> または<code>https://192.168.1.1</code></p><img src="/new-technology/2024/03/06/unifi-express/22.png" class="" width="360" title="alt"><p>ログイン後、画面右上の歯車アイコンをタップし、LANの設定に入ります。<br>スマホのキャプチャでは視認性が悪いので、ここではPC画面で項目の説明をします。</p><img src="/new-technology/2024/03/06/unifi-express/23.png" class="" width="640" title="alt"><p>IPv6のタブを選択し、<mark class="label primary">Prefix Delegation</mark>を選びます。<br>基本的には上記の画面キャプチャの通り、<mark class="label primary">WAN1</mark>インタフェースを選択します。</p><mark class="label primary">Client Address Assignment</mark>は趣味の範疇ですが、Expressが決定するアドレスにするならDHCPv6を、クライアントに任せるならSLAACを選びます。最近はSLAACでもMACアドレスベースに生成するのではなく、一時アドレスとしてクライアント側がIPアドレスを都度生成するので、IPアドレスを追跡できなくなりセキュリティ上は良いと言われています。但し、自身の管理としてログからは端末を判別しづらくなります。<p>これで設定はOKです。</p><h3 id="接続テスト"><a href="#接続テスト" class="headerlink" title="接続テスト"></a>接続テスト</h3><p>IPv6確認テストサイトで確認しましょう。</p><img src="/new-technology/2024/03/06/unifi-express/24.png" class="" width="800" title="alt"><p>問題なくIPv6で到達できているようです。HGWのPrefixは<code>240f:xxx:xxx:1::/64</code>でしたが、今回のPrefixは<code>240f:xxx:xxx:2::/64</code>となっており、パブリックIPv6アドレスがExpressに委任され、Expressからクライアントに配布されています。</p><blockquote><p>test-ipv6<br> <a href="https://test-ipv6.com/">https://test-ipv6.com</a></p></blockquote><p>これで一通りのセットアップは完了しました。UniFiスマホアプリは外出時に公衆回線からUbiquitiのクラウド経由でExpressに接続可能です。HGWのポート開放は必要ありません。後述するTeleportの技術を使っていてUbiquitiクラウドが接続管理、認証、通知などの役割を担ってくれます。これは無償のハイブリッドクラウド環境ですが、これこそがUbiqiutiが好まれる理由の1つです。</p><h2 id="Expressの機能-設定"><a href="#Expressの機能-設定" class="headerlink" title="Expressの機能&#x2F;設定"></a>Expressの機能&#x2F;設定</h2><p>必要な機能をPickupして見ていきます（多機能でとても全ては紹介しきれません）。トラフィック識別や、広告ブロックのフィルタリング状況はネットワークの見える化としてUbiquiti製品の特徴です。説明不要でグラフィカルで分かりやすいでしょうから、ここでは説明を割愛します。</p><p>管理画面ログイン後、左上のOSセッティングから<mark class="label primary">Console Settings</mark>に進みます。</p><img src="/new-technology/2024/03/06/unifi-express/25.png" class="" width="800" title="alt"><p>詳細の確認やトラブル対応の対策にSSHは事前に有効にしておきましょう。UNAにもSSHの設定がありますが、そちらはExpressが管理する配下のデバイスが対象であり今回は設定しません。</p><p>サポートとのやり取りで「サポートファイルが必要」となれば、画面最下部の<mark class="label primary">Download Support File</mark>から詳細ログをダウンロードし、UI Japanに送ることになります。</p><h3 id="プッシュ通知"><a href="#プッシュ通知" class="headerlink" title="プッシュ通知"></a>プッシュ通知</h3><p>任意設定ですが、アプリの歯車アイコンから<mark class="label primary">プッシュ通知</mark>を有効にしておくといくつかの通知を受けられます。</p><img src="/new-technology/2024/03/06/unifi-express/27.png" class="" width="360" title="alt"><p>障害などの重要なものはデフォルトで含まれています。それ以外にも、VPNの接続があったら通知する、レーダーを受信すると通知するなどいくつかの追加選択が可能です。</p><h3 id="広告ブロック"><a href="#広告ブロック" class="headerlink" title="広告ブロック"></a>広告ブロック</h3><p>UNAの設定（歯車アイコン）から、<mark class="label primary">セキュリティ</mark>を選択します。<br>ここでは<mark class="label primary">広告ブロック</mark>にチェックしておきます。広告ブロックはExpressにおいては、1つのネットワークのみ選択可能です。IPv6を有効にしていても広告は綺麗に消えますのでかなり有効です。<br>DNSシールドはDNSによる名前解決時にDoH（DNS over HTTPS）を使い、GoogleまたはCloudflareで名前解決するものです。TLS&#x2F;SSLで暗号化されているので、プロバイダや途中の経路において、どこにアクセスしているのか判らないようにする目的があります。日本のISPはDDoS対策のために独自のDNSフィルタを実施していることや、その情報を売却するなどの行為が厳しいために日本においてはDNSシールドの重要性はあまり無いものと考えられます。<br>なお、このDNSフィルタを使っていても、広告ブロックは有効です。Expressは広告ドメインを対象にDNSで排除します。</p><p>通常は、以下のクエリを返します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ nslookup www.googleadservices.com</span><br><span class="line">Server:240f:xxxx:xxxx:2::1</span><br><span class="line">Address:240f:xxxx:xxxx:2::1#53</span><br><span class="line"></span><br><span class="line">Non-authoritative answer:</span><br><span class="line">Name:www.googleadservices.com</span><br><span class="line">Address: 172.217.xxx.xxx</span><br></pre></td></tr></table></figure><p>DNSフィルタを有効にすると。。。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$ nslookup www.googleadservices.com.</span><br><span class="line">Server:240f:xxxx:xxxx:2::1</span><br><span class="line">Address:240f:xxxx:xxxx:2::1#53</span><br><span class="line"></span><br><span class="line">Name:www.googleadservices.com</span><br><span class="line">Address: 0.0.0.0</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>0.0.0.0を返すのでアクセスできなくなります。<br>控えめな広告であれば私は許容できるのですが、日本特有というか酷い内容の広告は徹底して除外したいものです。今のところExpressは綺麗に広告をカットしてくれています。</p><h2 id="Teleport-VPN"><a href="#Teleport-VPN" class="headerlink" title="Teleport(VPN)"></a>Teleport(VPN)</h2><p>まず、UniFiアプリでTeleportを有効にします。招待のリンクを生成します。</p><img src="/new-technology/2024/03/06/unifi-express/28-1.png" class="" width="360" title="alt"><p>UniFiアプリの設定（歯車アイコン）からWiFimanをインストールし、起動すると右下にTeleportというアイコンがあります。それをタップします。</p><img src="/new-technology/2024/03/06/unifi-express/28.png" class="" width="360" title="alt"><p>上記画面が表示されたら<strong>On</strong>をタップし接続開始するだけです。接続開始するまで10秒強掛かりますが、ポート開放無しにここまで自動でやってくれます。Teleport経由のSpeedtestは40Mbps弱で速いとは言えませんが、とてもお手軽です。</p><h3 id="Local-DNS"><a href="#Local-DNS" class="headerlink" title="Local DNS"></a>Local DNS</h3><p>さて、上記で自宅にVPNで接続できるようになりました。自宅に接続するというのは、そもそもNASやサーバーがある事が前提です。自宅内はローカルのDNS、hosts、NetBIOSでの名前解決を、外からはパブリックのIPをダイナミックDNSで管理し運用されていらっしゃる方も多いでしょう。<br>例えば私はSynologyのDDNSを取り敢えず利用する事にはしていますが、実際に公衆回線からパブリックIPを通して接続はしていません。単純にローカルDNSで、xxxx.synology.meというSynologyから与えられたホスト名＋ドメイン名（FQDN）で自宅ではアクセスしています（Synologyのスマホアプリもその名前（FQDN）を使います）。これはTLS&#x2F;SSL証明書とも関係ありますし、あまり自由な名前にできません。アプリのプッシュ通知による2要素認証もありますし、証明書のエラーになっていては自宅に接続できても使い物になりません。<br>UniFiには、Local DNS機能が存在しており、固定IPと名前とをセットで登録できます。</p><img src="/new-technology/2024/03/06/unifi-express/29.png" class="" width="1024" title="alt"><p>上記の右の赤枠のように、FQDNとプライベートの固定IPアドレスを設定しておきます。NASがDHCPでExpressにIPを要求すると、この固定IPアドレスとローカルDNSへの登録が自動で行われます。</p><img src="/new-technology/2024/03/06/unifi-express/30.png" class="" width="360" title="alt"><p>自宅、外出時のFQDNを統一できることで2要素認証のプッシュ通知、パスワードマネージャーからのID&#x2F;パスワード入力も極めてスムーズです。<br>Express1台でここまで便利に使えるようになります。</p><img src="/new-technology/2024/03/06/unifi-express/31.png" class="" width="1024" title="alt"><blockquote><p>UI Japan Store Express<br><a href="https://jp.store.ui.com/collections/unifi-network-unifi-os-consoles/products/ux">https://jp.store.ui.com/collections/unifi-network-unifi-os-consoles/products/ux</a></p></blockquote><p>価格は26,900円です。</p><h2 id="補足説明"><a href="#補足説明" class="headerlink" title="補足説明"></a>補足説明</h2><p>私のHGWはBL3000HMという機種です。</p><ul><li><a href="/new-technology/2023/01/28/bl3000hm/" title="auひかり BL3000HM">auひかり BL3000HM</a></li></ul><blockquote><p>Ubiquiti Japan ホームページ<br> <a href="https://note.com/ui_japan">https://note.com/ui_japan</a></p></blockquote><blockquote><p>Ubiquiti ヘルプセンター<br> <a href="https://help.jp.ui.com/categories/6583256751383/">https://help.jp.ui.com/categories/6583256751383/</a></p></blockquote><blockquote><p>Ubiquiti コミュニティ（日本）<br> <a href="https://www.facebook.com/groups/uijapan">https://www.facebook.com/groups/uijapan</a></p></blockquote><blockquote><p>Ubiquiti Community（米国中心）<br> <a href="https://community.ui.com/">https://community.ui.com/</a></p></blockquote><p>（製品提供：Ubiquiti Japan株式会社）</p>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2024/03/06/unifi-express/Title.png&quot; class=&quot;&quot; width=&quot;1024&quot; title=&quot;alt&quot;&gt;
&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;

&lt;p&gt;この記事ではUniFiネットワークの導入未経験の方を対象に、UniFiの新しい小型ゲートウェイUniFi Expressの具体的なセットアップおよび性能確認、機能紹介を目的としています。検証のため製品提供を受けていますのでこの記事はPR要素を含みます。&lt;/p&gt;</summary>
    
    
    
    <category term="Hardware" scheme="https://yoshi0808.github.io/new-technology/categories/Hardware/"/>
    
    <category term="Network" scheme="https://yoshi0808.github.io/new-technology/categories/Network/"/>
    
    
    <category term="UniFi" scheme="https://yoshi0808.github.io/new-technology/tags/UniFi/"/>
    
  </entry>
  
  <entry>
    <title>VMWare 無償版ESXiの提供終了について（最終報）</title>
    <link href="https://yoshi0808.github.io/new-technology/2024/03/04/EOS-Free-esxi3/"/>
    <id>https://yoshi0808.github.io/new-technology/2024/03/04/EOS-Free-esxi3/</id>
    <published>2024-03-04T01:09:38.000Z</published>
    <updated>2024-04-07T10:43:06.884Z</updated>
    
    <content type="html"><![CDATA[<h2 id="VMWareからの告知"><a href="#VMWareからの告知" class="headerlink" title="VMWareからの告知"></a>VMWareからの告知</h2><p>2024-02-09ごろに、以下のKBが告知され、無償版ESXiは新たにインストールが不可能となりました。但し、パッチなどは継続的に提供されることが判明しましたので、その内容を持って最終報とさせていただきます。</p><blockquote><p>End Of General Availability of the Free vSphere Hypervisor (ESXi 7.x and 8.x) (2107518)<br> <a href="https://kb.vmware.com/s/article/2107518?lang=en_us">https://kb.vmware.com/s/article/2107518?lang=en_us</a></p></blockquote><blockquote><p>要約：<br> 無償版ESXiはVMWareのWebサイトではもはや利用できません。</p></blockquote><blockquote><p>解決方法：<br> 永久ライセンスから新しいサブスクリプション製品への移行の一環として、無償版ESXiは EOGA (End of General Availability) となりました。現時点では、同等の代替製品はありません。 </p></blockquote><span id="more"></span><p>無償版ESXiのインストールモジュールはすでにダウンロードできなくなりました。</p><p>1月30日に書いた記事「<a href="/new-technology/2024/01/30/EOS-Free-esxi/" title="VMWare 無償版ESXiの提供終了について">VMWare 無償版ESXiの提供終了について</a>」では、今後もESXiを新規利用またはアップグレードされる方はISOファイルのダウンロードとライセンスの取得をお勧めしていましたが、あまりに期間も短くお役に立てなかったかもしれません。</p><p>パッチについては、2024-03-01にESXi 8.0 Update 2bが発表されましたので、無償版ESXiでも当面パッチは提供されることが分かりました。少しホッとしたと同時に、早速、パッチ情報の記事についてアップデートしましたので、ESXi8をお使いの方はパッチの適用を検討ください。</p><p>「<a href="/new-technology/2020/06/14/esxi67-patch/" title="VMware ESXiにパッチを適用する">VMware ESXiにパッチを適用する</a>」</p><h2 id="ESXiの代替の検討"><a href="#ESXiの代替の検討" class="headerlink" title="ESXiの代替の検討"></a>ESXiの代替の検討</h2><p>（ここから先は第2報とほぼ同じ内容です）</p><p>当面はESXiを継続利用できますが、既にISOファイルはダウンロードできませんし、無償ライセンスの新規取得も不可能です。有償のESXiを使うつもりでなければ、代替を検討する必要があります。</p><h2 id="Proxmox-VE"><a href="#Proxmox-VE" class="headerlink" title="Proxmox VE"></a>Proxmox VE</h2><img src="/new-technology/2024/03/04/EOS-Free-esxi3/proxmox.png" class="" width="400" title="alt"><p>ProxmoxはLinuxユーザー、個人を中心に人気のあるプロダクトです。大学や団体の利用実績もあります。ドイツの2名の開発者からスタートした企業です。ESXiは比較的ネットワークカードやNVMeの種類を選びましたから、手軽に始められる仮想環境としてはまずはProxmoxが挙げられます。</p><blockquote><p>Proxmox Virtual Environment<br> <a href="https://www.proxmox.com/en/proxmox-virtual-environment/overview">https://www.proxmox.com/en/proxmox-virtual-environment/overview</a></p></blockquote><img src="/new-technology/2024/03/04/EOS-Free-esxi3/proxmox1.png" class="" width="1024" title="alt"><p>上記は取り急ぎproxmoxをセットアップして動作させたブラウザ画面のキャプチャです。現時点では、Ubuntu22をセットアップした程度でほとんど検証ができていません。</p><p>モニタ類も非常に見やすいです。</p><img src="/new-technology/2024/03/04/EOS-Free-esxi3/proxmox2.png" class="" width="800" title="alt"><p>Proxmoxにはバックアップサーバーという製品もありますが、Proxmox VE単独でバックアップのスケジューリングができます。これは無償版ESXiと比べて良い点です。SynologyNASのNFS4.1に接続してバックアップしています。</p><img src="/new-technology/2024/03/04/EOS-Free-esxi3/proxmox3.png" class="" width="640" title="alt"><p>通知は下記のように行われます。</p><img src="/new-technology/2024/03/04/EOS-Free-esxi3/proxmox4.png" class="" width="640" title="alt"><p>バックアップ速度は4Gbps強です。差分のバックアップ（ブロック変更のみ）は無さそうですね。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">100: 2024-02-17 14:43:09 INFO: transferred 32.00 GiB <span class="keyword">in</span> 63 seconds (520.2 MiB/s)</span><br><span class="line">100: 2024-02-17 14:43:10 INFO: archive file size: 10.06GB</span><br></pre></td></tr></table></figure><p>スナップショットもESXi同等にメモリの状態まで確保できます（ZFSファイルシステムで実行）。</p><p>少し気になる点としては無償で利用するには開発用リポジトリを使うことになり、有償のリポジトリはより安全にテストされたものが利用できる仕組みです。GUIでもモジュールは更新できますが、更新の単位は<code>apt update</code>と同様の感覚です。リモートワークなどに利用しているVMがあるのであればその点は留意する必要があります。</p><p>まだ十分な検証ができていませんが、手軽にESXiからの移行を始めるにはProxmoxの環境で検証をスタートさせるのも良いかもしれません。<br>Proxmox自体、セキュアブートでインストールでき、VMもセキュアブートの設定ができます。</p><p>設定はややLinux寄りです。結局はLinuxのコマンドをGUIにうまく形を変えているとも言えます。ESXiで慣れていると少しギャップがあります。ESXiのVMWare Remote Consoleは素晴らしい製品でしたが、そこまでは行かずとも、別ウィンドウでVNCから暗号化通信でコンソールにアクセスするなど操作性はとても良く、先進的であると感じさせます。</p><p>取り急ぎ、ProxmoxVE8.1のセットアップとVMの新規作成に関する記事を投稿しています。Proxmoxを試してみたい方は参考にしてみてください。</p><ul><li><a href="/new-technology/2024/02/17/ProxmoxVE/" title="ProxmoxVEのインストール">ProxmoxVEのインストール</a></li><li><a href="/new-technology/2024/02/19/Proxmox-new-vm/" title="ProxmoxVEのVM新規作成（Ubuntu24.04LTS）">ProxmoxVEのVM新規作成（Ubuntu24.04LTS）</a></li></ul><h2 id="XCP-ng（XEN-Orchestra）"><a href="#XCP-ng（XEN-Orchestra）" class="headerlink" title="XCP-ng（XEN Orchestra）"></a>XCP-ng（XEN Orchestra）</h2><img src="/new-technology/2024/03/04/EOS-Free-esxi3/xcpng.png" class="" width="800" title="alt"><p>新しいプロダクトではありませんが、Citrixが提供しているXen Serverから派生したオープンソースシステムでVatesという会社が提供しています。2012年にフランスで設立されています。おそらく規模は小さい会社のように見えます。こちらは企業中心、またホームラボでも利用されています。<br>仮想化という概念では素晴らしいものをXenから継承しており、本格的なHypervisorです。ProxmoxはHypervisorとも言えますが、VMが明確に独立しておらずDMAなどのメモリへのアクセスはかなり自由です。一方、XCP-NGは厳格にセパレートされておりセキュリティが高く、安定度も高い物と考えられます。その犠牲になるのは速度ですが、XEN Orchestraという有償のGUI管理ツールはわかりやすいため、ESXiユーザーはこちらの方が気にいるかもしれません。</p><blockquote><p>XCP-ng<br> <a href="https://xcp-ng.org/#easy-to-install">https://xcp-ng.org/#easy-to-install</a></p></blockquote><p>Xen OrchestraのGUIツールは有償ですが、個人が使うためのソースコードが提供されており、自身でコンパイルして利用する分には無償です。有償のプロダクトはXOA（Xen Orchestra Apliance）、ソースコードからビルドしたものはXOと呼ばれ区別されています。</p><p>Proxmoxと比べると少しグラフィカルな面は見劣りするでしょうか。</p><img src="/new-technology/2024/03/04/EOS-Free-esxi3/xo1.png" class="" width="1024" title="alt"><p>ネットワークなどは簡単にVLANを作成できて一覧として確認できるので管理しやすく思えます。</p><img src="/new-technology/2024/03/04/EOS-Free-esxi3/xo2.png" class="" width="1024" title="alt"><p>これはMellanox Connect X-3の１つのPort（ネイティブVLAN&#x3D;1）にさらに仮想のVLAN110を加えています。</p><p>こちらもバックアップはスケジューリングできます。ESXiのようにバックアップもブロック単位の差分で取得できます。<br>バックアップのメール通知は以下のような形で行われます。</p><img src="/new-technology/2024/03/04/EOS-Free-esxi3/xo3.png" class="" width="480" title="alt"><p>VMはブラウザから操作することになりますが、メニューの大きさも相まって、少し使いづらいと感じます。クライアントのVNCからXenOrchestraにSSHしてPort Forwardingすることによって暗号化した上で単独のVNCクライアントから操作できるようですが、こちらはまだ未確認です。</p><img src="/new-technology/2024/03/04/EOS-Free-esxi3/xo4.png" class="" width="1024" title="alt"><p>XCP-ng本体は特に難しいところもなくインストールができます。8.2.1はまだセキュアブートのセットアップはできません。VM自体はセキュアブートの設定ができます。また、Xen Orchestraの管理ツール自体は別ノードからアクセスする方が好ましく、最初からノード単位のフェールオーバーなどを考えて作られています。現在私のセットアップではXen OrchestraをESXiで、昔使っていたintelのPCにXCP-NGをセットアップしています。</p><p>XCP-ngの最新バージョンは現在8.2.1ですが、Ryzen環境で動作させると応答速度やネットワーク速度が遅く、Communityの情報を見ながら、古いintel core i7マシン（Intel(R) Core(TM) i7-8700 CPU @ 3.20GHz）に再インストールするなど、少し回り道してしまいました。8.3はまだベータ版ですが、そこではRyzen版の速度改善が見込めるようなのでこちらはまた少し時間を置いてから検証を開始するつもりです。なお、P-Core&#x2F;E-CoreのCPUは仮想環境でどのようにCPUが使われるのか読めないと考えられ、難しさを感じています。</p><p>XCP-NGはスナップショットやバックアップが少し古い時代を感じさせるところがあります。稼働中のVMをバックアップした後にレストアすると、OSをブートするところから始まります。つまり、メモリの内容が廃棄されてしまいます。オープンしていたファイルがどうなるのか、恐らくロールバックされるとは思いますが、検証をしっかりと行いたい箇所ではあります。</p><p>XO自体のリポジトリはGitHubにあり、かなり細かい単位でMasterブランチ（メインのソースコードの配置場所）がCommitされていきます。どこかでそれらの更新部分を取り込むには改めてXOのソースコードのコンパイルから必要になります。但し、これは簡単なスクリプトで手間をかけずに対処可能です。</p><p>私がXCP-ngに期待しているのはシステムの安定度です。ESXiも本当に安定していて、これまでハードウェアの故障以外でハングしたりすることは全くありませんでした。また、Xen Orchestraは、企業で数十台の仮想サーバを管理することを想定して作られており、管理のしやすさを感じます。</p><p>Proxmox、XCP-ngともに良いプロダクトのようで、最終的にはどちらかの仮想環境をメインに使い、2台構成でライブマイグレーション（仮想マシンのノード間の移動）まで実現できればと考えています。</p><p>海外のホームラボのパワーユーザーはどちらかといえば、XCP-ngを好むようにも見えます。これは簡単なProxmoxは面白くないということなのかもしれません。ESXiの代替としてはXCP-ngが今脚光を浴びているように見えます。</p><p>XCP-ng、Xen Orchestraへの理解を深めるには、ローレンスシステムズのTom氏が解説しているYouTubeビデオがわかりやすいと思います。</p><blockquote><p>Understanding How The XCP-NG &amp; Xen Orchestra Open Source Virtualization Platform Works<br> <a href="https://www.youtube.com/watch?v=CEUFHudLO1g&t=447s">https://www.youtube.com/watch?v=CEUFHudLO1g&amp;t=447s</a></p></blockquote><p>XCP-ngに興味のある方はこちらの記事をご覧ください。</p><ul><li><a href="/new-technology/2024/04/07/xcpng/" title="XCP-ngとXen Orchestra">XCP-ngとXen Orchestra</a></li><li><a href="/new-technology/2024/04/07/xcpng-newvm/" title="XCP-ngのVM新規作成">XCP-ngのVM新規作成</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;VMWareからの告知&quot;&gt;&lt;a href=&quot;#VMWareからの告知&quot; class=&quot;headerlink&quot; title=&quot;VMWareからの告知&quot;&gt;&lt;/a&gt;VMWareからの告知&lt;/h2&gt;&lt;p&gt;2024-02-09ごろに、以下のKBが告知され、無償版ESXiは新たにインストールが不可能となりました。但し、パッチなどは継続的に提供されることが判明しましたので、その内容を持って最終報とさせていただきます。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;End Of General Availability of the Free vSphere Hypervisor (ESXi 7.x and 8.x) (2107518)&lt;br&gt; &lt;a href=&quot;https://kb.vmware.com/s/article/2107518?lang=en_us&quot;&gt;https://kb.vmware.com/s/article/2107518?lang=en_us&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;要約：&lt;br&gt; 無償版ESXiはVMWareのWebサイトではもはや利用できません。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;解決方法：&lt;br&gt; 永久ライセンスから新しいサブスクリプション製品への移行の一環として、無償版ESXiは EOGA (End of General Availability) となりました。現時点では、同等の代替製品はありません。 &lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    
    <category term="ESXi" scheme="https://yoshi0808.github.io/new-technology/tags/ESXi/"/>
    
  </entry>
  
  <entry>
    <title>ProxmoxVEのVM新規作成（Ubuntu24.04LTS）</title>
    <link href="https://yoshi0808.github.io/new-technology/2024/02/19/Proxmox-new-vm/"/>
    <id>https://yoshi0808.github.io/new-technology/2024/02/19/Proxmox-new-vm/</id>
    <published>2024-02-19T00:04:44.000Z</published>
    <updated>2024-06-09T05:01:46.646Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2024/02/19/Proxmox-new-vm/Title.png" class="" title="alt"><p class="onepoint">この記事で実現すること</p><p>仮想環境のProxmox VEで仮想マシン（VM）の新規作成を行います。例示としてこの記事ではUbuntu24のセットアップを行います。ネットワークインターフェースと仮想マシンとの関係も見ていきます。</p><span id="more"></span><h2 id="Ubuntu-24-04LTSのダウンロード"><a href="#Ubuntu-24-04LTSのダウンロード" class="headerlink" title="Ubuntu 24.04LTSのダウンロード"></a>Ubuntu 24.04LTSのダウンロード</h2><p>最初にUbuntu24.04LTSのダウンロードを行います。</p><blockquote><p>Ubuntu Desktop 24.04 LTS<br> <a href="https://jp.ubuntu.com/download">https://jp.ubuntu.com/download</a><br> ファイル名は「ubuntu-24.04-desktop-amd64.iso」です。</p></blockquote><h2 id="Proxmox-VEのネットワーク構成"><a href="#Proxmox-VEのネットワーク構成" class="headerlink" title="Proxmox VEのネットワーク構成"></a>Proxmox VEのネットワーク構成</h2><p>新規VMのセットアップにはディスク、メモリ、ネットワークを定義することになりますが、VMの新規作成の前にネットワークインタフェースについて見ていきます。</p><p>以下は私の環境の例です。intel X710の4PortとRealtekのオンボードNIC（未使用）の５つが存在します。</p><img src="/new-technology/2024/02/19/Proxmox-new-vm/proxmox1.png" class="" width="1024" title="alt"><p>X710の4Portは”enp1s0f0”が1Port目、”enp1s0f3”が4Port目となっています。これが物理ネットワークインタフェースです。<br>これに加えて、インストール直後は、vmbr0というネットワークブリッジが作成されており、ここではセットアップ時に決めたIPアドレスが設定されているはずです。vmbr1以降は私が手動で作成しています。</p><p>仮想環境においてはL2ネットワークが重要であり、VMは仮想MACアドレスを保有します。ProxmoxのインタフェースではこのネットワークブリッジがNICの物理MACアドレス以外の仮想マシンのMACアドレスも受け取ることになり、いわば、無差別モード（プロミスキャスモード）で動作します。</p><p>仮想マシンに対してL2レイヤのブリッジ（取り次ぐ）を行うために、<mark class="label primary">Linux Bridge</mark>が必要となります。<br>Proxomoxにおいては命名規約は厳格であり、自由な名前は付けられません。ブリッジにしてもVLANにしても命名規則に従う必要があります。</p><p>ここでは仮想マシンの仮想MACアドレスは作成しません。VMを作成するタイミングで自動生成されることになります。L3レイヤ、つまりIPアドレスに関してProxmoxは意識しません。VMの中のOS任せであり、これはESXiなどの他のハイパーバイザーと考え方は同じです。</p><p>個人的には、物理ネットワークカードのMACアドレスが表示されないのは少しわかりづらく感じます。物理ネットワーク（ネットデバイス）にはコメント欄があるので、そこにMACアドレスを記入しておけば運用面はなんとかなりそうです。</p><h2 id="ISOの保存先"><a href="#ISOの保存先" class="headerlink" title="ISOの保存先"></a>ISOの保存先</h2><p>VMを新規作成する上で、OSのインストールのために予めISOファイルをコピーしておく必要があります。Proxmoxの左ペインから、<mark class="label primary">local(ホスト名)</mark>を選択します（私の環境ではホスト名がpve1という名前です）。</p><img src="/new-technology/2024/02/19/Proxmox-new-vm/proxmox2.png" class="" width="800" title="alt"><p>ここに<mark class="label primary">ISOイメージ</mark>とあるので、選択します。ここで、<mark class="label primary">アップロード</mark>ボタンをクリックし、ローカルの端末からISOファイルをアップロードします。今回は、Ubuntu24.04デスクトップをインストールするためにファイルアップロードします。</p><h2 id="VMの新規作成"><a href="#VMの新規作成" class="headerlink" title="VMの新規作成"></a>VMの新規作成</h2><p>ここでは２つのネットワークインタフェースを持つUbuntu24をセットアップします。もちろん、１つの場合はより簡単です。<br>Proxmoxの右上にある青いボタン<mark class="label primary">VMを作成</mark>をクリックします。いよいよ仮想マシンの作成に入ります。</p><img src="/new-technology/2024/02/19/Proxmox-new-vm/proxmox3.png" class="" width="480" title="alt"><p>ホスト名としての名前を（ご自身で決めたものを）入力します。VM IDは100から付番されていきます。また<mark class="label primary">ブート時に起動</mark>するか否かを決定します。</p><h3 id="OSの種類"><a href="#OSの種類" class="headerlink" title="OSの種類"></a>OSの種類</h3><img src="/new-technology/2024/02/19/Proxmox-new-vm/proxmox4.png" class="" width="480" title="alt"><p>Linuxを選択します。UbuntuやDebianなどをバージョン毎に選ぶのかと思いましたが、種類は多くありません。<mark class="label primary">Kernel6.x-2.6</mark>または<mark class="label primary">Kernel2.4</mark>の2種類です。<mark class="label primary">Kernel6.x-2.6</mark>を選択します。今回は関係ありませんが、Windows11もインストールできるようですね。また、懐かしいSolarisも選択可能となっています。<br>さて、ISOファイルを選択して次に進みます。</p><h3 id="システム"><a href="#システム" class="headerlink" title="システム"></a>システム</h3><img src="/new-technology/2024/02/19/Proxmox-new-vm/proxmox6.png" class="" width="480" title="alt"><p>ここでは、旧ブートのBIOS（SeaBIOS）かUEFIを選択します。UbuntuはUEFIに対応しているので基本的にはUEFIを選びます。<mark class="label primary">TPM追加</mark>は好みで選んでください。また、<mark class="label primary">Qemuエージェント</mark>のチェックボックスは最初、Offのままにしておきます（後で設定します）。ゲストにインストールするヘルパーデーモンであり、稼働状況をホストが把握するためや、ホストから安全にシャットダウンするなどのアクションができるようになります。ESXiではVMWareToolsに相当するモジュールです。</p><h3 id="ディスク"><a href="#ディスク" class="headerlink" title="ディスク"></a>ディスク</h3><img src="/new-technology/2024/02/19/Proxmox-new-vm/proxmox7.png" class="" width="480" title="alt"><p>ディスクサイズを設定します。追加のボリュームを加える場合もここで設定します。</p><h3 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h3><img src="/new-technology/2024/02/19/Proxmox-new-vm/proxmox8.png" class="" width="480" title="alt"><p>CPUの種別、CPUのコア数を指定します。Extra CPU Flagsとしていくつかの脆弱性に対応させるためのチェックがあります。私はRyzen５5600GにProxmoxをインストールしているので下記のオプションとしました。<br>CPUの種別は特定されたものがあればそれを、無ければ一般的に<mark class="label primary">x86-64-v2-AES</mark>を選びます。Intel&#x2F;AMDをクラスタで混在させないならそのCPUの最も古いものに合わせておくのが良いようです。詳細はヘルプのCPU TYPEを確認してください。</p><blockquote><p>If you don’t care about live migration or have a homogeneous cluster where all nodes have the same CPU and same microcode version, set the CPU type to host, as in theory this will give your guests maximum performance.</p></blockquote><blockquote><p>If you care about live migration and security, and you have only Intel CPUs or only AMD CPUs, choose the lowest generation CPU model of your cluster.</p></blockquote><blockquote><p>If you care about live migration without security, or have mixed Intel&#x2F;AMD cluster, choose the lowest compatible virtual QEMU CPU type.</p></blockquote><h3 id="メモリ"><a href="#メモリ" class="headerlink" title="メモリ"></a>メモリ</h3><img src="/new-technology/2024/02/19/Proxmox-new-vm/proxmox9.png" class="" width="480" title="alt"><p>VMで利用するメモリの量を設定します。</p><h3 id="ネットワーク"><a href="#ネットワーク" class="headerlink" title="ネットワーク"></a>ネットワーク</h3><img src="/new-technology/2024/02/19/Proxmox-new-vm/proxmox10.png" class="" width="480" title="alt"><p>特に変更することはなく、NICのモデルは、<mark class="label primary">VirtIO(準仮想化)</mark>を選んでおきます。おっと、ここではNICを追加することができませんね。後で2枚目のNICを追加することになるのでしょうか。まずはメインの<mark class="label primary">vmbr0</mark>ブリッジを選択しておきます。</p><h3 id="確認"><a href="#確認" class="headerlink" title="確認"></a>確認</h3><p>最後に確認画面で完了します。</p><h2 id="（任意）仮想マシンでネットワークの追加"><a href="#（任意）仮想マシンでネットワークの追加" class="headerlink" title="（任意）仮想マシンでネットワークの追加"></a>（任意）仮想マシンでネットワークの追加</h2><p>2枚目のNICをVMに追加する場合、仮想マシンが作成されたら、以下のようにハードウェアからネットワークの追加を行います。</p><img src="/new-technology/2024/02/19/Proxmox-new-vm/proxmox12.png" class="" width="1024" title="alt"><h2 id="VMの起動"><a href="#VMの起動" class="headerlink" title="VMの起動"></a>VMの起動</h2><p>左ペインでVMを選択した状態で、画面上部の<mark class="label primary">▶︎開始</mark>をクリックします。</p><p>さて、無事にコンソールから起動してきました。</p><img src="/new-technology/2024/02/19/Proxmox-new-vm/proxmox13.png" class="" width="1024" title="alt"><p>ProxoxのVMの<mark class="label primary">コンソール</mark>のプルダウンから、<mark class="label primary">VNC</mark>を選ぶと大きな画面でセットアップを進められます。</p><h2 id="Ubuntu24-04-Desktopのインストール"><a href="#Ubuntu24-04-Desktopのインストール" class="headerlink" title="Ubuntu24.04 Desktopのインストール"></a>Ubuntu24.04 Desktopのインストール</h2><p>さて、ここからはUbuntuのセットアップに入ります。とは言っても、殆ど迷うことなくセットアップは完了します。</p><img src="/new-technology/2024/02/19/Proxmox-new-vm/ubuntu1.png" class="" width="800" title="alt"><img src="/new-technology/2024/02/19/Proxmox-new-vm/ubuntu2.png" class="" width="800" title="alt"><img src="/new-technology/2024/02/19/Proxmox-new-vm/ubuntu3.png" class="" width="800" title="alt"><p>迷うのはキーボードぐらいでしょうか。実際にタイプしてよく問題になりそうな記号について確認できます。「検出」を行うと、海外を基準として様々な文字の有無を確認させられるのでかえって面倒です。</p><img src="/new-technology/2024/02/19/Proxmox-new-vm/ubuntu4.png" class="" width="800" title="alt"><img src="/new-technology/2024/02/19/Proxmox-new-vm/ubuntu5.png" class="" width="800" title="alt"><img src="/new-technology/2024/02/19/Proxmox-new-vm/ubuntu6.png" class="" width="800" title="alt"><img src="/new-technology/2024/02/19/Proxmox-new-vm/ubuntu7.png" class="" width="800" title="alt"><p>オフィスツールなどを利用するか否かでセットアップの種類を選択します。</p><img src="/new-technology/2024/02/19/Proxmox-new-vm/ubuntu8.png" class="" width="800" title="alt"><p>追加のドライバなどはお好みで設定してください。</p><img src="/new-technology/2024/02/19/Proxmox-new-vm/ubuntu9.png" class="" width="800" title="alt"><p>ファイルシステムの変更を行う場合（ex. ext4→ZFS）は、ここでカスタマイズします。</p><img src="/new-technology/2024/02/19/Proxmox-new-vm/ubuntu10.png" class="" width="800" title="alt"><p>最初のユーザーを作成します。</p><img src="/new-technology/2024/02/19/Proxmox-new-vm/ubuntu11.png" class="" width="800" title="alt"><p>タイムゾーンを設定して完了です。</p><img src="/new-technology/2024/02/19/Proxmox-new-vm/ubuntu12.png" class="" width="800" title="alt"><img src="/new-technology/2024/02/19/Proxmox-new-vm/ubuntu13.png" class="" width="800" title="alt"><p>Ubuntu Proの設定確認があるので、登録します。できるだけシャットダウンせずに自動的にパッチが適用できます。個人ユーザーの場合は、Ubuntu Oneアカウントを作成し、それからProのレジストを行うことで対応できます。add token manuallyを選択して、Proのレジストが終わってから、トークンをここに貼り付けて完了させます。</p><img src="/new-technology/2024/02/19/Proxmox-new-vm/ubuntu14.png" class="" width="800" title="alt"><p>Ubuntu Oneアカウントがない場合は、こちらからアカウントを作成します。文字列のコピーペーストをするので、UbuntuのFirefoxを使ってアカウントの作成とProのレジストを行ってください。</p><p><a href="https://login.ubuntu.com/">https://login.ubuntu.com/</a></p><p>その後、Ubuntu Proのレジストを以下で行います。<br><a href="https://ubuntu.com/pro">https://ubuntu.com/pro</a></p><img src="/new-technology/2024/02/19/Proxmox-new-vm/ubuntu15.png" class="" width="800" title="alt"><p>さて、Proのレジストが完了すると、トークンを入手できますので、Ubuntuのセットアップ画面にトークンを貼り付けます。</p><img src="/new-technology/2024/02/19/Proxmox-new-vm/ubuntu16.png" class="" width="800" title="alt"><p>登録が完了すると以下の画面になります。できるだけリブートせずに自動的にパッチが当たっていくので運用がとても楽になります。</p><img src="/new-technology/2024/02/19/Proxmox-new-vm/ubuntu17.png" class="" width="800" title="alt"><h3 id="Open-SSH-Serverのインストール"><a href="#Open-SSH-Serverのインストール" class="headerlink" title="Open SSH Serverのインストール"></a>Open SSH Serverのインストール</h3><p>UbuntuにSSHするために必ず必要なモジュールです。GUIでコマンドを扱うには<mark class="label primary">端末</mark>というアプリケーションを起動します。 そこからopensshをインストールします。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">sudo</span> apt update</span><br><span class="line">$ <span class="built_in">sudo</span> apt install openssh-server</span><br><span class="line"></span><br><span class="line">パッケージリストを読み込んでいます... 完了</span><br><span class="line">依存関係ツリーを作成しています... 完了</span><br><span class="line">状態情報を読み取っています... 完了</span><br><span class="line">以下の追加パッケージがインストールされます:</span><br><span class="line">  ncurses-term openssh-sftp-server ssh-import-id</span><br><span class="line">提案パッケージ:</span><br><span class="line">  molly-guard monkeysphere ssh-askpass</span><br><span class="line">以下のパッケージが新たにインストールされます:</span><br><span class="line">  ncurses-term openssh-server openssh-sftp-server ssh-import-id</span><br><span class="line">アップグレード: 0 個、新規インストール: 4 個、削除: 0 個、保留: 0 個。</span><br><span class="line">751 kB のアーカイブを取得する必要があります。</span><br><span class="line">この操作後に追加で 6,046 kB のディスク容量が消費されます。</span><br><span class="line">続行しますか? [Y/n] Y</span><br></pre></td></tr></table></figure><p>Ubuntuで<mark class="label primary">端末</mark>アプリケーションを起動する場合、キーボードショートカットによる起動が便利です。セットアップ時のキーボードの選択によって内容は変わりますが、Widnowsは”Ctrl”+”Alt”+”T”で起動します。macOSでは”option”+”control”+”T”で起動します。</p><h2 id="Proxmoxのセットアップの続き"><a href="#Proxmoxのセットアップの続き" class="headerlink" title="Proxmoxのセットアップの続き"></a>Proxmoxのセットアップの続き</h2><p>さて、Proxmoxの世界に戻ります。セットアップしているところでVMのサマリー画面を見ていると結構面白いですね。1vCPUと2GBのメモリでは少々足りないようです。</p><img src="/new-technology/2024/02/19/Proxmox-new-vm/proxmox14.png" class="" width="1024" title="alt"><p>もちろん後からCPUとメモリは変更できます。4vCPU&#x2F;4GBのメモリでもFirefoxを起動し、Fast.comに接続すると結構しんどそうです（1.5Gbps）。Ryzen7 5700GのESXiでは2vCPU&#x2F;2GBで2.4Gbps、XCP-ngでは古いCore <a href="mailto:&#105;&#x37;&#45;&#x38;&#55;&#48;&#48;&#64;&#51;&#x2e;&#50;&#48;&#x47;&#72;&#x7a;">i7-8700@3.20GHz</a>で2vCPU&#x2F;2GBで2.8Gbpsなので最適化という意味では若干改善の余地があるような気もします。これがCLIベースのSpeedtestだと3者共に殆ど結果が変わらないので何か描画などに関してオーバーヘッドがあるのかなという気がしています。</p><p>また、ゲストエージェントが未設定という表示もされています。</p><h2 id="VMの確認と後工程"><a href="#VMの確認と後工程" class="headerlink" title="VMの確認と後工程"></a>VMの確認と後工程</h2><p>Ubuntuのセットアップが終了して再起動後、さらにUbuntuモジュールの更新処理が行われていきます。<br>それがひと段落したら、ゲストエージェントをインストールします。Ubuntu上の端末アプリケーションを起動し、以下のコマンドを入力します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">sudo</span> apt install qemu-guest-agent</span><br></pre></td></tr></table></figure><p>これでゲストエージェントのインストールは完了です。一旦、VMをシャットダウンします。<br>続いて、VMのオプションから、<mark class="label primary">QEMU Guest Agent</mark>を有効にします。</p><img src="/new-technology/2024/02/19/Proxmox-new-vm/proxmox15.png" class="" width="1024" title="alt"><p>再度、Ubuntuを起動し、サマリ情報を参照すると、以下のようにIPアドレスの情報が取得できています。当たり前ですが、IPv6も確認できます。</p><img src="/new-technology/2024/02/19/Proxmox-new-vm/proxmox16.png" class="" width="800" title="alt"><mark class="label primary">More</mark>ボタンをクリックすると、2枚目のNICのIPアドレスも確認できます。<p>これでProxmoxに関して、一通りセットアップからVMの作成までを終えました。CPUタイプのあたりは少し最適化に向けて試行錯誤は必要そうですが、とても簡単にVMが作成できることがわかりました。</p>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2024/02/19/Proxmox-new-vm/Title.png&quot; class=&quot;&quot; title=&quot;alt&quot;&gt;

&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;

&lt;p&gt;仮想環境のProxmox VEで仮想マシン（VM）の新規作成を行います。例示としてこの記事ではUbuntu24のセットアップを行います。ネットワークインターフェースと仮想マシンとの関係も見ていきます。&lt;/p&gt;</summary>
    
    
    
    <category term="Software" scheme="https://yoshi0808.github.io/new-technology/categories/Software/"/>
    
    
    <category term="proxmox Ubuntu" scheme="https://yoshi0808.github.io/new-technology/tags/proxmox-Ubuntu/"/>
    
  </entry>
  
  <entry>
    <title>ProxmoxVEのインストール</title>
    <link href="https://yoshi0808.github.io/new-technology/2024/02/17/ProxmoxVE/"/>
    <id>https://yoshi0808.github.io/new-technology/2024/02/17/ProxmoxVE/</id>
    <published>2024-02-17T13:52:00.000Z</published>
    <updated>2024-02-20T14:05:33.844Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2024/02/17/ProxmoxVE/Title.png" class="" title="alt"><p class="onepoint">この記事で実現すること</p><p>個人ユーザーでも手軽に始められる仮想環境のProxmox VE8.1のインストールを行います。セットアップは非常に簡単ですが、ポイントを絞って解説していきます。</p><span id="more"></span><h2 id="Proxmox-VEとは"><a href="#Proxmox-VEとは" class="headerlink" title="Proxmox VEとは"></a>Proxmox VEとは</h2><p>Proxmox VEは、Debianベースのオープンソース仮想プラットフォームです。LinuxのKVMベースの仮装化とLXCのコンテナに対応しています。KVMはLinuxの一部であり、正統なハイパーバイザーにかなり近いですが、Linuxの中間型ともいえ、メモリ管理はあくまでLinuxとして行われるのが特徴です。Linuxにより近いことでパフォーマンスのボトルネックが少ないとも言えます。一方、セキュリティなどVMの独立性というセキュリティの面では正統なハイパーバイザーよりは劣ります。</p><p>KVMはかなりPC寄りでコマンド中心の管理となり、何らかのGUIツールと組み合わせて利用されることが一般的です。ProxmoxはGUI中心の操作で、それ単体でバックアップやスナップショットなどが実行でき、手軽で便利な仮想環境の最有力候補となります。</p><p>特にLinuxで稼動するツールなどを利用する想定だと、複数個のVMを立てる必要となりますので、最近の多数のコアのPCがあると便利です。ESXiのようにネットワークカードを厳選してしまう事もないので2.5GbEなどをはじめ多くの方が利用できるでしょう。NASとは異なり、仮想環境は一般的に大量のトラフィックを捌くものではないので、単にサーバーを立ち上げるだけであれば1GbEで十分なことも多いでしょう。さほどCPUが強力ではないミニPCを使うケースも多く見られます。<br>一方、ファイアウォールやルーターとして利用する場合は高速なCPUと10GbEのネットワークが必要となるケースもあり、利用方法は2分されます。</p><p>インストールは英語ですが、操作画面の言語は日本語が表示できます。</p><h2 id="価格と安定度"><a href="#価格と安定度" class="headerlink" title="価格と安定度"></a>価格と安定度</h2><p>Proxmoxは有償のプロダクトですが、本番環境で利用しないことを想定して無償で利用できます。それはモジュールなどのアップデートがベータ版としての扱いのモジュールが含まれることになります。これは「サブスクリプション無しのリポジトリ」と呼ばれます。セキュリティパッチなどを考えると原則パッチは当てていくことになりますが、その中に不十分なテストモジュールを含む場合があり、システム全体の安定度はあまり担保されません。自己責任ですので「お勧めしない」ということになります。また、ESXiのような、エンタープライズ向けのシステムではないのでドライバーなどがあまりこなれていないようにも見えます。</p><p>安定度への貢献のため、無償ユーザーがテストを兼ねるというのはよく考えられています。ネットワークのUbiquitiもそうですが、ホームユーザーは積極的にアルファ版のテストから参加されています。</p><p>価格と機能については以下のメニューとなっています。</p><img src="/new-technology/2024/02/17/ProxmoxVE/price.png" class="" width="1024" title="alt"><p>一番下のCommunityでも、Enterpriseリポジトリが使えます。価格は年間、1CPUソケットあたり110ユーロ（約17,800円）です。<br>無償ESXiから乗り換えを検討している状況なら、VMUGというユーザーグループに加入し、VMWare製品を個人利用限定で使う場合を考えると参加費用の年間200ドル（約30,000円）が必要です。これらを両睨みで考えることになるでしょうか。費用を支払う場合は、VMWareの方が色々な製品を使えてお得なのかなと考えられますが、こういった価格帯系は急に変わることも多く悩みどころです。</p><p>私はProxmoxを検証のためしばらく利用するつもりですが、有償のリポジトリとしてはおそらく利用せず、あくまで検証や安定性に難があっても構わない領域で使っていこうと考えています。</p><h2 id="システム要件"><a href="#システム要件" class="headerlink" title="システム要件"></a>システム要件</h2><p>推奨ハードウェアは以下の通りです。</p><ul><li>IntelVT&#x2F;AMD-V、CPUフラグ付きのIntelEMT64またはAMD64。</li><li>メモリ、OSおよびProxmox VEサービス用の最低2GB。さらに、ゲスト用の指定されたメモリ。CephまたはZFSの追加メモリが必要な場合は、使用するストレージTBごとに約1GBのメモリが必要。</li><li>高速で冗長なストレージ、SSDディスクで最高の結果。</li><li>ストレージ：バッテリーで保護された書き込みキャッシュ（BBU）を備えたハードウェアRAID、またはZFSおよびSSDキャッシュを備えた非RAID。</li><li>VMストレージ： ローカルストレージには、バッテリーバックアップ書き込みキャッシュ（BBU）またはZFS用の非RAIDを備えたハードウェアRAIDを使用。ZFS、CephはハードウェアRAIDコントローラと互換性無し。共有および分散ストレージも可能。</li><li>冗長Gbit NIC、優先ストレージ技術とクラスターセットアップに応じて追加のNIC - 10 Gbit以上もサポート。PCI(e)パススルーには、VT-d&#x2F;AMD-d CPUフラグ付きのCPUが必要。</li></ul><p>こうやってRequirementを見てみると個人向けとも言えない本格派の構成を想定しているように見受けられます。本番環境ではお勧めしないとしつつも、その目線の高さを感じられます。<br>最小構成など詳細は以下のリンクを参照してください。</p><blockquote><p>Proxmox システム要件<br> <a href="https://www.proxmox.com/en/proxmox-virtual-environment/requirements?highlight=WyJoYXJkd2FyZSIsImhhcmR3YXJlJ3MiLCJjb21wYXRpYmxlIiwiY29tcGF0aWJpbGl0eSJd">https://www.proxmox.com/en/proxmox-virtual-environment/requirements?highlight=WyJoYXJkd2FyZSIsImhhcmR3YXJlJ3MiLCJjb21wYXRpYmxlIiwiY29tcGF0aWJpbGl0eSJd</a></p></blockquote><h2 id="モジュールのダウンロード"><a href="#モジュールのダウンロード" class="headerlink" title="モジュールのダウンロード"></a>モジュールのダウンロード</h2><p>以下のURLからモジュールをダウンロードします。</p><blockquote><p>Download ISO image<br> <a href="https://www.proxmox.com/en/downloads/proxmox-virtual-environment/iso">https://www.proxmox.com/en/downloads/proxmox-virtual-environment/iso</a></p></blockquote><p>最新バージョンは8.1です。</p><p>WindowsであればRufusなどでUSBメモリにISOファイルをインストールします。</p><blockquote><p>Rufus<br> <a href="https://rufus.ie/ja/">https://rufus.ie/ja/</a></p></blockquote><p>または、WindowsのMicrosoftストアアプリでRufusを検索してインストールします。</p><p>Proxmox 8.1はセキュアブートに対応しています。UEFIでセキュアブートでのインストールがうまくいかない場合は、 UEFIセットアップ画面でセキュアブートをOffに、CMSサポートを有効にするなどして古いブート形式で起動しセットアップを行います。</p><p>その他のOSでメディアを作成するなど、インストールに関する情報は以下を参照してください。</p><blockquote><p>Installing Proxmox VE<br> <a href="https://pve.proxmox.com/pve-docs/chapter-pve-installation.html">https://pve.proxmox.com/pve-docs/chapter-pve-installation.html</a></p></blockquote><h2 id="インストール"><a href="#インストール" class="headerlink" title="インストール"></a>インストール</h2><p>インストールに入る前に、複数のネットワークカードがある場合は、どのPortをメインのマネジメントインタフェースにするか決めておく必要があるので、それぞれのNICのMACアドレスを確認しておく事をお勧めします。</p><img src="/new-technology/2024/02/17/ProxmoxVE/proxmox1.png" class="" width="1024" title="alt"><p>セットアップを起動し、<mark class="label primary">Install Proxmox VE(Graphical)</mark>を選択します。</p><ol><li>EULAへの同意</li><li>Diskのフォーマット選択画面が表示されます。</li></ol><img src="/new-technology/2024/02/17/ProxmoxVE/proxmox2.png" class="" width="1024" title="alt"><ol start="3"><li><p>optionをクリックします。</p></li><li><p>ファイルシステムはデフォルトはext4です。ここで、xfs、zfs、btrfsとが選択できます。<br> ファイルシステムは以下の項目を参考に決定してください。</p></li></ol> <img src="/new-technology/2024/02/17/ProxmoxVE/proxmox3.png" class="" width="1024" title="alt"><p> デフォルトのext4ではLVM（ブロックベース）が選択できるとのことで、コンテナはLVM-Thinが使いやすいようです。zfsはファイルとブロックベースとが利用できます。上記の内容を踏まえてご自身の利用に沿ったファイルシステムを選択します。</p><ol start="5"><li>場所とタイムゾーンを指定します。</li><li>rootでログインするパスワードとメールアドレスを指定します。</li><li>ネットワークの情報です。サーバーですので固定IPアドレスを振ることをお勧めします。複数のNICがある場合はメインのNICのMACアドレスを選択します。</li></ol> <img src="/new-technology/2024/02/17/ProxmoxVE/proxmox4.png" class="" width="1024" title="alt"><ol start="8"><li>最後に確認画面が表示されて<mark class="label primary">Install</mark>ボタンをクリックしてインストールが始まります。</li></ol><h2 id="初期設定"><a href="#初期設定" class="headerlink" title="初期設定"></a>初期設定</h2><p>まずインストール時に決めたパスワードでログインします。ここで言語設定も変更しておきます。</p><img src="/new-technology/2024/02/17/ProxmoxVE/proxmox5.png" class="" width="400" title="alt"><p>最初に「有効なサブスクリプションがありません」というダイアログが出ます。これは無償で使う場合は今後も必ず表示されます。<br>早速、「サブスクリプション無しのリポジトリ」に切り替えます。</p><p>以下の画面から左上のホスト（インストール時のホスト名）を選択し、画面中央の<mark class="label primary">リポジトリ</mark>を選択します。</p><ol><li><mark class="label primary">追加</mark>ボタンから、<mark class="label primary">No-Subscription</mark>をプルダウンから選び追加します。</li><li>右下部分の<mark class="label primary">Enterprise</mark>の文字が含まれる2つのリポジトリを<mark class="label primary">Disable</mark>ボタンをクリックして無効化します。</li></ol><img src="/new-technology/2024/02/17/ProxmoxVE/proxmox6.png" class="" width="1024" title="alt"><h2 id="任意-定期的なジョブ結果を通知するメール設定"><a href="#任意-定期的なジョブ結果を通知するメール設定" class="headerlink" title="(任意)定期的なジョブ結果を通知するメール設定"></a>(任意)定期的なジョブ結果を通知するメール設定</h2><p>以下の画面からSMTPを選択します。</p><img src="/new-technology/2024/02/17/ProxmoxVE/proxmox7.png" class="" width="1024" title="alt"><p>以下の画面で必要項目を入力しますが、簡単なのはGmailを送信者として自分宛のよく使うメアド宛に通知する方法です。</p><img src="/new-technology/2024/02/17/ProxmoxVE/proxmox8.png" class="" width="480" title="alt"><p>Googleアカウントから、<mark class="label primary">セキュリティ</mark>→<mark class="label primary">2段階認証プロセス</mark>→<mark class="label primary">アプリパスワード</mark>へと進みます。</p><p>ここで、アプリ名を入力し、作成ボタンをクリックするとパスワードが生成されます。</p><img src="/new-technology/2024/02/17/ProxmoxVE/proxmox9.png" class="" width="480" title="alt"><p>このパスワードを前述のProxmoxの通知用メール設定の送信者のパスワードとして設定します。基本的にここで設定したGmailのアカウントが発信者として、Proxmoxをインストールした時に設定したメールアドレス宛に通知が行われることになります。<br>このダイアログで設定した後は<mark class="label primary">Test</mark>ボタンで検証可能です。</p><h2 id="任意-バックアップサーバー（NFSなど）への接続"><a href="#任意-バックアップサーバー（NFSなど）への接続" class="headerlink" title="(任意)バックアップサーバー（NFSなど）への接続"></a>(任意)バックアップサーバー（NFSなど）への接続</h2><p>以下のようにメニューから外部サーバーを選択します。</p><img src="/new-technology/2024/02/17/ProxmoxVE/proxmox10.png" class="" width="640" title="alt"><p>注意点としてはサーバーのNFSのバージョンと合わせます。また<mark class="label primary">内容</mark>は<mark class="label primary">VZDumpバックアップファイル</mark>を選択します。<mark class="label primary">Export</mark>はNASなどの外部サーバーのパスを設定しますので、NASなどのマニュアルを確認して設定してください。</p><h2 id="その他"><a href="#その他" class="headerlink" title="その他"></a>その他</h2><ul><li>SSHでログインし、<code>/.ssh</code>にauthorized_keyがありますので、そこに公開鍵をAppendしておけば公開鍵認証が可能です。</li><li>あまり人にお勧めはできませんが、ProxmoxにSSHし、intel X710のファームウェアをアップデートしました（v9.4）。intelのサイトからダウンロードし、Linux用を利用しました。</li></ul><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>これでProxoxの一通りのセットアップが完了です。ネットワークはまだ見ていませんが、これはVMセットアップの時に確認をしていきます。</p><ul><li><a href="/new-technology/2024/02/19/Proxmox-new-vm/" title="ProxmoxVEのVM新規作成（Ubuntu24.04LTS）">ProxmoxVEのVM新規作成（Ubuntu24.04LTS）</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2024/02/17/ProxmoxVE/Title.png&quot; class=&quot;&quot; title=&quot;alt&quot;&gt;

&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;

&lt;p&gt;個人ユーザーでも手軽に始められる仮想環境のProxmox VE8.1のインストールを行います。セットアップは非常に簡単ですが、ポイントを絞って解説していきます。&lt;/p&gt;</summary>
    
    
    
    
    <category term="proxmox" scheme="https://yoshi0808.github.io/new-technology/tags/proxmox/"/>
    
  </entry>
  
  <entry>
    <title>VMWare 無償版ESXiの提供終了について（第2報）</title>
    <link href="https://yoshi0808.github.io/new-technology/2024/02/14/EOS-Free-esxi2/"/>
    <id>https://yoshi0808.github.io/new-technology/2024/02/14/EOS-Free-esxi2/</id>
    <published>2024-02-14T05:09:13.000Z</published>
    <updated>2024-02-19T13:11:23.709Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2024/02/14/EOS-Free-esxi2/vm1.png" class="" width="1024" title="alt"><span id="more"></span><h2 id="VMWareからの告知"><a href="#VMWareからの告知" class="headerlink" title="VMWareからの告知"></a>VMWareからの告知</h2><p>2024-02-09ごろに、以下のKBが告知されました。</p><blockquote><p>End Of General Availability of the Free vSphere Hypervisor (ESXi 7.x and 8.x) (2107518)<br> <a href="https://kb.vmware.com/s/article/2107518?lang=en_us">https://kb.vmware.com/s/article/2107518?lang=en_us</a></p></blockquote><blockquote><p>要約：<br> 無償版ESXiはVMWareのWebサイトではもはや利用できません。</p></blockquote><blockquote><p>解決方法：<br> 永久ライセンスから新しいサブスクリプション製品への移行の一環として、無償版ESXiは EOGA (End of General Availability) となりました。現時点では、同等の代替製品はありません。 </p></blockquote><p>つまり、無償版ESXiのインストールモジュールはすでにダウンロードできなくなりました。<br>なお、パッチについては、VMWareのカスタマーコネクトにログインした上で、従来通り、製品パッチをダウンロードできます。2&#x2F;14 20時においてダウンロードできました。</p><img src="/new-technology/2024/02/14/EOS-Free-esxi2/cc.png" class="" width="1024" title="alt"><p>1月30日に書いた記事「<a href="/new-technology/2024/01/30/EOS-Free-esxi/" title="VMWare 無償版ESXiの提供終了について">VMWare 無償版ESXiの提供終了について</a>」では、今後もESXiを新規利用またはアップグレードされる方はISOファイルのダウンロードとライセンスの取得をお勧めしていましたが、あまりに期間も短くお役に立てなかったかもしれません。</p><p>これにはもはや抗うことはできないようです。</p><h2 id="ESXiの代替の検討"><a href="#ESXiの代替の検討" class="headerlink" title="ESXiの代替の検討"></a>ESXiの代替の検討</h2><p>既に稼働済みの無償版ESXiは定期的なオンライン認証などがあるわけではないので当面の間利用は継続できますが、有償のESXiを使うつもりでなければ、移行について検討しなければなりません。</p><h2 id="Proxmox-VE"><a href="#Proxmox-VE" class="headerlink" title="Proxmox VE"></a>Proxmox VE</h2><img src="/new-technology/2024/02/14/EOS-Free-esxi2/proxmox.png" class="" width="400" title="alt"><p>ProxmoxはLinuxユーザー、個人を中心に人気のあるプロダクトです。大学や団体の利用実績もあります。ドイツの2名の開発者からスタートした企業です。ESXiは比較的ネットワークカードやNVMeの種類を選びましたから、手軽に始められる仮想環境としてはまずはProxmoxが挙げられます。</p><blockquote><p>Proxmox Virtual Environment<br> <a href="https://www.proxmox.com/en/proxmox-virtual-environment/overview">https://www.proxmox.com/en/proxmox-virtual-environment/overview</a></p></blockquote><img src="/new-technology/2024/02/14/EOS-Free-esxi2/proxmox1.png" class="" width="1024" title="alt"><p>上記は取り急ぎproxmoxをセットアップして動作させたブラウザ画面のキャプチャです。現時点では、Ubuntu22をセットアップした程度でほとんど検証ができていません。</p><p>モニタ類も非常に見やすいです。</p><img src="/new-technology/2024/02/14/EOS-Free-esxi2/proxmox2.png" class="" width="800" title="alt"><p>Proxmoxにはバックアップサーバーという製品もありますが、Proxmox VE単独でバックアップのスケジューリングができます。これは無償版ESXiと比べて良い点です。SynologyNASのNFS4.1に接続してバックアップしています。</p><img src="/new-technology/2024/02/14/EOS-Free-esxi2/proxmox3.png" class="" width="640" title="alt"><p>通知は下記のように行われます。</p><img src="/new-technology/2024/02/14/EOS-Free-esxi2/proxmox4.png" class="" width="640" title="alt"><p>バックアップ速度は4Gbps強です。差分のバックアップ（ブロック変更のみ）は無さそうですね。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">100: 2024-02-17 14:43:09 INFO: transferred 32.00 GiB <span class="keyword">in</span> 63 seconds (520.2 MiB/s)</span><br><span class="line">100: 2024-02-17 14:43:10 INFO: archive file size: 10.06GB</span><br></pre></td></tr></table></figure><p>スナップショットもESXi同等にメモリの状態まで確保できます（ZFSファイルシステムで実行）。</p><p>少し気になる点としては無償で利用するには開発用リポジトリを使うことになり、有償のリポジトリはより安全にテストされたものが利用できる仕組みです。GUIでもモジュールは更新できますが、更新の単位は<code>apt update</code>と同様の感覚です。リモートワークなどに利用しているVMがあるのであればその点は留意する必要があります。</p><p>まだ十分な検証ができていませんが、手軽にESXiからの移行を始めるにはProxmoxの環境で検証をスタートさせるのも良いかもしれません。<br>Proxmox自体、セキュアブートでインストールでき、VMもセキュアブートの設定ができます。</p><p>設定はややLinux寄りです。結局はLinuxのコマンドをGUIにうまく形を変えているとも言えます。ESXiで慣れていると少しギャップがあります。ESXiのVMWare Remote Consoleは素晴らしい製品でしたが、そこまでは行かずとも、別ウィンドウでVNCから暗号化通信でコンソールにアクセスするなど操作性はとても良く、先進的であると感じさせます。</p><p>取り急ぎ、ProxmoxVE8.1のセットアップとVMの新規作成に関する記事を投稿しました。Proxmoxを試してみたい方は参考にしてみてください。</p><ul><li><a href="/new-technology/2024/02/17/ProxmoxVE/" title="ProxmoxVEのインストール">ProxmoxVEのインストール</a></li><li><a href="/new-technology/2024/02/19/Proxmox-new-vm/" title="ProxmoxVEのVM新規作成（Ubuntu24.04LTS）">ProxmoxVEのVM新規作成（Ubuntu24.04LTS）</a></li></ul><h2 id="XCP-ng（XEN-Orchestra）"><a href="#XCP-ng（XEN-Orchestra）" class="headerlink" title="XCP-ng（XEN Orchestra）"></a>XCP-ng（XEN Orchestra）</h2><img src="/new-technology/2024/02/14/EOS-Free-esxi2/xcpng.png" class="" width="800" title="alt"><p>新しいプロダクトではありませんが、Citrixが提供しているXen Serverから派生したオープンソースシステムでVatesという会社が提供しています。2012年にフランスで設立されています。おそらく規模は小さい会社のように見えます。こちらは企業中心、またホームラボでも利用されています。<br>仮想化という概念では素晴らしいものをXenから継承しており、本格的なHypervisorです。ProxmoxはHypervisorとも言えますが、VMが明確に独立しておらずDMAなどのメモリへのアクセスはかなり自由です。一方、XCP-NGは厳格にセパレートされておりセキュリティが高く、安定度も高い物と考えられます。その犠牲になるのは速度ですが、XEN Orchestraという有償のGUI管理ツールはわかりやすいため、ESXiユーザーはこちらの方が気にいるかもしれません。</p><blockquote><p>XCP-ng<br> <a href="https://xcp-ng.org/#easy-to-install">https://xcp-ng.org/#easy-to-install</a></p></blockquote><p>Xen OrchestraのGUIツールは有償ですが、個人が使うためのソースコードが提供されており、自身でコンパイルして利用する分には無償です。有償のプロダクトはXOA（Xen Orchestra Apliance）、ソースコードからビルドしたものはXOと呼ばれ区別されています。</p><p>Proxmoxと比べると少しグラフィカルな面は見劣りするでしょうか。</p><img src="/new-technology/2024/02/14/EOS-Free-esxi2/xo1.png" class="" width="1024" title="alt"><p>ネットワークなどは簡単にVLANを作成できて一覧として確認できるので管理しやすく思えます。</p><img src="/new-technology/2024/02/14/EOS-Free-esxi2/xo2.png" class="" width="1024" title="alt"><p>これはMellanox Connect X-3の１つのPort（ネイティブVLAN&#x3D;1）にさらに仮想のVLAN110を加えています。</p><p>こちらもバックアップはスケジューリングできます。ESXiのようにバックアップもブロック単位の差分で取得できます。<br>バックアップのメール通知は以下のような形で行われます。</p><img src="/new-technology/2024/02/14/EOS-Free-esxi2/xo3.png" class="" width="480" title="alt"><p>VMはブラウザから操作することになりますが、メニューの大きさも相まって、少し使いづらいと感じます。クライアントのVNCからXenOrchestraにSSHしてPort Forwardingすることによって暗号化した上で単独のVNCクライアントから操作できるようですが、こちらはまだ未確認です。</p><img src="/new-technology/2024/02/14/EOS-Free-esxi2/xo4.png" class="" width="1024" title="alt"><p>XCP-NG本体は特に難しいところもなくインストールができます。8.2.1はまだセキュアブートのセットアップはできません。VM自体はセキュアブートの設定ができます。また、Xen Orchestraの管理ツール自体は別ノードからアクセスする方が好ましく、最初からノード単位のフェールオーバーなどを考えて作られています。現在私のセットアップではXen OrchestraをESXiで、昔使っていたintelのPCにXCP-NGをセットアップしています。</p><p>XCP-NGの最新バージョンは現在8.2.1ですが、Ryzen環境で動作させると応答速度やネットワーク速度が遅く、Communityの情報を見ながら、古いintel core i7マシン（Intel(R) Core(TM) i7-8700 CPU @ 3.20GHz）に再インストールするなど、少し回り道してしまいました。8.3はまだベータ版ですが、そこではRyzen版の速度改善が見込めるようなのでこちらはまた少し時間を置いてから検証を開始するつもりです。なお、P-Core&#x2F;E-CoreのCPUは仮想環境でどのようにCPUが使われるのか読めないと考えられ、難しさを感じています。</p><p>XCP-NGはスナップショットやバックアップが少し古い時代を感じさせるところがあります。稼働中のVMをバックアップした後にレストアすると、OSをブートするところから始まります。つまり、メモリの内容が廃棄されてしまいます。オープンしていたファイルがどうなるのか、恐らくロールバックされるとは思いますが、検証をしっかりと行いたい箇所ではあります。</p><p>XO自体のリポジトリはGitHubにあり、かなり細かい単位でMasterブランチ（メインのソースコードの配置場所）がCommitされていきます。どこかでそれらの更新部分を取り込むには改めてXOのソースコードのコンパイルから必要になります。但し、これは簡単なスクリプトで手間をかけずに対処可能です。</p><p>私がXCP-NGに期待しているのはシステムの安定度です。ESXiも本当に安定していて、これまでハードウェアの故障以外でハングしたりすることは全くありませんでした。また、Xen Orchestraは、企業で数十台の仮想サーバを管理することを想定して作られており、管理のしやすさを感じます。</p><p>Proxmox、XCP-NGともに良いプロダクトのようで、最終的にはどちらかの仮想環境をメインに使い、2台構成でライブマイグレーション（仮想マシンのノード間の移動）まで実現できればと考えています。</p><p>海外のホームラボのパワーユーザーはどちらかといえば、XCP-NGを好むようにも見えます。これは簡単なProxmoxは面白くないということなのかもしれません。ESXiの代替としてはXCP-NGが今脚光を浴びているように見えます。</p><p>XCP-NG、Xen Orchestraへの理解を深めるには、ローレンスシステムズのTom氏が解説しているYouTubeビデオがわかりやすいと思います。</p><blockquote><p>Understanding How The XCP-NG &amp; Xen Orchestra Open Source Virtualization Platform Works<br> <a href="https://www.youtube.com/watch?v=CEUFHudLO1g&t=447s">https://www.youtube.com/watch?v=CEUFHudLO1g&amp;t=447s</a></p></blockquote><p>今後、Xen Orchestraのセットアップ手順などを整理していきたいと考えています。手持ちの予備マシンをProxmoxで使ってしまったのでマシン調達から始めますのでしばらく時間がかかりそうです。</p>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2024/02/14/EOS-Free-esxi2/vm1.png&quot; class=&quot;&quot; width=&quot;1024&quot; title=&quot;alt&quot;&gt;</summary>
    
    
    
    
    <category term="ESXi" scheme="https://yoshi0808.github.io/new-technology/tags/ESXi/"/>
    
  </entry>
  
  <entry>
    <title>VMWare 無償版ESXiの提供終了について</title>
    <link href="https://yoshi0808.github.io/new-technology/2024/01/30/EOS-Free-esxi/"/>
    <id>https://yoshi0808.github.io/new-technology/2024/01/30/EOS-Free-esxi/</id>
    <published>2024-01-30T02:00:00.000Z</published>
    <updated>2024-03-04T11:58:19.235Z</updated>
    
    <content type="html"><![CDATA[<h2 id="VMWare製品の買い切りモデルからサブスクリプションモデルへの移行"><a href="#VMWare製品の買い切りモデルからサブスクリプションモデルへの移行" class="headerlink" title="VMWare製品の買い切りモデルからサブスクリプションモデルへの移行"></a>VMWare製品の買い切りモデルからサブスクリプションモデルへの移行</h2><p>VMWareのKBで以下のタイトルの文書が2024&#x2F;1&#x2F;22に公開されています。</p><blockquote><p>VMware End Of Availability of Perpetual Licensing and SaaS Services (96168)<br> <a href="https://kb.vmware.com/s/article/96168?lang=en_US">https://kb.vmware.com/s/article/96168?lang=en_US</a></p></blockquote><p>最終報については、「<a href="/new-technology/2024/03/04/EOS-Free-esxi3/" title="VMWare 無償版ESXiの提供終了について（最終報）">VMWare 無償版ESXiの提供終了について（最終報）</a>」を参照してください。</p><span id="more"></span><p>VMWareはスタンドアロン製品の提供を終了し、サブスクリプションモデルに変更されるとのこと。無償版ESXiは対象外ではという期待もありましたが、上記のKBを補足する形のブログとして以下が公開されています。</p><blockquote><p>VMware End Of Availability of Perpetual Licensing and SaaS Services (VMWare Blog)<br> <a href="https://blogs.vmware.com/cloud-foundation/2024/01/22/vmware-end-of-availability-of-perpetual-licensing-and-saas-services/">https://blogs.vmware.com/cloud-foundation/2024/01/22/vmware-end-of-availability-of-perpetual-licensing-and-saas-services/</a></p></blockquote><p>このページではサブスクリプションへの移行可否を判断可能なプロダクト一覧があります。残念ながら、表の中の移行対象外プロダクトとして、「VMware vSphere Hypervisor (free edition)」の記載があります。</p><p>そもそもの発表は2023年12月11日の発表に遡ります。</p><blockquote><p>VMware by Broadcom、製品ラインアップとライセンス モデルを大幅に簡素化<br> <a href="https://news.vmware.com/company/vmware-by-broadcom-business-transformation">https://news.vmware.com/company/vmware-by-broadcom-business-transformation</a></p></blockquote><p> 正式にサブスクリプションモデルに移行する事が発表された後の製品の明確化という事ですが、ソフトウェアのダウンロード自体はいつ出来なくなっても不思議ではない状態となっています。一方、昨年末の発表でも改めて触れられていますが、すぐにサポート終了というわけではなく、あらかじめ定められたサポート期限（ジェネラルサポート期限）まではパッチなども提供されるとのことです。</p><h2 id="無償版ESXiのサポート期限"><a href="#無償版ESXiのサポート期限" class="headerlink" title="無償版ESXiのサポート期限"></a>無償版ESXiのサポート期限</h2><p>無償版ESXiに関するサポート期限は以下の通りです。</p><img src="/new-technology/2024/01/30/EOS-Free-esxi/lifecycle.png" class="" width="1024" title="alt"><blockquote><p>Product Lifecycle Matrix<br> <a href="https://lifecycle.vmware.com/#/?advancedFilter=checkbox_sup&filters=%7B%22name%22:%22esxi%22,%22lifecycle_policy%22:null,%22text%22:null%7D">https://lifecycle.vmware.com/#/?advancedFilter=checkbox_sup&amp;filters=%7B%22name%22:%22esxi%22,%22lifecycle_policy%22:null,%22text%22:null%7D</a></p></blockquote><p>まず見るべきはパッチ提供が行われるGeneral Supportの期限です。ESXi7は2025&#x2F;4&#x2F;2であり、あと1年と少しです。また、ESXi8については、2027&#x2F;10&#x2F;11と3年半の猶予があります。</p><p>もちろん、今後それなりの費用を支払ってESXiを使う事も選択肢としては挙げられますが、ホームユーザーにとっては高額となるライセンス費用を払ってまでESXiに拘る方は少ないものと考えられます。</p><h2 id="現時点で考えられるアクションプラン"><a href="#現時点で考えられるアクションプラン" class="headerlink" title="現時点で考えられるアクションプラン"></a>現時点で考えられるアクションプラン</h2><p>このような状況からは以下のように考えられるでしょうか。</p><ul><li><p>新規にESXiをインストールしてみたいと考えているユーザー向け<br> 残念ながら、無償での利用終了が覆る事は無いと考えられるため新規にホームユーザーがESXiを覚えようとする事は仕事で利用する等の理由がない限りお勧めできません。</p></li><li><p>既にFree ESXiを運用しているユーザー向け</p><ol><li>代替ソフトウェアを速やかに探し、移行する</li><li>ESXi8のライフサイクルが長いプロダクトにアップグレードの上、当面は情報収集し、ESXiの運用を継続する</li></ol></li></ul><p>なお、既にESXiを運用されている方であっても、何らかのトラブルでクリーンインストールが必要となる可能性は残ります。<br>このため、以下のアクションは速やかに行っておくべきです。またアップグレードでもISOファイルは利用できます。</p><ol><li>無償版ESXi8のモジュール（ISOファイル）をダウンロードしておくこと</li><li>無償版ESXi8のライセンスを取得しておくこと</li></ol><p>詳細は、「<a href="/new-technology/2023/06/18/esxi-upgrade8/" title="VMware ESXiを8.0にアップグレードする">VMware ESXiを8.0にアップグレードする</a>」、「<a href="/new-technology/2023/07/07/building-setup-esxi8/" title="ESXi8.0をRyzen5 5600Gで構築">ESXi8.0をRyzen5 5600Gで構築</a>」の記事を参照してください。</p><h2 id="今後のアクションプラン"><a href="#今後のアクションプラン" class="headerlink" title="今後のアクションプラン"></a>今後のアクションプラン</h2><p>これは各個人によって仮想環境の利用方法や考え方やが異なりますので、コメントは難しいところですがポイントになる点を列挙してみます。</p><ul><li><p>仮想環境のバックアップを主眼にする場合<br>　私の場合はNASのソフトウェアでVMの定期バックアップを取得しており、仮想環境の一番のメリットと感じています。<br>　NASによる仮想環境のバックアップはESXiおよびHyper-V Serverが対象です。<br>　Hyper-V Server 2019も移行対象にはなりますが、既にメインストリームの終了を2024年1月に迎えており、短命と考えられます。</p><blockquote><p>Microsoft Lifecycle<br> <a href="https://learn.microsoft.com/ja-jp/lifecycle/products/hyperv-server-2019">https://learn.microsoft.com/ja-jp/lifecycle/products/hyperv-server-2019</a></p></blockquote><ul><li>今後NASのソフトウェアや他のバックアップソリューションが別の仮想環境システムに対応してくればそれが選択の候補になり得ます。</li><li>Windows Serverのライセンス購入も選択肢となりますが、やはり個人向けには高価で集約するコストメリットが無くなってしまいます。</li><li>Linuxの全体バックアップをNASで確保しつつ、LinuxのKVMで個別の仮想マシンを管理するという方法も考えられます。</li></ul></li><li><p>その他の仮想環境への移行を主眼にする場合<br> 仮想化ソフトウェアの信頼性を見極める必要があります。<br> リモートワークの一部に利用している製品であれば、信頼性（安全性、可用性）が必要ですから、仮想化ソフトウェアが期待に満たない場合はベアメタルに移行する事も必要でしょう。</p></li><li><p>コンテナへの移行など別の技術を活用する場合<br> バージョンアップなどの移行が容易であればよりリソースが少なく済む可能性はあります。最新パッチの当たったイメージが開発ベンダーから提供されるならそれ以上言うことありません。セキュリティ製品などOS単位でのソフトウェアや、VLANや仮想ネットワークなど、ネットワークが主眼である場合は、他のソリューションも視野に入れることとなります。</p></li></ul><h2 id="補足"><a href="#補足" class="headerlink" title="補足"></a>補足</h2><p>VMWareのコミュニティの中心的存在であるVMWareのWilliam氏（lamw）は、定期的なブログのポスト、Community(Flings)でのCommunity Driverなどの再整理など今年に入ってからも意欲的に活動されています。</p><blockquote><p>Wiliam Lam氏のブログ<br> <a href="https://williamlam.com/">https://williamlam.com/</a></p></blockquote><blockquote><p>VMWare Community(Flings)<br> <a href="https://communities.vmware.com/t5/Flings/ct-p/77">https://communities.vmware.com/t5/Flings/ct-p/77</a></p></blockquote><p>私個人としては当面情報収集をし、急いで他のシステムに移行する事は考えていませんが、継続して代替策は検討していきたいと考えています。</p>]]></content>
    
    
    <summary type="html">&lt;h2 id=&quot;VMWare製品の買い切りモデルからサブスクリプションモデルへの移行&quot;&gt;&lt;a href=&quot;#VMWare製品の買い切りモデルからサブスクリプションモデルへの移行&quot; class=&quot;headerlink&quot; title=&quot;VMWare製品の買い切りモデルからサブスクリプションモデルへの移行&quot;&gt;&lt;/a&gt;VMWare製品の買い切りモデルからサブスクリプションモデルへの移行&lt;/h2&gt;&lt;p&gt;VMWareのKBで以下のタイトルの文書が2024&amp;#x2F;1&amp;#x2F;22に公開されています。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;VMware End Of Availability of Perpetual Licensing and SaaS Services (96168)&lt;br&gt; &lt;a href=&quot;https://kb.vmware.com/s/article/96168?lang=en_US&quot;&gt;https://kb.vmware.com/s/article/96168?lang=en_US&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;最終報については、「&lt;a href=&quot;/new-technology/2024/03/04/EOS-Free-esxi3/&quot; title=&quot;VMWare 無償版ESXiの提供終了について（最終報）&quot;&gt;VMWare 無償版ESXiの提供終了について（最終報）&lt;/a&gt;」を参照してください。&lt;/p&gt;</summary>
    
    
    
    
    <category term="ESXi" scheme="https://yoshi0808.github.io/new-technology/tags/ESXi/"/>
    
  </entry>
  
</feed>
