<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>New technologies in our life</title>
  
  <subtitle>Device,Network,Code,etc...</subtitle>
  <link href="https://yoshi0808.github.io/new-technology/atom.xml" rel="self"/>
  
  <link href="https://yoshi0808.github.io/new-technology/"/>
  <updated>2023-05-16T12:39:00.659Z</updated>
  <id>https://yoshi0808.github.io/new-technology/</id>
  
  <author>
    <name>阿部　吉伸(Yoshinobu ABE)</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Sophos Firewall v19.5 MR-2</title>
    <link href="https://yoshi0808.github.io/new-technology/2023/05/16/xg-v195mr2/"/>
    <id>https://yoshi0808.github.io/new-technology/2023/05/16/xg-v195mr2/</id>
    <published>2023-05-16T03:00:00.000Z</published>
    <updated>2023-05-16T12:39:00.659Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2023/05/16/xg-v195mr2/title.png" class="" title="alt"><h2 id="Sophos-Firewall-v19-5-MR2"><a href="#Sophos-Firewall-v19-5-MR2" class="headerlink" title="Sophos Firewall v19.5 MR2"></a>Sophos Firewall v19.5 MR2</h2><p>Sophos Firewall v19.5 MR2が2023年5月8日に発表されました。</p><span id="more"></span><h2 id="主なエンハンスの内容"><a href="#主なエンハンスの内容" class="headerlink" title="主なエンハンスの内容"></a>主なエンハンスの内容</h2><p>MR2ではセキュリティ向上と4,000のマルチキャストグループのルーティングに対応しています。ホームユーザーにとって新機能が無いのは少し寂しいですが、安定性はv19以降でかなり向上しています。<br>WANセグメントに管理画面を開放している場合、ACLで厳格にアクセスリストを求められるようになります。部門のFirewallを想定しているのかもしれませんね。個人ではWANに管理画面を開放するようなことはありませんが。。。</p><p>v19.5 MR2の詳細な説明はRelease Notesを参照してください。</p><blockquote><p><a href="https://docs.sophos.com/releasenotes/index.html?productGroupID=nsg&amp;productID=xg&amp;versionID=19.5">https://docs.sophos.com/releasenotes/index.html?productGroupID=nsg&amp;productID=xg&amp;versionID=19.5</a></p></blockquote><h2 id="Sophos-Firewallのアップデート"><a href="#Sophos-Firewallのアップデート" class="headerlink" title="Sophos Firewallのアップデート"></a>Sophos Firewallのアップデート</h2><p>XGの管理画面にログイン後、左ペインメニューの<mark class="label primary">バックアップ＆ファームウェア</mark>の<mark class="label primary">ファームウェアの確認</mark>に通知が来る場合があります。</p><img src="/new-technology/2023/05/16/xg-v195mr2/notice.png" class="" width="480" title="alt"><p>また、アップデートの案内が来ていなくても、MySophosにログインし、バージョンアップの差分モジュールをダウンロードします。</p><ol><li>Sophosのサイトの上部の「ソフォスについて」のプルダウンメニューから、<mark class="label primary">ライセンスとアカウント</mark>をクリックします。<blockquote><p><a href="https://www.sophos.com/ja-jp.aspx">https://www.sophos.com/ja-jp.aspx</a></p></blockquote></li><li>Sophos IDをお持ちでなければIDを作成します。</li><li>ログイン後、<mark class="label primary">Network Protection</mark>をクリックします。</li><li><mark class="label primary">Firmware Updates</mark>をクリックします。</li><li>「製品名&#x2F;OSを使った検索」で”Firewall”を選択し、その後現れるプルダウンは”Software”を選択します。</li><li><mark class="label primary">Show Available Downloads</mark>ボタンをクリックします。</li></ol><img src="/new-technology/2023/05/16/xg-v195mr2/mysophos.png" class="" width="800" title="alt"><ol><li>上記画面で”SW-19.5.2_MR-3.SFW-624.sig”というアップデータが表示されますのでダウンロードします。</li><li>MY Sophosはここで終了してXGの管理画面にログインし、左ペインメニューの<mark class="label primary">バックアップ＆ファームウェア</mark>の<mark class="label primary">ファームウェアのタブメニュー</mark>から以下の画面に赤丸で囲った矢印のアイコンをクリックし、ダウンロードしたモジュールをアップロードします。</li></ol><img src="/new-technology/2023/05/16/xg-v195mr2/verup.png" class="" width="800" title="alt"><p>アップロード＆再起動ボタンをクリックし、v19.5 MR2へのアップグレードを完了させます。</p><img src="/new-technology/2023/05/16/xg-v195mr2/upgrade.png" class="" width="800" title="alt"><div class="note info"><p>仮想環境（ESXi）上にFirewallをインストールされている方はアップグレードの前に、「<a href="/new-technology/2020/10/11/esxi-backup/" title="VMware ESXiの仮想マシンをバックアップする">VMware ESXiの仮想マシンをバックアップする</a>」を参考に、バックアップを確保される事をお勧めします。</p></div>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2023/05/16/xg-v195mr2/title.png&quot; class=&quot;&quot; title=&quot;alt&quot;&gt;

&lt;h2 id=&quot;Sophos-Firewall-v19-5-MR2&quot;&gt;&lt;a href=&quot;#Sophos-Firewall-v19-5-MR2&quot; class=&quot;headerlink&quot; title=&quot;Sophos Firewall v19.5 MR2&quot;&gt;&lt;/a&gt;Sophos Firewall v19.5 MR2&lt;/h2&gt;&lt;p&gt;Sophos Firewall v19.5 MR2が2023年5月8日に発表されました。&lt;/p&gt;</summary>
    
    
    
    <category term="Security" scheme="https://yoshi0808.github.io/new-technology/categories/Security/"/>
    
    
    <category term="XG Firewall" scheme="https://yoshi0808.github.io/new-technology/tags/XG-Firewall/"/>
    
  </entry>
  
  <entry>
    <title>L2ネットワークとESXi</title>
    <link href="https://yoshi0808.github.io/new-technology/2023/04/29/l2-esxi/"/>
    <id>https://yoshi0808.github.io/new-technology/2023/04/29/l2-esxi/</id>
    <published>2023-04-28T15:00:00.000Z</published>
    <updated>2023-04-28T23:27:23.360Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2023/04/29/l2-esxi/title.png" class="" title="alt"><p class="onepoint">この記事で実現すること</p><p>ネットワークの教本といえば、TCP&#x2F;IP、つまりレイヤ3が中心の解説が中心です。ここでは、普段なかなか目にすることのないL2ネットワークの基礎、 ESXiにおけるネットワークの設定について説明するものです。</p><span id="more"></span><h2 id="L2ネットワークとIPアドレス"><a href="#L2ネットワークとIPアドレス" class="headerlink" title="L2ネットワークとIPアドレス"></a>L2ネットワークとIPアドレス</h2><p>個人向けのWi-Fiルーターなどを使い、PCやスマホ、またはNASや仮想環境などを使うようになれば、IPアドレスやDHCP、そして個々の端末が保有するMACアドレスというところは良く目にすることでしょう。Wi-Fiルーターと無線接続する端末だけだと、なかなかL2レイヤは気にすることは無いかもしれません。ネットワークを高度化して、ESXiなどの仮想環境を使い始めると、L2レイヤの知識が必要となってきます。何となくは理解して仮想環境を使われている方が多いかと思いますが、L2スイッチとVLAN、スタンドアロン（無償版）ESXiのvSwitchなどの具体的な設定などを確認していきます。</p><h2 id="スイッチングハブ"><a href="#スイッチングハブ" class="headerlink" title="スイッチングハブ"></a>スイッチングハブ</h2><p>個人向けに販売されているスイッチングハブといえば、一般的にL2スイッチを指します。TCP&#x2F;IPのルーティングができるL3スイッチもありますが、高額です。L2スイッチも大まかには2種類あり、VLANの設定ができるタイプと、設定が出来ないタイプとの2種類あります。スイッチングハブのネーミングの理由としては、指定されたMACアドレスがあるポートにのみデータを転送する機能を持つものです。昔のハブは電気的に全てのポートにデータを送っており、さらに半二重通信（片方が送信している時は相手側は送信できない。Wi-Fiと同様）でしたが、今のスイッチングハブといえば、全二重で双方向通信が可能であり、複数端末の同時通信でデータ送受信の競合がないようになっています（半二重通信ができる製品もあります）。スイッチングハブではない昔ながらのハブはダムハブやリピーターハブと呼ばれましたが昨今ではむしろその製品を探すのが難しくなっています（ダムハブは隣の端末の通信を傍受できるのでパケットキャプチャとしての使い道はあります）。</p><p>スイッチングハブをタイプ別と特徴で示すと以下の通りです。</p><table><thead><tr><th>タイプ</th><th>説明</th><th>特徴</th></tr></thead><tbody><tr><td>アンマネージ</td><td>電源OnしてLANケーブルを繋いですぐに使える製品。設定画面などは一切ない。</td><td>安価</td></tr><tr><td>スマートスイッチ</td><td>管理画面があり、VLAN、MACアドレスフィルタやパケットの優先度設定などが可能</td><td>個人向けには少ない</td></tr><tr><td>マネージド</td><td>VLAN、高度な管理（SNMP、Portミラーリング、コマンドライン）</td><td>やや高額。L2スイッチではスマートスイッチとマネージドとの区別が付けづらくなってきている</td></tr><tr><td>L3スイッチ</td><td>DHCP機能、ネットワークアドレスを分離し、ルーティングが可能。マネージドスイッチの扱い。</td><td>高額。ネットワークの知識が必要な難解なコマンドライン中心の製品が多い。</td></tr></tbody></table><p>ホームユーザーとしては、こういった情報よりも、10GbEとか2.5GbEなどのポートの速度を優先したり、発熱を気にしてファンレスか否か、ファンがどれだけ静かなのかをポイントにしてスイッチングハブを購入されていることでしょう。単にネットを使うだけであればそれで充分で、普段はL2ネットワークの事を気にする必要はありません。</p><p>リモートワークで家の機器と会社の機器とを分離したい場合、一般的にWi-Fiルーターではゲスト用ネットワーク（ゲスト用SSID）があるので、昔ほどVLANを必要としなくなっています。こういった単にネットを使うだけで何も管理できないスイッチをアンマネージスイッチと呼びます。</p><h3 id="スイッチング能力"><a href="#スイッチング能力" class="headerlink" title="スイッチング能力"></a>スイッチング能力</h3><p>スイッチの性能の一つにスイッチング能力、別名、スイッチングファブリックというものがあります。比較サイトでも必ずスペックとして出ているものですが、この数値は、基本的に全てのポートが全二重でブロッキングせずにデータを送信できるものとして計算された数値となっています。8Portで全て10GbEなら以下の通りです。</p><ul><li>10Gbps×8(Port)×2（全二重）&#x3D; 160Gbps</li></ul><p>10GbEが4Port、1GbEが8Portの製品なら、96Gbpsという具合です。ですので、製品を比較して「こちらのハブのスループットが高そうだ」という事にはなりません。</p><h3 id="スマートスイッチ・マネージドスイッチ"><a href="#スマートスイッチ・マネージドスイッチ" class="headerlink" title="スマートスイッチ・マネージドスイッチ"></a>スマートスイッチ・マネージドスイッチ</h3><p>全く管理画面が無いL2スイッチはIPアドレスを持ちませんが、スマートスイッチ・マネージドスイッチと呼ばれている製品はIPアドレスを持ちます。この”スマート”や”マネージド”というネーミングも実は明確な定義はありません。各社によって呼び名が少しづつ異なっており、はっきり言えばマーケティング用語です。Webの管理画面があってもVLANが無いL2スイッチもあります。</p><p>IPアドレスを持っているとはいえ、スイッチ経由で通信をする際に、ルーターのようにスイッチのIPアドレスを経由する訳ではありません。以下のように見えないPort0番にAmazon Fire Stickをさらに小さくしたような組み込み機器で独立したOSが接続されていて、そこに最低限のネットワーク通信と管理のためのOSの機能を持っていると考えてください。スイッチングハブとしてパケットを転送している機能はハードウェアであるASIC(Application Specific Integrated Circuit)が担っており、この小さな機器は殆ど使われません。最近のWi-Fi機器もこういった形になっており、管理画面の遷移が遅いからといって転送能力が劣っているという訳でもありません。PCなどからスイッチへのpingを打つと、このPort0番に着信して応答を返す仕組みになります（pingの応答速度も一般的に遅いです）。</p><img src="/new-technology/2023/04/29/l2-esxi/sw3.drawio.png" class="" width="360" title="alt"><p>日本では、全くITの知識が無い人向けに分かりやすくスイッチを提供するという事が主眼に置かれているため、アンマネージスイッチが主力製品として販売されていますが、値段なりの品質です。仮想環境やNASなど24時間の運用を前提で考えるのであれば、スイッチにもそれなりの品質を求めるべきです。アンマネージで不具合が出ると回収するしかありません。ファームウェアの更新ができるもの、かつ、きちんと定期的にアップデートが行われている製品を選定されることをお勧めします。</p><h3 id="L2ネットワークとMACアドレス"><a href="#L2ネットワークとMACアドレス" class="headerlink" title="L2ネットワークとMACアドレス"></a>L2ネットワークとMACアドレス</h3><p>L2スイッチはMACアドレスを宛先として判断し、パケットを目的のポートに転送します。この世界ではIPアドレスはデータの中身として扱われ、宛先として使われることはありません。例えば、以下のPCとL2スイッチとの関係で確認してみます。</p><img src="/new-technology/2023/04/29/l2-esxi/net1.drawio.png" class="" width="640" title="alt"><p>PC1からPC2にpingを打つこととします。</p><pre class="mermaid">sequenceDiagramparticipant pc1 as PC1participant sw as SWitchparticipant pc2 as PC2Note over pc1: 1.PC2へのpingコマンド投入pc1 -&gt;&gt; sw : 2.ARP Request(PC2)をブロードキャストNote over sw: 3.PC1のMACを自己学習sw -&gt;&gt; pc2 : 4.ARP Requestをブロードキャストpc2 --&gt;&gt; sw : 5.ARP Reply(PC2のMAC)Note over sw: 6.PC2のMACを自己学習sw --&gt;&gt; pc1 : 7.ARP Reply(PC2のMAC)pc1 -&gt;&gt; sw : 8.ICMP Echo Requestsw -&gt;&gt; pc2 : 9.ICMP Echo Requestpc2 --&gt;&gt; sw : 10.ICMP Echo Replysw --&gt;&gt; pc1 : 11.ICMP Echo ReplyNote over pc1: 12.ping応答</pre><p>このシーケンスの実行の結果は以下の通りです。</p><p>PC1のarpテーブルは以下になります(Windowsでの実行を想定)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\yoshi&gt;arp -a</span><br><span class="line"></span><br><span class="line">インターフェイス: 192.168.100.129 --- 0x10</span><br><span class="line"> インターネット アドレス 物理アドレス           種類</span><br><span class="line">  192.168.100.161       04-69-f8-aa-bb-cc      動的</span><br><span class="line">  255.255.255.255       ff-ff-ff-ff-ff-ff     静的</span><br></pre></td></tr></table></figure><p>PC2のARPテーブルは以下になります(macOSでの実行を想定)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ arp -a</span><br><span class="line">? (192.168.100.129) at 30:59:b7:00:11::22 on en0 ifscope [ethernet]</span><br></pre></td></tr></table></figure><p>そして、スイッチ上のMACアドレステーブルは、MACアドレスと接続されているPortの組み合わせが登録されています（ここではUbiquiti社のPro Aggregationスイッチを使っています。各社、機種毎に取得方法は異なります）。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(UBNT) &gt;show mac-addr-table</span><br><span class="line"></span><br><span class="line">VLAN ID  MAC Address         Interface              IfIndex  Status</span><br><span class="line">-------  ------------------  ---------------------  -------  ------------</span><br><span class="line">1        30:59:B7:00:11:22   0/1                    1        Learned</span><br><span class="line">1        04:69:F8:AA:BB:CC   0/28                   28       Learned</span><br></pre></td></tr></table></figure><p>VLANはデフォルトVLANが1の製品が大半です。MACアドレステーブルにはVLANのIDが必要ですが、詳細説明は割愛します（機種により実装の違いがあります）。</p><p>さて、このようにして、PC同士はL3レイヤ（IPアドレス）からL2レイヤ（MACアドレス）への変換の情報をお互いに持ち、スイッチはMACアドレスとそれがどのPortに接続されているかを管理しています。</p><p>スイッチ自身に管理画面がないと、スイッチの中身がどうなっているか分からないんですが、アンマネージスイッチでは管理IPアドレスを持たないだけで、しっかりとMACアドレステーブルの管理は行われています。</p><p>ちなみに、MACアドレスは6バイトでコロン区切りかハイフン区切りとなっています。先頭の3バイトがVendorIDとなっていて、上記の例だと、<code>30:59:B7</code>はMicrosoft社であり、<code>04:69:F8</code>はApple社になります。</p><p>ご自身のPCでも<code>arp -a</code>を実行してみてください。LANにあるさまざまな端末のIPアドレスとMACアドレスの一覧が確認できるはずです。</p><blockquote><p>Ubiquiti Switch Pro Aggregation<br> <a href="https://jp.store.ui.com/collections/unifi-network-switching/products/unifi-switch-aggregation-pro">https://jp.store.ui.com/collections/unifi-network-switching/products/unifi-switch-aggregation-pro</a></p></blockquote><h2 id="ESXiのL2ネットワーク"><a href="#ESXiのL2ネットワーク" class="headerlink" title="ESXiのL2ネットワーク"></a>ESXiのL2ネットワーク</h2><p>ここではVSphere Hypervisor（無償版ESXi）についての説明になります。ESXiは仮想環境として端末を動作させる機能とvSwitchという仮想ネットワークスイッチの機能を持っています。実際は1つのネットワークカードに対して、複数の仮想マシンを動作させることが可能となっています。</p><h3 id="仮想マシンのNIC"><a href="#仮想マシンのNIC" class="headerlink" title="仮想マシンのNIC"></a>仮想マシンのNIC</h3><p>仮想マシンの構成としての一例を挙げます。</p><img src="/new-technology/2023/04/29/l2-esxi/vm1.png" class="" width="1024" title="alt"><p>この仮想マシンはUbuntuで、1つの仮想ネットワークアダプタを持っています。最もシンプルな構成です。MACアドレスの先頭3バイトは<code>00:0c:29</code>となっており、これはVMwareのVenderIDです。下位3バイトは仮想マシンの構成時に自動的に振られます。</p><p>続いて、仮想ネットワークスイッチの説明です。</p><img src="/new-technology/2023/04/29/l2-esxi/vsw1.png" class="" width="1024" title="alt"><p>この例では仮想スイッチ1つに物理アダプタを1つ加えています。ESXi本体のハードウェアに付属するネットワークカードが物理アダプタです。</p><img src="/new-technology/2023/04/29/l2-esxi/vsw2.png" class="" width="640" title="alt"><p>この物理アダプタには当然ですが物理MACアドレスがあります。仮想ネットワークアダプタに到達するためには、この物理アダプタを経由する必要があります。しかし、ESXiのネットワークドライバのレベルで仮想ネットワークアダプタがNICの物理デバイスと接続されており、物理ネットワークアダプタ<code>80:61:5f:xx:xx:xx</code>は使わず、仮想MACアドレス<code>00:0c:29:4f:2e:05</code>が仮想マシンに接続されています。<code>80:61:5f:xx:xx:xx</code>は使われていないと書きましたが、ESXiを構成すると、vmnic0の物理MACアドレスはESXiのVMKernelのvmk0に使われるようになっています。ESXiの世界ではネットワークの障害時の切り替えなども考慮し、物理MACアドレスはあまり重要ではありません。</p><p>過去の技術ですが、物理MACアドレスがデータを受け取って仮想MACアドレスに変換して受け渡す、いわゆるNATの技術も実際には存在します。しかし、今のESXiでは物理NICから実際の仮想MACアドレスのデータが流れていきます。</p><p>一例として、私の保有しているスイッチでPort19のESXiの物理NICとESXiの仮想MACアドレステーブルを表示させると以下のようになっています。<br>（物理MACアドレスの値と一部のVLANの値は修正しています）<br>前述したように、先頭３バイトが<code>00:0C:29</code>のものが仮想マシンです。</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(UBNT) <span class="comment">#show mac-addr-table | include Interface|00:0C:29|80:61:5F</span></span><br><span class="line"></span><br><span class="line">VLAN ID  MAC Address         Interface              IfIndex  Status</span><br><span class="line">200      00:0C:29:4F:2E:05   0/19                   19       Learned</span><br><span class="line">200      00:0C:29:C8:1F:97   0/19                   19       Learned</span><br><span class="line">200      80:61:5F:00:00:03   0/19                   19       Learned</span><br></pre></td></tr></table></figure><p>VLAN200の２つの仮想マシンが存在している事が分かります、スイッチはこのようにして仮想マシンのMACアドレス１つ１つを管理し、適切なスイッチポートに転送していることがわかります。</p><p>ちなみに物理スイッチを多段接続した場合にも、1つのポートから先のスイッチ経由で複数の端末が接続されていれば同様に1つのポートに複数の端末のMACアドレスがテーブルに管理されます。</p><h3 id="vSwitch"><a href="#vSwitch" class="headerlink" title="vSwitch"></a>vSwitch</h3><p>vSwitchでは物理NICを経由して仮想マシンと接続するためのポートグループが必要です。仮想マシンにネットワークアダプタを加える時にはこのポートグループが必要です。ESXiのセットアップ完了後は、<mark class="label primary">vSwitch0</mark>  がデフォルトのvSwitchとして作成されており、ポートグループとして、<mark class="label primary">Management Network</mark>および<mark class="label primary">VM Network</mark>の2つが作成されています。</p><img src="/new-technology/2023/04/29/l2-esxi/vsw3.png" class="" width="480" title="alt"><mark class="label primary">Management Network</mark>は、ESXiのWebにログインしたり制御のためのポートグループです。このグループの中にデフォルトで<mark class="label primary">VMKernel NIC</mark>として<mark class="label primary">vmk0</mark>が自動作成されています。VMKernel NICはESXiのWebサービスを始めとする管理系のサービス提供のためのIPアドレスを持ちます。前述したL2スイッチの説明ではPort0として小さな組み込み機器としてOSが稼働していると表現しましたが、それと目的は同じです。VMKernelはvSwitchを制御するというよりは、ネットワークセグメント単位に持ち、ESXiを管理するためのIPアドレスとなります。<mark class="label primary">VM Network</mark>もポートグループです。仮想マシンが何もない初期状態では特に仮想IPアドレスも保有していません。仮想マシンを作成し、ネットワークアダプタを追加する際に、この<mark class="label primary">VM Network</mark>を選択することになります。そうすると自動的に仮想IPアドレスが振られます。もちろん、新規にポートグループを作成し、仮想マシンにネットワークアダプタを追加する事もできます。また、ポートグループという”グループ”の意味としては、複数の仮想マシンを同一のポートグループに追加できます。この際、MACアドレスが同じになったりはしません。<div class="note info"><p>ポートグループ1つで複数の仮想NICと接続できます。仮想マシン作成時、仮想MACアドレスは自動的に割り当てられます。物理NICを2つ以上保有する場合、障害対策と負荷分散ができます。負荷分散の際、ESXiのデフォルトでは、ポートグループ単位に複数の物理NICを使い負荷分散をします。</p></div><div class="note info"><p><mark class="label primary">Management Network</mark>と<mark class="label primary">VM Network</mark>のポートグループが分かれているのは、本来、マネジメントネットワークとクライアントやサーバーがある仮想マシンのネットワークとは分離すべきという考えに基づいています。</p></div><p>なお、仮想マシンをバックアップから戻した場合には、既存の仮想マシンと同一のMACアドレスで復元してしまうと通信が正しく行えなくなります。従って、仮想マシンの復元後、初期起動時には以下のダイアログが表示され、<mark class="label primary">コピーしました</mark>を選択すると、新しい仮想MACアドレスが割り当てられます。</p><img src="/new-technology/2023/04/29/l2-esxi/esxi3.png" class="" width="640" title="alt"><h4 id="特殊な設定"><a href="#特殊な設定" class="headerlink" title="特殊な設定"></a>特殊な設定</h4><p>vSwitchには以下の2つの特殊な仮想マシンのための追加設定ができます。</p><img src="/new-technology/2023/04/29/l2-esxi/vsw4.png" class="" width="480" title="alt"><ul><li><mark class="label primary">無差別モードを許可</mark><p> ファイアウォールやIPS&#x2F;IDS（Intrusion Prevention System&#x2F;Intrusion Detection System）などセキュリティ製品におけるブリッジモードのように、同一LAN内でパケットの検証をする際にはこれを<mark class="label primary">はい</mark>に変更します。セキュリティ製品の先に接続されている端末も同一のL2ネットワークとして全てパケットを転送してあげる動作です。自分宛のMACアドレスでなくとも受け取る挙動であり、仮想マシンはダムハブに見えるわけです。また、仮想マシンのネットワークキャプチャを行う場合に使えます。</p></li><li><mark class="label primary">偽装転送を許可/MAC変更を許可</mark><p> 上記と同じようにセキュリティ製品（ゲートウェイ）がバックヤードにある端末のパケットを相互にやりとりするわけですから、自分自身のMACアドレスではないMACアドレスを持ったデータを送信する事になります。一般的にはセキュリティ上認めていないものですが、セキュリティ製品では<mark class="label primary">MAC変更を許可</mark>を<mark class="label primary">はい</mark>を、<mark class="label primary">偽装転送を許可</mark>を<mark class="label primary">はい</mark>にします。</p></li></ul><p>これらはいずれもセキュリティ強化のためにデフォルトでは<mark class="label primary">いいえ</mark>になっています。<br>これらの機能の詳細はVMwareの以下のドキュメントを参照してください。</p><blockquote><p>vSphere 標準スイッチのセキュリティ強化<br> <a href="https://docs.vmware.com/jp/VMware-vSphere/7.0/com.vmware.vsphere.security.doc/GUID-3507432E-AFEA-4B6B-B404-17A020575358.html">https://docs.vmware.com/jp/VMware-vSphere/7.0/com.vmware.vsphere.security.doc/GUID-3507432E-AFEA-4B6B-B404-17A020575358.html</a></p></blockquote><h2 id="ESXiのVLAN"><a href="#ESXiのVLAN" class="headerlink" title="ESXiのVLAN"></a>ESXiのVLAN</h2><p>無償版ESXiではVLAN設定が可能です。<br>ESXiにおけるデフォルトVLAN（タグ無し）はVLAN ID＝0となります。通常のスイッチはVLAND ID＝1のものが多いのですが、基本的にタグ無し同士の通信であれば問題になりません。デフォルトVLANを変更し、さらにそれをネイティブVLAN（タグ無し）にする時は少し考える必要がありますが、ホームユーザー向けではそこまで考えることも無いでしょう。</p><table><thead><tr><th>ESXiのVLANのタイプ</th><th>説明</th></tr></thead><tbody><tr><td>EST</td><td>通常のタグ無し。物理スイッチのアクセスポートに接続する場合でスイッチ側でタグが外される事を期待。</td></tr><tr><td>VST</td><td>タグ付き（1〜4094）。物理スイッチからタグ付きで接続する場合。</td></tr><tr><td>VGT</td><td>タグ付き（4095）。仮想マシンに複数のタグ付きパケットを流す場合</td></tr></tbody></table><p>3種類それぞれのネーミングがあります。</p><p>EST（タグ無し）はVLANを意識しないモードです。<br>タグ無しでvSwitchのポートグループに渡されることを期待している設定です。物理スイッチがアクセスポートの場合は、タグが外されるのでvSwtichおよびポートグループでは特に何もしませんし、仮想マシンでも何も意識しません。</p><p>VSTは、VLAN IDをポートグループに設定します。<br>例えば、ESXiのマネジメントネットワークはタグ無し、仮想マシンはユーザー側ネットワークとする場合にvSwitchで2つのセグメントのデータを受け入れ、VMKernelはタグ無しのまま、仮想マシンはポートグループでIDに200を指定します。この場合はVLAN200について、vSwitchでタグが外され仮想マシンにパケットが届きますので仮想マシンでVLANの意識はしません。</p><p>VGTは物理スイッチにおけるトランクポートの役割と同等です。ポートグループに4095を設定します。仮想マシン自身がタグVLANを解釈できる場合に複数のVLANのタグ付きパケットを流し、仮想マシン側でタグを外すような使い方となります。また、VSTではESXiの仕様として1〜4094とありますが、一般的にタグありのVLANは2〜1005の間で作成しますし、個人向け環境のVLANはネットワークアドレスの第3オクテットの数字と合わせるのが無難です。<code>192.168.xxx.0/24</code><br>全てのVLANデータが流れて不要なものは仮想マシン側で破棄する事になるので負荷が高くなりやすく、物理スイッチからは必要なVLANのみのデータを流すことが求められます。</p><img src="/new-technology/2023/04/29/l2-esxi/vsw3.png" class="" width="480" title="alt"><p>VSTの例ですが、Win10ProのVLAN IDを300とすると、ポートグループの設定でVLANの値を明示します。</p><img src="/new-technology/2023/04/29/l2-esxi/vsw5.png" class="" width="640" title="alt"><p>このvSwitchの例で言えば、タグ300のパケットは、VGT（ID&#x3D;4095）、300と明示した2つの仮想マシンのみに転送されます。VLAN ID0のVM NetworkおよびManagement Networkにはタグ300のパケットは流れません。</p><p>このように、vmnic0に接続されたvSwitchネットワークはvmk0のIPネットワークが<code>192.168.1.0/24</code>だとすれば、全ての仮想マシンが<code>192.168.1.0/24</code>のIPアドレスを持つのがシンプルな構成ですが、このようにタグVLANを組み合わせることで、物理NICの数が少なくても複数のVLAN、つまり複数のネットワークセグメントのデータを通すことができます。</p><p>VGTの場合は、物理スイッチ側のMACアドレステーブルは以下のようになっています。仮想マシン自体がVLANのトランクポートを扱えるため、１つのMACアドレスに複数のVLANが割り当てられている事が分かります。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">VLAN ID  MAC Address         Interface              IfIndex  Status</span><br><span class="line">1        00:0C:29:EB:B3:CC   0/15                   15       Learned</span><br><span class="line">200      00:0C:29:EB:B3:CC   0/15                   15       Learned</span><br><span class="line">300      00:0C:29:EB:B3:CC   0/15                   15       Learned</span><br><span class="line">4040     00:0C:29:EB:B3:CC   0/15                   15       Learned</span><br></pre></td></tr></table></figure><p>ESXiのVLANタグについては以下のドキュメントを参照してください。英語ですが3つのVLANについての解説ビデオもあります。</p><blockquote><p>VMware VLAN 構成<br> <a href="https://docs.vmware.com/jp/VMware-vSphere/7.0/com.vmware.vsphere.networking.doc/GUID-7225A28C-DAAB-4E90-AE8C-795A755FBE27.html?hWord=N4IghgNiBcIBwAYBMA6AjARRAXyA">https://docs.vmware.com/jp/VMware-vSphere/7.0/com.vmware.vsphere.networking.doc/GUID-7225A28C-DAAB-4E90-AE8C-795A755FBE27.html?hWord=N4IghgNiBcIBwAYBMA6AjARRAXyA</a></p></blockquote>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2023/04/29/l2-esxi/title.png&quot; class=&quot;&quot; title=&quot;alt&quot;&gt;

&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;

&lt;p&gt;ネットワークの教本といえば、TCP&amp;#x2F;IP、つまりレイヤ3が中心の解説が中心です。ここでは、普段なかなか目にすることのないL2ネットワークの基礎、 ESXiにおけるネットワークの設定について説明するものです。&lt;/p&gt;</summary>
    
    
    
    <category term="Network" scheme="https://yoshi0808.github.io/new-technology/categories/Network/"/>
    
    
    <category term="ESXi" scheme="https://yoshi0808.github.io/new-technology/tags/ESXi/"/>
    
  </entry>
  
  <entry>
    <title>Mellanox Connect XとWindows11</title>
    <link href="https://yoshi0808.github.io/new-technology/2023/03/25/Mellanox-ConnectXandWindows11/"/>
    <id>https://yoshi0808.github.io/new-technology/2023/03/25/Mellanox-ConnectXandWindows11/</id>
    <published>2023-03-24T15:00:01.000Z</published>
    <updated>2023-04-04T12:49:36.414Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2023/03/25/Mellanox-ConnectXandWindows11/title.png" class="" width="1024" title="alt"><p class="onepoint">この記事で実現すること</p><p>この記事ではSFP+のネットワークカードである、Mellanox Connect XについてWindows11の対応状況やWindowsでのファームウェアアップデートなどを記します。</p><span id="more"></span><h2 id="安価なMellanox-Connect-Xカード"><a href="#安価なMellanox-Connect-Xカード" class="headerlink" title="安価なMellanox Connect-Xカード"></a>安価なMellanox Connect-Xカード</h2><p>すでに販売終了となったConnect X-3はeBayで5,000円弱で売られています。MellanoxのConnect Xシリーズは脆弱性の指摘も見かけず、安定しているNICでしょうか。intelに比べればマイナーですが、SFP＋で安価に入手可能となっており、ホームユーザーにとっても大変ありがたい存在です。<br>Connect X-3はWindows10までのドライバはNvidiaのサイトに掲載されていますがWindows11ではドライバの存在はありません。</p><p>しかしながら、Windows11ではConnect Xを認識してWindowsとして用意されたドライバのインストールが行われ、すぐに使えます。いわゆる、Windows11に標準で付属しているinboxドライバになります。逆にNVidiaサイトにあるWindows10用のドライバはWindows11ではエラーが発生し動きません。後述のNVidiaフォーラムの投稿をご確認ください。</p><p>最近、2PortのMellanox Connect X-4 LxをeBayでちらほら見かけるようになってきました。販売終了した製品ですが、サポートはされています。</p><p><strong>MCX4121A-ACAT</strong>という型番は、<strong>Mellanox ConnectX-4 LX 25GBE SFP28 2ポートPCIeイーサネット アダプター</strong>となっており、eBayで15,000円ほどで購入できます。SFP28はSFP+とモジュール接続口の互換性があります。SFP＋のダイレクトアタッチケーブル（DAC）やOM3ケーブルと共に使うSFP+短距離マルチモードファイバ（MM SR）モジュール等の10GbE SFP+で問題なく10Gbps通信できます。もちろん25GbEとしても使えますが、PCなどホスト端末に挿して使うには他の機器との速度差が大きすぎて使いにくいものです。intel製のNICは在庫不足から回復傾向にあるようですが、まだまだ高額です。</p><p>詳しいスペックは以下のリンクを参照してください。PCIe3 x8となっています。</p><blockquote><p>Mellanox Connect X-4<br> <a href="https://network.nvidia.com/files/doc-2020/pb-connectx-4-lx-en-card.pdf">https://network.nvidia.com/files/doc-2020/pb-connectx-4-lx-en-card.pdf</a></p></blockquote><p>Connect X-3はやや個人向けの色合いが強かったですが、Connect X-4あたりからはサーバー製品としての要素が強くなっていきます。OEM版（HPE、DELL向け等）は避けることをお勧めします。これはベンダーロックインが掛かっている可能性が高く、ファームウェアの強制書き込みなどが必要になります。また、それでうまくいく保証もありません。また、Connect X-4はいろいろなホストインタフェースがありますので、Ethernet、PCIeというところに気をつけてください。PCIeスロットに挿すだけですぐにWindows11で使えるMCX4121A-ACATはお勧めです。</p><p>2Portも要らないといっても、eBayでは意外と1Portものが出ていません。また、他カードとの兼ね合い（x16が埋まっている）でPCIe x4までという方は一般論としてConnect X-3（MCX311A-XCAT）が向いています。</p><blockquote><p>Nvidia ConnectX-4 Lx 製品概要<br> <a href="https://www.nvidia.com/ja-jp/networking/ethernet/connectx-4-lx/">https://www.nvidia.com/ja-jp/networking/ethernet/connectx-4-lx/</a></p></blockquote><blockquote><p>NVidiaフォーラムでConnect X-3のWin11のドライバが無いことをNVidiaのテクニカルサポートが示唆<br> <a href="https://forums.developer.nvidia.com/t/connectx-3-cx311a-xcat-for-win11-crashed/205962">https://forums.developer.nvidia.com/t/connectx-3-cx311a-xcat-for-win11-crashed/205962</a></p></blockquote><h2 id="Windows11でのデバイスドライバ"><a href="#Windows11でのデバイスドライバ" class="headerlink" title="Windows11でのデバイスドライバ"></a>Windows11でのデバイスドライバ</h2><h3 id="Connect-X-3"><a href="#Connect-X-3" class="headerlink" title="Connect X-3"></a>Connect X-3</h3><p>Connect X-3をPCIeにセットしてWin11を起動します。デバイスドライバを見てみます。</p><img src="/new-technology/2023/03/25/Mellanox-ConnectXandWindows11/x3.png" class="" width="480" title="alt"><p>2019年のinboxドライバが自動的に取り込まれます。このドライバに脆弱性が出てしまえば、リスクがあり別の製品に買い替えが必要となりますが、脆弱性データベースでもなかなかMellanoxの名前を見ることはありません。</p><p>お約束ですが、ESXi上のUbuntuとのiperf3を実行してみます。MTUは1,500のデフォルト、スイッチはフローコントロールをオンにしています。<br>多重度3でUbuntuからダウンロードする方向（-Rオプション）に実行して以下の通りです。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[ ID] Interval           Transfer     Bitrate         Retr</span><br><span class="line">[  5]   0.00-10.05  sec  3.81 GBytes  3.26 Gbits/sec  615             sender</span><br><span class="line">[  5]   0.00-10.00  sec  3.81 GBytes  3.27 Gbits/sec                  receiver</span><br><span class="line">[  7]   0.00-10.05  sec  3.46 GBytes  2.96 Gbits/sec  423             sender</span><br><span class="line">[  7]   0.00-10.00  sec  3.46 GBytes  2.97 Gbits/sec                  receiver</span><br><span class="line">[  9]   0.00-10.05  sec  3.79 GBytes  3.24 Gbits/sec  623             sender</span><br><span class="line">[  9]   0.00-10.00  sec  3.78 GBytes  3.25 Gbits/sec                  receiver</span><br><span class="line">[SUM]   0.00-10.05  sec  11.1 GBytes  9.45 Gbits/sec  1661             sender</span><br><span class="line">[SUM]   0.00-10.00  sec  11.1 GBytes  9.49 Gbits/sec                  receiver</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>(Ryzen 7 5700G、メモリDDR4-3200 DIMM (PC4-25600)32GByte)<br>このPCにはPCIe×16のスロットにConnect X-4を、PCIe x4のスロットにConnect X-3を挿しています。</p><p>少しリトライが多いようですが、9.49Gbpsです。<code>-R -P3</code>オプションとして逆方向の送信（ダウンロード）、多重度3のみ、それ以外のオプションは指定していません。Windows10時代でも多重度は4程度から9.3Gbpsをマークしていたと記憶しているので、まずまずでしょうか。Windows11側がダウンロード側ですのでUbuntu側の送信速度に少し追いついていないようです。これはドライバが最適化されていない可能性もあります。しかし、実運用として使うのであれば十分でしょう。</p><h3 id="Connect-X-4"><a href="#Connect-X-4" class="headerlink" title="Connect X-4"></a>Connect X-4</h3><p>Connect X-4はWindows11で自動導入されるドライバは2020年のものですが、新しいドライバをNvidiaからダウンロードできます。</p><img src="/new-technology/2023/03/25/Mellanox-ConnectXandWindows11/x4.png" class="" width="480" title="alt"><p>NVidiaではSoftwareのEthernetの分類でドライバを検索することになります。<br><a href="https://developer.nvidia.com/networking/ethernet-software">https://developer.nvidia.com/networking/ethernet-software</a></p><p>具体的には、以下のWinOF-2がWin10以降のドライバとなります。</p><blockquote><p>MLNX_OFED for Windows - WinOF &#x2F; WinOF-2<br> <a href="https://network.nvidia.com/products/adapter-software/ethernet/windows/winof-2/">https://network.nvidia.com/products/adapter-software/ethernet/windows/winof-2/</a></p></blockquote><p>Connect X-4は2023年2月2日に発表されたRevision3.20.50010が最新のようですが、実際のドライバは上記のキャプチャの通り、3.2.25がインストールされます。</p><p>セットアップはただインストーラの指示に従い、進めていくだけなので何も難しいものはありません。</p><img src="/new-technology/2023/03/25/Mellanox-ConnectXandWindows11/setup.png" class="" width="480" title="alt"><h2 id="Connect-X-4のスループット"><a href="#Connect-X-4のスループット" class="headerlink" title="Connect X-4のスループット"></a>Connect X-4のスループット</h2><p>PCのConnect X-4（SFP28スロット）にSFP＋モジュールを挿入し、対向もスイッチに挿します。</p><p>Connect X-3もConnect X-4も同じ10GbEとして使うなら変わらないように思えますが、ドライバの違いもさることながら能力は結構違います。<br>多重度1でUbuntuに対して実行した結果です。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">Connect X-4 flow control send</span><br><span class="line"></span><br><span class="line">[ ID] Interval           Transfer     Bitrate</span><br><span class="line">[  5]   0.00-1.00   sec  1.11 GBytes  9.51 Gbits/sec</span><br><span class="line">[  5]   1.00-2.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   2.00-3.00   sec  1.10 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   3.00-4.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   4.00-5.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   5.00-6.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   6.00-7.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   7.00-8.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   8.00-9.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   9.00-10.00  sec  1.10 GBytes  9.49 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[ ID] Interval           Transfer     Bitrate</span><br><span class="line">[  5]   0.00-10.00  sec  11.1 GBytes  9.49 Gbits/sec                  sender</span><br><span class="line">[  5]   0.00-10.04  sec  11.0 GBytes  9.45 Gbits/sec                  receiver</span><br><span class="line"></span><br><span class="line">Connect X-4 flow control recv</span><br><span class="line"></span><br><span class="line">[ ID] Interval           Transfer     Bitrate</span><br><span class="line">[  5]   0.00-1.00   sec  1.11 GBytes  9.51 Gbits/sec</span><br><span class="line">[  5]   1.00-2.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   2.00-3.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   3.00-4.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   4.00-5.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   5.00-6.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   6.00-7.00   sec  1.10 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   7.00-8.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   8.00-9.00   sec  1.10 GBytes  9.48 Gbits/sec</span><br><span class="line">[  5]   9.00-10.00  sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[ ID] Interval           Transfer     Bitrate         Retr</span><br><span class="line">[  5]   0.00-10.05  sec  11.1 GBytes  9.45 Gbits/sec    0             sender</span><br><span class="line">[  5]   0.00-10.00  sec  11.1 GBytes  9.49 Gbits/sec                  receiver</span><br></pre></td></tr></table></figure><p>非常に安定していますね。Windowsのiperf3のシングルプロセスでRetryが0です。<br>ちなみにこれだけ安定しているならということでスイッチのフローコントロールを外してみます。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">Connect X-4 no flow control send</span><br><span class="line"></span><br><span class="line">[ ID] Interval           Transfer     Bitrate</span><br><span class="line">[  5]   0.00-1.00   sec  1.11 GBytes  9.52 Gbits/sec</span><br><span class="line">[  5]   1.00-2.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   2.00-3.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   3.00-4.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   4.00-5.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   5.00-6.00   sec  1.10 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   6.00-7.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   7.00-8.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   8.00-9.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   9.00-10.00  sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[ ID] Interval           Transfer     Bitrate</span><br><span class="line">[  5]   0.00-10.00  sec  11.1 GBytes  9.50 Gbits/sec                  sender</span><br><span class="line">[  5]   0.00-10.04  sec  11.1 GBytes  9.45 Gbits/sec                  receiver</span><br><span class="line"></span><br><span class="line">Connect X-4 no flow control recv</span><br><span class="line"></span><br><span class="line">[ ID] Interval           Transfer     Bitrate</span><br><span class="line">[  5]   0.00-1.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class="line">[  5]   1.00-2.00   sec  1.10 GBytes  9.47 Gbits/sec</span><br><span class="line">[  5]   2.00-3.00   sec  1.10 GBytes  9.47 Gbits/sec</span><br><span class="line">[  5]   3.00-4.00   sec  1.10 GBytes  9.47 Gbits/sec</span><br><span class="line">[  5]   4.00-5.00   sec  1.10 GBytes  9.47 Gbits/sec</span><br><span class="line">[  5]   5.00-6.00   sec  1.10 GBytes  9.47 Gbits/sec</span><br><span class="line">[  5]   6.00-7.00   sec  1.10 GBytes  9.47 Gbits/sec</span><br><span class="line">[  5]   7.00-8.00   sec  1.10 GBytes  9.47 Gbits/sec</span><br><span class="line">[  5]   8.00-9.00   sec  1.10 GBytes  9.47 Gbits/sec</span><br><span class="line">[  5]   9.00-10.00  sec  1.10 GBytes  9.45 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[ ID] Interval           Transfer     Bitrate         Retr</span><br><span class="line">[  5]   0.00-10.05  sec  11.0 GBytes  9.42 Gbits/sec    0             sender</span><br><span class="line">[  5]   0.00-10.00  sec  11.0 GBytes  9.47 Gbits/sec                  receiver</span><br></pre></td></tr></table></figure><p>フローコントロール無しでこれは良い結果です。もっとも、アプリケーション（iperf3）が再送を必要としていないだけであって、NIC同士がオフロードして送受信管理するのでOSまでその情報は見えていないと考えられます。昔はとても高価かつ使いこなすのが難しいNICでしたが、シンプルに使うだけであれば、容易にその高い性能がホームユーザーにも享受できるようになってきました。</p><h2 id="Connect-Xのファームウェア更新（Windows版）"><a href="#Connect-Xのファームウェア更新（Windows版）" class="headerlink" title="Connect Xのファームウェア更新（Windows版）"></a>Connect Xのファームウェア更新（Windows版）</h2><p>特にMellanoxのNICで脆弱性という話を聞いたことはなく、頻繁にパッチが出ないので本当に運用が楽ではありますが購入時にファームウェアを更新しておきましょう。「<a href="/new-technology/2022/04/02/nic-firmware/" title="ESXiでネットワークカードのファームウェアを更新する">ESXiでネットワークカードのファームウェアを更新する</a>」ではネットに接続されていない前提としてパッチを個別にダウンロードしましたが、Windowsの場合はネットに接続されている事が前提でしょうから、もう少し手間は省けます（ESXiホスト自身はNTPなど限定されたサービスを除きインターネットアクセスしないのが一般的です）。</p><p>WindowsにおいてMellanoxカードのファームウェアの更新にはMFTとmlxupの2つのツールが必要です。<br>まずMFTのインストールになります。以下のURLからMFTをダウンロードします。</p><blockquote><p>NVIDIA Firmware Tools (MFT)<br> <a href="https://network.nvidia.com/products/adapter-software/firmware-tools/">https://network.nvidia.com/products/adapter-software/firmware-tools/</a></p></blockquote><p>2023-3-25時点では、2023-1-31リリースの4.23.0が最新のようです。<br>MFTもインストーラーで特に悩むこともなくセットアップを完了させます。OSを再起動するとMFTツールは自動起動されますが、再起動しなくともコマンドプロンプトから<code>mst server start</code>でサービスが起動します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\yoshi&gt;mst server start</span><br><span class="line"></span><br><span class="line">C:\Users\yoshi&gt;Waiting for connection on port 23108</span><br></pre></td></tr></table></figure><p>引き続き、管理者権限のコマンドプロンプトを開き、<code>mst status</code>を実行するとNICの情報が得られます。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">C:\Windows\System32&gt;mst status</span><br><span class="line">MST devices:</span><br><span class="line">------------</span><br><span class="line"></span><br><span class="line">  mt4117_pciconf0</span><br><span class="line"></span><br><span class="line">C:\Windows\System32&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>続いてmlxupのダウンロードです。これはexeファイルそのものなので、ブラウザからのダウンロード時に警告が出るかもしれません。</p><blockquote><p>mlxup - Update and Query Utility<br> <a href="https://network.nvidia.com/support/firmware/mlxup-mft/">https://network.nvidia.com/support/firmware/mlxup-mft/</a></p></blockquote><p>ダウンロードしたら、コマンドプロンプトにて<code>mlxup.exe --query</code>を実行します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mlxup --query</span><br><span class="line"></span><br><span class="line">Querying Mellanox devices firmware ...</span><br><span class="line"></span><br><span class="line">Device #1:</span><br><span class="line">----------</span><br><span class="line"></span><br><span class="line">  Device Type:      ConnectX4LX</span><br><span class="line">  Part Number:      MCX4121A-ACA_Ax</span><br><span class="line">  Description:      ConnectX-4 Lx EN network interface card; 25GbE dual-port SFP28; PCIe3.0 x8; ROHS R6</span><br><span class="line">  PSID:             MT_2420110034</span><br><span class="line">  PCI Device Name:  mt4117_pciconf0</span><br><span class="line">  Base MAC:         0c42a1000000</span><br><span class="line">  Versions:         Current        Available</span><br><span class="line">     FW             14.25.1020     14.32.1010</span><br><span class="line">     PXE            3.5.0701       3.6.0502</span><br><span class="line">     UEFI           14.18.0019     14.25.0017</span><br><span class="line"></span><br><span class="line">  Status:           Update required</span><br></pre></td></tr></table></figure><p>するとこのようにファームウェアの情報とアップデート可能か否かの情報が得られます。<br>実際のファームウェアの更新は<code>mlxup --online</code>です。これで適切なファームウェアがダウンロードされ適用されます。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\yoshi\Downloads&gt;mlxup --online</span><br><span class="line">Querying Mellanox devices firmware ...</span><br><span class="line"></span><br><span class="line">Device #1:</span><br><span class="line">----------</span><br><span class="line"></span><br><span class="line">  Device Type:      ConnectX4LX</span><br><span class="line">  Part Number:      MCX4121A-ACA_Ax</span><br><span class="line">  Description:      ConnectX-4 Lx EN network interface card; 25GbE dual-port SFP28; PCIe3.0 x8; ROHS R6</span><br><span class="line">  PSID:             MT_2420110034</span><br><span class="line">  PCI Device Name:  mt4117_pciconf0</span><br><span class="line">  Base MAC:         0c42a1000000</span><br><span class="line">  Versions:         Current        Available</span><br><span class="line">     FW             14.25.1020     14.32.1010</span><br><span class="line">     PXE            3.5.0701       3.6.0502</span><br><span class="line">     UEFI           14.18.0019     14.25.0017</span><br><span class="line"></span><br><span class="line">  Status:           Update required</span><br><span class="line"></span><br><span class="line">Release notes for the available Firmware:</span><br><span class="line">-----------------------------------------</span><br><span class="line"></span><br><span class="line">  For more details, please refer to the following FW release notes:</span><br><span class="line">    1- ConnectX3 (2.42.5000):    http://www.mellanox.com/pdf/firmware/ConnectX3-FW-2_42_5000-release_notes.pdf</span><br><span class="line">    2- ConnectX3Pro (2.42.5000): http://www.mellanox.com/pdf/firmware/ConnectX3Pro-FW-2_42_5000-release_notes.pdf</span><br><span class="line">    3- Connect-IB (10.16.1200):  http://www.mellanox.com/pdf/firmware/ConnectIB-FW-10_16_1200-release_notes.pdf</span><br><span class="line">    4- ConnectX4 (12.28.2006):   http://docs.mellanox.com/display/ConnectX4Firmwarev12282006</span><br><span class="line">    5- ConnectX4Lx (14.32.1010): http://docs.mellanox.com/display/ConnectX4LxFirmwarev14321010</span><br><span class="line">    6- ConnectX5 (16.35.2000):   http://docs.mellanox.com/display/ConnectX5Firmwarev16352000</span><br><span class="line">    7- ConnectX6 (20.36.1010):   http://docs.mellanox.com/display/ConnectX6Firmwarev20361010</span><br><span class="line">    8- ConnectX6Dx (22.36.1010):   http://docs.mellanox.com/display/ConnectX6DxFirmwarev22361010</span><br><span class="line">    9- ConnectX6Lx (26.36.1010):   http://docs.mellanox.com/display/ConnectX6LxFirmwarev26361010</span><br><span class="line">    10- BlueField2 (24.35.2000):   http://docs.mellanox.com/display/BlueField2Firmwarev24352000</span><br><span class="line">    11- ConnectX7 (28.36.1010):   http://docs.mellanox.com/display/ConnectX7Firmwarev28361010</span><br><span class="line"></span><br><span class="line">---------</span><br><span class="line">Found 1 device(s) requiring firmware update...</span><br><span class="line"></span><br><span class="line">Perform FW update? [y/N]: y</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CMD: mlxup -u --log-on-update --ssl-certificate C:\Users\yoshi\AppData\Local\Temp\sfxter_yoshi_3512\mlxup-dir\ca-bundle.crt --current-dir C:\Users\yoshi\Downloads\  --online</span><br><span class="line">Querying Mellanox devices firmware ...</span><br><span class="line"></span><br><span class="line">Device #1:</span><br><span class="line">----------</span><br><span class="line"></span><br><span class="line">  Device Type:      ConnectX4LX</span><br><span class="line">  Part Number:      MCX4121A-ACA_Ax</span><br><span class="line">  Description:      ConnectX-4 Lx EN network interface card; 25GbE dual-port SFP28; PCIe3.0 x8; ROHS R6</span><br><span class="line">  PSID:             MT_2420110034</span><br><span class="line">  PCI Device Name:  mt4117_pciconf0</span><br><span class="line">  Base MAC:         0c42a1000000</span><br><span class="line">  Versions:         Current        Available</span><br><span class="line">     FW             14.25.1020     14.32.1010</span><br><span class="line">     PXE            3.5.0701       3.6.0502</span><br><span class="line">     UEFI           14.18.0019     14.25.0017</span><br><span class="line"></span><br><span class="line">  Status:           Update required</span><br><span class="line"></span><br><span class="line">Release notes for the available Firmware:</span><br><span class="line">-----------------------------------------</span><br><span class="line"></span><br><span class="line">  For more details, please refer to the following FW release notes:</span><br><span class="line">    1- ConnectX3 (2.42.5000):    http://www.mellanox.com/pdf/firmware/ConnectX3-FW-2_42_5000-release_notes.pdf</span><br><span class="line">    2- ConnectX3Pro (2.42.5000): http://www.mellanox.com/pdf/firmware/ConnectX3Pro-FW-2_42_5000-release_notes.pdf</span><br><span class="line">    3- Connect-IB (10.16.1200):  http://www.mellanox.com/pdf/firmware/ConnectIB-FW-10_16_1200-release_notes.pdf</span><br><span class="line">    4- ConnectX4 (12.28.2006):   http://docs.mellanox.com/display/ConnectX4Firmwarev12282006</span><br><span class="line">    5- ConnectX4Lx (14.32.1010): http://docs.mellanox.com/display/ConnectX4LxFirmwarev14321010</span><br><span class="line">    6- ConnectX5 (16.35.2000):   http://docs.mellanox.com/display/ConnectX5Firmwarev16352000</span><br><span class="line">    7- ConnectX6 (20.36.1010):   http://docs.mellanox.com/display/ConnectX6Firmwarev20361010</span><br><span class="line">    8- ConnectX6Dx (22.36.1010):   http://docs.mellanox.com/display/ConnectX6DxFirmwarev22361010</span><br><span class="line">    9- ConnectX6Lx (26.36.1010):   http://docs.mellanox.com/display/ConnectX6LxFirmwarev26361010</span><br><span class="line">    10- BlueField2 (24.35.2000):   http://docs.mellanox.com/display/BlueField2Firmwarev24352000</span><br><span class="line">    11- ConnectX7 (28.36.1010):   http://docs.mellanox.com/display/ConnectX7Firmwarev28361010</span><br><span class="line"></span><br><span class="line">---------</span><br><span class="line">Found 1 device(s) requiring firmware update...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Please wait while downloading MFA(s) ...</span><br><span class="line">Device #1: Updating FW ...</span><br><span class="line"></span><br><span class="line">FSMST_INITIALIZE -   OK</span><br><span class="line"></span><br><span class="line">Writing Boot image component -   0%</span><br><span class="line">Writing Boot image component -   1%</span><br><span class="line">Writing Boot image component -   2%</span><br><span class="line">(省略)</span><br><span class="line">Writing Boot image component - 100%</span><br><span class="line">Writing Boot image component -   OK</span><br><span class="line">Done</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Restart needed for updates to take effect.</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>最後にOSをリブートして完了です。ESXiよりはずいぶん簡単ですね。</p><p>個別のファームウェアを適用したい場合は、mlxupのダウンロードページにUser Manualのリンクがありますので参照してください。</p><h2 id="PCIe-x4スロット"><a href="#PCIe-x4スロット" class="headerlink" title="PCIe x4スロット"></a>PCIe x4スロット</h2><p>さて、エイプリールフールも近いのでネタを1つご紹介します。<br>今回紹介したMellanox Connect X-4の必要レーン数は、PCIe x8です。グラフィックカードをPCIe x16に挿していらっしゃる方は残りのPCIe x4のスロットしか使えず、最初からPCIe x8のネットワークカードは候補に上がらないと思います。</p><p>私のもう1台のPC（Ryzen5 5600G）のPCIe x4のスロットです（PCIe3 x4で動作）。物理的なスロットは長いですが、接続端子がx4の部分までしかありません（画像をクリックして拡大できます）。</p><img src="/new-technology/2023/03/25/Mellanox-ConnectXandWindows11/pci1.png" class="" width="1024" title="alt"><p>Connect X-4を挿すところです。どう見てもレーン数が不足しています。</p><img src="/new-technology/2023/03/25/Mellanox-ConnectXandWindows11/pci2.png" class="" width="1024" title="alt"><p>とりあえずはスロットにConnect X-4を差し込み、Windows11を起動すると無事にカードは認識されています。<strong>SFP28モジュール</strong>とOM3ケーブルとを使ってスイッチに繋いでみます。</p><img src="/new-technology/2023/03/25/Mellanox-ConnectXandWindows11/unifi1.png" class="" width="1024" title="alt"><p>（UbiquitiのSwitch Pro Aggregationスイッチは4つのSFP28ポートを持っています。見た目はSFP+と区別がつきませんが、右側の4PortがSFP28です）</p><p>iperf3のテストです。Windows11同士、それぞれがConnectx-4で片方がPCIe x4です。多重度は2です。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">iperf3 PCIe x4 Ryzen5(SFP28) &lt;- Ryzen7(SFP28)</span><br><span class="line"></span><br><span class="line">C:\Users\yoshi&gt;iperf3 -c 192.168.x.165 -R -P2</span><br><span class="line">Connecting to host 192.168.x.165, port 5201</span><br><span class="line">Reverse mode, remote host 192.168.x.165 is sending</span><br><span class="line">[  5] <span class="built_in">local</span> 192.168.x.112 port 49813 connected to 192.168.x.165 port 5201</span><br><span class="line">[  7] <span class="built_in">local</span> 192.168.x.112 port 49814 connected to 192.168.x.165 port 5201</span><br><span class="line">[ ID] Interval           Transfer     Bitrate</span><br><span class="line">[  5]   0.00-1.00   sec  1.37 GBytes  11.8 Gbits/sec</span><br><span class="line">[  7]   0.00-1.00   sec  1.35 GBytes  11.6 Gbits/sec</span><br><span class="line">[SUM]   0.00-1.00   sec  2.72 GBytes  23.3 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[  5]   1.00-2.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class="line">[  7]   1.00-2.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class="line">[SUM]   1.00-2.00   sec  2.76 GBytes  23.7 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[  5]   2.00-3.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class="line">[  7]   2.00-3.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class="line">[SUM]   2.00-3.00   sec  2.76 GBytes  23.7 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[  5]   3.00-4.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class="line">[  7]   3.00-4.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class="line">[SUM]   3.00-4.00   sec  2.76 GBytes  23.7 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[  5]   4.00-5.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class="line">[  7]   4.00-5.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class="line">[SUM]   4.00-5.00   sec  2.76 GBytes  23.7 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[  5]   5.00-6.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class="line">[  7]   5.00-6.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class="line">[SUM]   5.00-6.00   sec  2.76 GBytes  23.7 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[  5]   6.00-7.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class="line">[  7]   6.00-7.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class="line">[SUM]   6.00-7.00   sec  2.76 GBytes  23.7 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[  5]   7.00-8.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class="line">[  7]   7.00-8.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class="line">[SUM]   7.00-8.00   sec  2.76 GBytes  23.7 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[  5]   8.00-9.00   sec  1.35 GBytes  11.6 Gbits/sec</span><br><span class="line">[  7]   8.00-9.00   sec  1.39 GBytes  11.9 Gbits/sec</span><br><span class="line">[SUM]   8.00-9.00   sec  2.74 GBytes  23.5 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[  5]   9.00-10.00  sec  1.39 GBytes  11.9 Gbits/sec</span><br><span class="line">[  7]   9.00-10.00  sec  1.35 GBytes  11.6 Gbits/sec</span><br><span class="line">[SUM]   9.00-10.00  sec  2.73 GBytes  23.5 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[ ID] Interval           Transfer     Bitrate</span><br><span class="line">[  5]   0.00-10.00  sec  13.8 GBytes  11.8 Gbits/sec                  sender</span><br><span class="line">[  5]   0.00-10.00  sec  13.8 GBytes  11.8 Gbits/sec                  receiver</span><br><span class="line">[  7]   0.00-10.00  sec  13.8 GBytes  11.8 Gbits/sec                  sender</span><br><span class="line">[  7]   0.00-10.00  sec  13.8 GBytes  11.8 Gbits/sec                  receiver</span><br><span class="line">[SUM]   0.00-10.00  sec  27.5 GBytes  23.6 Gbits/sec                  sender</span><br><span class="line">[SUM]   0.00-10.00  sec  27.5 GBytes  23.6 Gbits/sec                  receiver</span><br><span class="line"></span><br><span class="line">iperf Done.</span><br></pre></td></tr></table></figure><p>中途半端な繋ぎ方ですが、25GbEワイヤレートの速度がしっかり出ています。25GbEの全二重通信の検証まではやっていませんが、そもそもPCIe x8で25GbEが2Portならば、PCIe x4で25GbEの1Portはいけるでしょうし、10GbEなら2Portともに大丈夫でしょう。</p><p>まるでギャンブルですが、エイプリールフールでした、、、ということではありません。Mellanox Connect X-4はこういった接続方法に対応しています。</p><img src="/new-technology/2023/03/25/Mellanox-ConnectXandWindows11/mellanox.png" class="" width="480" title="alt"><p>冒頭で紹介した製品スペックのPDFでは、赤枠で囲ったところに、オートネゴシエートとあります。理論上、PCIe3 x4では帯域が32Gbpsですから25Gbpsの通信は可能ということになります。</p><p>どうしても先入観があって、x4のスロットにx8のカードを挿そうと思いませんよね。</p><p>PCIeのレーン数はご利用のマザーボードによって様々な仕様がありますので事前のご確認をお勧めします。</p>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2023/03/25/Mellanox-ConnectXandWindows11/title.png&quot; class=&quot;&quot; width=&quot;1024&quot; title=&quot;alt&quot;&gt;
&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;

&lt;p&gt;この記事ではSFP+のネットワークカードである、Mellanox Connect XについてWindows11の対応状況やWindowsでのファームウェアアップデートなどを記します。&lt;/p&gt;</summary>
    
    
    
    <category term="Hardware" scheme="https://yoshi0808.github.io/new-technology/categories/Hardware/"/>
    
    <category term="Network" scheme="https://yoshi0808.github.io/new-technology/categories/Network/"/>
    
    
    <category term="SFP+" scheme="https://yoshi0808.github.io/new-technology/tags/SFP/"/>
    
    <category term="10GbE" scheme="https://yoshi0808.github.io/new-technology/tags/10GbE/"/>
    
  </entry>
  
  <entry>
    <title>Sophos Firewall v19.5 MR-1</title>
    <link href="https://yoshi0808.github.io/new-technology/2023/02/23/xg-v195mr1/"/>
    <id>https://yoshi0808.github.io/new-technology/2023/02/23/xg-v195mr1/</id>
    <published>2023-02-22T21:34:42.000Z</published>
    <updated>2023-02-23T06:48:44.000Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2023/02/23/xg-v195mr1/title.png" class="" title="alt"><h2 id="Sophos-Firewall-v19-5-MR1"><a href="#Sophos-Firewall-v19-5-MR1" class="headerlink" title="Sophos Firewall v19.5 MR1"></a>Sophos Firewall v19.5 MR1</h2><p>Sophos Firewall v19.5 MR1が2023年2月15日に発表されました。</p><span id="more"></span><h2 id="主なエンハンスの内容"><a href="#主なエンハンスの内容" class="headerlink" title="主なエンハンスの内容"></a>主なエンハンスの内容</h2><p>Home Editionとしてはバグフィックスのみで機能向上はなさそうです。新機能が無いのは少し寂しいですが、安定性はv19以降でかなり向上したと感じます。</p><p>v19.5 MR1の詳細な説明はRelease Notesを参照してください。</p><blockquote><p><a href="https://docs.sophos.com/releasenotes/index.html?productGroupID=nsg&amp;productID=xg&amp;versionID=19.5">https://docs.sophos.com/releasenotes/index.html?productGroupID=nsg&amp;productID=xg&amp;versionID=19.5</a></p></blockquote><h2 id="Sophos-Firewallのアップデート"><a href="#Sophos-Firewallのアップデート" class="headerlink" title="Sophos Firewallのアップデート"></a>Sophos Firewallのアップデート</h2><p>XGの管理画面にログイン後、左ペインメニューの<mark class="label primary">バックアップ＆ファームウェア</mark>の<mark class="label primary">ファームウェアの確認</mark>ではただちに全てのユーザーにアップデートの案内が来るわけでは無いので、アップデートにはMySophosにログインし、バージョンアップの差分モジュールをダウンロードします。</p><ol><li>Sophosのサイトの右上のプルダウンメニューから、<mark class="label primary">ライセンスとアカウント</mark>をクリックします。<blockquote><p><a href="https://www.sophos.com/ja-jp.aspx">https://www.sophos.com/ja-jp.aspx</a></p></blockquote></li><li>Sophos IDをお持ちでなければIDを作成します。</li><li>ログイン後、<mark class="label primary">Network Protection</mark>をクリックします。</li><li><mark class="label primary">ファームウェアの更新</mark>をクリックします。</li><li>「製品名&#x2F;OSを使った検索」で”ファイアーウォール”を選択し、その後現れるプルダウンは”ソフトウェア”を選択します。</li><li><mark class="label primary">選択可能なダウンロードを表示</mark>ボタンをクリックします。</li></ol><img src="/new-technology/2023/02/23/xg-v195mr1/mysophos.png" class="" width="800" title="alt"><ol><li>上記画面で”SW-19.5.1_MR-1.SFW-278.sig”というアップデータが表示されますのでダウンロードします。</li><li>MY Sophosはここで終了してXGの管理画面にログインし、左ペインメニューの<mark class="label primary">バックアップ＆ファームウェア</mark>の<mark class="label primary">ファームウェアのタブメニュー</mark>から以下の画面に赤丸で囲った矢印のアイコンをクリックし、ダウンロードしたモジュールをアップロードします。</li></ol><img src="/new-technology/2023/02/23/xg-v195mr1/verup.png" class="" width="800" title="alt"><p>アップロード＆再起動ボタンをクリックし、v19.5へのアップグレードを完了させます。</p><img src="/new-technology/2023/02/23/xg-v195mr1/upgrade.png" class="" width="800" title="alt"><div class="note info"><p>仮想環境（ESXi）上にFirewallをインストールされている方はアップグレードの前に、「<a href="/new-technology/2020/10/11/esxi-backup/" title="VMware ESXiの仮想マシンをバックアップする">VMware ESXiの仮想マシンをバックアップする</a>」を参考に、バックアップを確保される事をお勧めします。</p></div>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2023/02/23/xg-v195mr1/title.png&quot; class=&quot;&quot; title=&quot;alt&quot;&gt;

&lt;h2 id=&quot;Sophos-Firewall-v19-5-MR1&quot;&gt;&lt;a href=&quot;#Sophos-Firewall-v19-5-MR1&quot; class=&quot;headerlink&quot; title=&quot;Sophos Firewall v19.5 MR1&quot;&gt;&lt;/a&gt;Sophos Firewall v19.5 MR1&lt;/h2&gt;&lt;p&gt;Sophos Firewall v19.5 MR1が2023年2月15日に発表されました。&lt;/p&gt;</summary>
    
    
    
    <category term="Security" scheme="https://yoshi0808.github.io/new-technology/categories/Security/"/>
    
    
    <category term="XG Firewall" scheme="https://yoshi0808.github.io/new-technology/tags/XG-Firewall/"/>
    
  </entry>
  
  <entry>
    <title>auひかり BL3000HM</title>
    <link href="https://yoshi0808.github.io/new-technology/2023/01/28/bl3000hm/"/>
    <id>https://yoshi0808.github.io/new-technology/2023/01/28/bl3000hm/</id>
    <published>2023-01-27T15:00:00.000Z</published>
    <updated>2023-02-23T07:12:09.000Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2023/01/28/bl3000hm/bl3000hm.png" class="" width="240" title="alt"><p class="onepoint">この記事で実現すること</p><p>auひかりの新しいホームゲートウェイ（HGW)に交換してみたのでレポートします。ONUと一体型となったモデルです。Wi-Fi6Eにも対応しています。私はauひかりのWi-Fiは契約していないため、Wi-Fi以外の基本性能・機能について紹介します。</p><span id="more"></span><h2 id="auひかりホームユーザー向け、HGW交換の案内"><a href="#auひかりホームユーザー向け、HGW交換の案内" class="headerlink" title="auひかりホームユーザー向け、HGW交換の案内"></a>auひかりホームユーザー向け、HGW交換の案内</h2><p>auひかりではこれまでもユーザーの希望によるホームゲートウェイの交換について、半導体不足により一時的に交換を停止していましたが、昨年末に再開するという案内がありました。</p><blockquote><p>2022&#x2F;12&#x2F;22 auひかり ホームゲートウェイ：お客さまのご要望による交換（希望交換）の再開について<br> <a href="https://www.au.com/information/notice_internet/service/20221220-01/">https://www.au.com/information/notice_internet/service/20221220-01/</a></p></blockquote><p>私はこれまでホーム5ギガユーザーとしてBL1000HW（HGW）と10G-PON（ONU）をレンタルで利用していましたが、ONU一体型のHGWになるということで多少のレイテンシと消費電力の改善期待があり早速交換のお願いをしました。交換には3,300円掛かるとの記載があります。電話回線が2回線ある場合はBL3000HMには交換できないようです。<br>インターネット回線によるスピードテストでも3ギガ程度は出ており全く不満はありませんが、5ギガと10ギガの差額が月額780円なので、10ギガの契約に併せて変更もしました。</p><h2 id="auひかりホーム10ギガ・5ギガについて"><a href="#auひかりホーム10ギガ・5ギガについて" class="headerlink" title="auひかりホーム10ギガ・5ギガについて"></a>auひかりホーム10ギガ・5ギガについて</h2><p>auひかりのホーム10ギガ・5ギガサービスは関東圏の一部エリアのみ提供となっています。IPv4&#x2F;IPv6デュアルスタックで複雑な設定が不要で高速インターネットが利用できます。<br>ホーム10ギガ・5ギガのサービス説明は以下を参照してください。</p><blockquote><p>auひかり ホーム10ギガ・5ギガ<br> <a href="https://www.au.com/internet/auhikari_10-5g/">https://www.au.com/internet/auhikari_10-5g/</a></p></blockquote><p>基本情報、マニュアルは以下を参照してください。</p><blockquote><p>auひかり ホームゲートウェイ Aterm BL3000HM<br> <a href="https://www.au.com/support/service/internet/guide/modem/bl3000hm/">https://www.au.com/support/service/internet/guide/modem/bl3000hm/</a></p></blockquote><h2 id="BL3000HM"><a href="#BL3000HM" class="headerlink" title="BL3000HM"></a>BL3000HM</h2><p>年末に申し込んで年明け早々にBL3000HM（BL3000：右側）が届きました。BL1000（左側）も大きかったですがBL3000はかなり大きいと感じます。交換は自分で行います。</p><img src="/new-technology/2023/01/28/bl3000hm/bl3000-1.png" class="" width="1024" title="alt"><p>横幅28cm程度もありますね。私の場合はクローゼットの中に収まるので大きさは特に気になりませんが、リビングに配置するとなると少し目立つサイズです。</p><p>BL3000には、上記写真にある通り、ひかり回線と接続するコネクタ付きのシングルモードファイバケーブル（約3m）が既に取り付けられています。説明書には約3mと書いてありますが、これ3mもあるかな。。。その他付属品として電源ケーブル（アース無し）とLANケーブル（1.5m）があります。</p><table><thead><tr><th>機種</th><th>消費電力</th><th>アース</th><th>LANケーブル</th></tr></thead><tbody><tr><td>BL3000HM</td><td>45W（最大）</td><td>無し</td><td>Cat6A STP</td></tr><tr><td>BL1000HW</td><td>34W(最大)</td><td>無し</td><td>Cat6A STP</td></tr><tr><td>10G-EPON</td><td>14.3W以下</td><td>無し</td><td>Cat6A STP</td></tr></tbody></table><p>最大消費電力だけで見るとBL1000とONUとを合計したものとBL3000と比較した場合は大して変わりません。BL1000、BL3000共にWi-Fi機能を持ちますから、Wi-Fiを使わない場合はそれなりに電力が抑えられているものと思います。付属のケーブルは前回も今回も変わらず、Cat6Aのシールドツイストペア（STP）です。STPを使う場合には正しいアースが云々というご意見もあるようですが、短いケーブルについて気にすることは無いということでしょう。LAN4というRJ45の口が10GbEですが、5G&#x2F;2.5G&#x2F;1G&#x2F;100Base-TXにも対応しています。</p><p>早速、BL3000のファイバケーブルを光回線に接続し直し、LANケーブルを10GbEポートに接続し、電源を入れてみます。</p><img src="/new-technology/2023/01/28/bl3000hm/wchecker.png" class="" width="360" title="alt"><p>普段のアイドル状態で16.35w、2.5Gbps程度のアップロード時で16.5Wです。やはりネットワーク機器なのでNATやフィルタ処理などを除いたルーティングは通信専用のチップ（ASIC）が対応するため通信量と電力とは殆ど関係ありません。</p><h2 id="回線速度"><a href="#回線速度" class="headerlink" title="回線速度"></a>回線速度</h2><p>さて、いつものSpeedtestです。HGWとスイッチとをRJ45で接続し、スイッチとMacBook-AirとをSFP+で接続して計測してみます。平日の夕方に計測しました。</p><p>HGWのLANに接続</p><img src="/new-technology/2023/01/28/bl3000hm/speedtest1.png" class="" width="360" title="alt"><p>Sophos Firewall（TLS／SSLインスペクション有り）を通した速度</p><img src="/new-technology/2023/01/28/bl3000hm/speedtest2.png" class="" width="360" title="alt"><p>HGWのLANに接続した場合は5Gbps以上の速度が出ています。一方、FirewallのTLS&#x2F;SSLインスペクションを通しても下りはさほど落ちていません。上りは流石にデータ漏洩の観点から厳しくチェックするのでこれくらいには落ちてしまうのは仕方がないところでしょうか。自宅内のFirewallを通してもレイテンシ（Ping）が3ミリ秒という表示になっており、かなりの低遅延のネットワークになっていると言えそうです。これまでは4ミリ秒でした。</p><p>朝方の計測はHGW直結で5Gbps〜6Gbps程度の速度です。</p><h2 id="ログ機能"><a href="#ログ機能" class="headerlink" title="ログ機能"></a>ログ機能</h2><p>今回のHGWは簡単なログ機能が付いています。HGWのデフォルトのLANのIPアドレスは<code>192.168.0.1/24</code>です。</p><img src="/new-technology/2023/01/28/bl3000hm/log.png" class="" width="800" title="alt"><h2 id="スイッチ部分"><a href="#スイッチ部分" class="headerlink" title="スイッチ部分"></a>スイッチ部分</h2><p>BL1000HWと同様、BL3000HMも10GbEが1Port、1GbEが3Portとなります。</p><img src="/new-technology/2023/01/28/bl3000hm/sw.png" class="" width="360" title="alt"><p>一般的に、スイッチ機能を持つ1Gのチップ（PHY）は4Port単位で組まれることが多いです。10GbEと1GbEと合わせて4Portというのは、実際に10GbEに対応した4PortのPHYに1GbEの3Portが接続されているのでは？と妄想してしまいます。</p><p>10Gポートと1Gポートとのスループットはどうでしょうか。10Gポートには、Mellanox Connect-X3(10G SFP+)を挿したUbuntu22をSFP+スイッチ経由で接続し、1GポートにはMacBook-AirにPlaggableのUSBアダプタを挿してiperf3を実行してみます。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">yoshi@ub22:~$ iperf3 -c 192.168.0.3</span><br><span class="line">Connecting to host 192.168.0.3, port 5201</span><br><span class="line">[  5] <span class="built_in">local</span> 192.168.0.4 port 48032 connected to 192.168.0.3 port 5201</span><br><span class="line">[ ID] Interval           Transfer     Bitrate         Retr  Cwnd</span><br><span class="line">[  5]   0.00-1.00   sec   115 MBytes   963 Mbits/sec    0   3.77 MBytes</span><br><span class="line">[  5]   1.00-2.00   sec   112 MBytes   944 Mbits/sec    0   3.77 MBytes</span><br><span class="line">[  5]   2.00-3.00   sec   112 MBytes   944 Mbits/sec    0   3.96 MBytes</span><br><span class="line">[  5]   3.00-4.00   sec   111 MBytes   933 Mbits/sec    0   3.96 MBytes</span><br><span class="line">[  5]   4.00-5.00   sec   112 MBytes   944 Mbits/sec    0   3.96 MBytes</span><br><span class="line">[  5]   5.00-6.00   sec   112 MBytes   944 Mbits/sec    0   3.96 MBytes</span><br><span class="line">[  5]   6.00-7.00   sec   112 MBytes   944 Mbits/sec    0   3.96 MBytes</span><br><span class="line">[  5]   7.00-8.00   sec   112 MBytes   944 Mbits/sec    0   3.96 MBytes</span><br><span class="line">[  5]   8.00-9.00   sec   111 MBytes   933 Mbits/sec    0   3.96 MBytes</span><br><span class="line">[  5]   9.00-10.00  sec   112 MBytes   944 Mbits/sec    0   3.96 MBytes</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[ ID] Interval           Transfer     Bitrate         Retr</span><br><span class="line">[  5]   0.00-10.00  sec  1.10 GBytes   944 Mbits/sec    0             sender</span><br><span class="line">[  5]   0.00-10.03  sec  1.10 GBytes   941 Mbits/sec                  receiver</span><br></pre></td></tr></table></figure><p>文句なしのパフォーマンスです。このタイミングでワットチェッカーを確認してみました。</p><img src="/new-technology/2023/01/28/bl3000hm/wchecker2.png" class="" width="360" title="alt"><p>10GbEに加え、1GbEのRJ45をBL3000HMに接続しているため、ベースの消費電力は16.787Wとなっています。10GbEのみと比べ、0.43W消費電力が増えています。<br>これにiperf3を実行したタイミングでは、16.84Wとなり、僅か0.07W弱の消費電力が上昇しています。非常に誠実な作りであると思われます。</p><p>10GのPHYは単体であったり、2Port、4Portと様々な種類がありますが、他の製品のHGWやWi-Fiルーターで1GbEが4Port、10GbEが1Portある製品を見た時には、それらを繋ぐのはどうやっているのかな？と気になります。ASICではなくCPU（ソフトウェア）で相互にパケットをやり取りしている製品もあるらしく、10GbEと1GbEの通信のパフォーマンスが出ないそうです。</p><h2 id="レイテンシとアプリケーション"><a href="#レイテンシとアプリケーション" class="headerlink" title="レイテンシとアプリケーション"></a>レイテンシとアプリケーション</h2><p>私は10Gbpsのトラフィックを必要としていませんが、こういった多段のセグメントを介するネットワーク構成(VLAN)&#x2F;仮想環境&#x2F;Firewall&#x2F;アンチウィルス&#x2F;アプリケーションFirewallを組み合わせているため、少しでもレイテンシが大きくなるのを防ぎたいという狙いがあります。こうやって全体を俯瞰して見ると、セキュリティのためとはいえ、レイテンシが大きくなるような事ばかりしているわけです。</p><p>私の使っているアンチウィルスソフトのBitDefenderはそれ単体でTLS&#x2F;SSLインスペクションを実行するため、なおさら遅くなります。</p><p>最近のファイル転送プロトコルであればファイルのやり取りに高度な並列処理を実施することでトータルのデータ転送量を稼ぎますが、アプリケーションによっては単一のTCPセッションによるやり取りとなります。そのようなアプリケーションはいくら回線が太くても、到底大きな転送量はこなせません。数10Mbps程度の速度でもレイテンシが大きく関係するようになります。</p><p>高速回線と聞けば、ストリーミングビデオを思いつく方が多いでしょうか。4Kの映画や音楽配信サービスなどは負担が大きそうに思えるかもしれません。しかしこのようなサービスはデータの先読みができて、いくらでもバッファに積めます。1秒後どころか1分後に再生すべきであろうデータは全て読み込んでおけるので回線が多少不安定でも並列度を高めてデータ受信することで全く問題ありません。<br>しかし、電話であればそうはいきません。データの安定度を高めるために0.2秒程度のバッファは持ちますが、それ以上のバッファを持ち、遅延させると電話による会話が噛み合わなくなります。現代のリモートワークでも同時に発言してお互い譲り合うというのは見慣れた光景かもしれません。ホームユーザーであれば、リモートワークはもちろん、オンライン授業・コミュニティや友人・家族・親戚とのビデオ通話などが該当するでしょう。こういったビデオ通話ではデータの先読みが殆ど出来ないため、ネットワークの品質とレイテンシが大きく影響します。</p><p>私はオンラインゲームはしませんが、これもビデオ会議と同様でしょう。TCP通信では遅すぎるのでUDP通信でアプリケーション固有のプロトコルでやりとりすることになるでしょうか。私は自宅の環境でパケットロスを認識できるほどの経験はありませんが、回線の太さ以前に、パケット損失が大きく出てしまうプロバイダや回線業者もあるようです。私が10ギガネットワークを使いたいというのは光回線で、通信業者自体が持つバックボーンに（レイテンシが極めて小さい）大型ネットワーク機器が収容されていることを期待しています。さらに言えば、Apple、Googleなどの主要IT、CloudflareやAkamaiなどのCDN（コンテンツ・デリバリ・ネットワーク）、AWSやAzureなどのクラウドサービスにネットワーク的に近い環境が好ましいとも言えます。</p><p>私が利用しているSophos Firewallではレポート機能でビデオ会議のトラフィックを確認できます。</p><img src="/new-technology/2023/01/28/bl3000hm/sophos.png" class="" width="1024" title="alt"><mark class="label primary">Conferencing</mark> でフィルタすると、Teams会議、Zoom会議がクラウドアプリケーションとして判定され、サーバーIPアドレスも列挙されます。<p>実例として、Microsoft365のTeamsのサーバーにpingでレイテンシを計測してみます。</p><img src="/new-technology/2023/01/28/bl3000hm/ping.png" class="" width="1024" title="alt"><p>10分程度、pingの往復レイテンシを計測しています。平均4.6msであり、非常に低レイテンシでスパイクもせいぜい20ms以下ですから安定していると言えます。サーバーIPアドレスをGeo Locationで見ると場所は米国のマイクロソフト社になりますが、レイテンシから鑑みると関東近辺のデータセンターになると思われます。私の感覚的なものですが、米国の西海岸までは純粋なネットワークだけで往復100msのレイテンシ、東海岸までは往復150ms程度はあるはずです。実際のサーバーとの往復だと数百msにはなるようです。</p><p>なお、PCをWi-Fi6接続に変更すると、6.8msとなり、2.2ms遅延が追加されます。</p><h2 id="auひかりのホーム5ギガ、ホーム10ギガの違い"><a href="#auひかりのホーム5ギガ、ホーム10ギガの違い" class="headerlink" title="auひかりのホーム5ギガ、ホーム10ギガの違い"></a>auひかりのホーム5ギガ、ホーム10ギガの違い</h2><p>今回、HGWの交換によって若干のレイテンシ改善は確認できましたが、スループットとして大きく変わるような結果はありません。恐らく地域によって結果は大きく異なると思われます。なお、auひかりの場合は増速の際には事前の調査が必要なようで、混雑している地域だと10ギガへの変更が行えないとの事。ここ2、3年で1ギガを超える光回線の提供も随分浸透してきたと思われるので、時間帯によって帯域制限が加わっているような感覚をお持ちの方は一度確認されてはいかがでしょうか。</p><h2 id="契約変更"><a href="#契約変更" class="headerlink" title="契約変更"></a>契約変更</h2><p>機器交換には3,300円必要とauのホームページには記載がありましたが、以下の案内が事後に郵送されてきました。3,300円の交換に加えて2,000円の交換手数料が掛かるがそれは無料ということなのか、そもそも3,300円ではなく2,000円になるのか、或いは都合良く解釈すれば機器交換は無料なのか。。。また、プロバイダがau one netで10ギガに増速した場合、12ヶ月の間、780円（税込858円）を割り引くとの事です。こちらも次月の請求がわかったところでアップデートしたいと思いますが、そもそもの最初の契約の仕方によって人それぞれで割引プランが異なるのかもしれませんね。<br>（私はプロバイダはau one netでどこのアフェリエイトも通さず、直接auひかりに申し込みしています）</p><img src="/new-technology/2023/01/28/bl3000hm/au.png" class="" width="1024" title="alt"><p>(2023-2-23更新）<br>1月の請求を確認しました。キャンペーンの月額割引は日割りもあり、ピッタリ一致していませんが、計算上は780円の割引になっていました。また、機器交換の請求は現時点でありませんでした。</p><h2 id="補足"><a href="#補足" class="headerlink" title="補足"></a>補足</h2><p>新しいHGWを接続してから、しばらくしてIPv6アドレスが割り当てられていない事に気づきました。結局は翌日の昼頃に特にHGWを再起動したわけでもないですが、IPv6が割り当てられていました。環境変更後、少し時間が掛かるようです。</p>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2023/01/28/bl3000hm/bl3000hm.png&quot; class=&quot;&quot; width=&quot;240&quot; title=&quot;alt&quot;&gt;
&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;

&lt;p&gt;auひかりの新しいホームゲートウェイ（HGW)に交換してみたのでレポートします。ONUと一体型となったモデルです。Wi-Fi6Eにも対応しています。私はauひかりのWi-Fiは契約していないため、Wi-Fi以外の基本性能・機能について紹介します。&lt;/p&gt;</summary>
    
    
    
    <category term="Hardware" scheme="https://yoshi0808.github.io/new-technology/categories/Hardware/"/>
    
    <category term="Network" scheme="https://yoshi0808.github.io/new-technology/categories/Network/"/>
    
    
    <category term="10GbE" scheme="https://yoshi0808.github.io/new-technology/tags/10GbE/"/>
    
  </entry>
  
  <entry>
    <title>UniFi Wi-Fiシステム</title>
    <link href="https://yoshi0808.github.io/new-technology/2022/12/31/unifi-ap/"/>
    <id>https://yoshi0808.github.io/new-technology/2022/12/31/unifi-ap/</id>
    <published>2022-12-30T15:00:01.000Z</published>
    <updated>2023-04-15T03:45:16.168Z</updated>
    
    <content type="html"><![CDATA[<p class="onepoint">この記事で実現すること</p><p>この記事ではホームユーザー向けにUniFi AP(Wi-Fiアクセスポイント）の設定ができるようになることを目的としています。</p><span id="more"></span><h2 id="最近のWi-Fi事情"><a href="#最近のWi-Fi事情" class="headerlink" title="最近のWi-Fi事情"></a>最近のWi-Fi事情</h2><p>2022年9月にWi-Fiで6GHzも利用できるよう法律が変更されました（Wi-Fi6E）。国内のメーカーはこの6GHzとメッシュを謳い文句にWi-Fiルータの販売強化を図っているようです。しかしながら、端末側は今年に発売するiPhoneで6Eの対応が見送られた事であまり盛り上がってはいないようです。</p><p>Wi-Fiの難しいところはその住居の形や家の周りの電波状態に大きく左右されてしまう点で、これがベストという構成を見出せません。私の例で言えば、凡庸な建売の木造2階建であり、無線APが1つだけでも、それなりに無難にWi-Fiが使えるという環境です。</p><p>最近販売され始めた無線ルーターは、メッシュ対応のものが多く出てきました。メッシュは複数台のAPと無線でデータをやり取りできる機能です。無線の中継機は常に親機に集約されていましたが、メッシュは複数台のAPと相互に接続します。一般的には中継専用のSSIDを用いお互いにデータを中継します。</p><p>最近のメッシュWi-Fiルーターでは高速ローミング（802.11k、802.11r、802.11v）に対応している製品も出てきており、端末を持ちながら移動した場合に、アクセスポイント（AP）間を高速ローミングすることで切断時間を短くし、近くのAPに接続できます。また、それぞれのAPがメッシュ（無線）ではなく、有線接続して互いの情報を交換できる<strong>イーサネットバックホール（有線バックホール）</strong>という機能に対応している製品を複数の部屋に設置することでずいぶん快適になるでしょう。</p><p>なお、6EはDFSの影響を受けないチャンネルなので、自宅の間取りで6GHzが効率よく使える環境下であれば利便性は増します。私は6GHzの無線APは保有していないので、どのくらい電波が届くものなのかは今後機会があれば評価してみたいと考えています。周波数が上がるにつれて障害物によって遠くに届きづらくなるとは考えられます。各部屋に有線がなく、イーサネットバックホールが使えないケースでは、AP同士を6Eの独立チャンネルで接続する事で中継機能が改善することが期待されます（これまでは親機と中継機が同一のチャンネルを使うことで効率が大幅に落ちるケースがありました）。</p><p>また、端末側の6E対応状況が進捗するまではしばらくはWi-Fi6（5GHz）のままというのが現状でしょうか。</p><h2 id="UniFi-APのスペック"><a href="#UniFi-APのスペック" class="headerlink" title="UniFi APのスペック"></a>UniFi APのスペック</h2><p>日本国内で販売されているUniFi APはルーター機能を持たず、アクセスポイントに特化したハードウェアです。UniFiネットワークアプリケーションまたはUniFiコンソールを介して情報連携が行われます。</p><table><thead><tr><th>機種</th><th>U6 Pro</th><th>U6 Lite</th></tr></thead><tbody><tr><td>有線</td><td>GbE RJ45ポート x1</td><td>GbE RJ45ポート x1</td></tr><tr><td>給電方法</td><td>PoE</td><td>PoE</td></tr><tr><td>最大消費電力</td><td>13W</td><td>13.5W</td></tr><tr><td>最大送信パワー2.4GHz</td><td>22dBm</td><td>23dBm</td></tr><tr><td>最大送信パワー5GHz</td><td>23dBm※</td><td>23dBm</td></tr><tr><td>MIMO 2.4GHz</td><td>2x2</td><td>2x2</td></tr><tr><td>MIMO 5GHz</td><td>4x4</td><td>2x2</td></tr></tbody></table><p>※U6 Proのスペック上は26dBmが上限ですが、日本国内で利用する場合は上限が23dBmとなります。</p><p>Wi-FiのスペックとしてはU6 Proで日本国内のやや高性能モデルに相当するでしょうか。アンテナ数を見ても、国内のWi-Fi機器と比較して特段優れている項目はありません。U6 Liteも一般的なスペックです。</p><p>上記以外にも、11axに対応した中継機である、U6 Extender、メッシュ接続を前提とした、U6 Meshアクセスポイントなどが販売されています。商品の詳細は日本のオンラインストアを参照してください。</p><blockquote><p>Ubiquiti オンラインストア<br> <a href="https://jp.store.ui.com/collections/unifi-network-wireless">https://jp.store.ui.com/collections/unifi-network-wireless</a></p></blockquote><h2 id="UniFi-APの実速度"><a href="#UniFi-APの実速度" class="headerlink" title="UniFi APの実速度"></a>UniFi APの実速度</h2><p>iPhone11を使ってAPに1mの距離まで近づけて、iperf3を実行した時の結果は以下の通りです。</p><blockquote><p>U6 Pro<br> <img src="/new-technology/2022/12/31/unifi-ap/u6-pro3.png" class="" width="360" title="alt"></p></blockquote><blockquote><p>U6 Lite<br> <img src="/new-technology/2022/12/31/unifi-ap/u6-lite3.png" class="" width="360" title="alt"></p></blockquote><p>参考までに、Aterm WX6000HPの場合は以下です。</p><blockquote><img src="/new-technology/2022/12/31/unifi-ap/aterm.png" class="" width="360" title="alt"></blockquote><p>U6 Proの個性として、iperf3の起動直後は少しスロースタートに見えます。省電力の最適化に重きを置いているのでしょうか。</p><p>また、私の自宅の1階において、macOSのWi-Fi Explorerで電波の強さを計測してみました。1階にはU6 ProとAterm、2階にはU6 Liteが配置されています。</p><img src="/new-technology/2022/12/31/unifi-ap/wifi-explorer.png" class="" width="1024" title="alt"><p>電波の強さだけであればAtermのWX6000HPが素晴らしい結果を出しています。しかしiperf3の最高速度という観点についてはU6 Proの方が良いスコアです。</p><p>pingのレイテンシも見てみましょう。iPhoneからNASへのping応答速度です。iOSやmacOSはpingのレイテンシ数値が高く出てしまう傾向にあります。実は上記のiperf3を含めてL3スイッチ経由でルーティングしてNASのiperf3サーバーに接続しており、1ホップあります。</p><ul><li><p>Aterm pingレイテンシ</p> <img src="/new-technology/2022/12/31/unifi-ap/aterm4.png" class="" width="360" title="alt"></li><li><p>U6 Pro pingレイテンシ</p> <img src="/new-technology/2022/12/31/unifi-ap/u6-pro4.png" class="" width="360" title="alt"></li></ul><blockquote><p>PingPlotterによる計測<br> <a href="https://www.pingman.com/">https://www.pingman.com</a></p></blockquote><p>U6 Proの方が電波の出力は低いものの、レイテンシは15msあたりで上限が整っています。一方、Atermは時々、20msを超えるスパイクが発生しています。U6 Proの速度が出る理由はレイテンシが低い事と想定されます。スマホやノートPCの一般的な操作では100Mbpsを超えたあたりから殆どその差については分からなくなってきますが、リモートワークのビデオ会議の安定性を考えるとレイテンシは意識したいところです。</p><p>UniFi APはWi-Fi設定が非常に詳細まで行えることがメリットであり、電波が届かないなどの対策としての購入用途には向いていません。</p><h2 id="UniFi-APの設置"><a href="#UniFi-APの設置" class="headerlink" title="UniFi APの設置"></a>UniFi APの設置</h2><p>具体的にAPのセットアップの前に一度日本語ガイドのページをご覧になることをお勧めします。<br>これは最近拡充されてきたリソースですが、本来は私がブログで書きたかった、メーカーに依存しない無線LANに必要な知見が整理されており、とても貴重な内容となっています。</p><blockquote><p>UniFi Network - ワイヤレスクライアントの接続性を最適化する<br> <a href="https://help.jp.ui.com/articles/221029967/">https://help.jp.ui.com/articles/221029967/</a></p></blockquote><blockquote><p>UniFi Network - ワイヤレスネットワーク速度の最適化<br> <a href="https://help.jp.ui.com/articles/360012947634/">https://help.jp.ui.com/articles/360012947634/</a></p></blockquote><blockquote><p>UniFi Network - 最適なワイヤレスメッシュネットワークにするための検討事項<br> <a href="https://help.jp.ui.com/articles/115002262328/">https://help.jp.ui.com/articles/115002262328/</a></p></blockquote><p>私もどこかで自分なりの考えをまとめて記事にしたいとは考えています。</p><p>さて、APの設置についてです。</p><p>電源を取るのはPoEアダプタまたはPoEスイッチからというのが独特です。これによってLANケーブルのみでデータ送受信と送電が行え、美観を損ねる事なく、壁の上部にAPを配置し、障害物を避けた効率の良い電波の発信が行えます。Wi-Fiはハードウェアスペックも関係ありますが、こういった物理的な配置も重要です。有線バックホールを使わずにPoEの電力だけを使い、メッシュにすることもできます。この場合、UniFi APは有線接続されている他のUniFi APにメッシュで接続してくれます。</p><p>有線バックホールの一例です。</p><p>（U6 Liteを2階に設置）</p><img src="/new-technology/2022/12/31/unifi-ap/u6-lite.png" class="" width="640" title="alt"><p>コアスイッチから2階のこの部屋までは光で通し、SFP+スイッチ（usw-Aggregation)から1GbEでAPに接続しています。このスイッチにはPoE機能はないため、別途PoEアダプタを使ってAPに給電しています。</p><img src="/new-technology/2022/12/31/unifi-ap/poe.png" class="" width="640" title="alt"><p>PoEアダプタを電源に繋ぎ、LANをusw-AggregationにRJ45で接続し、POEをU6 LiteにRJ45で接続します。</p><p>（私の環境の場合）電波の弱い階段のエリアにまで電波を届かせるために出来るだけ障害物を避けるAPの配置の工夫をしました。階を移動した時にスムーズなローミングができ、ビデオ会議で相手の声がなるべく途切れない事を目的としています。</p><img src="/new-technology/2022/12/31/unifi-ap/u6-lite2.png" class="" width="640" title="alt"><p>2階の各部屋に電波を届けつつ、立体的に見て、壁と2階の床を抜ける箇所を想定し、試行錯誤しながら配置を決めていきます。</p><h2 id="UniFi-Wi-Fi設定"><a href="#UniFi-Wi-Fi設定" class="headerlink" title="UniFi Wi-Fi設定"></a>UniFi Wi-Fi設定</h2><p>ここでは、UniFiコンソールやUniFiネットワークアプリケーションが既にセットアップされている事を前提に説明します。<br>UniFiネットワークアプリケーションを最初からセットアップされる方は以下の記事を参照してください。</p><ul><li>「<a href="/new-technology/2022/08/27/ubiquiti-unifi/" title="Ubiquiti UniFiの世界">Ubiquiti UniFiの世界</a>」</li><li>「<a href="/new-technology/2022/09/23/ubuntu22-04lts/" title="Ubuntu22.04LTSをESXiにセットアップする">Ubuntu22.04LTSをESXiにセットアップする</a>」</li><li>「<a href="/new-technology/2022/09/23/unifi-network-application/" title="UniFi Network Applicationのセットアップ">UniFi Network Applicationのセットアップ</a>」</li><li>「<a href="/new-technology/2022/10/23/unifi-network-application2/" title="UniFi Network Applicationの運用">UniFi Network Applicationの運用</a>」</li></ul><p>ネットワークアプリケーションの<mark class="label primary">SETTINGS</mark>から<mark class="label primary">WiFi</mark>の画面を開くと以下の表示となります。</p><img src="/new-technology/2022/12/31/unifi-ap/wifi1.png" class="" width="640" title="alt"><p>画面上部のWiFiについては、既存のSSID一覧が表示されます。画面下部の<mark class="label primary">Global AP Settings</mark>では、複数台のAPに共通設定を指定します。</p><p>メインとなる5GHzの無線設定では、DFSのこともあり、一般的には80MHzを指定します。日本の製品ではアンテナ数で上り2、下り2として2x2という表現がされている事が多いでしょうか。スマホなど多くは80MHzになります。高性能なWiFiクライアントをお持ちの場合は160MHzも設定可能です（U6 Liteは80MHzが上限です）。</p><mark class="label primary">Transmit Power</mark>は環境に応じて、Auto、High、Medium、Low、Custom（固定数値指定）と設定できます。<p>有線バックホール無しでAPを設置する場合は、<mark class="label primary">Wireless Connectivity</mark>の<mark class="label primary">Wireless Meshing</mark>のチェックボックスをOnにします。私は普段は有線バックホールで運用していますが、U6 Proでは有線LANへ接続せずにメッシュ接続が行えました。</p><p>続いて、SSIDの設定です。</p><img src="/new-technology/2022/12/31/unifi-ap/wifi2.png" class="" width="800" title="alt"><p>SSIDの名前、パスワード、ネットワーク、そのSSIDにどのAPを参加させるかを決めます。ここでは個人向けのWi-Fiとして一般的なWPA2パーソナルまたはWPA3パーソナルを前提としています。</p><p>続いて、マニュアル設定でSSIDの詳細を設定していきます。</p><img src="/new-technology/2022/12/31/unifi-ap/wifi3.png" class="" width="480" title="alt"><img src="/new-technology/2022/12/31/unifi-ap/wifi4.png" class="" width="480" title="alt"><table><thead><tr><th>項目名</th><th>説明</th></tr></thead><tbody><tr><td>WiFi Band</td><td>2.4GHz&#x2F;5GHzを選択します。両方を有効にもできます。</td></tr><tr><td>WiFi Type</td><td>通常はStandardです。カフェのように外部にWiFiを解放する場合はGuest Hotspotを選択します。</td></tr><tr><td>Band Steering</td><td>バンドステアリング。Bandで2.4GHz、5GHzを指定した場合に設定でき、電波状態によって自動で切り替わります。</td></tr><tr><td>Bandwidth Profile</td><td>帯域制限を指定します。</td></tr><tr><td>Multicast Management</td><td>通常必要ありませんので説明は割愛します。</td></tr><tr><td>Client Device Isolation</td><td>クライアントをお互いに接続できないようにします。Guest扱い。</td></tr><tr><td>Proxy ARP</td><td>混雑している環境ではWiFiデバイスの代わりにAPが代理応答します。</td></tr><tr><td>BSS Transition</td><td>AP同士でクライアントの状況を共有します。デフォルト有効。</td></tr><tr><td>UAPSD</td><td>省電力に関するパラメータです。古いデバイスでは問題が出る場合があります。</td></tr><tr><td>Fast Roaming</td><td>Fast Roamingに対応している端末であれば有効にすべきです。逆に言えば、Fast Roamingに対応した端末専用のSSIDにすべきです。</td></tr><tr><td>802.11 DTIM Period</td><td>デフォルト有効。Autoを推奨。説明は割愛します。</td></tr><tr><td>Minimum Data Rate Control</td><td>デフォルト有効。最低通信量を定め、それを下回る場合クライアントにAP切り替えを促すはずですが、私の環境ではあまり有効に機能しません。</td></tr><tr><td>Security Protocol</td><td>WPA2、WPA3の指定をします。WPA Enterpriseを指定することでRADIUS認証（ユーザー認証）が可能です。子供が友達にWi-Fiパスワード共有することに対策したいというこだわりのある方などチャレンジされてはいかがでしょうか。QNAPのNASなどでRADIUSサーバを稼働させられます</td></tr><tr><td>PMF</td><td>保護された管理フレーム。WPA3では必須。WPA2では任意にすることも可能。必須にすると古い端末は繋がらない可能性があリます。</td></tr><tr><td>Group Rekey Interval</td><td>暗号化キーの交換を定期的に行います。デフォルトは3600秒（＝1時間）です。</td></tr><tr><td>Hide WiFi Name</td><td>使うメリットはありません。説明は割愛します。</td></tr><tr><td>MAC Address Filter</td><td>MACアドレスのホワイトリスト、ブラックリストを指定します。</td></tr><tr><td>RADIUS MAC Authentication</td><td>説明は割愛します。</td></tr></tbody></table><p>WiFi Schedulerは夜間など使わない時の時間を設定できます。私は夜間は弱い2.4GHzのみ利用し、日中使っている5GHzは止めています。</p><h2 id="AP単位の設定"><a href="#AP単位の設定" class="headerlink" title="AP単位の設定"></a>AP単位の設定</h2><p>UniFiのDevice画面の<mark class="label primary">Settings</mark>から、AP本体の設定を変更します。主にはIPアドレス、無線のチャンネルを指定します。</p><img src="/new-technology/2022/12/31/unifi-ap/u6-pro5-1.png" class="" width="360" title="alt"><p>５GHzについては、APを2つ設置するならば、メインはDFSを受けないチャンネル、サブは別のチャンネルにするとお互い競合せずに安定した電波の受信ができます。2.4GHzはChannel幅は20MHzとし、1、6、11という具合に５づつスライドさせてAP毎に電波が重ならないように設定します。AP毎に電波の出力も変更できますし、きめ細かい設定が行えるのもUniFi APの特徴です。</p><h3 id="VLAN"><a href="#VLAN" class="headerlink" title="VLAN"></a>VLAN</h3><img src="/new-technology/2022/12/31/unifi-ap/u6-pro5-2.png" class="" width="360" title="alt"><p>このAP自体が属するマネジメント用のVLANを指定します。Wi-Fi設定ではSSID毎にVLANを設定できるので、APに接続するスイッチは、マネジメントVLANを含む全てのVLAN IDを含めるようにトランクポートとして設定する必要があります。</p><p>VLANを使った設定の一例です。</p><p>デバイスの管理をデフォルトVLAN（かつネイティブVLAN）、一般端末をVLAN100、会社用・ゲストをVLAN500とした、よくある一般的なシナリオです。</p><img src="/new-technology/2022/12/31/unifi-ap/network.drawio.png" class="" width="1024" title="alt"><p>UniFIでは複数VLANのペアを作って、そのうちの１つをネイティブVLANとして指定します。この例ではマネジメントVLANをDefault（VLAN ID＝1）、かつ、ネイティブVLAN（タグ無し）としています。会社のPCやゲスト用端末はClient Device IsolationをEnableにして互いの機器の通信を拒否します。スイッチ間のトランクポートは必ず通信するVLAN IDのタグを含めてあげる必要があります。</p><h2 id="APのファームウェア"><a href="#APのファームウェア" class="headerlink" title="APのファームウェア"></a>APのファームウェア</h2><p>UniFi APの最新のOfficialのファームウェアは、ローミングの切り替わりが安定しないように見えますが、現在リリース候補となっている、6.5.40は遅延の少ないローミングが成功しているように見えます。また、Wi-Fi6Eに対応したU6 Enterpriseもいよいよ発売されるようです。</p><h2 id="通知機能"><a href="#通知機能" class="headerlink" title="通知機能"></a>通知機能</h2><p>通知はUniFiコンソールまたはUniFiネットワークアプリケーションの機能ですが、APに関して通知機能は以下の通りです。</p><img src="/new-technology/2022/12/31/unifi-ap/wifi5.png" class="" width="800" title="alt"><p>DFSを受信した時にアラートが受けられるのと、自宅付近に同じSSIDを持つAPを発見した場合通知してくれます。特に後者はセキュリティ上有用です。これは試験的にUniFi以外のAPを同じSSIDで起動して検知させています。</p><img src="/new-technology/2022/12/31/unifi-ap/wifi6.png" class="" width="360" title="alt"><p>通知はメールとスマホアプリと2種類あり、選択できます。<mark class="label primary">Hotspot Client Connection Change</mark>は、端末の接続&#x2F;切断を検知したり、ローミングの切り替わり状況を通知してくれます。家族の自宅への出入りも把握できます。ただし、通知数が多くなるので、メール通知は避け、アプリ通知にした方が良さそうです。本来の趣旨は知らないMACアドレスからの接続があった時に検知するものです。</p><p>これらの機能はハイブリッドクラウド機能を持つUniFi製品の特徴ですが、これらが無償で利用できるというのは本当にありがたい存在です。</p><h2 id="リソース"><a href="#リソース" class="headerlink" title="リソース"></a>リソース</h2><p>以下の日本語ヘルプ、コミュニティがUniFiの構築には大いに参考になります。</p><blockquote><p>Ubiquiti コミュニティ（日本）<br> <a href="https://www.facebook.com/groups/uijapan">https://www.facebook.com/groups/uijapan</a></p></blockquote><blockquote><p>UI 日本語ヘルプ記事<br> <a href="https://help.jp.ui.com/categories/6583256751383/">https://help.jp.ui.com/categories/6583256751383/</a></p></blockquote><blockquote><p>Ubiquiti Community（米国中心）<br> <a href="https://community.ui.com/">https://community.ui.com/</a></p></blockquote>]]></content>
    
    
    <summary type="html">&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;

&lt;p&gt;この記事ではホームユーザー向けにUniFi AP(Wi-Fiアクセスポイント）の設定ができるようになることを目的としています。&lt;/p&gt;</summary>
    
    
    
    <category term="Hardware" scheme="https://yoshi0808.github.io/new-technology/categories/Hardware/"/>
    
    <category term="Network" scheme="https://yoshi0808.github.io/new-technology/categories/Network/"/>
    
    
    <category term="UniFi" scheme="https://yoshi0808.github.io/new-technology/tags/UniFi/"/>
    
  </entry>
  
  <entry>
    <title>Sophos Firewall v19.5</title>
    <link href="https://yoshi0808.github.io/new-technology/2022/12/03/xg-v195/"/>
    <id>https://yoshi0808.github.io/new-technology/2022/12/03/xg-v195/</id>
    <published>2022-12-02T15:01:00.000Z</published>
    <updated>2022-12-11T10:16:39.000Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2022/12/03/xg-v195/title.png" class="" title="alt"><h2 id="Sophos-Firewall-v19-5"><a href="#Sophos-Firewall-v19-5" class="headerlink" title="Sophos Firewall v19.5"></a>Sophos Firewall v19.5</h2><p>Sophos Firewall v19.5が2022年11月16日に発表されました。</p><span id="more"></span><h2 id="主なエンハンスの内容"><a href="#主なエンハンスの内容" class="headerlink" title="主なエンハンスの内容"></a>主なエンハンスの内容</h2><ul><li>SD-WAN Load Balancingの強化</li><li>OSPFv3 (IPv6)の対応</li></ul><p>ホームユーザーにはあまり関係しない機能でしょうか。</p><p>v19.5の詳細な説明はSophos Communityを参照してください。</p><blockquote><p><a href="https://community.sophos.com/sophos-xg-firewall/b/blog/posts/sophos-firewall-v195-is-now-available">https://community.sophos.com/sophos-xg-firewall/b/blog/posts/sophos-firewall-v195-is-now-available</a></p></blockquote><h2 id="Sophos-Firewallのアップデート"><a href="#Sophos-Firewallのアップデート" class="headerlink" title="Sophos Firewallのアップデート"></a>Sophos Firewallのアップデート</h2><p>XGの管理画面にログイン後、左ペインメニューの<mark class="label primary">バックアップ＆ファームウェア</mark>の<mark class="label primary">ファームウェアの確認</mark>ではただちに全てのユーザーにアップデートの案内が来るわけでは無いので、アップデートにはMySophosにログインし、バージョンアップの差分モジュールをダウンロードします。</p><ol><li>Sophosのサイトの右上のプルダウンメニューから、<mark class="label primary">ライセンスとアカウント</mark>をクリックします。<blockquote><p><a href="https://www.sophos.com/ja-jp.aspx">https://www.sophos.com/ja-jp.aspx</a></p></blockquote></li><li>Sophos IDをお持ちでなければIDを作成します。</li><li>ログイン後、<mark class="label primary">Network Protection</mark>をクリックします。</li><li><mark class="label primary">ファームウェアの更新</mark>をクリックします。</li><li>「製品名&#x2F;OSを使った検索」で”ファイアーウォール”を選択し、その後現れるプルダウンは”ソフトウェア”を選択します。</li><li><mark class="label primary">選択可能なダウンロードを表示</mark>ボタンをクリックします。</li></ol><img src="/new-technology/2022/12/03/xg-v195/mysophos.png" class="" width="800" title="alt"><ol><li>上記画面で”SW-19.5.0_GA.SFW-197.sig”というアップデータが表示されますのでダウンロードします。</li><li>MY Sophosはここで終了してXGの管理画面にログインし、左ペインメニューの<mark class="label primary">バックアップ＆ファームウェア</mark>の<mark class="label primary">ファームウェアのタブメニュー</mark>から以下の画面に赤丸で囲った矢印のアイコンをクリックし、ダウンロードしたモジュールをアップロードします。</li></ol><p>アップロード＆再起動ボタンをクリックし、v19.5へのアップグレードを完了させます。</p><div class="note info"><p>仮想環境（ESXi）上にFirewallをインストールされている方はアップグレードの前に、「<a href="/new-technology/2020/10/11/esxi-backup/" title="VMware ESXiの仮想マシンをバックアップする">VMware ESXiの仮想マシンをバックアップする</a>」を参考に、バックアップを確保される事をお勧めします。</p></div><p>Relase Notesを見るとセキュリティ観点ではOpenSSL (CVE-2022-1292)の脆弱性対応が行われています。他にもかなりの数の不具合が修正されていますが、コメントがサラッとしており、どういう事象なのかまでは判明しないものが多いようです。</p><p>IPSec-VPN、SSL&#x2F;TLSインスペクション、マルウェアチェック（EICAR Testファイル）などを検証し、2週間程度運用していますが、スループット含めて特段の問題は見つかっていません。</p><p>（2022-12-11追記）<br>SophosからSophos Firewallのv19以前の脆弱性について12-06にレポートが公開されています。<br>以下の脆弱性に対応したものであり、v19以前のユーザーはv19.5にアップグレードが必要との事です。<br>CVE-2022-3236<br>CVE-2022-3226<br>CVE-2022-3713<br>CVE-2022-3696<br>CVE-2022-3709<br>CVE-2022-3711<br>CVE-2022-3710</p><blockquote><p>Sophos Firewall v19.5 GA Resolves Security Vulnerabilities<br> <a href="https://www.sophos.com/en-us/security-advisories/sophos-sa-20221201-sfos-19-5-0">https://www.sophos.com/en-us/security-advisories/sophos-sa-20221201-sfos-19-5-0</a></p></blockquote><p>大幅に機能が更新されていないにも関わらず、v19からv19.5となり、リリースノートでの表現も控え目で何が変わったのか良くわかりませんでしたが結局のところ脆弱性の対応が中心ということですね。</p><p>私は「<a href="/new-technology/2020/06/24/protect-xg/" title="XG Firewall自身を防御する">XG Firewall自身を防御する</a>」の記事で、そもそもFirewall自身を守るためのセキュアな設定が必要と記載しており、パッチやバージョンアップを速やかに実施することも必要ですが、セキュアな環境のために追加の設定をお勧めしています。</p><p>過去からの経緯を見ていると、v18で大きくアーキテクチャが変更になったものの、管理画面を中心とした機能は大きな変更が行われていません。過去からの脆弱性、特にUI周りのクロスサイトスクリプティング、およびDBアクセス機能におけるSQLインジェクションのサニタイズが不十分であり、指摘されては都度修正しているという活動を繰り返しているように見えます。<br>ユーザー側の自主的な防御として、余計な機能はインターネット向けには提供しない事をお勧めします。つまりSophos Firewallの管理画面や入力項目を持つユーザーポータルはLANからのアクセスのみに限定すべきで、WAN、DMZはもちろん、可能であればVPNからもアクセス不可にしておく事をお勧めします。今回のエンハンスでSQLインジェクションなどが全て撲滅されたかどうかは不明です。</p><img src="/new-technology/2022/12/03/xg-v195/manage.png" class="" width="1024" title="alt">]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2022/12/03/xg-v195/title.png&quot; class=&quot;&quot; title=&quot;alt&quot;&gt;

&lt;h2 id=&quot;Sophos-Firewall-v19-5&quot;&gt;&lt;a href=&quot;#Sophos-Firewall-v19-5&quot; class=&quot;headerlink&quot; title=&quot;Sophos Firewall v19.5&quot;&gt;&lt;/a&gt;Sophos Firewall v19.5&lt;/h2&gt;&lt;p&gt;Sophos Firewall v19.5が2022年11月16日に発表されました。&lt;/p&gt;</summary>
    
    
    
    <category term="Security" scheme="https://yoshi0808.github.io/new-technology/categories/Security/"/>
    
    
    <category term="XG Firewall" scheme="https://yoshi0808.github.io/new-technology/tags/XG-Firewall/"/>
    
  </entry>
  
  <entry>
    <title>UniFiスイッチ</title>
    <link href="https://yoshi0808.github.io/new-technology/2022/11/23/unifi-switch/"/>
    <id>https://yoshi0808.github.io/new-technology/2022/11/23/unifi-switch/</id>
    <published>2022-11-22T15:00:00.000Z</published>
    <updated>2023-04-15T03:33:51.850Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2022/11/23/unifi-switch/title.png" class="" width="1024" title="alt"><p class="onepoint">この記事で実現すること</p><p>この記事ではホームユーザー向けにUniFiスイッチの設定ができるようになることを目的としています。</p><span id="more"></span><h2 id="UniFiスイッチの特徴"><a href="#UniFiスイッチの特徴" class="headerlink" title="UniFiスイッチの特徴"></a>UniFiスイッチの特徴</h2><p>UniFiネットワークスイッチの特徴としては、どちらかといえばスモールビジネス向けの製品が中心ではあります。<br>スモールオフィスの基幹ネットワークを構成しながら、監視カメラやWi-Fiシステムを導入し、トータルソリューションが売りになります。<br>ネットワークスイッチ単独の機能として見ると、以下の特徴があります。</p><ol><li>Wi-FiにRJ45ケーブルで通信と電力出力を兼ねるPoE</li><li>SFP＋などの10GbEネットワーク</li><li>UniFiネットワークアプリケーションによる集中管理</li></ol><p>ホームユーザー向けとして自宅内のネットワークを10GbEかつSFP+を選択する場合は、いくつかの魅力的なネットワークスイッチが候補に上がります。<br>発熱対策のために各部屋にSFP+でOM3などの光ケーブルを通す場合は、個人向けのネットワークスイッチではPortが不足してしまうのが実態です。<br>機器の価格帯が個人向け、かつ消去法でいくとMikroTikかUniFiが選択肢に上がります。円安で昔ほどは安いと思えなくなりましたが、SFP+スイッチは廉価です。</p><h2 id="基本設定"><a href="#基本設定" class="headerlink" title="基本設定"></a>基本設定</h2><p>基本設定です。UniFiスイッチを新規導入する際には、ネットワークアプリケーションに登録（採用）する必要があります。初期セットアップについては、以下の記事を参照してください。UniFi製品群の標準の考え方ではセキュリティゲートウェイをインターネットルーターの役割として配置し、そこに各UniFi製品群をぶら下げることになります。私はSophos Firewallを利用しており、UniFiセキュリティゲートウェイは不要としているため、集中管理のためのUniFiネットワークアプリケーションを導入しています。</p><ul><li><a href="/new-technology/2022/08/27/ubiquiti-unifi/" title="Ubiquiti UniFiの世界">Ubiquiti UniFiの世界</a></li><li><a href="/new-technology/2022/09/23/unifi-network-application/" title="UniFi Network Applicationのセットアップ">UniFi Network Applicationのセットアップ</a></li><li><a href="/new-technology/2022/10/23/unifi-network-application2/" title="UniFi Network Applicationの運用">UniFi Network Applicationの運用</a></li></ul><p>UniFiスイッチが採用（Adoption）されると、ネットワークアプリケーションから管理できるようになります。</p><p>スイッチ毎の<mark class="label primary">Settings</mark>では、<mark class="label primary">Service</mark>で基本設定を、<mark class="label primary">Network</mark>でIPアドレスを設定できます。</p><img src="/new-technology/2022/11/23/unifi-switch/netapp2.png" class="" width="360" title="alt"><mark class="label primary">Service</mark>では、スイッチ自身がどのネットワーク（VLAN）に属するのかを決め、Flow ControlやJumbo Frameの設定が可能です。デフォルトでFlow ControlはOffです。ネットワーク速度が異なる端末を接続する場合は、Flow ControlはOnの方が良いでしょう。もちろん、送信側端末のネットワークカードがFlow Controlに対応している必要はあります。最近、UniFiネットワークアプリケーションではスイッチのGlobalSettingが可能となり、スイッチ毎にこれらの設定が不要になっています。<img src="/new-technology/2022/11/23/unifi-switch/netapp3.png" class="" width="360" title="alt"><mark class="label primary">Network</mark>では、静的IPアドレスを設定することもできます。<p>その他、<mark class="label primary">Settings</mark>からは、スイッチの再起動が可能です。</p><h2 id="スイッチポート確認"><a href="#スイッチポート確認" class="headerlink" title="スイッチポート確認"></a>スイッチポート確認</h2><p>スイッチ毎の<mark class="label primary">Ports</mark>からはPortの稼働状況が確認できます。</p><img src="/new-technology/2022/11/23/unifi-switch/netapp4.png" class="" width="360" title="alt"><table><thead><tr><th>項目名</th><th>内容</th></tr></thead><tbody><tr><td>Status</td><td>実際に接続されている速度を示します。稀にファームウェアのアップデートのタイミングで誤った認識になる場合があります</td></tr><tr><td>Tx&#x2F;Rx</td><td>送信(Tx)、受信(Rx)量を示します</td></tr><tr><td>Profile</td><td>UniFiのVLANは複数のネットワークを指定した上で纏めたトランクポートを複数種類作成可能です。私の環境の一例では、管理用LAN（タグ無し※デフォルトVLAN）、家族用VLAN、ゲスト用VLAN（会社向けやIoTなどのゲストネットワーク）を1つに束ねて上流スイッチから接続しています。</td></tr><tr><td>Uplink</td><td>上流の機器を示します。UniFiがInternetへのルーティングを解析し、Internet接続ルーターを上流として自動的にUplinkポートを判別します</td></tr></tbody></table><p>その他、SFPモジュールの情報などが出力されています。</p><h2 id="スイッチポート設定"><a href="#スイッチポート設定" class="headerlink" title="スイッチポート設定"></a>スイッチポート設定</h2><p>スイッチ毎の<mark class="label primary">Ports</mark>からさらに<mark class="label primary">Port Management</mark>を選択すると、個々のPortの設定を行えます。</p><img src="/new-technology/2022/11/23/unifi-switch/netapp5.png" class="" width="1024" title="alt"><p>これはPro-Aggregationの例ですが、Portごとに接続されているクライアントが表示されています。ここで個別のPortを選択すると、ポートの速度やVLANを設定できます。</p><h3 id="Portの設定変更"><a href="#Portの設定変更" class="headerlink" title="Portの設定変更"></a>Portの設定変更</h3><p>Portの物理的な設定変更は以下の<mark class="label primary">Port Profile Override</mark>から行います。</p><img src="/new-technology/2022/11/23/unifi-switch/netapp7.png" class="" width="360" title="alt"><table><thead><tr><th>項目名</th><th>内容</th></tr></thead><tbody><tr><td>Operation</td><td>Switching または、Aggregate（複数のPortを束ねて帯域を増やす）、Mirrorを選択します。</td></tr><tr><td>Link Speed</td><td>オートネゴ、10Gbps、2.5Gbpsなどの速度固定を選択します。なお、2.5Gはオートネゴでは動作しません</td></tr><tr><td>Port Isolation</td><td>Uplinkポートのみトラフィックを転送します</td></tr><tr><td>Storm Control</td><td>ブロードキャスト、マルチキャストなどの飽和を某防止します</td></tr><tr><td>LLDP</td><td>ディスカバリプロトコルを有効にします（デフォルトON）</td></tr><tr><td>Spanning Tree Protocol</td><td>スパニングツリーを有効にします（デフォルトON）</td></tr></tbody></table><p>ミラーPortはトラブル時の確認のために使います。トラブルのあるPort番号を指定し、ミラーに設定することで同じデータが流れます。ノートPCなどを接続し、WireSharkなどを使いパケット解析します。</p><p>SFP+の製品であっても、USW-AggregationスイッチやUSW-Enterprise-8-PoEのSFP+ポートは2.5GbEに対応していません。過去記事「<a href="/new-technology/2022/07/30/sfp-plus-nbaset/" title="SFP+の2.5GbE対応">SFP+の2.5GbE対応</a>」で書いたように、10GbEを2.5GbEとして偽装させる特殊なSFP+モジュールが必要になります（もっとも、USW-Enterprise-8-PoEは2.5GbEのRJ45ポートを備えているので運用上困ることはありませんが）。</p><h2 id="VLANを設定"><a href="#VLANを設定" class="headerlink" title="VLANを設定"></a>VLANを設定</h2><p>VLANを作成するにはネットワークアプリケーションの<mark class="label primary">SETTINGS</mark>から<mark class="label primary">NETWORKS</mark>を選択し、<mark class="label primary">Create New Network</mark>をクリックします。</p><p>L3スイッチではなく、単にVLANを作成したい場合は、ここで<mark class="label primary">VLAN-only Network</mark>のチェックボックスをONにし、VLAN IDを決定します。</p><img src="/new-technology/2022/11/23/unifi-switch/netapp8.png" class="" width="360" title="alt"><p>こういったネットワーク構成全般の変更を行うと、全てのスイッチに対してコンフィグの転送が行われ、スイッチの再構成が実行されます。</p><p>トランクポートとして使うのであれば予め作成した複数のネットワークを束ねたProfileを作成した上でそれを指定します。<br>Profile作成時には指定する複数のネットワークのうちどれか1つをネイティブVLANとしてタグ無しに設定します。昨今、デフォルトVLANを変えることがセキュリティ上優位であるとも思えないので、私は管理用VLANは無条件にデフォルトVLAN（VLAN ID&#x3D;1）で管理するようにしています。</p><img src="/new-technology/2022/11/23/unifi-switch/netapp6.png" class="" width="1024" title="alt"><p>ProfileではこのようにネイティブVLANがどのネットワークか定め、タグ付きのVLANを追加で選択していきます。この例では、 UniFi-APはデフォルトVLANで接続し、AP同士の制御用パケットは全てデフォルトVLAN配下に流れます。また、タグ付きネットワークでVLAN-XXX（一般端末向け）とGuestがありますが、UniFi-APは複数のネットワークに属することができますので1つのAPで複数のネットワークに対してWi-Fiサービス提供できるようになります。</p><p>ネットワーク機器のLANをデフォルトVLAN、かつ、ネイティブVLAN（タグ無し）としているのは何らかのトラブル時に復旧させやすいという点もあります。</p><p>なお、SFP＋のインタフェースを持つFirewallなどの機器からホームゲートウェイ(HGW)などRJ45を持つ機器に接続するときにはインタフェースの変換が必要となります。スイッチを2Port、LANとは異なるVLANネットワークにし、RJ45 SFP+モジュールを使うことでインタフェースの変換に使うのもVLANの一つの活用方法です。上記の例ではHGWという名前のVLANを作成し、auひかりから提供されるHGWのRJ45ポートから、スイッチのPort26（RJ45モジュール）へ、FirewallのWAN（SFP＋）をスイッチのPort22へ接続し、実質メディアコンバーターとして使っています。</p><p>SFP+のネットワークカード（NIC）に10GbEのRJ45モジュールを使う事はお勧めしません。電力不足によりリンクアップしなかったり2.5Gbpsでリンクアップするなどの事象が発生する場合があります。また、モジュールの発熱によるNICの故障の原因になります。</p><p>スイッチを最初にAdoptした時はPortのプロファイルは”All”となっています。これはネイティブVLANおよび全てのタグ付きVLANを転送するモードです。VLANを設定しないならProfileはALLのままで使っても構いません。</p><h2 id="SSH"><a href="#SSH" class="headerlink" title="SSH"></a>SSH</h2><p>UniFiスイッチは廉価なSwitch Flex Miniを除き、大半のスイッチはSSH接続が可能です。ネットワークアプリケーションで設定したID&#x2F;パスワードでも接続できますし、公開鍵認証でも接続可能です。スイッチにSSHすると Linuxのインタフェースのように見えます。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">$ ssh xxx</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BusyBox v1.25.1 () built-in shell (ash)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  ___ ___      .__________.__</span><br><span class="line"> |   |   |____ |__\_  ____/__|</span><br><span class="line"> |   |   /    \|  ||  __) |  |   (c) 2010-2022</span><br><span class="line"> |   |  |   |  \  ||  \   |  |   Ubiquiti Inc.</span><br><span class="line"> |______|___|  /__||__/   |__|</span><br><span class="line">            |_/                  https://www.ui.com</span><br><span class="line"></span><br><span class="line">      Welcome to UniFi USW-Aggregation!</span><br><span class="line"></span><br><span class="line">********************************* NOTICE **********************************</span><br><span class="line">* By logging <span class="keyword">in</span> to, accessing, or using any Ubiquiti product, you are     *</span><br><span class="line">* signifying that you have <span class="built_in">read</span> our Terms of Service (ToS) and End User   *</span><br><span class="line">* License Agreement (EULA), understand their terms, and agree to be       *</span><br><span class="line">* fully bound to them. The use of SSH (Secure Shell) can potentially      *</span><br><span class="line">* harm Ubiquiti devices and result <span class="keyword">in</span> lost access to them and their data. *</span><br><span class="line">* By proceeding, you acknowledge that the use of SSH to modify device(s)  *</span><br><span class="line">* outside of their normal operational scope, or <span class="keyword">in</span> any manner             *</span><br><span class="line">* inconsistent with the ToS or EULA, will permanently and irrevocably     *</span><br><span class="line">* void any applicable warranty.                                           *</span><br><span class="line">***************************************************************************</span><br><span class="line"></span><br><span class="line">USW-Aggregation-US.6.3.13<span class="comment"># cd /var/log</span></span><br><span class="line">USW-Aggregation-US.6.3.13<span class="comment"># vi messages</span></span><br><span class="line">USW-Aggregation-US.6.3.13<span class="comment"># ping 192.168.x.100</span></span><br><span class="line">PING 192.168.x.100 (192.168.x.100): 56 data bytes</span><br><span class="line">64 bytes from 192.168.x.100: <span class="built_in">seq</span>=0 ttl=64 time=0.000 ms</span><br><span class="line">64 bytes from 192.168.x.100: <span class="built_in">seq</span>=1 ttl=64 time=10.000 ms</span><br><span class="line">64 bytes from 192.168.x.100: <span class="built_in">seq</span>=2 ttl=64 time=10.001 ms</span><br><span class="line">64 bytes from 192.168.x.100: <span class="built_in">seq</span>=3 ttl=64 time=10.000 ms</span><br><span class="line">64 bytes from 192.168.x.100: <span class="built_in">seq</span>=4 ttl=64 time=10.001 ms</span><br></pre></td></tr></table></figure><p><code> /var/log/messages</code>にはsyslogがありますので、たまには中身を確認されることをお勧めします（viコマンドなどで開きます）。表向き、SFPモジュールが動作しているように見えても、互換性の問題でエラーを吐いている場合もあります。ダイレクトアタッチケーブルなどを対向の端末を繋がずスイッチに接続している場合など定期的にLinkDownのアラートが出ている場合もあります。RJ45とは動きは異なります。</p><p>上記はUSW-Aggregationに接続した状態ですが、pingも動作しますが、レスポンスは悪いです。LAN内の機器の応答に10ms掛かっていますが驚かないでください。スイッチのデータ転送は専用チップ（ASIC）が行うため、機器のCPUがスイッチの実力にはなりません。OSに割り当てるCPUリソースの関係でしょうか、このpingの応答速度は「ご参考」として割り切った方が良さそうです。</p><h3 id="スイッチの詳細情報について"><a href="#スイッチの詳細情報について" class="headerlink" title="スイッチの詳細情報について"></a>スイッチの詳細情報について</h3><p>Linuxのコンソールから、<code>cli</code>コマンドを投入することで、Ciscoライクなスイッチのコマンドモードに入ることができます。<br>コマンド入力途中でタブを押下するとコマンドが補完されます。<br><code>show  running-config</code>などそのまま使えます。<code>copy running-config startup-config</code>なども実行できそうですが、UniFiではネットワークアプリケーションから完全同期されていることが大前提であり、コマンドモードで設定しても再起動時にはネットワークアプリケーションから上書きされてしまいます。<br>ややこしいのは、スイッチ毎にコマンドの互換性が殆どないことです。コマンドの途中で<code>&quot;？&quot;</code>を入力すると、実行できるパラメータが列挙されるので推測でコマンドを補完しながら入力することになります。私の知る限り、機種毎のコマンドラインのマニュアルは存在しないようです。</p><h3 id="USW-Pro-Aggregation-L3スイッチ"><a href="#USW-Pro-Aggregation-L3スイッチ" class="headerlink" title="USW-Pro-Aggregation(L3スイッチ)"></a>USW-Pro-Aggregation(L3スイッチ)</h3><p>このスイッチは比較的コマンドが充実しています。<code>cli</code>でコマンドモードに入り、<code>en</code>で特権モードに入ります。<br>Portの状況を見るには以下のコマンドを使います。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(UBNT) #show interface ethernet 0/x</span><br></pre></td></tr></table></figure><p>これだと100行余りの結果が表示されるのでパイプ（｜）で区切り、必要な項目だけフィルタできます。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">(UBNT) #show interface ethernet 0/x | include Error|Collision|Discard</span><br><span class="line"></span><br><span class="line">Total Packets Received Without Errors.......... 43388669</span><br><span class="line">Receive Packets Discarded...................... 0</span><br><span class="line">Total Packets Received with MAC Errors......... 0</span><br><span class="line">Alignment Errors Received...................... 0</span><br><span class="line">FCS Errors Received............................ 0</span><br><span class="line">URPF Discards.................................. 0</span><br><span class="line">Transmit Packets Discarded..................... 0</span><br><span class="line">Total Transmit Errors.......................... 0</span><br><span class="line">FCS Errors Transmitted......................... 0</span><br><span class="line">Total Transmit Packets Discarded............... 0</span><br><span class="line">Single Collision Frames........................ 0</span><br><span class="line">Multiple Collision Frames...................... 0</span><br><span class="line">Excessive Collision Frames..................... 0</span><br><span class="line"></span><br><span class="line">(UBNT) #</span><br></pre></td></tr></table></figure><p>このようにして重要な情報のみ取得できます。あくまで一般的なパラメータとしていますが、現代の全二重の通信前提であればCollisionまで見る必要はないですね。一般的にはReceiveでエラーがあるときはケーブルを最初に疑ってみること、Transmit Packets Discardedの場合はVLANの設定が間違っている可能性があることでしょうか。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clear counters all</span><br></pre></td></tr></table></figure><p>カウンタをクリアします。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show fiber-ports optics-info all</span><br></pre></td></tr></table></figure><p>モジュールのメーカーやシリアル番号を表示します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">(UBNT) #show fiber-ports optics all</span><br><span class="line"></span><br><span class="line">                                                 Output   Input</span><br><span class="line">Port    Physical Port/  Temp  Voltage  Current   Power    Power     TX     LOS</span><br><span class="line">        Lane Number     [C]   [Volt]     [mA]    [dBm]    [dBm]     Fault</span><br><span class="line">------  --------------  ----  -------  -------   -------  -------   -----  ---</span><br><span class="line">0/4     0/4-Lane1       34.2    3.328     10.2    -3.370   -2.496   No     No</span><br><span class="line">0/5     0/5-Lane1       34.5    3.265     10.4    -2.976   -3.373   No     No</span><br><span class="line">0/8     0/8-Lane1       34.0    3.360     10.2    -3.799   -1.643   No     No</span><br><span class="line">0/9     0/9-Lane1        N/A      N/A      N/A       N/A      N/A   N/A    N/A</span><br><span class="line">0/12    0/12-Lane1       N/A      N/A      N/A       N/A      N/A   N/A    N/A</span><br><span class="line">0/15    0/15-Lane1       N/A      N/A      N/A       N/A      N/A   N/A    N/A</span><br><span class="line">0/18    0/18-Lane1       N/A      N/A      N/A       N/A      N/A   N/A    N/A</span><br><span class="line">0/19    0/19-Lane1       N/A      N/A      N/A       N/A      N/A   N/A    N/A</span><br><span class="line">0/22    0/22-Lane1       N/A      N/A      N/A       N/A      N/A   N/A    N/A</span><br><span class="line">0/26    0/26-Lane1      33.3    3.235      6.0    -3.002   -3.002   No     No</span><br><span class="line"></span><br><span class="line"> Temp - Internally measured transceiver temperatures.</span><br><span class="line"> Voltage - Internally measured supply voltage.</span><br><span class="line"> Current - Measured TX bias current.</span><br><span class="line"> Output Power - Measured optical output power relative to 1mW.</span><br><span class="line"> Input Power - Measured optical power received relative to 1mW.</span><br><span class="line"> TX Fault - Transmitter fault.</span><br><span class="line"> LOS - Loss of signal.</span><br><span class="line"></span><br><span class="line">(UBNT) #</span><br></pre></td></tr></table></figure><p>モジュールのDDM（温度、光の強さ）を表示します。</p><h3 id="USW-Aggregation-SFP-8Port"><a href="#USW-Aggregation-SFP-8Port" class="headerlink" title="USW-Aggregation(SFP+ 8Port)"></a>USW-Aggregation(SFP+ 8Port)</h3><p>このスイッチは<code>cli</code>でコマンドモードに入ったら、すぐに大半のコマンドが実行できます。代表的なのは以下のものです。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show interfaces TenGigabitEthernet x</span><br></pre></td></tr></table></figure><p>Port xのPort状況を表示します。パケットカウントやコリジョンなどの数を示します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clear interfaces TenGigabitEthernet  x counters</span><br></pre></td></tr></table></figure><p>Port xのカウンタをクリアします。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show fiber-transceiver-info interfaces  TenGigabitEthernet  x</span><br></pre></td></tr></table></figure><p>SFPモジュールの種類やシリアル番号を表示します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show fiber-transceiver interfaces  TenGigabitEthernet x</span><br></pre></td></tr></table></figure><p>SFPモジュールのDDM（信号の強さ、温度）を示します。</p><h2 id="L3スイッチの制約"><a href="#L3スイッチの制約" class="headerlink" title="L3スイッチの制約"></a>L3スイッチの制約</h2><p>UniFiのL3スイッチはDHCP機能を持ちますが、管理機能やルーティングについてはIPv6には対応していません。スイッチ自身はIPv6アドレスを持てるようですが、現段階でIPv6のL3ルーティングできるようにはなっていません。別のルーターでDHCPv6を割り当て、そちらをゲートウェイにするなどが必要です。L2スイッチを含めてIPv6通信が行えないということではありません。</p><h2 id="SFPモジュール"><a href="#SFPモジュール" class="headerlink" title="SFPモジュール"></a>SFPモジュール</h2><p>Ubiquitiのモジュール群は廉価なため、光モジュールは純正が間違いないでしょう。OM3ケーブルやDACはさまざまなメーカーのものを使いましたが、UniFi製品で問題が発生したことはありません。RJ45モジュールは特に10GbEのものは低電力を踏まえるとSFPメーカーの製品の選定も視野に入ります。</p><img src="/new-technology/2022/11/23/unifi-switch/module.png" class="" width="640" title="alt"><p>1GbE tp-link TL-SM331<br>一般的なMarvell社88E1111などを使ったモジュールが通常使用（Typical）で1.05Wの消費電力なのに対し、その半分以下の0.5Wとなっており、発熱もかなり抑えられています。最近、国内でも発売になったようですが、私は今年の5月に米Amazonで$19.99で購入し、問題なく使えています。</p><blockquote><p>tp-link<br> <a href="https://www.tp-link.com/jp/service-provider/switch-accessory/tl-sm331t/">https://www.tp-link.com/jp/service-provider/switch-accessory/tl-sm331t/</a></p></blockquote><p>10GbE Fiber mall SFP-10G-T-UB-80m<br>80mまで対応した省電力の10GbEモジュールです。こちらも米Amazonで購入しました。＄68.99でした。BroadcomのBCM84891のチップを採用している80mに対応したモジュールはいくつか存在します。Cisco用のモジュール（SFP-10G-TS80）についてはメーカーの公表ではDDMに対応していないと記載があるものの、UniFiスイッチ上では、モジュールの温度などのパラメータが出力されています。</p><blockquote><p>Fiber mall<br> <a href="https://www.fibermall.com/ja/news/10g-copper-sfp.htm">https://www.fibermall.com/ja/news/10g-copper-sfp.htm</a></p></blockquote><p>英語ですが、ぜひAmazonのカスタマーレビューを見てください。より詳細で素晴らしい知見に基づいたコメントが見られます。</p><blockquote><p>米Amazon Customer Review<br> <a href="https://www.amazon.com/gp/customer-reviews/RLHW2OL4I1QZP/ref=cm_cr_dp_d_rvw_ttl?ie=UTF8&amp;ASIN=B0B18BY1XK">https://www.amazon.com/gp/customer-reviews/RLHW2OL4I1QZP/ref=cm_cr_dp_d_rvw_ttl?ie=UTF8&amp;ASIN=B0B18BY1XK</a></p></blockquote><h2 id="PoE"><a href="#PoE" class="headerlink" title="PoE"></a>PoE</h2><p>スイッチにおけるPoEもネットワークアプリケーションから設定できます。USW-Enterprise-8-PoEの例では、Switch Flex MiniおよびAPのU6 Proに給電している状況が確認できます。</p><img src="/new-technology/2022/11/23/unifi-switch/netapp9.png" class="" width="640" title="alt"><p>Port ManagementからPoEのOn&#x2F;Offが可能となっています。</p><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>これらのように、ネットワークスイッチをただ単に繋げるための道具ではなく、ITやネットワークを見える化するという目的においては非常に有用な機器になります。セキュリティ観点ではできることは限られていますが、ホームユーザーにとっても有用な機能は活用できると思われます。</p><p>Ubiquiti 日本語ガイドのスイッチに関する記事は以下が参考になります。</p><blockquote><p>UniFi Network - 有線ネットワーク速度の最適化<br> <a href="https://help.jp.ui.com/articles/6949005136919/">https://help.jp.ui.com/articles/6949005136919/</a></p></blockquote><h2 id="リソース"><a href="#リソース" class="headerlink" title="リソース"></a>リソース</h2><p>以下の日本語ヘルプ、コミュニティがUniFiの構築には大いに参考になります。</p><blockquote><p>Ubiquiti コミュニティ（日本）<br> <a href="https://www.facebook.com/groups/uijapan">https://www.facebook.com/groups/uijapan</a></p></blockquote><blockquote><p>UI 日本語ヘルプ記事<br> <a href="https://help.jp.ui.com/categories/6583256751383/">https://help.jp.ui.com/categories/6583256751383/</a></p></blockquote><blockquote><p>Ubiquiti Community（米国中心）<br> <a href="https://community.ui.com/">https://community.ui.com/</a></p></blockquote>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2022/11/23/unifi-switch/title.png&quot; class=&quot;&quot; width=&quot;1024&quot; title=&quot;alt&quot;&gt;
&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;

&lt;p&gt;この記事ではホームユーザー向けにUniFiスイッチの設定ができるようになることを目的としています。&lt;/p&gt;</summary>
    
    
    
    <category term="Hardware" scheme="https://yoshi0808.github.io/new-technology/categories/Hardware/"/>
    
    <category term="Network" scheme="https://yoshi0808.github.io/new-technology/categories/Network/"/>
    
    
    <category term="SFP+" scheme="https://yoshi0808.github.io/new-technology/tags/SFP/"/>
    
    <category term="10GbE" scheme="https://yoshi0808.github.io/new-technology/tags/10GbE/"/>
    
    <category term="UniFi" scheme="https://yoshi0808.github.io/new-technology/tags/UniFi/"/>
    
  </entry>
  
  <entry>
    <title>UniFi Network Applicationの運用</title>
    <link href="https://yoshi0808.github.io/new-technology/2022/10/23/unifi-network-application2/"/>
    <id>https://yoshi0808.github.io/new-technology/2022/10/23/unifi-network-application2/</id>
    <published>2022-10-23T01:38:49.000Z</published>
    <updated>2023-04-15T03:26:30.506Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2022/10/23/unifi-network-application2/unifi1.png" class="" width="1024" title="alt"><p class="onepoint">この記事で実現すること</p><p>前回記事「<a href="/new-technology/2022/09/23/unifi-network-application/" title="UniFi Network Applicationのセットアップ">UniFi Network Applicationのセットアップ</a>」では、UniFi Network ApplicationをUbuntu上にセットアップし、UniFiネットワーク製品の登録（Adoption）までを行いました。この記事ではホームユーザーがUniFi製品を運用していくにあたり、必要な操作ができるようになることを目的としています。</p><span id="more"></span><h2 id="日本語ガイド"><a href="#日本語ガイド" class="headerlink" title="日本語ガイド"></a>日本語ガイド</h2><p>セットアップが完了し、運用開始するにあたり、日本の公式のガイドとして以下のリソースがあります。</p><blockquote><p>UniFi - アップデート<br> <a href="https://help.jp.ui.com/articles/7605005245975/">https://help.jp.ui.com/articles/7605005245975/</a></p></blockquote><blockquote><p>接続の課題などのFAQ<br> <a href="https://help.jp.ui.com/articles/7258465146519/">https://help.jp.ui.com/articles/7258465146519/</a></p></blockquote><h2 id="UniFiデバイス一覧およびアップデート"><a href="#UniFiデバイス一覧およびアップデート" class="headerlink" title="UniFiデバイス一覧およびアップデート"></a>UniFiデバイス一覧およびアップデート</h2><p><code>https://UniFi Network Application Host:8443/</code>に接続すると左にカテゴリのアイコンが並びます。以下のように左の赤枠で囲った<mark class="label primary">UNIFI DEVICES</mark>一覧では現在のAdoptされているUniFi機器の一覧が確認できます。</p><img src="/new-technology/2022/10/23/unifi-network-application2/u1.png" class="" width="1024" title="alt"><p>バージョンアップの通知があれば、ここで<mark class="label primary">Click to Update</mark>のように表示されますので、これをクリックしてデバイスのアップデートが行えます。<br>リリースの情報については本国のCommunityを参照することになります。</p><blockquote><p>UniFi リリース一覧<br> <a href="https://community.ui.com/releases/">https://community.ui.com/releases/</a></p></blockquote><img src="/new-technology/2022/10/23/unifi-network-application2/rel.png" class="" width="1024" title="alt"><p>ここでは、<mark class="label primary">Official</mark>または<mark class="label primary">Release Candidate(リリース候補）</mark>と区分されています。Network Applicationの初期設定では、Officialのものが自動的にアップデートされる仕組みになっています。後に説明する設定画面で、Official,Release Candidate,Early Accessと3つの区分を選択可能です。</p><p>実際のリリースのポストを参照すると先頭には簡単なリリースノーツが記述されており、それ以下でユーザーによるレポートが続きます。前回も記載しましたが、マニュアルがないことや製品提供機能やUbiquitiの今後の方向性があまり見えてこないこともあり、他のプロダクトと比較しても、ユーザーからは辛辣な意見が寄せられる事が多いです。単なる不満（ユーザーのスキル不足や、製品への過剰な期待や思い込みが原因である事も多いように感じられます）の投稿によって重要な情報を見失わないようにすることが大事です。詳細な検証結果など貴重な情報を提供してくれるユーザーも存在しています。</p><p>デバイスを選択すると個々のデバイスのトラフィック状況などが確認できます。<mark class="label primary">Settings</mark>に進むとバージョンアップや再起動、ファームウェアのロールバックなどが実行できます。また、デバイスをリセットする場合や他のネットワークに使う場合は、<mark class="label primary">Forget</mark>を選択します。</p><img src="/new-technology/2022/10/23/unifi-network-application2/u2.png" class="" width="360" title="alt"><p>ファームウェアをロールバック（ダウングレード）する場合は、該当製品のファームウェアバージョンのURLを指定します。ここで説明している使い方は、Ubiquitiクラウド連携を前提としており、UniFiネットワークアプリケーション、スイッチ共にインターネットへ接続可能である必要があります。リリース一覧は以下のURLから確認します。</p><blockquote><p>UniFi APなど<br><a href="https://www.ui.com/download/unifi/">https://www.ui.com/download/unifi/</a></p></blockquote><blockquote><p>UniFi スイッチ<br><a href="https://www.ui.com/download/unifi-switching-routing">https://www.ui.com/download/unifi-switching-routing</a></p></blockquote><img src="/new-technology/2022/10/23/unifi-network-application2/dl.png" class="" width="1024" title="alt"><p>左メニューのプルダウンから製品を選択すると以下のように最新バージョンが表示されます。ここから<mark class="label primary">PAST FIRMWARE</mark>を選択し、具体的なバージョンを指定してから、ダウンロードを選択するとURLが示されるので、そのURLをネットワークアプリケーションのデバイスのURLに貼り付け、Updateを実行します。</p><img src="/new-technology/2022/10/23/unifi-network-application2/rel1.png" class="" width="800" title="alt"><p>ここまでの作業はスマホアプリ（UniFi Network）でも同様の操作が可能です。</p><h2 id="クライアントデバイス一覧"><a href="#クライアントデバイス一覧" class="headerlink" title="クライアントデバイス一覧"></a>クライアントデバイス一覧</h2><p>以下のように左の赤枠で囲った<mark class="label primary">CLIENT DEVICES</mark>では現在のUniFiネットワークに接続されているクライアント一覧が確認できます。</p><img src="/new-technology/2022/10/23/unifi-network-application2/u3.png" class="" width="1024" title="alt"><p>ここではIPアドレス、クライアントが所属するVLAN、接続しているWi-Fiの情報、トラフィックなどが確認できます。もし、UniFiのL3スイッチがあれば、L3スイッチにDHCP機能があるので、この画面からスタティックIPアドレスを設定可能です。</p><p>この画面もスマホアプリで同様の操作と確認ができます。</p><h2 id="設定"><a href="#設定" class="headerlink" title="設定"></a>設定</h2><p>以下のように左の赤枠で囲った<mark class="label primary">SETTINGS</mark>ではUniFi製品群の全般的な設定をします。なおこの記事のUniFiの構成では、UDM Proなどのセキュリティゲートウェイを保有していない状態であり、単独のUniFi Network Applicationの設定例となります。以下の左側メニューの<mark class="label primary">Internet</mark>、<mark class="label primary">VPN</mark>、<mark class="label primary">Traffic Management</mark>、<mark class="label primary">Firewall & Security</mark>は対象外です。</p><img src="/new-technology/2022/10/23/unifi-network-application2/u4.png" class="" width="1024" title="alt"><h3 id="WiFi"><a href="#WiFi" class="headerlink" title="WiFi"></a>WiFi</h3><p>WiFi設定では名前、所属するVLAN、チャンネルなど設定します。UniFiは集中型管理であるため、個々のAP毎に設定するよりはネットワーク全体でどのように管理するかを決めるモデルとなります。</p><ul><li><p>Global AP Settings<br> この設定で、複数APを立てることを想定し、全般設定を行います。</p></li><li><p>Channel Width<br> 2.4GHz、5GHzそれぞれでバンド幅を設定します。ここは個人の好みによりますが、一般的なデバイスのために2.4GHzは20MHzを、5GHzでは80MHzを設定することをお勧めします。もちろん、PCなども無線でできるだけ速度を求める方は160MHzの設定が可能です。こういった場合は、AP単位にバンド幅を個別設定し、クライアント単位に接続させるAPを固定させる事ができます。</p></li><li><p>Transmit Power<br> 無線の送信出力を決めます。Auto&#x2F;High&#x2F;Medium&#x2F;Lowが選択できます。</p></li><li><p>AP Site Settings<br> Wiress Meshingの項目がありますが、メッシュ製品（無線によるバックホール接続）は現在日本では発売されていません。</p></li><li><p>Nightly Channel Optimization<br> 夜間に外部のWiFiの電波状況を見ながらUniFi側でWiFiチャネルの最適化を行います。比較的近い距離で同一のチャンネルを選択していると競合することになるのでこれは実際にテストしながら選択されることをお勧めします。</p></li></ul><p>これより詳細のWiFi設定についてはまた別の機会があれば書きたいと思います。</p><h3 id="Networks"><a href="#Networks" class="headerlink" title="Networks"></a>Networks</h3><p>Networksでは主にVLANとスイッチの全般設定をします。</p><img src="/new-technology/2022/10/23/unifi-network-application2/u5.png" class="" width="1024" title="alt"><p>今回の記事は概要に留めますが、VLANを構成する場合にはスイッチ単位ではなく、ネットワークアプリケーションでネットワーク全体の構成を決めることになります。もし、UniFiのL3スイッチがあり、L3ネットワークにするのであれば、L3のDHCPを有効にします。L3スイッチがない場合で単にL2のVLANを作成する場合は、<mark class="label primary">VLAN Only Network</mark>としてVLANを作成し、ルーティングやDHCP機能はFirewallやルータに任せることになります。</p><p>一旦ネットワークアプリケーションでVLANを定義すると、どのスイッチからもそのVLANが利用できるようになります。</p><p>以下はFirewallを利用する場合の一例です。インターネット接続がホームゲートウェイとなる場合、もちろんFirewallとHGWとを直結しても構いませんが、トラフィックを把握するためにVLANを定義し、FirewallのWANとHGWとをスイッチに接続します。こういった場合にはUniFiスイッチではFirewallの外側（ホームゲートウェイ側）と内側（LAN）のネットワークとを分離するため、VLAN OnlyでWANのVLANを作成することになります。</p><img src="/new-technology/2022/10/23/unifi-network-application2/switch.drawio.png" class="" width="480" title="alt"><p>UniFiネットワークの初期設定ではVLANが無い状態であり、”ALL”というプロファイルになります。これは全てのVLANを転送するPortになります。セグメントを分離する場合は、ALLを使わず、Defaultに加え、WAN、管理用という具合にそれぞれの独立したネットワークを作成することになります。マルチプルVLANを使う場合にはALLプロファイルを使います。一般的な個人向けのルータを使い、シンプルに一つのセグメント（例えば192.168.1.x&#x2F;24）だけがある環境で、自宅用と会社用との端末の相互アクセスを禁止する場合はマルチプルVLANは便利です（この場合はルータをALLプロファイル、自宅用の端末はDefault、会社用端末はVLAN1という具合に分離します）。</p><p>ESXiなどでLAN用に複数の物理Portが存在する場合、仮想マシンを使うセグメントと仮想マシンのバックアップ用（NAS）LANとトラフィックを分離するのも一つの使い方です。</p><ul><li><p>Global Network Settings<br> ネットワーク設定全般を行います。スイッチの共通設定部分になります。</p></li><li><p>Multicast DNS<br> Apple AirPlayやGoogle Chromecastのためにネットワークセグメントを超えてmDNS(Bonjour)の名前解決およびデータ配信を支援します。</p></li><li><p>IGMP Snooping<br> 本来は、マルチキャストトラフィックを使っていないクライアントに対してはパケットの転送を抑制するためのものですが、スイッチでPackets Discardedのカウンタが増えるのが気になり私は無効にしています。WiFiネットワークがあるセグメントにひかりTVなど、対象セグメントに一定量のマルチキャストトラフィックを流すのが気になる場合はセグメントをVLANで分離する方がお勧めです。</p></li><li><p>Global Switch Settings<br> 複数スイッチの共通設定を指定します。主には、Flow Control、Jumbo Framesがあります。また固有のスイッチだけフローコントロールを外すとか個別設定が可能なように、<mark class="label primary">Switch Exclusion</mark>から該当するスイッチを選択できます。</p></li></ul><h3 id="System"><a href="#System" class="headerlink" title="System"></a>System</h3><p>Systemでは主にネットワークアプリケーション全般設定をします。</p><img src="/new-technology/2022/10/23/unifi-network-application2/u6.png" class="" width="1024" title="alt"><mark class="label primary">Network Notification</mark>で通知設定ができます。これはメール、スマホアプリへの通知、ネットワークアプリケーション画面上での通知が選択できます。ファームウェア通知、APのレーダー受信、クライアントの接続/切断通知など設定項目は多岐にわたります。<p>その他主要項目を抜粋します。</p><ul><li><p>Updates<br> ここではデバイスのファームウェア情報についての設定です。ネットワークアプリケーション自身のアップデートがある場合、デバイスのアップデートがある場合は通知できます。ここで接続チャネル（Officail&#x2F;Release Candidate&#x2F;Early Access）が選べます。なお、ネットワークアプリケーションはインストールで実施したようにShellスクリプトで実施することになります（後述します）。</p></li><li><p>Device Auto Updates<br> デバイスを自動的にアップデートするか選択します。最新ファームウェアが公開されると時刻に関係なくアップデートされるので、ここはオフに設定し、<mark class="label primary">Schedule Device Updates</mark>で週末などにアップデートする設定を追加することをお勧めします。</p> <img src="/new-technology/2022/10/23/unifi-network-application2/u7.png" class="" width="240" title="alt"></li><li><p>Backup<br> ネットワークアプリケーションの設定のバックアップです。日次、週次、月次でバックアップ可能です。トラフィックログも併せてバックアップが可能です。</p></li><li><p>System Logging<br> デバイスのログをsyslogに転送できます。syslogサーバのIPアドレスとPort（一般的に514）を設定します。</p></li><li><p>Network Device SSH Authentication<br> スイッチやAPに対しSSH可能です。スイッチの詳細なカウンタを取得するために必要です。カウンタのエラーが無いか、切断回数などを確認するために使います。パスワード認証または公開鍵を設定することでUniFiデバイスへ接続可能になります。</p> <img src="/new-technology/2022/10/23/unifi-network-application2/u8.png" class="" width="480" title="alt"></li><li><p>Other Configuration<br> NTPの設定、メールサーバーの設定ができます。メールサーバーはCloudを選択するとUbiquitiクラウドからメール通知が行われます。</p></li></ul><h2 id="Network-Applicationのバージョンアップ"><a href="#Network-Applicationのバージョンアップ" class="headerlink" title="Network Applicationのバージョンアップ"></a>Network Applicationのバージョンアップ</h2><p>Network ApplicationはこのGUIから更新することはできず、前回記事「<a href="/new-technology/2022/09/23/unifi-network-application/" title="UniFi Network Applicationのセットアップ">UniFi Network Applicationのセットアップ</a>」で説明したLinuxのシェルからアップデートスクリプトを実行することになります。Windows、macOSでお使いの方は最新モジュールをダウンロードし、セットアップを実行することになります。ここではUbuntuのアップデートの例を記載します。</p><p>スクリプトの情報は、コミュニティにあります。<br><a href="https://community.ui.com/questions/UniFi-Installation-Scripts-or-UniFi-Easy-Update-Script-or-UniFi-Lets-Encrypt-or-UniFi-Easy-Encrypt-/ccbc7530-dd61-40a7-82ec-22b17f027776">https://community.ui.com/questions/UniFi-Installation-Scripts-or-UniFi-Easy-Update-Script-or-UniFi-Lets-Encrypt-or-UniFi-Easy-Encrypt-/ccbc7530-dd61-40a7-82ec-22b17f027776</a></p><p>セットアップで失敗した際にすぐに戻れるように、このタイミングでESXiのスナップショット、またはバックアップの取得をお勧めします。</p><p>実行は3ステップです。Ubuntuの<mark class="label primary">端末</mark>から、以下のコマンドを実行します。</p><ol><li><p>管理者になります</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo -i</span><br></pre></td></tr></table></figure></li><li><p>証明書などのダウンロードをします。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ apt-get update; apt-get install ca-certificates wget -y</span><br></pre></td></tr></table></figure></li><li><p>ネットワークアプリケーションのアップデートを行います。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">rm</span> unifi-update.sh &amp;&gt; /dev/null; wget https://get.glennr.nl/unifi/update/unifi-update.sh &amp;&amp; bash unifi-update.sh</span><br></pre></td></tr></table></figure></li></ol><p>上記のCommunityでは、個別のバージョンのスクリプトシェルへのリンクもありますので、unifi-updates.shの代わりに、バージョンを指定したスクリプトでインストールすることもできます。ロールバックは対応していないとの情報があるので、私はESXiでのバックアップを保存するようにしています。</p><p>日本語ガイドにもアップデートに関する言及があります。</p><blockquote><p>UniFi Network - 他社製の非コンソールUniFi Networkアプリケーションをアップデートする（Linux - 高度）<br> <a href="https://help.jp.ui.com/articles/220066768/">https://help.jp.ui.com/articles/220066768/</a></p></blockquote><h2 id="リソース"><a href="#リソース" class="headerlink" title="リソース"></a>リソース</h2><p>以下の日本語ヘルプ、コミュニティがUniFiの構築には大いに参考になります。</p><blockquote><p>Ubiquiti コミュニティ（日本）<br> <a href="https://www.facebook.com/groups/uijapan">https://www.facebook.com/groups/uijapan</a></p></blockquote><blockquote><p>UI 日本語ヘルプ記事<br> <a href="https://help.jp.ui.com/categories/6583256751383/">https://help.jp.ui.com/categories/6583256751383/</a></p></blockquote><blockquote><p>Ubiquiti Community（米国中心）<br> <a href="https://community.ui.com/">https://community.ui.com/</a></p></blockquote>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2022/10/23/unifi-network-application2/unifi1.png&quot; class=&quot;&quot; width=&quot;1024&quot; title=&quot;alt&quot;&gt;

&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;

&lt;p&gt;前回記事「&lt;a href=&quot;/new-technology/2022/09/23/unifi-network-application/&quot; title=&quot;UniFi Network Applicationのセットアップ&quot;&gt;UniFi Network Applicationのセットアップ&lt;/a&gt;」では、UniFi Network ApplicationをUbuntu上にセットアップし、UniFiネットワーク製品の登録（Adoption）までを行いました。この記事ではホームユーザーがUniFi製品を運用していくにあたり、必要な操作ができるようになることを目的としています。&lt;/p&gt;</summary>
    
    
    
    <category term="Network" scheme="https://yoshi0808.github.io/new-technology/categories/Network/"/>
    
    
    <category term="UniFi" scheme="https://yoshi0808.github.io/new-technology/tags/UniFi/"/>
    
  </entry>
  
  <entry>
    <title>UniFi Network Applicationのセットアップ</title>
    <link href="https://yoshi0808.github.io/new-technology/2022/09/23/unifi-network-application/"/>
    <id>https://yoshi0808.github.io/new-technology/2022/09/23/unifi-network-application/</id>
    <published>2022-09-22T16:00:00.000Z</published>
    <updated>2023-04-15T03:29:08.572Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2022/09/23/unifi-network-application/unifi1.png" class="" width="1024" title="alt"><p class="onepoint">この記事で実現すること</p><p>米国Ubiquiti（ユビキティ）社のUniFi製品であるネットワークスイッチ、Wi-Fiアクセスポイントを利用するには、管理コンソールとしてUniFi OS ConsoleまたはUniFi Network Applicationが必要となります。UniFi Network ApplicationはUbiquitiより無償提供されており、管理・運用においてはUniFiクラウドサービスと連携します。一般的にはこのようなサービスはサブスクリプション費用が必要ですが、この費用も掛かりません。UniFi製品はネットワークの見える化に特化しているため、管理コンソールの24時間稼働が理想です。最初からハード組み込みのセキュリティ機器（UniFi Security Gateway等）やUniFi Cloud Keyを購入すればすぐにUniFi製品を使い始めることができますが、これらのハードウェアを購入しなくとも、ネットワークやLinuxの知識がある人はUniFi Network Applicationをセットアップし、使い始めることができます。</p><span id="more"></span><h2 id="UniFi-Network-Applicationのセットアップの前提"><a href="#UniFi-Network-Applicationのセットアップの前提" class="headerlink" title="UniFi Network Applicationのセットアップの前提"></a>UniFi Network Applicationのセットアップの前提</h2><p>「<a href="/new-technology/2022/08/27/ubiquiti-unifi/" title="Ubiquiti UniFiの世界">Ubiquiti UniFiの世界</a>」ではUniFiの機能全般を説明しました。UniFi Network Applicationをセットアップする以前に製品の情報やアップデートの情報は全てUbiquitiの提供するCommunityから入手します。英語のコミュニティサイトではSOHOなどのユーザーはUDM Proなどのセキュリティゲートウェイに、スイッチ、APを組み合わせているケースが多く見られます。スイッチユーザーは、もう少し大きな規模のユーザーがネットワークアプリケーションをLinuxで構築しているユーザーが多いように見えます。実際に顧客にサービスを提供しているSIerやエンジニアの参加もあります。コミュニティの情報・不具合などの割合から見ると、ネットワークアプリケーションの機能とスイッチの情報が圧倒的に多いように見え、セキュリティゲートウェイの質問やセキュリティそのものに関する技術的な内容は少ないように見えます。</p><p>手っ取り早くUniFi機器を稼働させるには、Windows、macOSのUniFi Network Applicationをセットアップし、動作させることです。</p><p>基本的には24時間稼働させ、スイッチ&#x2F;APからリアルタイムで情報を収集したり、スイッチ&#x2F;APに必要な動作を指示するのがConsole&#x2F;Network Applicationの役目です。Linux上（Debian&#x2F;Ubuntu）にセットアップされるケースが多いようです。わざわざLinuxのセットアップをするのは手間だと思えますが、運用を継続することを考えると、Linuxへのセットアップがお勧めです。また、バックアップや設定変更で動作しなくなった時のロールバックを考えると仮想環境（ESXi）にセットアップされることをお勧めします。Ubuntuの最新バージョンであるUbuntu22.04LTSはサポート期間が2027年までと十分長い期間があります。UniFiのためのUbuntuのセットアップ記事は「<a href="/new-technology/2022/09/23/ubuntu22-04lts/" title="Ubuntu22.04LTSをESXiにセットアップする">Ubuntu22.04LTSをESXiにセットアップする</a>」を参照してください。</p><p>ローカル環境のみのアクセス（オンプレミス）、リモート（スマホアプリ）から管理可能なハイブリッドクラウド方式がありますが、ここではハイブリッドクラウド方式で進めます。クラウドはUbiquitが提供する無償のサービスです（※有償のUbiquitiクラウド管理の方式もあります）。基本的には機器のCPU、メモリ使用量、温度管理に加え、スマホへの通知やリモートによる機器のリスタート、アップグレード、高い利便性があります。</p><p>UniFiはAppleのiPhoneのように説明書が無くても使えることを目標にしているのでしょうか。難しいスイッチなどのコマンドラインを必要としませんが、マニュアルというものがありません。文末に示すコミュニティなどの情報を参考にしてください。徐々に日本語向けガイドも整備されてきています。</p><p>この記事ではUbuntuに具体的にネットワークアプリケーションをセットアップする方法を記載していますが、最初に日本語のガイドを参照されることをお勧めします。より詳細の手順としてこの記事を参考にされることをお勧めします。Ubiquitiの公式ではUniFiコンソールを購入してセットアップする事が推奨されています。</p><blockquote><p>UI Japan サポートセンター UniFiの導入<br> <a href="https://help.jp.ui.com/articles/360012192813/">https://help.jp.ui.com/articles/360012192813/</a></p></blockquote><blockquote><p>UniFi Network - コンソールなしでUniFi Networkをセルフホスティングする（高度）<br> <a href="https://help.jp.ui.com/articles/360012282453/">https://help.jp.ui.com/articles/360012282453/</a></p></blockquote><p>この記事では、公式で記載されている方法ではなく、有志が作成したスクリプトを用いてセットアップします。</p><h3 id="UniFi-Networkのリモートアクセス"><a href="#UniFi-Networkのリモートアクセス" class="headerlink" title="UniFi Networkのリモートアクセス"></a>UniFi Networkのリモートアクセス</h3><p>Requirementとして以下のドキュメントがあります。</p><blockquote><p>UniFi Network - リモートアクセスの要件<br> <a href="https://help.jp.ui.com/articles/115012240067/">https://help.jp.ui.com/articles/115012240067/</a></p></blockquote><p>説明は至ってシンプルです。UIシングルサインオンアカウント、インターネットに接続されているネットワークアプリケーションホストが必要とあります。<br>よくあるトラブルとしては、Port解放の問題、DNS、NTPへの接続が必要という項目があります。また、コミュニティのリリースポストを参照してほしいとあります。</p><p>UniFiの環境は慣れるまでは理解するのが大変ですが、その世界観を理解できれば1つ1つは難しくありません。</p><h3 id="UIシングルサインオンアカウントの作成"><a href="#UIシングルサインオンアカウントの作成" class="headerlink" title="UIシングルサインオンアカウントの作成"></a>UIシングルサインオンアカウントの作成</h3><p>早速、Ubiquitiのシングルサインオンアカウントを作成しましょう。アカウントの作成は無償です。</p><p><a href="https://account.ui.com/register">https://account.ui.com/register</a></p><p>ユーザー名、メールアドレス、パスワードが必要です。ユーザー名は他のユーザーと重複しない名前が必要です。一度決定するとこのユーザー名でローカル環境もログインする事になります。</p><img src="/new-technology/2022/09/23/unifi-network-application/unifi4.png" class="" width="360" title="alt"><p>登録が完了すると以下の画面になります。</p><img src="/new-technology/2022/09/23/unifi-network-application/unifi6.png" class="" width="360" title="alt"><p>登録したメールアドレスに”Email Verification”が行きますのでVerifyしてください。</p><h2 id="UniFi-Consoleの要件"><a href="#UniFi-Consoleの要件" class="headerlink" title="UniFi Consoleの要件"></a>UniFi Consoleの要件</h2><ul><li>2 GHz dual core processor(2vCPU)</li><li>4 GiB RAM (system memory)</li><li>64 GB Disk</li></ul><p>UniFi Network Applicationに対してはユーザーからのWebサービス、スイッチからネットワークアプリケーションへの接続などがあり、いくつかのサーバーPortをオープンしておく必要があります。Ubuntuと言われるとWindows上のWSL2を思い浮かべますが、WindowsOS上にPort Forwardの設定を行う必要があり、通常のUbuntuより余計な手間が掛かるためWSL2はお勧めしません。</p><p>UniFi Network ApplicationではMongoDB&#x2F;Javaを使います。これらのミドルウェアの利用はアプリケーション内部の組み込み型モジュールとして考えるべきでもあり、セキュリティの観点からは可能な限りUbuntu上の公開ポートを制限すべきです。従い、UbuntuはUniFiネットワークアプリケーション専用として利用し、必要なPort以外は閉じます。</p><p>実際のインストールは有志が作成した素晴らしいシェルスクリプトが公開されており、悩むことなくセットアップは完了します。</p><p>UniFi Network Applicationのバージョンアップはインストール同様にシェルスクリプトを動作させます。また、UniFi Network Applicationはロールバックに対応していないため、何か問題があった場合に旧環境に戻すにはアンインストール、インストールをするかESXiのレベルでスナップショットからの戻し、または仮想マシンごとのバックアップからの戻しをします。ESXiによるOSのロールバックは非常に手軽なため、万が一の際はOSレベルでのレストアが早く確実です。</p><blockquote><p>Oracle Java<br> <a href="https://www.oracle.com/jp/java/technologies/java-se-support-roadmap.html">https://www.oracle.com/jp/java/technologies/java-se-support-roadmap.html</a></p></blockquote><blockquote><p>MongoDB<br> <a href="https://www.mongodb.com/support-policy/lifecycles">https://www.mongodb.com/support-policy/lifecycles</a></p></blockquote><h2 id="Ubuntuの事前準備"><a href="#Ubuntuの事前準備" class="headerlink" title="Ubuntuの事前準備"></a>Ubuntuの事前準備</h2><p>ここでは「<a href="/new-technology/2022/09/23/ubuntu22-04lts/" title="Ubuntu22.04LTSをESXiにセットアップする">Ubuntu22.04LTSをESXiにセットアップする</a>」で記載したようにUbuntuがESXi上にセットアップされ、ESXiのUbuntuにVMware Remote Consoleで接続して操作する事を前提としています。ESXiのWebUIにログインし、Ubuntuの仮想マシンに対してVMRCで接続するか、ブラウザから、<code>vmrc://ユーザー名@esxiのホスト名/?moid=[仮想マシンのID]</code>で接続します（VMRCウィンドウが起動します）。クライアントへのVMRCのインストールはESXiのWebUIからダウンロードできます。</p><h3 id="Ubuntuの固定IPアドレスの設定"><a href="#Ubuntuの固定IPアドレスの設定" class="headerlink" title="Ubuntuの固定IPアドレスの設定"></a>Ubuntuの固定IPアドレスの設定</h3><p>UniFiの機器から、或いはWeb Consoleとして常に同一のIPアドレスに接続するために固定IPアドレス、またはDHCPの配布でmacアドレスを元に常に同じIPアドレスを配布するように設定します。Ubuntu上で固定IPにするには、<mark class="label primary">設定</mark>画面の<mark class="label primary">ネットワーク</mark>で固定IPを設定します。</p><img src="/new-technology/2022/09/23/unifi-network-application/unifi15.png" class="" width="640" title="alt"><p>UniFi Network Applicationでは現時点でIPv4のみを利用しIPv6は未対応と考えてください。個々のスイッチ&#x2F;APはもちろんIPv6通信に対応していますが、機器本体の管理をIPv4で行います。</p><h3 id="ufwの設定"><a href="#ufwの設定" class="headerlink" title="ufwの設定"></a>ufwの設定</h3><p>UniFi Consoleで最低限のPortを開けるため、UbuntuのFirewallであるufwを設定します。Ubuntuの<mark class="label primary">端末</mark>を起動します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw status</span><br><span class="line">状態: 非アクティブ</span><br><span class="line">$</span><br></pre></td></tr></table></figure><p>ufwを有効にします。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw <span class="built_in">enable</span></span><br><span class="line">ファイアウォールはアクティブかつシステムの起動時に有効化されます。</span><br></pre></td></tr></table></figure><p>再度状態確認します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ sudo ufw status</span><br><span class="line">状態: アクティブ</span><br><span class="line">$</span><br></pre></td></tr></table></figure><div class="note danger"><p>ESXiやVMRCを使わずSSHで接続しufwを有効にする場合は、SSHポート（22&#x2F;TCP)を許可しておかないと新しいSSHの接続ができません。再起動などのタイミングでSSHできず面倒になるのでご注意ください。なお、UniFi Network Applicationのセットアップ途中でSSHポートを開けます。</p></div><p>ufwを有効化しただけでは外部へ接続する方向へは制限しませんが、UbuntuのFirefoxでInternetに接続可能な状態である事を確認します。セキュリティ機器やFirewall機器で<strong>Outbound通信</strong>に厳密な管理をされている方は以下の記事を参考に必要なPortを開けてください。UniFi Network ApplicationのセットアップにはInternetへの接続が必要です。Internetから内部にポート解放する必要はありません。</p><blockquote><p>UniFi - Setting Up a UniFi OS Console<br> <a href="https://help.ui.com/hc/en-us/articles/4416276882327-UniFi-Setting-Up-a-UniFi-OS-Console">https://help.ui.com/hc/en-us/articles/4416276882327-UniFi-Setting-Up-a-UniFi-OS-Console</a></p></blockquote><h2 id="UniFi-Network-Applicationのインストール"><a href="#UniFi-Network-Applicationのインストール" class="headerlink" title="UniFi Network Applicationのインストール"></a>UniFi Network Applicationのインストール</h2><p>スクリプトの情報は、Ubiquiti本国のコミュニティにあります。<br><a href="https://community.ui.com/questions/UniFi-Installation-Scripts-or-UniFi-Easy-Update-Script-or-UniFi-Lets-Encrypt-or-UniFi-Easy-Encrypt-/ccbc7530-dd61-40a7-82ec-22b17f027776">https://community.ui.com/questions/UniFi-Installation-Scripts-or-UniFi-Easy-Update-Script-or-UniFi-Lets-Encrypt-or-UniFi-Easy-Encrypt-/ccbc7530-dd61-40a7-82ec-22b17f027776</a></p><p>セットアップで失敗した際にすぐに戻れるように、このタイミングでESXiのスナップショット、またはバックアップの取得をお勧めします。</p><p>実行は3ステップです。Ubuntuの<mark class="label primary">端末</mark>から、以下のコマンドを実行します。</p><ol><li><p>管理者になります</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ sudo -i</span><br></pre></td></tr></table></figure></li><li><p>証明書などのダウンロードをします。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ apt-get update; apt-get install ca-certificates wget -y</span><br></pre></td></tr></table></figure></li><li><p>ネットワークアプリケーションのセットアップを行います。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">rm</span> unifi-latest.sh &amp;&gt; /dev/null; wget https://get.glennr.nl/unifi/install/install_latest/unifi-latest.sh &amp;&amp; bash unifi-latest.sh</span><br></pre></td></tr></table></figure><p>必要なモジュールをインストールし、最新のUniFi Network Applicationをインストールしていきます。何回かユーザーとコマンド上の対話があります。全て”Y”を回答します。</p></li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Do you want to keep the script on your system after completion? (Y/n)</span></span><br></pre></td></tr></table></figure><p>“Y”を入力しEnterを押下します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Do you want to proceed with updating your system? (Y/n)</span></span><br></pre></td></tr></table></figure><p>“Y”を入力しEnterを押下します。その後いくつかのモジュールがセットアップされていきます。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Preparing for MongoDB installation...</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Adding key for MongoDB 3.6...</span></span><br><span class="line"><span class="comment"># Successfully added key for MongoDB 3.6!</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Running apt-get update...</span></span><br><span class="line"><span class="comment"># Successfully ran apt-get update!</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Installing mongodb-org version 3.6...</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Preparing OpenJDK 8 installation...</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Installing openjdk-8-jre-headless...</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Installing your UniFi Network Application ( 7.2.94 )...</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Downloading the UniFi Network Application...</span></span><br><span class="line"><span class="comment"># Successfully downloaded application version 7.2.94!</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Installing the UniFi Network Application...</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Would you like to update the UniFi Network Application via APT?</span></span><br><span class="line"><span class="comment"># Do you want the script to add the source list file? (Y/n)</span></span><br></pre></td></tr></table></figure><p>“Y”を入力しEnterを押下します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Is/will your application only be used locally ( regarding device discovery )? (Y/n)</span></span><br></pre></td></tr></table></figure><p>あなたのアプリケーションはディスカバリにおいてローカル環境だけで使いますか？という質問ですが、これはスクリプトの中身を見る限りは、”Y”を選択しないと、ufwの10001&#x2F;udpを開けないので、”Y”を選択します。10001&#x2F;UDPを開けないとローカル環境のUniFi機器を見つけられません。AWSなどのクラウド上にネットワークアプリケーションをセットアップする場合、ローカルのUniFi機器を直接UniFi Network Applicationに向かわせる方法もあり、その場合はクラウド上のローカルネットワークに不要なポートを公開しないための設定と考えられます。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Do you want to add the required ports for your UniFi Network Application? (Y/n)</span></span><br></pre></td></tr></table></figure><p>“Y”を入力しEnterを押下します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Successfully added port 3478/udp to UFW.</span></span><br><span class="line"><span class="comment"># Successfully added port 8080/tcp to UFW.</span></span><br><span class="line"><span class="comment"># Successfully added port 8443/tcp to UFW.</span></span><br><span class="line"><span class="comment"># Successfully added port 8880/tcp to UFW.</span></span><br><span class="line"><span class="comment"># Successfully added port 8843/tcp to UFW.</span></span><br><span class="line"><span class="comment"># Successfully added port 6789/tcp to UFW.</span></span><br><span class="line"><span class="comment"># Successfully added port 10001/udp to UFW.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Your SSH port ( 22 ) doesn&#x27;t seem to be in your UFW list..</span></span><br><span class="line"><span class="comment"># Do you want to add your SSH port to the UFW list? (Y/n)</span></span><br></pre></td></tr></table></figure><p>UniFiに必要なポートを開け、さらにSSHも開けますか？と聞かれるので”Y”を入力しEnterを押下します。</p><p>最後に以下の表示でスクリプトは終了します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># UniFi Network Application 7.2.94 has been installed successfully</span></span><br><span class="line"><span class="comment"># Your application address: https://192.168.xxx.222:8443</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># UniFi is active ( running )</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Author   |  Glenn R.</span></span><br><span class="line"><span class="comment"># Email    |  glennrietveld8@hotmail.nl</span></span><br><span class="line"><span class="comment"># Website  |  https://GlennR.nl</span></span><br></pre></td></tr></table></figure><p>とても素晴らしいシェルスクリプトです。Glenn R氏に深謝です。<br>最後の”Your application address:”にあるように、クライアントのブラウザから<code>https://UbuntuのIPアドレス:8443</code>に接続します。</p><h2 id="UniFi-ネットワークアプリケーションのセットアップ"><a href="#UniFi-ネットワークアプリケーションのセットアップ" class="headerlink" title="UniFi ネットワークアプリケーションのセットアップ"></a>UniFi ネットワークアプリケーションのセットアップ</h2><p>ここからはしばらくUbuntuは操作しません。WindowsやmacOS、スマホなどのクライアントから<code>https://UbuntuのIPアドレス:8443</code>に接続します。独自証明書のため、ブラウザのエラーが表示されますが、「危険を理解して進む」などをクリックして画面を開きます。UniFi Network ApplicationのSSL対応は別の機会に記事を書きます。</p><p>以下では規約に同意するチェックを入れ、”Next”で進みます。</p><img src="/new-technology/2022/09/23/unifi-network-application/unifi7.png" class="" width="480" title="alt"><p>ここでは、<mark class="label primary">Switch to Advanced Setup</mark>をクリックします。</p><img src="/new-technology/2022/09/23/unifi-network-application/unifi8.png" class="" width="480" title="alt"><mark class="label primary">Advanced remote and local access</mark>では、以下のようにリモートアクセスとUIシングルサインオンアカウントのトグルスイッチをOnにした状態で"Next"で進みます。<img src="/new-technology/2022/09/23/unifi-network-application/unifi8-1.png" class="" width="480" title="alt"><p>UIシングルサインオンアカウントでログインします。</p><img src="/new-technology/2022/09/23/unifi-network-application/unifi8-2.png" class="" width="480" title="alt"><p>ここではバックアップを有効にします。</p><img src="/new-technology/2022/09/23/unifi-network-application/unifi8-3.png" class="" width="480" title="alt"><p>デバイスセットアップです。ここで新しいUniFiのハードウェアがネットワークアプリケーションのサブネット内で接続状態であれば、自動的に検出します。ただし、ネットワークアプリケーションで最初にネットワークアドレスを設定する必要があり、ここではデバイスのセットアップをせずに、”Next”で進みます。</p><img src="/new-technology/2022/09/23/unifi-network-application/unifi9.png" class="" width="640" title="alt"><p>WiFiセットアップです。UniFiのAPがある場合はここでWiFiセットアップが可能ですが、スキップし”Next”で進みます。</p><img src="/new-technology/2022/09/23/unifi-network-application/unifi10.png" class="" width="640" title="alt"><p>確認画面です。所在地である日本を選択し、”Finish”で完了します。</p><img src="/new-technology/2022/09/23/unifi-network-application/unifi11.png" class="" width="800" title="alt"><p>ここまで完了すると初期画面が表示されます。</p><img src="/new-technology/2022/09/23/unifi-network-application/unifi12.png" class="" width="800" title="alt"><h2 id="UniFi-ネットワークアプリケーションの初期設定"><a href="#UniFi-ネットワークアプリケーションの初期設定" class="headerlink" title="UniFi ネットワークアプリケーションの初期設定"></a>UniFi ネットワークアプリケーションの初期設定</h2><p>最初にUniFiネットワークアプリケーションのネットワークアドレスと動作モードを設定します。<br>ネットワークアプリケーションの左下の歯車アイコンをクリックし、<mark class="label primary">Networks</mark>を選択します。</p><img src="/new-technology/2022/09/23/unifi-network-application/unifi13.png" class="" width="800" title="alt"><p>最初のネットワークアドレスは”192.168.1.0&#x2F;24”となっていますのでこれを修正します。</p><img src="/new-technology/2022/09/23/unifi-network-application/unifi13-1.png" class="" width="480" title="alt"><mark class="label primary">Auto Scale Network</mark>のチェックを外し、実際のルーターのLAN側IPアドレスを入力します。<img src="/new-technology/2022/09/23/unifi-network-application/unifi13-2.png" class="" width="480" title="alt"><p>続いて<mark class="label primary">Advanced Configuration</mark>では、今回のようにセキュリティゲートウェイなどのUniFi Consoleがありませんが、デフォルトではセキュリティゲートウェイがDHCPを提供するDHCPサーバーモードとなっています。</p><img src="/new-technology/2022/09/23/unifi-network-application/unifi13-3.png" class="" width="480" title="alt"><p>ここでは、DHCPモードを”無し”にし、”Apply Changes”で変更を完了させます。</p><img src="/new-technology/2022/09/23/unifi-network-application/unifi13-4.png" class="" width="480" title="alt"><p>左側の丸い二重丸のアイコン（UniFiAPのシンボルです）からは、新しいUniFi機器のAdoptが可能な状態になっています。</p><img src="/new-technology/2022/09/23/unifi-network-application/unifi14.png" class="" width="480" title="alt"><p>Ubuntuを再起動後してみてください。再度ブラウザでUniFi管理画面にログインできること、UbuntuにSSH可能である事を確認しましょう。</p><p>これでUniFiネットワークアプリケーションの設定は一旦完了です。もちろんこの段階で検出したスイッチを採用（Adopt）できますが、管理の主体はスマホアプリで可能なため、スマホアプリをインストールしていきましょう。</p><h2 id="UniFi-ネットワーク-スマホアプリ"><a href="#UniFi-ネットワーク-スマホアプリ" class="headerlink" title="UniFi ネットワーク スマホアプリ"></a>UniFi ネットワーク スマホアプリ</h2><p>UniFiの使い勝手の良さはスマホアプリにあります。スマホアプリからUniFiネットワークアプリケーションを制御します。普段はスマホアプリがあれば大抵は事足ります。アプリストアから”UniFi Network&#x2F;Ubiquiti Inc”を見つけスマホにアプリをインストールします。</p><ul><li><p>Apple iOS</p> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKUAAAClCAAAAAAYQGIGAAAB90lEQVR42u3a0W7DIAxG4b7/S2d3mzQFc36Stg46XHUqK18rEYzt12s+jt/x9+dwyr/J9aeczVsdKlV+R3mMBiXQrzR8txaoVNlcebbccKV6Mti79MGhUuVOyuFKgBWtoVLldsrhIZq/UqlyE2UdXy4ef/U3vD0KVqny40p6tr3v1U0ZGJUqP6k84KDnGN2nRzJUqmypBHstQtOzMlpXpcqWymHaL0qBL558dc5x/DOqVNlCuXj/ispQUXWX/KAqVbZQggxEdExGm5/GoSpV9lWCPEbe5FAfrHVtaxIAq1TZRxkluekVbfEWhy95KlV+W0n7FmiNqQ5VF8tVKlW2VNZ58HylesdGrUmT7L9KlX2U0edfrk9lNzaVKh+ljPb9PQHlJHWpUmUz5WL5NbqigZgzK02pVNlCmd+XorwIzUxM5qlU2VYZpekWWyBApEmaIVSq7KO8nA8E8qgtYvyQUKmyrRLs7LzvCISloKFVpconKPGGm8eXeTF2kp1XqfJRSrpwvQhNhEyeNypVNlMecFzJkkcVqNPJKlV2VNIMXV64ilL79D9UquymBG11N27qPFuhUmVzZdTfsJgyzFMiKlVuosx3O2ifoJUqlSo3UdJmCFywBXyVKtsq6/gyajkC8SVti1CpsrkyCvZAkSq6f9EAVaXKZsofDWwJqEp4wN0AAAAASUVORK5CYII=" alt="UniFi Network" title="" class="title: UniFi Network"><p> <a href="https://apps.apple.com/jp/app/unifi-network/id1057750338">https://apps.apple.com/jp/app/unifi-network/id1057750338</a></p></li><li><p>Android</p> <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALkAAAC5CAAAAABRxsGAAAACV0lEQVR42u3bS46EMAxF0dr/pqtnNUAkuc9BLRHfjFrF74CEcRz357Me39+4/Ha3y2Xc7Ty8Bt0ZD+XKz5CDC893Kd4SuIfFscqVt5HTt53e0vzm5k8HqJQrV559vOeBY54+3KUZypUrr8YW8BuVD73KlSvPJsAgeoAUAGx9cmahXPnr5Xn96T/+eqg6p1z5m+XRLPiZ2AK++QSkXHkHOXifd77qxdozXrNSrvxwOV31yddq6fnAhtudlSvvIM9XaUBsmacKO7UwUv5Wrvw0efTxBlXjPCsHbVfjHEK58nPltKWCzn2jdVkadMZPWrnyw+Xzrzp42yPlfM4N8vPbAKNc+bnyyAGy7bwWVg0wypW3kRe/9OAwKgfhTLnyjvJ5sRmUogvJxkZ+vphGK1d+rpy+1BG6GKboDEG58mby6GBQbAaxCjSDkNK5cuXnyvP2p6gqBq4BWjTImZUrP00ODo6WZIuVssJ1lSvvJQeOqC0i6nKKopZy5crJ/5p+1iPvlaK3rlx5H/lOsXln8hy1d1zPolx5B3lhgr0m7Eyoo1ZK5cpbyHEH0rqRgk6F6aLSIvVQrryNHLzZeQ9U1H+RNUIpV95anndO0AJ0VJlePDHlytvI8+ZB2iAxjw9RzUy58mbyLxzZK79eWaI5xDgdUa68g5y+ylnaDFOAfBk5ikHKlR8ip+cCX/VqAlKMLcqVt5HnjQ9Rsap4cyS2KFeunG4F7RjzZADUwZUrV57FlnwrnRKQdSLlyjvIix2EO7GFZgnjnZUr7yCPsmM6g366ql0YypW/Xf4Hl2yz0I8KdVwAAAAASUVORK5CYII=" alt="UniFi Network" title="" class="title: UniFi Network"><p> <a href="https://play.google.com/store/apps/details?id=com.ubnt.easyunifi&amp;hl=en_US&amp;gl=US">https://play.google.com/store/apps/details?id=com.ubnt.easyunifi&amp;hl=en_US&amp;gl=US</a></p></li></ul><p>ここではiPhoneで操作します。”Set up a New Device”をタップします</p><img src="/new-technology/2022/09/23/unifi-network-application/app1.png" class="" width="280" title="alt"><p>ネットワークを検索しに行きます</p><img src="/new-technology/2022/09/23/unifi-network-application/app2.png" class="" width="280" title="alt"><p>UniFi OS Consoleは存在していないので見つけられません。”Set up a connection by IP address”でUniFi Network ApplicationのIPアドレスを指定します。</p><img src="/new-technology/2022/09/23/unifi-network-application/app3.png" class="" width="280" title="alt"><p>UniFi Network ApplicationのIPアドレス、UIシングルサインオンアカウントのIDとパスワードを指定します。</p><img src="/new-technology/2022/09/23/unifi-network-application/app4.png" class="" width="280" title="alt"><p>しばらく経ってから、UniFi Network Applicationを見つけるので、”Proceed”をタップします。</p><img src="/new-technology/2022/09/23/unifi-network-application/app5.png" class="" width="280" title="alt"><p>無事ログインが完了し、早速Adopt可能なデバイスが表示されます。Adoptしてみます。”Set Up”をタップします。</p><img src="/new-technology/2022/09/23/unifi-network-application/app6.png" class="" width="280" title="alt"><p>“Next”をタップします。</p><img src="/new-technology/2022/09/23/unifi-network-application/app7.png" class="" width="280" title="alt"><p>デバイスを採用中です。しばらく待ちます。少し時間が掛かります。ここではデバイスの採用と最新ファームウェアのダウンロード、適用が行われます。</p><img src="/new-technology/2022/09/23/unifi-network-application/app8.png" class="" width="280" title="alt"><p>デバイスの採用が完了すると、以下の画面になります。”Go to Dashboard”をタップします。</p><img src="/new-technology/2022/09/23/unifi-network-application/app9.png" class="" width="280" title="alt"><p>Top画面です</p><img src="/new-technology/2022/09/23/unifi-network-application/app10.png" class="" width="280" title="alt"><p>UniFiデバイスの画面をタップすると、採用されたスイッチが見えます。</p><img src="/new-technology/2022/09/23/unifi-network-application/app11.png" class="" width="280" title="alt"><p>スイッチのPortの状況です。GbEでアップリンク（上流のネットワーク）に接続されています。</p><img src="/new-technology/2022/09/23/unifi-network-application/app12.png" class="" width="280" title="alt"><p>アプリの歯車アイコン（System）から”Network Application Configuration”を選択します。以下のHostname&#x2F;IPとなっている場所にネットワークアプリケーションのIPアドレスを設定しておきます。</p><img src="/new-technology/2022/09/23/unifi-network-application/app12-1.png" class="" width="280" title="alt"><h2 id="UniFiネットワーク経由のログイン"><a href="#UniFiネットワーク経由のログイン" class="headerlink" title="UniFiネットワーク経由のログイン"></a>UniFiネットワーク経由のログイン</h2><p>UniFiスマホアプリを終了し、Wi-Fiをオフにしてから再びアプリを起動します。今度は”Log in to Your UI Account”をタップし、UIシングルサインオンアカウントでログインします。</p><img src="/new-technology/2022/09/23/unifi-network-application/app13.png" class="" width="280" title="alt"><p>接続に少し時間が掛かりますが、Ubiquitiのクラウド経由でローカルのUniFiネットワークアプリケーションに接続され、スイッチや接続されたクライアントの状態が把握可能となります。厳密にはUbiquitiクラウドからスマホのパブリックIPアドレスを取得し、UniFi Network Applicationからスマホアプリへの直接接続を行うようです。</p><h2 id="2要素認証"><a href="#2要素認証" class="headerlink" title="2要素認証"></a>2要素認証</h2><p>ハイブリッドクラウドで外部からログインができるようになったので、2要素認証を設定します。ブラウザで<code>&lt;https://account.ui.com/&gt;</code>に接続します。</p><p>“My Security”をタップします。</p><img src="/new-technology/2022/09/23/unifi-network-application/verify1.png" class="" width="280" title="alt"><p>Multi Factor Authentication(MFA)をEnableにします。</p><img src="/new-technology/2022/09/23/unifi-network-application/verify2.png" class="" width="280" title="alt"><p>”UI Verify”アプリを選択します。</p><img src="/new-technology/2022/09/23/unifi-network-application/verify3.png" class="" width="280" title="alt"><p>UI VerifyアプリをダウンロードしAppを構成します。</p><img src="/new-technology/2022/09/23/unifi-network-application/verify4.png" class="" width="280" title="alt"><p>2要素認証が完了し、アプリが使えない場合のメールアドレスへの通知が2要素認証のバックアップとして利用されます。</p><img src="/new-technology/2022/09/23/unifi-network-application/verify5.png" class="" width="280" title="alt"><p>これで2要素認証が必須となり、UniFi Networkスマホアプリでは初回の認証時にUI Verifyアプリへのプッシュ通知が行われます。ユーザーが確認の応答を実施しログインが完了します。ローカル環境でブラウザなどからネットワークアプリケーションにログインする際や、UIアカウントサイトにログインする場合も2要素認証が求められ、UI Verifyアプリで応答する必要があります。</p><img src="/new-technology/2022/09/23/unifi-network-application/verify6.png" class="" width="280" title="alt"><h2 id="ufwのGUI"><a href="#ufwのGUI" class="headerlink" title="ufwのGUI"></a>ufwのGUI</h2><p>Ubuntuで今回設定したufwの設定を追加する場合、GUIによるツールを導入しておくと便利です。<mark class="label primary">Ubuntu Software</mark>から”gufw”を探し、インストールします。</p><img src="/new-technology/2022/09/23/unifi-network-application/ubuntu1.png" class="" width="640" title="alt"><h2 id="SSH"><a href="#SSH" class="headerlink" title="SSH"></a>SSH</h2><p>ここではUbuntuにSSHする説明は割愛しますが、Ubiquiti日本語ガイドにSSHについての記載がありますので参照してください。</p><blockquote><p>UniFi - SSHでログイン（高度）<br> <a href="https://help.jp.ui.com/articles/204909374/">https://help.jp.ui.com/articles/204909374/</a></p></blockquote><h2 id="セットアップの完了"><a href="#セットアップの完了" class="headerlink" title="セットアップの完了"></a>セットアップの完了</h2><p>ここまででUniFiのセットアップは完了です。ESXiのスナップショットを取得していらした方はスナップショットの管理から「すべて削除」し、一旦、Ubuntu全体のバックアップを取得される事をお勧めします。次の記事「<a href="/new-technology/2022/10/23/unifi-network-application2/" title="UniFi Network Applicationの運用">UniFi Network Applicationの運用</a>」で、UniFi Network Applicationの運用全般（設定のバックアップ、アップデート、通知）を紹介します。</p><h2 id="リソース"><a href="#リソース" class="headerlink" title="リソース"></a>リソース</h2><p>以下の日本語ヘルプ、コミュニティがUniFiの構築には大いに参考になります。</p><blockquote><p>Ubiquiti コミュニティ（日本）<br> <a href="https://www.facebook.com/groups/uijapan">https://www.facebook.com/groups/uijapan</a></p></blockquote><blockquote><p>UI 日本語ヘルプ記事<br> <a href="https://help.jp.ui.com/categories/6583256751383/">https://help.jp.ui.com/categories/6583256751383/</a></p></blockquote><blockquote><p>Ubiquiti Community（米国中心）<br> <a href="https://community.ui.com/">https://community.ui.com/</a></p></blockquote>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2022/09/23/unifi-network-application/unifi1.png&quot; class=&quot;&quot; width=&quot;1024&quot; title=&quot;alt&quot;&gt;

&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;

&lt;p&gt;米国Ubiquiti（ユビキティ）社のUniFi製品であるネットワークスイッチ、Wi-Fiアクセスポイントを利用するには、管理コンソールとしてUniFi OS ConsoleまたはUniFi Network Applicationが必要となります。UniFi Network ApplicationはUbiquitiより無償提供されており、管理・運用においてはUniFiクラウドサービスと連携します。一般的にはこのようなサービスはサブスクリプション費用が必要ですが、この費用も掛かりません。UniFi製品はネットワークの見える化に特化しているため、管理コンソールの24時間稼働が理想です。最初からハード組み込みのセキュリティ機器（UniFi Security Gateway等）やUniFi Cloud Keyを購入すればすぐにUniFi製品を使い始めることができますが、これらのハードウェアを購入しなくとも、ネットワークやLinuxの知識がある人はUniFi Network Applicationをセットアップし、使い始めることができます。&lt;/p&gt;</summary>
    
    
    
    <category term="Network" scheme="https://yoshi0808.github.io/new-technology/categories/Network/"/>
    
    
    <category term="UniFi" scheme="https://yoshi0808.github.io/new-technology/tags/UniFi/"/>
    
  </entry>
  
  <entry>
    <title>Ubuntu22.04LTSをESXiにセットアップする</title>
    <link href="https://yoshi0808.github.io/new-technology/2022/09/23/ubuntu22-04lts/"/>
    <id>https://yoshi0808.github.io/new-technology/2022/09/23/ubuntu22-04lts/</id>
    <published>2022-09-22T15:00:00.000Z</published>
    <updated>2022-09-23T00:58:38.000Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2022/09/23/ubuntu22-04lts/title.png" class="" width="1024" title="alt"><p class="onepoint">この記事で実現すること</p><p>この記事では24時間稼働させるサーバーとして、intel&#x2F;AMDの<strong>ESXi</strong>上にUbuntuをセットアップするケースを想定しています。従来のSSHで接続するコマンドラインベースだけではなく、WindowsやmaOSから<strong>GUIで接続するUbuntu環境</strong>になります。長期サポートの最新バージョンであるUbuntu22.04LTSを仮想環境であるESXi7.0上に導入します。リモートデスクトップに相当するクライアントソフトウェアはESXiに付属する<strong>VMware Remote Console</strong>(VMRC)を使います。Ubuntu22.04LTSのEOLは2027年4月であり、十分に長い期間のサポートがあります。</p><span id="more"></span><h2 id="ESXiにおけるUbuntuのセットアップのポイント"><a href="#ESXiにおけるUbuntuのセットアップのポイント" class="headerlink" title="ESXiにおけるUbuntuのセットアップのポイント"></a>ESXiにおけるUbuntuのセットアップのポイント</h2><p>サーバーとして動作させるUbuntuをESXiおよびVMRCで仮想マシンを操作する事のメリットはトラブルに強いという事でしょうか。直接ハードウェアにインストールする（いわゆるベアメタル）方式ですと、IPアドレス周りの設定変更で失敗するとSSHで繋がらなくなり、ディスプレイに本体を繋いでリカバリするなど面倒です。VMRCはESXi本体に接続し操作するため、仮想マシン上のネットワークがダウンしていても操作可能です。特に複数VLANに跨いだ環境を構築したり、ファイアウォール(ufw)を設定する場合はトラブルになりやすいため、復旧しやすい構成を目指します。</p><p>Requirements:</p><p>Ubuntu Desktop Edition<br>2 GHz dual core processor<br>4 GiB RAM (system memory)<br>25 GB (8.6 GB for minimal) of hard-drive space (or USB stick, memory card or external drive but see LiveCD for an alternative approach)<br>VGA capable of 1024x768 screen resolution<br>Either a CD&#x2F;DVD drive or a USB port for the installer media<br>Internet access is helpful</p><blockquote><p>Ubuntu documentation<br> <a href="https://help.ubuntu.com/community/Installation/SystemRequirements">https://help.ubuntu.com/community/Installation/SystemRequirements</a></p></blockquote><p>実際には、動かすアプリケーションを想定し、CPU、メモリ、ストレージを増やしておくことになるでしょう。ここでは、一例として、2vCPU、4GBメモリ、64GBストレージで進めます。</p><p>また、Ubuntuのパッチ管理のために、Ubuntu Oneアカウントの申請および、ライセンス（個人利用は無償）の取得が必要となります（後述します）。</p><p>環境面の前提としては、仮想マシンからDHCPでIPアドレスおよびDNSが取得でき、インターネットに接続可能な環境とします。</p><h2 id="Ubuntu22-04LTSのダウンロード"><a href="#Ubuntu22-04LTSのダウンロード" class="headerlink" title="Ubuntu22.04LTSのダウンロード"></a>Ubuntu22.04LTSのダウンロード</h2><p>最初にUbuntu22.04LTSのダウンロードを行います。日本語Remix版を利用します。</p><blockquote><p>Ubuntu 22.04 LTS 日本語Remix<br> <a href="https://www.ubuntulinux.jp/News/ubuntu2204-ja-remix">https://www.ubuntulinux.jp/News/ubuntu2204-ja-remix</a><br> ファイル名は「ubuntu-ja-22.04-desktop-amd64.iso」です。</p></blockquote><h2 id="ESXiで仮想マシンを作成する"><a href="#ESXiで仮想マシンを作成する" class="headerlink" title="ESXiで仮想マシンを作成する"></a>ESXiで仮想マシンを作成する</h2><h3 id="ESXiへのisoファイルのアップロード"><a href="#ESXiへのisoファイルのアップロード" class="headerlink" title="ESXiへのisoファイルのアップロード"></a>ESXiへのisoファイルのアップロード</h3><p>ESXiのWebUIにログインします。<br>ESXiの左ペインメニューの<mark class="label primary">ストレージ</mark>から<mark class="label primary">データストアブラウザ</mark>を開き、そこにダウンロードしたUbuntuのisoファイル（ubuntu-ja-22.04-desktop-amd64.iso)をアップロードします。</p><h3 id="ネットワークポートグループの作成（任意）"><a href="#ネットワークポートグループの作成（任意）" class="headerlink" title="ネットワークポートグループの作成（任意）"></a>ネットワークポートグループの作成（任意）</h3><p>Ubuntuのネットワークで使うESXiのポートグループを用意します。新しく作成する場合は、左ペインメニューの<mark class="label primary">ネットワーク</mark>から<mark class="label primary">ポートグループの追加</mark>を選択し、該当するvSwitch上に新しいポートグループを作成します。</p><h3 id="仮想マシンの作成"><a href="#仮想マシンの作成" class="headerlink" title="仮想マシンの作成"></a>仮想マシンの作成</h3><p>左ペインメニューの<mark class="label primary">仮想マシン</mark>から、<mark class="label primary">仮想マシンの作成/登録</mark>をクリックし、<mark class="label primary">新規仮想マシンの作成</mark>を選択します。ここでは仮想マシンの名前と仮想マシンのバージョンによる互換性とゲストOSの種類を指定します。互換性は特に理由がなければ一番新しいものを選んでください。<mark class="label primary">ゲストOSファミリ</mark>は”Linux”を、<mark class="label primary">ゲストOSのバージョン</mark>は”Ubuntu Linxu(64ビット）”を選択します。</p><img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu1.png" class="" width="800" title="alt"><p>続いて仮想マシンを作成するストレージを選択します。</p><img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu1-1.png" class="" width="800" title="alt"><mark class="label primary">設定のカスタマイズ</mark>では、<mark class="label primary">仮想ハードウェア</mark>と<mark class="label primary">仮想マシンオプション</mark>があります。<mark class="label primary">仮想ハードウェア</mark>のタブでは、CPU、メモリ、ディスク、ネットワークアダプタ（上記で作成したポートグループ）を指定し、CD/DVDドライブの場所でUbuntuのisoファイルを選択します。ネットワークアダプタが10GbEの場合は、<mark class="label primary">ネットワークアダプタ1</mark>のプルダウンをクリックして"VMXNET3"が選択されていることを確認してください。<img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu2.png" class="" width="800" title="alt"><mark class="label primary">仮想マシンオプション</mark>の画面に移動し、VMWare Toolsのプルダウンを開き、<mark class="label primary">Toolsのアップグレード</mark>の<mark class="label primary">パワーオン前に毎回VMware Toolsをチェックしてアップグレード</mark>のチェックボックスをオンにします。また、<mark class="label primary">起動オプション</mark>では<mark class="label primary">ファームウェア</mark>に"EFI"を選択し、<mark class="label primary">この仮想マシンに対してUEFIセキュア ブートを有効にするかどうかを指定します</mark>のチェックボックスをオンにします。セキュアブートは必須ではありませんが、セキュリティ向上のためにお勧めします。<img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu3.png" class="" width="800" title="alt"><p>完了させたら、左ペインメニューの<mark class="label primary">仮想マシン</mark>から、対象の仮想マシンを起動します。もし、クライアント端末（Windows,macOS）にVMRCをダウンロードしていなければダウンロードし、クライアント上でセットアップしておきます。</p><img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu3-1.png" class="" width="800" title="alt"><mark class="label primary">仮想マシン</mark>を<mark class="label primary">パワーオン</mark>し、<mark class="label primary">リモートコンソールを起動</mark>します。VMRCのセットアップが完了していれば以下のようなウィンドウがブラウザから独立して起動します。<img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu4.png" class="" width="800" title="alt"><mark class="label primary">Ubuntuをインストール</mark>を選択します。<h3 id="Ubuntuのセットアップ"><a href="#Ubuntuのセットアップ" class="headerlink" title="Ubuntuのセットアップ"></a>Ubuntuのセットアップ</h3><p>最初は、キーボードレイアウトを選択します。下記の例ではJapanese(Macintosh)が選択されていますが、日本語キーボードのmacOSや一般的なWindowsの日本語キーボードは一番上の”Japanese”が一般的です。<mark class="label primary">キーボード入力をここで試してください</mark>で実際のキー入力が確認できるのでここで試してから選択しましょう。インストール後にいつでも変更できます。</p><img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu5.png" class="" width="800" title="alt"><p>ここでは<mark class="label primary">最小インストール</mark>を選択します。なお、ESXiの場合、サードパーティのドライバはここでは選択する必要はありません。最初の仮想マシン作成時に、VMware Toolsをインストールするように指示しましたから、”open-vm-tools”が自動的にインストールされます。</p><img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu6.png" class="" width="800" title="alt"><p>ここでは<mark class="label primary">ディスクを削除してUbuntuをインストール</mark>を選択し”インストール”ボタンをクリックします。仮想マシン作成時に設定した64GBのディスクを初期化します。</p><img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu7.png" class="" width="800" title="alt"><p>住んでいる場所を指定します。</p><img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu8.png" class="" width="800" title="alt"><p>ホスト名、ユーザー名を設定します。ここで設定するホスト名・ユーザー名を使ってSSHで接続します。</p><img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu9.png" class="" width="800" title="alt"><img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu9-1.png" class="" width="800" title="alt"><p>インストールは完了です。再起動後、下記の画面が表示されるので、一旦Enterを押下します。</p><img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu9-2.png" class="" width="800" title="alt"><p>最初の起動画面です。ウェルカム画面というのでしょうか。初期案内のウィンドウが表示されます。</p><img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu10.png" class="" width="800" title="alt"><p>ここでは、Ubuntuシングルサインオンを行います。一旦、Ubuntuはこのままにして、クライアントのブラウザからUbuntuのOneアカウントサイトにアクセスします。</p><blockquote><p>One account for everything on Ubuntu<br> <a href="https://login.ubuntu.com/">https://login.ubuntu.com</a></p></blockquote><p>ここでは、以下のようにアカウントを作成します。メールアドレス、フルネーム、ユーザー名、パスワードを入力します。このユーザー名はUbuntuへのログインユーザーと同じである必要はありません。</p><img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu12.png" class="" width="800" title="alt"><p>“Create account”ボタンをクリックし、アカウントを作成すると、登録したメールにコンファーメーションが行きますのでそこで確認のリンクをクリックしUbuntu Oneアカウントの登録は完了します。</p><img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu13.png" class="" width="800" title="alt"><p>続いて、再びUbuntuの画面に戻り、今作成したUbuntu Oneアカウントをここで入力します。</p><img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu11.png" class="" width="800" title="alt"><p>アカウントの照合がうまくいくと、キーリングの登録になります。これは第2パスワードというべき位置付けでもあり、Ubuntuにログインしていても重要な操作の前にはこのキーリングを求められます。Ubuntuをサーバーとして使うのであればGUIでログインする場合は設定変更が主な作業でしょうから、それなりの頻度で求められることになるためパスワード管理ソフトありきの長い覚えられないパスワードにすると実際の運用で大変になってしまうので注意してください。</p><img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu13-1.png" class="" width="800" title="alt"><p>さて、続いてUbuntuにパッチを適用する際のライセンスが必要です。Ubuntu22からはLivePatchに制限が付きます。個人アカウントは3台のUbuntuまでLivePatchが適用できます。このLivePatchが有効になっていると、可能な限りリブートなく最新パッチが自動的に更新される素晴らしい仕組みとなっています。<br><strong>UbuntuのFirefoxを起動</strong>し、Ubuntu Advantageにアクセスします。</p><blockquote><p>Ubuntu Advantage<br> <a href="https://ubuntu.com/advantage">https://ubuntu.com/advantage</a></p></blockquote><p>Ubuntu Oneアカウントでログインします。</p><img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu15.png" class="" width="800" title="alt"><mark class="label primary">Free for personal use</mark>の"Register"をクリックします。<img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu16.png" class="" width="800" title="alt"><p>これで、パーソナルトークンが作成されました。<mark class="label primary">Token</mark>に記載のある文字列をマウスで選択し、右クリックからコピーを選びます。</p><p>ウェルカム画面でUbuntu Oneのシングルサインオン完了後に次の画面に進むと、<mark class="label primary">LivePatchのセットアップ</mark>に進みます。別の方法として、”ソフトウェアの更新”アプリケーションから<mark class="label primary">設定</mark>をクリックし、<mark class="label primary">LivePatch</mark>のタブを選択することでも可能です。</p><img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu20.png" class="" width="800" title="alt"><img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu21.png" class="" width="800" title="alt"><mark class="label primary">LivePatchは再起動することなく。..</mark>の表示とトグルスイッチがありますので、これをオンにします。<img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu22.png" class="" width="800" title="alt"><p>Ubuntu Advantageのトークンを貼り付けします。Ubuntu Advantageの更新は少しタイムラグがあるようで、Tokenの作成直後は登録がうまく行かない場合があるので、その場合は数時間待ってください。</p><img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu19.png" class="" width="800" title="alt"><h3 id="Open-SSH-Serverのインストール"><a href="#Open-SSH-Serverのインストール" class="headerlink" title="Open SSH Serverのインストール"></a>Open SSH Serverのインストール</h3><p>UbuntuにSSHするために必ず必要なモジュールです。GUIでコマンドを扱うには<mark class="label primary">端末</mark>というアプリケーションを起動します。 そこからopensshをインストールします。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">$ sudo apt update</span><br><span class="line">$ sudo apt install openssh-server</span><br><span class="line"></span><br><span class="line">パッケージリストを読み込んでいます... 完了</span><br><span class="line">依存関係ツリーを作成しています... 完了</span><br><span class="line">状態情報を読み取っています... 完了</span><br><span class="line">以下の追加パッケージがインストールされます:</span><br><span class="line">  ncurses-term openssh-sftp-server ssh-import-id</span><br><span class="line">提案パッケージ:</span><br><span class="line">  molly-guard monkeysphere ssh-askpass</span><br><span class="line">以下のパッケージが新たにインストールされます:</span><br><span class="line">  ncurses-term openssh-server openssh-sftp-server ssh-import-id</span><br><span class="line">アップグレード: 0 個、新規インストール: 4 個、削除: 0 個、保留: 0 個。</span><br><span class="line">751 kB のアーカイブを取得する必要があります。</span><br><span class="line">この操作後に追加で 6,046 kB のディスク容量が消費されます。</span><br><span class="line">続行しますか? [Y/n] Y</span><br></pre></td></tr></table></figure><p>Ubuntuで<mark class="label primary">端末</mark>アプリケーションを起動する場合、キーボードショートカットによる起動が便利です。セットアップ時のキーボードの選択によって内容は変わりますが、Widnowsは”Ctrl”+”Alt”+”T”で起動します。macOSでは”option”+”control”+”T”で起動します。</p><h2 id="任意設定"><a href="#任意設定" class="headerlink" title="任意設定"></a>任意設定</h2><h3 id="VMRCとクライアントとのCopy-Paseteを連携する"><a href="#VMRCとクライアントとのCopy-Paseteを連携する" class="headerlink" title="VMRCとクライアントとのCopy -Paseteを連携する"></a>VMRCとクライアントとのCopy -Paseteを連携する</h3><p>WindowsやmacOSでブラウザで検索した結果をUbuntu上で貼り付けたい場合があります。この場合は仮想マシンをシャットダウンし、仮想マシンのオプションから以下のパラメータを設定します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">isolation.tools.copy.disable          FALSE</span><br><span class="line">isolation.tools.paste.disable         FALSE</span><br><span class="line">isolation.tools.setGUIOptions.<span class="built_in">enable</span>  TRUE</span><br><span class="line"></span><br></pre></td></tr></table></figure><img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu25.png" class="" width="800" title="alt"><blockquote><p>Copy &amp; Pasetを有効にする<br> <a href="https://kb.vmware.com/s/article/57122">https://kb.vmware.com/s/article/57122</a></p></blockquote><h3 id="フォルダのパスを英語に変更する"><a href="#フォルダのパスを英語に変更する" class="headerlink" title="フォルダのパスを英語に変更する"></a>フォルダのパスを英語に変更する</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ LANG=C xdg-user-dirs-gtk-update</span><br></pre></td></tr></table></figure><img src="/new-technology/2022/09/23/ubuntu22-04lts/ubuntu24.png" class="" width="480" title="alt"><mark class="label primary">Don't ask me this again</mark>をチェックし、"Update Names"をクリックします。<h2 id="VMRCの便利な起動方法"><a href="#VMRCの便利な起動方法" class="headerlink" title="VMRCの便利な起動方法"></a>VMRCの便利な起動方法</h2><p>ESXiで該当する仮想マシンを開き、URLを確認すると、URLの末尾に仮想マシンNoとも言える2桁の番号が振られています。</p><img src="/new-technology/2022/09/23/ubuntu22-04lts/esxi1.png" class="" width="640" title="alt"><p>この数字を使って以下のURLをブラウザのお気に入りに登録しておくことによって、ESXiの画面にログインしてから仮想マシンにアクセスすることなく、直接VMRCを起動し仮想マシンにアクセスできます。</p><p><code>vmrc://[ユーザー名]@[ESXiのホスト名]/?moid=[仮想マシンNo]</code><br>例：<br><code>vmrc://root@192.168.1.1/?moid=20</code></p><h3 id="セットアップ完了"><a href="#セットアップ完了" class="headerlink" title="セットアップ完了"></a>セットアップ完了</h3><p>ESXiにおけるUbuntu22.04LTSのセットアップは完了です。最後に、仮想マシンのバックアップを取得されることをお勧めします。Linuxには個人ユーザー向けの有力なウィルス対策ソフトが存在しないため、色々なサイトをブラウジングするには多少抵抗がありますが、限られたパッケージシステムのみをインストールし、自宅内のサーバーとして利用するにはESXiとの組み合わせは最適です。バックアップやスナップショットを活用し、トラブル時には迅速にロールバックできる環境はとても便利です。</p><ul><li><a href="/new-technology/2020/10/11/esxi-backup/" title="VMware ESXiの仮想マシンをバックアップする">VMware ESXiの仮想マシンをバックアップする</a></li><li><a href="/new-technology/2021/12/04/qnap-hdp/" title="無償版ESXiのVMをQNAP NASにバックアップ">無償版ESXiのVMをQNAP NASにバックアップ</a></li><li><a href="/new-technology/2021/03/06/esxi-nakivo/" title="無償版ESXiの高度なバックアップ">無償版ESXiの高度なバックアップ</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2022/09/23/ubuntu22-04lts/title.png&quot; class=&quot;&quot; width=&quot;1024&quot; title=&quot;alt&quot;&gt;

&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;

&lt;p&gt;この記事では24時間稼働させるサーバーとして、intel&amp;#x2F;AMDの&lt;strong&gt;ESXi&lt;/strong&gt;上にUbuntuをセットアップするケースを想定しています。従来のSSHで接続するコマンドラインベースだけではなく、WindowsやmaOSから&lt;strong&gt;GUIで接続するUbuntu環境&lt;/strong&gt;になります。長期サポートの最新バージョンであるUbuntu22.04LTSを仮想環境であるESXi7.0上に導入します。リモートデスクトップに相当するクライアントソフトウェアはESXiに付属する&lt;strong&gt;VMware Remote Console&lt;/strong&gt;(VMRC)を使います。Ubuntu22.04LTSのEOLは2027年4月であり、十分に長い期間のサポートがあります。&lt;/p&gt;</summary>
    
    
    
    <category term="Software" scheme="https://yoshi0808.github.io/new-technology/categories/Software/"/>
    
    
    <category term="ESXi" scheme="https://yoshi0808.github.io/new-technology/tags/ESXi/"/>
    
    <category term="Ubuntu" scheme="https://yoshi0808.github.io/new-technology/tags/Ubuntu/"/>
    
  </entry>
  
  <entry>
    <title>Ubiquiti UniFiの世界</title>
    <link href="https://yoshi0808.github.io/new-technology/2022/08/27/ubiquiti-unifi/"/>
    <id>https://yoshi0808.github.io/new-technology/2022/08/27/ubiquiti-unifi/</id>
    <published>2022-08-26T23:40:00.000Z</published>
    <updated>2023-04-15T03:49:37.576Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2022/08/27/ubiquiti-unifi/title.png" class="" width="1024" title="alt"><p class="onepoint">この記事で実現すること</p><p>米国Ubiquiti（ユビキティ）社のネットワーク製品群であるUniFiを紹介します。Ubiquiti社はAppleにも在籍経験のあるロバートJ・ペラ氏が立ち上げた会社でWi-Fiネットワークの製品に強みを持っています。NY証券取引所にも上場しており、ビジネス向けのネットワーク機器販売が主力のビジネスです。<br>Ubiquitiにもいくつか製品群があり、このうちUniFiという製品群では、ネットワーク、監視カメラ、入退室管理などの製品があります。法人向けと個人向けのちょうど中間に位置するこの製品群は、ビジネスグレードという位置付けながら廉価です。Ubiquti製品群でも上級者向けのEdgeMaxシリーズがあり、初級者〜中級者向けをターゲットとしているのがUniFiです（ネットワークの知識は必要です）。ここではネットワーク製品のうちスイッチとWi-Fiにフォーカスを当ててどのような機能・サービスがあるのか説明していきます。ペラ氏はカリフォルニア大学において日本語の学士号を保有されており、親近感を覚えます。</p><blockquote><p>UniFiの世界へようこそ<br> <a href="https://help.jp.ui.com/">https://help.jp.ui.com</a></p></blockquote><span id="more"></span><h2 id="UniFi製品の特徴"><a href="#UniFi製品の特徴" class="headerlink" title="UniFi製品の特徴"></a>UniFi製品の特徴</h2><p>UniFiはネットワークの「見える化」をテーマとした製品群と言えます。複数のネットワーク機器や個々の端末を集中管理することに長けています。代表的なのは特にWi-Fiですが、クライアントの通信量や電波の届き具合、通信量、どこのアクセスポイントに接続されているか把握・管理が容易です。ネットワークスイッチも同様でネットワークトポロジーが明瞭で設定内容やトラフィック量が把握できます。インターネットに接続するルーターの役目を果たすセキュリティゲートウェイはどのようなサイトに接続しているか、どれくらいのトラフィック量なのかが非常に見やすくなっています。また、直感的に分かりやすいGUIによる管理が可能で、難しい従来のコマンドラインは必要ありません（※詳細の情報把握にSSHでコマンド確認することも可能です）</p><p>カメラや電話などのネットワーク製品を除いた、UniFiにおけるコアネットワーク製品を管理するためにはUniFi OS ConsoleまたはUniFiネットワークアプリケーションが必要です。</p><h3 id="UniFi-OS-Console"><a href="#UniFi-OS-Console" class="headerlink" title="UniFi OS Console"></a>UniFi OS Console</h3><img src="/new-technology/2022/08/27/ubiquiti-unifi/console.png" class="" width="1024" title="alt"><p>UniFi OS ConsoleはUniFi環境において各ネットワーク機器を集中管理するために必要なものです。Wi-FiのAPやネットワークスイッチはそれぞれGUIなど持ち合わせていないため、GUI管理のためのConsoleが必要となります。UniFiコンソールをさらに分類するとUniFiゲートウェイがあります。 UniFiゲートウェイはUniFi Dream Machine(UDM)やUDM Proはセキュリティゲートウェイと各ネットワーク機器を管理するConsole機能を持ちます。Dream Machineはセキュリティゲートウェイ、Wi-Fi（日本では11ac対応）、Consoleとが一体になっています。UDM Proは、Wi-Fiの機能は持ちませんが、LAN&#x2F;WANに10GbE SFP+を持ち、IDS(侵入検知システム）&#x2F;IPS(侵入防止システム）のスループットが3.5Gbpsあります（iperf3で計測しているとの記載があります）。</p><p>残念ながら、私はUniFiゲートウェイ製品のDream MachineやUDM Proを保有していないので、ここでUniFiの魅力的な製品の1つであるセキュリティ製品の説明ができません。現時点においては、UniFiのセキュリティゲートウェイは日本の環境におけるMAP-EやDS-Liteに対応していないように見えます。UDM ProなどはIPv6 Delegationに対応しており魅力的ですが、日本においてはプロバイダを選ぶ（具体的にはフレッツなどでひかり電話を契約し&#x2F;56などの複数のIPv6プレフィックスの割り当てが必要）ことになり、かなり利用環境が限定されます。ただし、日本でもUDM Proを動作させているユーザーもいらっしゃるようで、このあたりは日本のUbiquitコミュニティが参考になります。また、UniFiの監視カメラなどを導入されたい場合は、ハードディスクをセッティングする必要がありUniFiの専用ハードウェアが必要です。この場合は、UDMシリーズや後述するCloud Key Gen2 Plusを導入する必要があります。</p><p>なお、ゲートウェイの機能としてUDMやUDM ProはIDS&#x2F;IPS、DPI（ディープパケットインスペクション）の機能を持ち、DNSフィルタやパケットのシグネチャを検査する仕組みを持っています。現時点では暗号化されたSSL&#x2F;TSL通信を解読できません。セキュリティゲートウェイではVPNはPPTP、L2TPに加え、最近Teleport VPNに対応しています。</p><blockquote><p>UDM Pro<br> <a href="https://jp.store.ui.com/collections/UniFi-network-UniFi-os-consoles/products/udm-pro">https://jp.store.ui.com/collections/UniFi-network-UniFi-os-consoles/products/udm-pro</a><br> <img src="/new-technology/2022/08/27/ubiquiti-unifi/udmpro.png" class="" width="480" title="alt"></p></blockquote><blockquote><p>Dream Machine<br> <a href="https://jp.store.ui.com/collections/UniFi-network-UniFi-os-consoles/products/UniFi-dream-machine">https://jp.store.ui.com/collections/UniFi-network-UniFi-os-consoles/products/UniFi-dream-machine</a><br> <img src="/new-technology/2022/08/27/ubiquiti-unifi/udm.png" class="" width="240" title="alt"></p></blockquote><p>Cloud Key Gen2は35,000円ほどしますが、監視カメラを導入する場合は必要です。予め1TBのHDDが用意されているので特に難しいセットアップは不要でUniFiの運用を開始できます。</p><blockquote><p>Cloud Key Gen2 Plus<br> <a href="https://jp.store.ui.com/collections/UniFi-network-UniFi-os-consoles/products/UniFi-cloudkey-gen2-plus-1">https://jp.store.ui.com/collections/UniFi-network-UniFi-os-consoles/products/UniFi-cloudkey-gen2-plus-1</a><br> <img src="/new-technology/2022/08/27/ubiquiti-unifi/cloudkey.png" class="" width="240" title="alt"></p></blockquote><p>UniFi OS Consoleを購入しなくとも、WindowsやmacOSでUniFi Network Applicationをセットアップできます。別途、Javaのインストールが必要です。もし、仮想環境のESXiをお持ちであれば（一定のネットワークの知識があることが前提です）、ESXi上にUbuntuなどを導入し、そこにUniFi Network Applicationをセットアップできます。ネットワークアプリケーションのロールバックはサポートされておらず、旧バージョンを再インストールするか、ESXiによるバックアップからロールバックすることになります。UniFi本来のメリットを享受するためには見える化が大事ですから24時間365日の稼働とトラフィック収集が重要です。もちろんカジュアルユーザーは設定変更時だけ都度PCを起動し、UniFi Network Applicationを起動し、設定変更する方法もあります。</p><p>自分でUniFi Network Applicationをセットアップする場合は自身で用意するハードウェア以外の費用はかかりません。UniFiソフトウェアは無償ですし、サブスクリプションなどの定額支払いもありません。Linuxの場合、最低2GByteのメモリ、HDDは最低10Gバイトが必要です。私はUbuntu Desktop上に構築しており、4Gバイトのメモリ、HDDは40Gバイトにしています。UniFiのセットアップやバージョンアップにGUIは不要ですが、ハードウェアスペックに余裕のある方はGUI(Ubuntu Desktop)をお薦めします。</p><blockquote><p>UniFi Help Center<br> <a href="https://help.ui.com/hc/en-us/articles/360012282453-UniFi-Network-Self-Hosting-your-UniFi-Network-Without-a-Console-Advanced-">https://help.ui.com/hc/en-us/articles/360012282453-UniFi-Network-Self-Hosting-your-UniFi-Network-Without-a-Console-Advanced-</a></p></blockquote><h3 id="UniFiの管理画面"><a href="#UniFiの管理画面" class="headerlink" title="UniFiの管理画面"></a>UniFiの管理画面</h3><p>UniFiの管理画面は新旧の2種類あります。旧画面は日本語にも対応していますが、最新機器の製品名が表示されないなどちょっと中途半端な対応状況です。デザイン的にも少し洗練された新画面はまだまだ機能が不足しているというデメリットもありますが、近いうちに日本語対応含め機能拡充されていきます。これから利用を開始するユーザーは新画面で利用されることをお勧めします。</p><p>新画面の抜粋</p><img src="/new-technology/2022/08/27/ubiquiti-unifi/unifi1.png" class="" width="1024" title="alt"><img src="/new-technology/2022/08/27/ubiquiti-unifi/unifi2.png" class="" width="1024" title="alt"><img src="/new-technology/2022/08/27/ubiquiti-unifi/unifi3.png" class="" width="1024" title="alt"><p>旧画面</p><img src="/new-technology/2022/08/27/ubiquiti-unifi/unifi4.png" class="" width="1024" title="alt"><img src="/new-technology/2022/08/27/ubiquiti-unifi/unifi5.png" class="" width="1024" title="alt"><h3 id="スマホアプリ"><a href="#スマホアプリ" class="headerlink" title="スマホアプリ"></a>スマホアプリ</h3><p>UniFiの管理システムはハイブリッドクラウドのような仕組みがあり、無償で利用できます。完全なオンプレミスも可能ですが、外出先から自宅内のネットワーク機器を手軽にコントロールできるのは魅力的です。</p><p>特にスマホアプリから行うWi-Fi機器やスイッチ機器のモニタリング、設定変更が容易で秀逸です。コントローラは2要素認証に対応しており、自宅でコントローラにログインすると、スマホにPush通知が来ますのでこれに応答することによりログインが完了します。アプリからはLANの直接接続、或いはUbiquitiのクラウド経由で自宅のConsoleまたはネットワークアプリケーションと接続されますが、クラウド経由の場合でも自宅のFirewallやルーターで特定のPortで待ち受ける（Port解放する）ことなく、UniFi Console（ネットワークアプリケーション）側からUbiquitiのクラウドにアクセスし、最終的にはコントローラーからスマホへ接続する形態です。セキュリティ的にも一段レベルが上で、ダイナミックDNSなどの準備が不要であることが特徴です。</p><p>UniFi Networkアプリ（iOS&#x2F;Android)<br>UniFiのシングルサインオンアカウントを使ってスマホアプリにログインします。自宅内でも自宅外であってもVPNなど意識することなく簡単かつ素早くUniFi機器の管理ができます。</p><img src="/new-technology/2022/08/27/ubiquiti-unifi/app1.png" class="" width="360" title="alt"><img src="/new-technology/2022/08/27/ubiquiti-unifi/app2.png" class="" width="360" title="alt"><img src="/new-technology/2022/08/27/ubiquiti-unifi/app3.png" class="" width="360" title="alt"><p>新しい機器をスイッチポートに接続する際にはどのVLANに属するか設定しますが、この場合はスマホアプリからConsoleを経由し大抵のことができます。SFP＋のDDM(Digital Diagnostic Monitoring)の値も取れますし、スイッチによっては機器本体の温度も把握できます。</p><p>このスマホアプリではARという機能があり、UniFiスイッチの第2世代以降は以下のビデオのようにスマホで実際のスイッチ機器をかざすことによって接続された端末がVR的にマッピングされたものを見られます。UniFiスイッチを一躍有名にした機能でもあります。</p><video src='ar.mov' type='video/mp4' controls='controls'  width='45%' height='45%'></video><p> UI Verifyアプリ（iOS&#x2F;Android)<br> これはConsoleやUbiquitiのサイトにログインする際の2要素認証のためのワンタイムパスワードのスマホアプリです。</p><img src="/new-technology/2022/08/27/ubiquiti-unifi/verify1.png" class="" width="360" title="alt"><p>これを導入してシングルサインオンの設定をしておくとPCなどからログインした際にはプッシュ通知がされます。</p><img src="/new-technology/2022/08/27/ubiquiti-unifi/verify2.png" class="" width="360" title="alt"><p>これで2要素認証も簡単に対応できます。</p><h3 id="その他管理"><a href="#その他管理" class="headerlink" title="その他管理"></a>その他管理</h3><ul><li><p>Syslog&#x2F;SNMP<br>UniFi Console、各機器それぞれが統合管理されるので、1箇所のSyslogサーバにログを書き出せます。あくまでsyslogなので、UniFiシステムの障害切り分けに使うレベルのものです。また、SNMPv3の管理機能を持ちます。</p></li><li><p>SSH<br> スイッチの詳細情報を確認できます、パスワード認証、公開鍵認証が可能です。私はYubicoのYubiKeyで公開鍵認証を使っています。</p></li><li><p>バックアップ<br> 構成情報を定期的にバックアップできます。</p></li><li><p>通知<br> メール、アプリにイベントを通知できます。ファームウェア更新の通知（自動更新も可能）、スイッチやWi-Fiを対象にすればクライアント（インタフェース）の新規接続、切断、ローミングが通知されます。他にもリスク管理の通知機能があります。</p></li></ul><h3 id="オンラインストア"><a href="#オンラインストア" class="headerlink" title="オンラインストア"></a>オンラインストア</h3><p>UniFi製品は日本のオンラインストアがあります。製品はワールドワイドに展開されていますが、ONUと接続する可能性のあるセキュリティゲートウェイや電波を出すWi-Fi製品は技適マークもありますし、ネットワークスイッチの電源コードはPSEマークも付与されており安心して購入できます（電源ケーブルは3PINとなっており、日本のコンセントに合うように2PIN変換アダプタが別途必要です）。</p><blockquote><p>Ubiquit Japan Store<br> <a href="https://jp.store.ui.com/">https://jp.store.ui.com</a></p></blockquote><p>世界的にはUbiquitiの製品・パーツは非常に廉価です。日本においては今年に円安のため2回ほど価格改定があり、以前と比べると特別廉価とは感じなくなっています。</p><ul><li>MMモジュール（10Gbpsマルチモード光学モジュール）2つで6,282円</li><li>10GSFP+ RJ45モジュール9,092円</li></ul><p>日本のサイトでは今のところ送料が無料です。UbiquitiのMMモジュールは様々な機器に繋いでいますが、特段問題が発生したことはありません。Ubiquitiのスイッチに限りませんが、SFP&#x2F;SFP+の互換性の問題が出る場合があり、純正のMMモジュールまたは信頼のあるSFPベンダーからの購入をお勧めします。</p><p>ケーブルに関してはUbiquitiの純正のOM3ケーブルは部屋と部屋とを繋ぐにしては短すぎるものばかりなので別途FSやAmazonなどで調達する必要があります。</p><p>UbiquitiのRJ45ケーブル（Cat6)はコネクタ付近で曲げることができるユニークなパッチケーブルです。基本的にCat6Aはなく、Cat6のケーブルのみの取り扱いですが、最大8メートルのパッチケーブルであれば10GbEでも問題が出ることはありません。</p><img src="/new-technology/2022/08/27/ubiquiti-unifi/cat6.png" class="" width="280" title="alt"><h3 id="ネットワークスイッチ"><a href="#ネットワークスイッチ" class="headerlink" title="ネットワークスイッチ"></a>ネットワークスイッチ</h3><p>ここ数ヶ月、このブログでは省電力化および低発熱を目的としてSFP＋の説明をしてきましたが、UniFiスイッチを簡単に紹介します。</p><p>UniFiスイッチはL2の製品群が主流です。設定はGUIのみで行います。SSHでスイッチに接続し、設定変更は行えますが再起動のタイミングにおいて、GUIで設定した内容に上書きされます。見える化やスイッチ全体の一括管理のために、全てのスイッチをUniFiのものに統一したくなりますが、部分的にUniFiスイッチを導入できます。UniFiスイッチはハードウェア自体は一般的なL2スイッチとあまり違いは無いので異なるメーカーのL2スイッチをUniFiスイッチに接続し、VLANで相互に運用できます。</p><p>個人で利用する場合、無理にVLANを切る必要もありませんが、マルチプルVLANも対応しているので、1つのネットワークアドレスで複数のVLANに属する形を取ればネットワーク分離も簡単に行えます。</p><p>一部の製品にはL3に対応したスイッチも存在しますが、IPv6に対応していないことや、アクセスコントロール（ACL）が行えないというものであり、L3としてはまだ使えるレベルには達していません。</p><h4 id="USW-Aggregation"><a href="#USW-Aggregation" class="headerlink" title="USW-Aggregation"></a>USW-Aggregation</h4><img src="/new-technology/2022/08/27/ubiquiti-unifi/USW-Aggregation.png" class="" width="280" title="alt"><p>ファンレスL2スイッチです。SFP＋ポートを8つ持ちます。小規模なネットワークにも向いていますが、アグリゲーションという名前が付くだけあって、本来はいくつかのスイッチを束ねる目的のスイッチでもあります。MikroTikの8Portスイッチと値段も同程度でもあり、良く比較される対象になっています。奥行きは短いですが、基本は19インチラックに合うように作られているので結構幅があります。あまりIT機器のようにも見えないデザインでもあり、リビングに単独で置いても違和感はありません。</p><h4 id="USW-Pro-Aggregation"><a href="#USW-Pro-Aggregation" class="headerlink" title="USW-Pro-Aggregation"></a>USW-Pro-Aggregation</h4><img src="/new-technology/2022/08/27/ubiquiti-unifi/USW-Aggregation-PRO.png" class="" width="280" title="alt"><p>L3スイッチです。10G SFP＋ポートを28ポート、および25G SFP28ポートを4ポート持っています。私は寝室にあるクローゼットにこのスイッチを置いており、ファンの音はしますが、クローゼットのドアを閉めれば全く気にならない程度で静音といえます。L3は前述したように本来のL3としては制約がありますが、セグメント超えのiperf3を実行しても殆どスループットは落ちません。ここはさすがL3スイッチです。</p><h4 id="USW-Enterprise-8-PoE"><a href="#USW-Enterprise-8-PoE" class="headerlink" title="USW-Enterprise-8-PoE"></a>USW-Enterprise-8-PoE</h4><img src="/new-technology/2022/08/27/ubiquiti-unifi/USW-Enterprise-8-PoE.png" class="" width="280" title="alt"><p>L3スイッチです。Enterpriseという割には小ぶりでリビングに似合いそうなスイッチです。SFP＋を2ポート、2.5GbE（1GbE、100Base）のRJ45ポートを8ポート持ちます。ファンの音は殆どわかりません。実際にフロントのLCDパネルでファンの回転数を引き上げられ、その際はさすがにファンの音はするものの、やがて自動運転ではかなりの抑えた風量に戻るようです。米国ではTVとかオーディオなど色々な専用セグメントが必要だったりするのでL3が必要なのでしょうか。これはPoEスイッチでもあり、UniFiの世界では小型スイッチやWi-FiがPoE、つまりLANケーブル1本で通信と給電とが行われます。家が小さい日本ではあまり馴染みがないテクノロジですが、アメリカのように大きい家ではLANケーブル1本で各部屋まで配線し、天井や壁にWi-Fiやスイッチを埋め込む形でLANを構築していく事が多いのでPoEが重宝されます。RJ45の8ポートが2.5GbEであると同時にPoEによる給電が可能です。かなりの発熱で筐体上部は50℃ほどあり、コンソールからは70℃以上の熱を示しています。この温度であればファンが回っても良さそうな雰囲気ですが、LCDパネル上のファン回転数は80rpmで静かです。普段の運用ではファンが回るイメージがありません。</p><h4 id="Switch-Flex-Mini"><a href="#Switch-Flex-Mini" class="headerlink" title="Switch Flex Mini"></a>Switch Flex Mini</h4><img src="/new-technology/2022/08/27/ubiquiti-unifi/USW-Flex-Mini.png" class="" width="280" title="alt"><p>小型の1G RJ45を5ポート持つ小型スイッチです。4,794円と廉価です（最近の円安で値上がりしました）。UniFiではトランクポートとして設定する場合、複数のVLANを選択しグループ化しますが、トランクポートは全てのVLANが対象となる制約があります。一応L2対応になっています。洗練されたデザインで小型のこのスイッチは発熱が小さく安定しており気に入ってます。しかし、気に入っている割には無造作にマジックテープを裏面にべったり貼り付け、TVの後ろに貼り付けています。PoEの入力が可能なので、PoEスイッチから電源を取っています。最初から小さい電源アダプタも付属していますがケーブルの本数を減らしたい方はPoEは便利です。100Base-TXのLANを持つテレビなどは目立たないこのスイッチに集約させ、多くの長いLANケーブルから解放されるのに便利です。4,794円でUniFiの世界をテストドライブしてみるのも良いかもしれません。</p><h3 id="Wi-Fi"><a href="#Wi-Fi" class="headerlink" title="Wi-Fi"></a>Wi-Fi</h3><p>米国ではUniFiのWi-Fiシステムは非常に多くの製品が発売されていますが、日本で販売されている利用可能な製品はWi-Fi5、Wi-Fi6の有線接続を必須とする数製品に絞られます。日本のメーカーとは異なった魅力のあるアクセスポイント（AP）です。主流の11ax対応製品については、3製品あります。Lite、Pro、LR（ロングレンジ）になります。中継機としてExtender、メッシュ用としてU6 Meshが存在します。</p><img src="/new-technology/2022/08/27/ubiquiti-unifi/U6-Pro1.png" class="" width="280" title="alt"><p>基本的に壁に固定し、LANケーブルのPoEから電源を取ります。これまでのWi-Fiルータを棚やテーブルに置くという方法ではなく、電源コンセントの制約が無いため、自由度が高く、壁などに取り付けられます。APの設置は壁にねじ止めするのが本来の姿ですが、小心者の私は100均で売っている壁にメモを留めるようなピンを打ち付けてAPを固定しています。APを取り外した後も壁紙の補修液を塗り込めば壁の穴は目立ちません。</p><p>UniFiのWi-Fi製品は、ネットワークスイッチのPoEまたはPoEインジェクタを別途購入し接続することになります。</p><img src="/new-technology/2022/08/27/ubiquiti-unifi/poe.png" class="" width="280" title="alt"><p>壁掛けで1本のLANケーブルのみであれば部屋に馴染み、さほど気になるものでもありません。<br>Fast Roaming(802.11r)を前提として、APの切り替えがスムーズに行えます。一般的には端末を持つ人が移動した時のローミングを目的としていますが、家族が普段通りにスマホを使っていながら接続APを切り替えられます。私の場合、自宅の1階にU6-Proを、2階にU6-Liteを設置していますが、どちらのAPからも家じゅう電波は届きます。APの故障対策のためというよりは、私が色々なことをやってAPやスイッチの設定を変更したりリブートしたりするので、自宅内で家族向けに安定的なWi-Fiサービスの提供のためにはとても便利な機能です。AP毎の周波数を設定し、お互いが競合しないようにするなど、より細かい設定ができます。</p><p>ハードウェアスペックとしては一般的ですが、端末がどのAPに接続されているか、それぞれの端末の電波状況などがわかります。また時間でSSID単位に停波させることも可能で、私は夜間は11gの最小限の送信出力に絞り11axは止めています。スマホは夜間に勝手に11gに切り替わり最低限の通信は可能になっています。</p><p>日本のWiーFiルーターも多機能で、当たり前のようにあるWPSプッシュボタンによるクライアント登録（認証）や子供の端末を管理するなどの機能はUniFiは持っていません。下手に長いWi-Fiパスワードにしてしまうと、UniFiではIoTに対するパスワード入力が困難です。UniFiと国内のWi-Fiルーターとは目指す方向が違う事になり、基本性能という意味では殆ど変わらないものとお考えください。</p><p>ホームゲートウェイやスイッチなどが揃っている環境でUniFiのWi-Fi製品のみを導入できます。</p><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>ここではUniFiの製品群を説明しました。製品としては荒削りなところもあり、それなりに不具合や未対応の箇所を抱えながら少しづつ機能強化しているというプロダクトの特徴があります。特に見える化という観点で、ネットワーク環境を変える予定のある方は検討の候補になるかもしれません。私が保有しているスイッチを簡単に紹介しましたがSFP+に偏っており、他にも魅力的なスイッチがありますので、是非Ubiquitオンラインストアにアクセスされてみることをお勧めします。</p><p>このブログでは仮想環境のESXi上にUbuntuをセットアップし、UniFi Network Applicationを運用する方法を紹介しています。</p><ul><li>「<a href="/new-technology/2022/09/23/ubuntu22-04lts/" title="Ubuntu22.04LTSをESXiにセットアップする">Ubuntu22.04LTSをESXiにセットアップする</a>」</li><li>「<a href="/new-technology/2022/09/23/unifi-network-application/" title="UniFi Network Applicationのセットアップ">UniFi Network Applicationのセットアップ</a>」</li><li>「<a href="/new-technology/2022/10/23/unifi-network-application2/" title="UniFi Network Applicationの運用">UniFi Network Applicationの運用</a>」</li><li>「<a href="/new-technology/2022/11/23/unifi-switch/" title="UniFiスイッチ">UniFiスイッチ</a>」</li><li>「<a href="/new-technology/2022/12/31/unifi-ap/" title="UniFi Wi-Fiシステム">UniFi Wi-Fiシステム</a>」</li></ul><h2 id="リソース"><a href="#リソース" class="headerlink" title="リソース"></a>リソース</h2><p>以下の日本語ヘルプ、コミュニティがUniFiの構築には大いに参考になります。</p><blockquote><p>Ubiquiti コミュニティ（日本）<br> <a href="https://www.facebook.com/groups/uijapan">https://www.facebook.com/groups/uijapan</a></p></blockquote><blockquote><p>UI 日本語ヘルプ記事<br> <a href="https://help.jp.ui.com/categories/6583256751383/">https://help.jp.ui.com/categories/6583256751383/</a></p></blockquote><blockquote><p>Ubiquiti Community（米国中心）<br> <a href="https://community.ui.com/">https://community.ui.com/</a></p></blockquote>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2022/08/27/ubiquiti-unifi/title.png&quot; class=&quot;&quot; width=&quot;1024&quot; title=&quot;alt&quot;&gt;

&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;

&lt;p&gt;米国Ubiquiti（ユビキティ）社のネットワーク製品群であるUniFiを紹介します。Ubiquiti社はAppleにも在籍経験のあるロバートJ・ペラ氏が立ち上げた会社でWi-Fiネットワークの製品に強みを持っています。NY証券取引所にも上場しており、ビジネス向けのネットワーク機器販売が主力のビジネスです。&lt;br&gt;Ubiquitiにもいくつか製品群があり、このうちUniFiという製品群では、ネットワーク、監視カメラ、入退室管理などの製品があります。法人向けと個人向けのちょうど中間に位置するこの製品群は、ビジネスグレードという位置付けながら廉価です。Ubiquti製品群でも上級者向けのEdgeMaxシリーズがあり、初級者〜中級者向けをターゲットとしているのがUniFiです（ネットワークの知識は必要です）。ここではネットワーク製品のうちスイッチとWi-Fiにフォーカスを当ててどのような機能・サービスがあるのか説明していきます。ペラ氏はカリフォルニア大学において日本語の学士号を保有されており、親近感を覚えます。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;UniFiの世界へようこそ&lt;br&gt; &lt;a href=&quot;https://help.jp.ui.com/&quot;&gt;https://help.jp.ui.com&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    <category term="Hardware" scheme="https://yoshi0808.github.io/new-technology/categories/Hardware/"/>
    
    <category term="Network" scheme="https://yoshi0808.github.io/new-technology/categories/Network/"/>
    
    
    <category term="SFP+" scheme="https://yoshi0808.github.io/new-technology/tags/SFP/"/>
    
    <category term="10GbE" scheme="https://yoshi0808.github.io/new-technology/tags/10GbE/"/>
    
    <category term="Wi-Fi" scheme="https://yoshi0808.github.io/new-technology/tags/Wi-Fi/"/>
    
    <category term="UniFi" scheme="https://yoshi0808.github.io/new-technology/tags/UniFi/"/>
    
  </entry>
  
  <entry>
    <title>SFP+の2.5GbE対応</title>
    <link href="https://yoshi0808.github.io/new-technology/2022/07/30/sfp-plus-nbaset/"/>
    <id>https://yoshi0808.github.io/new-technology/2022/07/30/sfp-plus-nbaset/</id>
    <published>2022-07-29T21:20:00.000Z</published>
    <updated>2023-05-16T12:03:51.706Z</updated>
    
    <content type="html"><![CDATA[<p class="onepoint">この記事で実現すること</p><p>スイッチングハブのSFP&#x2F;SFP+ポートは2.5Gbps&#x2F;5Gbpsに対応していない製品が多いです。元々、10GBase-T&#x2F;1000Base-Tなどもスイッチに対し無理やり10G Base-SRのように見せかけて動作させており、SFPの世界にはNBase-Tが一般的に存在しません。ビジネス向けスイッチではそもそもの対応がされていない製品も多く、ホームユーザー向けもSFPがあまり一般的ではないことから2.5GbEのサポートは普及していません。しかしながら対応モジュールを組み合わせることで回避することは可能です。</p><span id="more"></span><h2 id="SFP-スイッチの2-5Gbpsサポート"><a href="#SFP-スイッチの2-5Gbpsサポート" class="headerlink" title="SFP+スイッチの2.5Gbpsサポート"></a>SFP+スイッチの2.5Gbpsサポート</h2><p>一般的なSFP＋スイッチは1G&#x2F;10Gのみのインタフェースとなります。また、10GBase-Tモジュールでは「ASF-10G-T」という型番のSFP＋モジュールが一般的に良く知られています。日本のAmazonだと10GTek、ipolexの取り扱いがあります。これは内部のチップにMarvell社の88X3310が使われています。これはNBase-Tに対応したチップが使われており、スイッチ側をオートネゴシエーションにしておくとスイッチ上は10Gと認識していますが、端末側の速度に合わせ2.5G、100Base-TXもリンクアップします。</p><p>必ずしも全てのモジュールがオートネゴシエーションでリンクアップするわけではありません。例えば、Broadcomチップで80m対応の省電力モジュール「Cisco SFP-10G-T-80互換」は<strong>2.5GbEに対応したスイッチ</strong>で2.5GbEと認識し正しく通信できますが、オートネゴシエーションモードではリンクアップしません。10GBase-Tで慣れている方はNBase-T対応が当然でもあり、少し違和感があるのでは無いでしょうか。</p><p>SFPモジュールの2.5Gbps対応状況について、まずは結論です。</p><table><thead><tr><th>10GBase-Tモジュール</th><th>メーカー</th><th>2.5GbE速度</th><th>2.5GbEオートネゴ</th><th>発熱</th></tr></thead><tbody><tr><td>ASF-10G-T</td><td>ipolex,10GTek</td><td>×</td><td>◯</td><td>◯</td></tr><tr><td>Cisco SFP-10G-T-80互換</td><td>各社</td><td>◯</td><td>×</td><td>◯</td></tr><tr><td>2.5GBase-Tモジュール</td><td>FSなど各社</td><td>◯</td><td>×</td><td>◎</td></tr><tr><td>S+RJ10</td><td>MikroTik</td><td>◯</td><td>◯</td><td>×</td></tr><tr><td>Aquantiaモジュール</td><td>Supermicro,FS</td><td>◯</td><td>◯</td><td>◯</td></tr></tbody></table><p>スイッチのPortをオートネゴ（10gbps）とし、モジュール側で2.5GbEをサポートする場合の制限は2つあります。1つ目は熱の問題で、2.5Gや100Baseであってもチップ自身は10Gbpsですから、消費電力および発熱量は高くなります。<br>2つ目は相手を2.5Gbpsと認識しているのはモジュール内部のチップだけであり、スイッチはその事実を全く知らないため、10Gbpsの速度でスイッチからSFP+モジュールに対してデータ送信します。このためSFP+モジュールはキャパオーバーとなり、データバッファが溢れ、データ再送が繰り返される事になります。つまり、一般的によく出回っているASF-10G-T（Marvell社の88X3310チップ）は2.5GbEとしては全く実用的ではありません。</p><p>実際に問題となるケースを説明します。クライアントは2.5GBase-Tを持つWindows10で10GBase-TのSFPモジュールを使いSFP＋スイッチにオートネゴモードで接続されています。サーバーはUbuntu20で10GbpsのSFP+DACケーブルで同じスイッチに接続されています。サーバーからデータをダウンロード、アップロードすることを想定し、iperf3を実行します。</p><img src="/new-technology/2022/07/30/sfp-plus-nbaset/nbase-t.drawio.png" class="" width="640" title="alt"><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># クライアントで実行：上り</span></span><br><span class="line"></span><br><span class="line">C:\Users\yoshi&gt;iperf3 -c 192.168.x.181</span><br><span class="line">Connecting to host 192.168.x.181, port 5201</span><br><span class="line">[  4] <span class="built_in">local</span> 192.168.x.164 port 62653 connected to 192.168.x.181 port 5201</span><br><span class="line">[ ID] Interval           Transfer     Bandwidth</span><br><span class="line">[  4]   0.00-1.00   sec   283 MBytes  2.37 Gbits/sec</span><br><span class="line">[  4]   1.00-2.00   sec   282 MBytes  2.37 Gbits/sec</span><br><span class="line">[  4]   2.00-3.00   sec   282 MBytes  2.37 Gbits/sec</span><br><span class="line">[  4]   3.00-4.00   sec   283 MBytes  2.37 Gbits/sec</span><br><span class="line">[  4]   4.00-5.00   sec   282 MBytes  2.37 Gbits/sec</span><br><span class="line">[  4]   5.00-6.00   sec   282 MBytes  2.37 Gbits/sec</span><br><span class="line">[  4]   6.00-7.00   sec   281 MBytes  2.36 Gbits/sec</span><br><span class="line">[  4]   7.00-8.00   sec   282 MBytes  2.37 Gbits/sec</span><br><span class="line">[  4]   8.00-9.00   sec   282 MBytes  2.37 Gbits/sec</span><br><span class="line">[  4]   9.00-10.00  sec   282 MBytes  2.37 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[ ID] Interval           Transfer     Bandwidth</span><br><span class="line">[  4]   0.00-10.00  sec  2.76 GBytes  2.37 Gbits/sec                  sender</span><br><span class="line">[  4]   0.00-10.00  sec  2.76 GBytes  2.37 Gbits/sec                  receiver</span><br><span class="line"></span><br><span class="line">iperf Done.</span><br><span class="line"></span><br><span class="line"><span class="comment"># クライアントで実行：下り</span></span><br><span class="line">C:\Users\yoshi&gt;iperf3 -c 192.168.x.181 -R</span><br><span class="line">Connecting to host 192.168.x.181, port 5201</span><br><span class="line">Reverse mode, remote host 192.168.x.181 is sending</span><br><span class="line">[  4] <span class="built_in">local</span> 192.168.x.164 port 62643 connected to 192.168.x.181 port 5201</span><br><span class="line">[ ID] Interval           Transfer     Bandwidth</span><br><span class="line">[  4]   0.00-1.00   sec   184 MBytes  1.54 Gbits/sec</span><br><span class="line">[  4]   1.00-2.00   sec   153 MBytes  1.29 Gbits/sec</span><br><span class="line">[  4]   2.00-3.00   sec   127 MBytes  1.06 Gbits/sec</span><br><span class="line">[  4]   3.00-4.00   sec   121 MBytes  1.02 Gbits/sec</span><br><span class="line">[  4]   4.00-5.00   sec   120 MBytes  1.01 Gbits/sec</span><br><span class="line">[  4]   5.00-6.00   sec   121 MBytes  1.02 Gbits/sec</span><br><span class="line">[  4]   6.00-7.00   sec   123 MBytes  1.03 Gbits/sec</span><br><span class="line">[  4]   7.00-8.00   sec   121 MBytes  1.02 Gbits/sec</span><br><span class="line">[  4]   8.00-9.00   sec   120 MBytes  1.00 Gbits/sec</span><br><span class="line">[  4]   9.00-10.00  sec   119 MBytes  1.00 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[ ID] Interval           Transfer     Bandwidth       Retr</span><br><span class="line">[  4]   0.00-10.00  sec  1.28 GBytes  1.10 Gbits/sec  16710             sender</span><br><span class="line">[  4]   0.00-10.00  sec  1.28 GBytes  1.10 Gbits/sec                  receiver</span><br><span class="line"></span><br><span class="line">iperf Done.</span><br></pre></td></tr></table></figure><p>Windows（クライアント：2.5Gbps）からUbuntu(サーバー:10Gbps)へのアップロードは2.5Gbps相当の速度が出ていますが、Ubuntu(サーバー:10Gbps)からWindows(クライアント：2.5Gbps)にダウンロードする方向で1Gbps程度の速度に落ち込みます。ubuntuの送信リトライの数が16710と大きな数字になっています。</p><p>上記のiperf3の実行結果についてクライアント側でネットワークアナライザのWireSharkを使い、下りデータをキャプチャしたものが以下のグラフです。</p><p>まずは、往復遅延時間（Round trip）です。</p><img src="/new-technology/2022/07/30/sfp-plus-nbaset/latency-ipolex.png" class="" width="800" title="alt"><p>X軸が時間の経過で10秒間、Y軸が往復遅延時間です。<br>問題は2つあります。1つ目は1ms（ミリ秒）を超える遅延（青いドット）がいくつか発生しています。2つ目は0ms〜1msの間に青いドットが集約され、青い帯のように見えます。LANの通信で帯に見える場合は数百μs（マイクロ秒）のレイテンシが発生し断続的に遅延が発生しています。レイテンシが小さいなら太い実線程度であり帯のようには見えません。</p><p>次に、スループットです。</p><img src="/new-technology/2022/07/30/sfp-plus-nbaset/throughput-ipolex.png" class="" width="800" title="alt"><p>X軸は時間の経過、Y軸は2つあり、茶色の実線および右の目盛りはスループットを表します。青色の点および左の目盛りは受信したデータ長を表します。<br>茶色のスループットは最初1.5Gbpsまでは上がり、その後スループットが落ち込んでいきます。グラフ上部の青い水平線はTCPのデータ1460バイトの点がプロットされたものが集まっており、実線に見えます。また、パケットが欠損するとこのように全体に青いドットが散らばり、中途半端なバイト数の受信を示します。</p><p>実際のパケットの中身を確認してみます。</p><img src="/new-technology/2022/07/30/sfp-plus-nbaset/capture-ipolex.png" class="" width="1024" title="alt"><p>IPの末尾181がubuntu、IPの末尾164がWindowsです。No307,309,310と1460バイトのTCPデータが受信されていますが、No311で318バイトを受信しています。ここで恐らくパケットが欠損したと思われます。その次の受信は、No313でシーケンス365001、No314でシーケンス366461を受信しています。受け損ねたと思われるNo311のシーケンスは360621です。(366461-360621)&#x2F;1460&#x3D;4とちょうど割り切れるため、サーバー側はTCP1460バイトを連続で送っていたものとみられます。No311で318バイトの残り1142バイトをロストし、次のシーケンス363541も1460バイト全体をロストしたのでしょう。</p><p>この後、クライアントは、あくまで自身が欲しいパケットのシーケンスは欠損した360621なのでDup ACKを送出しこれを要求しますが、要求している間にもどんどん次のトラフィックが送信されてきます。最終的には、360621の再送要求がサーバーに届き、サーバーは優先度を上げて360621を再送しますが、それまでに結構なタイムロスがあります。</p><p>iperf3など同一LAN内であれば、再送によるレイテンシも小さく済みますが、相手サーバーがInternet経由だとレイテンシが数ミリ秒〜数十ミリ秒あります。このためハイトラフィックテストや大きなファイルのダウンロードは更に落ち込む事になります。私の環境では200Mbpsが精一杯でした。</p><p>要約すると以下の通りです。</p><div class="note info"><ul><li>SFP＋スイッチの2.5GbEサポート状況はメーカー次第</li><li>SFP＋ 10GBase-Tモジュールのいくつかは2.5GbEをサポートするが、対応状況は不明瞭</li><li>スイッチが2.5GbEに対応しない場合、10GBase-Tモジュールで2.5GbEを認識する場合があるが、片側の速度が1Gbps未満に落ち込むモジュールが大半</li><li>2.5GbE接続であっても10GbEチップを使えば発熱量は増える</li></ul></div><blockquote><p>WireShark<br> <a href="https://www.wireshark.org/">https://www.wireshark.org</a></p></blockquote><h2 id="FS社のAquantiaチップ特注モジュール"><a href="#FS社のAquantiaチップ特注モジュール" class="headerlink" title="FS社のAquantiaチップ特注モジュール"></a>FS社のAquantiaチップ特注モジュール</h2><p>FS社では特にホームページで記載されていないものの、実はAquantiaチップを使ったRJ45 10GbEモジュールを特注で提供してくれます。Aquantiaチップのモジュールは、数年前よりSupermicro社が提供するRJ45モジュールで唯一の2.5GbE&#x2F;5GbE対応のものと言われていましたが、$200と高価なものでした。</p><img src="/new-technology/2022/07/30/sfp-plus-nbaset/aquantia.png" class="" width="800" title="alt"><p>（ラベルは至って普通。でも特注です）</p><p>SFP+スイッチでこのモジュールを10GbEオートネゴで使い、上記の2.5Gbpsのテストをやってみたところ、十分な速度が出ました。今回はリトライもありません。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Connecting to host 192.168.x.181, port 5201</span><br><span class="line">Reverse mode, remote host 192.168.x.181 is sending</span><br><span class="line">[  4] <span class="built_in">local</span> 192.168.x.164 port 54413 connected to 192.168.x.181 port 5201</span><br><span class="line">[ ID] Interval           Transfer     Bandwidth</span><br><span class="line">[  4]   0.00-1.00   sec   279 MBytes  2.34 Gbits/sec</span><br><span class="line">[  4]   1.00-2.00   sec   283 MBytes  2.37 Gbits/sec</span><br><span class="line">[  4]   2.00-3.00   sec   283 MBytes  2.38 Gbits/sec</span><br><span class="line">[  4]   3.00-4.00   sec   283 MBytes  2.37 Gbits/sec</span><br><span class="line">[  4]   4.00-5.00   sec   283 MBytes  2.37 Gbits/sec</span><br><span class="line">[  4]   5.00-6.00   sec   283 MBytes  2.38 Gbits/sec</span><br><span class="line">[  4]   6.00-7.00   sec   283 MBytes  2.37 Gbits/sec</span><br><span class="line">[  4]   7.00-8.00   sec   283 MBytes  2.37 Gbits/sec</span><br><span class="line">[  4]   8.00-9.00   sec   283 MBytes  2.37 Gbits/sec</span><br><span class="line">[  4]   9.00-10.00  sec   283 MBytes  2.37 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[ ID] Interval           Transfer     Bandwidth       Retr</span><br><span class="line">[  4]   0.00-10.00  sec  2.76 GBytes  2.37 Gbits/sec    0             sender</span><br><span class="line">[  4]   0.00-10.00  sec  2.76 GBytes  2.37 Gbits/sec                  receiver</span><br><span class="line"></span><br><span class="line">iperf Done.</span><br></pre></td></tr></table></figure><p>Aquantiaチップの特性でデータロストから耐えられたように見えます。<br>スループットを見てみましょう。</p><img src="/new-technology/2022/07/30/sfp-plus-nbaset/throughput-fs.png" class="" width="800" title="alt"><p>茶色の実線のスループットは最初の1秒で2Gbpsまで順調に伸びています。1460バイトのTCPデータが連続して受信されている事が青色の実線でわかります。制御のためのデータ送受信もあり、全てが1460バイトにはなりませんが、中途半端なレングスのパケットが点在していません。iperf3の結果だけ見るとすこぶる結果は良好ですが、実際のグラフにしてみるとそれなりに速度の変動は発生しています。</p><p>次にRound tripです。</p><img src="/new-technology/2022/07/30/sfp-plus-nbaset/latency-fs.png" class="" width="800" title="alt"><p>iperf3の開始直後は5msを超える遅延（青いドット）がいくつか発生しています。断続的に1msに近いレイテンシは10秒間の全体を通して発生しています。見た目だけですと最初の「ASF-10G-T」よりも悪くなっているように見えますが、遅延が0に近い場所の青い線の厚みがあることで「ASF-10G-T」よりは遅延の数が少ないと想定されます。何よりスループットは十分な速度が出ていますので許容範囲と考えるべきでしょう。10Gbpsと2.5Gbpsという速度差から発生するギャップがあり、TCP通信の初期段階で通信速度の差をある程度調整することになりますが、一定の数の調整を無くすことはできません。</p><h2 id="スイッチのフローコントロール"><a href="#スイッチのフローコントロール" class="headerlink" title="スイッチのフローコントロール"></a>スイッチのフローコントロール</h2><p>2.5GbEに対応していないSFP+スイッチであっても、Aquantiaモジュール側の2.5Gbpsの自動認識および速度調整によって上手くいくことが確認できました。それはスイッチの<strong>フロー制御</strong>によっても支えられています。「フローコントロール」を無効にしてみます。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$ iperf3 -c 192.168.x.1 -R</span><br><span class="line">Connecting to host 192.168.x.2, port 5201</span><br><span class="line">Reverse mode, remote host 192.168.x.2 is sending</span><br><span class="line">[  5] <span class="built_in">local</span> 192.168.x.1 port 49780 connected to 192.168.x.2 port 5201</span><br><span class="line">[ ID] Interval           Transfer     Bitrate</span><br><span class="line">[  5]   0.00-1.00   sec   176 MBytes  1.47 Gbits/sec</span><br><span class="line">[  5]   1.00-2.00   sec   172 MBytes  1.45 Gbits/sec</span><br><span class="line">[  5]   2.00-3.00   sec   159 MBytes  1.34 Gbits/sec</span><br><span class="line">[  5]   3.00-4.00   sec   163 MBytes  1.37 Gbits/sec</span><br><span class="line">[  5]   4.00-5.00   sec   170 MBytes  1.42 Gbits/sec</span><br><span class="line">[  5]   5.00-6.00   sec   183 MBytes  1.54 Gbits/sec</span><br><span class="line">[  5]   6.00-7.00   sec   176 MBytes  1.47 Gbits/sec</span><br><span class="line">[  5]   7.00-8.00   sec   183 MBytes  1.53 Gbits/sec</span><br><span class="line">[  5]   8.00-9.00   sec   194 MBytes  1.63 Gbits/sec</span><br><span class="line">[  5]   9.00-10.00  sec   183 MBytes  1.53 Gbits/sec</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[ ID] Interval           Transfer     Bitrate         Retr</span><br><span class="line">[  5]   0.00-10.00  sec  1.73 GBytes  1.48 Gbits/sec  13430             sender</span><br><span class="line">[  5]   0.00-10.00  sec  1.72 GBytes  1.48 Gbits/sec                  receiver</span><br><span class="line"></span><br><span class="line">iperf Done.</span><br></pre></td></tr></table></figure><p>汎用モジュールの「ASF-10G-T」ほど数字は落ち込みませんが、AquantiaチップのSFP＋モジュールでも2.5Gbpsのレートは出ません。こちらはRetrの数字が大きいことから、スイッチのフロー制御が無いまま、TCPの世界でリトライが多発しているように見えます。これはスイッチによっても差がでます。</p><p>スイッチのフローコントロールは、<strong>送信側</strong>にPauseフレームをマルチキャスト送信し、送信側を一時停止させます。システムの速度差が問題を引き起こすため、何らかの理由でスイッチのバッファが溢れそうになる時にはスイッチのフローコントロールによってネットワーク全体が安定的に動作します。ここまでの検証で、Aquantiaチップは十分なバッファを持っていることである程度は大量のトラフィックに耐えますが、バッファが溢れそうになった段階でスイッチに限界を通知し、スイッチにPauseフレーム送信を促すことにより通信が安定するものとみられます。</p><h2 id="FSでのAquantia-10GbE-SFP＋モジュール（RJ45）の指定方法"><a href="#FSでのAquantia-10GbE-SFP＋モジュール（RJ45）の指定方法" class="headerlink" title="FSでのAquantia　10GbE SFP＋モジュール（RJ45）の指定方法"></a>FSでのAquantia　10GbE SFP＋モジュール（RJ45）の指定方法</h2><p>これはFS社から教わりましたが、注文時に備考欄に  <mark class="label primary">Aquantia方案</mark>と記載して欲しいとのこと。この指定が無ければMarvellチップのモジュールになります。受注生産とのことで納品まで1か月程度掛かりますが、これはホームユーザーにとって強い味方になると思われます。</p><img src="/new-technology/2022/07/30/sfp-plus-nbaset/fs.png" class="" width="800" title="alt"><h2 id="2-5GbE-SFP＋モジュール（RJ45）"><a href="#2-5GbE-SFP＋モジュール（RJ45）" class="headerlink" title="2.5GbE SFP＋モジュール（RJ45）"></a>2.5GbE SFP＋モジュール（RJ45）</h2><p>スイッチが2.5GbEに対応しているなら、日本ではあまり見かけない2.5Gbase-Tモジュールが利用できる可能性があります。これはスイッチの対応状況に依存するため、事前にモジュールメーカーへ問い合わせが必須となります。スイッチのパフォーマンスを最大限活かせること、10GbEのチップほど温度が上がらないメリットがあります。モジュール自体の価格も10GBase-Tのものよりは安価です。</p><img src="/new-technology/2022/07/30/sfp-plus-nbaset/fs25.png" class="" width="480" title="alt"><h2 id="モジュールの温度"><a href="#モジュールの温度" class="headerlink" title="モジュールの温度"></a>モジュールの温度</h2><p>モジュールの温度に関して具体的な数値の記録は以下の通りです。</p><p>前回記事「<a href="/new-technology/2022/05/28/sfp-plus/" title="10GネットワークとSFP+">10GネットワークとSFP+</a>」と同様にモジュールの表面に金属センサーを接触させ計測しています。</p><ul><li>ファンレススイッチでオートネゴによる10Gbpsと2.5Gbpsでのリンクアップの違い</li></ul><table><thead><tr><th>10GBase-Tモジュール</th><th>速度</th><th>温度</th></tr></thead><tbody><tr><td>ASF-10G-T</td><td>2.5Gbps</td><td>46℃</td></tr><tr><td>Aquantia10Gモジュール</td><td>2.5Gbps</td><td>45℃</td></tr><tr><td>ASF-10G-T</td><td>10Gbps</td><td>49.4℃</td></tr><tr><td>Aquantia10Gモジュール</td><td>10Gbps</td><td>49.5℃</td></tr><tr><td>（室温29℃）</td><td></td><td></td></tr></tbody></table><p> Marvell、Aquantiaのモジュールは温度に関して違いは見られません。そういえば、Aquantiaは3年前にMarvellに買収されましたね。今となってはMarvell、Aquantiaという名前で比較するにはふさわしく無いのかもしれません。</p><ul><li>ファン付きスイッチで2.5GbEチップと10GbEチップ（2.5Gbpsオートネゴ接続）との比較</li></ul><table><thead><tr><th>モジュール(2.5Gbpsで接続)</th><th>温度</th></tr></thead><tbody><tr><td>Cisco SFP-10G-T-80互換</td><td>37.7℃</td></tr><tr><td>Aquantia 10Gモジュール</td><td>38℃</td></tr><tr><td>Marvell 2.5Gモジュール</td><td>35.8℃</td></tr><tr><td>（室温31℃）</td><td></td></tr></tbody></table><p> Cisco SFP-10G-T-80互換のBroadcomチップは低発熱で使いやすいモジュールですが、やはり2.5Gbps専用チップに軍配が上がります。</p><h2 id="補足"><a href="#補足" class="headerlink" title="補足"></a>補足</h2><p>2.5Gbps対応スイッチとオートネゴのASF-10G-Tとの遅延を比較したグラフのスケールを拡大して比較したものを載せておきます。上記ではレイテンシの幅について「帯」という表現をしましたが、拡大してみるとレイテンシの状況にはかなりの違いが見られます。</p><img src="/new-technology/2022/07/30/sfp-plus-nbaset/compare.png" class="" width="1024" title="alt"><p>左：2.5Gbpsモジュール（フローコントロール無し）<br>右：ASF-10G-T（2.5GbEオートネゴシエーション）</p><p>0.5秒前後を切り取っただけであり、どちらのモジュールも1msを超える大きな遅延はあります。順調なケースと問題を抱えているケースとしての比較です。左はかなり良い状態を切り取っています。どのモジュールでも数百μsの遅延は定期的に発生します。しかし帯と表現した右側のグラフでは、300μsを超えるレイテンシが継続して発生しており、何らかの問題を抱えていることがわかります。<br>遅延だけでなく、スループットを併せて見ることで遅延は無いが送る量が少ないケースも見極める必要があります。</p><p>iperf3の出力結果だけでもある程度の状況は把握できますが、WireSharkで厳密にスループットのグラフや往復遅延時間を確認し、スイッチやモジュールの能力を見極められます。</p>]]></content>
    
    
    <summary type="html">&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;

&lt;p&gt;スイッチングハブのSFP&amp;#x2F;SFP+ポートは2.5Gbps&amp;#x2F;5Gbpsに対応していない製品が多いです。元々、10GBase-T&amp;#x2F;1000Base-Tなどもスイッチに対し無理やり10G Base-SRのように見せかけて動作させており、SFPの世界にはNBase-Tが一般的に存在しません。ビジネス向けスイッチではそもそもの対応がされていない製品も多く、ホームユーザー向けもSFPがあまり一般的ではないことから2.5GbEのサポートは普及していません。しかしながら対応モジュールを組み合わせることで回避することは可能です。&lt;/p&gt;</summary>
    
    
    
    <category term="Hardware" scheme="https://yoshi0808.github.io/new-technology/categories/Hardware/"/>
    
    <category term="Network" scheme="https://yoshi0808.github.io/new-technology/categories/Network/"/>
    
    
    <category term="SFP+" scheme="https://yoshi0808.github.io/new-technology/tags/SFP/"/>
    
  </entry>
  
  <entry>
    <title>Sophos Firewall v19 MR-1</title>
    <link href="https://yoshi0808.github.io/new-technology/2022/07/30/xg-v19-mr1/"/>
    <id>https://yoshi0808.github.io/new-technology/2022/07/30/xg-v19-mr1/</id>
    <published>2022-07-29T21:00:00.000Z</published>
    <updated>2022-08-16T08:00:57.000Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2022/07/30/xg-v19-mr1/title.png" class="" title="alt"><h2 id="Sophos-Firewall-v19-MR-1"><a href="#Sophos-Firewall-v19-MR-1" class="headerlink" title="Sophos Firewall v19 MR-1"></a>Sophos Firewall v19 MR-1</h2><p>Sophos Firewall v19 MR-1が2022年7月25日に発表されました。ほとんと微修正で大きなエンハンスではなさそうです。</p><span id="more"></span><h2 id="主なエンハンスの内容"><a href="#主なエンハンスの内容" class="headerlink" title="主なエンハンスの内容"></a>主なエンハンスの内容</h2><p>（8&#x2F;16更新）<br>V19 MR-1の再リリースということで、2022年8月15日に「Sophos Firewall OS v19 MR1 re-release (Build 365) is Now Available」の案内がありました。不具合の緊急対応も含まれるようです。</p><ul><li>マルウェアエンジンの64ビット対応</li><li>Sophos Assistantオプトアウト機能</li></ul><p>v19の詳細な説明はRelease Note（英語）を参照してください。</p><blockquote><p><a href="https://docs.sophos.com/releasenotes/index.html?productGroupID=nsg&amp;productID=xg&amp;versionID=19.0">https://docs.sophos.com/releasenotes/index.html?productGroupID=nsg&amp;productID=xg&amp;versionID=19.0</a></p></blockquote><h2 id="Sophos-Firewallのアップデート"><a href="#Sophos-Firewallのアップデート" class="headerlink" title="Sophos Firewallのアップデート"></a>Sophos Firewallのアップデート</h2><p>XGの管理画面にログイン後、左ペインメニューの<mark class="label primary">バックアップ＆ファームウェア</mark>の<mark class="label primary">ファームウェアの確認</mark>ではただちに全てのユーザーにアップデートの案内が来るわけでは無いので、アップデートにはMySophosにログインし、バージョンアップの差分モジュールをダウンロードします。</p><ol><li>Sophosのサイトの右上のプルダウンメニューから、<mark class="label primary">ライセンスとアカウント</mark>をクリックします。<blockquote><p><a href="https://www.sophos.com/ja-jp.aspx">https://www.sophos.com/ja-jp.aspx</a></p></blockquote></li><li>Sophos IDをお持ちでなければIDを作成します。</li><li>ログイン後、<mark class="label primary">Network Protection</mark>をクリックします。</li><li><mark class="label primary">ファームウェアの更新</mark>をクリックします。</li><li>「製品名&#x2F;OSを使った検索」で”ファイアーウォール”を選択し、その後現れるプルダウンは”ソフトウェア”を選択します。</li><li><mark class="label primary">選択可能なダウンロードを表示</mark>ボタンをクリックします。</li></ol><img src="/new-technology/2022/07/30/xg-v19-mr1/mysophos.png" class="" width="800" title="alt"><ol><li>上記画面で”SW-19.0.1_MR-1.SFW-365.sig”というアップデータが表示されますのでダウンロードします。</li><li>MY Sophosはここで終了してXGの管理画面にログインし、左ペインメニューの<mark class="label primary">バックアップ＆ファームウェア</mark>の<mark class="label primary">ファームウェアのタブメニュー</mark>から以下の画面に赤丸で囲った矢印のアイコンをクリックし、ダウンロードしたモジュールをアップロードします。</li></ol><img src="/new-technology/2022/07/30/xg-v19-mr1/verup.png" class="" width="800" title="alt"><p>アップロード＆再起動ボタンをクリックし、v19 MR-1へのアップグレードを完了させます。</p><img src="/new-technology/2022/07/30/xg-v19-mr1/upgrade.png" class="" width="800" title="alt"><div class="note info"><p>仮想環境（ESXi）上にFirewallをインストールされている方はアップグレードの前に、「<a href="/new-technology/2020/10/11/esxi-backup/" title="VMware ESXiの仮想マシンをバックアップする">VMware ESXiの仮想マシンをバックアップする</a>」を参考に、バックアップを確保される事をお勧めします。</p></div>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2022/07/30/xg-v19-mr1/title.png&quot; class=&quot;&quot; title=&quot;alt&quot;&gt;

&lt;h2 id=&quot;Sophos-Firewall-v19-MR-1&quot;&gt;&lt;a href=&quot;#Sophos-Firewall-v19-MR-1&quot; class=&quot;headerlink&quot; title=&quot;Sophos Firewall v19 MR-1&quot;&gt;&lt;/a&gt;Sophos Firewall v19 MR-1&lt;/h2&gt;&lt;p&gt;Sophos Firewall v19 MR-1が2022年7月25日に発表されました。ほとんと微修正で大きなエンハンスではなさそうです。&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>マルチカレンシー口座 WISE</title>
    <link href="https://yoshi0808.github.io/new-technology/2022/06/28/multi-currency-account/"/>
    <id>https://yoshi0808.github.io/new-technology/2022/06/28/multi-currency-account/</id>
    <published>2022-06-28T02:00:00.000Z</published>
    <updated>2022-06-28T11:15:56.000Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2022/06/28/multi-currency-account/wise.png" class="" width="1024" title="alt"><p class="onepoint">この記事で実現すること</p><p>最近の円安や物価高と慢性的な在庫不足によりIT機器も買いづらい状況が続いています。海外通販でパーツ等を購入する時、クレジットカードやPayPalを使われている方は自動で両替されるためあまり為替レートを意識することも少ないかもしれません。輸送コストに加え、この為替の両替手数料は意外とトータルコストに響きます。少しでもコストを抑えてショッピングできる、WISEデビットカードが便利です。カードを作るのに1,200円が掛かることと多少本人確認作業に手間は掛かりますが月額の口座管理料などは掛からないため持っておくと便利なカードです。外貨口座を持てるので、海外送金も廉価に行えます。アカウントを作るにはマイナンバーカードが必要です。</p><span id="more"></span><h2 id="匿名によるショッピングのメリットと為替手数料"><a href="#匿名によるショッピングのメリットと為替手数料" class="headerlink" title="匿名によるショッピングのメリットと為替手数料"></a>匿名によるショッピングのメリットと為替手数料</h2><p>米国eBayをはじめとする海外の通販サイトでパーツやIT機器をショッピングされる方はPayPalを使っていらっしゃる方が多いのでは無いでしょうか。クレジットカードを使う際のトラブルなどを考えると、住所はともかく、クレジット番号を販売者に知られたくないというのはもはや基本事項になってきていると感じます。ApplePayの利用は海外では大きく売上を伸ばしていると聞きます。日本でも個人対個人における商取引のメルカリなどは住所や支払い口座など匿名が大原則ですね。</p><p>PayPalはeBayをはじめ対応しているサイトが多く、日本国内、海外に限らずよく利用されます。しかしながらPayPalの場合は日本のユーザーだと円決済でPayPalが為替レートを提示し、そのレートで外貨に両替の上取引が成立します。この手数料が4％とかなり高額です。</p><p>もちろん、商売でやっていることなので一定のフィーが掛かるのはわかりますが、そのコストをユーザーからわかりづらくして4％という高額な手数料を徴収するのは私は少し抵抗があります。また、海外サイトでの為替レートの提示は例えば130円&#x2F;ドルという我々が見慣れた表記ではなく、ドル&#x2F;円表記なので”0.00769”と提示されるため余計に分かりづらくなっています。</p><h2 id="ドルの両替相場"><a href="#ドルの両替相場" class="headerlink" title="ドルの両替相場"></a>ドルの両替相場</h2><p>円からドルに交換した場合、有名なクレジットカード会社、Amazon.com、PayPal、Wiseと比較しています。</p><table><thead><tr><th>両替会社</th><th>手数料</th><th>URL</th></tr></thead><tbody><tr><td>三井住友カード</td><td>2.20%</td><td><a href="https://www.smbc-card.com/mem/service/sec/kaigai01.jsp">https://www.smbc-card.com/mem/service/sec/kaigai01.jsp</a></td></tr><tr><td>楽天カード Mastercard</td><td>1.63%</td><td><a href="https://www.rakuten-card.co.jp/overseas/payment/">https://www.rakuten-card.co.jp/overseas/payment/</a></td></tr><tr><td>楽天カード Visa</td><td>1.63%</td><td></td></tr><tr><td>楽天カード JCB</td><td>1.60%</td><td></td></tr><tr><td>イオンカード Mastercard</td><td>1.60%</td><td><a href="https://www.aeonbank.co.jp/aeoncard/use/shopping_w/">https://www.aeonbank.co.jp/aeoncard/use/shopping_w/</a></td></tr><tr><td>イオンカード Visa</td><td>1.60%</td><td></td></tr><tr><td>イオンカード JCB</td><td>1.60%</td><td></td></tr><tr><td>PayPayカード Mastercard</td><td>2.20%</td><td><a href="https://card.yahoo.co.jp/service/faq/04usage/oversea/1401.html">https://card.yahoo.co.jp/service/faq/04usage/oversea/1401.html</a></td></tr><tr><td>PayPayカード Visa</td><td>2.20%</td><td></td></tr><tr><td>PayPayカード JCB</td><td>1.60%</td><td></td></tr><tr><td>Amazon.com</td><td>1.45%</td><td>Yahoo  financeの週末レート(134.9600)とAmazon.comのCheckoutレート(136.9163950055)を確認（6&#x2F;18）</td></tr><tr><td>PayPal</td><td>4.00%</td><td><a href="https://www.paypal.com/jp/webapps/mpp/paypal-fees#no-fee">https://www.paypal.com/jp/webapps/mpp/paypal-fees#no-fee</a></td></tr><tr><td>Wise</td><td>0.60%</td><td><a href="https://wise.com/jp/pricing/card-fees?sourceAmount=100000&amp;sourceCcy=JPY&amp;targetCcy=USD">https://wise.com/jp/pricing/card-fees?sourceAmount=100000&amp;sourceCcy=JPY&amp;targetCcy=USD</a></td></tr></tbody></table><p>10万円のものを購入して、Wiseでは約600円、2.2％のカード会社であれば約2,200円です。PayPalに至っては約4,000円にもなります。</p><h2 id="Wise社とは"><a href="#Wise社とは" class="headerlink" title="Wise社とは"></a>Wise社とは</h2><p>Wiseは、第二種資金移動業として関東財務局に「ワイズ・ペイメンツ・ジャパン株式会社」として登録されています。金融というよりはFintechの会社というところでしょうか。また、顧客から預かった資産は自己の資産とは分別して管理されています。</p><blockquote><p>金融庁　資金移動業社登録一覧<br> <a href="https://www.fsa.go.jp/menkyo/menkyoj/shikin_idou.pdf">https://www.fsa.go.jp/menkyo/menkyoj/shikin_idou.pdf</a></p></blockquote><p>Wise社はエストニア出身の二人が作った会社でロンドン証券取引所に上場しています。世界各国にWebサイトがあります。<br>Wiseデビットカードを作ると200カ国で利用できます。このブログではその機能の一部、海外通販の決済についてしか触れませんが、海外のATMで外貨を引き出したり海外送金したり外貨を受け取ることができます。</p><blockquote><p>Wise<br><a href="https://wise.com/">https://wise.com</a></p></blockquote><h2 id="口座開設"><a href="#口座開設" class="headerlink" title="口座開設"></a>口座開設</h2><p>口座を作るのは無料ですが、実質的にデビットカードが必要ですので1,200円が掛かります。年会費は無料です。</p><p>口座開設は本人確認が必要ですが、日本の金融機関と同じように、2つの本人確認、つまり、本人の証明と身元確認が必要です。<br>日本の法律としては犯罪収益移転防止法と税法との関係で、マイナンバーカードが必要になります。<br>本人確認はFintech企業らしく、eKYCで行われます。免許証・マイナンバーカードで犯収法の確認を行い、さらに税法上、マイナンバーの提出義務があります。この2つが身元証明です。そしてメモ紙に4桁の数字を書かされ、それを持った自分自身を写メし、画像をアップロードすることで間違いなく本人であることの証明が行われ、口座開設の本人確認が終了します。<br>運転免許証で犯収法への確認はOKですが、税法上の理由で結局はマイナンバーカードが必要です。過去に発行されたマイナンバーの通知カードでは対応できません。</p><p>マイナンバーカードの写メを撮ってアップロードしたり、4桁の数字を片手で持ってもう片手のスマホで写メを撮って海外企業に送るというのは、若干の抵抗はあります。が、今の日本の法律がそれを求めているので必要なことです。</p><h2 id="デビットカード"><a href="#デビットカード" class="headerlink" title="デビットカード"></a>デビットカード</h2><p>口座開設が完了したら、まずは口座に入金が必要です。国内の指定された銀行口座に円で振り込みます。最低1,200円を振り込み、デビットカードの作成に進みます。クレジットカードとは異なり、後払いではなく事前入金が必要です。入金時は、振り込み名義人にWiseの口座番号を指定するのが必要です。これを行わず普通の仮名氏名で送ってしまうと入金確認に数日掛かってしまいます（私は最初これで数日掛かってしまいました）。通常は3時間程度で反映されます。</p><p>また米ドルやユーロなど使うと想定される口座を開ける必要があります。米ドル口座を開くと日本の金融機関では馴染みのない、個人のルーティングナンバーが付与され、米ドルの銀行口座として使用可能になります。海外で仕事をする時など、このルーティングナンバーを指定して振り込んでもらいます。海外通販の決済に使う場合はこのルーティングナンバーは使うことはありませんが、日本に居ながらここまでできるのは結構すごいことだなと感心しました。</p><p>その後、マスターカードのアイコンがついたデビットカードが2〜3週間程度で届けられます。</p><p>黄緑色のカードで表には識別する番号や名前などはありません。Mastercardのマークついており、裏面にはカード番号、名前が記入されています。</p><p>さて、届いてすぐに使えるわけではなく、後払いのクレジットカードとは違い、まず円で入金しておかなければなりません。デビットカードを作るときに余分に円を入れておけばその金額分は普通にショッピングで使えます。<mark class="label primary">Mastercardコンタクトレス</mark>、すなわちタッチ決済が使えますので、国内のコンビニでも気軽に使えます。</p><p>最初に使うのにはお作法が必要で、指定のATMで残高照会をしてデビットカードを有効化する必要があります。<br>以下のページにあるように、有効化には以下の場所で残高照会をする必要があります。</p><ul><li>イオン</li><li>イーネット</li><li>ビューカード</li><li>デイリーヤマザキ</li></ul><p>私はイオン銀行のATMで残高照会をしてみましたが使えないカードと言われてしまいました。。。<br>結局ファミリーマートのATMのイーネットで残高照会をし有効化できました。残高照会時に照会する口座種別を聞かれたように記憶していますが、その際は「チェッキング」を選択します。チェッキングは決済用口座で一般的に決済用の用途で利用され、金利がつかない口座のことです。</p><blockquote><p>Wiseデビットカードを有効化する方法<br> <a href="https://wise.com/ja/help/articles/2978024/">https://wise.com/ja/help/articles/2978024/</a></p></blockquote><p>その日のうちにコンビニでタッチ決済を使ってみましたが、利用の記録もアプリで確認できました。</p><h2 id="アプリと両替"><a href="#アプリと両替" class="headerlink" title="アプリと両替"></a>アプリと両替</h2><p>Wiseのアプリをスマホにインストールしておくと便利です。好きなタイミングで外貨に交換できます。あらかじめ両替しておいてももちろん構いませんが、円貨のまま保有していても通販で購入時にWise側で外貨に自動的に両替してくれるので便利です（特に割り増し手数料などはありません）。もちろん、事前にある程度まとまった金額をドルに変えておいても良いですね（今後さらに円安に振れるとお考えなのであれば）。アプリは2要素認証に対応しており、Webログイン時にプッシュ通知で確認を求められるように設定できます。</p><p>両替自体はマーケットレートを使って一瞬で交換が成立します（その時に手数料も差し引かれます）。</p><p>なお、自動両替という機能もあり、レートを指定しておくと、そのレートになった時に両替してくれる機能もあります。</p><h2 id="ネットショッピングでの使い方"><a href="#ネットショッピングでの使い方" class="headerlink" title="ネットショッピングでの使い方"></a>ネットショッピングでの使い方</h2><p>Amazon、eBay(PayPal)など外貨で決済を使うユーザーに最も適しています。</p><h3 id="eBayの場合"><a href="#eBayの場合" class="headerlink" title="eBayの場合"></a>eBayの場合</h3><p>仮にConnect X-3をeBayで購入するとしましょう。</p><img src="/new-technology/2022/06/28/multi-currency-account/ebay1.png" class="" width="1024" title="alt"><p>カートに入れて…USDを選んで…</p><img src="/new-technology/2022/06/28/multi-currency-account/ebay2.png" class="" width="1024" title="alt"><p>確認、ここで気を付けてください！！「今すぐ支払う」をクリックしてはいけません。</p><img src="/new-technology/2022/06/28/multi-currency-account/ebay3.png" class="" width="480" title="alt"><p>eBayでドル払いと言いつつ、PayPalが円からドルに4％の手数料で両替し、円＋手数料をPayPalに払うことになってしまうんです。<br>わざと目立たなくしている、「通貨オプションを表示」をクリックする必要があります。ここでは私が赤枠で囲っていますが、人間の目線をうまく回避するかのような絶妙な右側の外れた位置にポツンと円表記があります。</p><img src="/new-technology/2022/06/28/multi-currency-account/ebay4.png" class="" width="480" title="alt"><p>これは毎回「通貨オプションを表示」をクリックする必要があります。</p><p>USDをクリックして確実にWiseでドル払いにして決済します。</p><img src="/new-technology/2022/06/28/multi-currency-account/ebay5.png" class="" width="480" title="alt"><h3 id="Amazon-comの場合"><a href="#Amazon-comの場合" class="headerlink" title="Amazon.comの場合"></a>Amazon.comの場合</h3><p>こちらも同じような状況です。ipolexの2PortのX710がありました。でも高いですね。。。4ヶ月前にX710の4Portが$500だったのに2Portで＄420です。。</p><img src="/new-technology/2022/06/28/multi-currency-account/amazon1.png" class="" width="1024" title="alt"><p>Amaon.comの場合は、普通にクレジットカードのようにカード番号を入力して購入します。私はドル払いでしかAmazon.comで購入したことはありませんが、デフォルトは円払いになっています。良い点は為替レートが良心的であることでしょうか。それでも約1.5％ですね。あとは1ドル137円という表記で多少は分かりやすいのが良いところでしょうか。</p><img src="/new-technology/2022/06/28/multi-currency-account/amazon2.png" class="" width="1024" title="alt"><p>こちらもドル払いに変更して、チェックアウトします。</p><h2 id="リスク"><a href="#リスク" class="headerlink" title="リスク"></a>リスク</h2><p>便利なデビットカードによるショッピングですがデメリットもあります。一般的なクレジットカードに付帯されている海外通販などの保険がありません。Wiseの約款においてはショッピング保険などの対応は一切できないことが明確です。従い、多くのサイトでカード番号を入力せずに、信頼のおけるサイトやタッチ決済などのクレカ番号が相手に知られない決済方法に限り利用すべきでしょう。</p><h2 id="利用限度額"><a href="#利用限度額" class="headerlink" title="利用限度額"></a>利用限度額</h2><p>Wiseのアプリでは利用限度額が設定できます。</p><ul><li>ATM引き出し</li><li>ICチップ決済（暗証番号を使った決済）</li><li>磁気ストライプ決済</li><li>オンラインでの支払い</li><li>コンタクトレス決済</li></ul><p>これだけ細かく設定できればカード紛失を想定しあらかじめ設定しておけるでしょう。</p><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>海外の色々なものが割高になっているので気軽に買い物できる状況には無いかもしれませんが、持っておいて損はないカードです。是非検討される事をお勧めします。</p>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2022/06/28/multi-currency-account/wise.png&quot; class=&quot;&quot; width=&quot;1024&quot; title=&quot;alt&quot;&gt;

&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;

&lt;p&gt;最近の円安や物価高と慢性的な在庫不足によりIT機器も買いづらい状況が続いています。海外通販でパーツ等を購入する時、クレジットカードやPayPalを使われている方は自動で両替されるためあまり為替レートを意識することも少ないかもしれません。輸送コストに加え、この為替の両替手数料は意外とトータルコストに響きます。少しでもコストを抑えてショッピングできる、WISEデビットカードが便利です。カードを作るのに1,200円が掛かることと多少本人確認作業に手間は掛かりますが月額の口座管理料などは掛からないため持っておくと便利なカードです。外貨口座を持てるので、海外送金も廉価に行えます。アカウントを作るにはマイナンバーカードが必要です。&lt;/p&gt;</summary>
    
    
    
    
  </entry>
  
  <entry>
    <title>10GネットワークとSFP+</title>
    <link href="https://yoshi0808.github.io/new-technology/2022/05/28/sfp-plus/"/>
    <id>https://yoshi0808.github.io/new-technology/2022/05/28/sfp-plus/</id>
    <published>2022-05-27T15:00:00.000Z</published>
    <updated>2023-05-17T10:11:09.527Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2022/05/28/sfp-plus/title.png" class="" width="1024" title="alt"><p class="onepoint">この記事で実現すること</p><p>リモートワークやインターネット回線の高速化に伴い、10Gネットワークが普及し、10GBase-Tの発熱に対する声が聞かれます。10Gネットワークにおいては従来のLANケーブルではなく光ファイバーで省電力化と低発熱が実現できる、SFP+が選択肢となります。実はあまり知られていない低遅延の効果もあります。2023年4月以降段階的に各地で電気代が値上げされることになりました。また、5月中旬というのに夏のような暑さが到来しています。毎年恒例ですが、発熱対策の気になる季節になってきました。この記事は1年前に投稿したものですが、最近の情勢を踏まえて1年ぶりにアップデートするもので、10Gネットワークを前提にSFP+についてまとめています。</p><span id="more"></span><h2 id="10Gネットワークの消費電力と発熱"><a href="#10Gネットワークの消費電力と発熱" class="headerlink" title="10Gネットワークの消費電力と発熱"></a>10Gネットワークの消費電力と発熱</h2><p>10GBase-Tの消費電力は1Portあたり3W程度で、単体で見るとさほど大きいものではありませんが、スイッチなどそれが4Port&#x2F;8Portとなると全体で30W以上の消費電力となり、PC程度のものになってきます。<br>10Gbase-Tのネットワーク機器が出す熱は軽く40度を超え、夏場は60度を超える場合もあります。そもそも10Gbpsという高速処理は負荷が高いのに加え、10GBase-Tに必要なエラー訂正とアナログ&#x2F;デジタル変換の負荷が高くなります。モジュールの消費電力に比例して温度も高くなる傾向があります。</p><p>発熱はスイッチやネットワークカード、PC本体などその周辺機器に悪影響を与えます。特に真夏で部屋の温度が40度近くに達する場合は、これらの高熱を出す機器も内部温度は70度近くに上がってしまい一気に故障する可能性が高くなります。ファンが付いているスイッチは大きいファンノイズが発生しますし、エアコンやファンでエアフローにも気を遣う必要が出てきます。一般的な建売戸建やマンションでクローゼットに回線引き込みがされ、各部屋へのCD管またはPF管が集約されている場合、そこにルーターやスイッチングハブを設置せざるを得ません。こうなると発熱対策、騒音対策が結構な問題になってきます。</p><p>私の自宅の2階のクローゼットの中にある、インターネット配線設備（マルチメディアポート）の内部。家の中で最も熱が篭る場所に配置されています。。。</p><img src="/new-technology/2022/05/28/sfp-plus/mmport.png" class="" width="1024" title="alt"><p>右手前がホームゲートウェイ、配線設備の内部にテレビアンテナケーブル（黒）、電話線（グレー）、auひかりのシングルモードファイバケーブル（白）、スイッチングハブから各部屋へのCat6 UTPケーブル（青）、マルチモードファイバケーブル（水色）を通しています。マルチメディアポートの奥に各部屋に繋がるオレンジ色のCD管（直径2cm）が見えます。</p><h2 id="SFP-x2F-SFP-とは"><a href="#SFP-x2F-SFP-とは" class="headerlink" title="SFP&#x2F;SFP+とは"></a>SFP&#x2F;SFP+とは</h2><p>SFPはSmall Form-factor Pluggableの略で光ファイバーの通信に使われるもので、個人向けのネットワーク機器においても利用可能な価格帯のハードウェアです。本来は遠距離の通信や高速化が主で法人向けでしたが、普及に伴い、価格がこなれてきました。個人向けには発熱を抑えた高速通信という意味で利用価値があります。レイテンシが小さく、自宅の通信経路にFirewallやルーターを通しても遅延が少なく済みます。</p><p>10Gネットワークのタイプとレイテンシ</p><table><thead><tr><th>タイプ</th><th>レイテンシ</th></tr></thead><tbody><tr><td>1000Base-T</td><td>10マイクロ秒前後（幅が大きい）</td></tr><tr><td>10GBase-T</td><td>2〜2.5マイクロ秒</td></tr><tr><td>SFP+</td><td>0.3マイクロ秒</td></tr></tbody></table><p>1000Base-TのネットワークでFirewallやルータを挟むと10マイクロ秒のレイテンシが、HGW、ファイアウォールWAN、ファイアウォールLAN、クライアントへとそれぞれがパケット単位で時間を要し、ファイアウォール自身が高性能であっても「ファイアウォールが遅い」という話になります。また、大きなファイルをダウンロードしないから10Gネットワークが不要というわけではなく、一つひとつの処理をキビキビと動作させるためにSFP+の利用価値があります。通常1,500バイトのMTUを9,000バイトとしたジャンボフレームの設定で遅延を緩和できますが、抜本的改善としてSFP+を選択する効果は大きいです。</p><p>SFPは主として光ケーブルを接続するためのインタフェースです。スイッチやネットワークカードにはSFPスロット（ポート）があり、SFPモジュール（トランシーバとも呼ばれます）を挿して使います。モジュールは光ケーブル、銅線のダイレクトアタッチケーブル、従来のLANケーブル（RJ-45端子）などを接続可能なインタフェースがあります。SFPはさまざまなモジュールを使い分けることにより、速度、距離、ケーブルの種類に対応できます。</p><img src="/new-technology/2022/05/28/sfp-plus/sw.png" class="" width="1024" title="alt"><p>RJ45を持たず、SFP&#x2F;SFP+スロットしかないスイッチもあります。もちろん、前述したRJ45モジュールを接続して従来のツイストペアケーブルを使えます。</p><h2 id="距離、ケーブルの種類によるモジュールの使い分け"><a href="#距離、ケーブルの種類によるモジュールの使い分け" class="headerlink" title="距離、ケーブルの種類によるモジュールの使い分け"></a>距離、ケーブルの種類によるモジュールの使い分け</h2><p>ホームユーザーが自宅でSFPモジュールを使い分けるには、既存ケーブルの有無、配線の距離、価格面の優位性を見ながら選択することになります。</p><table><thead><tr><th>名称</th><th>距離</th><th>お勧め度</th><th>消費電力</th><th>発熱</th><th>補足説明</th></tr></thead><tbody><tr><td>パッシブダイレクトアタッチケーブル(DAC)</td><td>〜7m</td><td>◎</td><td>0.2w</td><td>微弱</td><td>安価。Twinaxとも呼ばれる</td></tr><tr><td>アクティブダイレクトアタッチケーブル</td><td>〜15m</td><td>△</td><td>1w未満</td><td>弱</td><td>殆ど見かけない</td></tr><tr><td>アクティブオプティカルケーブル(AOC)</td><td>〜100m</td><td>◯</td><td>0.5w〜2w</td><td>弱</td><td>流通量少ない（高価）</td></tr><tr><td>MMFモジュール（10GBase-SR）+OM3ケーブル</td><td>〜300m</td><td>◎</td><td>0.6W</td><td>弱</td><td>安価、取り回しやすい</td></tr><tr><td>SMFモジュール＋SM1 or SM2ケーブル</td><td>100m〜40km〜</td><td>△</td><td>0.6w〜1w</td><td>弱</td><td>長距離向け、ケーブルが折り曲げに弱い</td></tr><tr><td>10GBase-Tモジュール</td><td>〜80m</td><td>◯</td><td>2.5W〜3w</td><td>強</td><td>高発熱、やや高額</td></tr></tbody></table><p>SFP&#x2F;SFP+は対向機器の電源が入っていなくてもモジュールを挿すだけで電力を消費します。単体をスイッチに挿し、対向が接続していない状態でDACと1000Base-Tは0.1W程度の消費で誤差の範囲ですが、10GBase-SRは単体で0.5W消費します。10GBase-Tモジュールは1W程度消費します。</p><h3 id="DAC"><a href="#DAC" class="headerlink" title="DAC"></a>DAC</h3><img src="/new-technology/2022/05/28/sfp-plus/dac.png" class="" width="1024" title="alt"><p>DACは1,500円&#x2F;mと安価であり、ケーブルにはモジュールも両端に付いているので別途モジュールを購入する必要はありません。DACのケーブル長はモジュールの端から端までの距離を示すため、50cmや1mのDACは思ったより短いという印象を持ちやすいです。</p><p>パッシブDACは銅線（Copper）で、1mであればCat6の一般的なケーブルよりは細いですが、しなやかさは劣ります。7mまでの距離に応じて線の太さが太くなります。端末、スイッチ間の距離が7m未満であればパッシブダイレクトアタッチケーブル（DAC）を最優先に選定します。DACと言えば、一般的にはパッシブのことを言います。特に電流を増幅させずそのままデータを送信するので発熱が極めて少ないですが、距離の制限があります。ホームユーザーが熱対策を考える場合、どうにかして7mの距離以内に端末・スイッチを配置する事が最優先となります。アクティブDACは信号を増幅させる仕組みを使っていますが、現代では殆ど見かけません。</p><h3 id="AOC"><a href="#AOC" class="headerlink" title="AOC"></a>AOC</h3><img src="/new-technology/2022/05/28/sfp-plus/aoc.png" class="" width="480" title="alt"><p>AOCケーブルは見た目はDACと同じで両端にモジュールが付いており、線の内部は光が使われます。短いケーブルはOM3ですが距離が長いAOCはOM4が使われます。ユーザーにシングルモード&#x2F;マルチモードのことやケーブルの種類を意識させず、ケーブルの距離だけを意識して選定するというソリューションですが、それなりに知識のある人がSFPを選定する事を考えると、SFPトランシーバとOM3、OM4ケーブルを個別に選定することが一般的で、購入先もなかなか見つからないかもしれません。</p><h3 id="MMF-10GBase-SR-OM3ケーブル"><a href="#MMF-10GBase-SR-OM3ケーブル" class="headerlink" title="MMF 10GBase-SR+OM3ケーブル"></a>MMF 10GBase-SR+OM3ケーブル</h3><p>7mを超える距離、例えば異なる部屋にLANを通す場合には、10GBase-SRモジュールとOM3光ケーブルを使います。SRとはShort Reach（短距離）の意味です。光ケーブルも発熱は少なく、マルチモードファイバは、かなりケーブルが細くしなやかです。ただし、ツイストペアケーブルほどは強いものではなく、極端な折り曲げは通信エラーになりますし、通線ワイヤーを使い各部屋を通す場合には強い力でぐいぐいと引っ張るわけにもいきません。うっかり足を引っ掛けると断線しますし、ケーブルを絨毯の下に這わせたり、ドアの隙間を通したりするのは難しいでしょう。丁寧に扱う必要があります。</p><img src="/new-technology/2022/05/28/sfp-plus/om3.png" class="" width="1024" title="alt"><p>SFP+の10Gbpsで利用するマルチモードファイバは、LC-LCという2対の組みをトランシーバに挿して使います。2本の光ファイバがセットになり、送信用（Tx)と受信用（RX)とに役割があります。また、速度によってケーブルの被覆の色が決められており、OM3、OM4はアクアジャケットになります。<strong>2本の線があるからマルチではなく</strong>、1本の線の中で複数の光の波形を通すのでマルチモードと呼ばれます。</p><table><thead><tr><th>MMF</th><th>1Gbps</th><th>10Gbps</th><th>40Gbps</th><th>100Gbps</th><th>ジャケット色</th></tr></thead><tbody><tr><td>OM1</td><td>275m</td><td>33m</td><td>ー</td><td>ー</td><td>オレンジ</td></tr><tr><td>OM2</td><td>550m</td><td>82m</td><td>ー</td><td>ー</td><td>オレンジ</td></tr><tr><td>OM3</td><td>ー</td><td>300m</td><td>100m</td><td>70m</td><td>アクア</td></tr><tr><td>OM4</td><td>ー</td><td>550m</td><td>150m</td><td>150m</td><td>アクア</td></tr><tr><td>OM5</td><td>ー</td><td>550m</td><td>150m</td><td>150m</td><td>ライム</td></tr></tbody></table><p>OM3は1,500円&#x2F;10m、2,500円&#x2F;20mです。OM4は2,200円&#x2F;10mです(販売会社によって若干のばらつきがあります)。ケーブルを自宅内に敷設するなら、将来の拡張性のために40Gbps&#x2F;100Gbpsを150mの距離に対応しているOM4を選択しても良いように見えます。しかし今のところ25GbpsのスイッチはSFP28インタフェースとなりOM3のLC-LCケーブルが使えますが、40Gbpsはスイッチ側がQFSPインタフェースとなり、LC-LCではなくMPOケーブルとなります。個人向けという意味では、PF管&#x2F;CD管を通す場合のMPOコネクタは幅・厚みがあることで、管を通すことが難しくなります。OM3のLC-LCであれば、（1ペアづつ地道に通線させ）直径2cmの管に3本〜4本程度のOM3ケーブルを通せます。</p><h3 id="10GBase-Tモジュール、1000Base-Tモジュール"><a href="#10GBase-Tモジュール、1000Base-Tモジュール" class="headerlink" title="10GBase-Tモジュール、1000Base-Tモジュール"></a>10GBase-Tモジュール、1000Base-Tモジュール</h3><p>既存のRJ45端子のLANケーブル（UTPケーブル）を接続するためのモジュールです。10GBase-Tの口を持っていないSFP+のみのスイッチでは、このモジュールを利用し既存の10GBase-T環境と接続します。10GBase-TモジュールはLANケーブルの長さが30mまでを限界としている製品が多いです。ケーブルが長くなれば電力量が増え3Wを超えてしまうためです。通信量と消費電力とは殆ど関係ありません。確かにIEEE802.3azという規格では無通信時は省電力にする仕組みを持っていますが、<strong>消費電力は距離によって変わります</strong>。MarvellではなくBroadcomのチップを使った10GBase-Tモジュールも出てきており省電力で80mまで可能となっています。</p><h3 id="その他ケーブル、トランシーバ"><a href="#その他ケーブル、トランシーバ" class="headerlink" title="その他ケーブル、トランシーバ"></a>その他ケーブル、トランシーバ</h3><ul><li><p>SCケーブル</p> <img src="/new-technology/2022/05/28/sfp-plus/sc.png" class="" width="600" title="alt"><p> 古い規格の光ファイバ端子です。GBICとも呼ばれます。これが対となりSC-SCケーブルというものになりますが、SFP&#x2F;SFP+モジュールには接続できません。</p></li><li><p>MPOケーブル</p> <img src="/new-technology/2022/05/28/sfp-plus/mpo.png" class="" width="600" title="alt"><p> 40GbpsのQFSPトランシーバ（QSFP-40G-SR4）に利用されます。SFP&#x2F;SFP+&#x2F;SFP28とは互換性がありません。</p></li></ul><h2 id="モジュールの互換性・ベンダーロックイン"><a href="#モジュールの互換性・ベンダーロックイン" class="headerlink" title="モジュールの互換性・ベンダーロックイン"></a>モジュールの互換性・ベンダーロックイン</h2><p>SFP+を語るときに外せないテーマが、互換性の問題とベンダーロックインです。まず互換性の問題ですが、背景としてはSGMIIというCiscoが提唱した方式がデファクトスタンダードとなり、他のメーカーがSGMII対応に倣ってきたため、各社仕様が微妙に異なる状況となっており、互換性の問題で接続できないケースが発生します。また、ベンダーロックインはCisco&#x2F;HP&#x2F;intelなどのメーカーが設定しており、動作を担保するためにテスト済みのモジュール以外は使えないようになっています。SFPはMSA（マルチソースアグリーメント）によって業界で標準化されたトランシーバデバイスとして、可能な限り規格を統一されるように取り組まれています。</p><h3 id="MMFモジュールの互換性"><a href="#MMFモジュールの互換性" class="headerlink" title="MMFモジュールの互換性"></a>MMFモジュールの互換性</h3><p>MMFモジュールの互換性については、Cisco&#x2F;intel&#x2F;Dell&#x2F;Mellanox&#x2F;HPというグループに分かれます。この互換性に基づきMMFモジュールを購入する必要があります。</p><p>MMFモジュールの互換性グループ</p><table><thead><tr><th>メーカー</th><th>企業属性</th><th>その他互換性のあるメーカー</th></tr></thead><tbody><tr><td>Cisco</td><td>ネットワーク</td><td>Ubiquiti、Mikrotik、NETGEAR</td></tr><tr><td>HP</td><td>サーバー</td><td></td></tr><tr><td>DELL</td><td>サーバー</td><td></td></tr><tr><td>intel</td><td>半導体</td><td></td></tr><tr><td>Mellanox</td><td>半導体・ネットワーク</td><td></td></tr></tbody></table><p>ネットワーク業界においてデファクトスタンダードとなったCiscoのグループは、一般的にUbiquiti、NETGEAR、Mikrotikというネットワーク機器メーカーで互換性があります。<br>Dell&#x2F;HPはサーバーのメーカーです。intel&#x2F;Mellanoxは半導体メーカーです。全体を俯瞰してみると3社の関係性が見えてきます。Ciscoは最もシェアが大きいネットワークメーカーなので他のネットワークメーカーもその接続性が大事になります。また、サーバーメーカーは、自社のライザーカード&#x2F;メザニンカードという独自の拡張カードを提供し、その上にネットワークカードを載せていたため、そもそも他のサーバーメーカーとの互換性はありません。唯一、intel&#x2F;Mellanoxは彼らにとってHP&#x2F;DELLは大切なお客様なはずで互換性を持っても良いのでは無いかと思うところです。しかしながらNICとSFP+モジュールの関係においてはあまりサーバーのメーカーは関係がなく、半導体メーカーとしてのNICとSFP+はセットでサーバーメーカーに卸すため、半導体メーカーで相互に接続する事は求められなかったのでしょう。</p><h3 id="MMFモジュールのベンダーロックイン"><a href="#MMFモジュールのベンダーロックイン" class="headerlink" title="MMFモジュールのベンダーロックイン"></a>MMFモジュールのベンダーロックイン</h3><p>それぞれの業界のトップシェアの会社（Cisco&#x2F;HP&#x2F;intel）はベンダーロックインの道を選びました。ベンダーロックインはプリンタが良い例で、本体を安く販売し、メーカー専用インクで利益を上げるビジネスモデルです。NIC&#x2F;SFP+の場合は、同一のベンダーのSFP+モジュールでないと使えないというものです。ただ、個人的にはプロテクトというよりは、互換性のテスト済みか否かという点で牽制という意味合いが強いのでは無いかと思います（Ciscoはコマンドの設定で他社モジュールの利用を受容します）。昨今ではモジュールメーカーがこれらの互換性についてノウハウを持っており、過度にベンダーロックについて気にする必要はなく、上記のグループにおける互換性を守ることがまずは基本です。<br>2015年にはHPは分社化し法人部隊がHPEとなり、Arubaも買収しているので、細かいことを言えばこの２つのメーカーはもう少し複雑です。</p><p>これらを守れば100％接続できるというわけではありませんので、事前の下調べをお勧めします。</p><p>SFP+ RJ45モジュールも内部的にはMMFモジュールと見せかけて動作させるようになっているので互換性についてはMMFモジュールと同様です。</p><h3 id="DACの互換性"><a href="#DACの互換性" class="headerlink" title="DACの互換性"></a>DACの互換性</h3><p>DACについては、「Cisco、intelまたはその他色々なメーカー」という大まかな分類で売っていることが多いです。そして殆どのメーカーのNICにもネットワーク機器にも繋がるものですが、ネットワーク装置側が規格に対応していれば、という条件付きです。国内のネットワークメーカーなどではDACの種類を選ぶ機器もあるようです。まずはネットワーク機器を購入される前に<strong>ネットワーク機器のメーカー</strong>に相談されることをお勧めします。海外製品は口コミも多いので状況がよく把握できます。セキュリティ製品などは互換性が厳しくなっています。<br>稀なケースですが、互換性が不十分でDACで接続できない場合は、MMFモジュール＋OM3の方式で接続します。例えば、ホストのNICがintelでスイッチがCisco互換機であれば、両端のモジュールはそれぞれのベンダーのモジュールを購入します。</p><p>DACでは（基本的には）ベンダーロックインというよりは繋がらないのはほぼ互換性の問題です。DACは既に両端にモジュールが付いていますから、異なるベンダーの機器を接続する時にどちらかのベンダーの互換性を重視して購入する事がポイントになります（ですので<strong>DACでベンダーロックインという事になるとネットワーク機器とサーバー（NIC）間の他社接続が出来ないわけで現実的にそれを好むベンダーは存在しない</strong>というものです）。残念ながらDACであっても互換性の問題は実際に存在しますので、NIC側の互換性をメインに考えるか、スイッチなどのネットワーク機器の互換性をメインに考えるか判断が必要です。</p><h3 id="その他ネットワーク機器と接続するMMFモジュールの互換性"><a href="#その他ネットワーク機器と接続するMMFモジュールの互換性" class="headerlink" title="その他ネットワーク機器と接続するMMFモジュールの互換性"></a>その他ネットワーク機器と接続するMMFモジュールの互換性</h3><p>例えばQNAPというNASメーカーもスイッチは販売していますが、ネットワークの世界で見れば、マイナーなメーカーになります。またNETGEARなどは純正モジュールを販売しており、互換モジュールへの対応状況はメーカーサポートとしても言及が難しくなります。過去からの経緯に鑑み、Cisco互換モジュールを中心に選定しますが、メーカーサポート&#x2F;コミュニティ&#x2F;口コミを参考に購入していくことになります。</p><h2 id="SFP-モジュールの価格"><a href="#SFP-モジュールの価格" class="headerlink" title="SFP+モジュールの価格"></a>SFP+モジュールの価格</h2><p>それぞれのモジュールの価格帯は以下の通りです。</p><table><thead><tr><th>タイプ</th><th>国内価格</th></tr></thead><tbody><tr><td>DAC</td><td>1,500円〜2,500円</td></tr><tr><td>MMF+OM3</td><td>MMF 3,000円強(1つの値段)、OM3ケーブル 1,500円前後&#x2F;10m</td></tr><tr><td>1000Base-T</td><td>3,000円〜4,000円（1つの値段）</td></tr><tr><td>10GBase-T</td><td>10,000円（1つの値段）</td></tr></tbody></table><p>FS社のモジュールは世界的に見てもよく利用されています。日本語のWebサイトがあり円建てで購入できます。海外通販を利用する際、通常は2％程度の為替手数料を、PayPalに至っては通貨の追加設定をしないと4％の割高な為替手数料を適用されます。また、最近高騰している輸送コストでかえって割高になってしまいます。</p><blockquote><p>FS 10Gモジュール<br> <a href="https://www.fs.com/c/10g-sfp-2320">https://www.fs.com/c/10g-sfp-2320</a></p></blockquote><p>FSのWebサイトは法人向けがメインとあって、モジュールの注文画面ではCisco、Juniper、Aristaと有名な海外ベンダー名が列挙されています。<mark class="label primary">もっと＋</mark>ボタンをクリックするとNetgear、intel、Mellanoxなどの名前が出てきます。それでも該当するメーカーが無い場合は<mark class="label primary">カスタム</mark>のボタンをクリックすると、カスタムモジュールの注文画面に遷移し、さらに細かなベンダー一覧が表示されます。見つからない場合、<mark class="label primary">対応ブランド</mark>に「その他」を、<mark class="label primary">デバイスの型番</mark>に、メーカーと型番を記入すればOKです（FS社から教えてもらいました）。無償の技術サポートがあり質問もできます。法人を対象にビジネスされているでしょうし、個人ユーザーが色々聞くのも気が引けるかもしれませんが、きちんと回答してもらえます。</p><img src="/new-technology/2022/05/28/sfp-plus/fs1.png" class="" width="480" title="alt"><p>DACについても互換性が心配な場合は、同様にベンダー名や機器名を記入し注文します。</p><p>FS社は互換性に関する知識が豊富です。しかしながら、あまり極端に「このメーカー専用のDAC」などの販売をしていては、ユーザーは「SFP+は原則互換性がなく、専門家のサポートが無ければ繋がらない」という誤認を与えてしまっているのではないかと思うところがあります。それでも、個人に対してもしっかりサポートしてくれます。</p><p>日本で購入できるグローバルなネットワーク機器メーカーのうち、UbiquitiのSFP+MMFモジュールは廉価です。トータルソリューションとなっており、スイッチとMMFモジュールの接続で悩むことはありません。</p><blockquote><p>Ubiquiti SFP アクセサリー<br> <a href="https://jp.store.ui.com/collections/unifi-accessories/products/sfp-accessory">https://jp.store.ui.com/collections/unifi-accessories/products/sfp-accessory</a><br> <img src="/new-technology/2022/05/28/sfp-plus/ubiquiti.png" class="" width="1024" title="alt"></p></blockquote><h2 id="SFP-モジュールの発熱"><a href="#SFP-モジュールの発熱" class="headerlink" title="SFP+モジュールの発熱"></a>SFP+モジュールの発熱</h2><p>室温26度の状況下でそれぞれのモジュールの温度を計測しました。計測するにあたり以下の機器を使いました。これでモジュールの表面にこの金属のセンサを当てて温度を測ります。</p><img src="/new-technology/2022/05/28/sfp-plus/TM902C.png" class="" width="480" title="alt"><p>併せてスイッチのコマンドラインからモジュールの温度が取得できるのでそれも加え比較します。</p><ul><li>ファン付きスイッチ</li></ul><table><thead><tr><th>No</th><th>タイプ</th><th>実際の温度</th><th>スイッチ上のCLI</th></tr></thead><tbody><tr><td>1</td><td>DAC</td><td>27℃</td><td>なし</td></tr><tr><td>2</td><td>10GBase-SR(10m)</td><td>32.9℃</td><td>36.8℃</td></tr><tr><td>3</td><td>10GBase-SR(20m)</td><td>33.8℃</td><td>39.1℃</td></tr><tr><td>4</td><td>10GBase-T “Broadcom”</td><td>36.2℃</td><td>40.7℃</td></tr><tr><td>5</td><td>10GBase-T “Broadcom” 2.5Gbps動作 <sup><b><a href="#note1">[1]</a></b></sup></td><td>32.3℃</td><td>29.5℃</td></tr><tr><td>6</td><td>10GBase-T “MikroTik” S+RJ10</td><td>40.3℃</td><td>61.0℃</td></tr><tr><td>7</td><td>1000Base-T ASF-GE-T</td><td>34.2℃</td><td>なし</td></tr><tr><td>8</td><td>10GBase-T “Marvell” ASF-10G-T</td><td>40.2℃</td><td>なし</td></tr><tr><td></td><td>(スイッチ:Ubiquiti USW-Pro-Aggregation)</td><td></td><td></td></tr></tbody></table><p><small id="note1">[1]スイッチは2.5Gbpsに対応し、10GBase-Tモジュールを2.5Gbpsでリンクさせています。</small></p><p>No1-5は常にスイッチに挿したまま、6,7,8は計測の都度挿し替えしています。</p><ul><li>ファンレススイッチ</li></ul><table><thead><tr><th>No</th><th>タイプ</th><th>実際の温度</th><th>スイッチ上のCLI</th></tr></thead><tbody><tr><td>1</td><td>10GBase-SR(20m)</td><td>43.6℃</td><td>48.61℃</td></tr><tr><td>2</td><td>1000Base-T ASF-GE-T</td><td>44.6℃</td><td>なし</td></tr><tr><td>3</td><td>10GBase-T “Marvell” ASF-10G-T</td><td>48.6℃</td><td>なし</td></tr><tr><td>4</td><td>10GBase-T “Broadcom”</td><td>45.4℃</td><td>54.3℃</td></tr><tr><td>5</td><td>10GBase-T “MikroTik” S+RJ10</td><td>49.5℃</td><td>67.06℃</td></tr><tr><td></td><td>(スイッチ:Ubiquiti USW-Aggregation)</td><td></td><td></td></tr></tbody></table><p>No1,2は常にスイッチに挿したまま、3,4,5は計測の都度挿し替えしています。</p><p>ファンレスのスイッチは筐体内部に熱を持つため、それがモジュールにも伝播しているのが分かります。また、”実際の温度”はモジュールのコネクタ部分に近い箇所を計測しています。スイッチのCLIで表示される温度は、モジュールのセンサーの1か所の温度でありモジュール全体ではありません。10GBase-SRの出す熱の範囲は高温ながら範囲が限定的で、センサーがなかなか一定数値にはなりませんでした（最も高い数値を採用しています）。10GBase-Tは測る場所によって多少温度は異なりますがモジュール全体から発熱しています。</p><p>60℃を超えるとハードウェア環境面としては相当に厳しいでしょうか。まずはエアフローが大事ということになります。特にファンレススイッチを使う場合、この時期は問題ありませんが、夏場はエアコンまたはサーキュレーターが必要そうです。次に、可能な限り10GBase-Tを使わずDACや10GBase-SRを使い、熱を抑える必要があります。クライアントの10GBase-Tの速度を2.5Gbpsに落とすのも効果的です。ファンレスのスイッチで10GBase-Tを多用すると、スイッチがスローダウンまたはシステムダウンする可能性があります。</p><p>技術面でポイントをまとめると以下の通りです。</p><ul><li>10GBase-Tを多用する場合はファンレススイッチでは厳しい（特に数十mの距離のツイストペアケーブルでは発熱が大きい）</li><li>10Gネットワークを使う場合は可能な限りDACや10GBase-SRへの移行を</li><li>10GBase-TモジュールのBroadcomチップ対応のもの（80m対応）は熱対策には有効</li><li>1000Base-Tのモジュールも意外と発熱する。リビングなど多くの100&#x2F;1000Mbps機器が揃う箇所にはSFPのスイッチはかえって不向き。4Portなどの小型ハブに逃した方が良い</li></ul><p>個人ユーザーのニーズとしては静かなファンレスのスイッチを好む傾向にあり、メーカー側もファンレスや静かなスイッチを販売せざるを得ない傾向のように見えますが、今の10GBase-Tのファンレススイッチは空調がある場所が必要というのが結論です。メインのネットワークスイッチはSFP+を中心に使い、各部屋にOM3で繋いだ上で、ある程度の速度が必要なWi-Fi APやクライアント端末を2.5GbEのUTPで接続する方法が現実的です。24時間稼働するNASもPCIeがあるのであれば、SFP+のネットワークカードを使う事をお勧めします。</p><h2 id="ネットワークカードの消費電力"><a href="#ネットワークカードの消費電力" class="headerlink" title="ネットワークカードの消費電力"></a>ネットワークカードの消費電力</h2><p>intel X710の4Portについて、10GBase-TのモデルとSFP+のモデルとで比較します。</p><table><thead><tr><th>型番</th><th>接続方式</th><th>通常消費電力</th><th>最大消費電力</th></tr></thead><tbody><tr><td>X710T4(旧型)</td><td>UTP(RJ45)4Port 10Gbps</td><td>23.7W</td><td>28.9W</td></tr><tr><td>X710TL4</td><td>UTP(RJ45)4Port 10Gbps</td><td>13.6W</td><td>14.2W</td></tr><tr><td>X710TL4</td><td>UTP(RJ45)4Port 2.5Gbps</td><td>9.5W</td><td>9.9W</td></tr><tr><td>X710DA4</td><td>SFP+4Port 10GBase-SR</td><td>6.2W</td><td>6.6W</td></tr><tr><td>X710DA4</td><td>SFP+4Port DAC</td><td>3.6W</td><td>3.8W</td></tr></tbody></table><p>10GBase-Tは従来のX710T4はものすごい消費電力でしたが、X710TL4となり随分と消費電力が抑制されています。2.5Gbpsであればさらに抑制することはできますが、速度が1&#x2F;4になったからといって、消費電力が1&#x2F;4に下がるわけではありません。X710（40Gbpsのチップ）のポテンシャルが無駄になっているということでしょうか。</p><p>これに対してSFPは光の10GBase-SRは最大6.6Wとかなり抑制され、DACに至っては最大で3.8Wです。1Portあたり1w未満です。</p><blockquote><p>intel<br> <a href="https://www.intel.com/content/dam/www/public/us/en/documents/product-briefs/ethernet-x710-brief.pdf">https://www.intel.com/content/dam/www/public/us/en/documents/product-briefs/ethernet-x710-brief.pdf</a></p></blockquote><p>Mellanoxは2PortのNICが多く出回っています。Connect X-4以降は100Gbpsのチップで高機能という理由もありますが、消費電力も増えるようです。</p><table><thead><tr><th>型番（いずれもパッシブケーブル接続）</th><th>通常消費電力</th><th>最大消費電力</th></tr></thead><tbody><tr><td>Connect X-3(MCX311A-XCAT)１Port</td><td>3.47W</td><td>4.84W</td></tr><tr><td>Connect X-4(MCX4121A-ACAT)2Port  ※25GbE</td><td>9.6W</td><td>11.6W</td></tr><tr><td>Connect X-5(MCX512A-ACAT)2Port ※25GbE</td><td>9.5W</td><td>11.8W</td></tr></tbody></table><blockquote><p>Mellanox Connect X-3<br> <img src="/new-technology/2022/05/28/sfp-plus/connectx3.png" class="" width="480" title="alt"></p></blockquote><blockquote><p>Mellanox Connect X-4&#x2F;X-5<br> <a href="https://docs.nvidia.com/networking/display/CX4LxEN/Specifications#Specifications-MCX4111A-ACATandMCX4111A-ACUTSpecifications">https://docs.nvidia.com/networking/display/CX4LxEN/Specifications#Specifications-MCX4111A-ACATandMCX4111A-ACUTSpecifications</a><br> <a href="https://docs.nvidia.com/networking/display/ConnectX5EN/Specifications#Specifications-MCX512A-ACATandMCX512A-ACUTSpecifications">https://docs.nvidia.com/networking/display/ConnectX5EN/Specifications#Specifications-MCX512A-ACATandMCX512A-ACUTSpecifications</a></p></blockquote><p>Connect X-4&#x2F;X-5は25GbEのイメージが強いですが、SFP+として10GbEで使えます。</p><h3 id="クライアント側の発熱抑制"><a href="#クライアント側の発熱抑制" class="headerlink" title="クライアント側の発熱抑制"></a>クライアント側の発熱抑制</h3><p>デスクトップPCを都度電源オフにせずスリープにされる方は、スイッチ側のSFPモジュールは通電している状態かもしれません。Windowsの省電力の設定で殆どリンクダウン状態にする事でより省電力、発熱を抑えられます。WakeOnLanを使わない方は設定を検討してはいかがでしょうか。</p><img src="/new-technology/2022/05/28/sfp-plus/win.png" class="" width="400" title="alt"><h2 id="SFP-x2F-SFP-モジュールの挿入、取り外し"><a href="#SFP-x2F-SFP-モジュールの挿入、取り外し" class="headerlink" title="SFP&#x2F;SFP+モジュールの挿入、取り外し"></a>SFP&#x2F;SFP+モジュールの挿入、取り外し</h2><p>モジュールの挿入は差し込むだけです。カチッと音がし、ロックされます。取り出すときはケーブルを抜き、<strong>ラッチを引き下げる</strong>とロックが外れます。ラッチを下げないと抜けません。<strong>無理に引き抜こうとするとスイッチやNICが破損します</strong>。</p><img src="/new-technology/2022/05/28/sfp-plus/latch.png" class="" width="400" title="alt"><p>このとき、光が出ている部分を覗き込むと目を痛める恐れがありますので注意してください。</p><p>DACも同様に差し込むのは簡単です。取り外すときは、プルタブを指に引っ掛けて引き抜きます。本来は簡単に引き抜けるようになっていますが、Amazonで販売している製品（10Gtek）のDAC、モジュールは特に引き抜きづらいものがあり注意が必要です。無理に片手でプルタブを強く引っ張るとスイッチやNICが破損しますので注意してください。引き抜きづらい製品を購入してしまった場合は、以下のようにモジュールの横を押さえてプルタブを引く事でラッチが外れやすくなります。</p><img src="/new-technology/2022/05/28/sfp-plus/dac2.png" class="" width="400" title="alt"><p>10GtekのDACがどうしても抜けない時の対応方法です。<br>ラッチに細いマイナスドライバーや精密ドライバーを引っ掛けてラッチを引き下げる事で抜けるようになります。</p><img src="/new-technology/2022/05/28/sfp-plus/latch2.png" class="" width="400" title="alt"><p>MMFモジュールのラッチもメーカーによって様々ですが、以下のようにラッチを精密ドライバーなどで引っ掛けて手前に引いてラッチを外したり、手前から奥に押し込むと外れるタイプもあります。いずれもバネで止まっているものであり大きな力は不要です。このようにドライバーを引っ掛けると行ってもテコの力でグッと強く押したり引いたりすると破損しますので注意してください。</p><img src="/new-technology/2022/05/28/sfp-plus/latch3.png" class="" width="400" title="alt"><h2 id="ネットワークカードへのSFP-モジュールの挿入"><a href="#ネットワークカードへのSFP-モジュールの挿入" class="headerlink" title="ネットワークカードへのSFP+モジュールの挿入"></a>ネットワークカードへのSFP+モジュールの挿入</h2><p>PCやNASのSFP+対応のネットワークカードにはSFP+モジュールを挿しますが、ネットワークカードからSFPポートへの電力供給は最大3W程度です。従い、DACやMMFトランシーバはもちろん問題ありませんが、10GBase-Tモジュールは電力を要するので基本的にネットワークカードには10GBase-Tモジュールを挿しません。電力供給が不足する可能性が高く、2.5Gbpsに速度が落ちたり、安定しないなどの事象が発生します。また、発熱のためにネットワークカードが破損する可能性があります。</p><h2 id="OM3ケーブルを配管に通すには"><a href="#OM3ケーブルを配管に通すには" class="headerlink" title="OM3ケーブルを配管に通すには"></a>OM3ケーブルを配管に通すには</h2><p>LC-LCをそのまま直径2cm程度の既存配管に通すのは難しいのですが、一旦端子部分を繋いでいるコネクタを外す事ができます。<br> <img src="/new-technology/2022/05/28/sfp-plus/lclc.png" class="" width="300" title="alt"></p><p>私の場合、UTPケーブルの被覆を使い、コネクタ部分を被せるようにしてテープを巻いています。CD管&#x2F;PF管の内径の大きさの問題もありますが、LCのコネクタは長いので、CD管&#x2F;PF管が曲がる箇所を通過させるのが難しいところです。コネクタとコネクタの間を少し大きく取り、CD管が曲がっている場所も通りやすくします。通線ワイヤーとテープでしっかりと繋いで配管を通します。電話線など他の配線があって通せない場合は工事業者さんにお願いした方が良いでしょう（一旦電話線を抜いて光を通し、電話線を再配線すると楽ですが、電話線の敷設は資格が必要です）。最近、ショートノーズの新製品が出てきているので配管を通す場合はお勧めです。</p> <img src="/new-technology/2022/05/28/sfp-plus/lclc2.png" class="" width="300" title="alt"><p>OM3については、Amazon Basicの製品で10m&#x2F;20mのものがあり、廉価でお勧めです。</p><h2 id="失敗事例とスイッチのDDM"><a href="#失敗事例とスイッチのDDM" class="headerlink" title="失敗事例とスイッチのDDM"></a>失敗事例とスイッチのDDM</h2><p>光ケーブルは弱いと書きましたが、既に配管にケーブルがあるにも関わらず追加でOM3を通そうとして途中の配管のカーブで詰まってしまい、諦めて戻したことがあります。UTPケーブルなら体重を掛けてぐいぐい引っ張るところですが、さすがにOM3のケーブルなので片手で引っ張る程度で手加減したつもりでしたが損傷していました。SFPトランシーバはDDM(Digital Diagnostic Monitoring)の機能を持ち、スイッチのCLIで光の強さなども把握できます（スイッチがその機能を持つ必要があります）。</p><p>ケーブルに損傷がないかスイッチのCLIで見た結果が以下です。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">(UBNT) &gt;show fiber-ports optics all</span><br><span class="line">                                                 Output   Input</span><br><span class="line">Port    Physical Port/  Temp  Voltage  Current   Power    Power     TX     LOS</span><br><span class="line">        Lane Number     [C]   [Volt]     [mA]    [dBm]    [dBm]     Fault</span><br><span class="line">------  --------------  ----  -------  -------   -------  -------   -----  ---</span><br><span class="line">0/1     0/1-Lane1       43.9    3.321      7.7    -2.947   -3.036   No     No</span><br><span class="line">0/4     0/4-Lane1       44.4    3.348      7.8    -2.818   -2.476   No     No</span><br><span class="line">0/16    0/16-Lane1      43.4    3.389      7.8    -3.011  -11.733   No     No</span><br><span class="line">0/21    0/21-Lane1       N/A      N/A      N/A       N/A      N/A   N/A    N/A</span><br><span class="line">0/22    0/22-Lane1       N/A      N/A      N/A       N/A      N/A   N/A    N/A</span><br><span class="line">0/23    0/23-Lane1       N/A      N/A      N/A       N/A      N/A   N/A    N/A</span><br><span class="line">0/24    0/24-Lane1       N/A      N/A      N/A       N/A      N/A   N/A    N/A</span><br><span class="line">0/28    0/28-Lane1      46.7    3.372      6.0    -3.010   -3.010   No     No</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>上記Port16が該当のケーブルなんですが、Input Powerが-11.733dBmとなっています。これはケーブルの品質が極めて悪化していることを示しています。光ケーブルの品質は以下の表が参考にすべき内容となっています。大昔よりEMC社が提示しているリストで、多くの方に目安として使われています。私のケースだと、-11.733dBmなので2Gbpsも危ういということがわかります。実際のiperf3の計測では4Gbps〜5Gbpsほどは出ていますが、このケーブルは廃棄するしかありませんでした。</p><table><thead><tr><th>microwatt</th><th>milliwatt</th><th>dBm</th><th>Description</th></tr></thead><tbody><tr><td>1</td><td>0.001</td><td>-30</td><td>Loss of Signal</td></tr><tr><td>10</td><td>0.01</td><td>-20</td><td></td></tr><tr><td>25.1</td><td>0.0251</td><td>-16</td><td>2Gbps minimum accept signal</td></tr><tr><td>31.6</td><td>0.0316</td><td>-15</td><td>4Gbps minimum accept signal</td></tr><tr><td>50</td><td>0.05</td><td>-13.01</td><td></td></tr><tr><td>100</td><td>0.1</td><td>-10</td><td>2Gbps minimum send signal</td></tr><tr><td>125.9</td><td>0.1259</td><td>-9</td><td>4Gbps minimum send signal</td></tr><tr><td>150</td><td>0.15</td><td>-8.24</td><td></td></tr><tr><td>200</td><td>0.2</td><td>-6.99</td><td>Normal range of optical signal strength</td></tr><tr><td>250</td><td>0.25</td><td>-6.02</td><td></td></tr><tr><td>300</td><td>0.3</td><td>-5.23</td><td></td></tr><tr><td>350</td><td>0.35</td><td>-4.26</td><td></td></tr><tr><td>400</td><td>0.4</td><td>-3.98</td><td></td></tr></tbody></table><h2 id="現実的なネットワークカードの選定"><a href="#現実的なネットワークカードの選定" class="headerlink" title="現実的なネットワークカードの選定"></a>現実的なネットワークカードの選定</h2><p>intelのNICは低電力でお勧めですが、インフレということもあり、X710の2Portで49,200円（秋葉原のオリオスペック）とそれなりの値段です。標準的なNICといえます。日本のAmazonではSFP+のNICを探すのは難しくなっています。X520が売れ残っている状況ですが、セキュリティリスクを理解した上で導入される事をお勧めします。既にEOSL（Discontinued）で最新ファームウェアのダウンロードもできませんし、NIC自体の脆弱性の状況も分かりません。<br><a href="https://ark.intel.com/content/www/us/en/ark/products/series/42489/intel-ethernet-server-adapter-x520.html">https://ark.intel.com/content/www/us/en/ark/products/series/42489/intel-ethernet-server-adapter-x520.html</a></p><p>intelはチップのみを販売していることもあって、intel純正のNIC以外に、他社製造のNICでチップがX710という廉価な製品も見かけます。この場合、一般的にネットワークドライバはintelのものを使えますが、ファームウェアはOEMとして個別に提供される場合があるので、購入前に販売者に確認される事をお勧めします。</p><p>MellanoxのNICはeBayで揃えるのが一つの方法です。海外通販になりますし、発送元は大半が中国からです。返品不可の出品者が多く、少しハードルは高いです。一般的なセオリーですが、評価の高い出品者から購入するのが無難と言えます。<br>NAS、ESXi7、Windows10など動くとわかっている枯れたOSであれば5,000円未満となるConnect X-3を使ってみるのはアリです。既にEOSLを迎えているのですが最新ファームウェアもダウンロードできますし、Connect Xの脆弱性のレポートは無く比較的安心して使えるNICです。新しいOSを使う場合はConnect X-3は見送った方が良いです。VMware ESXi8やWindows11は対応しません。</p><p>新しいOS向けにこれからSFP+を導入するならば、MellanoxのConnect X-4&#x2F;X-5が対象になります。Connect X-4（MCX4121A-ACAT）が$100、Connect X-5（MCX512A-ACAT）が$170です。将来的に25GbEも考えてみようかなと思う場合は、手元に置いておいても良いかもしれません。</p><p>NICについては、Fibre Channel、InfiniBandとEthernetとは異なります。SFP+のNICを購入される時は、Ethernetのものを購入してください。</p><h2 id="スイッチの選定"><a href="#スイッチの選定" class="headerlink" title="スイッチの選定"></a>スイッチの選定</h2><p>ワンルームでスイッチを利用するならファンレスを検討したいところです。一般的な使い方として、NASだけであれば2.5GbEが中心でSFP+までは不要かもしれません。しかしサーバーを立てて、細かいデータファイルやモジュールのバックアップを取るとなると10Gの速度が欲しくなるでしょう。ファンレスの10GbEならSFP+が最有力候補です。</p><p>LDK〜のマンションや戸建てになれば、Wi-Fiアクセスポイント（AP）も２台は置きたくなりますし、AmazonアレクサやAppleTVなどのIoT機器も増えるでしょう。やがて監視カメラなどを繋げるようになると安定した有線接続も必要になります。<br>メインのスイッチはSFP+の口を多めのものに、そこにサーバー群を10G SFP+で接続、各部屋へ2.5Gbps&#x2F;1Gbpsのツイストペア接続、または10GbEのSFP+接続とし、各部屋のスイッチはWi-Fi AP、家電、IoT、監視カメラへと接続しやすい、マルチギガのスイッチまたはPoEスイッチを用意されると良いのではないかと思います。</p><p>各部屋の配線全てを光ケーブルにする必要もありませんが、OM3を引いておけば、将来25GbEの対応は容易です。</p><p>個人向けのWi-Fiルータは値段なりの機能・品質ですし、4Port程度の機器を繋ぐことができますが、高度なことは出来ません。リモートワークや今後のWi-Fiの進化などを踏まえ、VLANも用意した上でしっかりとしたネットワーク敷設を考えられるのであれば、ネットワークに特化したメーカーの製品を導入される事を検討されてはいかがでしょうか。メインスイッチはファン付きで信頼性のある安定した製品を選定されることをお勧めします。</p><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>もし、既存のネットワークで発熱、ファンの騒音、電気使用量が気になるのであれば是非SFP+にチャレンジしてみてください。低レイテンシ・低発熱のネットワークが構築できます。</p><p>なお、SFPの注意点としてはNBase-T(2.5Gbps&#x2F;5Gbps)に対応していないスイッチも多く存在することです。一般的なRJ45のSFP+モジュールはNBase-Tへの対応を謳う製品もあり、リンクアップ出来る場合がありますが、モジュールが2.5GbEと認識できていてもスイッチ自体が10GbEと認識しており、速度のミスマッチにより十分な速度が出ません。2.5GbEに対応していないSFP+のスイッチであっても、ハックとして2.5GbEの機器と接続する方法は一応あります。SFP+のNBase-Tへの対応については「 <a href="/new-technology/2022/07/30/sfp-plus-nbaset/" title="SFP+の2.5GbE対応">SFP+の2.5GbE対応</a> 」を参照してください。</p>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2022/05/28/sfp-plus/title.png&quot; class=&quot;&quot; width=&quot;1024&quot; title=&quot;alt&quot;&gt;

&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;

&lt;p&gt;リモートワークやインターネット回線の高速化に伴い、10Gネットワークが普及し、10GBase-Tの発熱に対する声が聞かれます。10Gネットワークにおいては従来のLANケーブルではなく光ファイバーで省電力化と低発熱が実現できる、SFP+が選択肢となります。実はあまり知られていない低遅延の効果もあります。2023年4月以降段階的に各地で電気代が値上げされることになりました。また、5月中旬というのに夏のような暑さが到来しています。毎年恒例ですが、発熱対策の気になる季節になってきました。この記事は1年前に投稿したものですが、最近の情勢を踏まえて1年ぶりにアップデートするもので、10Gネットワークを前提にSFP+についてまとめています。&lt;/p&gt;</summary>
    
    
    
    <category term="Hardware" scheme="https://yoshi0808.github.io/new-technology/categories/Hardware/"/>
    
    <category term="Network" scheme="https://yoshi0808.github.io/new-technology/categories/Network/"/>
    
    
    <category term="SFP+" scheme="https://yoshi0808.github.io/new-technology/tags/SFP/"/>
    
    <category term="10GbE" scheme="https://yoshi0808.github.io/new-technology/tags/10GbE/"/>
    
  </entry>
  
  <entry>
    <title>Sophos Firewall v19</title>
    <link href="https://yoshi0808.github.io/new-technology/2022/04/29/xg-v19/"/>
    <id>https://yoshi0808.github.io/new-technology/2022/04/29/xg-v19/</id>
    <published>2022-04-28T15:00:00.000Z</published>
    <updated>2022-11-26T00:04:23.000Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2022/04/29/xg-v19/title.png" class="" title="alt"><h2 id="Sophos-Firewall-v19"><a href="#Sophos-Firewall-v19" class="headerlink" title="Sophos Firewall v19"></a>Sophos Firewall v19</h2><p>Sophos Firewall v19が2022年4月21日に発表されました。</p><span id="more"></span><h2 id="主なエンハンスの内容"><a href="#主なエンハンスの内容" class="headerlink" title="主なエンハンスの内容"></a>主なエンハンスの内容</h2><ul><li>SD-WAN（Software Defined-Wide Area Network）の強化</li><li>IPSecに関する高速化（Xstream FastPath acceleration）</li><li>SSLーVPNを含むVPNのエンハンス</li><li>Sophos Assistant機能の追加</li></ul><p>v19の詳細な説明はSophos Communityを参照してください。</p><blockquote><p><a href="https://community.sophos.com/sophos-xg-firewall/b/blog/posts/sophos-firewall-os-v19-is-now-available">https://community.sophos.com/sophos-xg-firewall/b/blog/posts/sophos-firewall-os-v19-is-now-available</a></p></blockquote><h2 id="Sophos-Firewallのアップデート"><a href="#Sophos-Firewallのアップデート" class="headerlink" title="Sophos Firewallのアップデート"></a>Sophos Firewallのアップデート</h2><p>XGの管理画面にログイン後、左ペインメニューの<mark class="label primary">バックアップ＆ファームウェア</mark>の<mark class="label primary">ファームウェアの確認</mark>ではただちに全てのユーザーにアップデートの案内が来るわけでは無いので、アップデートにはMySophosにログインし、バージョンアップの差分モジュールをダウンロードします。</p><ol><li>Sophosのサイトの右上のプルダウンメニューから、<mark class="label primary">ライセンスとアカウント</mark>をクリックします。<blockquote><p><a href="https://www.sophos.com/ja-jp.aspx">https://www.sophos.com/ja-jp.aspx</a></p></blockquote></li><li>Sophos IDをお持ちでなければIDを作成します。</li><li>ログイン後、<mark class="label primary">Network Protection</mark>をクリックします。</li><li><mark class="label primary">ファームウェアの更新</mark>をクリックします。</li><li>「製品名&#x2F;OSを使った検索」で”ファイアーウォール”を選択し、その後現れるプルダウンは”ソフトウェア”を選択します。</li><li><mark class="label primary">選択可能なダウンロードを表示</mark>ボタンをクリックします。</li></ol><img src="/new-technology/2022/04/29/xg-v19/mysophos.png" class="" width="800" title="alt"><ol><li>上記画面で”SW-19.0.0_GA.SFW-317.sig”というアップデータが表示されますのでダウンロードします。</li><li>MY Sophosはここで終了してXGの管理画面にログインし、左ペインメニューの<mark class="label primary">バックアップ＆ファームウェア</mark>の<mark class="label primary">ファームウェアのタブメニュー</mark>から以下の画面に赤丸で囲った矢印のアイコンをクリックし、ダウンロードしたモジュールをアップロードします。</li></ol><img src="/new-technology/2022/04/29/xg-v19/verup.png" class="" width="800" title="alt"><p>アップロード＆再起動ボタンをクリックし、v19へのアップグレードを完了させます。</p><img src="/new-technology/2022/04/29/xg-v19/upgrade.png" class="" width="800" title="alt"><div class="note info"><p>仮想環境（ESXi）上にFirewallをインストールされている方はアップグレードの前に、「<a href="/new-technology/2020/10/11/esxi-backup/" title="VMware ESXiの仮想マシンをバックアップする">VMware ESXiの仮想マシンをバックアップする</a>」を参考に、バックアップを確保される事をお勧めします。</p></div><h2 id="VPNの設定"><a href="#VPNの設定" class="headerlink" title="VPNの設定"></a>VPNの設定</h2><p>VPNも内部的にはバージョンアップはされていますが、ホームユーザーが利用するIPSec VPNやSSLーVPNについて設定ファイルの変更はなく、過去からの物がそのまま利用できます。どちらかといえば、企業向けのサービスとして、サイト間VPNの機能強化を主眼に置いたものになります。管理画面のメニューにおいても、<mark class="label primary">リモートアクセスVPN</mark>と<mark class="label primary">サイト間VPN</mark>とメニューが分かれるようになりました。</p><h2 id="Sophos-Assistant"><a href="#Sophos-Assistant" class="headerlink" title="Sophos Assistant"></a>Sophos Assistant</h2><p>Sophos Assistantという管理画面操作のアシスタント機能が追加になりました。例えば、サーバーとしてインターネット側からの接続を受け入れる場合は、DNATという機能を使うことになりますが、以下のように「Full configuration: Create DNAT and firewall rules for web servers」という項目を選択すると、まず最初にWebサーバーのIPを定義するところから始めるように促してくれます。</p><img src="/new-technology/2022/04/29/xg-v19/sa1.png" class="" width="640" title="alt"><img src="/new-technology/2022/04/29/xg-v19/sa2.png" class="" width="1024" title="alt"><p>ある程度わかっている人が久々に操作する時には役に立つ機能と思われます。時間があるときに色々調べてみると知らなかった機能など気づきがあるかもしれません。</p><h2 id="Amazon-Virtual-Private-Cloud-Amazon-VPC-の対応"><a href="#Amazon-Virtual-Private-Cloud-Amazon-VPC-の対応" class="headerlink" title="Amazon Virtual Private Cloud (Amazon VPC) の対応"></a>Amazon Virtual Private Cloud (Amazon VPC) の対応</h2><p>v19より、AWSのプライベートクラウドに接続する機能が加わっています。自宅オンプレとAWSクラウドとをシームレスにネットワークを接続するハイブリッドクラウドに興味のある方はウォッチしてみてください。</p><blockquote><p>Amazon Web Services VPC support in SFOS v19<br> <a href="https://news.sophos.com/en-us/2022/04/07/amazon-web-services-vpc-support-in-sfos-v19/">https://news.sophos.com/en-us/2022/04/07/amazon-web-services-vpc-support-in-sfos-v19/</a></p></blockquote>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2022/04/29/xg-v19/title.png&quot; class=&quot;&quot; title=&quot;alt&quot;&gt;

&lt;h2 id=&quot;Sophos-Firewall-v19&quot;&gt;&lt;a href=&quot;#Sophos-Firewall-v19&quot; class=&quot;headerlink&quot; title=&quot;Sophos Firewall v19&quot;&gt;&lt;/a&gt;Sophos Firewall v19&lt;/h2&gt;&lt;p&gt;Sophos Firewall v19が2022年4月21日に発表されました。&lt;/p&gt;</summary>
    
    
    
    <category term="Security" scheme="https://yoshi0808.github.io/new-technology/categories/Security/"/>
    
    
    <category term="XG Firewall" scheme="https://yoshi0808.github.io/new-technology/tags/XG-Firewall/"/>
    
  </entry>
  
  <entry>
    <title>ESXiでネットワークカードのファームウェアを更新する</title>
    <link href="https://yoshi0808.github.io/new-technology/2022/04/02/nic-firmware/"/>
    <id>https://yoshi0808.github.io/new-technology/2022/04/02/nic-firmware/</id>
    <published>2022-04-01T23:10:04.000Z</published>
    <updated>2023-03-05T22:15:00.000Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2022/04/02/nic-firmware/title.png" class="" width="1024" title="alt"><p class="onepoint">この記事で実現すること</p><p>ESXiにおいてネットワークカードの主要ITベンダーであるintelおよびMellanox(NVidia)のファームウェアをアップデートします。sshでESXiホストに接続したままアップデート可能です（作業中は何度かのシステムリスタートが必要になります）。</p><span id="more"></span><h2 id="ネットワークカード自体の脆弱性"><a href="#ネットワークカード自体の脆弱性" class="headerlink" title="ネットワークカード自体の脆弱性"></a>ネットワークカード自体の脆弱性</h2><p>（2023-3-5更新）<br>2023-2-14にintelのサイトで700シリーズおよびE810シリーズでCVE-2022-36382の脆弱性について発表がありました。<br>境界外への書き込みでサービス拒否に繋がるとの事（Base Score: 6.0 MEDIUM）です。</p><p>その数日後の23-2-17に700シリーズでは新しいv9.2、およびE180シリーズではv4.2のファームウェアが発表されています。</p><blockquote><p>Intel® Ethernet Controllers and Adapters Advisory<br> <a href="https://www.intel.com/content/www/us/en/security-center/advisory/intel-sa-00754.html">https://www.intel.com/content/www/us/en/security-center/advisory/intel-sa-00754.html</a></p></blockquote><blockquote><p>Intel 700 nvmupdate v9.2<br> <a href="https://www.intel.co.jp/content/www/jp/ja/download/18638/non-volatile-memory-nvm-update-utility-for-intel-ethernet-adapters-700-series-vmware-esx.html?wapkw=nvm%E3%80%80update">https://www.intel.co.jp/content/www/jp/ja/download/18638/non-volatile-memory-nvm-update-utility-for-intel-ethernet-adapters-700-series-vmware-esx.html?wapkw=nvm%E3%80%80update</a></p></blockquote><blockquote><p>Intel E810 nvmupdate v4.2<br> <a href="https://www.intel.com/content/www/us/en/download/19624/non-volatile-memory-nvm-update-utility-for-intel-ethernet-network-adapter-e810-series.html">https://www.intel.com/content/www/us/en/download/19624/non-volatile-memory-nvm-update-utility-for-intel-ethernet-network-adapter-e810-series.html</a></p></blockquote><blockquote><p>NATIONAL VULNERABILITY DATABASE<br> <a href="https://nvd.nist.gov/vuln/detail/CVE-2022-36382">https://nvd.nist.gov/vuln/detail/CVE-2022-36382</a></p></blockquote><p>脆弱性対策情報データベースである、JVN iPdeiaでの検索では、2020年以降、Intel(R) Ethernet I210 Controller、Intel(R) Ethernet 700 Series Controller 、Intel(R) Ethernet Network Controller E810において脆弱性が発見されています。</p><ul><li>JVN iPdeia （”Intel Ethernet Controller”で検索）<br> <a href="https://jvndb.jvn.jp/search/index.php?mode=_vulnerability_search_IA_VulnSearch&amp;lang=ja&amp;keyword=Intel+Ethernet+Controller&amp;useSynonym=1&amp;vendor=&amp;product=&amp;datePublicFromYear=&amp;datePublicFromMonth=&amp;datePublicToYear=&amp;datePublicToMonth=&amp;dateLastPublishedFromYear=&amp;dateLastPublishedFromMonth=&amp;dateLastPublishedToYear=&amp;dateLastPublishedToMonth=&amp;cwe=&amp;searchProductId=">https://jvndb.jvn.jp/search/index.php?mode=_vulnerability_search_IA_VulnSearch&amp;lang=ja&amp;keyword=Intel+Ethernet+Controller&amp;useSynonym=1&amp;vendor=&amp;product=&amp;datePublicFromYear=&amp;datePublicFromMonth=&amp;datePublicToYear=&amp;datePublicToMonth=&amp;dateLastPublishedFromYear=&amp;dateLastPublishedFromMonth=&amp;dateLastPublishedToYear=&amp;dateLastPublishedToMonth=&amp;cwe=&amp;searchProductId=</a></li></ul><p>Mellanox(NVIDIA)のネットワークカードについては脆弱性は見つかっていないようです。</p><h2 id="ネットワークカード-NIC-の保守期限"><a href="#ネットワークカード-NIC-の保守期限" class="headerlink" title="ネットワークカード(NIC)の保守期限"></a>ネットワークカード(NIC)の保守期限</h2><p>ESXiでのドライバはintelやMellanoxを使っている限りは最適なドライバがパッチ公開のタイミングで提供されます。但し、チップを動作させるネットワークカード上のファームウェアは別途NICの提供ベンダーからのパッチを適用する必要があります。<br>ESXiのハードウェア互換リストでは古いネットワークカードでも対応している場合があります。しかし、ベンダー側でサポート終了（EOSL）となっている製品もあり注意が必要です。ビジネス用途でなければ使えるうちは使うといった対応が取れますが、万が一ファームウェアで脆弱性などが指摘された場合は、そのNICの利用を取りやめる必要が出てきます。</p><h2 id="intelのサポート終了NIC"><a href="#intelのサポート終了NIC" class="headerlink" title="intelのサポート終了NIC"></a>intelのサポート終了NIC</h2><p>以下のリンクではintelの製造終了のNIC一覧情報があります。さらに5年経過でサポート終了という事です。X520やX540なども製造終了しており、5年間の保証ポリシーの対象となっています。</p><ul><li>intel<br> <a href="https://www.intel.co.jp/content/www/jp/ja/support/articles/000026530/ethernet-products/legacy-ethernet-products.html">https://www.intel.co.jp/content/www/jp/ja/support/articles/000026530/ethernet-products/legacy-ethernet-products.html</a></li></ul><p>しかし、X520とX540の新しいファームウェアのダウンロードについては見つかりませんでした。私の見落としでなければ、最新版のファームウェアの提示が無いというのはこれから新規導入する場合、リスクが大きく感じます。</p><h2 id="Melanoxのサポート終了NIC"><a href="#Melanoxのサポート終了NIC" class="headerlink" title="Melanoxのサポート終了NIC"></a>Melanoxのサポート終了NIC</h2><p>Mellanoxにおいても”Products End-of-Life Policy”というものがあり、販売終了から5年経過し、End of Supportとなるようです。<br>以前にはEOSの製品一覧が記載されているExcelファイルが置いてあったんですが、最近は無くなってしまいました。</p><p>最近は$40で購入できるMCX311A-XCATなどは2020年3月31日に販売終了となっています。<br>Mellanoxの場合はVMwareの互換リストから外れているConnect X-3についてもWebにはファームウェアの情報が掲載されているので、いつでも最新のファームウェアに更新できます。</p><h2 id="intelのNICファームウェア更新"><a href="#intelのNICファームウェア更新" class="headerlink" title="intelのNICファームウェア更新"></a>intelのNICファームウェア更新</h2><p>intelの純正のNICであればそのカード名称でintelのサイトを検索しファームウェアを更新します。また、3rdベンダーがintelチップを採用し製造したNICだとintelのチップの名称でファームウェアをダウンロードする必要があります。「<a href="/new-technology/2022/02/27/building-setup-esxi7/" title="ESXI7.0をRyzen7 5700Gで構築">ESXI7.0をRyzen7 5700Gで構築</a>」では、私は3rdベンダーが製造したintel X710を搭載したNICを購入したと書きましたが、このようなケースではintelが提供するファームウェアを適用可能なのか、それとも3rdベンダーが提供するファームウェアがあるのか事前に確認する必要があります。X710のSFP＋を4Portというのは低消費電力・低発熱で魅力的ですが、前述した脆弱性について既に確認していたため、ファームウェアのアップデートに言及できるベンダーのものを選定しました。販売者の中には「できるはずだがお勧めしない」という回答もありました。3rdベンダーの場合は、ファームウェアアップデートの設定ファイルの書き換えが必要な場合もあります（私の購入したNICはこの修正が不要でした）。</p><p>導入はシンプルでnvmupdateというファームウェア更新ツールとセットになったNICのファームウェアをintelのサイトからダウンロードし、ESXiにSSHで接続し実行するだけです。留意点としては、誤った種類のファームウェア適用によりNICが使えなくなってしまった場合は自己責任であり、リスクはあります。</p><p>導入手順を説明します。intelのサイトで”nvm update”を検索します。するとX550シリーズ、700シリーズ、E810シリーズとnvmupdateについて表示されるのでお使いのチップに相当するモジュールをダウンロードしてください。intel純正のカードであればカード名で検索も可能です。</p><ul><li><p>X550シリーズ<br> <a href="https://www.intel.co.jp/content/www/jp/ja/download/19362/non-volatile-memory-nvm-update-utility-for-intel-ethernet-adapters-550-series-vmware-esx.html?wapkw=nvm%20update%20esxi">https://www.intel.co.jp/content/www/jp/ja/download/19362/non-volatile-memory-nvm-update-utility-for-intel-ethernet-adapters-550-series-vmware-esx.html?wapkw=nvm%20update%20esxi</a></p></li><li><p>700シリーズ<br> <a href="https://www.intel.co.jp/content/www/jp/ja/download/18638/non-volatile-memory-nvm-update-utility-for-intel-ethernet-adapters-700-series-vmware-esx.html?wapkw=nvm%E3%80%80update">https://www.intel.co.jp/content/www/jp/ja/download/18638/non-volatile-memory-nvm-update-utility-for-intel-ethernet-adapters-700-series-vmware-esx.html?wapkw=nvm%E3%80%80update</a></p></li><li><p>E810シリーズ<br> <a href="https://www.intel.co.jp/content/www/jp/ja/download/19628/non-volatile-memory-nvm-update-utility-for-intel-ethernet-network-adapters-e810-series-vmware-esx.html?wapkw=e810%20nvm%20update">https://www.intel.co.jp/content/www/jp/ja/download/19628/non-volatile-memory-nvm-update-utility-for-intel-ethernet-network-adapters-e810-series-vmware-esx.html?wapkw=e810%20nvm%20update</a></p></li></ul><p>それぞれのダウンロードページには、クイック使用ガイドというものがありますのでそこに詳細な手順が記されています。</p><p> <a href="https://www.intel.co.jp/content/www/jp/ja/embedded/products/networking/nvm-update-tool-vmware-esx-quick-usage-guide.html">https://www.intel.co.jp/content/www/jp/ja/embedded/products/networking/nvm-update-tool-vmware-esx-quick-usage-guide.html</a></p><p>700シリーズのファームウェア適用の実例です。まずNICのFirmwareを確認します。対象のNIC（vmnicx）を指定し内容を確認します。<code>esxcli network nic get -n [物理NICのID]</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@esxi2:~] esxcli network nic get -n vmnic0</span><br><span class="line">   Advertised Auto Negotiation: true</span><br><span class="line">   Advertised Link Modes: Auto, 10000BaseT/Full</span><br><span class="line">   Auto Negotiation: true</span><br><span class="line">   Cable Type: DA</span><br><span class="line">   Current Message Level: 1</span><br><span class="line">   Driver Info:</span><br><span class="line">         Bus Info: 0000:01:00:0</span><br><span class="line">         Driver: i40en</span><br><span class="line">         Firmware Version: 8.50 0x8000b6c5 1.2074.0</span><br><span class="line">         Version: 1.11.1.31</span><br><span class="line">   Link Detected: true</span><br><span class="line">   Link Status: Up</span><br><span class="line">   Name: vmnic0</span><br><span class="line">   PHYAddress: 0</span><br><span class="line">   Pause Autonegotiate: false</span><br><span class="line">   Pause RX: true</span><br><span class="line">   Pause TX: true</span><br><span class="line">   Supported Ports: DA</span><br><span class="line">   Supports Auto Negotiation: true</span><br><span class="line">   Supports Pause: true</span><br><span class="line">   Supports Wakeon: true</span><br><span class="line">   Transceiver:</span><br><span class="line">   Virtual Address: 00:00:00:00:00:00</span><br><span class="line">   Wakeon: MagicPacket(tm)</span><br></pre></td></tr></table></figure><p>続いてダウンロードしたファイル（700シリーズは2023年3月5日時点では最新がv9.2です）をscpかストアブラウザを使ってESXi上にアップロードします。その後展開し実行します。<br>特に注意点はありませんが、私は実行にあたりメンテナンスモードにして（VMを停止）から開始しました（アップデート中に、仮想マシンが止まるようなことはありませんが）。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@esxi2:] tar -xvf 700Series_NVMUpdatePackage_v9_20_ESX.tar.gz</span><br><span class="line">#展開されたフォルダに入り以下を実行します。</span><br><span class="line">[root@esxi2:] ./nvmupdaten64e</span><br></pre></td></tr></table></figure><p>以下ではNICを全て対象、NVMイメージのバックアップは有りということで実行したログになります。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">Intel(R) Ethernet NVM Update Tool</span><br><span class="line">NVMUpdate version 1.39.32.6</span><br><span class="line">Copyright(C) 2013 - 2023 Intel Corporation.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">WARNING: To avoid damage to your device, do not stop the update or reboot or power off the system during this update.</span><br><span class="line">Inventory in progress. Please wait [****......]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Num Description                          Ver.(hex)  DevId S:B    Status</span><br><span class="line">=== ================================== ============ ===== ====== ==============</span><br><span class="line">01) Intel(R) Ethernet Controller X710  8.112(8.70)   1572 00:001 Update</span><br><span class="line">    for 10GbE SFP+                                               available</span><br><span class="line"></span><br><span class="line">Options: Adapter Index List (comma-separated), [A]ll, e[X]it</span><br><span class="line">Enter selection: A</span><br><span class="line">Would you like to back up the NVM images? [Y]es/[N]o: Y</span><br><span class="line">Update in progress. This operation may take several minutes.</span><br><span class="line">[....|*****]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Num Description                          Ver.(hex)  DevId S:B    Status</span><br><span class="line">=== ================================== ============ ===== ====== ==============</span><br><span class="line">01) Intel(R) Ethernet Controller X710   9.32(9.20)   1572 00:001 Update</span><br><span class="line">    for 10GbE SFP+                                               successful</span><br><span class="line"></span><br><span class="line">Reboot is required to complete the update process.</span><br><span class="line"></span><br><span class="line">Tool execution completed with the following status: All operations completed successfully.</span><br><span class="line">Press any key to exit.</span><br><span class="line"></span><br><span class="line">[root@esxi2:~] reboot</span><br></pre></td></tr></table></figure><p>最後にリブートが必要とのことでリブートしています。</p><p>ホストが再起動後、ファームウェアが適用されているか再び確認します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@esxi2:~] esxcli network nic get -n vmnic0</span><br><span class="line">   Advertised Auto Negotiation: true</span><br><span class="line">   Advertised Link Modes: Auto, 10000BaseT/Full</span><br><span class="line">   Auto Negotiation: true</span><br><span class="line">   Cable Type: DA</span><br><span class="line">   Current Message Level: 1</span><br><span class="line">   Driver Info:</span><br><span class="line">         Bus Info: 0000:01:00:0</span><br><span class="line">         Driver: i40en</span><br><span class="line">         Firmware Version: 9.20 0x8000d8bc 1.2074.0</span><br><span class="line">         Version: 1.11.1.31</span><br><span class="line">   Link Detected: true</span><br><span class="line">   Link Status: Up</span><br><span class="line">   Name: vmnic0</span><br><span class="line">   PHYAddress: 0</span><br><span class="line">   Pause Autonegotiate: false</span><br><span class="line">   Pause RX: true</span><br><span class="line">   Pause TX: true</span><br><span class="line">   Supported Ports: DA</span><br><span class="line">   Supports Auto Negotiation: true</span><br><span class="line">   Supports Pause: true</span><br><span class="line">   Supports Wakeon: true</span><br><span class="line">   Transceiver:</span><br><span class="line">   Virtual Address: 00:00:00:00:00:00</span><br><span class="line">   Wakeon: MagicPacket(tm)</span><br></pre></td></tr></table></figure><p><code>Firmware Version: 9.20</code>ということで、無事更新されました。</p><p>intelの手順書では、NOTEとして、以下の説明があります。</p><blockquote><p>On 700 Series and 500 Series devices, updating to the most current NVM (with the NVM Update Package) and driver does not update the Option ROM. Intel recommends an Option ROM update after the NVM and driver are updated. Refer to the User Guide for Intel® Ethernet Adapters page for the most current Option ROM update process version.</p></blockquote><p>これはネットワークブート時の<mark class="label primary">UEFI Network Driver Option ROM</mark>をLinuxまたはUEFIシェルを使ってUEFIネットワークドライバを更新するものです。今回はこの作業については割愛します。</p><h2 id="MellanoxのNICファームウェア更新"><a href="#MellanoxのNICファームウェア更新" class="headerlink" title="MellanoxのNICファームウェア更新"></a>MellanoxのNICファームウェア更新</h2><p>Mellanoxの場合は、NVIDIAのサイトに”How-to: Install NVIDIA Firmware Tools (MFT) on VMware ESXi 6.7&#x2F;7.0.”というマニュアルがありますので、そこで手順を確認します。</p><blockquote><p>How-to: Install NVIDIA Firmware Tools (MFT) on VMware ESXi 6.7&#x2F;7.0.<br> <a href="https://docs.nvidia.com/networking/pages/releaseview.action?pageId=15049813">https://docs.nvidia.com/networking/pages/releaseview.action?pageId=15049813</a></p></blockquote><p>NVIDIA Firmware Toolをダウンロードし、ESXiにインストールします。その後別途ファームウェアをダウンロードしてファームウェアのアップグレードを行います。昔はflintでしたが、上記手順によれば今はmlxfwmanagerというのが使われるようです。Windowsではそのサブセットのmlxupが一般的です。</p><ol><li><p>ツールを2つダウンロードするために、ダウンロードページにアクセスします。<br> <a href="http://www.mellanox.com/page/management_tools">http://www.mellanox.com/page/management_tools</a></p></li><li><p>ここの例ではESXi7.0向けのVersion4.18.1を使い進めます。</p></li><li><p>“7 Native”、”x64”を選択し、”Mellanox-NATIVE-NMST_4.18.1.14-1OEM.700.1.0.15843807_19206114-package.zip”をダウンロードし展開します。</p></li><li><p>ZIPの中にはさらにZIPファイルがあり、”MEL_bootbank_nmst_4.18.1.14-1OEM.700.1.0.15843807.vib”というESXiのモジュールファイルを見つけます。 <img src="/new-technology/2022/04/02/nic-firmware/nmst.png" class="" width="480" title="alt"></p></li><li><p>続いて、”Mellanox-MFT-Tools_4.18.1.14-1OEM.700.1.0.15843807_19206112-package.zip”をダウンロードし展開します。</p></li><li><p>こちらもZIPの中にさらにZIPファイルがあり、”mft”というフォルダの中に”MEL_bootbank_mft_4.18.1.14-0.vib”のモジュールファイルを見つけます。別にOEMというフォルダがあり、NVIDIAの手順書でもファイル名からもOEMを選ぶべきのように見えますが、OEMのフォルダのものは必要なモジュールが見つかりません。<img src="/new-technology/2022/04/02/nic-firmware/mft.png" class="" width="480" title="alt"></p></li><li><p>scpかストアブラウザを使いこの2つのファイルをESXiにアップロードします。2つのモジュールは1つづつインストール、リブートが必要になりますので、&#x2F;tmpにコピーする場合は最初のリブートで&#x2F;tmpがクリアされるのでお気をつけください。</p></li><li><p>ESXiにSSHで接続し、最初のモジュール(NMST)をインストールします。<code>esxcli software vib install -v /tmp/MEL_bootbank_nmst_4.18.1.14-1OEM.700.1.0.15843807.vib -f</code></p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost:/tmp] esxcli software vib install -v /tmp/MEL_bootbank_nmst_4.18.1.14-1OEM.700.1.0.15843807.vib -f</span><br><span class="line">Installation Result</span><br><span class="line">   Message: The update completed successfully, but the system needs to be rebooted <span class="keyword">for</span> the changes to be effective.</span><br><span class="line">   Reboot Required: <span class="literal">true</span></span><br><span class="line">   VIBs Installed: MEL_bootbank_nmst_4.18.1.14-1OEM.700.1.0.15843807</span><br><span class="line">   VIBs Removed:</span><br><span class="line">   VIBs Skipped:</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><p>ここで一旦リブートします。</p></li><li><p>SSHで接続後、2つ目のモジュール(MFT-Tools)をインストールします。<code>esxcli software vib install -v /tmp/MEL_bootbank_mft_4.18.1.14-0.vib -f</code></p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> [root@localhost:/tmp] esxcli software vib install -v /tmp/MEL_bootbank_mft_4.18.1.14-0.vib -f</span><br><span class="line">Installation Result</span><br><span class="line">   Message: The update completed successfully, but the system needs to be rebooted for the changes to be effective.</span><br><span class="line">   Reboot Required: true</span><br><span class="line">   VIBs Installed: MEL_bootbank_mft_4.18.1.14-0</span><br><span class="line">   VIBs Removed:</span><br><span class="line">   VIBs Skipped:</span><br></pre></td></tr></table></figure></li><li><p>再びリブートします。</p></li><li><p>ESXiにインストールされているモジュールを確認します。<code>esxcli software vib list</code><br> 先頭に以下のモジュールがあるはずです。PartnerSupportedとなっており、セキュアブートのESXiでも問題ありません。</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"> Name                           Version                                Vendor  Acceptance Level  Install Date</span><br><span class="line">-----------------------------  -------------------------------------  ------  ----------------  ------------</span><br><span class="line">mft                            4.18.1.14-0                            MEL     PartnerSupported  2022-03-13</span><br><span class="line">nmst                           4.18.1.14-1OEM.700.1.0.15843807        MEL     PartnerSupported  2022-03-13</span><br></pre></td></tr></table></figure></li><li><p>SSHで接続後、ツールの動作確認をします。ここではConnectX3がある環境です。<code>cd /opt/mellanox/bin</code>,<code>./mst start</code>,<code>./mst status</code>,<code>./mst status -vv</code></p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost:/opt/mellanox/bin] ./mst start</span><br><span class="line">Module mst is already loaded</span><br><span class="line">[root@localhost:/opt/mellanox/bin] ./mst status</span><br><span class="line">MST devices:</span><br><span class="line">------------</span><br><span class="line">mt4099_pciconf0</span><br><span class="line">mt4099_pci_cr0</span><br><span class="line"></span><br><span class="line">[root@localhost:/opt/mellanox/bin] /opt/mellanox/bin/mst status -vv</span><br><span class="line">PCI devices:</span><br><span class="line">------------</span><br><span class="line">DEVICE_TYPE             MST                           PCI       RDMA            NET                       NUMA</span><br><span class="line">ConnectX3(rev:1)        mt4099_pciconf0               01:00.0   net-vmnic0</span><br><span class="line">ConnectX3(rev:1)        mt4099_pci_cr0                01:00.0   net-vmnic0</span><br></pre></td></tr></table></figure></li><li><p>ファームウェアアップデートに使うmlxfwmanagerの動作確認をします。<code>./mlxfwmanager --query</code></p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost:/opt/mellanox/bin] ./mlxfwmanager --query</span><br><span class="line">Querying Mellanox devices firmware ...</span><br><span class="line"></span><br><span class="line">Device #1:</span><br><span class="line">----------</span><br><span class="line"></span><br><span class="line"> Device Type:      ConnectX3</span><br><span class="line"> Part Number:      MCX311A-XCA_Ax</span><br><span class="line"> Description:      ConnectX-3 EN network interface card; 10GigE; single-port SFP+; PCIe3.0 x4 8GT/s; RoHS R6</span><br><span class="line"> PSID:             MT_1170110023</span><br><span class="line"> PCI Device Name:  mt4099_pci_cr0</span><br><span class="line"> Port1 MAC:        0002c9xxxxxx</span><br><span class="line"> Port2 MAC:        0002c9xxxxxx</span><br><span class="line"> Versions:         Current        Available</span><br><span class="line">    FW             2.33.5220      N/A</span><br><span class="line">    PXE            3.4.0467       N/A</span><br><span class="line"></span><br><span class="line"> Status:           No matching image found</span><br></pre></td></tr></table></figure><p> 今回のケースでは、ebayにて＄50で購入可能な、ConnectX-3（MCX311A-XCAT）を対象としています。</p></li><li><p>NVIDIAのサイトからファームウェアをダウンロードします。<br>　<a href="https://network.nvidia.com/support/firmware/firmware-downloads/">https://network.nvidia.com/support/firmware/firmware-downloads/</a></p></li><li><p>該当するEthernetファームウェアを選択し、ZIPファイルをダウンロードし展開します。*.binというファイルが抽出されます。</p> <img src="/new-technology/2022/04/02/nic-firmware/firmware.png" class="" width="480" title="alt"></li><li><p>scpまたはストアブラウザでbinファイルをESXiの&#x2F;tmpにアップロードします。</p></li><li><p>ファームウェアのアップデートを行います <code>./mlxfwmanager -u -i /tmp/ファームウェア.bin</code>。ファームウェアの実行直前に確認が求められるので、”y”を入力します。</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost:/opt/mellanox/bin] ./mlxfwmanager -u -i /tmp/fw-ConnectX3-rel-2_42_5000-MCX311A-XCA_Ax-FlexBoot-3.4.752.bin</span><br><span class="line">Querying Mellanox devices firmware ...</span><br><span class="line"></span><br><span class="line">Device #1:</span><br><span class="line">----------</span><br><span class="line"></span><br><span class="line"> Device Type:      ConnectX3</span><br><span class="line"> Part Number:      MCX311A-XCA_Ax</span><br><span class="line"> Description:      ConnectX-3 EN network interface card; 10GigE; single-port SFP+; PCIe3.0 x4 8GT/s; RoHS R6</span><br><span class="line"> PSID:             MT_1170110023</span><br><span class="line"> PCI Device Name:  mt4099_pci_cr0</span><br><span class="line"> Port1 MAC:        0002c9232da0</span><br><span class="line"> Port2 MAC:        0002c9232da1</span><br><span class="line"> Versions:         Current        Available</span><br><span class="line">    FW             2.33.5220      2.42.5000</span><br><span class="line">    PXE            3.4.0467       3.4.0752</span><br><span class="line"></span><br><span class="line"> Status:           Update required</span><br><span class="line"></span><br><span class="line">---------</span><br><span class="line">Found 1 device(s) requiring firmware update...</span><br><span class="line"></span><br><span class="line">Perform FW update? [y/N]: y</span><br><span class="line">Device #1: Updating FW ...</span><br><span class="line">Done</span><br><span class="line"></span><br><span class="line">Restart needed for updates to take effect.</span><br></pre></td></tr></table></figure></li><li><p>リブートします。</p></li><li><p>再び、<code>./mlxfwmanager --query</code>を実行し、ファームウェアがアップデートされたか確認します。</p> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost:/opt/mellanox/bin]  ./mlxfwmanager --query</span><br><span class="line">Querying Mellanox devices firmware ...</span><br><span class="line"></span><br><span class="line">Device #1:</span><br><span class="line">----------</span><br><span class="line"></span><br><span class="line"> Device Type:      ConnectX3</span><br><span class="line"> Part Number:      MCX311A-XCA_Ax</span><br><span class="line"> Description:      ConnectX-3 EN network interface card; 10GigE; single-port SFP+; PCIe3.0 x4 8GT/s; RoHS R6</span><br><span class="line"> PSID:             MT_1170110023</span><br><span class="line"> PCI Device Name:  mt4099_pci_cr0</span><br><span class="line"> Port1 MAC:        0002c9xxxxxx</span><br><span class="line"> Port2 MAC:        0002c9xxxxxx</span><br><span class="line"> Versions:         Current        Available</span><br><span class="line">    FW             2.42.5000      N/A</span><br><span class="line">    PXE            3.4.0752       N/A</span><br><span class="line"></span><br><span class="line"> Status:           No matching image found</span><br><span class="line"></span><br></pre></td></tr></table></figure></li></ol><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>intelでは新しいファームウェアについて推奨と書かれる場合があり判断が難しいケースがありますが、脆弱性や製品の組み合わせなど問題が顕在化する環境に当てはまる場合のみ、新しいファームウェアを適用すべきでしょうか。ファームウェアとドライバーとの整合性もあるのでリリースノートを参照されることをお勧めします。</p>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2022/04/02/nic-firmware/title.png&quot; class=&quot;&quot; width=&quot;1024&quot; title=&quot;alt&quot;&gt;

&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;

&lt;p&gt;ESXiにおいてネットワークカードの主要ITベンダーであるintelおよびMellanox(NVidia)のファームウェアをアップデートします。sshでESXiホストに接続したままアップデート可能です（作業中は何度かのシステムリスタートが必要になります）。&lt;/p&gt;</summary>
    
    
    
    <category term="Hardware" scheme="https://yoshi0808.github.io/new-technology/categories/Hardware/"/>
    
    <category term="Network" scheme="https://yoshi0808.github.io/new-technology/categories/Network/"/>
    
    
    <category term="ESXi" scheme="https://yoshi0808.github.io/new-technology/tags/ESXi/"/>
    
  </entry>
  
  <entry>
    <title>Sophos Firewall v18.5 MR-3</title>
    <link href="https://yoshi0808.github.io/new-technology/2022/03/25/xg-v185-mr3/"/>
    <id>https://yoshi0808.github.io/new-technology/2022/03/25/xg-v185-mr3/</id>
    <published>2022-03-25T11:11:40.000Z</published>
    <updated>2022-04-28T23:43:13.000Z</updated>
    
    <content type="html"><![CDATA[<img src="/new-technology/2022/03/25/xg-v185-mr3/title.png" class="" title="alt"><h2 id="Sophos-Firewall-v18-5-MR-3"><a href="#Sophos-Firewall-v18-5-MR-3" class="headerlink" title="Sophos Firewall v18.5 MR-3"></a>Sophos Firewall v18.5 MR-3</h2><p>Sophos Firewall v18.5 MR3が2022年3月24日に発表されました。主としては不具合の解消がメインです。また、v18.5を含みSophos Firewallの脆弱性の情報が提供されています。なお、XG Firewallの最新パッチについては、「<a href="/new-technology/2020/10/11/esxi-backup/" title="VMware ESXiの仮想マシンをバックアップする">VMware ESXiの仮想マシンをバックアップする</a>」の関連リンクを参照してください。</p><span id="more"></span><h2 id="主なエンハンスの内容"><a href="#主なエンハンスの内容" class="headerlink" title="主なエンハンスの内容"></a>主なエンハンスの内容</h2><ul><li>OpenSSL(CVE-2022-0778)のサービス拒否の脆弱性を修正</li><li>いくつかの重要なセキュリティ、パフォーマンス、信頼性の向上</li><li>Sophosアンチスパムインターフェースに更新された電子メール保護アンチスパムエンジン</li></ul><p>v18.5 MR-3の詳細な説明はSophos Communityを参照してください。出来るだけ早く適用するように推奨されています。</p><blockquote><p><a href="https://community.sophos.com/sophos-xg-firewall/b/blog/posts/sophos-firewall-v18-5-mr3-is-now-available">https://community.sophos.com/sophos-xg-firewall/b/blog/posts/sophos-firewall-v18-5-mr3-is-now-available</a></p></blockquote><h2 id="Sophos-Firewallのアップデート"><a href="#Sophos-Firewallのアップデート" class="headerlink" title="Sophos Firewallのアップデート"></a>Sophos Firewallのアップデート</h2><p>XGの管理画面にログイン後、左ペインメニューの<mark class="label primary">バックアップ＆ファームウェア</mark>の<mark class="label primary">ファームウェアの確認</mark>ではただちに全てのユーザーにアップデートの案内が来るわけでは無いようなので、アップデートにはMySophosにログインし、バージョンアップの差分モジュールをダウンロードします。</p><ol><li>Sophosのサイトの右上のプルダウンメニューから、<mark class="label primary">ライセンスとアカウント</mark>をクリックします。<blockquote><p><a href="https://www.sophos.com/ja-jp.aspx">https://www.sophos.com/ja-jp.aspx</a></p></blockquote></li><li>Sophos IDをお持ちでなければIDを作成します。</li><li>ログイン後、<mark class="label primary">Network Protection</mark>をクリックします。</li><li><mark class="label primary">ファームウェアの更新</mark>をクリックします。</li><li>「製品名&#x2F;OSを使った検索」で”ファイアーウォール”を選択し、その後現れるプルダウンは”ソフトウェア”を選択します。</li><li><mark class="label primary">選択可能なダウンロードを表示</mark>ボタンをクリックします。</li></ol><img src="/new-technology/2022/03/25/xg-v185-mr3/mysophos.png" class="" width="800" title="alt"><ol start="7"><li>上記画面で”SW-18.5.3_MR3-SFW-408”というアップデータが表示されますのでダウンロードします。</li><li>MY Sophosはここで終了してXGの管理画面にログインし、左ペインメニューの<mark class="label primary">バックアップ＆ファームウェア</mark>の<mark class="label primary">ファームウェアのタブメニュー</mark>から以下の画面に赤丸で囲った矢印のアイコンをクリックし、ダウンロードしたモジュールをアップロードします。</li></ol><img src="/new-technology/2022/03/25/xg-v185-mr3/verup.png" class="" width="800" title="alt"><p>アップロード＆再起動ボタンをクリックし、MR3へのアップグレードを完了させます。</p><img src="/new-technology/2022/03/25/xg-v185-mr3/upgrade.png" class="" width="800" title="alt"><div class="note info"><p>仮想環境（ESXi）上にFirewallをインストールされている方はアップグレードの前に、「<a href="/new-technology/2020/10/11/esxi-backup/" title="VMware ESXiの仮想マシンをバックアップする">VMware ESXiの仮想マシンをバックアップする</a>」を参考に、バックアップを確保される事をお勧めします。</p></div><h2 id="Sophos-FirewallのCVE-2022-1040"><a href="#Sophos-FirewallのCVE-2022-1040" class="headerlink" title="Sophos FirewallのCVE-2022-1040"></a>Sophos FirewallのCVE-2022-1040</h2><p>Sophosからは、Resolved RCE in Sophos Firewallという記事で2022-03-25に発表されています。これは、リモートコード実行を可能にする認証バイパスの脆弱性であり、SophosファイアウォールのユーザーポータルとWebadminで影響を受けます。</p><blockquote><p>Sophos Resolved RCE in Sophos Firewall (CVE-2022-1040)<br> <a href="https://www.sophos.com/en-us/security-advisories/sophos-sa-20220325-sfos-rce">https://www.sophos.com/en-us/security-advisories/sophos-sa-20220325-sfos-rce</a></p></blockquote><p>ただし、このブログで掲載している過去記事、「<a href="/new-technology/2020/06/24/protect-xg/" title="XG Firewall自身を防御する">XG Firewall自身を防御する</a>」で記載の通り、ローカルサービスACLにてWANからのWebadminおよびユーザーポータルからのアクセスが行えない状況にしてあれば、まず安全と言えます。Sophosではこういった脆弱性対策のためにHotFix機能を持っていて、速やかにパッチが自動更新されます。</p><img src="/new-technology/2022/03/25/xg-v185-mr3/acl.png" class="" width="800" title="alt"><p>※SSL-VPNを利用されている方はWANの項目にチェックが入る事は問題ありません。</p><img src="/new-technology/2022/03/25/xg-v185-mr3/hotfix.png" class="" width="640" title="alt"><h3 id="HotFixの確認"><a href="#HotFixの確認" class="headerlink" title="HotFixの確認"></a>HotFixの確認</h3><p>Firewall本体のコマンドコンソールにアクセスします。XG本体のコンソールまたは、ESXi上にインストールされている方はESXiのコンソールからFirewallのAdminのパスワードを入力し、ログインします。コマンドコンソールからは、<mark class="label primary">5.Device Management</mark>を選択、さらに、<mark class="label primary">3.Advanced Shell</mark>を選択します。そして以下のコマンドを実行します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SFVH_SO01_SFOS 18.5.3 MR-3-Build408#SFVUNL_SO01_SFOS 18.5.2 MR-2-Build380# test -f /static/up_mode_json_stamp &amp;&amp; echo &quot;Hotfix is applied&quot; || echo &quot;Hotfix isn&#x27;t applied&quot;</span><br><span class="line">Hotfix is applied</span><br></pre></td></tr></table></figure><p>上記のように”Hotfix is applied”と表示されればHotFixは適用済みです。isn’t appliedとでた場合はしばらく待つかSophosへのインターネットの接続性の確認が必要です。</p>]]></content>
    
    
    <summary type="html">&lt;img src=&quot;/new-technology/2022/03/25/xg-v185-mr3/title.png&quot; class=&quot;&quot; title=&quot;alt&quot;&gt;

&lt;h2 id=&quot;Sophos-Firewall-v18-5-MR-3&quot;&gt;&lt;a href=&quot;#Sophos-Firewall-v18-5-MR-3&quot; class=&quot;headerlink&quot; title=&quot;Sophos Firewall v18.5 MR-3&quot;&gt;&lt;/a&gt;Sophos Firewall v18.5 MR-3&lt;/h2&gt;&lt;p&gt;Sophos Firewall v18.5 MR3が2022年3月24日に発表されました。主としては不具合の解消がメインです。また、v18.5を含みSophos Firewallの脆弱性の情報が提供されています。なお、XG Firewallの最新パッチについては、「&lt;a href=&quot;/new-technology/2020/10/11/esxi-backup/&quot; title=&quot;VMware ESXiの仮想マシンをバックアップする&quot;&gt;VMware ESXiの仮想マシンをバックアップする&lt;/a&gt;」の関連リンクを参照してください。&lt;/p&gt;</summary>
    
    
    
    <category term="Security" scheme="https://yoshi0808.github.io/new-technology/categories/Security/"/>
    
    
    <category term="XG Firewall" scheme="https://yoshi0808.github.io/new-technology/tags/XG-Firewall/"/>
    
  </entry>
  
  <entry>
    <title>ESXI7.0をRyzen7 5700Gで構築</title>
    <link href="https://yoshi0808.github.io/new-technology/2022/02/27/building-setup-esxi7/"/>
    <id>https://yoshi0808.github.io/new-technology/2022/02/27/building-setup-esxi7/</id>
    <published>2022-02-26T18:58:48.000Z</published>
    <updated>2023-02-08T12:46:47.000Z</updated>
    
    <content type="html"><![CDATA[<p class="onepoint">この記事で実現すること</p><p>最近、改めて無償版ESXi7.0向けのハードウェアをRyzen CPUをベースにセットアップし直したので参考までに掲載します。vmの動作などは全く問題ありませんが、ESXi自身のセキュアブートだけはうまくいきませんでした。参考になればと思い記録を残します。</p><span id="more"></span><h2 id="ESXi7のためのハードウェア選定検討"><a href="#ESXi7のためのハードウェア選定検討" class="headerlink" title="ESXi7のためのハードウェア選定検討"></a>ESXi7のためのハードウェア選定検討</h2><p>ハードウェア選定については以下のポリシーとしました。私はパワーユーザーではなく、1つの仮想マシン（vm)に大きな能力を求めていませんが、LinuxやFirewallなどを中心にvmの数だけは増えていきそうな気がします。これまで使っていたハードウェアは10GBase-TのNICも含めてかなり熱を出していたのでもう少し省電力を求めて探しました。</p><ul><li>CPUは多くのvmを動かすことが想定されるが省電力を意識したい</li><li>筐体はスリムタイプ（Micro-ATX）でグラフィックカードは積まず貴重なPCIeスロットはネットワークカードに使う</li><li>ネットワークカードはintelかMellanoxが候補。熱対策が必要なので10Gbase-Tではなく、SFP+を中心に検討</li><li>ストレージは高速化のためNVMeにしたい</li></ul><h2 id="ハードウェア構成"><a href="#ハードウェア構成" class="headerlink" title="ハードウェア構成"></a>ハードウェア構成</h2><p>以下のハードウェア構成となりました。</p><table><thead><tr><th>パーツ</th><th>製品名</th></tr></thead><tbody><tr><td>CPU</td><td>Ryzen7 5700G 3.8GHz(Radeon Graphics)</td></tr><tr><td>マザーボード</td><td>GIGABYTE B550M S2H Micro-ATX</td></tr><tr><td>メモリ</td><td>SanMax DDR4-3200 1.2Volt Skhynix(88H) 32GB x 2</td></tr><tr><td>NVMe</td><td>Samsung 970EVO Plus PCIE x Gen3 x 4 1TB</td></tr><tr><td>SSD</td><td>WesternDigital Blue 500GB</td></tr><tr><td>NIC</td><td>ipolex OEM (intel X710 chipset) 10GbE SFP＋ 4Port</td></tr><tr><td>電源</td><td>スリムタイプ 300W電源</td></tr></tbody></table><p>キーボード・マウス・NICを除き163,480円でした。NICはダイレクトアタッチケーブル2本を含め$531でした（送料と関税入れると＄580程度）。</p><h3 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h3><p>毎回の説明ですが、ESXiにおいてはリテール向けのCPUは公式にサポートされていません。intelのCore iシリーズは鉄板ですが、AMD Ryzenでも動くようだという記事もちらほら見かけるようになりました。ESXi7.0になって、AMDのZEN3アーキテクチャをサポートするという内容（具体的にはEPYCに対応する）についてVMWareの方が説明しているビデオを見た事があり、ZEN3アーキテクチャのRyzenなら安定動作が見込めるのではないかと考えました。 私の場合省電力のPCを必要としていました。省電力ながらCPU8コア16スレッドは魅力です。Ryzen7 5700GはTDP65Wなので、全体で100W程度の省電力マシンを構築することを目標としました。ヘッドレスシステム、いわゆるキーボードもマウスもディスプレイ（グラフィックカード）も持たないESXiでのGPUレスのセットアップもあるようですが、トラブル時の緊急対応や後々のクライアントPCとしての再利用も視野に入れ、GPU付きのCPU(APU)を選択しました。</p><h3 id="マザーボード"><a href="#マザーボード" class="headerlink" title="マザーボード"></a>マザーボード</h3><p>秋葉原のパソコンSHOPアーク（Ark)にカスタマイズモデルがあり、それをベースに選択しました。無線LANや2.5GbEなども使う必要がないのでシンプルなマザーボードのGIGABYTE B550M S2H Micro-ATXを選定しました。</p><img src="/new-technology/2022/02/27/building-setup-esxi7/B550SH2.png" class="" width="1000" title="alt"><h3 id="メモリ"><a href="#メモリ" class="headerlink" title="メモリ"></a>メモリ</h3><p>安定していると評判の国内メーカーのものを選定しました。</p><h3 id="ストレージ"><a href="#ストレージ" class="headerlink" title="ストレージ"></a>ストレージ</h3><p>VMware Commmunityで970EVO Plusが動作するという情報が数件あったのでそれを参考に選定しました。980 Proなどそれ以上の魅力的な製品もありますが、Ryzen7 5700Gを選定しているため、PCIe x 3の制約があり、その上限に合わせた製品にしました。</p><img src="/new-technology/2022/02/27/building-setup-esxi7/970evo.png" class="" width="1000" title="alt"><h3 id="ネットワークカード"><a href="#ネットワークカード" class="headerlink" title="ネットワークカード"></a>ネットワークカード</h3><p>それなりの数のvmを動作させるとなると必然的にNICは10Gbpsを用意したくなります。過去からintel X550-T2を使ってきてそのまま使い続けるのでも良かったのですが、私の場合、クローゼットに光回線とモデム、CD管が集約されてしまっていることから、そこにあまり熱の出すハードウェアを置けません。次回はSFP&#x2F;SFP+にしようと決めていました。が、NICについては昨今の半導体不足で、欲しいカードは殆ど品切れの状態です。それでAmazon.comでipolexというSFPメーカーがOEM提供しているintel X710のチップが乗った4Portの10GbEカードを購入しました。intel純正のX710のSFP+4Portはフルハイトのカードですが、このipolex社のNICはロープロファイルでしたので私にとっては都合が良いものでした。</p><img src="/new-technology/2022/02/27/building-setup-esxi7/ipolex.png" class="" width="640" title="alt"><p>なお、2023-2-8時点でamazon.comでもintel純正のSFP+モデルは完売、X710チップが乗った2Portの3rdベンダー製品で$270です。</p><h2 id="ESXi7-0u3cのインストール"><a href="#ESXi7-0u3cのインストール" class="headerlink" title="ESXi7.0u3cのインストール"></a>ESXi7.0u3cのインストール</h2><h3 id="UEFIの設定"><a href="#UEFIの設定" class="headerlink" title="UEFIの設定"></a>UEFIの設定</h3><p>UEFIについては、以下の項目を設定しました。</p><table><thead><tr><th>項目名</th><th>設定値</th></tr></thead><tbody><tr><td>SVM mode</td><td>Enable</td></tr><tr><td>Fast Boot</td><td>Disable</td></tr><tr><td>CSM Support</td><td>Disable</td></tr><tr><td>Secure Boot</td><td>Advanced</td></tr></tbody></table><p>しかし、最終的にはセキュアブートでインストールされませんでした。</p><p>ESXiは事後にもセキュアブートに変更できるのですが、うまくいきません。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@esxi:~] /usr/lib/vmware/secureboot/bin/secureBoot.py -c</span><br><span class="line">Secure boot can be enabled: All vib signatures verified. All tardisks validated. All acceptance levels validated</span><br><span class="line">[root@esxi:~]</span><br><span class="line"></span><br><span class="line">[root@esxi:~] esxcli system settings encryption set --require-secure-boot=T</span><br><span class="line">Unable to change the encryption mode and policy. Verify that the current host configuration can satisfy the new requirement.</span><br><span class="line">[root@esxi:~]</span><br></pre></td></tr></table></figure><p>コマンドの前半では、セキュアブートに移行できるかのチェックではOKということですが、実際のセキュアブートへの変更ではエラーとなってしまいます。VMware Communityでも見かける内容ですが明確な答えは無いようです。これはマザーボードとESXiとの相性と考えられますが、今後もウォッチしていきたいと思います。</p><blockquote><p><a href="https://communities.vmware.com/t5/ESXi-Discussions/Enabling-Secure-Boot-not-possible/m-p/2864968">https://communities.vmware.com/t5/ESXi-Discussions/Enabling-Secure-Boot-not-possible/m-p/2864968</a></p></blockquote><h3 id="インストール"><a href="#インストール" class="headerlink" title="インストール"></a>インストール</h3><p>これまで同様、Rufusで32GBのUSBメモリにISOファイルを登録しUSBブートからセットアップしています。64Gbyteのメモリを認識し、NICも4つ認識されました。</p><img src="/new-technology/2022/02/27/building-setup-esxi7/esxi1.png" class="" width="800" title="alt"><p>NICの情報はこちらです。</p><img src="/new-technology/2022/02/27/building-setup-esxi7/esxi2.png" class="" width="800" title="alt"><p>ipolexはさらに製造をアウトソースしているのでしょうか、単に販売代理店でしょうか。MACアドレスを見る限りでは、「Beijing Sinead Technology」が製造しているようです。購入にあたってはipolexのサポートの方と色々やりとりができましたので安心して購入できました。</p><p>ストレージコントローラは以下の通りです。NVMe 1GBに加え、バックアップ用途で500GBのSSDを加えています。</p><img src="/new-technology/2022/02/27/building-setup-esxi7/esxi3.png" class="" width="800" title="alt"><h3 id="旧マシンからvmの移行"><a href="#旧マシンからvmの移行" class="headerlink" title="旧マシンからvmの移行"></a>旧マシンからvmの移行</h3><p>環境が異なるため、vSwitchやポートグループの設定はやり直しになりました。NASに対するNFSのマウントなど、いくつかの作業はありますが、そう重い作業ではありません。旧マシンでghettoVCBのバックアップから新環境にレストア、こちらも特段問題がなく3つのvmはあっさり30分程度で終了です。セキュアブートにしていたubuntuやWin10などは問題なく起動しています。</p><h2 id="ストレージのパフォーマンス"><a href="#ストレージのパフォーマンス" class="headerlink" title="ストレージのパフォーマンス"></a>ストレージのパフォーマンス</h2><p>vmのWindows10で実行したCrystal Disk Markの結果です。</p><img src="/new-technology/2022/02/27/building-setup-esxi7/DiskMark.png" class="" width="480" title="alt"><h2 id="ネットワークのパフォーマンス"><a href="#ネットワークのパフォーマンス" class="headerlink" title="ネットワークのパフォーマンス"></a>ネットワークのパフォーマンス</h2><p>こちらはWindows10Proのvmから10GbEのNASに対するiperf3の結果です。シングルスレッドだと7Gbps程度が限界のようです。元々、Windows版のiperf3はUNIXからの移植のためのヘルパー機能であるランタイムライブラリ「Cygwin1.dll」を使っておりパフォーマンスが出づらい状況にあります。さらに対向する端末の能力が高くないとこのような結果になりやすいです。10並列でようやく期待値となりました。</p><ul><li>シングルスレッド</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">C:\Users&gt;iperf3 -c 192.168.x.x</span><br><span class="line">[ ID] Interval           Transfer     Bandwidth</span><br><span class="line">[  4]   0.00-10.00  sec  8.48 GBytes  7.29 Gbits/sec                  sender</span><br><span class="line">[  4]   0.00-10.00  sec  8.48 GBytes  7.29 Gbits/sec                  receiver</span><br></pre></td></tr></table></figure><ul><li>10スレッド</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">C:\Users&gt;iperf3 -c 192.168.x.x -P10</span><br><span class="line">[ ID] Interval           Transfer     Bandwidth</span><br><span class="line">(省略)</span><br><span class="line">[SUM]   0.00-10.00  sec  10.9 GBytes  9.33 Gbits/sec                  sender</span><br><span class="line">[SUM]   0.00-10.00  sec  10.8 GBytes  9.28 Gbits/sec                  receiver</span><br></pre></td></tr></table></figure><p>ubuntu20は問題なしです。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">user@ubuntu1:~$ iperf3 -c 192.168.x.x</span><br><span class="line"></span><br><span class="line">Connecting to host 192.168.x.x, port 5201</span><br><span class="line">[  5] local 192.168.x.x port 55808 connected to 192.168.x.x port 5201</span><br><span class="line">[ ID] Interval           Transfer     Bitrate         Retr  Cwnd</span><br><span class="line">[  5]   0.00-1.00   sec  1.09 GBytes  9.39 Gbits/sec    0   1.69 MBytes</span><br><span class="line">[  5]   1.00-2.00   sec  1.07 GBytes  9.20 Gbits/sec    0   1.69 MBytes</span><br><span class="line">[  5]   2.00-3.00   sec  1.10 GBytes  9.42 Gbits/sec    0   1.69 MBytes</span><br><span class="line">[  5]   3.00-4.00   sec  1.09 GBytes  9.40 Gbits/sec    0   2.10 MBytes</span><br><span class="line">[  5]   4.00-5.00   sec  1.10 GBytes  9.42 Gbits/sec    0   2.21 MBytes</span><br><span class="line">[  5]   5.00-6.00   sec  1.09 GBytes  9.40 Gbits/sec  696   1.75 MBytes</span><br><span class="line">[  5]   6.00-7.00   sec  1.09 GBytes  9.41 Gbits/sec    0   1.75 MBytes</span><br><span class="line">[  5]   7.00-8.00   sec  1.10 GBytes  9.42 Gbits/sec    0   1.75 MBytes</span><br><span class="line">[  5]   8.00-9.00   sec  1.10 GBytes  9.42 Gbits/sec    0   1.75 MBytes</span><br><span class="line">[  5]   9.00-10.00  sec  1.06 GBytes  9.10 Gbits/sec    0   2.22 MBytes</span><br><span class="line">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class="line">[ ID] Interval           Transfer     Bitrate         Retr</span><br><span class="line">[  5]   0.00-10.00  sec  10.9 GBytes  9.36 Gbits/sec  696             sender</span><br><span class="line">[  5]   0.00-10.00  sec  10.9 GBytes  9.34 Gbits/sec                  receiver</span><br><span class="line"></span><br><span class="line">iperf Done.</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>速度としては問題ありませんが、ubuntu側にRetrの数字が出ており、対向側端末の能力不足で送信側のTCPの再送が稀に入っています。</p><h2 id="電力チェック"><a href="#電力チェック" class="headerlink" title="電力チェック"></a>電力チェック</h2><p>簡単な負荷テストを実施してみました。このESXi上にある仮想マシン2つを使ったテストです。ubuntu(2vCPU)からfast.comへの速度テストとSophos Firewall(4vCPU)でIPSによるSSL&#x2F;TLSインスペクションの負荷試験です。回線契約はauひかりの5Gbpsですが、FirewallのSSL&#x2F;TLSインスペクションが入るのでスループットは落ちます。CPUリソースおよび電力の記録は以下の通りです。</p><img src="/new-technology/2022/02/27/building-setup-esxi7/fastcom.png" class="" width="400" title="alt"><img src="/new-technology/2022/02/27/building-setup-esxi7/esxi4.png" class="" width="1024" title="alt"><img src="/new-technology/2022/02/27/building-setup-esxi7/wchecker.png" class="" width="400" title="alt"><p>CPU使用率は綺麗に分散していますしまだ半分ほど余力があります。Sophos FirewallのIPSは4つのスレッドで動作すると聞いていたことがあったので、1つのスレッド（vCPU）に偏るか最大4つのスレッドに偏るかと思いましたが、良い意味で予想は外れました。電力については、何もしていない時で35W、速度テスト実施中でも100Wに到達しない程度です。</p><p>ちなみに、数分速度テストを実施した後のダイレクトアタッチケーブルのSFP+モジュール部分は冷たく感じる程度で全く熱を持っていませんでした。</p><h2 id="SFP-について"><a href="#SFP-について" class="headerlink" title="SFP+について"></a>SFP+について</h2><p>今回、SFP+の4PortのNICを選択しましたが、インターネット接続側のホームゲートウェイ（HGW)は従来のRJ-45の端子であることが殆どです。この場合は以下の選択肢があります。</p><ol><li>拡張性のあるマザーボードを選定し、2つのPCIeスロットに2枚のネットワークカードを挿す（1つはRJ45、1つはSFP＋）</li><li>RJ45ポートとSFP＋ポートを持つスイッチングハブを経由し、ESXiからスイッチにはSFP＋で接続、スイッチからHGWにはRJ45で接続する。この場合はスイッチにおけるLAN側、WAN側とをVLANでネットワークセグメントを分離する必要があります（私はこの方法を選択）。</li><li>SFP＋からRJ45への変換専用の小さなスイッチを用意する（CRS305-1G-4S+IN)。但し、この場合もRJ45変換のSFP＋トランシーバーは必要です。HGWが2.5GbpsのRJ45タイプであればQNAPの小さいスイッチも合うでしょうか。</li></ol><ul><li>MikroTik<br> <a href="https://mikrotik.com/product/crs305_1g_4s_in">https://mikrotik.com/product/crs305_1g_4s_in</a></li><li>QNAP<br> <a href="https://www.qnap.com/ja-jp/product/qsw-2104-2s">https://www.qnap.com/ja-jp/product/qsw-2104-2s</a></li></ul><p>お勧めしないのは、NICのSFP＋ポートにRJ45変換のための10Gトランシーバーを接続することです。10GのRJ45トランシーバーは最大3W程度の消費電力ではありますが、触れなくなるほど高熱（70℃）になり、NICに接続するのはNIC破損の危険が高いです。またPCIからSFP+ポートへの電力供給不足でリンクアップしなかったり、2.5Gでリンクアップする場合があります。<br>スイッチに10Gトランシーバーを接続する場合、ネットワーク機器を販売しているMikroTikでは以下のガイダンスを提示しています。</p><blockquote><p>MikroTik S+RJ10 general guidance<br> 前述の通り、S+RJ10(10Gbps RJ45トランシーバー)は通常のトランシーバーよりも発熱が大きく、特にリニアSFPケージを4つ持つデバイスでは、並べて置くとオーバーヒートにつながる可能性があります。S+RJ10は2個おきに配置し、その間に光トランシーバーか空きポートを確保することをお勧めします。</p></blockquote><p> <a href="https://wiki.mikrotik.com/wiki/S%2BRJ10_general_guidance">https://wiki.mikrotik.com/wiki/S%2BRJ10_general_guidance</a></p><p>MikroTikのS+RJ10は高発熱で有名なモジュールですが、他の10GBase-T SFP+モジュールも相当な温度になります。トランシーバーの作りに問題があるわけではなく、そもそも10GBase-T（RJ-45）はかなりの発熱になってしまい、スイッチングハブであっても内部は相当な熱を持ちます。</p><p>SFP+の詳細な情報については「 <a href="/new-technology/2022/05/28/sfp-plus/" title="10GネットワークとSFP+">10GネットワークとSFP+</a> 」にまとめてあります。</p><p>Mellanoxの現行モデルはやはり在庫を殆ど見かけない状況ですが、古いMellanoxのConnect X-3(MCX311A-XCAT)は安価で手に入ります（ebayなどでは5,000円程度です）。私はMellanoxのConnect X-3(PCIe3 x 4)を保有しており、Windows10とQNAPのNAS（TVS-473e）で動いています。Connect X-3は2019年10月に既に販売終了しています。5年後のサービス終了までは保守されるようですが、最近のドライバなどは見かけません。また新しいOSでは対応が見送られる可能性があります。ただ、半導体不足の今の時期のつなぎとして割り切る考え方もありだと思います。Nvidia（Mellanox）のサイトではESXi7.0のドライバはConnect X-4を対象にしているようですが、セキュアブートのESXi 7.0U3cではインストール時にドライバ追加無しでNICのリンクアップ、疎通確認はできています。動作確認についてはESXiにログインしたまでで、仮想マシンを作成して動作まではさせていません。あくまでご参考です。</p><img src="/new-technology/2022/02/27/building-setup-esxi7/mellanox.png" class="" width="1024" title="alt"><blockquote><p>Mellanox End of Life Notification Procedure<br> <a href="https://network.nvidia.com/related-docs/eol/LCR-000532.pdf">https://network.nvidia.com/related-docs/eol/LCR-000532.pdf</a></p></blockquote><h2 id="intel-X710の注意点について"><a href="#intel-X710の注意点について" class="headerlink" title="intel X710の注意点について"></a>intel X710の注意点について</h2><p>X710は省電力で安定した動作をしますが、過去に何度もファームウェアの脆弱性が指摘されています。今の半導体不足の外部環境下において、もはやintel純正を購入することは困難ですが、サードパーティ製のNICでX710のチップが乗ったものを購入する場合であっても、ファームウェアの更新が必要になってきます。ESXiにおけるネットワークカードのファームウェアの更新方法も整理していますので、以下の記事を参照してください。</p><ul><li><a href="/new-technology/2022/04/02/nic-firmware/" title="ESXiでネットワークカードのファームウェアを更新する">ESXiでネットワークカードのファームウェアを更新する</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p class=&quot;onepoint&quot;&gt;この記事で実現すること&lt;/p&gt;

&lt;p&gt;最近、改めて無償版ESXi7.0向けのハードウェアをRyzen CPUをベースにセットアップし直したので参考までに掲載します。vmの動作などは全く問題ありませんが、ESXi自身のセキュアブートだけはうまくいきませんでした。参考になればと思い記録を残します。&lt;/p&gt;</summary>
    
    
    
    <category term="Hardware" scheme="https://yoshi0808.github.io/new-technology/categories/Hardware/"/>
    
    
    <category term="ESXi" scheme="https://yoshi0808.github.io/new-technology/tags/ESXi/"/>
    
    <category term="10GbE" scheme="https://yoshi0808.github.io/new-technology/tags/10GbE/"/>
    
  </entry>
  
</feed>
