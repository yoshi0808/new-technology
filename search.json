[{"title":"Plugable 2.5GbE USB アダプター","url":"/new-technology/2021/10/03/2500MbE/","content":"\n\n自宅のLANにつながるIT機器は増える一方、2.5GbEのUSBアダプターが値段もこなれてきています。2.5G〜10Gのネットワークスイッチも廉価、小型化してきているので導入するいいタイミングです。2.5Gbps、5GbpsのUSBアダプター、イーサネットカードの実力はどの程度のレベルでしょうか。\n\n\n3,000円台で購入できる2.5GbEアダプター最近、米国のPlugable社から3,680円で、2.5GbpsのUSB(USB3.2&#x2F;USB2.0&#x2F;Thunderbolt)接続ができる有線イーサネットアダプターが発売されています。Plugableは私が好きなメーカーで認証済みのThunderbolt3ケーブルを安価に提供しています。\n\nPlugable有線イーサネットアダプター https://ja.plugable.com/products/usbc-e2500\n\nまた、デスクトップPCにおいても、PCI Express×1のスロットは空きがある状態ではないでしょうか。ここ最近2.5GのPCI Express×1カードは、実売価格で4,000円を切ってきています。値段で躊躇してしまうレベルではありません。\nネットワークの理論値と現実1GbEのNICがあれば無理に2.5GbEを使う必要はないように感じます。ネットワークは難しいもので必ず遅延（レイテンシ）が存在しますので、比較高速な自宅内のLANであれば1GbEのNICで上限ぎりぎりまで速度は出ますが、インターネット向けだとそこまでスピードは出ません。私のデスクトップPCで利用しているAquantiaのカードは5Gbpsのチップが載ったPCI Express×1のカードですが、実力としては3Gbps程度です（自宅内のNASに対してiperf3で確認）。これがインターネット宛の通信でスピードテストでは1.4Gbps程度になります。このPCの接続を1GbpsのNICに変更すると700Mbps程度までに落ち込みます（この落ち込みはサーバー・PCの能力、回線の太さ、PCとサーバーとの物理的な距離によって変わります）。遅延要素としてはアプリケーションファイアウォールやウィルス対策ソフト、色々なものが入ります。Wi-Fiを使っているならば11acの高速なWi-Fiでも実測500Mbps〜600Mbps程度でしょうか。LAN内は限りなく1Gbpsで通信できていても実際のネットを使う場合は意外と低速な状態になっています。\n\nSpeedtest by Ookla https://www.speedtest.net\n\nジャンボフレームで速度を引き上げる手法もありますが見た目に分かりづらいトラブルを起こしやすく、私は最新テクノロジーによる能力増でセキュリティ対策などのパフォーマンス劣化をカバーする方法が好きです。\nPlugable 2.5GbE USBアダプターこのPlugable 2.5GbE USBアダプターを利用したWindows10のiperf3（ネットワーク速度測定ツール）の結果です（ウィルス対策ソフトとWindowsDefender Firewallが有効）。\nC:\\iperf3 -c 192.168.x.bConnecting to host 192.168.x.b, port 5201[  4] local 192.168.x.c port 57672 connected to 192.168.x.b port 5201[ ID] Interval           Transfer     Bandwidth[  4]   0.00-1.00   sec   278 MBytes  2.33 Gbits/sec[  4]   1.00-2.00   sec   275 MBytes  2.31 Gbits/sec[  4]   2.00-3.00   sec   276 MBytes  2.31 Gbits/sec[  4]   3.00-4.00   sec   277 MBytes  2.32 Gbits/sec[  4]   4.00-5.00   sec   278 MBytes  2.34 Gbits/sec[  4]   5.00-6.00   sec   280 MBytes  2.35 Gbits/sec[  4]   6.00-7.00   sec   280 MBytes  2.35 Gbits/sec[  4]   7.00-8.00   sec   280 MBytes  2.35 Gbits/sec[  4]   8.00-9.00   sec   280 MBytes  2.35 Gbits/sec[  4]   9.00-10.00  sec   278 MBytes  2.33 Gbits/sec- - - - - - - - - - - - - - - - - - - - - - - - -[ ID] Interval           Transfer     Bandwidth[  4]   0.00-10.00  sec  2.72 GBytes  2.33 Gbits/sec                  sender[  4]   0.00-10.00  sec  2.72 GBytes  2.33 Gbits/sec                  receiveriperf Done.\n\n結果はとても安定しています。私の自宅の環境では家の中を大きく経由（1階→2階→1階）して2つの10Gbpsスイッチを経由していますが、十分な速度です。\n何よりも発熱が非常に抑えられ、熱いという感じはありません。これは採用されているチップが進歩したためです。Plugable社の説明によれば、RTL8156Bというチップが採用されているとの事です。\n\nこのイーサネット・アダプターは Realtek 社製 RTL8156B チップセットを使用しており、10&#x2F;100&#x2F;1000&#x2F;2500 Mbit ネットワーク・スピードに対応しています。USB 2.0、3.0、3.1、3.2、または Thunderbolt 3、Thunderbolt 4、USB 3.2&#x2F;3.１&#x2F;3.0&#x2F;2.0 プロトコルに対応したホストシステムで使用できます。（USB 2.0 ポートに接続した場合には転送速度が制限されます。）\n\nこのアダプターはUSB-CとUSB-Aが使える事、Windows・macOSのどちらも使えます。1Gbps&#x2F;100Mbpsも認識できますので1つ持っておくとさまざまなデバイスに支えて便利ではないでしょうか。なお、USB-C→USB-Aの変換コネクタは事故の恐れがあるので他のケーブルには使えません。そういう意味で変換コネクタはこのアダプターにくくりつけられています。\n普段はWi-Fiを使っていても、何か大きなファイルを操作するとか大量のバックアップを取るなどする場合にはノートPCでも活躍しそうです。2.5Gbのスイッチも1万円切るくらいから発売されているので、少しの投資で速度アップが期待できます。\nmacOSでのiperf3の結果も安定しています。\n$ iperf3 -c 192.168.x.bConnecting to host 192.168.x.b, port 5201[  5] local 192.168.x.a port 50420 connected to 192.168.x.b port 5201[ ID] Interval           Transfer     Bitrate[  5]   0.00-1.00   sec   280 MBytes  2.35 Gbits/sec[  5]   1.00-2.00   sec   280 MBytes  2.35 Gbits/sec[  5]   2.00-3.00   sec   278 MBytes  2.33 Gbits/sec[  5]   3.00-4.00   sec   278 MBytes  2.33 Gbits/sec[  5]   4.00-5.00   sec   277 MBytes  2.32 Gbits/sec[  5]   5.00-6.00   sec   266 MBytes  2.23 Gbits/sec[  5]   6.00-7.00   sec   278 MBytes  2.33 Gbits/sec[  5]   7.00-8.00   sec   268 MBytes  2.25 Gbits/sec[  5]   8.00-9.00   sec   277 MBytes  2.32 Gbits/sec[  5]   9.00-10.00  sec   281 MBytes  2.35 Gbits/sec- - - - - - - - - - - - - - - - - - - - - - - - -[ ID] Interval           Transfer     Bitrate[  5]   0.00-10.00  sec  2.70 GBytes  2.32 Gbits/sec                  sender[  5]   0.00-10.00  sec  2.70 GBytes  2.32 Gbits/sec                  receiveriperf Done.\n\n上記はMacBook-Air 2019(intel)のBig Surにおいて、macOSのFirewall・アプリケーションFirewall(Vallum)・ウィルス対策ソフト（BitDefender）をオフにした状態での検証です。通常利用しているセキュリティを全てオンにすると、CPUパワーが足りないようで、1.6Gbps程度までに落ち込みます。\n$ iperf3 -c 192.168.x.bConnecting to host 192.168.x.b, port 5201[  5] local 192.168.x.a port 51620 connected to 192.168.x.b port 5201[ ID] Interval           Transfer     Bitrate[  5]   0.00-1.00   sec   205 MBytes  1.72 Gbits/sec[  5]   1.00-2.00   sec   205 MBytes  1.72 Gbits/sec[  5]   2.00-3.00   sec   193 MBytes  1.62 Gbits/sec[  5]   3.00-4.00   sec   202 MBytes  1.69 Gbits/sec[  5]   4.00-5.00   sec   198 MBytes  1.66 Gbits/sec[  5]   5.00-6.00   sec   191 MBytes  1.61 Gbits/sec[  5]   6.00-7.00   sec   199 MBytes  1.67 Gbits/sec[  5]   7.00-8.00   sec   199 MBytes  1.67 Gbits/sec[  5]   8.00-9.00   sec   181 MBytes  1.52 Gbits/sec[  5]   9.00-10.00  sec   196 MBytes  1.65 Gbits/sec- - - - - - - - - - - - - - - - - - - - - - - - -[ ID] Interval           Transfer     Bitrate[  5]   0.00-10.00  sec  1.92 GBytes  1.65 Gbits/sec                  sender[  5]   0.00-10.00  sec  1.92 GBytes  1.65 Gbits/sec                  receiveriperf Done.\n\nPlanex社からも2.5GbEのUSBアダプターが今年の7月に発売されています。\n\nhttps://www.planex.co.jp/products/usbc-lan2500r/\n\n2.5Gbpsも要らない、そんなサイズの大きなファイルを移動したり使う事もないというのは普通の感覚ですが、Webブラウザのようにマルチスレッドを用いた通信と画面描画とが完全に最適化されている場合は、それこそ100Mbpsでも十分に機能します。しかし使いたいアプリケーションは必ずしも最適化されているわけでもなく、4K動画を変換しながら再生するなどの処理はとても重いためネットワーク速度もより高速なものが好ましいです。数Mバイト単位のデータを極めて短時間に頻繁に読み込むまたは書き出すアプリケーションがあれば、通信とストレージのデータ処理の遅延が都度発生します。それぞれがシーケンシャルに処理されるアプリケーションは高速化しづらい面があります。例えばmacOSのバックアップソフトであるTimeMachineは、読み取り・差分確認・圧縮・暗号化・書き込みと1つ1つのシーケンシャルの処理の遅延が最終的に数時間にわたり動作し続けるする事になります。これらの1つのオーバーヘッドの要素である通信部分を比較的廉価な投資で速度面の解決ができる点はメリットがあります。\n2Gbps〜10Gbpsのインターネットサービスが提供されている場合で、回線会社から提供されているホームゲートウェイは必ずしも2.5GbE、5GbEと直接接続できるとは限りません。この場合は10GbEの口を持つPCかスイッチを用意する必要があります。\n\n\nmacOSの有線LANにお勧めしますMacBook(Big Sur)で1GbpsのUSBアダプターをお使いの方で速度が出ない方であればPlugable 2.5GbE USBアダプターを検討してみてください。\n実は、intel版のMacBook-AirをCatalinaからBig Surに変えてからTimeMachineのバックアップが非常に遅く感じるようになりました。フルバックアップの時は時間が掛かる事を見越して1Gbpsの有線アダプターを使っていましたが、それが10時間ほど掛かってしまい、これは明らかにおかしいと思い調べ始めました。\nいろいろ調べるなかで、Plugableのサイトであるきっかけが見つかりました。\n\nmacOS（10.13.6 ~ 10.15）：基本的には内蔵ドライバーによりサポートされていますが、当アダプターの完全なパフォーマンスを得るためには、こちらのドライバーページから最新のドライバーをダウンロードし更新してください。macOS（11.x） ：ドライバの導入は必要ありません。ただし、 macOS 11.x では、リンクレートの報告とパケット数が正しくないという既知の問題がわかっています。オートネゴシエーションによってアダプターは 2.5 Gbps の接続を取得し、デバイスは正常に動作しているのにもかかわらず、macOS 上でリンクレートが 1000Mbps しかないように表示されるというものです。またジャンボフレームは現在、macOS 11.x ではサポートされていません。 これらの問題を解決するために、Realtek 社は macOS 11.ｘ 用修正ドライバの開発に取り組んでいます。\n\nPlagableのサイトではApple純正のドライバの問題点とされるものもきちんとした説明がされていて安心できます。今時日本語のWebサイトも用意してくれているのも好感が持てます。またmacOSの投稿者からは、Plagableコミュニティで以下の書き込みがあったのでドライバについてとても参考になりました。\n\nExcellent Big Sur compatibility, but concerned about future support https://support.plugable.com/t/excellent-big-sur-compatibility-but-concerned-about-future-support/20802\n\nこの記事の一部を抜粋します。\n\nmacOS Big Sur appears to be using a Driver Extensions (DEXTs) to provide support to most USB network adapters built with Realtek chipsets. This allows for simple plug-and-play compatibility. But my testing has shown than CPU usage is excessive with the Apple provided DEXT. It interferes with normal system operation. For example, it causes stutters in system audio. Furthermore, on gigabit or faster connections, the DEXT is unable to reach actual gigabit speeds, instead reaching actual performance that typically tops out between 600 and 700 Mbps.\nmacOS Big Surは、DEXTs（Driver Extensions）を使用して、Realtekチップセットを搭載したほとんどのUSBネットワークアダプターに対応しているようです。これにより、シンプルなプラグアンドプレイの互換性を実現しています。しかし、私のテストによると、Appleが提供するDEXTでは、CPU使用率が過剰になります。これは、システムの正常な動作を妨げるものです。例えば、システムオーディオが途切れたりします。さらに、ギガビット以上の接続では、DEXTは実際のギガビットの速度に到達できず、600〜700Mbps程度のパフォーマンスとなります。\n\n\n\nこの投稿者の指摘通り、私のmacOSのアクティビティモニタでiperf3の実行中のパフォーマンスを確認すると、アイドル状態が数％まで落ち込みます。つまり通信部分で多くのリソースを使い果たしているのです。\nWi-Fiでiperf3実行時\n\n\n1GbEでiperf3実行時\n\n\nシステムがCPUを74.1％使用し、アイドルが1.35％しかありません。その時のiperf3実行結果はWi-Fi以下の速度でした。\n$ iperf3 -c 192.168.x.bConnecting to host 192.168.x.b, port 5201[  5] local 192.168.x.a port 59287 connected to 192.168.x.b port 5201[ ID] Interval           Transfer     Bitrate[  5]   0.00-1.00   sec  40.9 MBytes   342 Mbits/sec[  5]   1.00-2.00   sec  38.5 MBytes   324 Mbits/sec[  5]   2.00-3.00   sec  54.6 MBytes   458 Mbits/sec[  5]   3.00-4.00   sec  56.3 MBytes   472 Mbits/sec[  5]   4.00-5.00   sec  49.5 MBytes   415 Mbits/sec[  5]   5.00-6.00   sec  53.4 MBytes   448 Mbits/sec[  5]   6.00-7.00   sec  41.0 MBytes   344 Mbits/sec[  5]   7.00-8.00   sec  52.7 MBytes   443 Mbits/sec[  5]   8.00-9.00   sec  50.2 MBytes   420 Mbits/sec[  5]   9.00-10.00  sec  49.4 MBytes   416 Mbits/sec- - - - - - - - - - - - - - - - - - - - - - - - -[ ID] Interval           Transfer     Bitrate[  5]   0.00-10.00  sec   487 MBytes   408 Mbits/sec                  sender[  5]   0.00-10.01  sec   485 MBytes   407 Mbits/sec                  receiver\n\nこのPlugable 2.5GbE USBアダプターでは、ドライバの拡張子が”kext”となっており十分なパフォーマンスです。※Firewallやウィルス対策ソフトを利用しているとCPUは100％近くにはなります。\n\n\nPlugableの製品そのものの魅力ももちろんですが、ナレッジベースやコミュニティなどがきちんと運営されています。いずれ提供されるであろうRealtekのドライバ開発についても、先の投稿者は以下のように述べています。素晴らしい会社には素晴らしいユーザーが集まるものですね。\n\nありがとうございます。これこそが、私がPlugable社のアダプターを選んだ理由です。数年前にもPlugable社のデバイスを購入したことがあり、その時のサポートレベルの高さに感銘を受けました。Big Surに搭載されているASIXのネットワーク・チップセット・ドライバについて御社が行った非常に詳細な分析を読んで、Big Sur専用に推奨されているUSBC-E2500も十分にサポートされているだろうと思いました。これまでのところ、素晴らしい経験をしています。\n\n","categories":["Hardware","Network"]},{"title":"VMWare 無償版ESXiの提供終了について","url":"/new-technology/2024/01/30/EOS-Free-esxi/","content":"VMWare製品の買い切りモデルからサブスクリプションモデルへの移行VMWareのKBで以下のタイトルの文書が2024&#x2F;1&#x2F;22に公開されています。\n\nVMware End Of Availability of Perpetual Licensing and SaaS Services (96168) https://kb.vmware.com/s/article/96168?lang=en_US\n\n最終報については、「VMWare 無償版ESXiの提供終了について（最終報）」を参照してください。\n\n\nVMWareはスタンドアロン製品の提供を終了し、サブスクリプションモデルに変更されるとのこと。無償版ESXiは対象外ではという期待もありましたが、上記のKBを補足する形のブログとして以下が公開されています。\n\nVMware End Of Availability of Perpetual Licensing and SaaS Services (VMWare Blog) https://blogs.vmware.com/cloud-foundation/2024/01/22/vmware-end-of-availability-of-perpetual-licensing-and-saas-services/\n\nこのページではサブスクリプションへの移行可否を判断可能なプロダクト一覧があります。残念ながら、表の中の移行対象外プロダクトとして、「VMware vSphere Hypervisor (free edition)」の記載があります。\nそもそもの発表は2023年12月11日の発表に遡ります。\n\nVMware by Broadcom、製品ラインアップとライセンス モデルを大幅に簡素化 https://news.vmware.com/company/vmware-by-broadcom-business-transformation\n\n 正式にサブスクリプションモデルに移行する事が発表された後の製品の明確化という事ですが、ソフトウェアのダウンロード自体はいつ出来なくなっても不思議ではない状態となっています。一方、昨年末の発表でも改めて触れられていますが、すぐにサポート終了というわけではなく、あらかじめ定められたサポート期限（ジェネラルサポート期限）まではパッチなども提供されるとのことです。\n無償版ESXiのサポート期限無償版ESXiに関するサポート期限は以下の通りです。\n\n\nProduct Lifecycle Matrix https://lifecycle.vmware.com/#/?advancedFilter=checkbox_sup&amp;filters=%7B%22name%22:%22esxi%22,%22lifecycle_policy%22:null,%22text%22:null%7D\n\nまず見るべきはパッチ提供が行われるGeneral Supportの期限です。ESXi7は2025&#x2F;4&#x2F;2であり、あと1年と少しです。また、ESXi8については、2027&#x2F;10&#x2F;11と3年半の猶予があります。\nもちろん、今後それなりの費用を支払ってESXiを使う事も選択肢としては挙げられますが、ホームユーザーにとっては高額となるライセンス費用を払ってまでESXiに拘る方は少ないものと考えられます。\n現時点で考えられるアクションプランこのような状況からは以下のように考えられるでしょうか。\n\n新規にESXiをインストールしてみたいと考えているユーザー向け 残念ながら、無償での利用終了が覆る事は無いと考えられるため新規にホームユーザーがESXiを覚えようとする事は仕事で利用する等の理由がない限りお勧めできません。\n\n既にFree ESXiを運用しているユーザー向け\n\n代替ソフトウェアを速やかに探し、移行する\nESXi8のライフサイクルが長いプロダクトにアップグレードの上、当面は情報収集し、ESXiの運用を継続する\n\n\n\nなお、既にESXiを運用されている方であっても、何らかのトラブルでクリーンインストールが必要となる可能性は残ります。このため、以下のアクションは速やかに行っておくべきです。またアップグレードでもISOファイルは利用できます。\n\n無償版ESXi8のモジュール（ISOファイル）をダウンロードしておくこと\n無償版ESXi8のライセンスを取得しておくこと\n\n詳細は、「VMware ESXiを8.0にアップグレードする」、「ESXi8.0をRyzen5 5600Gで構築」の記事を参照してください。\n今後のアクションプランこれは各個人によって仮想環境の利用方法や考え方やが異なりますので、コメントは難しいところですがポイントになる点を列挙してみます。\n\n仮想環境のバックアップを主眼にする場合　私の場合はNASのソフトウェアでVMの定期バックアップを取得しており、仮想環境の一番のメリットと感じています。　NASによる仮想環境のバックアップはESXiおよびHyper-V Serverが対象です。　Hyper-V Server 2019も移行対象にはなりますが、既にメインストリームの終了を2024年1月に迎えており、短命と考えられます。\n\nMicrosoft Lifecycle https://learn.microsoft.com/ja-jp/lifecycle/products/hyperv-server-2019\n\n\n今後NASのソフトウェアや他のバックアップソリューションが別の仮想環境システムに対応してくればそれが選択の候補になり得ます。\nWindows Serverのライセンス購入も選択肢となりますが、やはり個人向けには高価で集約するコストメリットが無くなってしまいます。\nLinuxの全体バックアップをNASで確保しつつ、LinuxのKVMで個別の仮想マシンを管理するという方法も考えられます。\n\n\nその他の仮想環境への移行を主眼にする場合 仮想化ソフトウェアの信頼性を見極める必要があります。 リモートワークの一部に利用している製品であれば、信頼性（安全性、可用性）が必要ですから、仮想化ソフトウェアが期待に満たない場合はベアメタルに移行する事も必要でしょう。\n\nコンテナへの移行など別の技術を活用する場合 バージョンアップなどの移行が容易であればよりリソースが少なく済む可能性はあります。最新パッチの当たったイメージが開発ベンダーから提供されるならそれ以上言うことありません。セキュリティ製品などOS単位でのソフトウェアや、VLANや仮想ネットワークなど、ネットワークが主眼である場合は、他のソリューションも視野に入れることとなります。\n\n\n補足VMWareのコミュニティの中心的存在であるVMWareのWilliam氏（lamw）は、定期的なブログのポスト、Community(Flings)でのCommunity Driverなどの再整理など今年に入ってからも意欲的に活動されています。\n\nWiliam Lam氏のブログ https://williamlam.com/\n\n\nVMWare Community(Flings) https://communities.vmware.com/t5/Flings/ct-p/77\n\n私個人としては当面情報収集をし、急いで他のシステムに移行する事は考えていませんが、継続して代替策は検討していきたいと考えています。\n","tags":["ESXi"]},{"title":"VMWare 無償版ESXiの提供終了について（第2報）","url":"/new-technology/2024/02/14/EOS-Free-esxi2/","content":"\n\n\n\nVMWareからの告知2024-02-09ごろに、以下のKBが告知されました。\n\nEnd Of General Availability of the Free vSphere Hypervisor (ESXi 7.x and 8.x) (2107518) https://kb.vmware.com/s/article/2107518?lang=en_us\n\n\n要約： 無償版ESXiはVMWareのWebサイトではもはや利用できません。\n\n\n解決方法： 永久ライセンスから新しいサブスクリプション製品への移行の一環として、無償版ESXiは EOGA (End of General Availability) となりました。現時点では、同等の代替製品はありません。 \n\nつまり、無償版ESXiのインストールモジュールはすでにダウンロードできなくなりました。なお、パッチについては、VMWareのカスタマーコネクトにログインした上で、従来通り、製品パッチをダウンロードできます。2&#x2F;14 20時においてダウンロードできました。\n\n\n1月30日に書いた記事「VMWare 無償版ESXiの提供終了について」では、今後もESXiを新規利用またはアップグレードされる方はISOファイルのダウンロードとライセンスの取得をお勧めしていましたが、あまりに期間も短くお役に立てなかったかもしれません。\nこれにはもはや抗うことはできないようです。\nESXiの代替の検討既に稼働済みの無償版ESXiは定期的なオンライン認証などがあるわけではないので当面の間利用は継続できますが、有償のESXiを使うつもりでなければ、移行について検討しなければなりません。\nProxmox VE\n\nProxmoxはLinuxユーザー、個人を中心に人気のあるプロダクトです。大学や団体の利用実績もあります。ドイツの2名の開発者からスタートした企業です。ESXiは比較的ネットワークカードやNVMeの種類を選びましたから、手軽に始められる仮想環境としてはまずはProxmoxが挙げられます。\n\nProxmox Virtual Environment https://www.proxmox.com/en/proxmox-virtual-environment/overview\n\n\n\n上記は取り急ぎproxmoxをセットアップして動作させたブラウザ画面のキャプチャです。現時点では、Ubuntu22をセットアップした程度でほとんど検証ができていません。\nモニタ類も非常に見やすいです。\n\n\nProxmoxにはバックアップサーバーという製品もありますが、Proxmox VE単独でバックアップのスケジューリングができます。これは無償版ESXiと比べて良い点です。SynologyNASのNFS4.1に接続してバックアップしています。\n\n\n通知は下記のように行われます。\n\n\nバックアップ速度は4Gbps強です。差分のバックアップ（ブロック変更のみ）は無さそうですね。\n100: 2024-02-17 14:43:09 INFO: transferred 32.00 GiB in 63 seconds (520.2 MiB/s)100: 2024-02-17 14:43:10 INFO: archive file size: 10.06GB\n\nスナップショットもESXi同等にメモリの状態まで確保できます（ZFSファイルシステムで実行）。\n少し気になる点としては無償で利用するには開発用リポジトリを使うことになり、有償のリポジトリはより安全にテストされたものが利用できる仕組みです。GUIでもモジュールは更新できますが、更新の単位はapt updateと同様の感覚です。リモートワークなどに利用しているVMがあるのであればその点は留意する必要があります。\nまだ十分な検証ができていませんが、手軽にESXiからの移行を始めるにはProxmoxの環境で検証をスタートさせるのも良いかもしれません。Proxmox自体、セキュアブートでインストールでき、VMもセキュアブートの設定ができます。\n設定はややLinux寄りです。結局はLinuxのコマンドをGUIにうまく形を変えているとも言えます。ESXiで慣れていると少しギャップがあります。ESXiのVMWare Remote Consoleは素晴らしい製品でしたが、そこまでは行かずとも、別ウィンドウでVNCから暗号化通信でコンソールにアクセスするなど操作性はとても良く、先進的であると感じさせます。\n取り急ぎ、ProxmoxVE8.1のセットアップとVMの新規作成に関する記事を投稿しました。Proxmoxを試してみたい方は参考にしてみてください。\n\nProxmoxVEのインストール\nProxmoxVEのVM新規作成（Ubuntu24.04LTS）\n\nXCP-ng（XEN Orchestra）\n\n新しいプロダクトではありませんが、Citrixが提供しているXen Serverから派生したオープンソースシステムでVatesという会社が提供しています。2012年にフランスで設立されています。おそらく規模は小さい会社のように見えます。こちらは企業中心、またホームラボでも利用されています。仮想化という概念では素晴らしいものをXenから継承しており、本格的なHypervisorです。ProxmoxはHypervisorとも言えますが、VMが明確に独立しておらずDMAなどのメモリへのアクセスはかなり自由です。一方、XCP-NGは厳格にセパレートされておりセキュリティが高く、安定度も高い物と考えられます。その犠牲になるのは速度ですが、XEN Orchestraという有償のGUI管理ツールはわかりやすいため、ESXiユーザーはこちらの方が気にいるかもしれません。\n\nXCP-ng https://xcp-ng.org/#easy-to-install\n\nXen OrchestraのGUIツールは有償ですが、個人が使うためのソースコードが提供されており、自身でコンパイルして利用する分には無償です。有償のプロダクトはXOA（Xen Orchestra Apliance）、ソースコードからビルドしたものはXOと呼ばれ区別されています。\n\n\nProxmoxと比べると少しグラフィカルな面は見劣りするでしょうか。\n\n\nネットワークなどは簡単にVLANを作成できて一覧として確認できるので管理しやすく思えます。\n\n\nこれはMellanox Connect X-3の１つのPort（ネイティブVLAN&#x3D;1）にさらに仮想のVLAN110を加えています。\nこちらもバックアップはスケジューリングできます。ESXiのようにバックアップもブロック単位の差分で取得できます。バックアップのメール通知は以下のような形で行われます。\n\n\nVMはブラウザから操作することになりますが、メニューの大きさも相まって、少し使いづらいと感じます。クライアントのVNCからXenOrchestraにSSHしてPort Forwardingすることによって暗号化した上で単独のVNCクライアントから操作できるようですが、こちらはまだ未確認です。\n\n\nXCP-NG本体は特に難しいところもなくインストールができます。8.2.1はまだセキュアブートのセットアップはできません。VM自体はセキュアブートの設定ができます。また、Xen Orchestraの管理ツール自体は別ノードからアクセスする方が好ましく、最初からノード単位のフェールオーバーなどを考えて作られています。現在私のセットアップではXen OrchestraをESXiで、昔使っていたintelのPCにXCP-NGをセットアップしています。\nXCP-NGの最新バージョンは現在8.2.1ですが、Ryzen環境で動作させると応答速度やネットワーク速度が遅く、Communityの情報を見ながら、古いintel core i7マシン（Intel(R) Core(TM) i7-8700 CPU @ 3.20GHz）に再インストールするなど、少し回り道してしまいました。8.3はまだベータ版ですが、そこではRyzen版の速度改善が見込めるようなのでこちらはまた少し時間を置いてから検証を開始するつもりです。なお、P-Core&#x2F;E-CoreのCPUは仮想環境でどのようにCPUが使われるのか読めないと考えられ、難しさを感じています。\nXCP-NGはスナップショットやバックアップが少し古い時代を感じさせるところがあります。稼働中のVMをバックアップした後にレストアすると、OSをブートするところから始まります。つまり、メモリの内容が廃棄されてしまいます。オープンしていたファイルがどうなるのか、恐らくロールバックされるとは思いますが、検証をしっかりと行いたい箇所ではあります。\nXO自体のリポジトリはGitHubにあり、かなり細かい単位でMasterブランチ（メインのソースコードの配置場所）がCommitされていきます。どこかでそれらの更新部分を取り込むには改めてXOのソースコードのコンパイルから必要になります。但し、これは簡単なスクリプトで手間をかけずに対処可能です。\n私がXCP-NGに期待しているのはシステムの安定度です。ESXiも本当に安定していて、これまでハードウェアの故障以外でハングしたりすることは全くありませんでした。また、Xen Orchestraは、企業で数十台の仮想サーバを管理することを想定して作られており、管理のしやすさを感じます。\nProxmox、XCP-NGともに良いプロダクトのようで、最終的にはどちらかの仮想環境をメインに使い、2台構成でライブマイグレーション（仮想マシンのノード間の移動）まで実現できればと考えています。\n海外のホームラボのパワーユーザーはどちらかといえば、XCP-NGを好むようにも見えます。これは簡単なProxmoxは面白くないということなのかもしれません。ESXiの代替としてはXCP-NGが今脚光を浴びているように見えます。\nXCP-NG、Xen Orchestraへの理解を深めるには、ローレンスシステムズのTom氏が解説しているYouTubeビデオがわかりやすいと思います。\n\nUnderstanding How The XCP-NG &amp; Xen Orchestra Open Source Virtualization Platform Works https://www.youtube.com/watch?v=CEUFHudLO1g&amp;t=447s\n\n今後、Xen Orchestraのセットアップ手順などを整理していきたいと考えています。手持ちの予備マシンをProxmoxで使ってしまったのでマシン調達から始めますのでしばらく時間がかかりそうです。\n","tags":["ESXi"]},{"title":"VMWare 無償版ESXiの提供終了について（最終報）","url":"/new-technology/2024/03/04/EOS-Free-esxi3/","content":"VMWareからの告知2024-02-09ごろに、以下のKBが告知され、無償版ESXiは新たにインストールが不可能となりました。但し、パッチなどは継続的に提供されることが判明しましたので、その内容を持って最終報とさせていただきます。\n\nEnd Of General Availability of the Free vSphere Hypervisor (ESXi 7.x and 8.x) (2107518) https://kb.vmware.com/s/article/2107518?lang=en_us\n\n\n要約： 無償版ESXiはVMWareのWebサイトではもはや利用できません。\n\n\n解決方法： 永久ライセンスから新しいサブスクリプション製品への移行の一環として、無償版ESXiは EOGA (End of General Availability) となりました。現時点では、同等の代替製品はありません。 \n\n\n\n無償版ESXiのインストールモジュールはすでにダウンロードできなくなりました。\n1月30日に書いた記事「VMWare 無償版ESXiの提供終了について」では、今後もESXiを新規利用またはアップグレードされる方はISOファイルのダウンロードとライセンスの取得をお勧めしていましたが、あまりに期間も短くお役に立てなかったかもしれません。\nパッチについては、2024-03-01にESXi 8.0 Update 2bが発表されましたので、無償版ESXiでも当面パッチは提供されることが分かりました。少しホッとしたと同時に、早速、パッチ情報の記事についてアップデートしましたので、ESXi8をお使いの方はパッチの適用を検討ください。\n「VMware ESXiにパッチを適用する」\nESXiの代替の検討（ここから先は第2報とほぼ同じ内容です）\n当面はESXiを継続利用できますが、既にISOファイルはダウンロードできませんし、無償ライセンスの新規取得も不可能です。有償のESXiを使うつもりでなければ、代替を検討する必要があります。\nProxmox VE\n\nProxmoxはLinuxユーザー、個人を中心に人気のあるプロダクトです。大学や団体の利用実績もあります。ドイツの2名の開発者からスタートした企業です。ESXiは比較的ネットワークカードやNVMeの種類を選びましたから、手軽に始められる仮想環境としてはまずはProxmoxが挙げられます。\n\nProxmox Virtual Environment https://www.proxmox.com/en/proxmox-virtual-environment/overview\n\n\n\n上記は取り急ぎproxmoxをセットアップして動作させたブラウザ画面のキャプチャです。現時点では、Ubuntu22をセットアップした程度でほとんど検証ができていません。\nモニタ類も非常に見やすいです。\n\n\nProxmoxにはバックアップサーバーという製品もありますが、Proxmox VE単独でバックアップのスケジューリングができます。これは無償版ESXiと比べて良い点です。SynologyNASのNFS4.1に接続してバックアップしています。\n\n\n通知は下記のように行われます。\n\n\nバックアップ速度は4Gbps強です。差分のバックアップ（ブロック変更のみ）は無さそうですね。\n100: 2024-02-17 14:43:09 INFO: transferred 32.00 GiB in 63 seconds (520.2 MiB/s)100: 2024-02-17 14:43:10 INFO: archive file size: 10.06GB\n\nスナップショットもESXi同等にメモリの状態まで確保できます（ZFSファイルシステムで実行）。\n少し気になる点としては無償で利用するには開発用リポジトリを使うことになり、有償のリポジトリはより安全にテストされたものが利用できる仕組みです。GUIでもモジュールは更新できますが、更新の単位はapt updateと同様の感覚です。リモートワークなどに利用しているVMがあるのであればその点は留意する必要があります。\nまだ十分な検証ができていませんが、手軽にESXiからの移行を始めるにはProxmoxの環境で検証をスタートさせるのも良いかもしれません。Proxmox自体、セキュアブートでインストールでき、VMもセキュアブートの設定ができます。\n設定はややLinux寄りです。結局はLinuxのコマンドをGUIにうまく形を変えているとも言えます。ESXiで慣れていると少しギャップがあります。ESXiのVMWare Remote Consoleは素晴らしい製品でしたが、そこまでは行かずとも、別ウィンドウでVNCから暗号化通信でコンソールにアクセスするなど操作性はとても良く、先進的であると感じさせます。\n取り急ぎ、ProxmoxVE8.1のセットアップとVMの新規作成に関する記事を投稿しています。Proxmoxを試してみたい方は参考にしてみてください。\n\nProxmoxVEのインストール\nProxmoxVEのVM新規作成（Ubuntu24.04LTS）\n\nXCP-ng（XEN Orchestra）\n\n新しいプロダクトではありませんが、Citrixが提供しているXen Serverから派生したオープンソースシステムでVatesという会社が提供しています。2012年にフランスで設立されています。おそらく規模は小さい会社のように見えます。こちらは企業中心、またホームラボでも利用されています。仮想化という概念では素晴らしいものをXenから継承しており、本格的なHypervisorです。ProxmoxはHypervisorとも言えますが、VMが明確に独立しておらずDMAなどのメモリへのアクセスはかなり自由です。一方、XCP-NGは厳格にセパレートされておりセキュリティが高く、安定度も高い物と考えられます。その犠牲になるのは速度ですが、XEN Orchestraという有償のGUI管理ツールはわかりやすいため、ESXiユーザーはこちらの方が気にいるかもしれません。\n\nXCP-ng https://xcp-ng.org/#easy-to-install\n\nXen OrchestraのGUIツールは有償ですが、個人が使うためのソースコードが提供されており、自身でコンパイルして利用する分には無償です。有償のプロダクトはXOA（Xen Orchestra Apliance）、ソースコードからビルドしたものはXOと呼ばれ区別されています。\n\n\nProxmoxと比べると少しグラフィカルな面は見劣りするでしょうか。\n\n\nネットワークなどは簡単にVLANを作成できて一覧として確認できるので管理しやすく思えます。\n\n\nこれはMellanox Connect X-3の１つのPort（ネイティブVLAN&#x3D;1）にさらに仮想のVLAN110を加えています。\nこちらもバックアップはスケジューリングできます。ESXiのようにバックアップもブロック単位の差分で取得できます。バックアップのメール通知は以下のような形で行われます。\n\n\nVMはブラウザから操作することになりますが、メニューの大きさも相まって、少し使いづらいと感じます。クライアントのVNCからXenOrchestraにSSHしてPort Forwardingすることによって暗号化した上で単独のVNCクライアントから操作できるようですが、こちらはまだ未確認です。\n\n\nXCP-ng本体は特に難しいところもなくインストールができます。8.2.1はまだセキュアブートのセットアップはできません。VM自体はセキュアブートの設定ができます。また、Xen Orchestraの管理ツール自体は別ノードからアクセスする方が好ましく、最初からノード単位のフェールオーバーなどを考えて作られています。現在私のセットアップではXen OrchestraをESXiで、昔使っていたintelのPCにXCP-NGをセットアップしています。\nXCP-ngの最新バージョンは現在8.2.1ですが、Ryzen環境で動作させると応答速度やネットワーク速度が遅く、Communityの情報を見ながら、古いintel core i7マシン（Intel(R) Core(TM) i7-8700 CPU @ 3.20GHz）に再インストールするなど、少し回り道してしまいました。8.3はまだベータ版ですが、そこではRyzen版の速度改善が見込めるようなのでこちらはまた少し時間を置いてから検証を開始するつもりです。なお、P-Core&#x2F;E-CoreのCPUは仮想環境でどのようにCPUが使われるのか読めないと考えられ、難しさを感じています。\nXCP-NGはスナップショットやバックアップが少し古い時代を感じさせるところがあります。稼働中のVMをバックアップした後にレストアすると、OSをブートするところから始まります。つまり、メモリの内容が廃棄されてしまいます。オープンしていたファイルがどうなるのか、恐らくロールバックされるとは思いますが、検証をしっかりと行いたい箇所ではあります。\nXO自体のリポジトリはGitHubにあり、かなり細かい単位でMasterブランチ（メインのソースコードの配置場所）がCommitされていきます。どこかでそれらの更新部分を取り込むには改めてXOのソースコードのコンパイルから必要になります。但し、これは簡単なスクリプトで手間をかけずに対処可能です。\n私がXCP-ngに期待しているのはシステムの安定度です。ESXiも本当に安定していて、これまでハードウェアの故障以外でハングしたりすることは全くありませんでした。また、Xen Orchestraは、企業で数十台の仮想サーバを管理することを想定して作られており、管理のしやすさを感じます。\nProxmox、XCP-ngともに良いプロダクトのようで、最終的にはどちらかの仮想環境をメインに使い、2台構成でライブマイグレーション（仮想マシンのノード間の移動）まで実現できればと考えています。\n海外のホームラボのパワーユーザーはどちらかといえば、XCP-ngを好むようにも見えます。これは簡単なProxmoxは面白くないということなのかもしれません。ESXiの代替としてはXCP-ngが今脚光を浴びているように見えます。\nXCP-ng、Xen Orchestraへの理解を深めるには、ローレンスシステムズのTom氏が解説しているYouTubeビデオがわかりやすいと思います。\n\nUnderstanding How The XCP-NG &amp; Xen Orchestra Open Source Virtualization Platform Works https://www.youtube.com/watch?v=CEUFHudLO1g&amp;t=447s\n\nXCP-ngに興味のある方はこちらの記事をご覧ください。\n\nXCP-ngとXen Orchestra\nXCP-ngのVM新規作成\n\n","tags":["ESXi"]},{"title":"VMware ESXi8 Update3dのパッチを適用する","url":"/new-technology/2025/03/08/ESXi8-Patch/","content":"\nこの記事で実現すること\n\n無償版ESXi（VMware vSphere Hypervisor）について、VMWareのサイトから製品パッチをESXi本体から直接ダウンロードし、ESXi上でパッチを適用します。この記事ではESXi8.0を対象にしていますが、コマンド自体はESXi7.0も変わりません。従来は、BroadcomからパッチをダウンロードしESXiに適用する方法でしたが、ESXi8 Update3dから、少し対応しづらくなってきたので別の方法を紹介します。\n\n\nBroadcomのパッチのダウンロードについて2025-03-08の時点でESXi8.0は　Update3dのパッチが提供されています。しかしながら、私のBroadcomアカウントが個人のgmailで登録していたためか、Broadcomのサイトからパッチがダウンロードできなくなっています。個人のProfileを構成しなくてはなりませんが、「non-corporate email domain」はProfileが構成できないとのことです。無償ユーザーは少しづつ制約が加えられてきていることをひしひしと感じます。昨年末まではパッチをダウンロードできていましたが、現時点ではこれまで紹介してきた方法では実施できなくなっています。とはいえ、このブログは個人のためのものであり、自分が勤めている会社のメールを登録するつもりは全くありませんし、他の方法を模索しなくてはなりません。\n今回のパッチ適用方法についてのご注意事項今回はパッチ適用にあたり、暫定方式（一部メーカーが明確に推奨していない方法を含む）を紹介していますので、リスクをご理解の上で利用されているESXiへのパッチ適用をおすすめします。\n\n\nESXi8 Update3dこのリリースは、CVE-2025-22224、CVE-2025-22225、CVE-2025-22226の脆弱性に対応したものです。\n\n\n\n脆弱性ID\n対象製品\n概要\n深刻度 (CVSSv3.1)\n既知の悪用\n\n\n\nCVE-2025-22224\nVMware ESXi、Workstation\nTOCTOU（Time-of-Check Time-of-Use）レースコンディションにより、ヒープオーバーフローが発生し、境界外書き込みが可能となる脆弱性。これにより、ローカルの管理者権限を持つ攻撃者が、ホスト上でVMXプロセスとしてコードを実行できる可能性があります。\n9.3 (Critical)\n確認されています。\n\n\nCVE-2025-22225\nVMware ESXi\nVMXプロセス内で権限を持つ攻撃者が、任意のカーネル書き込みをトリガーし、サンドボックスを回避する可能性がある脆弱性。\n8.2 (Important)\n確認されています。\n\n\nCVE-2025-22226\nVMware ESXi、Workstation、Fusion\nHGFSにおける境界外読み取りにより、情報漏洩が発生する脆弱性。仮想マシン上でローカルの管理者権限を持つ攻撃者が、VMXプロセスのメモリ内容を取得する可能性があります。\n7.1 (Important)\n確認されています。\n\n\nこれは、すでに仮想マシンのゲストOSを侵害し、特権アクセス（管理者またはルート）を取得した攻撃者がハイパーバイザー自体に移動できる状況です。詳細は以下の「脆弱性に関する追加情報」を参照してください。すでに悪用が確認されていること、過去の脆弱性から鑑みても今回はかなりインパクトのある脆弱性と考えられます。\n\n脆弱性に関する追加情報（GitHub） https://github.com/vmware/vcf-security-and-compliance-guidelines/tree/main/security-advisories/vmsa-2025-0004 \n\n\nパッチ情報（Broadcom）https://techdocs.broadcom.com/us/en/vmware-cis/vsphere/vsphere/8-0/release-notes/esxi-update-and-patch-release-notes/vsphere-esxi-80u3d-release-notes.html\n\nパッチの内容について前述したパッチ情報によれば、今回のProfileは以下の2つです。\n\nESXi-8.0U3d-24585383-standard\nESXi-8.0U3d-24585383-no-tools\n\nいつものようにシンプルなパッチのプロファイルであり、通常はVMware Tools込みのものを適用します。現在稼働しているESXiのバージョンについては、ESXiにSSHし、以下のコマンドで確認できます（任意）。\n[root@localhost:~] esxcli software profile get(Updated) ESXi-8.0U3c-24414501-standard\n\nESXi上でSSH Serverを起動するには以下で行います。 ESXiの左ペインのホストー管理から、”サービス”のタブをクリックし、”TSM-SSH”を選択し”起動”ボタンをクリックし、SSHを有効にします。 \nこれまではオフラインバンドル、つまりESXiはセキュリティのために最小限のアクセスに留めるべく、インターネットに接続するのは最低限度（NTPのみ）という構成を前提としていました。一旦Broadcomからパッチをダウンロードし、それをESXiにアップロード、パッチ適用という流れです。しかし、現時点ではこれまでの方法が取れません。ESXi本体にSSHし、ESXiのコマンドにて直接VMwareサイト（実際はBroadcom）からのパッチの確認、ダウンロードします。このために少しハックが必要です。\nESXCLIコマンドの修正（ハック）注意点は2点あります。\n\nパッチを適用するためのProfileは、&lt;hostupdate.vmware.com&gt;にあります。これはDNSでLookupすると、IPv4とIPv6のホストが存在します。\nVMware改め、Broadcomの社員である有名なWilliam LAM氏のブログによれば、ESXi8でESXCLIコマンドでメモリエラーが出るケースに遭遇するとのこと。それらの対策のためにいくつかのコマンドをESXi本体にSSHして実行する必要があります。\n\nhostupdate.vmware.comESXi8にSSHしてからnslookupしてみると以下の通りです。IPアドレスは伏せてあります。\n[root@localhost:~] nslookup hostupdate.vmware.comServer:\t\t192.168.x.xAddress:\t192.168.x.x:53Non-authoritative answer:hostupdate.vmware.com\tcanonical name = hostupdate.broadcom.comhostupdate.broadcom.com\tcanonical name = hostupdate.broadcom.com.cdn.cloudflare.netName:\thostupdate.broadcom.com.cdn.cloudflare.netAddress: 2606:xxxx:xxxx::xxxxName:\thostupdate.broadcom.com.cdn.cloudflare.netAddress: 2a06:xxxx:xxxx::xxxxNon-authoritative answer:hostupdate.vmware.com\tcanonical name = hostupdate.broadcom.comhostupdate.broadcom.com\tcanonical name = hostupdate.broadcom.com.cdn.cloudflare.netName:\thostupdate.broadcom.com.cdn.cloudflare.netAddress: x.x.x.xName:\thostupdate.broadcom.com.cdn.cloudflare.netAddress: x.x.x.x\n\nこれまで直接パッチのProfileを確認したり、ダウンロードするには、hostupdate.vmware.comを使っていましたが、今後もそのまま使えるようではあります。ただ、どうもホストのどれかには情報が乗っていないサーバーがあるのか、Got no data from process.という結果が返ったりします。私はこれまでESXiではIPv4のみ利用していましたが、X（Twitter）でIPv6でしか情報が取れないなどのポストがあったので改めてESXiにIPv6を設定して実行しています。\nもし、IPv6が必要そうなのであれば、これはESXiのWebコンソールの左ペインネットワークから、ESXiのマネジメントインタフェース、おそらくvSwitch0のVMKernelであるvmk0が対象と思われますが、ご自身のマネジメントネットワークを選択の上、設定を編集し、IPv6を有効にしてください。 \nESXCLIコマンドのパッチWilliam氏のブログでは以下のコマンドパッチを適用することでコマンドエラーが無くなるとのことです。まずはESXiにSSHした上で以下の５つのコマンドパッチを投入してください。なお、新しいESXiパッチを適用すると今回のコマンドパッチはリセットされますので改めて設定が必要です。\n[root@localhost:~] esxcli system settings advanced set -o /VisorFS/VisorFSPristineTardisk -i 0[root@localhost:~] cp /usr/lib/vmware/esxcli-software /usr/lib/vmware/esxcli-software.bak[root@localhost:~] sed -i &#x27;s/mem=300/mem=500/g&#x27; /usr/lib/vmware/esxcli-software.bak[root@localhost:~] mv /usr/lib/vmware/esxcli-software.bak /usr/lib/vmware/esxcli-software -f[root@localhost:~] esxcli system settings advanced set -o /VisorFS/VisorFSPristineTardisk -i 1\n\n\nWilliam Lam氏の該当記事 https://williamlam.com/2024/03/quick-tip-using-esxcli-to-upgrade-esxi-8-x-throws-memoryerror-or-got-no-data-from-process.html\n\nパッチ情報の確認最初にESXiからhttpクライアントをFirewallで通すため、ESXiにSSHしたあと、以下のコマンドを投入します。\nesxcli network firewall ruleset set -e true -r httpClient\n\nすでにリリースノートで、パッチのProfileはESXi-8.0U3d-24585383-standardと判明していますが、SSHから確認してみます（任意）。数分、時間がかかります。\n[root@localhost:~] esxcli software sources profile list -d https://hostupdate.vmware.com/software/VUM/PRODUCTION/main/vmw-depot-index.xml | grep ESXi-8.0U3dESXi-8.0U3d-24585383-no-tools     VMware, Inc.  PartnerSupported  2025-03-04T00:00:00  2025-03-04T00:00:00ESXi-8.0U3d-24585383-standard     VMware, Inc.  PartnerSupported  2025-03-04T00:00:00  2025-03-04T00:00:00\n\n情報に相違はないことが確認できました。\nパッチ適用の事前準備\n仮想マシンを全てシャットダウンします\nESXiをメンテナンスモードに切り替えます\n\n \n\nさて、最後にパッチ適用のコマンドを投入しますが、前述したWilliam氏のブログでのコメントも認識しておいてください。いつまでこの方法が通用するかはわかりません。\n\nこれがあなたのホームラボであり、私のようなESXiホストが1つしかない場合、オンラインのVMwareパッチリポジトリを引き続き使用できるようにする回避策を見つけることができましたが、これは間違いなく公式にはサポートされていません。\n\n\n\n\nSSHから以下のコマンドを投入します。\n\n esxcli software profile update -p ESXi-8.0U3d-24585383-standard -d https://hostupdate.vmware.com/software/VUM/PRODUCTION/main/vmw-depot-index.xml\n\n実行後しばらくしてから、結果が表示されます。\n\n Update Result  Message: The update completed successfully, but the system needs to be rebooted for the changes to be effective.  ...  Reboot Required: true\n\n再びESXiのFirewallでhttpsアクセスを閉じます。　esxcli network firewall ruleset set -e false -r httpClient\n\nrebootとし、ESXiを再起動します。\n\n\n再起動完了後、ESXiにログインします。左ペインメニューの”ホスト”をクリックし、バージョンの表記に今回パッチを当てたビルド番号が表示されている事を確認してください。今回はU3dとなっているはずです。\n\n\nまたは、sshでESXiに接続し、vmware -vを実行し確認します。\n [root@localhost:~] vmware -vVMware ESXi 8.0.3 build-24585383\n事後作業これまで実施してきたメンテナンス準備とは反対の作業をします。メンテナンスモードの終了・SSHの無効化・仮想マシンの起動と続けます。\n","categories":["Software"],"tags":["ESXi"]},{"title":"VMware ESXi8 Update3eのパッチを適用する","url":"/new-technology/2025/04/12/ESXi8U3e-Patch/","content":"\nこの記事で実現すること\n\n無償版ESXi（VMware vSphere Hypervisor）について、2025-4-10にESXi8 Update3eが発表されています。今回、Broadcomサポートサイトからisoファイルをダウンロードできるようになっています。また、ESXi8 Update3dの時と同様にVMWareのサイトから製品パッチをESXi本体から直接ダウンロードし、ESXi上でパッチを適用する方法も（推奨されませんが）存在します。従来は、BroadcomからパッチのZIPファイルをダウンロードしESXiに適用する方法でしたが、ESXi8 Update3eではISOによるファイルのダウンロードおよび、（非推奨の）コマンドからのUpdateについて説明します。\n\n\nBroadcomのパッチのダウンロードについて2025-04-12の時点でESXi8.0は　Update3eのパッチが提供されています。但しこれはISOファイルであって、従来コマンドでパッチを適用していたZIPファイルではありません。おそらくユーザーのESXiはヘッドレス環境（モニタがない）で運用されているでしょうから、USBメモリにISOを書き込みブートしてから画面操作というのはなかなか面倒でしょう。しかし、正式にBroadcomからESXiの最新版のISOファイルが再び提供されるようになったのは喜ばしいことです。\nISOファイルのダウンロード手順は下記の通りです。\n\nBroadcomサポートポータルに接続し、ログインします。　https://support.broadcom.com/\n以下でVMwareのメニューを選択します。\n\n \n\n左ペインのMy Downloadsをクリックすると、Free Software Downloads available HEREと表示されますのでリンクをクリックします。\n\n \n\nFreeDownloadsの画面からSearch Product Nameの入力ボックスに”vSphere”と入力します。\n\n \n\n以下のようにvSphereの項目が表示されますのでさらにクリックします。\n\n \n\nvSphereからさらに次のページのLinkをクリックします。\n\n \n\n“8.0U3e”のリンクが表示されますのでさらにLinkをクリックします。\n\n \n\n以下のダウンロードリンクをクリックします。Agreementと共に個人情報を入力する画面が出る場合があります。\n\n \n\nISOファイルがダウンロードできたら、USBメモリに焼いてESXiのマシンにおいてUSBブート、アップグレード（実際にはアップデート）を実施します。ESXiに対するISOを使ったアップグレードの手順については、以下のESXiセットアップ動画を参考にしてください。特に難しいものはありません。途中、新規インストールかアップグレードかを選択する箇所があります。この動画では新規インストールを選択していますが、アップグレードを選んでください。https://www.youtube.com/watch?v=eiZn54GPfzI\nBroadcomのサイトから直接のダウンロード（非推奨）今回のパッチ適用方法についてのご注意事項今回はパッチ適用にあたり、暫定方式（一部メーカーが明確に推奨していない方法を含む）を紹介していますので、リスクをご理解の上で利用されているESXiへのパッチ適用をおすすめします。\n\n\nESXi8 Update3eこのリリースでは、新たに発見された脆弱性（CVE）はありませんが、未然防止としてのセキュリティパッチと不具合修正が含まれています。CVEは発行されていないといっても、重要度についてはCriticalとなっていますので、迅速なパッチ適用が求められます。\n\nパッチ情報（Broadcom）https://techdocs.broadcom.com/us/en/vmware-cis/vsphere/vsphere/8-0/release-notes/esxi-update-and-patch-release-notes/vsphere-esxi-80u3e-release-notes.html\n\nパッチの内容について前述したパッチ情報によれば、今回のProfileは以下の4つです。Image Profile NameESXi-8.0U3e-24674464-standardESXi-8.0U3e-24674464-no-toolsESXi-8.0U3se-24659227-standardESXi-8.0U3se-24659227-no-toolsここではセキュリティパッチ＋バグに対応したもの、かつ、VMware Tools込みのものを適用します（ESXi-8.0U3e-24674464-standard）。\n現在稼働しているESXiのバージョンについては、ESXiにSSHし、以下のコマンドで確認できます（任意）。\n[root@localhost:~] esxcli software profile get(Updated) ESXi-8.0U3d-24585383-standard\n\nESXi上でSSH Serverを起動するには以下で行います。 ESXiの左ペインのホストー管理から、”サービス”のタブをクリックし、”TSM-SSH”を選択し”起動”ボタンをクリックし、SSHを有効にします。 \nこれまではオフラインバンドル、つまりESXiはセキュリティのために最小限のアクセスに留めるべく、インターネットに接続するのは最低限度（NTPのみ）という構成を前提としていました。一旦Broadcomからパッチをダウンロードし、それをESXiにアップロード、パッチ適用という流れです。しかし、現時点ではこれまでの方法が取れません。ESXi本体にSSHし、ESXiのコマンドにて直接VMwareサイト（実際はBroadcom）からのパッチの確認、ダウンロードします。このために少しハックが必要です。\nESXCLIコマンドの修正（ハック）William氏のブログでは以下のコマンドパッチを適用することでコマンドエラーが無くなるとのことです。まずはESXiにSSHした上で以下の５つのコマンドパッチを投入してください。なお、再起動などで今回のコマンドパッチはリセットされますので改めて設定が必要です。\n[root@localhost:~] esxcli system settings advanced set -o /VisorFS/VisorFSPristineTardisk -i 0[root@localhost:~] cp /usr/lib/vmware/esxcli-software /usr/lib/vmware/esxcli-software.bak[root@localhost:~] sed -i &#x27;s/mem=300/mem=500/g&#x27; /usr/lib/vmware/esxcli-software.bak[root@localhost:~] mv /usr/lib/vmware/esxcli-software.bak /usr/lib/vmware/esxcli-software -f[root@localhost:~] esxcli system settings advanced set -o /VisorFS/VisorFSPristineTardisk -i 1\n\n\nWilliam Lam氏の該当記事 https://williamlam.com/2024/03/quick-tip-using-esxcli-to-upgrade-esxi-8-x-throws-memoryerror-or-got-no-data-from-process.html\n\nパッチ情報の確認最初にESXiからhttpクライアントをFirewallで通すため、ESXiにSSHしたあと、以下のコマンドを投入します。\nesxcli network firewall ruleset set -e true -r httpClient\n\nすでにリリースノートで、パッチのProfileはESXi-8.0U3e-24674464-standardと判明していますが、SSHから確認してみます（任意）。\n[root@localhost:~] esxcli software sources profile list -d https://hostupdate.vmware.com/software/VUM/PRODUCTION/main/vmw-depot-index.xml | grep ESXi-8.0U3e\n数分、時間がかかる場合があります。\nESXi-8.0U3e-24674464-no-tools     VMware, Inc.  PartnerSupported  2025-04-10T00:00:00  2025-04-10T00:00:00ESXi-8.0U3e-24674464-standard     VMware, Inc.  PartnerSupported  2025-04-10T00:00:00  2025-04-10T00:00:00\n\n情報に相違はないことが確認できました。セキュリティパッチのみの方は、Profile名が”ESXi-8.0U3se”なのでgrepの結果抽出されていません。\nパッチ適用の事前準備\n仮想マシンを全てシャットダウンします\nESXiをメンテナンスモードに切り替えます\n\n \n\nさて、最後にパッチ適用のコマンドを投入しますが、前述したWilliam氏のブログでのコメントも認識しておいてください。いつまでこの方法が通用するかはわかりません。\n\nこれがあなたのホームラボであり、私のようなESXiホストが1つしかない場合、オンラインのVMwareパッチリポジトリを引き続き使用できるようにする回避策を見つけることができましたが、これは間違いなく公式にはサポートされていません。\n\n\n\n\nSSHから以下のコマンドを投入します。\n\n esxcli software profile update -p ESXi-8.0U3e-24674464-standard -d https://hostupdate.vmware.com/software/VUM/PRODUCTION/main/vmw-depot-index.xml\n\n実行後しばらくしてから、結果が表示されます。\n\n Update Result  Message: The update completed successfully, but the system needs to be rebooted for the changes to be effective.  ...  Reboot Required: true\n\n再びESXiのFirewallでhttpsアクセスを閉じます。　esxcli network firewall ruleset set -e false -r httpClient\n\nrebootとし、ESXiを再起動します。\n\n\n再起動完了後、ESXiにログインします。左ペインメニューの”ホスト”をクリックし、バージョンの表記に今回パッチを当てたビルド番号が表示されている事を確認してください。今回はU3eとなっているはずです。\n\n\nまたは、sshでESXiに接続し、vmware -vを実行し確認します。\n [root@localhost:~] vmware -vVMware ESXi 8.0.3 build-24674464\n事後作業これまで実施してきたメンテナンス準備とは反対の作業をします。メンテナンスモードの終了・SSHの無効化・仮想マシンの起動と続けます。\n","categories":["Software"],"tags":["ESXi"]},{"title":"Sophos Firewall のインストール（事前準備）","url":"/new-technology/2020/03/06/InstallXG/","content":"この記事で実現すること\nSophos FirewallをESXiで稼働させるためのインストールイメージ（isoファイル）をダウンロードし、ESXi上で、Sophos Firewallのための仮想マシンを構築できるようになります。\n\n\nSophos FirewallのダウンロードSophosのサイトより、”Sophos Firewall Home Edition”モジュールをダウンロードします。\nhttps://www.sophos.com/ja-jp/products/free-tools.aspx\n\n\nSophos無償ツール(https://www.sophos.com/ja-jp/products/free-tools.aspx)お客様がご家庭でも常に安全に PCを利用できるようソフォスでは無償ツールを提供しています。\n\n\n\n\nSophos Firewallは、V18まではXG Firewallと呼ばれていました。v18.5よりSophos Firewallに名前が変更になっています。\nダウンロードサイトでは氏名、勤務先メールアドレスとありますが、ホームユースなので、遠慮なくGmailなどのアドレスを登録します。あっさりとISOファイルのダウンロードボタンが表示されると共に、メール宛にライセンス番号が送られてきます。利用条件としては、あくまで家庭での個人的な使用に限って無料です。ダウンロードはISOイメージです。2023年2月23日時点では、最新のバージョンはv19であり、”SW-19.0.1_MR-1-365.iso”となっています。\nクライアントPC（Windowsなど）から、ESXi管理画面にログインします。ESXiの管理画面の左ペインのストレージからデフォルトのストレージである、datastore1を選択し、データストアブラウザをクリックして下さい。次にアップロードボタンをクリックし、ダウンロードされた”SW-18.5.2_MR-2-380.iso”ファイルをアップロードして下さい。\n\n\n仮想マシンの作成ここから仮想マシンの初期設定です。\n\nESXiの管理画面の仮想マシンから新規仮想マシンを選択します。\n仮想マシンの作成を選択し、次へのボタンを押します。\n仮想マシンの名前を決め、ゲストOSを選択します。OSファミリはLinuxで、OSバージョンはその他のLinux4.x（64ビット）を選択します。\n\n\n\n\nストレージを確認し、次へのボタンを押します。\n\n\n\n\nここでは、ネットワークカードの追加をし、WAN側のNICを追加します。ネットワークアダプタの詳細（▶︎マークをクリック）でドライバがE1000など選択されている事を確認して下さい。\n\n\n\n\nまた、仮想CD-ROMにFirewallのインストールイメージ（isoファイル）をマウントします。\n\n\n\n\n起動オプションのファームウェアはEFIからBIOSに変更して下さい。\n\n\n\n\nさて、最終確認です。今回のプロビジョニングはシック（Lazy Zeroed）となっています。\n\n\n\n\n最後に完了ボタンを押します。これで仮想マシンが作成されます。\n\n\n\nいったんここまでで仮想マシンの作成は終了となります。なお、仮想マシンを選択した状態で「アクション」という歯車マークがあります。これをクリックして、コンソール→VMRCのダウンロードを選択し、”VMware Remote Console”をインストールして下さい。これがあるとブラウザから仮想マシンの画面がポップアップし、仮想マシンを操作出来るようになります。もし物理マシンに直接USBメモリ等でXGをインストールする場合は、対象マシンのBIOS設定でUEFIのチェックを外して下さい。\n(2023-2-23追記）現時点でダウンロードされるモジュールは、Sophos Firewall v19.0がベースとなります。このブログではv18からの記事を掲載しております。\nファイアウォールとしては、UEFIによるセキュアブートが期待されますが、現時点では対応していないようです（Sophosコミュニティでも明確な情報はありませんでした）\n\n\nIntelの10GbpsのNICをお使いの方は、速度の面で有利なVMXNET3ドライバを選択可能です。ただし、VMXNET3を使う場合は、MTUは1500のまま変更しないことをお勧めします。MTU9000でXGが再起動を繰り返す事象を確認しています\n\n\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"Sophos FirewallをESXi仮想マシンにインストールする","url":"/new-technology/2020/03/06/InstallXG2/","content":"この記事で実現すること\nESXiに環境構築済みの仮想マシンに対し、Sophos Firewallのインストールを行います。ESXiを使わない場合、PC（物理マシン）にフラッシュメモリを接続し直接インストールする事になりますが、この場合も手順自体はほとんど変わりません。\n\n\n\nSophos Firewallのインストール概要「VMware vSphere Hypervisor（ESXi）の設定」、「Sophos Firewall のインストール（事前準備）」で、ネットワークアドレスを決めました。Firewallのインストール概要は以下の通りです。\n\nSophos Firewall(FW)のLAN側ネットワークアドレスは製品のデフォルトである172.16.16.0/24を使うか、自身で決めたESXiが属するネットワークアドレス192.168.1.0/24（例）を使う事になります。ここではFWのWAN側を192.168.0.0/24のネットワーク、FWのLAN側を192.168.1.0/24として説明します。\nESXiの導入設定では、デフォルトのvSwitch0をLANとし、vSwitch1を追加しWANとしました。\nインターネットに繋がるホームゲートウェイ(HGW)のLAN側IPアドレスはここでは192.168.0.1とします。FWのWAN側IPアドレスはHGWのDHCPによってプライベートIPが割り当てられます。ここでは192.168.0.2とします。\nクライアントPCとESXiのLAN側ネットワークとを接続します。ESXiのLAN側IPアドレスは192.168.1.1とし、ESXiの管理コンソールに接続するクライアントPCは手動でLANのIPアドレスを割り当てます。ここでは192.168.1.101とします。\n仮想マシンは事前に設定されたFWのインストールイメージ（ISOファイル）からブートさせるので、PCのブラウザでESXiホストにログインし、仮想マシンを起動してインストールを行います。ESXiをセットアップした機器にモニタを接続する必要はありません。\nこれからインストールするFWはLAN側の管理画面に対し操作することになります。ここではLAN側IPを192.168.1.2とします。\n\n上記で説明したものをネットワーク構成図にすると以下のようになります。\n\n\n仮想マシンを起動する\nESXiの管理コンソールからFWの仮想マシンを選んでパワーオンをクリックします。\nSophos FIRMWARE INSTALLERが起動します。\nインストールを開始すると（仮想マシンに割り当てた）ディスクが全てフォーマットされ、ファームウェアがインストールされていきます。\npress y to rebootでリブートします。\n再起動後、さらにdefault conifgをインストールするとの表示がされ、やがてパスワード入力画面になります。最初のパスワードはadminです。まずライセンスを受け入れる画面となります。続いて、ネットワークの設定を変更します。\n\n\n\n1.”Network Configuration”を選び、次の画面で、”1.Interface Configuration”を選びます。以下の表示がEnterを押下する毎に変わります。\n\nLAN側のIP\nWAN側のIP（ホームゲートウェイからのプライベートIPが割り当てられています）。\n“Set IPv4 Address(y&#x2F;n)”と出るので、変更する場合は、y＋Enterします。\nIPv6は後で設定するので空Enterで構いません。\n\nこの状態で一旦IPの設定を終えたら、クライアントPCのブラウザからFWに対して接続し、セットアップを続けていきます。ここではFWのIPアドレスを192.168.1.2にしたと仮定して進めます。\nWANのIPが割り振られていない場合は、後続のセットアップでライセンスの確認ができません。事後にもライセンス登録は可能ですが、初期のうちに課題を解決しておきましょう。\n\n\nFirewallの初期設定ブラウザで、&lt;https://192.168.1.2:4444&gt;を開き初期設定を行っていきます。自己証明書でもあり、ブラウザのワーニングが表示されますが、了解のうえ進んでください。\n\n\nここでは、右上のプルダウンで日本語に変更しておくと良いでしょう。続いて、以下の項目を設定していきます。\n\n管理者パスワード\nタイムゾーン\n登録メールで届いたシリアル番号を入力します\n\n\n\n\nゲートウェイとしてルーターモードを選択します\nLAN側に割り振るDHCPのIP範囲を設定します\n\n\n\n\nネットワークプロテクションはSandStormを除き選択します。仮に選択してもホームユースでは解除されます。\n\n\n\n続いての画面のメールセットアップですが、登録しないと先に進めないので、一旦メールアドレスを登録します。Gmailをお持ちであれば、Gmailをメールの送信者にしておくと比較的簡単に送信できます。メールの受信者は、色々なイベント通知が発生した時に確認するアドレスですので、携帯などのアドレスが候補に挙げられます。\n\n\n セットアップも最後の仕上げです。5分程度と言いつつもう少し掛かる場合がありますので、ブラウザのリロードをせずそのまま待ちます。その後管理画面のリロードが入りますが、FWの管理サイトは自己証明書のためにブラウザのワーニングが出た画面で止まっている場合があります。\n\n\n ログイン画面です。固定IPにして設定してきたPCも、FWのDHCP機能によって、IPアドレスが割り当て可能となっています。PCの設定をDHCPにして確認して下さい。そして、インターネットにも接続出来ている事を確認して下さい。現段階では、基本はインターネットへの通信は全て通す設定になっているので疎通確認が出来たら、ホームゲートウェイに接続されている他の機器などをFWのLAN側に繋いで下さい。\nセキュア・ストレージ・マスターキーFWが再起動し、ログイン後、新たに追加されたセキュア・ストレージ・マスターキーの作成を求められます。\n\n\n以下の通り、最低12文字で、大文字・小文字・記号を含める必要があります。\n\n\n登録を終えると、マスターキーがセットされたとのメッセージが表示されて対応は完了です。\n\n\nマスターキーの情報は暗号化された安全な場所へ保管されることをお勧めします。参考までに「パスワード管理ソフトのbitwardenを活用する」を参照してください。\nパッチ適用インストール完了後、パッチがある場合は速やかにパッチ提供されることをお勧めします。v18.5をインストールされた場合、2022-03-26時点において最新版はMR3となります。「Sophos Firewall v18.5 MR-3」の記事を参照してください。\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"XG Firewall v18で正しいDNS利用を強制する","url":"/new-technology/2020/05/16/Intercept-DNS/","content":"この記事で実現すること\nユーザーが指定したDNS（多くはプロバイダDNS）に反し、行儀の悪いクライアントや悪意のあるプログラムはそれに従わず、別のDNSを参照する可能性があります。XG Firewall v18の機能を活用してDNSの安全性を確保します。\n\n\n\nDNSとプライバシーSophos CommunityでもDNSの扱いについてはいろいろ議論されていますが、ベストプラクティスとしてはDNS Best Practices for XGの記事にいくつかのアドバイスがあります。（※過去記事についてすでに削除されてしまいました）\n\nThe best protection is to use XG as dns server, configure dns request routing and nothing else. Avoid to open udp port 53.最良の防御策はXGをDNSサーバとして使用し、DNSリクエストのルーティングを設定すること。それ以外は何も行わないことです。udpポート53を開かないようにしてください。\n\n\n\nこの一言で既にDNSの使い方については答えが出てしまいましたが、記事が2017年とやや古い事もあり、v18の機能を生かしたDNSの設定例を書きます。\nDNSとプライバシーは国によって扱いが変わるかも知れません。国が人々のネットのアクセス状況を把握している事が問題とされている場所では、パブリックDNSが好まれます。また海外ではプロバイダーがDNSを改ざんするといったニュースも見かけます。日本国内においては、プロバイダのDNSの応答速度が遅い事から利用されるケースが増えてきているようです。\nブラウザのFireFoxでは、プライバシー保護を目的として、DNSについてHTTPSを利用したDNS over HTTPSに対応しています。この機能は日本ではデフォルトでオフになっていますが、HTTPSで暗号化されているため管理者側からは一般的なネットブラウジングと区別がつかず、トラフィックが見えづらくなります。\n私個人としてはDNSを含めたプライバシーの情報を無闇に拡散させない事が重要と考えています。また、Communityで言及されている通り、防御のためにDNSのPortは空けない事が重要と考えます。パブリックDNSの利用はユーザーそれぞれにとっては考え方は異なるかとおもいますので、これ以降は悪意をもったクライアントが本来のDNS設定を迂回する事の対策として読んでいただければとおもいます。\nXG v18で指定DNSを強制するここではDNS情報はDHCPで配布されている前提とします。このブログでは、クライアントが参照するDNSは、全てXGのDNSを指定するように設定しています。この前提で、これを回避しようとするクライアントに対して以下の対策を取ります。\n\nDNS over TLS(DoT)は拒否 Port853の拒否\nDNS over HTTPS(DoH)は拒否 RFC8484に基づき、MIMEヘッダーの”application&#x2F;dns-message”を見つけて、その通信を拒否\nPublic DNSへのアクセス（Port53）は、強制的にXGのDNS経由で本来のDNSにアクセス XGのDNATの機能を使い、WANインターフェースに対するPort53の通信だった場合、宛先IPをXGのLANのIPアドレスに変換\n\n\n\nアプリケーションは、DoTやDoHを止められると（一般的には）通常のDNS(Port53)にフォールバックします。そしてXGは強制的にDNSの向き先を変えますが、クライアントはパブリックDNSにアクセスしたと思い込んだまま、返されたIPに対しアクセスする事になります。\nDoHの拒否DoHの定義についてサービスの登録を行います。\nXGの左ペインメニューWebのファイルタイプから追加ボタンをクリックします。名前は”DoH”、テンプレートを空白とし、MIMEヘッダーにapplication/dns-messageと入力し、保存します。\n\n\n左ペインメニューWebのユーザーアクティビティから”追加”ボタンをクリックし、DoHとして登録したカテゴリを加え、DNS over HTTPSと名前を付けて保存します。\n\n\n続いて、具体的な拒否設定です。\n左ペインメニューWebのポリシーからご自身がFirewallルールで利用しているポリシー（ここでは”Home Policy”を仮定しています）に、上記で登録してきた”DNS over HTTPS”を拒否する設定を加えます。\n\n\nDoTの拒否XGの左ペインメニューホストとサービスのサービスから、”追加”ボタンをクリックし、”送信元ポート”1〜65535、”宛先ポート”853を指定し、”DoT”と名前を付け保存します。\n\n\nXGの左ペインメニュールールとポリシーから新しいファイアウォールルールを追加し、以下のようにDoTを”拒否”するルールを作成します。\n\n\nDNSに関するDNAT最初にDNATで必要なホストの定義を行います。LANで使っているネットワークアドレスの登録とXG自身のIPアドレスの登録が必要です。ネットワークアドレスについてIPv4は例えば、192.168.1.0/24、IPv6は例えばfd00:beef:cafe::/64などの登録を行います。XG自身のIPアドレスも登録が必要です。\n\n\nXGの左ペインメニュールールとポリシーから、NATルールを選択、”NATルールの追加”ボタンをクリックし、DNATを設定します。\n\n“変換前の送信元”は、使っているネットワークのオブジェクトを登録します\n“変換前のサービス”は、”DNS”を選択します\n“返還後の宛先（DNAT）”は、XG自身のIPを指定します\n“アウトバウンドインターフェース”には、WANである、”Port2”を選択します\n最後に追加ボタンをクリックして登録を完了します\n\n\n\n上記はIPv4の例ですが、IPv6を利用されている方は、同様にIPv6のDNATも設定してください。\n動作確認上記DNATによるDNSのインターセプトが有効になると、ルールとポリシーのNATルール画面で実際に変換された数が確認できるので、これで挙動を確認してください。\n\n\n以上がプライバシーと安全性を重視したv18ならではのDNSのベストプラクティスです。\nDNSに関しての補足GoogleDNSのDoHはRFC8484に従っていない独自プロトコルを使えるという事実があります。世界中のパブリックDNSを全て把握するのは困難ですが、Sophosのコミュニティの記事を参考にWebフィルタのURLグループにパブリックDNSのドメインを登録し、拒否する設定を加えても良いでしょう。詳細は、以下の記事を参照してください。\n\nSophos Community -DNS over HTTPS (DoH) for web security- https://community.sophos.com/kb/en-us/134644\n\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"Mellanox Connect XとWindows11","url":"/new-technology/2023/03/25/Mellanox-ConnectXandWindows11/","content":"\nこの記事で実現すること\n\nこの記事ではSFP+のネットワークカードである、Mellanox Connect XについてWindows11の対応状況やWindowsでのファームウェアアップデートなどを記します。\n\n\n安価なMellanox Connect-Xカードすでに販売終了となったConnect X-3はeBayで5,000円弱で売られています。MellanoxのConnect Xシリーズは脆弱性の指摘も見かけず、安定しているNICでしょうか。intelに比べればマイナーですが、SFP＋で安価に入手可能となっており、ホームユーザーにとっても大変ありがたい存在です。Connect X-3はWindows10までのドライバはNvidiaのサイトに掲載されていますがWindows11ではドライバの存在はありません。\nしかしながら、Windows11ではConnect Xを認識してWindowsとして用意されたドライバのインストールが行われ、すぐに使えます。いわゆる、Windows11に標準で付属しているinboxドライバになります。逆にNVidiaサイトにあるWindows10用のドライバはWindows11ではエラーが発生し動きません。後述のNVidiaフォーラムの投稿をご確認ください。\n最近、2PortのMellanox Connect X-4 LxをeBayでちらほら見かけるようになってきました。販売終了した製品ですが、サポートはされています。\nMCX4121A-ACATという型番は、Mellanox ConnectX-4 LX 25GBE SFP28 2ポートPCIeイーサネット アダプターとなっており、eBayで15,000円ほどで購入できます。SFP28はSFP+とモジュール接続口の互換性があります。SFP＋のダイレクトアタッチケーブル（DAC）やOM3ケーブルと共に使うSFP+短距離マルチモードファイバ（MM SR）モジュール等の10GbE SFP+で問題なく10Gbps通信できます。もちろん25GbEとしても使えますが、PCなどホスト端末に挿して使うには他の機器との速度差が大きすぎて使いにくいものです。intel製のNICは在庫不足から回復傾向にあるようですが、まだまだ高額です。\n詳しいスペックは以下のリンクを参照してください。PCIe3 x8となっています。\n\nMellanox Connect X-4 https://network.nvidia.com/files/doc-2020/pb-connectx-4-lx-en-card.pdf\n\nConnect X-3はやや個人向けの色合いが強かったですが、Connect X-4あたりからはサーバー製品としての要素が強くなっていきます。OEM版（HPE、DELL向け等）は避けることをお勧めします。これはベンダーロックインが掛かっている可能性が高く、ファームウェアの強制書き込みなどが必要になります。また、それでうまくいく保証もありません。また、Connect X-4はいろいろなホストインタフェースがありますので、Ethernet、PCIeというところに気をつけてください。PCIeスロットに挿すだけですぐにWindows11で使えるMCX4121A-ACATはお勧めです。\n2Portも要らないといっても、eBayでは意外と1Portものが出ていません。また、他カードとの兼ね合い（x16が埋まっている）でPCIe x4までという方は一般論としてConnect X-3（MCX311A-XCAT）が向いています。\n\nNvidia ConnectX-4 Lx 製品概要 https://www.nvidia.com/ja-jp/networking/ethernet/connectx-4-lx/\n\n\nNVidiaフォーラムでConnect X-3のWin11のドライバが無いことをNVidiaのテクニカルサポートが示唆 https://forums.developer.nvidia.com/t/connectx-3-cx311a-xcat-for-win11-crashed/205962\n\nWindows11でのデバイスドライバConnect X-3Connect X-3をPCIeにセットしてWin11を起動します。デバイスドライバを見てみます。\n\n\n2019年のinboxドライバが自動的に取り込まれます。このドライバに脆弱性が出てしまえば、リスクがあり別の製品に買い替えが必要となりますが、脆弱性データベースでもなかなかMellanoxの名前を見ることはありません。\nお約束ですが、ESXi上のUbuntuとのiperf3を実行してみます。MTUは1,500のデフォルト、スイッチはフローコントロールをオンにしています。多重度3でUbuntuからダウンロードする方向（-Rオプション）に実行して以下の通りです。\n[ ID] Interval           Transfer     Bitrate         Retr[  5]   0.00-10.05  sec  3.81 GBytes  3.26 Gbits/sec  615             sender[  5]   0.00-10.00  sec  3.81 GBytes  3.27 Gbits/sec                  receiver[  7]   0.00-10.05  sec  3.46 GBytes  2.96 Gbits/sec  423             sender[  7]   0.00-10.00  sec  3.46 GBytes  2.97 Gbits/sec                  receiver[  9]   0.00-10.05  sec  3.79 GBytes  3.24 Gbits/sec  623             sender[  9]   0.00-10.00  sec  3.78 GBytes  3.25 Gbits/sec                  receiver[SUM]   0.00-10.05  sec  11.1 GBytes  9.45 Gbits/sec  1661             sender[SUM]   0.00-10.00  sec  11.1 GBytes  9.49 Gbits/sec                  receiver\n\n(Ryzen 7 5700G、メモリDDR4-3200 DIMM (PC4-25600)32GByte)このPCにはPCIe×16のスロットにConnect X-4を、PCIe x4のスロットにConnect X-3を挿しています。\n少しリトライが多いようですが、9.49Gbpsです。-R -P3オプションとして逆方向の送信（ダウンロード）、多重度3のみ、それ以外のオプションは指定していません。Windows10時代でも多重度は4程度から9.3Gbpsをマークしていたと記憶しているので、まずまずでしょうか。Windows11側がダウンロード側ですのでUbuntu側の送信速度に少し追いついていないようです。これはドライバが最適化されていない可能性もあります。しかし、実運用として使うのであれば十分でしょう。\nConnect X-4Connect X-4はWindows11で自動導入されるドライバは2020年のものですが、新しいドライバをNvidiaからダウンロードできます。\n\n\nNVidiaではSoftwareのEthernetの分類でドライバを検索することになります。https://developer.nvidia.com/networking/ethernet-software\n具体的には、以下のWinOF-2がWin10以降のドライバとなります。\n\nMLNX_OFED for Windows - WinOF &#x2F; WinOF-2 https://network.nvidia.com/products/adapter-software/ethernet/windows/winof-2/\n\nConnect X-4は2023年2月2日に発表されたRevision3.20.50010が最新のようですが、実際のドライバは上記のキャプチャの通り、3.2.25がインストールされます。\nセットアップはただインストーラの指示に従い、進めていくだけなので何も難しいものはありません。\n\n\nConnect X-4のスループットPCのConnect X-4（SFP28スロット）にSFP＋モジュールを挿入し、対向もスイッチに挿します。\nConnect X-3もConnect X-4も同じ10GbEとして使うなら変わらないように思えますが、ドライバの違いもさることながら能力は結構違います。多重度1でUbuntuに対して実行した結果です。\nConnect X-4 flow control send[ ID] Interval           Transfer     Bitrate[  5]   0.00-1.00   sec  1.11 GBytes  9.51 Gbits/sec[  5]   1.00-2.00   sec  1.11 GBytes  9.49 Gbits/sec[  5]   2.00-3.00   sec  1.10 GBytes  9.49 Gbits/sec[  5]   3.00-4.00   sec  1.11 GBytes  9.49 Gbits/sec[  5]   4.00-5.00   sec  1.11 GBytes  9.49 Gbits/sec[  5]   5.00-6.00   sec  1.11 GBytes  9.49 Gbits/sec[  5]   6.00-7.00   sec  1.11 GBytes  9.49 Gbits/sec[  5]   7.00-8.00   sec  1.11 GBytes  9.49 Gbits/sec[  5]   8.00-9.00   sec  1.11 GBytes  9.49 Gbits/sec[  5]   9.00-10.00  sec  1.10 GBytes  9.49 Gbits/sec- - - - - - - - - - - - - - - - - - - - - - - - -[ ID] Interval           Transfer     Bitrate[  5]   0.00-10.00  sec  11.1 GBytes  9.49 Gbits/sec                  sender[  5]   0.00-10.04  sec  11.0 GBytes  9.45 Gbits/sec                  receiverConnect X-4 flow control recv[ ID] Interval           Transfer     Bitrate[  5]   0.00-1.00   sec  1.11 GBytes  9.51 Gbits/sec[  5]   1.00-2.00   sec  1.11 GBytes  9.49 Gbits/sec[  5]   2.00-3.00   sec  1.11 GBytes  9.49 Gbits/sec[  5]   3.00-4.00   sec  1.11 GBytes  9.49 Gbits/sec[  5]   4.00-5.00   sec  1.11 GBytes  9.49 Gbits/sec[  5]   5.00-6.00   sec  1.11 GBytes  9.49 Gbits/sec[  5]   6.00-7.00   sec  1.10 GBytes  9.49 Gbits/sec[  5]   7.00-8.00   sec  1.11 GBytes  9.49 Gbits/sec[  5]   8.00-9.00   sec  1.10 GBytes  9.48 Gbits/sec[  5]   9.00-10.00  sec  1.11 GBytes  9.49 Gbits/sec- - - - - - - - - - - - - - - - - - - - - - - - -[ ID] Interval           Transfer     Bitrate         Retr[  5]   0.00-10.05  sec  11.1 GBytes  9.45 Gbits/sec    0             sender[  5]   0.00-10.00  sec  11.1 GBytes  9.49 Gbits/sec                  receiver\n\n非常に安定していますね。Windowsのiperf3のシングルプロセスでRetryが0です。ちなみにこれだけ安定しているならということでスイッチのフローコントロールを外してみます。\nConnect X-4 no flow control send[ ID] Interval           Transfer     Bitrate[  5]   0.00-1.00   sec  1.11 GBytes  9.52 Gbits/sec[  5]   1.00-2.00   sec  1.11 GBytes  9.49 Gbits/sec[  5]   2.00-3.00   sec  1.11 GBytes  9.49 Gbits/sec[  5]   3.00-4.00   sec  1.11 GBytes  9.49 Gbits/sec[  5]   4.00-5.00   sec  1.11 GBytes  9.49 Gbits/sec[  5]   5.00-6.00   sec  1.10 GBytes  9.49 Gbits/sec[  5]   6.00-7.00   sec  1.11 GBytes  9.49 Gbits/sec[  5]   7.00-8.00   sec  1.11 GBytes  9.49 Gbits/sec[  5]   8.00-9.00   sec  1.11 GBytes  9.49 Gbits/sec[  5]   9.00-10.00  sec  1.11 GBytes  9.49 Gbits/sec- - - - - - - - - - - - - - - - - - - - - - - - -[ ID] Interval           Transfer     Bitrate[  5]   0.00-10.00  sec  11.1 GBytes  9.50 Gbits/sec                  sender[  5]   0.00-10.04  sec  11.1 GBytes  9.45 Gbits/sec                  receiverConnect X-4 no flow control recv[ ID] Interval           Transfer     Bitrate[  5]   0.00-1.00   sec  1.11 GBytes  9.49 Gbits/sec[  5]   1.00-2.00   sec  1.10 GBytes  9.47 Gbits/sec[  5]   2.00-3.00   sec  1.10 GBytes  9.47 Gbits/sec[  5]   3.00-4.00   sec  1.10 GBytes  9.47 Gbits/sec[  5]   4.00-5.00   sec  1.10 GBytes  9.47 Gbits/sec[  5]   5.00-6.00   sec  1.10 GBytes  9.47 Gbits/sec[  5]   6.00-7.00   sec  1.10 GBytes  9.47 Gbits/sec[  5]   7.00-8.00   sec  1.10 GBytes  9.47 Gbits/sec[  5]   8.00-9.00   sec  1.10 GBytes  9.47 Gbits/sec[  5]   9.00-10.00  sec  1.10 GBytes  9.45 Gbits/sec- - - - - - - - - - - - - - - - - - - - - - - - -[ ID] Interval           Transfer     Bitrate         Retr[  5]   0.00-10.05  sec  11.0 GBytes  9.42 Gbits/sec    0             sender[  5]   0.00-10.00  sec  11.0 GBytes  9.47 Gbits/sec                  receiver\n\nフローコントロール無しでこれは良い結果です。もっとも、アプリケーション（iperf3）が再送を必要としていないだけであって、NIC同士がオフロードして送受信管理するのでOSまでその情報は見えていないと考えられます。昔はとても高価かつ使いこなすのが難しいNICでしたが、シンプルに使うだけであれば、容易にその高い性能がホームユーザーにも享受できるようになってきました。\nConnect Xのファームウェア更新（Windows版）特にMellanoxのNICで脆弱性という話を聞いたことはなく、頻繁にパッチが出ないので本当に運用が楽ではありますが購入時にファームウェアを更新しておきましょう。「ESXiでネットワークカードのファームウェアを更新する」ではネットに接続されていない前提としてパッチを個別にダウンロードしましたが、Windowsの場合はネットに接続されている事が前提でしょうから、もう少し手間は省けます（ESXiホスト自身はNTPなど限定されたサービスを除きインターネットアクセスしないのが一般的です）。\nWindowsにおいてMellanoxカードのファームウェアの更新にはMFTとmlxupの2つのツールが必要です。まずMFTのインストールになります。以下のURLからMFTをダウンロードします。\n\nNVIDIA Firmware Tools (MFT) https://network.nvidia.com/products/adapter-software/firmware-tools/\n\n2023-3-25時点では、2023-1-31リリースの4.23.0が最新のようです。MFTもインストーラーで特に悩むこともなくセットアップを完了させます。OSを再起動するとMFTツールは自動起動されますが、再起動しなくともコマンドプロンプトからmst server startでサービスが起動します。\nC:\\Users\\yoshi&gt;mst server startC:\\Users\\yoshi&gt;Waiting for connection on port 23108\n引き続き、管理者権限のコマンドプロンプトを開き、mst statusを実行するとNICの情報が得られます。\nC:\\Windows\\System32&gt;mst statusMST devices:------------  mt4117_pciconf0C:\\Windows\\System32&gt;\n\n続いてmlxupのダウンロードです。これはexeファイルそのものなので、ブラウザからのダウンロード時に警告が出るかもしれません。\n\nmlxup - Update and Query Utility https://network.nvidia.com/support/firmware/mlxup-mft/\n\nダウンロードしたら、コマンドプロンプトにてmlxup.exe --queryを実行します。\nmlxup --queryQuerying Mellanox devices firmware ...Device #1:----------  Device Type:      ConnectX4LX  Part Number:      MCX4121A-ACA_Ax  Description:      ConnectX-4 Lx EN network interface card; 25GbE dual-port SFP28; PCIe3.0 x8; ROHS R6  PSID:             MT_2420110034  PCI Device Name:  mt4117_pciconf0  Base MAC:         0c42a1000000  Versions:         Current        Available     FW             14.25.1020     14.32.1010     PXE            3.5.0701       3.6.0502     UEFI           14.18.0019     14.25.0017  Status:           Update required\n\nするとこのようにファームウェアの情報とアップデート可能か否かの情報が得られます。実際のファームウェアの更新はmlxup --onlineです。これで適切なファームウェアがダウンロードされ適用されます。\nC:\\Users\\yoshi\\Downloads&gt;mlxup --onlineQuerying Mellanox devices firmware ...Device #1:----------  Device Type:      ConnectX4LX  Part Number:      MCX4121A-ACA_Ax  Description:      ConnectX-4 Lx EN network interface card; 25GbE dual-port SFP28; PCIe3.0 x8; ROHS R6  PSID:             MT_2420110034  PCI Device Name:  mt4117_pciconf0  Base MAC:         0c42a1000000  Versions:         Current        Available     FW             14.25.1020     14.32.1010     PXE            3.5.0701       3.6.0502     UEFI           14.18.0019     14.25.0017  Status:           Update requiredRelease notes for the available Firmware:-----------------------------------------  For more details, please refer to the following FW release notes:    1- ConnectX3 (2.42.5000):    http://www.mellanox.com/pdf/firmware/ConnectX3-FW-2_42_5000-release_notes.pdf    2- ConnectX3Pro (2.42.5000): http://www.mellanox.com/pdf/firmware/ConnectX3Pro-FW-2_42_5000-release_notes.pdf    3- Connect-IB (10.16.1200):  http://www.mellanox.com/pdf/firmware/ConnectIB-FW-10_16_1200-release_notes.pdf    4- ConnectX4 (12.28.2006):   http://docs.mellanox.com/display/ConnectX4Firmwarev12282006    5- ConnectX4Lx (14.32.1010): http://docs.mellanox.com/display/ConnectX4LxFirmwarev14321010    6- ConnectX5 (16.35.2000):   http://docs.mellanox.com/display/ConnectX5Firmwarev16352000    7- ConnectX6 (20.36.1010):   http://docs.mellanox.com/display/ConnectX6Firmwarev20361010    8- ConnectX6Dx (22.36.1010):   http://docs.mellanox.com/display/ConnectX6DxFirmwarev22361010    9- ConnectX6Lx (26.36.1010):   http://docs.mellanox.com/display/ConnectX6LxFirmwarev26361010    10- BlueField2 (24.35.2000):   http://docs.mellanox.com/display/BlueField2Firmwarev24352000    11- ConnectX7 (28.36.1010):   http://docs.mellanox.com/display/ConnectX7Firmwarev28361010---------Found 1 device(s) requiring firmware update...Perform FW update? [y/N]: y---CMD: mlxup -u --log-on-update --ssl-certificate C:\\Users\\yoshi\\AppData\\Local\\Temp\\sfxter_yoshi_3512\\mlxup-dir\\ca-bundle.crt --current-dir C:\\Users\\yoshi\\Downloads\\  --onlineQuerying Mellanox devices firmware ...Device #1:----------  Device Type:      ConnectX4LX  Part Number:      MCX4121A-ACA_Ax  Description:      ConnectX-4 Lx EN network interface card; 25GbE dual-port SFP28; PCIe3.0 x8; ROHS R6  PSID:             MT_2420110034  PCI Device Name:  mt4117_pciconf0  Base MAC:         0c42a1000000  Versions:         Current        Available     FW             14.25.1020     14.32.1010     PXE            3.5.0701       3.6.0502     UEFI           14.18.0019     14.25.0017  Status:           Update requiredRelease notes for the available Firmware:-----------------------------------------  For more details, please refer to the following FW release notes:    1- ConnectX3 (2.42.5000):    http://www.mellanox.com/pdf/firmware/ConnectX3-FW-2_42_5000-release_notes.pdf    2- ConnectX3Pro (2.42.5000): http://www.mellanox.com/pdf/firmware/ConnectX3Pro-FW-2_42_5000-release_notes.pdf    3- Connect-IB (10.16.1200):  http://www.mellanox.com/pdf/firmware/ConnectIB-FW-10_16_1200-release_notes.pdf    4- ConnectX4 (12.28.2006):   http://docs.mellanox.com/display/ConnectX4Firmwarev12282006    5- ConnectX4Lx (14.32.1010): http://docs.mellanox.com/display/ConnectX4LxFirmwarev14321010    6- ConnectX5 (16.35.2000):   http://docs.mellanox.com/display/ConnectX5Firmwarev16352000    7- ConnectX6 (20.36.1010):   http://docs.mellanox.com/display/ConnectX6Firmwarev20361010    8- ConnectX6Dx (22.36.1010):   http://docs.mellanox.com/display/ConnectX6DxFirmwarev22361010    9- ConnectX6Lx (26.36.1010):   http://docs.mellanox.com/display/ConnectX6LxFirmwarev26361010    10- BlueField2 (24.35.2000):   http://docs.mellanox.com/display/BlueField2Firmwarev24352000    11- ConnectX7 (28.36.1010):   http://docs.mellanox.com/display/ConnectX7Firmwarev28361010---------Found 1 device(s) requiring firmware update...Please wait while downloading MFA(s) ...Device #1: Updating FW ...FSMST_INITIALIZE -   OKWriting Boot image component -   0%Writing Boot image component -   1%Writing Boot image component -   2%(省略)Writing Boot image component - 100%Writing Boot image component -   OK\b\b\b\bDoneRestart needed for updates to take effect.\n最後にOSをリブートして完了です。ESXiよりはずいぶん簡単ですね。\n個別のファームウェアを適用したい場合は、mlxupのダウンロードページにUser Manualのリンクがありますので参照してください。\nPCIe x4スロットさて、エイプリールフールも近いのでネタを1つご紹介します。今回紹介したMellanox Connect X-4の必要レーン数は、PCIe x8です。グラフィックカードをPCIe x16に挿していらっしゃる方は残りのPCIe x4のスロットしか使えず、最初からPCIe x8のネットワークカードは候補に上がらないと思います。\n私のもう1台のPC（Ryzen5 5600G）のPCIe x4のスロットです（PCIe3 x4で動作）。物理的なスロットは長いですが、接続端子がx4の部分までしかありません（画像をクリックして拡大できます）。\n\n\nConnect X-4を挿すところです。どう見てもレーン数が不足しています。\n\n\nとりあえずはスロットにConnect X-4を差し込み、Windows11を起動すると無事にカードは認識されています。SFP28モジュールとOM3ケーブルとを使ってスイッチに繋いでみます。\n\n\n（UbiquitiのSwitch Pro Aggregationスイッチは4つのSFP28ポートを持っています。見た目はSFP+と区別がつきませんが、右側の4PortがSFP28です）\niperf3のテストです。Windows11同士、それぞれがConnectx-4で片方がPCIe x4です。多重度は2です。\niperf3 PCIe x4 Ryzen5(SFP28) &lt;- Ryzen7(SFP28)C:\\Users\\yoshi&gt;iperf3 -c 192.168.x.165 -R -P2Connecting to host 192.168.x.165, port 5201Reverse mode, remote host 192.168.x.165 is sending[  5] local 192.168.x.112 port 49813 connected to 192.168.x.165 port 5201[  7] local 192.168.x.112 port 49814 connected to 192.168.x.165 port 5201[ ID] Interval           Transfer     Bitrate[  5]   0.00-1.00   sec  1.37 GBytes  11.8 Gbits/sec[  7]   0.00-1.00   sec  1.35 GBytes  11.6 Gbits/sec[SUM]   0.00-1.00   sec  2.72 GBytes  23.3 Gbits/sec- - - - - - - - - - - - - - - - - - - - - - - - -[  5]   1.00-2.00   sec  1.38 GBytes  11.9 Gbits/sec[  7]   1.00-2.00   sec  1.38 GBytes  11.9 Gbits/sec[SUM]   1.00-2.00   sec  2.76 GBytes  23.7 Gbits/sec- - - - - - - - - - - - - - - - - - - - - - - - -[  5]   2.00-3.00   sec  1.38 GBytes  11.9 Gbits/sec[  7]   2.00-3.00   sec  1.38 GBytes  11.9 Gbits/sec[SUM]   2.00-3.00   sec  2.76 GBytes  23.7 Gbits/sec- - - - - - - - - - - - - - - - - - - - - - - - -[  5]   3.00-4.00   sec  1.38 GBytes  11.9 Gbits/sec[  7]   3.00-4.00   sec  1.38 GBytes  11.9 Gbits/sec[SUM]   3.00-4.00   sec  2.76 GBytes  23.7 Gbits/sec- - - - - - - - - - - - - - - - - - - - - - - - -[  5]   4.00-5.00   sec  1.38 GBytes  11.9 Gbits/sec[  7]   4.00-5.00   sec  1.38 GBytes  11.9 Gbits/sec[SUM]   4.00-5.00   sec  2.76 GBytes  23.7 Gbits/sec- - - - - - - - - - - - - - - - - - - - - - - - -[  5]   5.00-6.00   sec  1.38 GBytes  11.9 Gbits/sec[  7]   5.00-6.00   sec  1.38 GBytes  11.9 Gbits/sec[SUM]   5.00-6.00   sec  2.76 GBytes  23.7 Gbits/sec- - - - - - - - - - - - - - - - - - - - - - - - -[  5]   6.00-7.00   sec  1.38 GBytes  11.9 Gbits/sec[  7]   6.00-7.00   sec  1.38 GBytes  11.9 Gbits/sec[SUM]   6.00-7.00   sec  2.76 GBytes  23.7 Gbits/sec- - - - - - - - - - - - - - - - - - - - - - - - -[  5]   7.00-8.00   sec  1.38 GBytes  11.9 Gbits/sec[  7]   7.00-8.00   sec  1.38 GBytes  11.9 Gbits/sec[SUM]   7.00-8.00   sec  2.76 GBytes  23.7 Gbits/sec- - - - - - - - - - - - - - - - - - - - - - - - -[  5]   8.00-9.00   sec  1.35 GBytes  11.6 Gbits/sec[  7]   8.00-9.00   sec  1.39 GBytes  11.9 Gbits/sec[SUM]   8.00-9.00   sec  2.74 GBytes  23.5 Gbits/sec- - - - - - - - - - - - - - - - - - - - - - - - -[  5]   9.00-10.00  sec  1.39 GBytes  11.9 Gbits/sec[  7]   9.00-10.00  sec  1.35 GBytes  11.6 Gbits/sec[SUM]   9.00-10.00  sec  2.73 GBytes  23.5 Gbits/sec- - - - - - - - - - - - - - - - - - - - - - - - -[ ID] Interval           Transfer     Bitrate[  5]   0.00-10.00  sec  13.8 GBytes  11.8 Gbits/sec                  sender[  5]   0.00-10.00  sec  13.8 GBytes  11.8 Gbits/sec                  receiver[  7]   0.00-10.00  sec  13.8 GBytes  11.8 Gbits/sec                  sender[  7]   0.00-10.00  sec  13.8 GBytes  11.8 Gbits/sec                  receiver[SUM]   0.00-10.00  sec  27.5 GBytes  23.6 Gbits/sec                  sender[SUM]   0.00-10.00  sec  27.5 GBytes  23.6 Gbits/sec                  receiveriperf Done.\n\n中途半端な繋ぎ方ですが、25GbEワイヤレートの速度がしっかり出ています。25GbEの全二重通信の検証まではやっていませんが、そもそもPCIe x8で25GbEが2Portならば、PCIe x4で25GbEの1Portはいけるでしょうし、10GbEなら2Portともに大丈夫でしょう。\nまるでギャンブルですが、エイプリールフールでした、、、ということではありません。Mellanox Connect X-4はこういった接続方法に対応しています。\n\n\n冒頭で紹介した製品スペックのPDFでは、赤枠で囲ったところに、オートネゴシエートとあります。理論上、PCIe3 x4では帯域が32Gbpsですから25Gbpsの通信は可能ということになります。\nどうしても先入観があって、x4のスロットにx8のカードを挿そうと思いませんよね。\nPCIeのレーン数はご利用のマザーボードによって様々な仕様がありますので事前のご確認をお勧めします。\n","categories":["Hardware","Network"],"tags":["SFP+","10GbE","25GbE"]},{"title":"iPhoneに繋がるミニSSDケース","url":"/new-technology/2023/12/16/MiniSSDCase/","content":"\n\niPhone15のUSB-Cに繋がるミニSSDケースを紹介します。これは、M2-2230という小型のSSDが組み込めるケースです。iPhoneは破損防止のためにケースを使っていらっしゃる方が多いとは思いますが、ケースとUSB-C接続端子とが競合し、USB-C端子が本体に挿さりきらないという問題がありますが、このケースはやや長めの端子になっており、スマホケースを使う前提に作られているようです。\n\n\nSDカードの速度SDカードはちょっとしたデータの受け渡しに使え便利ですが速度という意味では少し取り残されてきた感があります。長期保存にも向きませんが、安価なのでOSのセットアップなどではまだまだ主流です。もっともSDカードは、ビデオカメラで動画を撮るのが主目的ですので、その速度とは常に動画の解像度と比較されることになります。\n分かりやすい目安の表が SD Associationから提示されている以下の図になります。\n\n\n\n Copyright © SD Association. All Rights Reserved.https://www.sdcard.org/ja/developers-2/sd-standard-overview/speed-class/\n\nフルHDの動画であれば、UHS-3を使えば一般的に問題無いというレベルです。4K動画となると、解像度に加え、フレームレートも大きく関わってきますから、少し留意が必要となってきます。\nこういった一般用途に加え、機器の持つデータの移行やバックアップなどが通常の利用用途に必要な方は、少しSDカードでは物足りなくなり、データ量としてカバーできるポータブルHDDの出番になります。\nM2.2230のSSDケースPCで一般的に用いられるM.2-2280を使えば高速化でき便利ですが、これだと少し大きさとしてポケットに入るとまでは言いづらく、嵩張ります。M.2-2230という小さなSSDであれば随分小型化できます。今回それにぴったりのSSDケースを紹介します。\n中国メーカーのITGZという会社の製品です。秋葉原のラジオデパートにあるテクノハウス東映に入荷したという情報から、10月ごろに店舗に足を運んだのですが、あっさり売り切れということでした。Amazonでも販売しているようですが、結局は中国からの発送なのか時間も掛かるようでしたので、いつものeBayで落札し、1ヶ月ほど待つことにしました。\nケースは金属製で、ヒートシンク代りにもなり、放熱しやすい仕組みになっています。放熱のサーマルパッドも2枚付属しています。ケース付属のドライバーでケースを分解し、SSDを取り付けます。\n\n\n\nSSDケース　US$15.95（eBay 送料込み）\n\nM.2 SSDM.2 SSD自体もeBayで落札しました。WD SN740の1TBモデルです。\n上記の写真はサーマルパッドをつけてSSDを組み込んだところです。もう1枚のサーマルパッドを付けると上蓋が閉まりきらなかったので付けないことにしました。もちろん、SSD側のシールを剥がして対応する事も出来なくはありませんが、よくシールを剥がしてミスって破損させるケースもあるようなので、原則はSSDのシールはそのままにします。WesternDigital社はこのシールを剥がすと保証対象外とするようですね。私の場合はeBay購入なのでそもそも保証はありませんが。。。\nM.2 2230自体があまり普及していないようですがAmazonなら数社ほどメーカーのSSDは入手できます。10月にテクノハウス東映に訪問した際は、確かトランセンド社とMicron社を筆頭に、いくつかのメーカーのSSDが廉価に販売されていたと記憶しています。\nMacbookでのベンチマークMacBookのAmorphousDiskMarkでベンチマークを計測してみます。\n\n\n想定通り、シーケンシャルは8Gbps(980MB&#x2F;s)程度と良い数値が出ています。SDインタフェースの90MB&#x2F;sを大きく凌駕しています。10GbEのネットワークを持つNASに繋いだ時とほぼ同程度の速度です（ネットワークレイテンシが無いぶんランダムの書き込みはSSDが高速です）。\nインターネット、NAS、ポータブルSSDと10Gbpsでそれぞれの速度差が無いと使い勝手が格段に良くなります。Wi-Fiも6Eで高速にはなりましたが、1.6Gbps程度でレイテンシも大きいので、大きなデータを扱う際は、PCなどをLANに繋ぎ直すという行為はまだ当面続きそうです。\nなお、スマホケースに組み込まれたiPhoneに接続することを想定しているのか少しUSB-Cの端子が長めになっています。よって、MacBookなどに繋げた際は、少し本体とケースの間に隙間ができます。\n\n\n発熱高速な通信には発熱は避けられません。MacでDiskMarkを2回実行し、ケースの温度を測ったところ51度ありました。\n\n\n51度は指でケースを触れてだいたい3秒程度我慢できるくらいでしょうか。\niPhoneでのProRes撮影なお、iPhone15 ProでApple ProResエンコーディングでの動画撮影をしてみました。自動的にUSBCに動画を保存するようになります。一応、撮影&#x2F;保存は出来るんですが、複数回、動画を撮影しようとするとiPhoneのカメラアプリが固まってしまいます。RTL9210チップとの相性なのか、再初期化（OSからのファイルのクローズ、再オープン）に無応答となるようですので、このケースではiOSのProRes撮影に正式に対応できていない可能性があります。30秒の4K&#x2F;30FPSの撮影で3GB強の容量が消費されます。MacBookで再生するときちんと録画はされているようです。またiOSの”ファイル”アプリケーションでUSB-Cへのファイルのコピーも問題なく可能なことを確認しています。\nまた、この際のケース温度は46度でした。普通の人が普通に使うとしたら、この熱量に驚くでしょうが、高速通信に慣れている方であれば許容範囲なのでしょうか。\nその他最近、円安も少し落ち着いてきましたね。来年春くらいにはさらに円安が落ち着くことを期待したいところです。以前に「マルチカレンシー口座 WISE」の記事でマルチカレンシー口座について記事を書きました。ドル決済を利用される方はeBayの為替手数料抑制のためにWISEの利用を検討されることをお勧めします。売買の都度、円から外貨に自動で交換し決済を完了させることができ、カード会社の手数料やPayPalの手数料よりは廉価です。\n","categories":["Hardware"],"tags":["M.2 NVMe"]},{"title":"XG Firewallの通知設定を行う","url":"/new-technology/2020/04/03/Notifications/","content":"この記事で実現すること\nXG Firewallで重要なエラーが発生した場合、VPNの接続通知、バージョンアップの通知をメールで受けとれます。\n\n\nGmailからメールを通知する設定XG Firewallのセットアップ時に通知用のメールアドレスを設定しても、メール通知がされません。プロバイダをはじめどこのサービスでも、SPAM対策がなされており、簡単にメールを送信する事は出来なくなっています。これは、Outbound Port 25 Blockingと呼ばれています。この回避策として、Googleアカウントを使う事で、メール通知が可能となります。\n\nGoogleアカウントをお持ちでない方はアカウントを作成し、あらかじめ2段階認証の設定を行ってください。次にGoogleアカウントのページに行き、左ペインのセキュリティをクリックしてください。\nGoogleアカウントのページ\n\n\n\n https://myaccount.google.com/?tab=kk\n\nアプリパスワードをクリックします。\n\n\n\n\nGoogleアカウントのパスワードで認証します\nアプリ パスワードを生成するアプリとデバイスを選択してください。という説明があるので、そこでXG用のパスワードと分かるように以下を入力してください\nアプリを選択　→　メールを選択します\nデバイスを選択　→　その他（名前を選択）を選択します\n\n\n\n\n名前をXG Firewallのものと分かるように入力します\n生成ボタンをクリックします\n生成されたアプリパスワードが表示されます\nパスワードを控えておきます\n完了ボタンをクリックし、Googleでの設定を終了します\n\n\n\n続いて、XG側の設定となります。左ペインの管理から、通知の設定をクリックします。以下の通り、外部メールサーバーを選択し、先ほどのGmailアカウントに関する情報を入力していきます。\n\n\n\n\n\n説明\n内容\n\n\n\nメールサーバーアドレス\nsmtp.gmail.com\n\n\nポート\n587\n\n\nユーザ名\nyour_account@gmail.com\n\n\nパスワード\nGoogleで取得した16桁のアプリパスワード\n\n\n接続のセキュリティ\nSTARTTLS\n\n\n送信元メールアドレス\nyour_account@gmail.com\n\n\nメールアドレスに通知を送信\n通知を受け取りたいメールアドレス\n\n\n管理インターフェースのIPアドレス\nWANのIPアドレスを選択\n\n\n最後に適用をクリックします。その後通知ボタンをクリックしテスト通知で正しく受信できる事を確認してください。それなりに重要度が高いものを対象とし、スマホで通知を受けると良いでしょう。\nv18-MR4での追加事項（2021-1-2追記）v18 MR4にアップデートしてから通知が来ていない事に気がつきました。MR4では、上記の画面に「証明書」という項目が追加されており、プルダウンから証明書を選択するようになっています。今回のように外部メールを利用するケースでは、”Application Certificate”を選択してください。\nメール通知するイベントを選択XGの左ペインからシステムサービス→通知リストと進みます。以下の通り、イベント毎に通知が設定可能となっているので、メール通知のトグルスイッチをオンにして、好みの通知について選択してください。\n\n\nリスク観点で考えると、以下の内容をオンにしておくのがお勧めです。\n\nユーザーのサインイン失敗\n新しいファームウェアの通知\nシステム関連（起動、CPU高、シグネチャ更新失敗）\nVPNの接続\nIPSの攻撃検知（サーバー公開している場合）\n\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"ProxmoxVEのVM新規作成（Ubuntu24.04LTS）","url":"/new-technology/2024/02/19/Proxmox-new-vm/","content":"\n\nこの記事で実現すること\n\n仮想環境のProxmox VEで仮想マシン（VM）の新規作成を行います。例示としてこの記事ではUbuntu24のセットアップを行います。ネットワークインターフェースと仮想マシンとの関係も見ていきます。\n\n\nUbuntu 24.04LTSのダウンロード最初にUbuntu24.04LTSのダウンロードを行います。\n\nUbuntu Desktop 24.04 LTS https://jp.ubuntu.com/download ファイル名は「ubuntu-24.04-desktop-amd64.iso」です。\n\nProxmox VEのネットワーク構成新規VMのセットアップにはディスク、メモリ、ネットワークを定義することになりますが、VMの新規作成の前にネットワークインタフェースについて見ていきます。\n以下は私の環境の例です。intel X710の4PortとRealtekのオンボードNIC（未使用）の５つが存在します。\n\n\nX710の4Portは”enp1s0f0”が1Port目、”enp1s0f3”が4Port目となっています。これが物理ネットワークインタフェースです。これに加えて、インストール直後は、vmbr0というネットワークブリッジが作成されており、ここではセットアップ時に決めたIPアドレスが設定されているはずです。vmbr1以降は私が手動で作成しています。\n仮想環境においてはL2ネットワークが重要であり、VMは仮想MACアドレスを保有します。ProxmoxのインタフェースではこのネットワークブリッジがNICの物理MACアドレス以外の仮想マシンのMACアドレスも受け取ることになり、いわば、無差別モード（プロミスキャスモード）で動作します。\n仮想マシンに対してL2レイヤのブリッジ（取り次ぐ）を行うために、Linux Bridgeが必要となります。Proxomoxにおいては命名規約は厳格であり、自由な名前は付けられません。ブリッジにしてもVLANにしても命名規則に従う必要があります。\nここでは仮想マシンの仮想MACアドレスは作成しません。VMを作成するタイミングで自動生成されることになります。L3レイヤ、つまりIPアドレスに関してProxmoxは意識しません。VMの中のOS任せであり、これはESXiなどの他のハイパーバイザーと考え方は同じです。\n個人的には、物理ネットワークカードのMACアドレスが表示されないのは少しわかりづらく感じます。物理ネットワーク（ネットデバイス）にはコメント欄があるので、そこにMACアドレスを記入しておけば運用面はなんとかなりそうです。\nISOの保存先VMを新規作成する上で、OSのインストールのために予めISOファイルをコピーしておく必要があります。Proxmoxの左ペインから、local(ホスト名)を選択します（私の環境ではホスト名がpve1という名前です）。\n\n\n\nここにISOイメージとあるので、選択します。ここで、アップロードボタンをクリックし、ローカルの端末からISOファイルをアップロードします。今回は、Ubuntu24.04デスクトップをインストールするためにファイルアップロードします。\nVMの新規作成ここでは２つのネットワークインタフェースを持つUbuntu24をセットアップします。もちろん、１つの場合はより簡単です。Proxmoxの右上にある青いボタンVMを作成をクリックします。いよいよ仮想マシンの作成に入ります。\n\n\nホスト名としての名前を（ご自身で決めたものを）入力します。VM IDは100から付番されていきます。またブート時に起動するか否かを決定します。\nOSの種類\n\nLinuxを選択します。UbuntuやDebianなどをバージョン毎に選ぶのかと思いましたが、種類は多くありません。Kernel6.x-2.6またはKernel2.4の2種類です。Kernel6.x-2.6を選択します。今回は関係ありませんが、Windows11もインストールできるようですね。また、懐かしいSolarisも選択可能となっています。さて、ISOファイルを選択して次に進みます。\nシステム\n\nここでは、旧ブートのBIOS（SeaBIOS）かUEFIを選択します。UbuntuはUEFIに対応しているので基本的にはUEFIを選びます。TPM追加は好みで選んでください。また、Qemuエージェントのチェックボックスは最初、Offのままにしておきます（後で設定します）。ゲストにインストールするヘルパーデーモンであり、稼働状況をホストが把握するためや、ホストから安全にシャットダウンするなどのアクションができるようになります。ESXiではVMWareToolsに相当するモジュールです。\nディスク\n\nディスクサイズを設定します。追加のボリュームを加える場合もここで設定します。\nCPU\n\nCPUの種別、CPUのコア数を指定します。Extra CPU Flagsとしていくつかの脆弱性に対応させるためのチェックがあります。私はRyzen５5600GにProxmoxをインストールしているので下記のオプションとしました。CPUの種別は特定されたものがあればそれを、無ければ一般的にx86-64-v2-AESを選びます。Intel&#x2F;AMDをクラスタで混在させないならそのCPUの最も古いものに合わせておくのが良いようです。詳細はヘルプのCPU TYPEを確認してください。\n\nIf you don’t care about live migration or have a homogeneous cluster where all nodes have the same CPU and same microcode version, set the CPU type to host, as in theory this will give your guests maximum performance.\n\n\nIf you care about live migration and security, and you have only Intel CPUs or only AMD CPUs, choose the lowest generation CPU model of your cluster.\n\n\nIf you care about live migration without security, or have mixed Intel&#x2F;AMD cluster, choose the lowest compatible virtual QEMU CPU type.\n\nメモリ\n\nVMで利用するメモリの量を設定します。\nネットワーク\n\n特に変更することはなく、NICのモデルは、VirtIO(準仮想化)を選んでおきます。おっと、ここではNICを追加することができませんね。後で2枚目のNICを追加することになるのでしょうか。まずはメインのvmbr0ブリッジを選択しておきます。\n確認最後に確認画面で完了します。\n（任意）仮想マシンでネットワークの追加2枚目のNICをVMに追加する場合、仮想マシンが作成されたら、以下のようにハードウェアからネットワークの追加を行います。\n\n\nVMの起動左ペインでVMを選択した状態で、画面上部の▶︎開始をクリックします。\nさて、無事にコンソールから起動してきました。\n\nProxoxのVMのコンソールのプルダウンから、VNCを選ぶと大きな画面でセットアップを進められます。\nUbuntu24.04 Desktopのインストールさて、ここからはUbuntuのセットアップに入ります。とは言っても、殆ど迷うことなくセットアップは完了します。\n\n\n\n\n迷うのはキーボードぐらいでしょうか。実際にタイプしてよく問題になりそうな記号について確認できます。「検出」を行うと、海外を基準として様々な文字の有無を確認させられるのでかえって面倒です。\n\n\n\n\nオフィスツールなどを利用するか否かでセットアップの種類を選択します。\n\n追加のドライバなどはお好みで設定してください。\n\nファイルシステムの変更を行う場合（ex. ext4→ZFS）は、ここでカスタマイズします。\n\n最初のユーザーを作成します。\n\nタイムゾーンを設定して完了です。\n\n\n\nUbuntu Proの設定確認があるので、登録します。できるだけシャットダウンせずに自動的にパッチが適用できます。個人ユーザーの場合は、Ubuntu Oneアカウントを作成し、それからProのレジストを行うことで対応できます。add token manuallyを選択して、Proのレジストが終わってから、トークンをここに貼り付けて完了させます。\n\n\nUbuntu Oneアカウントがない場合は、こちらからアカウントを作成します。文字列のコピーペーストをするので、UbuntuのFirefoxを使ってアカウントの作成とProのレジストを行ってください。\nhttps://login.ubuntu.com/\nその後、Ubuntu Proのレジストを以下で行います。https://ubuntu.com/pro\n\n\nさて、Proのレジストが完了すると、トークンを入手できますので、Ubuntuのセットアップ画面にトークンを貼り付けます。\n\n\n登録が完了すると以下の画面になります。できるだけリブートせずに自動的にパッチが当たっていくので運用がとても楽になります。\n\n\nOpen SSH ServerのインストールUbuntuにSSHするために必ず必要なモジュールです。GUIでコマンドを扱うには端末というアプリケーションを起動します。 そこからopensshをインストールします。\n$ sudo apt update$ sudo apt install openssh-serverパッケージリストを読み込んでいます... 完了依存関係ツリーを作成しています... 完了状態情報を読み取っています... 完了以下の追加パッケージがインストールされます:  ncurses-term openssh-sftp-server ssh-import-id提案パッケージ:  molly-guard monkeysphere ssh-askpass以下のパッケージが新たにインストールされます:  ncurses-term openssh-server openssh-sftp-server ssh-import-idアップグレード: 0 個、新規インストール: 4 個、削除: 0 個、保留: 0 個。751 kB のアーカイブを取得する必要があります。この操作後に追加で 6,046 kB のディスク容量が消費されます。続行しますか? [Y/n] Y\n\nUbuntuで端末アプリケーションを起動する場合、キーボードショートカットによる起動が便利です。セットアップ時のキーボードの選択によって内容は変わりますが、Widnowsは”Ctrl”+”Alt”+”T”で起動します。macOSでは”option”+”control”+”T”で起動します。\nProxmoxのセットアップの続きさて、Proxmoxの世界に戻ります。セットアップしているところでVMのサマリー画面を見ていると結構面白いですね。1vCPUと2GBのメモリでは少々足りないようです。\n\n\nもちろん後からCPUとメモリは変更できます。4vCPU&#x2F;4GBのメモリでもFirefoxを起動し、Fast.comに接続すると結構しんどそうです（1.5Gbps）。Ryzen7 5700GのESXiでは2vCPU&#x2F;2GBで2.4Gbps、XCP-ngでは古いCore i7-8700@3.20GHzで2vCPU&#x2F;2GBで2.8Gbpsなので最適化という意味では若干改善の余地があるような気もします。これがCLIベースのSpeedtestだと3者共に殆ど結果が変わらないので何か描画などに関してオーバーヘッドがあるのかなという気がしています。\nまた、ゲストエージェントが未設定という表示もされています。\nVMの確認と後工程Ubuntuのセットアップが終了して再起動後、さらにUbuntuモジュールの更新処理が行われていきます。それがひと段落したら、ゲストエージェントをインストールします。Ubuntu上の端末アプリケーションを起動し、以下のコマンドを入力します。\n$ sudo apt install qemu-guest-agent\n\nこれでゲストエージェントのインストールは完了です。一旦、VMをシャットダウンします。続いて、VMのオプションから、QEMU Guest Agentを有効にします。\n\n\n再度、Ubuntuを起動し、サマリ情報を参照すると、以下のようにIPアドレスの情報が取得できています。当たり前ですが、IPv6も確認できます。\n\n\nMoreボタンをクリックすると、2枚目のNICのIPアドレスも確認できます。\n\nこれでProxmoxに関して、一通りセットアップからVMの作成までを終えました。CPUタイプのあたりは少し最適化に向けて試行錯誤は必要そうですが、とても簡単にVMが作成できることがわかりました。\n","categories":["Software"],"tags":["proxmox Ubuntu"]},{"title":"ProxmoxVEのインストール","url":"/new-technology/2024/02/17/ProxmoxVE/","content":"\n\nこの記事で実現すること\n\n個人ユーザーでも手軽に始められる仮想環境のProxmox VE8.1のインストールを行います。セットアップは非常に簡単ですが、ポイントを絞って解説していきます。\n\n\nProxmox VEとはProxmox VEは、Debianベースのオープンソース仮想プラットフォームです。LinuxのKVMベースの仮装化とLXCのコンテナに対応しています。KVMはLinuxの一部であり、正統なハイパーバイザーにかなり近いですが、Linuxの中間型ともいえ、メモリ管理はあくまでLinuxとして行われるのが特徴です。Linuxにより近いことでパフォーマンスのボトルネックが少ないとも言えます。一方、セキュリティなどVMの独立性というセキュリティの面では正統なハイパーバイザーよりは劣ります。\nKVMはかなりPC寄りでコマンド中心の管理となり、何らかのGUIツールと組み合わせて利用されることが一般的です。ProxmoxはGUI中心の操作で、それ単体でバックアップやスナップショットなどが実行でき、手軽で便利な仮想環境の最有力候補となります。\n特にLinuxで稼動するツールなどを利用する想定だと、複数個のVMを立てる必要となりますので、最近の多数のコアのPCがあると便利です。ESXiのようにネットワークカードを厳選してしまう事もないので2.5GbEなどをはじめ多くの方が利用できるでしょう。NASとは異なり、仮想環境は一般的に大量のトラフィックを捌くものではないので、単にサーバーを立ち上げるだけであれば1GbEで十分なことも多いでしょう。さほどCPUが強力ではないミニPCを使うケースも多く見られます。一方、ファイアウォールやルーターとして利用する場合は高速なCPUと10GbEのネットワークが必要となるケースもあり、利用方法は2分されます。\nインストールは英語ですが、操作画面の言語は日本語が表示できます。\n価格と安定度Proxmoxは有償のプロダクトですが、本番環境で利用しないことを想定して無償で利用できます。それはモジュールなどのアップデートがベータ版としての扱いのモジュールが含まれることになります。これは「サブスクリプション無しのリポジトリ」と呼ばれます。セキュリティパッチなどを考えると原則パッチは当てていくことになりますが、その中に不十分なテストモジュールを含む場合があり、システム全体の安定度はあまり担保されません。自己責任ですので「お勧めしない」ということになります。また、ESXiのような、エンタープライズ向けのシステムではないのでドライバーなどがあまりこなれていないようにも見えます。\n安定度への貢献のため、無償ユーザーがテストを兼ねるというのはよく考えられています。ネットワークのUbiquitiもそうですが、ホームユーザーは積極的にアルファ版のテストから参加されています。\n価格と機能については以下のメニューとなっています。\n\n\n一番下のCommunityでも、Enterpriseリポジトリが使えます。価格は年間、1CPUソケットあたり110ユーロ（約17,800円）です。無償ESXiから乗り換えを検討している状況なら、VMUGというユーザーグループに加入し、VMWare製品を個人利用限定で使う場合を考えると参加費用の年間200ドル（約30,000円）が必要です。これらを両睨みで考えることになるでしょうか。費用を支払う場合は、VMWareの方が色々な製品を使えてお得なのかなと考えられますが、こういった価格帯系は急に変わることも多く悩みどころです。\n私はProxmoxを検証のためしばらく利用するつもりですが、有償のリポジトリとしてはおそらく利用せず、あくまで検証や安定性に難があっても構わない領域で使っていこうと考えています。\nシステム要件推奨ハードウェアは以下の通りです。\n\nIntelVT&#x2F;AMD-V、CPUフラグ付きのIntelEMT64またはAMD64。\nメモリ、OSおよびProxmox VEサービス用の最低2GB。さらに、ゲスト用の指定されたメモリ。CephまたはZFSの追加メモリが必要な場合は、使用するストレージTBごとに約1GBのメモリが必要。\n高速で冗長なストレージ、SSDディスクで最高の結果。\nストレージ：バッテリーで保護された書き込みキャッシュ（BBU）を備えたハードウェアRAID、またはZFSおよびSSDキャッシュを備えた非RAID。\nVMストレージ： ローカルストレージには、バッテリーバックアップ書き込みキャッシュ（BBU）またはZFS用の非RAIDを備えたハードウェアRAIDを使用。ZFS、CephはハードウェアRAIDコントローラと互換性無し。共有および分散ストレージも可能。\n冗長Gbit NIC、優先ストレージ技術とクラスターセットアップに応じて追加のNIC - 10 Gbit以上もサポート。PCI(e)パススルーには、VT-d&#x2F;AMD-d CPUフラグ付きのCPUが必要。\n\nこうやってRequirementを見てみると個人向けとも言えない本格派の構成を想定しているように見受けられます。本番環境ではお勧めしないとしつつも、その目線の高さを感じられます。最小構成など詳細は以下のリンクを参照してください。\n\nProxmox システム要件 https://www.proxmox.com/en/proxmox-virtual-environment/requirements?highlight=WyJoYXJkd2FyZSIsImhhcmR3YXJlJ3MiLCJjb21wYXRpYmxlIiwiY29tcGF0aWJpbGl0eSJd\n\nモジュールのダウンロード以下のURLからモジュールをダウンロードします。\n\nDownload ISO image https://www.proxmox.com/en/downloads/proxmox-virtual-environment/iso\n\n最新バージョンは8.1です。\nWindowsであればRufusなどでUSBメモリにISOファイルをインストールします。\n\nRufus https://rufus.ie/ja/\n\nまたは、WindowsのMicrosoftストアアプリでRufusを検索してインストールします。\nProxmox 8.1はセキュアブートに対応しています。UEFIでセキュアブートでのインストールがうまくいかない場合は、 UEFIセットアップ画面でセキュアブートをOffに、CMSサポートを有効にするなどして古いブート形式で起動しセットアップを行います。\nその他のOSでメディアを作成するなど、インストールに関する情報は以下を参照してください。\n\nInstalling Proxmox VE https://pve.proxmox.com/pve-docs/chapter-pve-installation.html\n\nインストールインストールに入る前に、複数のネットワークカードがある場合は、どのPortをメインのマネジメントインタフェースにするか決めておく必要があるので、それぞれのNICのMACアドレスを確認しておく事をお勧めします。\n\n\nセットアップを起動し、Install Proxmox VE(Graphical)を選択します。\n\nEULAへの同意\nDiskのフォーマット選択画面が表示されます。\n\n\n\n\noptionをクリックします。\n\nファイルシステムはデフォルトはext4です。ここで、xfs、zfs、btrfsとが選択できます。 ファイルシステムは以下の項目を参考に決定してください。\n\n\n \n\n デフォルトのext4ではLVM（ブロックベース）が選択できるとのことで、コンテナはLVM-Thinが使いやすいようです。zfsはファイルとブロックベースとが利用できます。上記の内容を踏まえてご自身の利用に沿ったファイルシステムを選択します。\n\n場所とタイムゾーンを指定します。\nrootでログインするパスワードとメールアドレスを指定します。\nネットワークの情報です。サーバーですので固定IPアドレスを振ることをお勧めします。複数のNICがある場合はメインのNICのMACアドレスを選択します。\n\n \n\n\n最後に確認画面が表示されてInstallボタンをクリックしてインストールが始まります。\n\n初期設定まずインストール時に決めたパスワードでログインします。ここで言語設定も変更しておきます。\n\n\n最初に「有効なサブスクリプションがありません」というダイアログが出ます。これは無償で使う場合は今後も必ず表示されます。早速、「サブスクリプション無しのリポジトリ」に切り替えます。\n以下の画面から左上のホスト（インストール時のホスト名）を選択し、画面中央のリポジトリを選択します。\n\n追加ボタンから、No-Subscriptionをプルダウンから選び追加します。\n右下部分のEnterpriseの文字が含まれる2つのリポジトリをDisableボタンをクリックして無効化します。\n\n\n\n(任意)定期的なジョブ結果を通知するメール設定以下の画面からSMTPを選択します。\n\n\n以下の画面で必要項目を入力しますが、簡単なのはGmailを送信者として自分宛のよく使うメアド宛に通知する方法です。\n\n\nGoogleアカウントから、セキュリティ→2段階認証プロセス→アプリパスワードへと進みます。\nここで、アプリ名を入力し、作成ボタンをクリックするとパスワードが生成されます。\n\n\nこのパスワードを前述のProxmoxの通知用メール設定の送信者のパスワードとして設定します。基本的にここで設定したGmailのアカウントが発信者として、Proxmoxをインストールした時に設定したメールアドレス宛に通知が行われることになります。このダイアログで設定した後はTestボタンで検証可能です。\n(任意)バックアップサーバー（NFSなど）への接続以下のようにメニューから外部サーバーを選択します。\n\n\n注意点としてはサーバーのNFSのバージョンと合わせます。また内容はVZDumpバックアップファイルを選択します。ExportはNASなどの外部サーバーのパスを設定しますので、NASなどのマニュアルを確認して設定してください。\nその他\nSSHでログインし、/.sshにauthorized_keyがありますので、そこに公開鍵をAppendしておけば公開鍵認証が可能です。\nあまり人にお勧めはできませんが、ProxmoxにSSHし、intel X710のファームウェアをアップデートしました（v9.4）。intelのサイトからダウンロードし、Linux用を利用しました。\n\nまとめこれでProxoxの一通りのセットアップが完了です。ネットワークはまだ見ていませんが、これはVMセットアップの時に確認をしていきます。\n\nProxmoxVEのVM新規作成（Ubuntu24.04LTS）\n\n","tags":["proxmox"]},{"title":"XG Firewall Sophos Communityについて","url":"/new-technology/2020/03/26/SophosCommunity/","content":"Sophos Communityを活用するXG Firewall Home EditionはSophosによるサポートがなく、ユーザコミュニティの相互サポートによって成り立っています。サポートサイトは英語が中心ですが、セキュリティに関するビジネスをしている方も積極的に参加しています。\n\n\n\nSophos community https://community.sophos.com/xg-firewall\n\nさて、直接XGの話ではありませんが、ここ数日話題になっているドイツ製翻訳ソフトのDeepLが素晴らしいです。私はGoogle翻訳をずっと使っていましたが、こちらも使い勝手が良く便利です。Windows、macOSのアプリケーションとしてインストールする事が出来ます。利用は無償（高機能な有償のpro版もあります）で、例えばブラウザで翻訳箇所を選択しCtrl+c(macはcommand+c)を2回押下するとDeepLが起動し、英訳と日本語が併記されます。\n\nDeepL翻訳 https://www.deepl.com/app\n\nこれまで私がブログで書いてきたv18のSSL&#x2F;TLSインスペクションですが、情報がたくさんあります。このブログで全てを説明するのは到底無理があります。Communityの素晴らしい知見を活用すべく、活用してみてください。\n\nSophos XG Firewall v18: DPI エンジンのトラブルシューティング https://community.sophos.com/products/xg-firewall/f/recommended-reads/118753/sophos-xg-firewall-v18-troubleshooting-problems-with-the-dpi-engine\n\nアプリでCtrl+cを2回押下して先頭部分の抜粋を抜粋します。\n\n\nぜひ、翻訳ソフトのDeepLを活用しながら、XGやSSLインスペクションの理解を深めてください。\n","categories":["Security"],"tags":["XG Firewall","DeepL"]},{"title":"Synology NASでESXi仮想マシンのバックアップを取得する","url":"/new-technology/2023/09/16/Synology-abb/","content":"\n\nこの記事で実現すること\n\nSynologyのNASでは無償版ESXiの仮想マシン（VM）バックアップが可能なActive Backup for Business(ABB)というソフトウェアが提供されています。Microsoft Hyper-V2016および2019にも対応しています。無償版ESXiのバックアップソフトは「無償版ESXiの高度なバックアップ」で書いた有償のもの（1年期限の無償版）は存在します。無償バックアップソフトは無償版ESXiに対応していないという難しい状況でしたが、NASが必須という前提はあるものの、追加コストゼロでESXi仮想マシンのバックアップが可能です。エージェントレスで、ESXi本体やVMには何もインストールする必要はありません。\n\nSynology https://www.synology.com/ja-jp/dsm/feature/active-backup-business/virtual-machine\n\n\n\n稼働条件ABBは基本はSynologyNASのPlusモデルで、Btrfsでフォーマットされたファイルシステムが必要です。一部のPlusモデルにはBtrfsに対応しない製品もあるので事前の確認をお勧めします。\nhttps://www.synology.com/ja-jp/dsm/packages/ActiveBackup\nABBの主要な機能についてここでは、ESXi仮想マシンのバックアップに目的を絞って説明します。\n\nESXi7.0、8.0対応\nVMのバックアップを複数世代管理\nジョブスケジューリング機能 ワンタイム、定期、日次、週次、月次を利用できます。\n重複排除 VMWareのChange Block Trackingに対応。\n暗号化転送\nバックアップデータの暗号化\n\nSynology NASの事前準備ABBのインストールNASのWeb画面に管理者としてログインし、パッケージセンターから”Active Backup for Business”をインストールします。\n\n\n上記はインストール済みの状態ですが、「インストール」ボタンをクリックしてインストールします。NASのFirewallを利用している場合は自動的にPort5510を開けるようにFirewallにルールが追加されます。\n可用性および機密性向上のために\nフォルダの容量制限（クォータ）についてはABBでは推奨されていません。\nESXiに対してSSHでの接続が必要です。セキュリティ向上のためroot相当の専用ユーザーをESXiに新規作成されることをお勧めします。\n\nESXiの事前準備ESXiには以下の設定が必要です。\n\nVMWare Toolsのインストールが必要です。\nABBからESXiに対しHTTPS(Port443)、SSH(Port22)を使って接続可能なようにサービスを設定します。\nABBで無償版ESXiをバックアップするためにはCBT(Changed Block Tracking)を手動で有効にする必要があります。\n（任意）セキュリティ向上のため、ESXi上に管理者アカウントを作成します。\n（任意）セキュリティ向上のため、Port22,443で接続可能なIPアドレスをESXi上のFirewall設定で絞ります。\n\nESXi上でHTTPS、SSHの解放無償版ESXiを使う場合はブラウザから基本はvSphere Web Clientを使いますので、HTTPS(Pprt443)の解放は特に意識する必要はありません。ESXiのファイアウォールで接続可能なIPアドレスを絞っている場合はNASのIPアドレスから接続できるようにしておきます。\nSSH(Port22)についてはESXiはデフォルトでサービス停止されている状態ですので、シェルおよびSSHのサービスを起動します。左ペインメニューのホストー管理のサービスタブからTSMおよびTSM-SSHを起動します。 この2つのサービスは右クリックメニューのポリシーからホストと連動して起動および停止しますをチェックしておく事でESXiの起動時に自動的にサービスが起動するようになります。\nVMのChanged Block Trackingの設定ESXiの機能であるChanged Block Tracking(CBT)はVMが稼働していて前回バックアップしたものから未更新のディスクブロックをスキップして差分のみバックアップする機能です。バックアップに必要な領域を削減できます。途中で別のバックアップ製品によるバックアップ、例えばghettoVCBなどでバックアップされると、次回のバックアップはフルバックアップを行います。\nこの設定にあたり、事前にVMのデータを退避することをお勧めします。VMを停止のうえで、データストアブラウザからVMの入っているフォルダ毎別の場所にコピーしてください。もし、設定の変更でVMを壊してしまった場合は、当該フォルダのVM名.vmxを右クリックから「VMの登録」で再登録できます。\n設定方法最初にVMがインストールされているディスクを調べ、そのSCSI-IDを確認します。ESXi管理画面のVMを選択し右クリックして設定の編集をクリックします。\n\n\nハードディスクの詳細を開き、コントローラの場所でSCSI-IDを確認します（SCSI(0:0)など）。\n\n\nVMを停止します。\nESXi管理画面のVMを右クリックして、設定の編集をクリックします。\nVMオプションタブをクリックします。\n詳細セクションを開き 設定パラメータの設定の編集をクリックします。設定パラメータダイアログが開きます。\nパラメータの追加をクリックします。\nctkEnabledパラメータを追加して、その値をtrueに設定します。\nさらにパラメータの追加をクリックし、scsi0:0.ctkEnabledを追加して、その値をtrueに設定します（環境に合わせてscsi0:0の内容は変更してください）。\nOKボタンをクリックし設定を完了させます。\nVMを起動します。\nSSHでESXiに入り、VMが配置されているディレクトリで、VM名-ctk.vmdkファイルがあることを確認します。\n\nCBTを無効にする場合はこの逆の手順、ctkEnabledの値をfalseに設定します。VMWareによるCBTの説明は以下を参照してください。\n\nVMware VM上の変更ブロックのトラッキング（CBT） (1020128) https://kb.vmware.com/s/article/1031873?lang=ja&amp;queryTerm=changed+block+tracking\n\n（任意）管理者アカウントの作成セキュリティの観点からrootはできるだけ使わない事をお勧めします。これは一般論でありrootがよく知られたユーザー名だからです。以下の手順で管理者アカウントを作成します。\n\n管理メニューの左ペインホストー管理からセキュリティとユーザーに進み、ユーザーからユーザーの追加をクリックします。\n\n\n\nABBから接続する専用のユーザー名とパスワードを登録してユーザーの作成を終えます。\n管理メニューの左ペインホストからアクションを選択し、プルダウンの権限をクリックします。\nさらにユーザーの追加を選択します。実際には上記で作成したユーザーと同一名のユーザー名を入力します。ロールについては”システム管理者”を選択します。\n\n\n\nこれで新しいユーザーが作成できたので、Web管理画面からログイン可能か確認してください。\n（任意）SSH、Web Clientのために接続可能なIPアドレスを絞るこの機能はESXiではファイアウォールと呼ばれ、Linuxのiptablesやufwと同様にシンプルなものです。ホームユーザーはシンプルなLANで閉じられたアクセスですが、安全のために特にSSHは設定を検討すべきです。Web管理画面の左ペインメニューの ネットワークを選択し、ファイアウォールタブをクリックして見つける事ができます。デフォルトでは一切の制約なく接続可能になっていますので、ここでSSHとWeb Clientに接続可能なIPを登録できます。\n\n\nABBの利用についてABBの使い方については公式のクイックガイドが提供されています。\n\nActive Backup for Business クィック スタート ガイド https://kb.synology.com/ja-jp/DSM/tutorial/Quick_Start_Active_Backup_for_Business\n\nABBでは管理者（Administratorsグループ）ユーザーのみが操作できます。\n仮想マシンのABBへの登録DSMからABBを起動します。\n\n\n仮想マシンを対象にします。\n\n\n最初にバックアップ対象となるESXiを登録します。\n\n\nバックアップ対象となるESXiのIPアドレス、アカウントを入力します。\n\n\nESXiに有効な証明書が設定されていないとワーニングが出ますが、ここはそのまま進みます。\n\n\nESXiへの接続が確認されチェックがOKであれば状態が成功となります。\n\n\nエラーとなった場合は、ESXi側の設定、またはネットワークを確認してください。\nバックアップタスクの登録無事にESXiの情報がABBに取り込まれると、仮想マシンの情報が出力されます。\n\n\n現在はバックアップが取得されておらず、タスクなしとなっています。\n上記のタスクの作成ボタンをクリックします。\n仮想マシンが選択されます。\n\n\nここでタスク名を入力します。ここでは、ESXi8のUbuntu22のバックアップを取るのでESXi8.Ubuntu22とします。\n続いてバックアップするフォルダを選択します。デフォルトでは、ActiveBackupforBusinessになります。\n\n\n最初のバックアップ時にフォルダの暗号化&#x2F;圧縮を設定します。私の場合すでに設定済みでありここでは変更できません。\n\n\nバックアップオプションを選択します。Windows、Linuxのバックアップ時にはアプリケーション対応バックアップを有効化にチェックすることが推奨されます。また、ESXiのCBTが有効である場合は変更ブロック　トラッキングを有効化のチェックが有効になります。\n\n\n改めて構成チェックが行われます。\n\n\n続いて定期的なバックアップの設定です。\n\n\n保持ポリシーを選定します。これはディスクの容量やバックアップ期間などに合わせて設定します。\n\n\n復元を許可するユーザーを設定します。\n\n\n最後のサマリで確認をし完了させます。今すぐバックアップを取得することもできます。\n\n\n仮想マシンのバックアップ実行64GBのシックプロビジョニングのUbuntu22の仮想マシンを手動でバックアップをしてみました。バックアップ速度についても計測してみます。\n環境\nESXi8\n\n\n\nパーツ\n製品名\n\n\n\nCPU\nAMD Ryzen5 5600G 6コア&#x2F;12スレッド 3.9-4.4GHz\n\n\nメモリ\n16GB(8GB×2) DDR4-3200\n\n\nNVMe\nWesternDigital Blue 500GB SSD &#x2F; NVMe M.2[PCIe 3.0×4]\n\n\nNIC\nMellanox Connect X5(MCX512A-ACAT) SFP28 2Port\n\n\nSynology 1621+\n\n\n\nパーツ\n製品名\n\n\n\nCPU\nAMD Ryzen V1500B クアッド コア 2.2 GHz\n\n\nメモリ\n8GB(4GB×2)\n\n\nSSD\nSamsung 870EVO 4TB(MZ-77E4T0B&#x2F;IT) &#x2F; SATA x 6(RAID5)\n\n\nNIC\nMellanox Connect X4(MCX4121A-ACAT) SFP28 2Port\n\n\nSFP28(25GbE)のスイッチポートにそれぞれDACケーブルで接続しています。\nログの結果も非常に詳細で分かりやすいです。ここはさすがソフトウェアが売りのSynologyですね。\n\n\n開発者が障害切り分けのために利用するログではなく、ユーザーに価値のある情報（ログ）を提供しています。これは他のメーカーとは根本的に出来が違います。\n通知設定しているとメールも届きます。\n\n**** のバックアップタスク ESXi8.Ubuntu22 が完了しました。 開始時間：2023-09-02 12:46 終了時間：2023-09-02 12:47 転送サイズ：24.7 GB デバイス リスト：Ubuntu22\n\n 送信元 ****\nまずは圧縮効果が出ており、64GBの仮想マシンが24.7GBとなっています。\nさらに30分後、もう一度バックアップを取得してみます。今度は数秒で終了しました。通知では3.1MBとなっていました。これはESXiのCBTが有効で差分のみバックアップするためわずかの量に収まっていることになります。仮想マシンの稼働時間が長くなるとそれだけバックアップ量も増えることになります。\nちなみに、同一の環境でghettoVCBスクリプトでバックアップを取得した場合は以下の通り35秒でした。\n2023-09-03 01:27:50 -- info: ============================== ghettoVCB LOG START ==============================2023-09-03 01:27:52 -- info: Creating Snapshot &quot;ghettoVCB-snapshot-2023-09-03&quot; for Ubuntu22Destination disk format: VMFS thin-provisionedCloning disk &#x27;/vmfs/volumes/datastore1/Ubuntu22/Ubuntu22.vmdk&#x27;...2023-09-03 01:28:23 -- info: Removing snapshot from Ubuntu22 ...2023-09-03 01:28:23 -- info: Backup Duration: 31 Seconds2023-09-03 01:28:23 -- info: Successfully completed backup for Ubuntu22!2023-09-03 01:28:25 -- info: ###### Final status: All VMs backed up OK! ######2023-09-03 01:28:25 -- info: ============================== ghettoVCB LOG END ================================\n\nABBの実行内容についてABBの実行している内容は、ghettoVCBとほぼ変わりません。ESXiのAPIでESXiのスナップショットを取得しつつ、無償版ESXiではバックアップ関係のAPIが使えないためSSHで各種操作をして仮想マシンの情報を吸い上げています。普段私はESXiにSSHで接続する際にはrootで公開鍵認証をしています（YubiKeyに秘密鍵を入れています）。ABBでは公開鍵認証は使えないようですので、今回示したように、別アカウントでパスワードを設定しています。ESXiのパスワードは他の用途を含めてABB以外では使うことがなく操作ミスなどによるパスワード漏洩の心配も不要です。\n復元ABBでバックアップを取得した日時（スナップショット）毎にESXiに復元します。\nABBの左ペインのメニューから仮想マシンを選択し、さらに実際に復元する仮想マシンを選択します。\n\n\n仮想マシンを選択した状態では背景が薄いグレーになりますので、ここで復元ボタンをクリックします。\n続いて、復元ポイント（バックアップを取得した日付と時刻）を選択し、VMWare VSphereへの復元を選択し、次に進みます。注釈で「ゲストOSファイル（Windows&#x2F;Linux）の復元の場合、Active Backup for Business Portalに進んでください」とありますが、これはファイル単位で復元したい場合です。ここではスナップショット単位に戻す事を目的としていますのでこの説明は省略します。\n続いて復元の仕方を選択します。\n\n\n仮想マシンの完全復元と即時復元との2種類があります。ここでは完全復元の例について記載します。\nなお、即時復元はNAS上で重複排除されてバックアップされたそのままの情報がESXiから見えるようになります。そこで仮想マシンを登録するなどすれば、すぐに仮想マシンを起動しその内容にアクセス可能となります。ただし、仮想マシンの実態はNAS上にあるのでパフォーマンスは落ちます。\n復元モードを選択します。\n\n\n元の場所に復元と新しい場所に復元、或いは異なる設定で復元との2種類があります。\n\n一般的にはMACアドレスはESXi上で動的に生成されますが、元の場所、つまりこれまでの仮想マシン同様のIPアドレス、構成で戻すのであればIPアドレスの引き継ぎなども鑑み、元のMACアドレスで戻すことになります。新しい場所、つまり新しい仮想マシンとして複製するのであれば、後者を選択します。\nなお、MACアドレスが静的な場合のオプションもありますがここでは割愛します。\nこの例では元の場所に戻します（仮想マシンの稼働中に復元します）。\n最後に構成の最終確認をして実行します。\n\n\n対象のデータストア、ネットワーク（VLAN）を念のため確認してください。\n復元後、自動的にVMの電源をオンにしますのチェックは手前が省けるのでオンで良いでしょう。構成を変更したい場合は外すなど状況に合わせて選択します。\n\nちなみに、私の構成では、vmfs/volumes/datastore1にUbuntu22というフォルダが作成され、その中に仮想マシンの関連ファイルが登録されています（新規に仮想マシンを作成した一般的な構成です）。\nESXiの稼働中の画面は以下の通りです。\n\n\nさて、実行中のアラートが表示されますがOKで続行します。\n\n\n実行結果です。\n\n\n普通にUbuntuにESXi管理コンソール経由で接続でき、SSHも問題ありません。仮想MACアドレスは同一のもので復元されておりIPアドレスも前回と同じものでした。復元動作は完璧です。\nさて、復元では留意する点として、仮想マシンのESXi上の管理IDが変わる事が挙げられます。\n復元後のフォルダ構成を確認しましたが、特にフォルダパスも変更はなく、復元前とは変更されたようには見受けられません。復元のログではテンポラリのフォルダを作成しているように見えますが、最終的にはvmfs/volumes/datastore1にUbuntu22というフォルダにて復元されています。\nESXiの管理IDは特に意識しない場合も多いのですが、ブラウザからESXiの管理コンソールを起動せずにいきなり仮想マシンを起動する場合は、vmrc://ユーザーID@ホスト名/?moid=管理ID　ですぐに仮想マシン（GUI）にアクセスできますが、このIDが変更されているので、ESXi管理コンソールで新しいIDを確認する必要があります。\nなお、これによってABBでバックアップしていた構成も変わることになるので、これまでタスク化されているバックアップは失敗することになりますので改めて仮想マシンの登録情報を編集しておく必要があります。\n\n警告,2023-09-03 12:42:22,前回のバージョンからのディスク [[datastore1] Ubuntu22&#x2F;Ubuntu22.vmdk] が見つかりません。それは削除されたか、あるいはパススルー、RDM、あるいは独立したディスクへ変更された可能性があります。バックアップ タスクはディスクをバックアップしません。\n\nこのエラーは構成情報の変更を検知したという事でしょう。私はこの対策として、旧環境でのバックアップの定期的な実行を取りやめる設定に変更し、新しいバックアップタスクを改めて作成するようにしています。それでしばらく時間が経過してから古いバックアップファイルを削除することにしています。\nまとめ非常に簡単なGUI操作で後は殆ど気にすることなく定期的な仮想マシンのバックアップが行えます。速度も必要十分で特に指摘する点は見つかりません。仮想マシンの一部のファイルを取り出したいなどのニーズにも応えられますし、本格的なバックアップソフトウェアです。小規模なビジネスやホームユーザーには十分すぎる機能を持ち合わせていると言えるでしょう。\n仮想環境としてESXiを選定するメリットとして、第一に使いやすさと安定性、セキュリティレベルが高いということが挙げられますが、こういったスタンダードなNASがESXiのバックアップをサポートしている事も大きなメリットではないでしょうか。\n","categories":["Software","Network"],"tags":["ESXi","10GbE","25GbE","Synology"]},{"title":"Synology DS1621+（DSM7.2）とSSD","url":"/new-technology/2023/07/27/Synology1621plus-ssd/","content":"\n\nこの記事で実現すること\n\nサイバー攻撃の話題が相変わらず賑やかな状況下、これまで使っていたNASのソフトウェアの安定性やセキュリティ面の不安があり、安定感のあるSynologyのNASにリプレースしました。昨今SSDが安くなってきた事もあり、節電兼ねてALL SSDのNASをセットアップしてみました。\n\n\n前提（私の使い方）私のNASの用途は、写真や動画のバックアップ、複数のPCで使う文書・PDFなどの同期兼バックアップ、仮想マシンやモジュールのバックアップ用途です。このブログなどはプライベートなものではないので、自宅で保存するよりGitHubのパブリッククラウドに置いておくほうがより現実的ではありますが、操作ミスで消えるリスクも鑑みNASにバックアップを取得しています。\n今のところ、TVや映画などの動画を保存する用途にはしていないので、容量だけでいえば1ベイか2ベイのNASで10TBあれば十分です。特殊要素があるとすれば、仮想マシンのバックアップを頻繁に取得するので、できるだけバックアップ速度を求めます。そういう意味では10GbEのネットワークは必須です。\nNASでは仮想マシンを稼働させる事もできますが、私の用途としてはESXiを一般的なPCにセットアップし、複数の仮想マシンを稼働させているので、NASはストレージがメインです。Windowsファイル共有（SMB）、NFS、iSCSI、せいぜいsyslog、SQLデータベースあたりまで使うといったところです。Ubuntuは個人向けにウィルス対策ソフトが存在しないので、Ubuntuのブラウザでインターネットにアクセスする事は殆どなく、モジュールのダウンロードは（ウィルス対策ソフトが有効な）macOSかWindowsでダウンロードしたものをSMBで共有してUbuntuで利用することが殆どです。\nNASの使い方は利用者によって様々でしょうから、あくまで一例ということでご覧ください。\nSynology機種選定6ベイ〜8ベイ程度のNASでそろそろ新モデルが出るかなと思い、年初くらいからウォッチしていましたが、発表されたのはDS1823xs+で、30万円と高額でした。周辺機器の互換性としてEnterpriseクラスの製品が中心で、個人向けとしては少し不向きだなと感じました。メモリは厳格に互換性を重視しつつも、SSDは必ずしも互換性のドライブでなくても良いかと考えていましたが、Enterpriseクラスの厳格性で10万円超えクラスの製品レベルを求められるとコスト面でかなり厳しいと感じました。現行モデルとの比較は以下の通りです。最初からSFP+のネットワークカードを増設する前提で、それなりにCPUパワーのある機種の比較です。10GbE以上の場合、どこまでスループットが出るかという期待も含めての選定です。\n\n\n\n機種\nCPU\nCPU TDP\n製造プロセス\nベイ\n実売価格\n\n\n\nDS1823xs+\nAMD Ryzen V1780B クアッド コア 3.35 GHz\n45W\n14nm\n8\n30万円\n\n\nDS1821+\nAMD Ryzen V1500B クアッド コア 2.2 GHz\n16W\n14nm\n8\n16万円\n\n\nDS1621+\nAMD Ryzen V1500B クアッド コア 2.2 GHz\n16W\n14nm\n6\n12.5万円\n\n\n意外にも、最新機種のDS1823xs+の製造プロセスは14nmで現行モデルと変わりません。DS1621+&#x2F;DS1821+の現行モデルは発売後2年半が経過しています。それなりに長期間使うことになるNASはEOSLを気にする必要があります。ただし、2012年モデルでもセキュリティパッチはきちんと提供されているので、Synologyのソフトウェア保守に対する考え方は非常にしっかりとしています。2018年に発表されたDS1618+（CPU:intel Atom C3538）は発売後5年でDiscontinuedになっていますが、あくまで製造中止であって、サポートはフルに提供されています。さらに、DS1621+&#x2F;DS1821+は新発表されたDS1823xs+とCPU世代が同じなので、長期的なサポート継続が行われると考えられます。\nちなみに、V1500BやV1780Bは2つの10GbEチップを内蔵しているんですね。ただし、DS1621+&#x2F;DS1821+には10GbEの口はありません。DS1823xs+は1つの10GbE(RJ45)があるのでその10GbEを活用しているということでしょうか。\nということで、Synologyはソフトウェアが秀逸である反面、少し高いというイメージを持っていたのですが、実売価格として廉価なDS1621+を購入することにしました。メモリが4GBなので、純正ECCメモリ（1.5万円）4GBを追加し8GBとしました。\nSynologyの保守に関する注意点としては、購入後の保証期間が過ぎたハードウェアの有償修理は行われないという点です。特殊なハードウェアだと電源やファンなど代替品というのも簡単には見つからないのでそこだけが留意する点でしょうか。故障が気になる方は延長保証を検討する必要があります。私は故障した場合は「さだめ」と割り切って新しいハードウェアを買う理由が見つかるので延長保証にはしていません笑\n\nSynology 製品サポート状況 https://www.synology.com/ja-jp/products/status\n\nSSD\n\nSynologyとしては公式には互換性確認が取れていないSamsungの870EVO 4TB(MZ-77E4T0B&#x2F;IT)が28,000円程度だったこともあり、6つ購入しました（最初に1台購入し、動作確認の上で追加を5台買いました）。仕様は以下の通りTLCで速度、耐久性を重要視しました。\n\nインターフェース (転送速度・規格値）：SATA 3.0(6Gbps) ※SATA 2.0(3Gbps)およびSATA 1.0(1.5Gbps)互換フォームファクタ：7mm厚2.5インチHDD互換［搭載デバイス］NANDフラッシュ：Samsung 3bit MLC (TLC) V-NANDコントローラ：Samsung MKXコントローラキャッシュメモリ：2GB LPDDR4［パフォーマンス］シーケンシャル：読み出し560 MB&#x2F;s、書き込み：530 MB&#x2F;s\n5年間または最大2,400TBWの限定保証\n\n4TBのSSDといえば、つい昨年は8万円くらいしていたと記憶していますが、廉価になるスピードも早いですね。世の中では半導体が不足していると言われる一方で、個人向けPCの販売不振によって、SSDなどのパーツが余剰在庫で値崩れしていると聞きますので、SSD全般に関しては今はお得な時期と言えるでしょう。\nDS1621+にはM.2-2280のNVMeキャッシュも搭載可能ですが、SSD RAID5の分散であればキャッシュを必要としない程度に十分な速度が出るものと見込んでいます。キャッシュだけだと見かけのベンチマークは良い数字が出るでしょうが、安定して読み込み・書き込み速度を出すにはSSDでシンプルな構成が一番と考えます。\nなお、このストレージのセットアップ時には互換性の無いDiskである警告メッセージが表示されます。また、Synologyアカウントのページには以下の記載があります。\n\n以下の状況ではテクニカル サポート サービスは提供されません。 Synology互換性リストに記載されていないデバイス（ドライブ、メモリモジュール、PCIeカードなど）を使用する。\n\n一度セットアップした後は警告メッセージは表示されていません。\nNASというグループではなく、ConsumerというクラスでSynologyの互換性について検索すると、850EVO、860EVOが一覧に表示されます。何れ870EVOがサポート対象になるのを願うことにします。\n\nSynology 製品互換リスト（機種指定なし） https://www.synology.com/ja-jp/compatibility?search_by=category&amp;category=hdds_no_ssd_trim&amp;filter_brand=Samsung&amp;filter_class=Consumer&amp;display_brand=other\n\nなお、Synologyの互換性試験を軽んじているわけではありませんし、なるべくは互換性のあるものを使おうと考えてはいます。ただし、DS1621+に関してSSDはサードパーティ製で認められたものはなく、SynologyのEnterpriseドライブのみで4TBだと価格が15万円&#x2F;個なので、これは個人で購入するのは困難でしょう。メモリやSSDキャッシュ用途であれば流石に互換性を重視した製品選定をしますが。。。\nNIC\n\nこのブログでは定番のMellanox Connect X4(MCX4121A-ACAT)を選定しました。ebayで1枚$70〜$80（日本円で約1万円）程度です。Synologyで正式に互換性検証されたものは、intel X710-T4がありますが、Connect X4は互換性リストにはありません。1つ昔のモデルのDS1618+はConnect X3には対応しているようです。Connect X4がダメなら純正のSFP28カードを購入するつもりでした。\n前出の互換性リストを見ると、Mellanox Connect X4に対応しているSynology NASもそれなりの数があるようです。\n\nSynology 製品互換リスト https://www.synology.com/ja-jp/compatibility?search_by=category&amp;category=network_interface_cards&amp;display_brand=other\n\nハードウェアインストールメモリ筐体の底の部分に蓋があり、それを外すとメモリモジュールを挿すところがあります。シール付きの別売りモジュール（4GByte）を装着したところです。\n\n\nDiskStationManager（DSM）セットアップDS1621+は今更珍しいハードウェアでも無いですし、DSMのセットアップ情報も世の中に多くあるので、手順については省略します。最初はLAN1にRJ45のCat6ケーブルを接続しセットアップしました。インターネットに接続されている環境で無事DSM7.2のセットアップが完了しました。\n論理Disk（ストレージプール）は初心者向けのSynology Hybrid RAID、または通常のRAIDを選択できますが、速度を重視し、RAID5としました。ダウンタイムを気にしてRAID6にするほど安全第一という事もなく、かといって、RAID0にして故障の際に大掛かりなリカバリのリスクを抱えたくも無いということで無難な選択です。6台のSSDすべてを1つの論理DISKとしてパリティの分散によって障害リスクの抑制、高速化を目指すことにします。\n以前のNASでは、こういった論理ボリュームを作成後、利用するアプリケーションや目的毎のデータサイズによってストレージプールの中にそれぞれのボリュームを作成していました。例えば、macOSのバックアップであるTimeMachineなどでは、決められたディスクサイズの中で最新世代のバックアップを確保する仕組みとなっており、ディスクの容量を事前に決めておかないと（クオータ）、肥大し続ける事になります。PCで言えばパーティションのようなものですね。また、別の目的では仮想マシンのバックアップなどは世代管理も含めて、どれだけのDisk容量を確保すべきかある程度運用しないとわかりません。意外と圧縮が効いて無駄にボリュームの空きができてしまう事はよくある課題です。また、複数ボリュームを作成するとスループットは落ちます。\nNASはこの辺りの事前の計画がとても難しいのですが、DSM7では単一ボリュームに共有フォルダを作成する時にフォルダのサイズ制限を設定できます。これができればわざわざ複数ボリュームを悩みながら作成する事も不要です。これが実現できるのはSynologyがアピールするBtrfs（バターエフエス）ファイルシステムのおかげです。Btrfsではスナップショットを取得してバックアップする際、バックアップ中にファイルが更新されて一貫性が失われないとのことです。ファイルシステムもデータベースの仕組みに近くなっていくんでしょうか。\n\nSynology ナレッジセンター\n\n https://kb.synology.com/ja-jp/DSM/help/DSM/AdminCenter/file_share_create?version=7#sharedfolderquota ストレージがBtrfsファイル システムを使用している場合に限り、共有スペースに共有スペースの割り当てを有効にするオプションをできますます。\n\nESXiの仮想マシンのバックアップのために、 SynologyのActive Backup for Businessを使うつもりですので、これは64ビットOSとBtrfsが必須となります。Disk構成は以下のようになりました。\n\n\n\n\n消費電力SSD6台、Mellanox Connect X4を装着した状態で、ワットチェッカーで計測してみました。以下の通り、おおよそ33W-35W程度で安定しています。なかなかの省電力です。以前に利用していたNASは4台のHDDという事もあり、70W-100W程度でかなり発熱も大きかったのがかなり改善されました。\n\nSynology（SSDx6、Mellanox Connect X4） （33W-35W）\n\n \n\n\n旧NAS（HDDx4、Mellanox Connect X3） （70W-100W）\n\n \n\nネットワークセットアップ終了後、無事Connect X4はNASに以下のように認識されていました。\n\n25000 Mbps, 全二重, MTU 1500\n\n2つのPortがあるので、1つは25GbE、もう1つは10GbEとして使ってみます。\nお決まりのiperf3の計測です。Connect X4をSFP28でスイッチに接続します。クライアントはWindows11でこちらもConnect X4です。Synologyのコミュニティから提供されているSynoCli Monitor Toolsというパッケージがあり、これをインストールして使ってみます。この組み合わせでは上り、下り共に19〜21Gbps程度であり、及第点という感じでした。\nWindows -&gt; Synology（多重度2）\n[ ID] Interval           Transfer     Bitrate[SUM]   0.00-10.00  sec  22.3 GBytes  19.1 Gbits/sec                  sender[SUM]   0.00-10.00  sec  22.3 GBytes  19.1 Gbits/sec                  receiver\n\nSynology NASとESXi上のUbuntuのiPerf3の結果は上り、下り共に十分なパフォーマンスが出ています。\nSynology -&gt; Ubuntu\n[ ID] Interval           Transfer     Bitrate[  5]   0.00-1.00   sec  2.33 GBytes  20.0 Gbits/sec[  5]   1.00-2.00   sec  2.59 GBytes  22.3 Gbits/sec[  5]   2.00-3.00   sec  2.72 GBytes  23.4 Gbits/sec[  5]   3.00-4.00   sec  2.59 GBytes  22.2 Gbits/sec[  5]   4.00-5.00   sec  2.71 GBytes  23.3 Gbits/sec[  5]   5.00-6.00   sec  2.72 GBytes  23.4 Gbits/sec[  5]   6.00-7.00   sec  2.73 GBytes  23.4 Gbits/sec[  5]   7.00-8.00   sec  2.70 GBytes  23.2 Gbits/sec[  5]   8.00-9.00   sec  2.70 GBytes  23.2 Gbits/sec[  5]   9.00-10.00  sec  2.69 GBytes  23.1 Gbits/sec- - - - - - - - - - - - - - - - - - - - - - - - -[ ID] Interval           Transfer     Bitrate         Retr[  5]   0.00-10.00  sec  26.5 GBytes  22.7 Gbits/sec   22             sender[  5]   0.00-10.00  sec  26.5 GBytes  22.7 Gbits/sec                  receiver\n\nDisk速度定番のCrystal Diskmarkのベンチマークを実施します。\n25GbE(SFP28)で計測\n\n読み込みは17Gbps、書き込みは14.3Gbpsと、かなり高いスループットが出ています。11Gbps-12Gbps程度であれば省電力を優先し10Gbpsで使おうと考えていましたが、迷いどころです。私が速度を重視するメインの使い道はESXiの仮想マシンのバックアップですので、それはまた別の機会に計測してみます。\n10GbE(SFP+)で計測 \n\n 10GbEの場合は、読み込み、書き込みともにワイヤレートが出ており、バランスの良い組み合わせでしょうか。NICをSFP+の10GbEにして、もう5W程度省電力を狙うというのも良いですね。\n25GbE(SFP28)にパケット署名を付けて計測 \n\nビジネスではセキュリティの観点からほぼ必須と指摘されるSMBのパケット署名ですが、意外と落ち込まないですね。これも実運用するには十分な速度が出ています。\nその他、素晴らしい機能以前のNASからリプレースして便利に感じた機能をいくつか挙げてみます。\n\n2要素認証（TouchID、Windows Hello） DSMに2要素認証でログインする場合は、圧倒的に便利です。パスワードレスでTouchID、Windows Helloのみの認証にもできます。 なお、YubiKeyのFIDO2も使えますが、PINもあって少し不便に感じます。YubiKeyはDSMへのSSHを公開鍵認証で使っています。iOSアプリのSecure SignInは自宅にいない場合に公衆回線を通じて2要素認証のためのサインインの通知が来るのは良いのですが、許可をタップするとNASへ直接接続しようとするようで、自宅のWi-Fiに接続していない場合は認証がうまく動作しません。これはいずれ機能アップして修正されることを期待します。SynologyのNASはTailScaleのアプリがインストールできるので、これを組み合わせる事で対応できるかもしれません。\n\n\ntailscale  https://tailscale.com\n\n\nログセンター（Syslog） グラフィカルで分かりやすいです。ネットワーク機器のログを集めるのに使っています。このおかげでSyslogのために別の仮想マシンを用意する必要は無さそうです。以前のNASではフィルタ機能が十分でなく、使っていませんでした。Synologyでは演算子を使っていろいろな条件で絞り込みができます。個人でのログ確認には必要十分です。\n\n 絞り込みも優秀で、ホスト名を入力させるのではなく、すでにログ出力されているホスト名から選択できます。  \n\nストレージアナライザー\n\n   \n ファイルサイズの大きいもの順に確認できたり、重複ファイルを確認、削除できます。データの見える化ができて、とても便利です。\n\nファイアウォール これはアプリケーションの自動ブロックと連動していて、このブロックが働いた時、つまり明らかな不正ログインの懸念がある場合のみ通知されます。ですので、普段から通知されることはありません。以前のNASでは許可していないサービスにIPレベルでパケットが到達した段階でエラーとカウントして膨大な件数の拒否カウントが定期的に通知されており、結局通知を止めていたのですが、こちらは現実的なファイアウォール機能となっています。\n\nさまざまなサービスとパッケージが自動ブロックをサポートします。例：DSM、SSH、Telnet、rsync、ネットワーク バックアップ、共有フォルダの同期、FTP、SMB、WebDAV、File Station、Audio Station、Video Station、Download Station、Mail Server、Mail Station、MailPlus、MailPlus Server、VPN Server、Synology Drive Server、および Synology モバイル アプリ。\n\n\nSynology Drive　NASでは一般的な機能で、複数クライアント端末とファイル同期を取るソリューションです。以前のNASでは小さいモジュールがたくさん存在するフォルダ、特にGitで使うようなソースコードや小さいモジュールのファイルは、conflict(0)のような競合ファイルがたくさん発生してしまい、全く使えずにいました。GitHubへのプッシュする際に大量の誤ったプッシュ候補のファイルが表示されてしまい、泣く泣く変更したファイルをロールバックする羽目になりました。他の端末との同時更新などの競合がある訳ではなかったのですが、それ以来、一般的な文書のみに使っていました。今回、SynologyのNASになってからはまだ日が浅いですが、このような小さいモジュール群も安定して複製してくれ、複数端末で同期が取れています。\n\nDSM画面のレスポンスが良いこと　どのアプリケーションを稼働させても、ウィンドウがもたつくことはありません。\n\n\nまとめSSDが安くなったおかげで、今回は廉価にNASのリプレースが出来ました。SSDキャッシュはベンチマークこそ良い成績が出ますが、実際の運用においてはなかなか効果を感じづらいところがあります。NVMeではなくSATAなので大きな期待はしていませんでしたが、かなりの速度が出ることを確認できました。私の利用方法は少し特殊と考えられますが、Synologyのソフトウェアが素晴らしいことで、NASを利用している時のストレスが本当に減りました。前述したSyslogや重複ファイルのチェックなど、本当にユーザーフレンドリーで使いやすく他社のNASから乗り換えた時にはこのDSM7.2を使うと、その使い勝手の良さに驚かれるでしょう。またストレージの消費量もかなり低く抑えられています。最近、SynologyはエントリーモデルにおいてもBtrfsに対応するようになったので廉価でも高性能なNASとして利用できそうです。今はNASのバックアップを外付けのHDDにしていますが、あまりに使い勝手が良いので廉価なビジネスモデルにリモートコピーでバックアップを取得するのでも良いかなと思い始めています。\n","categories":["Hardware","Network"],"tags":["10GbE","25GbE","Synology"]},{"title":"Ubiquiti Cloud Gateway Ultra","url":"/new-technology/2024/06/25/UCG-Ultra/","content":"\nこの記事で実現すること\n\nUniFiの新しい小型ゲートウェイUniFi Cloud Gatewayのセットアップ、機能紹介、ホームユーザー向けのセキュリティ対策の実例を掲載しています。検証のため製品提供を受けていますのでこの記事はPR要素を含みます。\n\n\nCloud Gateway Ultra（UCG-Ultra）3月には、UniFi初心者向けにUniFi Express（UX）の導入に関する記事を記載しました。UXはワンルームなどの比較的限られた範囲のWi-FiとUniFiゲートウェイがAll in oneとなったハードウェアですが、新しく発売されたCloud Gateway Ultraは、 Wi-Fi APやネットワークスイッチなどを追加、拡張することを想定しているゲートウェイです。Ubiquiti製品の一番人気はなんといってもアクセスポイント（Wi-Fi）ですが、複数のAPをはじめ、スイッチも拡張を想定するユーザーが購入対象となるでしょう。米国では$129と極めて廉価です。\n手短にUCG-Ultraを説明すると以下の通りです。\n\n30以上のUniFiデバイス&#x2F;300以上のクライアントサポート、1 Gbps IPSルーティング、およびマルチWANロードバランシングを備えたコンパクトなCloud Gateway\n\n\n\n 日本におけるUbiquitiの知名度もだいぶ上がってきたと感じています。これからUniFiを導入したいユーザーとしては、まず通信の見える化のためにUniFiゲートウェイを導入し、随時、人気のあるAPを追加していきたいと考えられているのではないでしょうか。私個人としては、UCG-UltraはIDS&#x2F;IPSも装備されているので自宅環境のセキュリティ面の強化という意味で期待ができるものと考えています。\nUCG-Ultraの説明ページ製品の説明ページは以下になります。\n\nUCG-Ultra https://jp.store.ui.com/jp/ja/pro/category/cloud-gateways-compact/products/ucg-ultra\n\n\nWAN:2.5GbE RJ45ポートx 1\nLAN:GbE RJ45ポートx 4\nIDS&#x2F;IPSスループット1Gbps\nLTEバックアップによる追加のインターネットフェイルオーバー\nアプリケーション認識ファイアウォールルール\nシグネチャベースのIDS&#x2F;IPS脅威検出\nコンテンツ、国、ドメイン、広告のフィルタリング\nVLAN&#x2F;サブネットに基づくトラフィックセグメンテーション\n完全なステートフルファイアウォール\nワンクリックのTeleportおよびIdentity VPN\n\nこの記事でのインターネットの構成私はauひかりホーム（10ギガ）を導入しており、貸与されたホームゲートウェイ（HGW）があります。その後ろにUCG-Ultraを配置する形式となります。\n\n\nセットアップUCG-Ultraはスマホだけでセットアップ可能です。アプリをダウンロードし、Bluetoothで接続して行います。\n製品と付属品です。本体、電源ケーブル、30cmのLANケーブルが付属します。\n\n\nPortはWAN（2.5Gbps）x1、LAN（1Gbps）x4です。\n\n\nさて、説明書のQRコードをiPhoneのカメラで読み込み、スマホアプリ（UniFi）をダウンロードしましょう。\n\n\nUbiquitiのアカウントを作成します。https://account.ui.com/login\nスマホアプリUniFiを起動後、UIアカウントにログインします。スマホアプリがBluetooth経由でUCG-Ultraを見つけると画面にセットアップ開始を促します。\n\n\n\n\nUCG-UltraにはWi-Fiは無いので、UCG-Ultraの名前を決めたらセットアップが完了します。また、途中インターネット速度テストが行われ、さらにファームウェアのアップデートが自動で行われていきます。\n\n\nWAN　Portの速度である2.5Gbpsの速度がきちんと出ています。\n\n\nあっさりとセットアップ完了です。\n\n\nファームウェアの自動更新が行われます。\n\n\nここまで、全く迷うことがありません。\n初期画面さて、アプリの表記では、HGWのDHCPによって割り当てられた192.168.0.2というUCG-UltraのWAN側IPアドレス、および、LAN側のIPアドレス192.168.1.1が振られています。\n\n\nLANのネットワーク、WANの情報が表示されています。LANはデフォルトVLANが1となっています（かつネイティブVLAN（タグ無し）。WANにはバックアップとしてのSecondary表記があります。今回はPrimaryをauひかりに接続していますが、別の回線または公衆回線（SIMを使う無線ルーター）に接続できます。\n\n\n設定から、コンソールを選択すると、コンソール管理画面が表示されます。UniFi OSはv3.2.18となっていますが、Networkアプリケーション（UNA）はUpdate可能なようです。早速Updateをタップします。\n\n\n\nUCG-UltraのUNAはv8.2.93となりました。\n今回は初回操作なので手動でアップデートすることにしましたが、毎日夜中3時に自動でアップデートチェックが行われ、自動でアップデートされます。また、Release Channelについては、”Official”(通常）、”Release Candidate”（リリース候補）、あとはUIアカウントのページから”Early Access”(ベータ版）を有効にすれば、3つのバージョンを選択できます。\n\nUI Account https://account.ui.com/profile\n\n慣れるまではOfficialにしておくのがお勧めです。Early Accessは事前確認する利用条件にある通り、守秘義務が存在します。許可なくその内容を第三者に開示してはいけません。安定しない場合も多く、広くユーザーに互換性を確認してもらうためのものです。\nさて、ここまでで初期セットアップは完了です。この段階でUCG-Ultraはインターネットへ接続可能になっているので、設定で利用したスマホアプリはUbiquitiクラウド経由でUCG-Ultraの操作が可能となっています。自宅でも外出中でもUCG-Ultraを操作できます。Cloud Gatewayという名前に相応しい基本機能です。\nセットアップの補足私の環境（auひかり）ではとても簡単にセットアップが完了しました。なお、UniFiのゲートウェイ全般は現在、Officialリリースにおいてインターネットマルチフィード社が提供するtransix IPv4接続 (DS-Lite) への対応はされていますが、その他のIPv4 over IPv6の対応は現時点でサポート外となっています。\nUniFiゲートウェイに関するガイドを以下に記載します。\n\nネットワークが不安定、Lineなどでやり取りができなくなる。 以下のガイドにMSS Clampingの設定で解決するという投稿がありますので確認ください。 Facebook Ubiquiti日本公式コミュニティ\n\n https://www.facebook.com/groups/uijapan/learning_content/?filter=167949146143924&amp;post=3507234616157550 この設定についてはUCG-Ultraにブラウザでログインし、WANのMSS Clampingの値をCustomの1414や1420等に設定する必要があります。具体的な設定はISPにより異なります。\n\nIPv6 IPoE transix IPv4 (DS-Lite)の設定手順｜Ubiquiti UniFi\n\n https://note.com/ui_japan/n/n3154ff641db5\nインターネットマルチフィードのDS-Liteは以下のISPが対象となります。\n\n株式会社インターネットイニシアティブ IIJ IPv6 FiberAccess&#x2F;Fサービス タイプIPoE\n株式会社インターネットイニシアティブ IIJmioひかり\n株式会社インターネットイニシアティブ IIJmio FiberAccess&#x2F;NF\n株式会社インターリンク ZOOT NATIVE\nエキサイト株式会社 excite MEC光\nエキサイト株式会社 BB.excite光Fit\nエキサイト株式会社 BB.exciteコネクトIPoE接続プラン\nスターティア株式会社 マネージドゲート2\nメディアウェイブシステムズ株式会社 Hybrid64 (ハイブリッド・ろくよん）\nメディアウェイブシステムズ株式会社 メディアひかり\n\n（引用： https://www.mfeed.ad.jp/transix/customers/）\nFacebookのUbiquiti日本公式コミュニティの情報によれば、ASAHIネットなど、対応ISPを増やす対応に取り組まれているようです。なお、PPPoEやDS-Liteのデータ転送時に、MSSの調整、すなわちデータ部分を切り詰める必要が発生するのは仕方のない事です。ネットワーク機器は専用チップ（ASIC)が処理する事が基本であり、CPUがデータ処理すると、途端にパフォーマンスがダウンしてしまいます。これは一般的に考えられるよりもネットワーク機器のCPUが非力なためです。UCG-UltraはUXよりCPUが強化され、IDS&#x2F;IPSが実行できるようになりましたが、それでもスマホ相当であり、小型PCと比較しても非力です。\n\n\n\nCPU\nCPU Mark\n\n\n\nARM Cortex-A53 4 Core 1512 MHz※UCG-Ultra\n472\n\n\nIntel   Celeron J1900 @ 1.99GHz\n1,150\n\n\nIntel N100\n5,552\n\n\n\nPassmark software https://www.cpubenchmark.net/cpu_list.php\n\n日本は世界の中でも通信速度においては先進的であり、日本のユーザーの目線が高いのは事実です。PPPoEが存在するのは日本に限った話ではありませんが、PPPoEとIDS&#x2F;IPSとを併用するとCPUパワーも必要になりパフォーマンスの問題は発生しやすいようです。UCG-Ultraの技術仕様のIDS&#x2F;IPSの項には「ISP の実装によって PPPoEでは性能が低下する可能性があります。」と記載されています。\n私が利用しているauひかりは、PPPoEやDS-Liteを使わず1,500バイトをLAN同様に転送できますので、パフォーマンスの問題は発生しません。他にもCATVなどもこういった問題にはあまり関わる事がありません。一方、DS-LiteなどではIPv6の複数サブネットの配布（Prefix Delegation）は魅力的なのも事実でありISPの選定は悩ましいものがあります。\nなお、ここではIPv6の説明は割愛しますが、auひかりのホームゲートウェイ（HGW）からUXにPrefix DelegationでIPv6サブネットを1つ割り振る設定を以下の記事で記載しています。その他、通知機能やSSH、プライベートDNS、VPNなどの基本設定についても記載しています。\n\nUniFi Express\n\nUbiquiti日本公式コミュニティ\n\n\n https://www.facebook.com/groups/uijapan\n初期セットアップは終了し、Windows PCをUCG-Ultraに繋いで、IPv4、IPv6の割り当てが確認できました。\n\n\nWindowsは以下のようにIPアドレスが振られています。\nWindows IP 構成イーサネット アダプター イーサネット:   接続固有の DNS サフィックス . . . . .: localdomain   IPv6 アドレス . . . . . . . . . . . .: 240f:103:xxxx:3:17f7:xxxx:xxxx:4c40   一時 IPv6 アドレス. . . . . . . . . .: 240f:103:xxxx:3:2594:xxxx:xxxx:e4c7   リンクローカル IPv6 アドレス. . . . .: fe80::7baf:af2:aa9:55a0%18   IPv4 アドレス . . . . . . . . . . . .: 192.168.1.170   サブネット マスク . . . . . . . . . .: 255.255.255.0   デフォルト ゲートウェイ . . . . . . .: fe80::xxxx:xxff:fexx:xxxx%18                                          192.168.1.1\n\nUCG-Ultraを利用したセキュリティ強化UCG-Ultraは何が出来るのかセキュリティに関しては話をシンプルにするため、一旦IPv4のみ割り当てが行われた状態で確認していきます。\nジオロケーションIPアドレスによる国別の認識が出来ています。\n\n\nトラフィック識別\n\nIDS&#x2F;IPSの設定をしていない初期設定状態でもトラフィックの識別はできています。この状態でのPCのスピードテストはワイヤレート（下り947Mbps&#x2F;上り942Mbps）の速度が出ています。\nIDS&#x2F;IPSIDS&#x2F;IPSの説明は以下の通りです。\n\n\n\n略称\n名称\n動作\n\n\n\nIDS\nIntrusion Detection System\nアラートのみ\n\n\nIPS\nIntrusion Prevension System\n防御（当該通信をReset）\n\n\n一般的にブラウザで利用するトラフィックは一般的に9割以上がhttps通信と言われており、SSL&#x2F;TLSにより暗号化されています。暗号化されている通信はその間にUCG-Ultraが入り込んでも情報を奪取できません。それでもトラフィック識別ができているのは、接続先のIPアドレスに加え、SSL&#x2F;TLSによるハンドシェイク時にリクエストされるSNI（Server Name Indicator）が平文で相手のFQDNをリクエストするため、どんなアプリケーションを利用しているのか判定する事が可能になっています。例えば、Appleのサイトにhttps接続する場合に最初のハンドシェイク時にSNIの情報が確認できます。\n\n\nUCG-Ultraで識別が不能な場合は、UniFiのトラフィック識別においてSSL&#x2F;TLSで一括りとなっています。またhttps通信をTCPではなくUDPを使い高速化したQUICプロトコルもあります。セキュリティレベルの高い事業者では、このQUICを認めないなどもある一方でGoogle系サービス（Gmail、Youtube）や国内の大手報道機関ではQUICプロトコルが採用されています。正直、SSL&#x2F;TLS、QUICが通信の大半と予想されます。\nユーザーとしては疑わしい通信は排除するIPSが一般的に使われます。しかしながら前述の通り暗号化された通信が大半である環境下において、IPSがシグネチャベースで検出する能力を持っていても、暗号化されたパケットは検査できません。これを実現するならばSSL&#x2F;TLSインスペクションといったSSL&#x2F;TLS解析の仕組みが必要ですが、大量のCPUリソースを使うことや端末毎にCA証明書のインストールが必要であるため個人向けには一般的ではありません。\nマルウェアやウィルスが配布されるような危険なサーバーに接続しようとしたところでDNSやIPS（SNIによる接続先検証）で防御することがまずはホームユーザー向けの対策と言えるでしょう。\n広告ブロックUNAの設定（歯車アイコン）から、セキュリティを選択します。ここでは広告ブロックにチェックしておきます。他に追加の設定は不要です。DNSシールドはDNSによる名前解決時にDoH（DNS over HTTPS）を使い、GoogleまたはCloudflareで名前解決するものです。TLS&#x2F;SSLで暗号化されているので、プロバイダや途中の経路において、どこにアクセスしているのか判らないようにする目的があります。日本のISPはDDoS対策のために独自のDNSフィルタを実施していることや、その情報を売却するなどの行為が厳しいために日本においてはDNSシールドの重要性はあまり無いものと考えられます。なお、このDNSフィルタを使っていても、広告ブロックは有効です。\nUCG-Ultraを使ったセキュリティの高め方UCG-Ultraを使ってどのようにセキュリティを高めるかという観点では、使える機能は使うべきということになるでしょう。利用することで特にデメリットとなることはパフォーマンスに関する観点くらいだと考えられます。\n\nIoT機器をお持ちであれば、PCなど多くのInternetとやり取りする機器とはネットワークを分離する。同様にリモートワークで使う会社貸与のPCなども自分が所有するPCとは分離することをお勧めします。これはタグVLANを設定し実現します。UniFiのAPを使うことでさらにSSID毎に属するVLANを変えられます。\n広告フィルタを行う。これは広告サイトが必ずしも安全とは言えないこと、不要なトラフィックが減らせます。\nIPSでリスクのあるサイトをブロックする。不要なVPNサイトが止められリスクを軽減できます。\n国別フィルタを使って不要国を止める。米国から一定量の攻撃がある事からも米国を止めるのは現実的でありませんが、普段アクセスしない国が明確なのであれば停止すべきでしょう。\n\n国別フィルタ、IPSの具体例設定はとても簡単です。一例としては以下の通りです。\n\n\nフィルタリングは通知とブロック（IPS相当）とし、検出感度は高めに設定してあります。さらに、ネットワーク（LAN）の画面からコンテンツフィルタを有効にします。\n\n\nコンテンツフィルタリングは仕事、家族と選択できますが、家族にしておけばVPNを止められます。\n国別フィルタは、フィルタをすり抜ける可能性もあります。中国のメーカーであっても、サーバーをAkamai（セキュリティベンダー）上に構築していたり、コンテンツデリバリネットワーク（CDN）やCloudflareにあれば同様に判定が難しくなります。\nまた、危険なサイトに関する情報についてはIPv4に関しては情報共有は積極的に行われるものの、IPv6についてはその情報共有が少ないのが実情です。今後、IPv6のコンテンツフィルタ機能が拡充されたとしても、IPv4だけのネットワークの方がセキュリティ上は安全ともいえるジレンマを抱えることになります。\nUCG-Ultraではロシアや中国企業のWebサイトでアクセスできない（パケットは拒否される）事を確認できています。フィッシングの手口ではこれらの国はよく使われるため、これらの抑止策はフェールセーフとして期待できます。\n私の環境ではこの設定を行った上でのInternet速度テストは以下の通りでした。\n\n\nダウンロードが947Mbpsから925Mbpsに下がりましたが、殆ど誤差でしょう。私の環境だと、パフォーマンスを意識してセキュリティレベルを下げる必要は無さそうです。\n(2024-06-27追記)なお、UCG-Ultraのスペックシートでは、IPS利用時に1Gbpsのルーティング機能とある通り、LANからWANへのスループットはクライアントを2台同時に利用した場合、上限はスペック通り合計で1Gbps程度です。セットアップ時は特に気にしていなかったのですが、IPSを外してみた場合のクライアント2台でもやはり1Gbps。運用としてはIPSを使う事が前提となるので結果は変わらないのでしょうが、WAN Portが2.5Gbpsであるにも関わらずLAN-WANのスループットが1Gbpsというのは少し疑問が残りました。前述した通り、UCG-Ultra本体からのスピードテストは2.5Gbpsワイヤレートしっかりと出ているのですが。\nアプリケーションのブロックとFirewallのブロックUniFiゲートウェイには、アプリケーションタイプでの制御（許可、ブロック）と従来型のFirewallのネットワーク、Port単位の制御の2通りがあります。Ubiquitiはそれぞれ、シンプル、高度なと分かれています。シンプルの方がアクセス統計のアプリから止められるため直感的で簡単です。ネットワークに慣れている方は従来のIPネットワーク、Portで止める方法もあります。ただ、自宅でサーバーを立てる時にPort8443などでWebサーバーを立てる事が多いように、必ずしもSSL&#x2F;TLSがPort443とは限りません。そういう意味ではアプリケーションで止めていく方が時代の流れには沿っていると考えられます。\nシンプルのルール表示の例です。\n\n\n高度なルール表示の例です。\n\n\nシンプルなルールでInternetに出ていくアプリケーションのうち、DNS(53&#x2F;TCP,UDP)、DoT（DNS over TLS(853&#x2F;TCP)）、DoH（DNS over HTTPS(443&#x2F;TCP)）とを止めるルールです。基本的にDNSはUCG-UltraがInternetに名前解決を問い合わせするため、クライアントがInternetとDNSで直接セッションを張る必要はないとして、ブロックするルールです（ユーザーの考え方次第でこのルールが多くの人に適合するというわけではありません）。\n\n\n従来型のファイアウォール設定、つまり高度なルールの設定です。Port 53&#x2F;TCP,UDPをInternetに出ていくものをブロックする設定を保険的に明示しています。\n\n\n高度なルールでDoTはPort853を指定して止める方法はありますが、DoHは暗号化されているのでファイアウォールでは検出不可能です。しかし、UCG-UltraはDoHの接続先（SNI)を見てブロックしているものと考えられ、シンプルなルールを使うことで簡単にアクセス制御ができます。\n最近はサイバーの脅威保護にDNSを使って情報資産を保護する取り組みは多い一方、ブラウザを提供しているITベンダーは広告を回避されたくないためユーザーが指定したDNSを参照せず、ベンダーが提供するDNSを（DoHを使って）参照しようとします。DoHでユーザーが用意したDNSの広告ブロックをバイパスするためです。ただこれがサイバー対策を迂回されてしまうリスクにもなります。\nSSL&#x2F;TLSインスペクションを使ったとしても完璧ではなく、最終的にはセキュリティ機器がどれだけ早く脅威情報を取り込めるかどうかに掛かっています。個人に対するサイバー攻撃で一番多いのはフィッシング詐欺です。このような仕組みでセキュリティを高めることに加え、多要素認証などを組み合わせる事でフィッシングの脅威から保護する事が重要です。\n\nUbiquiti Deep Dive into Advanced Firewall Rules https://help.ui.com/hc/en-us/articles/115003173168-Deep-Dive-into-Advanced-Firewall-Rules\n\n仮想ネットワーク（VLAN）前述した通り、IoT機器などのために、普段使うネットワークと分離するために新しいネットワークを作成できます。私の場合、ChromebookやAmazon Echo、Amazon FireTVなどは全てゲストネットワークとして、PCやスマホで普段使うネットワークとは分離しています。UniFiでは「仮想ネットワーク」としてVLANを定義しています。ネットワークの設定から「新しい仮想ネットワーク」を選択します。\n\n\nここでの例はGuestという名前を付けました。ネットワークアドレスは192.168.10.0/24、IPアドレスの第3オクテットに合わせてVLAN IDは10としています。ネットワーク分離を有効にし、Defaultネットワークとはお互いにルーティングできないようにしつつもInternetへのアクセスは可能としています。DHCPも有効になります。\n続いてPortマネージャーから、UCG-Ultraのポートを設定変更します。ここでは単一の端末を接続できるための設定をします。\n\n\nネイティブVLANネットワークはguestを選択します。つまりタグ10のVLANをネイティブ（タグ無し）として設定します。さらに他のネットワーク（Default)のパケットがタグ付きで外に出て行かないように、タグ付きVLAN管理の項目はすべてをブロックにチェックを付けておきます。\nこの2か所の設定で、Port2に端末を接続することで上記で作成したネットワーク（VLAN&#x3D;10)のIPアドレスが割り当てられます。以下はUCG-UltraのPort2に接続したChromebookの画面です。\n\n\nこれでIoTはインターネットにはアクセスできますが、自宅の重要な機器とは分離されます。PCがマルウェアに感染し、やがてセキュリティ上脆弱なIoTに感染してしまうということを防止できます。その逆も然りです。\nNASやサーバーがある場合、Default、ゲストだけでなく、サーバー用のVLANを作成し、Defaultとサーバーとは高度なファイアウォールを使用し、最低限度のプロトコルを通すなどすればよりセキュアな環境が整います。\nまた、今回は詳細の説明を割愛しますが、ルーティング機能も業務レベルの機能が用意されています。\n\n\n特定のドメインや地域などでルーティング先を変えるポリシーベースのルーティングやOSPF、L3スイッチなどを追加した場合の静的ルーティングに加え、DNSのカスタム設定（Aレコードだけではなく、MX、CNAME）などネットワーク機器としてはかなり多機能です。\nまとめ今回は、Cloud Gateway Ultraをセキュリティの観点から検証してみました。今後APやネットワークスイッチを導入する小型ネットワークを敷設される場合には候補になるプロダクトであると考えられます。\n\nUI Japan Store Cloud Gateway Ultrahttps://jp.store.ui.com/jp/ja/pro/category/cloud-gateways-compact/products/ucg-ultra\n\n価格は23,899円です。\nInterop246月12日〜14日の幕張で行われたInterop24でUbiquiti製品が紹介されていましたので、写真を撮ってきました。\nUXG-LiteとUCG-Ultra（これだとサイズ感が分からないですね。。。）\n\n\nPoEスイッチ　Switch Ultra\n\n\nUCG-UltraはPoEを持っていないので、UniFi APを接続する際は、別途PoEアダプタが必要となります。このSwitch UltraはPoEによる電源供給ができるのでAPや監視カメラなどを将来的に拡張していくのにちょうど良いスイッチかもしれません。\n\nSwitch Ultra https://jp.store.ui.com/jp/ja/pro/category/switching-utility/collections/pro-ultra\n\n補足説明\nUbiquiti Japan ホームページ https://note.com/ui_japan\n\n\nUbiquiti コミュニティ（日本） https://www.facebook.com/groups/uijapan\n\n\nUbiquiti Community（米国中心） https://community.ui.com/\n\n（製品提供：Ubiquiti Japan株式会社）\n","categories":["Hardware","Network"],"tags":["UniFi"]},{"title":"Sophos Firewallの導入","url":"/new-technology/2020/02/23/XG-Firewall/","content":"\n\n導入の背景元々、家庭用の無線ルータだけではセキュリティが不足していると考えていました。数年前よりランサムウェア等の脅威が出てきた事で、それなりの対策が必要と感じていました。街のWIFIからも自宅のリソースに安全に接続したり、家のサーバーを踏み台にしてネットに繋げたいというニーズもあり、VPNも必要でした。\n\nそもそも、iCloudかOneDriveあたりにファイルを置いておけばいいんですが、漏洩よりも万が一のロストが不安です。クラウドの特徴として、提供サービスと費用が一方的に変更されやすい傾向にあるようです。オンプレミスの場合は盗難や火事というリスクもあり、人によって優先するものは異なりますが、利便性と安全性のバランスを取る事を目指すのでしょうか。個人のセキュリティは、ビジネスにおけるリスクを極限まで抑制するという考えではなく、最低限必要な対策をもれなく行うものと考えています。特に最近進歩が著しいIoT機器は追加の防御策が必要です。Sophos社が提供するSophos Firewallは、業務用ながらホームユーザーには無料という事もあって、最良のセキュリティ防御の手段と考えています。かれこれ1年半くらいでしょうか。ずっと使わせてもらってます。\n\nSophos Firewall https://www.sophos.com/ja-jp/products/next-gen-firewall.aspx\n\n主な機能\nFirewall機能（IPフィルター、Portフィルター）\nIPS&#x2F;WAF\nコンテンツフィルター（Webフィルター、アプリケーションフィルター）\nDDoS対策機能\n国別フィルター（IPv4のみ）\nVPN（2要素認証対応）\nサーバ公開\nDNS&#x2F;DHCP(IPv4,IPv6)\n\nSophos Firewall導入メリット\nレイヤ7Firewall（次世代Firewall）により、アプリケーション単位、ギャンブルやゲーム、アダルトなどのカテゴリで禁止ルールを設定可能\n接続したくない国に対してアクセス制限ができる。Webブラウジングはもちろん、自宅にサーバーを建てた場合の接続元を日本からのみに絞る事も可能（IPv4のみ）\nSSL&#x2F;TLSインスペクションによりSSL&#x2F;TLS通信の中身を検査し、さまざまな脅威からの保護\nログ機能が充実している\nVPNが提供可能。ダイナミックDNSによる接続容易性に加え、ワンタイムパスワードによる2要素認証が可能（Windows、Mac、iOS、Android）\nエラーをフックし、メールでの通知が行える\n\nSophos Firewall導入の留意点\n新しいPCが必要（新品である必要はありません）。2枚のネットワークインタフェースが必要\nネットのパフォーマンスが犠牲になる。回線帯域よりもレイテンシ（遅延）が大きくなる\nXG Firewallによる保護はエンドポイントの保護を完全に不要にするものではないため、従来通りウィルス対策ソフト（Windows Defenderを含む）は必要\n\nシステム要件は以下の通りとなっています。\n\nhttps://www.sophos.com/ja-jp/products/free-tools/sophos-xg-firewall-home-edition.aspx2つのネットワークインターフェースのあるIntel互換コンピュータ。（XG Firewall Home Editionをインストールすると、コンピュータにある既存のOSやファイルは上書きされます）Home Editionは、4コア、および6GBのRAMまでの環境に対応しています。この条件を超えるコンピュータも使用可能ですが、XG Firewall Home Editionは、上限を超える容量を活用できません。\n\nホームユーザーには技術面でハードルは高いです。しかしながら業務用ファイアウォールが家庭で使えるというのは非常に魅力です。興味のある方はお付き合いください。\nSophos Firewallの記事一覧\nPC（ハードウェア）の準備\nVMware vSphere Hypervisor（ESXi）のインストール\nVMware vSphere Hypervisor（ESXi）の設定\nSophos Firewall のインストール（事前準備）\nSophos FirewallをESXi仮想マシンにインストールする\nSophos Firewallのメイン画面と特徴について\nXG Firewall v18のルールとポリシーについて\nXG Firewall v18のルールを作成する\nXG Firewall v18のポリシーをカスタマイズする\nSSLインスペクションについて\nXG Firewall v18のSSL&#x2F;TLSインスペクションの設定\nXG Firewall v18のSSLインスペクションの動作確認と調整\nXG Firewall Sophos Communityについて\nXG Firewall VPNについて\nXG Firewall VPNに2要素認証を設定する\nXG Firewall SSL-VPN\nXG Firewall VPNにスマホから接続する\nXG Firewallの通知設定を行う\nXG Firewall v18でLAN内のホストをインターネットに公開する\nIPv6のUnique Local Addressを生成する\nXG FirewallでIPv6の設定を行う（前半）\nSophos FirewallでIPv6の設定を行う（後半）\nXG FirewallでIPSのポリシーを確認する\nXG FirewallのWebとアプリケーションフィルタについて\nXG Firewall v18の設定におけるベストプラクティス\nXG Firewall v18で正しいDNS利用を強制する\nXG Firewall自身を防御する\nXG Firewall v18 MR3の更新\nXG Firewall v18 MR4の更新\nXG Firewall v18 MR5の更新\nXG Firewall v18.5 MR1の更新\nSophos Firewall v18.5 MR-2\nSophos Firewall v18.5 MR-3\nSophos Firewall v19\nSophos Firewall v19 MR-1\nSophos Firewall v19.5\nSophos Firewall v19.5 MR-1\n\nこのブログを書き始めた時はv18でしたが、2023年2月23日時点では、v19.5が最新バージョンとなっています。\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"Sophos Firewallのメイン画面と特徴について","url":"/new-technology/2020/03/08/XG-MainPage/","content":"この記事で実現すること\nSophos Firewallの管理画面とメニューから、製品の持つ機能を説明します。\n\n\nXGのメインページ XGの管理画面にログインすると、Controle Centerが表示されます。ここでは今の全体のFirewallの状況が示されます。ホームユーザーには相当なボリュームの内容で圧巻です。ホームユーザー向けに一部機能は制限されているので、不要な項目もたくさんありますが、Home Editionとして必要なものを見ていく事にしましょう。\n\n\n\n左上のシステムのアイコンは通常緑色です。\nネットワーク攻撃やブロックされたアプリなどが画面中央に赤色で表示されます。\n\n左ペインを見ていきます。\n\n\n\n項目\n内容\n\n\n\nルールとポリシー\nFirewallのルールを決める一番重要なメニューです\n\n\nweb\nコンテンツの種類によってアクセス制御を行うメニューです\n\n\nネットワーク\nインストール後、ネットワークの変更を行う時に、それなりに頻度の高いメニューになります\n\n\n認証\nVPNを使う時にワンタイムパスワードを併用する際利用します\n\n\nホストとサービス\n自分のFW配下にあるクライアントを登録する時に使用します\n\n\n管理\nこのFirewallのデバイスの管理を行います\n\n\n右上のログビューアをクリックすると別画面でFirewallのログがポップアップします。\nSophos FirewallのアーキテクチャSophos Firewallの最も重要な機能はv18から採用されているXStreamアーキテクチャです。暗号化されたhttpsプロトコルの様々なアプリケーションやコンテンツの中身を高速かつ適切に精査し、脅威から保護、かつ高速に動作する仕組みとなっています。\n以下、Sophosのサイトから引用します。\n\nXG Firewallの全く新しいXstreamアーキテクチャは、きわめて高いレベルの可視性、保護、およびパフォーマンスを提供します\n\n\n\n\nTLS インスペクションTLS 1.3 をサポートするネットワーク上の全ての暗号化されたトラフィックに業界をリードするパフォーマンスと可視性を提供\n\n\nXstream  DPI エンジン単一のストリーミングエンジンで高性能なディープパケット保護を実現し、既知および未知の脅威をすべて阻止\n\n\nXstream  Network Flow FastPath信頼性が高く重要なクラウド、SaaS、VoIP アプリケーショントラフィックを高速化して、最適なパフォーマンスを実現\n\n今回の構築する環境で実際に計測したSpeedtest.netの速度チェックのキャプチャ画像です。\n\n\n環境は以下の通りです。\n\nネット回線： auひかり5Gbps\nXGのマシンスペック： Core i7メモリ16Gbyte\n仮想環境： ESXi6.7\nネットワークカード： intel X550-T2\nクライアントPC： CeleronG3900という3年前の一般的なクライアントに5GbpsのNIC(Aquantia AQtion 5G Network Adapter)を組み込んだもの\n\nXG Home Editionは6Gbyteメモリ上限となる制約があります\n\n\nクライアント側のCPUで頭打ちになっており、XGは素晴らしい性能を持っています（もちろん業務向けとしては単一のセッションだけで評価は出来ませんが）。v17まではほぼProxyサーバとしての動作でしたが、v18はPort443に限らず、httpsの流れるデータをリアルタイムで精査します。私は製品のベータ版である、アーリーアクセスプログラムに参加していましたが、テストの最終局面でスピードが劇的に改善した時は感動しました。ホームユーザーが業務向けの製品を使えるのは本当に素晴らしい事です。\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"フィッシング対策ツールの実力","url":"/new-technology/2021/05/05/avoid-phishing/","content":"\n\nこの記事で実現すること\n\nフィッシングサイトから身を守るためには、自身が騙されないために日頃から意識する事が最も重要ですが、フェールセーフで各種セキュリティサービスに助けられるケースもあるはずです。それぞれのサービスがどの程度の実力を持つのか検証してみます。\n\n\nフィッシング対策について巷で記載されているフィッシング対策は、「本人が気を付ける」という観点で書かれている記事が大半です。ITに詳しくなくてもきちんとニュースやサイトの案内を理解され、慎重な方であれば滅多に引っかからないものですが、家族を含めて考えると無視できないテーマです。ウィルス対策ソフトなどはフィッシング対策も含めてアピールしている製品もありますが、実力はどの程度のものでしょうか。今回は、このサイトでお勧めしているXG Firewallを含め、代表的なウィルス対策ソフトの実力について調べてみました。\nフィッシングサイトと、対象ソフトウェアについてフィッシングサイトの選定フィッシングサイトは日本国内で有名になったものをTwitterなどからPickupしてみました。\n\n銀行・カード\n宅急便\n通販会社\nカード\n通販会社（別サイト）\n\n対象ソフトウェアGoogleはセーフブラウジングという機能を持っています。ChromeやFireFoxではこの機能が採用されています。これと同じ仕組みでMicrosoftのEdgeは”Smart Screen”という機能が提供されています。双方ともブラウザ画面いっぱいに赤色で警告を表示しますのでかなり驚きます。いずれもユーザーが報告を行える仕組みをとっています。\nウィルス対策ソフトは海外製品がどこまで日本の事情を理解できているかがポイントになるでしょうか。ある意味日本語という言葉の壁がフィッシングから身を守っていると言っても過言ではありません。従い、日本国内のサービスを対象とするフィッシング詐欺は日本の事に精通している必要があります。対策ソフトを作る側も同じ事が求められます。ウィルス対策ソフトについては、Norton360、Bitdefender、トレンドマイクロ（ウィルスバスター）を選定してみました。XG Firewallについても検証対象に加えてみます。\n検証方法PC、モバイルにおいて、セーフブラウジング、Smart Screenの実力を検証します。また、ウィルス対策ソフトを提供するベンダーは、簡易VPNとしてデバイス上で宛先（ドメインまたはURL）チェックを行う機能を持っていますので、これでフィッシングが認識できるか検証します。\n検証結果まずは検証結果の一覧です。URLの一部は伏せてあります。\n\n\n\n\n銀行direct5-xxxx[.]xxx\n宅急便znwjwvfgna[.]xx[.]xx\n通販会社1 www[.]xxx-amazon[.]xxx&#x2F;[.]\nカードxxx[.]epos-card[.]xxx&#x2F;\n通販会社2 amazon[.]co[.]jp[.]xxx[.]xx\n\n\n\niPhone Safari\n○\n✖️\n○\n✖️\n✖️\n\n\niPhone Chrome\n○\n✖️\n○\n✖️\n✖️\n\n\niPhone Edge\n○\n✖️\n○\n✖️\n✖️\n\n\niPhone Firefox\n○\n✖️\n○\n✖️\n✖️\n\n\nAndroid Chrome\n○\n✖️\n○\n○\n○\n\n\nAndroid Edge\n✖️\n✖️\n✖️\n✖️\n✖️\n\n\nAndroid Firefox\n○\n✖️\n○\n○\n○\n\n\nPC Edge\n○\n✖️\n○\n○\n○\n\n\nPC Firefox\n○\n✖️\n○\n○\n○\n\n\nMac Safari\n○\n✖️\n○\n✖️\n✖️\n\n\nMac Edge\n○\n✖️\n✖️\n✖️\n○\n\n\nMac Firefox\n○\n✖️\n○\n○\n○\n\n\nLinux(ubuntu) Firefox\n○\n✖️\n○\n○\n○\n\n\nBitdefender\n○\n✖️\n○\n○\n✖️\n\n\nXG Firewall\n○\n✖️\n○\n✖️\n✖️\n\n\nNorton360\n✖️\n✖️\n✖️\n✖️\n✖️\n\n\nウィルスバスターモバイル\n○\n○\n○\n○\n○\n\n\n（※上記の表は閲覧するデバイスによって見切れる場合がありますが、←→のスワイプで確認できます）\nWindows、LinuxChrome、FirefoxこれはGoogleセーフブラウジングを使う事になりますが、良い結果です。かなりの精度でフィッシングサイトを認識できています。✖️は1つですが、フィッシングサイトは次から次へと作られますからある意味いたちごっこではあります。ユーザーからの報告を受け、防御していくPDCAがうまく活用できているのでしょうね。\nEdge（Windowsのみ）MicrosoftのSmart Screenも良い結果でした。✖️は1つです。\nmacOSSafariSafariはGoogleセーフブラウジングの情報を活用しています。しかしWindowsとバージョンが異なるのか、不芳で✖️は3つです。\nChrome、FirefoxWindows版と同様で良い結果でした。✖️は1つです。\nEdgeこれも意外です。Windows版と結果が異なります。不芳で✖️は3つです。\nPCにおけるフィッシングサイトの検出能力Chrome、Firefoxを使う事で一定の防御が可能という事がわかりました。macOSでのみ、Edge、Safariの防御力が劣ります。\nAndroidChrome、FirefoxPCと共通で良い結果でした。✖️は1つです。\nEdge意外です。Android版Edgeはフィッシングサイトを全く検知できていません。仕組みが異なるのでしょうか。まだ発展途中のプロダクトという事でしょうか。\nAndroidにおけるフィッシングサイトの検出能力デフォルトのChromeを使う事で一定の防御が可能です。しかし、Edgeはフィッシングという観点では現段階で支援してくれない事を留意して使用すべきでしょうか。今後のアップデートで強化されていくものと考えられます。\niOSSafariiOSもmacOSと同じでGoogleのセーフブラウジングを使っています。不芳で✖️は3つです。\nEdge意外な事にGoogleセーフブラウジングを使っているようです。これは何らかの制約があるのでしょうか。不芳で✖️は3つです。\nChrome、Firefox想定通り、Googleセーフブラウジングを使っていますが、PC版のGoogleセーフブラウジングとは結果が異なります。不芳で✖️は3つです。\niOSにおけるフィッシングサイトの検出能力iOSは全てのブラウザで同じ結果、Googleセーフブラウジングを使っています。そして検出能力は高くありません。何らかの事情があるのでしょうか。また、Safariでは設定で、他社のコンテンツブロッカーを設定可能としています。そのせいなのか今1つiOS単体としての防御力を高める事は目指していないように見えます。\nウィルス対策ソフト等bitdefender海外のベンダーですが、どれだけ日本のものを検出可能でしょうか。✖️は2つと及第点です。ウィルス対策ソフトとしては信頼できるベンダーではありますが、日本からのタイムリーな情報入手は難しいものがあるのでしょうか。\nXG Firewallこちらも期待には応えられず、不芳で✖️は3つです。やはり海外製品はフィッシングについては苦手分野なようです。自宅におけるIoTからマルウェアなどを防御できる事をメリットに考えるべきでしょうか。\nNorton360iPhone上でVPNとして設定してみましたが全くフィッシングサイトを検知できませんでした。フィッシングとは関係のないサイトで警告を出すなど出来ていたので、Norton360のVPNの仕組みを使った保護というのはフィッシングを対象としていないのかもしれません。\nウィルスバスターモバイルこの製品は唯一全てのフィッシングサイトを検出できました。優秀です。トレンドマイクロは日本国内のオフィスもあり、日本の事情に精通している事も一因としてあるのでしょうか。前述したiPhoneのSafariのコンテンツブロッカーとして設定できます。また、SMSもフィルタする機能を持っています。\n検証結果を踏まえてフィッシングサイトから防御するため、様々な環境でテストしました。OSやソフトウェアによって特徴がありますので参考にしてください。多くのプログラムをインストールしたり開発する方であればフィッシングへの耐性は強いと思われるので、ウィルス・マルウェア対策に重点を置いて対策すべきでしょうか。一方、スマホアプリ、SNS、ブラウザ程度の使い方でITにあまり詳しくない方なのであればフィッシング対策に重きを置くという考えもあります。\n今回紹介には含められませんでしたが、携帯キャリアが提供しているフィッシング対策もあります。ご家族やご年配の方など心配であればフィッシングについての啓蒙、こういったツールの導入などを検討されてはいかがでしょうか。\n","categories":["Security"]},{"title":"ZikeDrive Z666 USB4エンクロージャー","url":"/new-technology/2024/01/13/ZikeDrive-Z666/","content":"\nこの記事で実現すること\n\nUSB4 40Gbpsに対応したNVMe　M.2対応のSSDエンクロージャーを紹介します。いわゆる外付けディスクです。ノートPCの外付けとして直近のNVMe M.2 SSDの状況を鑑みつつ、USB4&#x2F;Thunderbolt4&#x2F;Thunderbolt3などプロトコルの違い、実運用における速度を見ていきます。\n\n背景2023年はSSDがとても廉価だった年でした。非常に高性能なNANDフラッシュメモリが台頭してきた事もあり、外付けSSDとしての利用価値が高まってきています。USB-Cのコネクタ形状はiPhone15での対応もあり、最近デファクトになりつつある規格ですが、一方で新しいPCやMacではUSB4&#x2F;Thunderbolt4への対応が進んでいます。OS本体のストレージとは別に目的やジャンル別のデータ保存に外付けディスクを”切り替える”使い方もあろうかと思います。特にノートPCのディスク容量は大きくないですし、あまり使わないデータは外付けディスクで管理したいところです。\nこれまでUSB-CのSSDエンクロージャーといえば、USB3.2 Gen2の10Gbpsで接続可能なもの、一般的にはRealtekのRTL9210チップを搭載した安価なものが多くを占めます。今回のZIKE Z666は40Gbps対応となり、今のNVMeの能力を活かすことが期待できます。\nZIKE Z666ZIKEはアメリカ発のベンチャー企業で、2021年に起業したアメリカのデラウェア州にある企業です。\n\nZIKE\n\n https://ziketech.com\n商品説明のページでは、Z666は3,811MB&#x2F;sの読み取り速度と3,199 MB&#x2F;sの書き込み速度があるとの事。1USB3.2Gen2のSSD外付けドライブの3倍速です。ASMediaのAS2464PDチップを備え、USB4ケーブルが付属、NVMeの取り付けに工具不要。ケースそのものはアルミで作られ、その周りを透明なABS樹脂で覆ったものとなっています。サイズは112×66.8×18(mm)、重さ245gとなっており従来のエンクロージャと比べれば大きめです。外への持ち出しを考えられて作られてます。50度を超え70度にもなるNVMeを直接アルミで放熱することは機械にとっては良くても、人にとっては優しくないわけですが、一般消費者向けに（きちんと）作られた製品です。\n\n\nストレージの制限があるノート、特にMacbookのユーザーから人気があります。エンクロージャに取り付け可能な短いケーブルが付属します。Z666はあくまでエンクロージャーですので、中身のNVMeは別途購入する必要があります。スペックの概略は以下の通りです。\n\n\n\n各スペック\n説明\n\n\n\nインタフェース\nUSB4 40Gbps Thunderbolt3&#x2F;4互換、USB3.2Gen2 10Gbps、USB3.2Gen1 5Gbps、USB2.0 480Mbps\n\n\nSSD形状\nM.2 M-Key PCIe Gen 4x4&#x2F;2280\n\n\n容量\n1、2、4、16TBまたはそれ以上\n\n\n互換性\nWindows,MacOS,Linux,iPad,PlayStation\n\n\nAS2464PDチップとNVMeとの間がPCIe Gen4x4というのが魅力です。ファームウェアのアップデートもウェブサイトで公開されており、質問やユーザーレポートの投稿も可能です。\n詳細は、Zikeのウェブサイトで確認してください。\n\nZ666\n\n https://ziketech.com/products/zikedrive-worlds-first-and-fastest-usb4-ssd-drive?variant=42809341608097\nベンチマークここで利用するSSDについて紹介します。速度だけでいえば、WD_Black SN850X NVMeやSamsungの990Proがメジャーです。しかし、ケーブル接続する外付けディスクの利用目的としてはそこまで速度を求めるものでもないでしょうから、それに準ずる比較的廉価な製品を選定して確認していきます。Gen4x4の速度が必要であればマザーボードに直接NVMeをセットされる事をお勧めします。\nまずは、SK hynix Platinum P41 NVMe 2TBで確認します。\n\n\nPlatinum P41は990Pro、SN850Xと比較し価格は少し廉価ですが、2TBのモデルで速度はRead 7,000MB&#x2F;s、Write 6,500MB&#x2F;sであり、990ProのRead 7,450MB&#x2F;s、Write Write 6,900MB&#x2F;sの速度に迫り実力としては十分です。このモデルはDRAMを持っているので、ベンチマークには有利です。\nWindows CrystalDiskmark\n\nハードウェアはMinisForum UM790 Pro(Windows11 Home)で、USB4ポートで確認しました。フォーマットはexFATです。スペック通りの速度です（書き込みはスペック以上の速度です）。\nデバイスマネージャーから取り外しポリシーを高パフォーマンスに変更するとランダム書き込みの値が改善します。これは普段から接続しっぱなしの方にお勧めの設定です。\n\n\n\n\nmacOSのベンチマーク\n\nMacbook Pro(M2)のThunderbolt4ポートで確認しました。フォーマットはAPFSです。Windowsよりは速度は落ちますが、アプリケーションが違うものなので単純比較は難しいところです。macOSでは他にBlackmagicというDiskパフォーマンスベンチマークソフトがあります。\n\n\n前回の記事「iPhoneに繋がるミニSSDケース」で書いた小型のRTL9210エンクロージャではRead&#x2F;Writeともに980MB&#x2F;s程度でしたから格段に速度が向上しています。もちろん、USB4に対応していないUSB3.x Gen2のホストにZ666を接続した場合は10Gbpsと速度は落ちますが、アクセス可能です。\nUSB3.2 Gen2のエンクロージャーをご利用されている方は、読み込み書き込み共にCrystalDiskMarkのシーケンシャルで1,000MB&#x2F;s前後の数字を目にされているのでは無いでしょうか。これは8Gbps前後になりますので、USBを経由する実効速度は理論値よりは2割ほど落ちます。\n今回は最も遅い箇所が40Gbpsのケーブルですから5GB&#x2F;sが理論値となり、それの8割とすれば4GB&#x2F;sです。Windowsの結果を見れば大体このような数字なのかなと感じます。\nZ666のケース構造Z666のフタはプラでパチンと嵌め込む形になっているので、手で押し開けます。\n\n\n上蓋には3mm厚程度のサーマルパッドがあります。本体内部下部にはNVMeを支える2つの長方形のクッションが糊付けされています。NVMeはラバープラグを回転させて固定させる方式です。お世辞にもしっかりと固定されるとはいえませんが蓋を閉めるので大丈夫ということでしょうか。頻繁にNVMeの入れ替えを行う場合を想定して便利に作られています。内部のクッションは剥がせそうではありますが、基本的に片面実装（チップが片方のみあるもの）のNVMeを想定しているようです。また上蓋にサーマルパッドがあることから、ヒートシンク付きのNVMeは使えません。物理的には接続可能ですが、その場合は蓋が閉まりません。\nケースはABS樹脂とアルミの隙間があるため、ここから熱を逃すようです。ケースの外側はほんのり暖かい程度で熱さは感じません。\nZ666の購入ZIKEのWebサイトから海外通販で購入することになります。shopPayがあるので、Ubiquitiなどの他の通販で利用されている場合は再度住所の登録が不要です。日本からは送料無料で1月初旬で18,000円弱です（為替で変動するようです）。\nレビューを見ていると結構楽しいです。皆さんCrystalDiskMarkの画面ショットを貼り付けていらして、このような光景は世界共通ですね。速いのでLaptopでSQL Serverに使えるというコメントがあったり、M2 Ultra Mac Studioに990Proを付けて3200&#x2F;3100のBlackMagicベンチマーク結果で「こんなものなのかな」というコメントなど、平和ですね。\nSSDの進化NVMeに限らず、SSDにはDRAMキャッシュがあるもの、ないものと2種類の製品が存在します。\n以下は、Platinum P41　2TBを横から撮影したものです。\n\n\n右側のM.2コネクタから順に、コントローラー、DRAM、NANDフラッシュ2枚が並んでいます。M.2コネクタから近い順に速いチップを配置していくのが基本です。各社凌ぎを削っている部分ですが、このような配置だとNANDフラッシュは1TBづつ配置されている事になります。コントローラー、DRAMキャッシュ、NANDフラッシュと片面実装にするためにギリギリで詰め込まれているのがわかります。176層というNANDフラッシュ1つに1TB、それを2個搭載する事で2TBという容量を実現しています。\nただ、このデザインから見えるように、すでに基盤上はチップで埋まっているので、これ以上NANDフラッシュメモリを追加できません。さらに片面のまま4TBの容量とするには微細化が求められることになります。Platinum P41の製品バリエーションとして最大容量は2TBとなっています。WD SN850Xの4TBはいくつかの第三者レビューを見る限りではNANDフラッシュが裏面に2枚あるそうで両面実装となっています。\nSamsungの990Proの4TBは片面実装になっています。王者の貫禄というか、意地でしょうか。凄まじさを感じさせます。\n\n4TB NVMe Laptop UpgradeIt’s the one and only on the market—the 990 PRO 4TB is now compatible with laptops. Thanks to Samsung’s NAND Stacking technology, 990 PRO is the first 4TB m.2 NVMe Internal SSD with a single-sided form—meaning it fits easily in the most popular laptops for an instant upgrade in high-performing storage.\n4TB NVMeラップトップ・アップグレード990 PRO 4TBがラップトップに唯一無二の存在となりました。サムスンのNANDスタッキング・テクノロジーのおかげで、990 PROは、片面実装の初の4TB  M.2 NVMe内蔵SSDとなりました。つまり、高性能ストレージを即座にアップグレードするために、最も人気のあるラップトップに簡単に収まることを意味します。\n\n\n\n\nSamsung\n\n https://www.samsung.com/us/computing/memory-storage/solid-state-drives/990-pro-pcie-4-0-nvme-ssd-4tb-mz-v9p4t0b-am/\nSSDの選択先ほど紹介したZIKEの掲示板では高額なホストに高額なNVMe(990Pro)を付けたからといって大したパフォーマンスの向上は見込めないように見えます。\nケーブルやUSBを経由するオーバーヘッドがある場合には、SSD側のDRAMキャッシュがある程度有効になります。NANDフラッシュへの遅い書き込みをカバーするために、できるだけ応答を早く返すことで遅いケーブル上での待ちを少なくすることが重要です。\n速度以外にも、容量の確保、発熱を抑えることも、コストを抑えることも大事です。\nZIKEの掲示板でもLexarのNM790というNVMeが紹介されていました。Lexarは昔からカメラを趣味にしている人であればよく知られているブランドで世界的にも有名です。\nこのNM790はYMTCの232層NANDフラッシュとMaxioのMAP1602Aコントローラーを使ったNVMeです。他社でもこの組み合わせのNVMeは大量に出回っています。\nこのモデルは、DRAMレスとなっており、SK hynixのものよりは1回り小さいNANDチップが4枚片面に乗せられています。コントローラーも1回りサイズが小さくなっており、うまく片面に乗せられたという感じです。このコントローラーは4多重で動作でき、負荷分散ができます。RAIDシステムで分散して処理速度を稼ぐのと同じ考え方ですね。ローテクな感じですが、負荷分散によりボトルネックが小さく、DRAMキャッシュの複雑な機構も不要ですので、廉価で低発熱が期待できます。\n各SSDをZ666で速度テスト手元には以下のNVMeを用意し、Macbookで速度検証してみます。\n\nSamsung 970EVO Plus 1TB\nSK hynix Platinum P41 2TB\nLexar NM790 2TB\n\nテスト結果は以下のとおりです。\n\n\n\nテスト項目\nSamsung\nSK hynix\nLexar\n\n\n\n\n970EVO Plus\nPlatinum P41\nNM790\n\n\nSEQ1M Q8　Read\n3368\n3386\n3379\n\n\nSEQ1M Q1　Read\n2901\n3120\n3028\n\n\nRND4K QD64　Read\n890\n916\n905\n\n\nRND4k QD1　Read\n62\n65\n68\n\n\nSEQ1M Q8　Write\n1312\n3178\n2679\n\n\nSEQ1M Q1　Write\n1176\n2677\n2887\n\n\nRND4K QD64　Write\n262\n305\n221\n\n\nRND4k QD1　Write\n46\n44\n31\n\n\nコントローラー温度\n65\n61\n47\n\n\nDRAM温度\n84\n72\n-\n\n\nNAND温度\n72\n60\n50\n\n\n※パフォーマンスのテスト数値はMB&#x2F;s、温度は摂氏となります。DiskMarkを2回実行し、赤外線で計測するタイプの温度計でチップ表面を計測し、一番温度の高い数値を採用しています。\n\n970EVO Plus（PCIe3x4）のSEQ Readはカタログスペック3,500MBなので読み込みのボトルネックは発生していない。\n970EVO Plus（PCIe3x4）のSEQ Writeはカタログスペック3,300MBなのでこの環境では半分以下に落ち込んでいる。逆に言えば、ホスト、ADMediaチップ、NVMeのコントローラーがPCIe4x4で揃っていればボトルネックが生まれにくい。\nPCIe4x4対応のPlatinum P41とNM790のシーケンシャル処理はReadにせよWriteにせよ3,300MBあたりが壁になっている。Macbook本体やASMediaチップがPCIe4x4（理論値64Gbps）であってもケーブルが最大40Gbpsの制約、プロトコル変換のオーバーヘッドに加え、Macbook&#x2F;macOSが持つ何らかの要因によるオーバーヘッドがあると考えられる（Windwos11と比較しても遅く見える）。\nDRAMキャッシュがないNM790は大量のランダムな書き込みには特に弱い。PCIe3x4の970EVO Plusを下回る。\n970EVO Plusは速度が頭打ちになっているにも関わらず発熱量はかなり大きい。\nNM970はかなり温度が低い。DRAMを使わない分処理が単純なのとNANDチップが高性能というのも一理あるかもしれない。\n\n廉価にPCIe4x4のNVMeを使える機会があるのであれば無理にPCIe3x4の970EVO Plusを使う意味は無さそうです。なお、容量が4TBとなると、この3つのうちではNM790が候補になります。\nあくまでベンチマークだけの話なので参考に留めていただけると幸いです。WindowsのCrystalDiskMarkはスレッド数（多重度）も指定できましたが、macOS版では特に指定がありません。1スレッドという事なのかもしれません。\n大きなサイズのファイルコピーESXiの仮想マシンvmdkファイル42.95GByteを対象とし、macOSからZ666へ書き込みます。\n\n\n\nテスト項目\n970EVO Plus\nPlatinum P41\nNM790\n\n\n\n42.95GBファイルをMac→Z666へコピー\n31秒\n13秒\n16秒\n\n\nこの結果を見る限りではやはりPCIe4x4のチームが有利ですね。外付けDiskで40GByteのファイルが10秒台というのは魅力的です。Platinum P41でベンチマークのシーケンシャルWrite処理を超える3.3GB&#x2F;sという数値が出ています。素晴らしい結果ですが、やっぱりMacBook Pro（M2）では何かしらの3.3GBの壁があるように見えます。\n小さなサイズの多くの数のファイルコピーこのブログで使っているモジュール群のNode Moduleやgitは細かいファイルをたくさん生成します。2.07GBのフォルダに、54,301ファイルが存在しています。\n\n\n\nテスト項目\n970EVO Plus\nPlatinum P41\nNM790\n\n\n\n54,301個のファイルをMac→Z666へコピー\n23秒\n23秒\n23秒\n\n\n\n\n\nテスト項目\n970EVO Plus\nPlatinum P41\nNM790\n\n\n\n54,301個のファイルをZ666→Macへコピー\n21秒\n21秒\n22秒\n\n\nOS処理のオーバーヘッドが大きいようで各NVMeでほぼ同じ時間となりました。ランダムに弱いという点はベンチマークではありましたが、バックアップ目的での小さなファイルコピーを中心に利用するならばあまりメディアの違いは関係なさそうです。速度はおおよそ90MB&#x2F;sです。\nRTL9210の10Gbps対応のエンクロージャにNM790をセットして書き込んでみます。結果は26秒でした。OSが細かいファイルを処理する事はやはりオーバーヘッドが大きいため、90MB&#x2F;s程度の速度であれば高速デバイスのメリットは活かしきれず、USB3.2 Gen2とUSB4との違いはありません。\n今回のケースでは敢えて極端な例を示していますが、一般的によく利用される写真、動画、文書などのファイルであれば効率的にZ666のパフォーマンスを活かせます。\nUSB&#x2F;Thunderboltと対応PCUSBについてのおさらいです。\n\n\n\nUSB規格名\nデータ転送速度\n旧名称\nマーケティング名\n\n\n\nUSB3.2 Gen1\n5Gbps\nUSB3.1 Gen1、USB3.0\nUSB　5Gbps、旧（SuperSpeedUSB、SSマーク）\n\n\nUSB3.2 Gen2\n10Gbps\nUSB3.1 Gen2\nUSB　10Gbps、旧（同上）\n\n\nUSB3.2 Gen2x2、USB4 Gen2x2\n20Gbps\n\nUSB  20Gbps、旧（SuperSpeed USB 20Gbps、USB4  20Gbps）\n\n\nUSB4 Gen3x2\n40Gbps\n\nUSB 40Gbps、旧（USB4 40Gbps）\n\n\nUSB4 Ver2.0\n80Gbps\n\n\n\n\nまずZ666を利用するにあたり、最低限度の必要な確認です。お使いのPCでUSB4(Thunderbolt4&#x2F;Thunderbolt3)に対応していなければZ666のメリットは活かしきれません。私はUSB3.2Gen2x2のホストを保有していないので確認できませんが、ASMediaのASM2464PDの紹介ページではUSB3.2、USB2.0の後方互換があると記載されています。USB-Cがあってもお使いのPCがUSB3.2 Gen2止まりであれば従来のRealtekのRTL9210のエンクロージャーで十分です。\n\nASMedia ASM2464PD\n\n https://www.asmedia.com.tw/product/802zX91Yw3tsFgm4/C64ZX59yu4sY1GW5\nUSB4はThunderbolt3をベースに作られています。同じUSB-Cの形状でもUSBポート、Thunderbolt3&#x2F;4ポートの違いがあり、それぞれのプロトコルの違いがあるので一層理解が難しくなっているのが現状です。\nThunderbolt3は40Gbps対応とはいえ、Requirement（要求事項）は最低16GbpsのPCIeデータのサポートが求められています。Altモードでデータ、ディスプレイへの出力の合計で40Gbpsです。\n\n\n\n\nThundrerbolt4\nThunderbolt3\n\n\n\n総帯域幅\n40Gbps\n40Gbps\n\n\nデータ転送の最小帯域幅\n32Gbps\n16Gbps\n\n\nディスプレイ\n4K  モニター最大 2 台、または 8K モニター 1 台\n4K モニター 1 台\n\n\n2018年以降のmacbookをお使いの方はThunderbolt3対応になっていると思います。Windows(intel)のノートPCではThunderbolt3に対応した機種もあります。新しいWindowsノートPCはUSB4に対応したモデルも出てきていますね。外付けディスクだけを考えた場合、Thunderbolt3対応というのはデータ転送において最低16Gbpsを満たす事ですから、外付けディスクで16Gbpsの速度しか出なくても文句は言えません。但し、Requirementと実装とは異なることも多いので個別のホストを確認しないと分かりません。\nmacのポートの対応については以下を確認してください。\n\nApple Macのポートを調べる\n\n https://support.apple.com/ja-jp/HT201736\n M1 MacなどはThunderbolt&#x2F;USB4と記載があります。本当はThunderbolt4と書きたいところだったんでしょうけれども何か規格に満たないものがあり、こういった表現に留めているのだと思われます。\nZ666はUSB4に対応したモデルであり、Thunderboltプロトコルとは互換性があります。MacBook ProでZ666とを接続し、システム情報を参照するとThunderbolt4ではなくUSB4モードで接続されています。\n製造元名:\tGopod Group Limited.装置名:\tUSB4 NVMe SSD Pro Enclosureモード:\tUSB4装置ID:\t0xD666製造元ID:\t0x2D01デバイスのリビジョン:\t0x5Aファームウェアのバージョン:\t1.87状況:\t装置は接続済みリンクの状況:\t0x2速度:\t最高40Gb/秒×1現在のリンク幅:\t0x2\n\n一方、2019年のintel版Macbook AirはUSB4には対応していませんが、Thunderbolt3には対応しています。\n製造元名:\tGopod Group Limited.装置名:\tUSB4 NVMe SSD Pro Enclosureモード:\tThunderbolt 3装置ID:\t0xD666製造元ID:\t0x1CAデバイスのリビジョン:\t0xE3ファームウェアのバージョン:\t1.87状況:\t装置は接続済みリンクの状況:\t0x2速度:\t最高40Gb/秒×1現在のリンク幅:\t0x2\n\nintel版Macbook AirをDiskMarkで確認してみます。\n\n\nもしかしたら遅くなるのかなと考えていましたが、Requirement（16Gbps）以上の良いパフォーマンスを発揮しました。少なくとも32Gbpsは対応してそうです。\nケーブルについて80cmのThunderbolt3ケーブルはUSB4で問題なく使えます。1mを超えるThunderbolt3のパッシブケーブルは20Gbpsですので、十分なパフォーマンスが出ない場合があります。距離が必要であれば少し高額ですが、2mのThunderbolt4アクティブケーブルを用意することになります。私はPlugableのThunderboltケーブルを好んで使っています（Amazonで購入できます）。iPhoneの充電には白色のAmazon Basicのケーブル（通信速度480Mbps）、データ通信用はPD充電（100W）を兼ねて黒色のThunderboltケーブルと使い分けています。\nZ666を使う分には別途ケーブルを購入する必要はありませんが、微妙な接触不良などが思わぬトラブルの原因になるため、事前の確認をお勧めします。Z666に限らず、エンクロージャーを動かしたら切断警告が出たという経験をお持ちの方も多いのではないでしょうか。Z666に付属のケーブルも短すぎてエンクロージャを動かした時に端子に負担を掛けます。しなやかなで、ある程度の長さがあり、端子に負担を掛けないケーブルを利用されることをお勧めします。\nSSDの暗号化メディアの持ち出しなどのためにWindowsであればBitlocker To Go、macOSであれば**APFS（暗号化）**でのフォーマットをお勧めします。\nBitlocker To GoはWindows Homeでは使えない機能ですが、一度Proで作成してしまえば、Windows Homeでもファイルの読み込み・書き込みが可能です（将来的にはHomeでは使えなくなる可能性があります）。パフォーマンスについてはDiskMarkを見ている限りではランダムは少し速度が落ちますが、シーケンシャルはMac OS、Windowsともに暗号化しない時と殆ど変わりません。\nmacOS、Windowsとともに、次回からパスワードを省略できます（macOSはキーチェーンに保存）ので自宅PCでの利用においてはパスワードを意識する事なく便利です。\nWindowsにおける実運用Z666にBitLocker ToGoで暗号化された2TBのLexar NM790をセットして書き込みのテストを実施してみます。エクスプローラーでコピーし、対象は写真・動画で、209GBのフォルダサイズです。\nまずはDiskの取り外しポリシーをクイック取り外し（既定：キャッシュ無し）の通常のコピーをパフォーマンスモニターで記録しました。項目はDisk Write Bytes&#x2F;secおよびCurrent Disk Queue Lengthです。Disk Queue Lengthは一般的に2を超える数値だとディスクにボトルネックがあると伝統的に言われています。ハードディスク時代のサーバー管理における一般論ですのであくまで参考値です。4分25秒でコピーが完了しています。\nLexar NM790 書き込みキャッシュ無し\n\n緑色のグラフはDisk Write Bytes&#x2F;secで、左の凡例の10の数が1,000Mbpsを示します。赤色のグラフはDisk Queue Lengthで、左の凡例の10の数が1を示します。\n計算上は約788MB&#x2F;sでファイルがコピーされていますが、実際にNVMeに書き込んだ内容は860MB&#x2F;sです。凡そ1,000MB&#x2F;sでコピーしており、最後の20秒で速度が落ちています。速度が落ちた理由はNVMeのSLCバッファが枯渇したものと思われ、200MB&#x2F;sあたりまで落ち込み、Disk Queue Lengthも2のままが継続する比率が高くなっています（青色の枠で囲った部分）。SLCバッファの枯渇はSSDの宿命とも言え、やむを得ませんが、取り外しポリシーがクイック取り外し、暗号化、数MB単位の小さいファイルもあれば、これくらいの速度が現実的です。\nDisk Queue Lengthは取り外しポリシーの制約があり、Diskへの負担はあまり大きくありません。\nLexar NM790 書き込みキャッシュ有り取り外しポリシーを高パフォーマンスにします。コピー時間は凡そ1分50秒で2分35秒の短縮です。計算上は約1,900MB&#x2F;sです。\n\n\n前回同様、後半はSLCバッファが枯渇して数値が落ち込むと考えられますが、グラフを見る限りは後半を除けば2,000MB&#x2F;s〜3,000MBの速度でNVMeに書き込んでいます。最初から4〜6あたりのDisk Queue Lengthが発生しており、十分NVMeへの負荷も確認できます。但し、断続的に高止まりしているわけではなく、0〜8の間で行ったり来たりしていますから、ファイルサイズが変化する状況で速度に変化があると考えられます。グラフを眺めていると、後半30秒はDisk Write Bytes&#x2F;secの値が落ち込むと同時にDisk Queue Lengthの数値は若干高い傾向が見られます（青色の枠で囲った部分）。最後の5秒はDisk Write Bytes&#x2F;secがかなり落ち込みNVMeに対する信頼性として一瞬不安になりますが、実際の書き込み量が減るものの、Queueは発生していないのでボトルネックは発生していないと考えられます。\n10gbpsのエンクロージャーを使った場合は、取り外しポリシーを高パフォーマンスの時のDisk Write Bytes&#x2F;secは凡そ950MB&#x2F;sで、クイック取り外しの時は600MB&#x2F;sでした（後半の処理速度低下部分を除く）。\nSK hynix Platinum P41Platinum P41の高パフォーマンスでの結果です。コピーの結果は1分35秒でNM790よりは15秒ほど高速でした。\n\n\nこのNVMeの特性として、初動はスロースタートです。Disk Queue Lengthがいきなり8まで上がります。これはmacOSのベンチマークで確認した際にも少し気になりました。Disk Queue LengthはNM790よりはやや低い数値で安定しています。NM790はQueueが0と8の間を絶えず行ったり来たりしています。一方、P41のQueueは2と3が中心で、時々0になったり4以上となり変動が少ない状況です。これらはDRAMキャッシュの効果といえます。実際のコピー時間として見た場合はNM790と比較してそれほど顕著な差は見受けられません。単純にコピーではない、動画編集処理やゲームなど低レイテンシが求められるような用途には向いていると考えられます。\nまとめ最後のWindowsでのテストはリアルな速度を示しました。SSDの容量が埋まっている場合はSLCバッファの数も足りなくなり、これよりもパフォーマンスは落ち込むものと考えられますが、今回の検証の目的からも外れるため、ここまでといたします。\n結論として、外付けディスクの速度を上げるためには、デバイスコントローラー（AS2464PD）、ケーブル（Thunderbolt4／USB4）、NVMeメディア（PCIe4x4）、ホストコントローラー（PC本体）のすべての速度をバランス良く高める必要があります。\n私は4TBのNM790でMacbookのバックアップ（TimeMachine）のパーティションを1TB、その他動画・写真の管理・編集および映画や音楽、モジュールのダウンロードなどを3TBとしてシンプルな用途で使っています。色々なデータでTimeMachineのバックアップが膨らんでいくのも避けたいと考えています。\nZIKEDRIVE Z666が登場したこと、高速なNVMeが登場したことで、外付けディスクは実運用でかなり快適に使えるようになりました。\n補足2024-02-10 更新\nZ666のファームウェアアップデータの提供は取り下げになったようです。今はZIKEのホームページで表示がされていません。なお、同じAS2464のチップを搭載したJEYIのエンクロージャーはeBayで購入できます。こちらの製品はファームウェアがきちんと提供されています。実際に私もeBayで購入したものをファームウェアアップデートして利用しています。Z666とJEYIのものとは私の環境においては違いは見受けられません。\n\nJeyi ASM2464 USB4 Enclosure Firmwarehttps://www.jeyi.com/pages/downloads?spm=..index.header_1.1\n\nーーー\nZ666のファームウェアは2024年1月3日に更改されたものの、アップデータとしてのConfigが誤っているようでアップデートが出来ません。単にファームのファイル名が誤っているように見えて、Configを修正すれば実行できるとは思いますが、他のパラメータもたくさんあり、一旦はZIKE社に問い合わせています。また情報が得られたら記事をアップデートしたいと思います。\n","categories":["Hardware"],"tags":["M.2 NVMe","ZikeDrive","USB4","Thunderbolt3","Thunderbolt4","MinisForum UM790 Pro","Lexar NM790","SK hynix Platinum P41"]},{"title":"XG Firewall v18の設定におけるベストプラクティス","url":"/new-technology/2020/05/09/best-practice/","content":"この記事で実現すること\nXG Firewall v18を利用するホームユーザー向けに、ベストプラクティスとなる設定をします。\n\n\n\nXG v18のベストプラクティスXG v18のレイヤ7ファイアウォールは、SSL&#x2F;TLS通信をPort443に限定していません。これまでの一連の設定で実施してきましたが、そもそもファイアウォールのルール自体は非常にシンプルです。https通信を通すのは原則であり、URL・アプリケーション・データの中身をどうチェックするかがレイヤ7ファイアウォールの肝となります。Sophos Communityにおいては、過去発生したランサムウェアや情報漏洩に繋がるProxyやVPN等、様々な検討、議論が重ねられ、ベストプラクティスといえるお勧めの設定が存在します。以下の記事を参考にします。\n\nSophos XG Firewall &#x2F; Cyberoam: Application filter recommended settings for better application detection https://community.sophos.com/products/xg-firewall/f/recommended-reads/119051/sophos-xg-firewall-cyberoam-application-filter-recommended-settings-for-better-application-detectionランサムウェア: ソフォス製品による回避策のアドバイス https://community.sophos.com/kb/ja-jp/124744Sophos XG Firewall: 高リスクのアプリケーションをブロックする手順 https://community.sophos.com/kb/ja-jp/123102　[1]Best Practice Guide.pdf（2020-06-24追加） https://community.sophos.com/cfs-file/__key/communityserver-discussions-components-files/258/Securing-your-Sophos-XG-Firewall-_2D00_-Best-Practice-Guide.pdf\n\n最初の記事がベストプラクティスとも言える内容になっており、この記事を中心に、関連する記事も参考にしながら設定します。\n設定内容設定の概要\nXGのコマンドラインでIPSの設定を変更します。初期設定から変更するのはmaxpktsの値です。これは、データの先頭からアプリケーションの判定に8パケットを渡すというもので、この値はパフォーマンスや検出精度に影響するようです。100〜300パケットを設定するのがお勧めとされています。\nアプリケーションフィルタでは、P2P&#x2F;Proxy and Tunnel&#x2F;DNS Multiple QNAME（DNS経由の情報漏洩）&#x2F;OpenVPNを止めるべきと記載があります。また、ハイリスクアプリケーションのカテゴリ（Risk&#x3D;4、High Risk&#x3D;5）も止める事が推奨されるようにカテゴライズされています。\nWebフィルタでは、以下の項目が拒否対象です。\n\n\nIPAddress\nNone\nParked Domains\nSpam URLs\nAnonymizers\nCommand &amp; Control\nPhishing &amp; Fraud\nSpyware &amp; Malware\nUncategorized\n\n\n個別のファイアウォールのルールでUDP443のQUICを認めない設定、不正なSSL証明書を許可しない等の設定が必要です。\n\nIPSの設定XGの画面右上にある、admin▼からコンソールを選択し起動します。パスワードを入力し、4.Device Consoleに入ります。そして、以下のコマンドを入力し、期待する設定値を合っているか確認します。\nconsole&gt; show advanced-firewall\n\n\nMidstream Connection Pickup Off\n\nここはXGのv18であれば基本変更する必要はありません。次にIPSの設定です。\nconsole&gt; show ips-settings\n\n\nmaxsesbytes 0\nstream on\nmaxpkts 200（推奨値100〜300）\n\nデフォルトでは、maxpktsが8となっているので、以下のコマンドで200に変更します。ここはマシンスペックにもよるので、100から300の間で設定をチューニングしながらスループットを確認してください。これまでのCommunityでは、この値は80が推奨されていましたが、2020-06-24にSophosより公開されたBest Practice Guideではスループットを確認しながら100〜300の間で設定する事が推奨されています。ここでは中央値の200を設定しています。\n\nBest Practice Guide https://community.sophos.com/cfs-file/__key/communityserver-discussions-components-files/258/Securing-your-Sophos-XG-Firewall-_2D00_-Best-Practice-Guide.pdf\n\nconsole&gt; set ips maxpkts 200\n\nアプリケーションフィルタの設定とにかくアプリケーションの数が多い事と、今後もメンテナンスしていく事を留意して設定します。高リスクというカテゴリであっても、ホームユーザーが利用するアプリケーションもそれなりにあります。ここでは、リコメンドされた拒否アプリの拒否設定をしつつ、ユーザー側で許可する設定を加えていく事になります。ただし下手にアプリを個別選択するようなフィルタにしてしまうと、新しいアプリケーションが追加される都度、メンテナンスが必要となってしまいます。従いリスクの高いアプリケーションは停止を原則とし、自分が許可するアプリの設定を加え、以後はなるべくメンテナンスが不要となるように設定します。\nXGの左メニューのアプリケーションのアプリケーションリストの右上に”分類”というフィルタがあります。このフィルタをクリックし展開すると、新規&#x2F;認証済み&#x2F;許容&#x2F;未認証とあります。これはクラウドアプリケーションとして登録されているものが対象となります。左ペインメニューのアプリケーションからクラウドアプリケーションで内容が確認できます。\n\n\n“未認証”というのは不許可の意味です。デフォルトで、”新規”か”設定なし（空白）”となっています。リスクの高低によらず、自身で”認証済み”または”許容”としたものは許可する事になります。またリスクが低くとも明らかに使わないものは”未認証”を設定すると、そのアプリケーションは直ちに拒否されるようになります。\n具体的にリコメンドされた高リスクアプリケーションを止める設定をしていきます。以下の数字の順番に設定を行ってください。最後に設定したものがルールとして一番上（優先）に位置します。\n\n\n\n項番\n対象\n内容\n推奨\n\n\n\n1\nRisk4,5のアプリ\nハイリスクアプリケーションは拒否する\nSophos\n\n\n2\nP2P Proxy\nFirewallで電文が解読できない宛先は拒否する\nSophos\n\n\n3\nDNS QNAME,OpenVPN\nアプリケーション個別指定で拒否設する\nSophos\n\n\n4\n自身で許容\n上記で拒否するアプリケーションであっても自身で許容して利用するアプリケーションを列挙する。ホームユーザー向けには、EXEファイル・ZIPファイルなど\n筆者\n\n\n5\n未認証\nクラウドアプリケーションで通したくないものについて拒否する\n-\n\n\n6\n許容、認証済み\nクラウドアプリケーションで許容する或いは様子をみるものは許可する\n-\n\n\nアプリケーションフィルタの設定方法\nXGの左メニューのアプリケーションのアプリケーションフィルタから、”追加”ボタンをクリックしてください。フィルタの名前を決めます。テンプレートは”Allow ALL”のままで構いません。ここでは、”Block High Risk Apps”と命名します。\n\n\n\n\n以下のようにカテゴリでリスクのプルダウンからHigh、Very Highのものを選択し、アクションは”拒否”を選び保存してください。\n\n登録が完了するとリスクの高いアプリケーションが並びます。\n\n\n\nアプリケーションフィルタの追加ボタンをクリックし、フィルタを追加します。今度はカテゴリから、P2PとProxyを選び、アクションは”拒否”を選び保存します。\n“DNS QNAME”と”OpenVPN”とをフィルタします。一番右側のプルダウンのスマートフィルタにqnameと入力し、Enterキーを押下してください。一旦”DNS Multiple QNAME”が絞り込まれスマートフィルタの欄が空白になりますので、引き続きopenvpnと入力し、Enterキーを押下してください。これで2つのフィルタが絞り込まれているので、”拒否”を選択し、”保存”をクリックしてください。\nご自身で利用しているアプリが高リスクまたはP2PとProxyに含まれる場合の除外設定です。ログビューアでアプリケーションフィルタログを見ながら拒否されてしまった対象を除外する設定が必要です。ホームユーザーには最低限度EXEファイルおよびZIPファイルは必要でしょうから、スマートフィルタを活用しexe file、zip fileと入力し、許可と設定します。\nフィルタの分類から”未認証”を選ぶと、自動で”Cloud Application”が選択されます。これを”拒否”として保存します。\nフィルタの分類から”許容”と”認証済み”を選択し、アクションは”許可”として登録します。\n\nクラウドアプリケーションの画面では、以下の通り、過去に通信のあったアプリケーション一覧が表示されます。既に安全と分かっているものについては、classifyから分類を”認証済み”にマークできます。未認証と設定した場合は、アプリケーションフィルタで即座に通信が停止されます。\nこれでアプリケーションフィルタの設定は終了です。今後Sophosによりフィルタが定期的に追加されていきますが、リスクの高いアプリケーションは自動的にフィルタされる事になります。また、クラウドアプリケーションはリスクが高でも即座に拒否とはなりませんので、上記の記載のとおり、定期的にクラウドアプリケーションの利用状況を確認してください。\nWebフィルタの設定続いてWebフィルタの設定を行います。フィルタとその内容は以下の通りです。\n\n\n\n対象\n内容\n\n\n\nIPAddress\nIPアドレスでアクセスするサイト\n\n\nNone\nカテゴリに該当しない通信\n\n\nParked Domains\nドメイン取得後放置されているドメイン\n\n\nSpam URLs\nスパムメールに含まれるURL\n\n\nAnonymizers\nセキュリティと制御を回避する目的をもって運用されるProxyなど\n\n\nCommand &amp; Control\n感染したマシン上の悪意のあるソフトウェアからのC2C通信\n\n\nPhishing &amp; Fraud\nフィッシングサイト\n\n\nSpyware &amp; Malware\nスパイウェア、マルウェア\n\n\nUncategorized\n分類不能なサイト\n\n\nWebフィルタの設定方法\nXGの左ペインメニューの、Web、ポリシーから、”追加”ボタンをクリックします。\n\n\n\n\n上記の図のとおり名前を入力します。ここでは、”Home Policy”とします。デフォルトは許可で、その上に拒否するルールを追加していきます。\n以下の図のとおり拒否する対象を選択する時には”すべて表示”とし、全てのカテゴリを表示させ、選択してください。\n登録が終わったら、画面の最下部にある、変更を適用をクリックしてください。\n最後にWebの全般設定をクリックします。\n\n\n認識されていないSSLプロトコルをブロックにチェックします\n無効な証明書をブロックにチェックします\nスキャンエンジンの選択は\"デュアルエンジン\"を選択します\n\nルールとポリシーの設定XGの左ペインのルールとポリシーで設定を見直します。デフォルトポリシーとしているルールを選択します。\n\n\nこれまでの記事では”To Internet”というデフォルトのルールを作ってきましたので、そのルールを修正します。\n\nWebポリシーに、\"Home Policy\"を設定します。\nアプリケーションコントロールに、\"Block High Risk Apps\"を設定します。\nSophos推奨のQUICプロトコルのブロックにチェックします。\n\nIPv6を有効にされている方は、IPv4と同様にIPv6のポリシーを設定してください。\nSSL&#x2F;TLSインスペクションルールの確認いよいよ設定も最後です。XGの左ペインメニューのルールとポリシーからSSL/TLSインスペクションルールに進み、右上のSSL/TLSインスペクションの設定をクリックします。特に設定変更は不要ですが、以下の通りである事を確認してください。\n\n\n除外した設定ベストプラクティスとして記事に記載のある中で今回設定していないものがあります。以下の記載の部分です。\n\nAllow only HTTPS, HTTP, DNS, ICMP, SMPT. Services on LAN→WAN\n\nこれはPsiphonおよびTor（トーア）Proxyの対策で、ビジネスの現場においては、恣意的にFirewallを回避させるケースを想定しています。端的に言えば、HTTPS、DNS、メール等の通信許可するポートを最低限にせよというものです。これを制限すると個人で利用する音楽のストリーミングやSNSなど多くのアプリケーションが動作しなくなる可能性があります。アプリケーションを全て特定し、宛先サーバーと利用ポートを全て管理するのは個人向けとしては現実的ではありません。願わくば、Torの個人利用はお控えいただいて、この設定を不要とすることをお勧めします。そのうち、XGのアプリケーションフィルタで対応出来るようになる事を期待しましょう。\n動作確認ログビューアを開き、”ファイアウォール”、”アプリケーションフィルタ”、”Webフィルタ”を確認します。IPアドレスで接続するもの・カテゴリ無し・分類不能とされたWebフィルタは拒否されるケースが多くあります。ここは状況に応じて除外設定が必要です。\n[1]　アプリケーションフィルタの説明で、”新しく起動またはアップグレードされたアプリケーションを自動的に次のグループに分類するアプリケーションフィルタ機能が含まれています”と記載されています。クラウドアプリケーションについてはその通りの解釈ですが、アプリケーションフィルタについては起動された場合ではなく、”Sophos社がアプリケーションフィルタを追加した場合”と解釈してください。\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"パスワード管理ソフトのbitwardenを活用する","url":"/new-technology/2020/08/30/bitwarden/","content":"\n\nパスワード管理はソフトウェアに任せる「安全快適にリモートワークを行う」で記載したように、リモートワークの活用機会が高まり、ますます各自のパスワード管理が重要になってきています。頭ではパスワードの使い回しは良く無いと理解していながら、結局は文字列＋数字で似たようなパスワードをいくつも作ってしまい、脆弱な状態にあるケースは多いように感じます。パスワード管理ソフトの導入はITリテラシが高く無いとなかなか取り組む機会はありませんが、個人のパスワードと会社のアカウントに利用しているパスワードが類似しているのは問題です。同僚とパスワードを共有してしまうという問題も多くあります。先日のニュースでは国内企業のVPNの脆弱性からパスワードが漏洩し、2要素認証を設定していた企業は救われたと記事になっていました。ここで紹介するパスワード管理ソフトですが、パスワードを管理する事と、ランダムな文字列でのパスワード生成機能の2つの機能を持ちます。また、このbitwardenは、パスワードが登録されたサイトに遷移すると指紋認証や顔認証等でパスワードが入力されます。当然ながら、URLが異なればパスワードを自動入力しないため、フィッシング対策にもなります。このプロダクトは無償、有償と選択が可能ですが、無償でも十分な機能を保持しています。\n\nパスワード管理の目指す姿\n信頼できるソフトウェアを活用する（bitwarden社について）\nクロスプラットフォームで複数のチャネル、有名なブラウザーに対応し利便性が高いこと\nパスワード生成機能は所定の文字数で任意に数字や記号を含められること\nネットに繋がらなくてもパスワード管理ソフトを利用できること\n可能な限り2要素認証を組み合わせること\n容易にバックアップが取得できること\n本当に重要なIDこそ自分で記憶する。金融に関わるパスワード管理\nクラウド管理かオンプレミス（ローカル環境）か\n\n\n信頼できるソフトウェアを活用する（bitwarden社について） プロダクトを提供している企業のプライバシーポリシーがしっかり記載され、どの国に属するかが記載され、本人の同意なく情報を開示しないという基本事項がプライバシーポリシーに記載されている事は重要です。曖昧に記載している企業のソフトウェアはお勧めしません。最終的に企業が属する国の命令には逆らえませんが、明瞭である事は重要です。オープンソースである事などは、さらに企業のスタンスが明確です。\n\nクロスプラットフォームで複数のチャネル、有名なブラウザーに対応し利便性が高いこと クロスプラットフォームである事は利便性が高くなります。Windowsだけで使えても、スマホでは別管理というのではじきに使わなくなってしまいます。Windows、macOS、iOS、Androidに対応している事は必須条件でしょう。スマホやタブレットなどでは指紋認証や顔認証でスムーズにパスワードを利用できる事が前提です。\n\nパスワード生成機能は所定の文字数で任意に数字や記号を含められること サイトによっては文字列数の下限、上限が異なります。また記号の一部が含められないなどサイトによってルールは異なります。パスワード管理ソフトでは、サイトによって任意にルールを定めたうえで生成できる事が求められます。\n\nネットに繋がらなくてもパスワード管理ソフトを利用できること ネットに繋げるためのパスワードや、ブラウザから利用するものがパスワード管理の全てではありません。クローズネットワークやスマホの機内モードであったとしても重要なデータにアクセスする機会はあり得ます。これはソフトウェアのデザインですが、bitwardenはそのシチュエーションを踏まえたソフトウェアのデザインがなされています。\n\n可能な限り2要素認証を組み合わせること これはユーザー側に求める要件です。パスワードが漏洩する可能性を踏まえ、利用するサイトやサービスでは2要素認証を設定しておくべきです。パスワード自体を第三者に預けられる前提が2要素認証です。もちろん、bitwardenからパスワード全体が漏洩する事は企業の存続に関わるわけですし、その可能性は低いと考えられますが完璧と考えるべきではありません。今や2要素認証はサービス提供業者の基本提供機能ですからパスワードが万が一漏洩しても水際で防ぐ事ができます。なお、使い方の注意として2要素認証のキーとなる要素をbitwardenに保存するべきではありません。2要素認証で有名なAuthyはバックアップパスワードなどの存在がありますが、これは主に利用するパスワード管理ソフトとは別に管理すべきです。\n\n容易にバックアップが取得できること パスワードは漏洩する事が最悪の事象ですが、ロストすると回復に時間を要し、大幅な時間をロスします。各個人の責任でバックアップは取得しておくべきです。bitwardenは、csvまたはjson形式で簡単にエクスポートできます。これを暗号化されたUSBメディアなどにバックアップし、ネットとは繋がらない場所に保管しておく事が求められます。\n\n本当に重要なIDこそ自分で記憶する。金融に関わるパスワード管理 オンラインバンキングなど、漏洩した時には直接金銭的、かつ高額となり得るものはパスワード管理システムから除外される事をお勧めします。2要素認証があるのは当然としても、です。もちろん上述した暗号化されたUSBメディアに保存しておく事でも構いません。ネットで到達できる場所に保存されるべきではありません。クレジットカードの盗難とは異なり、オンラインバンキングではユーザー側の重過失によって補償減額、または補償せずという取り扱いになりえます。これはパスワードを記載した手帳を盗まれた、パスワードをスマホに保存してあったものが盗難されるなどした場合もユーザー側の重過失にあたる可能性があります。そのアカウントの利用でどういったリスクがあるのかを考えIDとパスワードを管理していく必要があります。●●payのQR決済もオンラインバンキング程は高額にならないものの、金銭流出のリスクがあります。主要なQR決済事業者は不正利用に対して補償するというスタンスが主流ではあるものの、パスワード管理におけるユーザー側の過失があれば補償されない可能性があります。各企業の約款、補償の事項に必ず目を通す必要があります。全ては個別事案での判断という事なのでしょうが、そもそもパスワードの使い回しは過失と言われても仕方がないのではないでしょうか。金融分野は極めてリスクが高いという事になります。QR決済は少額決済ですが、2要素認証は必須といえるでしょう。英単語と数字の単純な組み合わせではない複雑さを持ったパスワードを設定される事をお勧めします。\n\nクラウドかオンプレミス（ローカル環境）か 自宅のPCでパスワード管理する事とbitwardenのようにクラウドで管理する事のどちらが安全かと言われれば判断は難しいところです。ちなみに、bitwardenはオンプレミスで構築できます。実際に過去、ubuntu18.04LTSにdocker、docker composeを導入し、bitwardenをセットアップし利用していた事があります。ダイナミックDNSはno-ipを使い、SSLは無償のLet’s Encryptにbitwarden自身が登録すれば完了です。3カ月ごとにスクリプトを走らせればSSL証明書を自動更新し、dockerから最新イメージを自動ダウンロードしてシステムを最新に保ちます。Linux上でMS SQLServerが動作し、bitwardenはコンパクトながらとても技術の高さを感じました。しかし、個人でWAF導入やアクセスログのチェックなどセキュリティ対策を実施する事の難易度の高さも感じ、再びクラウド管理に戻しました。ビジネス目的にて、インターネットに接続されない企業内でbitwardenを活用するのは非常に良い方法です。個人のサイバーセキュリティ対策で実現可能な事は資金面やスキル面でも限界があります。隙を見せず、目立たず狙われにくい事が大切です。\n\n\nbitwardenの利用方法bitwardenのWebサイトで最初にアカウントを作成します。\n\nhttps://bitwarden.com\n\n\n\nアカウント作成の最初の画面こそ英語ですが、実際のアカウント作成画面は日本語となります。利用するアプリも日本語ですので扱いはとても簡単に感じます。\n\n\nアカウントの作成が終了したらWebにログインし、もし現在利用されているパスワードマネージャがあるのであればインポートできます。ChromeやFirefoxのパスワードをcsvに一旦出力し、インポートもできます。bitwardenではこのパスワードの集合体を保管庫と呼んでいます。\n\n\n続いて設定タブから2要素認証を設定します。おなじみのAuthyやメール通知を選択できます。\n\n\n次に、PCであれば、端末毎にbitwardenのクライアントアプリケーションおよび利用するブラウザの拡張機能としてbitwardenをインストールしてください。上記の画面ではYubikey、Duo、FIDOがプレミアム版としての表記がありますが、無償版のbitwardenであっても、生体認証に対応しています。プレミアム版に登録しDuoを選択した場合は、2要素認証の6桁の数字を入力する事なく、シングルサインオンでスマホに通知がきますので以下のように”Approve”をタップするだけでログインが完了します。これはあくまでbitwardenのログインの話であって、各サイトのログイン時にシングルサインオンが可能になるわけではありません。\n\n\nDuo Securityは2018年にCisco社が買収しています。CiscoのAnyConnectを使う場合の2要素認証に使われるもので、どちらかといえば法人がターゲットです。最近だとMicrosoft365でも使えるようになりました。個人利用は無償です。\n\nDuo Security https://duo.com\n\n\n\n“Free Trial”と言われると基本は有償サービスのように感じますが、”Free Trial”からアカウントを作成し、速やかに無料アカウント（Duo Free）に切り替え可能です。bitwardenとの連携は以下のようにDuoの画面からbitwardenの情報を元にID、秘密鍵、APIサーバーを設定します。そしてスマホアプリの”Duo Mobile”をセットアップし利用します。\n\n\nそもそもコストの低いbitwardenでDuoのPushサービスが利用できるという事は、Duoは法人向けの利用料も廉価なのでしょうか。今後色々なサービスでもDuoを利用する機会が増えてくる事が期待されます。\nbitwardenの設定bitwardenに対しパスワードの入力の都度、毎回マスターパスワードを入力するのは大変な作業で現実的ではありません。2要素認証を設定していれば、初回こそマスターパスワードと2要素認証が必要ですが、2回目以降のログインでは同一クライアントまたは同一ブラウザであれば2要素認証は不要です。bitwardenはさらにpinによる簡易な対話型認証をし、保管庫にアクセスする事が可能となります。\n\n\nPINによるロック解除ブラウザの拡張機能からbitwardenを呼び出し、”設定”から保管庫のタイムアウトはブラウザ再起動時とし、PINでロック解除にチェックします。すると右側の画面がポップアップするので、簡易なPINコードを決めたら入力し、”ブラウザー再起動時にマスターパスワードでロック”のチェックボックスは外します。最後に”送信”ボタンをクリックし確定します。\nこれでブラウザーを再起動しても、再びマスターパスワードは不要でPINコードで保管庫にアクセスできます。\n生体認証によるロック解除（スマホ）スマホの場合は最近では生体認証がほぼ使える状態でしょう。iOSであればbitwardenの”設定”から”Face IDでロック解除”をチェックします。Androidの場合も同様にbitwardenの”設定”から”生体認証でロック解除”を設定します。\n生体認証によるロック解除（PC）スマホと同様ですが、bitwardenの仕組みはブラウザから生体認証するときにデスクトップアプリのbitwardenとやりとりして認証します。ブラウザ起動後、最初にbitwardenを使う場合はロック解除が必要ですが、この時にデスクトップ版のbitwardenをあらかじめ起動しておくことが必須です。\nWindowsのbitwardenでは、Windows Helloに対応しています。生体認証が付いていないPCであっても、Amazonなどで安価に（2,000円強）で指紋認証のUSBドングルが販売されているのでこちらを利用可能です。Windows Helloのセットアップも難しくはありません。USBに挿せばドライバを自動セットアップしてくれます。Windowsのログイン、bitwarden共に指紋認証が行え便利です。\n\nAmazon 【Amazon.co.jp 限定】SEKC USB指紋認証キー Windows Hello機能対応 0.05秒 指紋認証でセキュリティ対策 SFSD-01 https://www.amazon.co.jp/gp/product/B07GLRQPHP/\n\nOSのWindows Helloの設定が無事完了すると、bitwardenアプリでも生体認証が行えるようになります。設定から”生体認証でロック解除”をチェックします。また、ブラウザの拡張機能としてbitwardenをインストールし、拡張機能版のbitwardenでも同様に生体認証を設定します。\nmacOSでも設定内容はWindowsと同じです。macbookであればTouch IDが使えるので、Touch IDでアプリ、ブラウザ共にロック解除が可能です。私が知る限りでは、SafariとMicrosoft EdgeではTouch IDで解除できますが、mac版Firefoxでは生体認証によるロック解除は使えませんでした。\nなお、生体認証といえばYubikeyが挙げられますが、これはWindows Helloに対応させた運用をするのは難しく、Windows Hello対応の指紋認証デバイスを購入されることをお勧めします。（なんだかややこしい書き方をしていますが、YubikeyではWindowsローカルアカウント前提とか色々運用上の制約があります）。\nその他カスタマイズする箇所としてはクリップボードの消去で、他のアプリケーションからクリップボードの中身を読み取られる可能性を考え、速やかに消去する設定がお勧めです。\n（2020-09-30追記）iOS14から、クリップボードを読み取ったアプリケーションについて画面上部に表示される機能が加わりました。これまでこっそりクリップボードの内容を読み取っていたアプリ提供者も釈明に追われる事でしょう。そのようなアプリは多くないようですが、パスワードや他の重要な情報を読み取られてしまうリスクを念頭に対処してください。\nアカウント作成時の実例アカウント作成時に、どのようにパスワードを自動生成し登録していくのかを動画にしてありますので参考にしてください。\n\n\n実例として価格comのサイトへのアカウント作成の挙動です。価格comは半角英数の8〜12文字という制約があります。記号は使えません。パスワードの規則に添うようにパスワードを生成します。\n一度登録してしまえば、ブラウザからのログインはとても簡単です。\n\n\nサイトによって挙動は異なるのですが、価格comの場合、ログインボタンをクリックするだけで、あとは勝手にbitwardenがIDとパスワードをセットしてくれます。\nこれで、たくさんのパスワードに悩まされる事なく、パスワードの使い回しによる、”利用者の過失”というリスクから解放されます。私は、個人向けのセキュリティ対策はまず最初に認証管理が重要と考えています。なかなか興味が向かない分野ですが、参考にしていただければ幸いです。\n（補足）bitwardenの脆弱性についてbitwardenはオープンソースであるが故に、いろいろな脆弱性を見つけられ、指摘を受ける可能性があります。実際にJPCERT&#x2F;CCとIPAとの共同で提供されている、脆弱性対策情報データベースであるJVN IPediaから、bitwardenの脆弱性を検索できます。\n\nJPCERT&#x2F;CC https://www.jpcert.or.jpIPA https://www.ipa.go.jpJVN IPedia https://jvndb.jvn.jp/index.html\n\nJPN IPediaでbitwardenについて検索すると、2件該当し、直近では2020年7月18日に公開された「JVNDB-2020-008246 Bitwarden Server におけるサーバサイドのリクエストフォージェリの脆弱性」が見つかります。セキュリティの専門家は、このサーバーサイドリクエストフォージェリはかなりリスクが高い内容と認識しています。端的に言えば、bitwarden Serverを踏み台にし、そこからネットワーク内の別のサーバーの情報を抜き取る事が可能（かもしれない）という脆弱性です。またCVSSv3の値が7.5と定量的にもリスクが高い事を示しています。JVN IPediaは速やかに情報共有を行うのが目的であって、ユーザーがどう対応するか、または修正が完全であるかどうかの評価を行いません。この修正に関しては、JPN IPediaから辿ると、bitwardenのGitHub上のプルリクエストが行われており、内容はhackerOneから7月16日に指摘されたものでIPv6が混在した場合の脆弱性とわかります。このやりとりを見れば7月18日には修正が行われマージコミットされています。そして7月29日にはVersion1.36.0の提供が行われ、対応完了という流れになります。Version1.36.0については以下を参照してください。\n\nbitwardenのGitHub上のプルリクエスト https://github.com/bitwarden/server/pull/827hackerOne https://www.hackerone.comVersion 1.36.0(GitHub) https://github.com/bitwarden/server/releases/tag/v1.36.0\n\n実際に、クラウド上でbitwarden社がどのように運用しているかまでは公開されていません。一般的には多重化されたサイバーセキュリティ製品で守られており、そう簡単に攻撃が成功するケースは無いものと考えられますが、ユーザーがオンプレミスで運用している場合で、インターネットにbitwarden Serverを公開している場合は高いリスクといえます。そのような理由で私も一時はインターネット接続を認めない形でLAN内のみでオンプレでbitwarden Serverを運用していたものの、こういった情報を頻繁に追っていくのがあまりに大変であるため、再びクラウドの利用に切り替えたという次第です。\nhackeroneに対しては、あくまで企業の意思で登録するもので、bitwarden社はhackeroneへの登録を行っています。hackeroneに登録されたハッカーは脆弱性を見つけた場合には報奨金を得る仕組みとなっています。ハッカーの中には報奨金を寄付に回す人達もいます。bitwarden社のモデルはかなり勇気のある行動で自分たちの技術力に自信が無いとなかなかこういった行動は取れないでしょう。\nサーバーセキュリティ製品なのでサーバーサイドからクライアントに対し緊急パッチを当てる機能は必須です。しかし、「開発者がOSの特権を用いてやりたい放題の脆弱性」だと指摘されるケースもあります。それが脆弱性だとしたらアプリケーションを何もインストールできなくなってしまいます。そういったケースも含めてオープンに説明責任を果たし、ユーザーに考える機会を与える事、信頼を蓄積していく事がプロの仕事でありプロダクトの信頼性に繋がると私は考えています。\n","categories":["Security"],"tags":["bitwarden"]},{"title":"auひかり BL3000HM","url":"/new-technology/2023/01/28/bl3000hm/","content":"\nこの記事で実現すること\n\nauひかりの新しいホームゲートウェイ（HGW)に交換してみたのでレポートします。ONUと一体型となったモデルです。Wi-Fi6Eにも対応しています。私はauひかりのWi-Fiは契約していないため、Wi-Fi以外の基本性能・機能について紹介します。\n\n\nauひかりホームユーザー向け、HGW交換の案内auひかりではこれまでもユーザーの希望によるホームゲートウェイの交換について、半導体不足により一時的に交換を停止していましたが、昨年末に再開するという案内がありました。\n\n2022&#x2F;12&#x2F;22 auひかり ホームゲートウェイ：お客さまのご要望による交換（希望交換）の再開について https://www.au.com/information/notice_internet/service/20221220-01/\n\n私はこれまでホーム5ギガユーザーとしてBL1000HW（HGW）と10G-PON（ONU）をレンタルで利用していましたが、ONU一体型のHGWになるということで多少のレイテンシと消費電力の改善期待があり早速交換のお願いをしました。交換には3,300円掛かるとの記載があります。電話回線が2回線ある場合はBL3000HMには交換できないようです。インターネット回線によるスピードテストでも3ギガ程度は出ており全く不満はありませんが、5ギガと10ギガの差額が月額780円なので、10ギガの契約に併せて変更もしました。\nauひかりホーム10ギガ・5ギガについてauひかりのホーム10ギガ・5ギガサービスは関東圏の一部エリアのみ提供となっています。IPv4&#x2F;IPv6デュアルスタックで複雑な設定が不要で高速インターネットが利用できます。ホーム10ギガ・5ギガのサービス説明は以下を参照してください。\n\nauひかり ホーム10ギガ・5ギガ https://www.au.com/internet/auhikari_10-5g/\n\n基本情報、マニュアルは以下を参照してください。\n\nauひかり ホームゲートウェイ Aterm BL3000HM https://www.au.com/support/service/internet/guide/modem/bl3000hm/\n\nBL3000HM年末に申し込んで年明け早々にBL3000HM（BL3000：右側）が届きました。BL1000（左側）も大きかったですがBL3000はかなり大きいと感じます。交換は自分で行います。\n\n\n横幅28cm程度もありますね。私の場合はクローゼットの中に収まるので大きさは特に気になりませんが、リビングに配置するとなると少し目立つサイズです。\nBL3000には、上記写真にある通り、ひかり回線と接続するコネクタ付きのシングルモードファイバケーブル（約3m）が既に取り付けられています。説明書には約3mと書いてありますが、これ3mもあるかな。。。その他付属品として電源ケーブル（アース無し）とLANケーブル（1.5m）があります。\n\n\n\n機種\n消費電力\nアース\nLANケーブル\n\n\n\nBL3000HM\n45W（最大）\n無し\nCat6A STP\n\n\nBL1000HW\n34W(最大)\n無し\nCat6A STP\n\n\n10G-EPON\n14.3W以下\n無し\nCat6A STP\n\n\n最大消費電力だけで見るとBL1000とONUとを合計したものとBL3000と比較した場合は大して変わりません。BL1000、BL3000共にWi-Fi機能を持ちますから、Wi-Fiを使わない場合はそれなりに電力が抑えられているものと思います。付属のケーブルは前回も今回も変わらず、Cat6Aのシールドツイストペア（STP）です。STPを使う場合には正しいアースが云々というご意見もあるようですが、短いケーブルについて気にすることは無いということでしょう。LAN4というRJ45の口が10GbEですが、5G&#x2F;2.5G&#x2F;1G&#x2F;100Base-TXにも対応しています。\n早速、BL3000のファイバケーブルを光回線に接続し直し、LANケーブルを10GbEポートに接続し、電源を入れてみます。\n\n\n普段のアイドル状態で16.35w、2.5Gbps程度のアップロード時で16.5Wです。やはりネットワーク機器なのでNATやフィルタ処理などを除いたルーティングは通信専用のチップ（ASIC）が対応するため通信量と電力とは殆ど関係ありません。\n回線速度さて、いつものSpeedtestです。HGWとスイッチとをRJ45で接続し、スイッチとMacBook-AirとをSFP+で接続して計測してみます。平日の夕方に計測しました。\nHGWのLANに接続\n\n\nSophos Firewall（TLS／SSLインスペクション有り）を通した速度\n\n\nHGWのLANに接続した場合は5Gbps以上の速度が出ています。一方、FirewallのTLS&#x2F;SSLインスペクションを通しても下りはさほど落ちていません。上りは流石にデータ漏洩の観点から厳しくチェックするのでこれくらいには落ちてしまうのは仕方がないところでしょうか。自宅内のFirewallを通してもレイテンシ（Ping）が3ミリ秒という表示になっており、かなりの低遅延のネットワークになっていると言えそうです。これまでは4ミリ秒でした。\n朝方の計測はHGW直結で5Gbps〜6Gbps程度の速度です。\nログ機能今回のHGWは簡単なログ機能が付いています。HGWのデフォルトのLANのIPアドレスは192.168.0.1/24です。\n\n\nスイッチ部分BL1000HWと同様、BL3000HMも10GbEが1Port、1GbEが3Portとなります。\n\n\n一般的に、スイッチ機能を持つ1Gのチップ（PHY）は4Port単位で組まれることが多いです。10GbEと1GbEと合わせて4Portというのは、実際に10GbEに対応した4PortのPHYに1GbEの3Portが接続されているのでは？と妄想してしまいます。\n10Gポートと1Gポートとのスループットはどうでしょうか。10Gポートには、Mellanox Connect-X3(10G SFP+)を挿したUbuntu22をSFP+スイッチ経由で接続し、1GポートにはMacBook-AirにPlaggableのUSBアダプタを挿してiperf3を実行してみます。\nyoshi@ub22:~$ iperf3 -c 192.168.0.3Connecting to host 192.168.0.3, port 5201[  5] local 192.168.0.4 port 48032 connected to 192.168.0.3 port 5201[ ID] Interval           Transfer     Bitrate         Retr  Cwnd[  5]   0.00-1.00   sec   115 MBytes   963 Mbits/sec    0   3.77 MBytes[  5]   1.00-2.00   sec   112 MBytes   944 Mbits/sec    0   3.77 MBytes[  5]   2.00-3.00   sec   112 MBytes   944 Mbits/sec    0   3.96 MBytes[  5]   3.00-4.00   sec   111 MBytes   933 Mbits/sec    0   3.96 MBytes[  5]   4.00-5.00   sec   112 MBytes   944 Mbits/sec    0   3.96 MBytes[  5]   5.00-6.00   sec   112 MBytes   944 Mbits/sec    0   3.96 MBytes[  5]   6.00-7.00   sec   112 MBytes   944 Mbits/sec    0   3.96 MBytes[  5]   7.00-8.00   sec   112 MBytes   944 Mbits/sec    0   3.96 MBytes[  5]   8.00-9.00   sec   111 MBytes   933 Mbits/sec    0   3.96 MBytes[  5]   9.00-10.00  sec   112 MBytes   944 Mbits/sec    0   3.96 MBytes- - - - - - - - - - - - - - - - - - - - - - - - -[ ID] Interval           Transfer     Bitrate         Retr[  5]   0.00-10.00  sec  1.10 GBytes   944 Mbits/sec    0             sender[  5]   0.00-10.03  sec  1.10 GBytes   941 Mbits/sec                  receiver\n\n文句なしのパフォーマンスです。このタイミングでワットチェッカーを確認してみました。\n\n\n10GbEに加え、1GbEのRJ45をBL3000HMに接続しているため、ベースの消費電力は16.787Wとなっています。10GbEのみと比べ、0.43W消費電力が増えています。これにiperf3を実行したタイミングでは、16.84Wとなり、僅か0.07W弱の消費電力が上昇しています。非常に誠実な作りであると思われます。\n10GのPHYは単体であったり、2Port、4Portと様々な種類がありますが、他の製品のHGWやWi-Fiルーターで1GbEが4Port、10GbEが1Portある製品を見た時には、それらを繋ぐのはどうやっているのかな？と気になります。ASICではなくCPU（ソフトウェア）で相互にパケットをやり取りしている製品もあるらしく、10GbEと1GbEの通信のパフォーマンスが出ないそうです。\nレイテンシとアプリケーション私は10Gbpsのトラフィックを必要としていませんが、こういった多段のセグメントを介するネットワーク構成(VLAN)&#x2F;仮想環境&#x2F;Firewall&#x2F;アンチウィルス&#x2F;アプリケーションFirewallを組み合わせているため、少しでもレイテンシが大きくなるのを防ぎたいという狙いがあります。こうやって全体を俯瞰して見ると、セキュリティのためとはいえ、レイテンシが大きくなるような事ばかりしているわけです。\n私の使っているアンチウィルスソフトのBitDefenderはそれ単体でTLS&#x2F;SSLインスペクションを実行するため、なおさら遅くなります。\n最近のファイル転送プロトコルであればファイルのやり取りに高度な並列処理を実施することでトータルのデータ転送量を稼ぎますが、アプリケーションによっては単一のTCPセッションによるやり取りとなります。そのようなアプリケーションはいくら回線が太くても、到底大きな転送量はこなせません。数10Mbps程度の速度でもレイテンシが大きく関係するようになります。\n高速回線と聞けば、ストリーミングビデオを思いつく方が多いでしょうか。4Kの映画や音楽配信サービスなどは負担が大きそうに思えるかもしれません。しかしこのようなサービスはデータの先読みができて、いくらでもバッファに積めます。1秒後どころか1分後に再生すべきであろうデータは全て読み込んでおけるので回線が多少不安定でも並列度を高めてデータ受信することで全く問題ありません。しかし、電話であればそうはいきません。データの安定度を高めるために0.2秒程度のバッファは持ちますが、それ以上のバッファを持ち、遅延させると電話による会話が噛み合わなくなります。現代のリモートワークでも同時に発言してお互い譲り合うというのは見慣れた光景かもしれません。ホームユーザーであれば、リモートワークはもちろん、オンライン授業・コミュニティや友人・家族・親戚とのビデオ通話などが該当するでしょう。こういったビデオ通話ではデータの先読みが殆ど出来ないため、ネットワークの品質とレイテンシが大きく影響します。\n私はオンラインゲームはしませんが、これもビデオ会議と同様でしょう。TCP通信では遅すぎるのでUDP通信でアプリケーション固有のプロトコルでやりとりすることになるでしょうか。私は自宅の環境でパケットロスを認識できるほどの経験はありませんが、回線の太さ以前に、パケット損失が大きく出てしまうプロバイダや回線業者もあるようです。私が10ギガネットワークを使いたいというのは光回線で、通信業者自体が持つバックボーンに（レイテンシが極めて小さい）大型ネットワーク機器が収容されていることを期待しています。さらに言えば、Apple、Googleなどの主要IT、CloudflareやAkamaiなどのCDN（コンテンツ・デリバリ・ネットワーク）、AWSやAzureなどのクラウドサービスにネットワーク的に近い環境が好ましいとも言えます。\n私が利用しているSophos Firewallではレポート機能でビデオ会議のトラフィックを確認できます。\n\n\nConferencing でフィルタすると、Teams会議、Zoom会議がクラウドアプリケーションとして判定され、サーバーIPアドレスも列挙されます。\n\n実例として、Microsoft365のTeamsのサーバーにpingでレイテンシを計測してみます。\n\n\n10分程度、pingの往復レイテンシを計測しています。平均4.6msであり、非常に低レイテンシでスパイクもせいぜい20ms以下ですから安定していると言えます。サーバーIPアドレスをGeo Locationで見ると場所は米国のマイクロソフト社になりますが、レイテンシから鑑みると関東近辺のデータセンターになると思われます。私の感覚的なものですが、米国の西海岸までは純粋なネットワークだけで往復100msのレイテンシ、東海岸までは往復150ms程度はあるはずです。実際のサーバーとの往復だと数百msにはなるようです。\nなお、PCをWi-Fi6接続に変更すると、6.8msとなり、2.2ms遅延が追加されます。\nauひかりのホーム5ギガ、ホーム10ギガの違い今回、HGWの交換によって若干のレイテンシ改善は確認できましたが、スループットとして大きく変わるような結果はありません。恐らく地域によって結果は大きく異なると思われます。なお、auひかりの場合は増速の際には事前の調査が必要なようで、混雑している地域だと10ギガへの変更が行えないとの事。ここ2、3年で1ギガを超える光回線の提供も随分浸透してきたと思われるので、時間帯によって帯域制限が加わっているような感覚をお持ちの方は一度確認されてはいかがでしょうか。\n契約変更機器交換には3,300円必要とauのホームページには記載がありましたが、以下の案内が事後に郵送されてきました。3,300円の交換に加えて2,000円の交換手数料が掛かるがそれは無料ということなのか、そもそも3,300円ではなく2,000円になるのか、或いは都合良く解釈すれば機器交換は無料なのか。。。また、プロバイダがau one netで10ギガに増速した場合、12ヶ月の間、780円（税込858円）を割り引くとの事です。こちらも次月の請求がわかったところでアップデートしたいと思いますが、そもそもの最初の契約の仕方によって人それぞれで割引プランが異なるのかもしれませんね。（私はプロバイダはau one netでどこのアフェリエイトも通さず、直接auひかりに申し込みしています）\n\n\n(2023-2-23更新）1月の請求を確認しました。キャンペーンの月額割引は日割りもあり、ピッタリ一致していませんが、計算上は780円の割引になっていました。また、機器交換の請求は現時点でありませんでした。\n補足新しいHGWを接続してから、しばらくしてIPv6アドレスが割り当てられていない事に気づきました。結局は翌日の昼頃に特にHGWを再起動したわけでもないですが、IPv6が割り当てられていました。環境変更後、少し時間が掛かるようです。\n","categories":["Hardware","Network"],"tags":["10GbE"]},{"title":"ESXI7.0をRyzen7 5700Gで構築","url":"/new-technology/2022/02/27/building-setup-esxi7/","content":"この記事で実現すること\n\n最近、改めて無償版ESXi7.0向けのハードウェアをRyzen CPUをベースにセットアップし直したので参考までに掲載します。vmの動作などは全く問題ありませんが、ESXi自身のセキュアブートだけはうまくいきませんでした。参考になればと思い記録を残します。\n\n\nご注意事項2024&#x2F;1&#x2F;22に発表されたVMWareブログによりますと、スタンドアロン製品の提供を終了し、サブスクリプションモデルに変更されることとなりました。この無償版ESXiは今後提供停止となりますが、サポートは継続されるとの事です。無償版ESXiの利用にあたっては、まずこちらの記事「VMWare 無償版ESXiの提供終了について」を参照されることをお勧めします。\nESXi7のためのハードウェア選定検討ハードウェア選定については以下のポリシーとしました。私はパワーユーザーではなく、1つの仮想マシン（vm)に大きな能力を求めていませんが、LinuxやFirewallなどを中心にvmの数だけは増えていきそうな気がします。これまで使っていたハードウェアは10GBase-TのNICも含めてかなり熱を出していたのでもう少し省電力を求めて探しました。\n\nCPUは多くのvmを動かすことが想定されるが省電力を意識したい\n筐体はスリムタイプ（Micro-ATX）でグラフィックカードは積まず貴重なPCIeスロットはネットワークカードに使う\nネットワークカードはintelかMellanoxが候補。熱対策が必要なので10Gbase-Tではなく、SFP+を中心に検討\nストレージは高速化のためNVMeにしたい\n\nハードウェア構成以下のハードウェア構成となりました。\n\n\n\nパーツ\n製品名\n\n\n\nCPU\nRyzen7 5700G 3.8GHz(Radeon Graphics)\n\n\nマザーボード\nGIGABYTE B550M S2H Micro-ATX\n\n\nメモリ\nSanMax DDR4-3200 1.2Volt Skhynix(88H) 32GB x 2\n\n\nNVMe\nSamsung 970EVO Plus PCIE x Gen3 x 4 1TB\n\n\nSSD\nWesternDigital Blue 500GB\n\n\nNIC\nipolex OEM (intel X710 chipset) 10GbE SFP＋ 4Port\n\n\n電源\nスリムタイプ 300W電源\n\n\nキーボード・マウス・NICを除き163,480円でした。NICはダイレクトアタッチケーブル2本を含め$531でした（送料と関税入れると＄580程度）。\nCPU毎回の説明ですが、ESXiにおいてはリテール向けのCPUは公式にサポートされていません。intelのCore iシリーズは鉄板ですが、AMD Ryzenでも動くようだという記事もちらほら見かけるようになりました。ESXi7.0になって、AMDのZEN3アーキテクチャをサポートするという内容（具体的にはEPYCに対応する）についてVMWareの方が説明しているビデオを見た事があり、ZEN3アーキテクチャのRyzenなら安定動作が見込めるのではないかと考えました。 私の場合省電力のPCを必要としていました。省電力ながらCPU8コア16スレッドは魅力です。Ryzen7 5700GはTDP65Wなので、全体で100W程度の省電力マシンを構築することを目標としました。ヘッドレスシステム、いわゆるキーボードもマウスもディスプレイ（グラフィックカード）も持たないESXiでのGPUレスのセットアップもあるようですが、トラブル時の緊急対応や後々のクライアントPCとしての再利用も視野に入れ、GPU付きのCPU(APU)を選択しました。\nマザーボード秋葉原のパソコンSHOPアーク（Ark)にカスタマイズモデルがあり、それをベースに選択しました。無線LANや2.5GbEなども使う必要がないのでシンプルなマザーボードのGIGABYTE B550M S2H Micro-ATXを選定しました。\n\n\nメモリ安定していると評判の国内メーカーのものを選定しました。\nストレージVMware Commmunityで970EVO Plusが動作するという情報が数件あったのでそれを参考に選定しました。980 Proなどそれ以上の魅力的な製品もありますが、Ryzen7 5700Gを選定しているため、PCIe x 3の制約があり、その上限に合わせた製品にしました。\n\n\nネットワークカードそれなりの数のvmを動作させるとなると必然的にNICは10Gbpsを用意したくなります。過去からintel X550-T2を使ってきてそのまま使い続けるのでも良かったのですが、私の場合、クローゼットに光回線とモデム、CD管が集約されてしまっていることから、そこにあまり熱の出すハードウェアを置けません。次回はSFP&#x2F;SFP+にしようと決めていました。が、NICについては昨今の半導体不足で、欲しいカードは殆ど品切れの状態です。それでAmazon.comでipolexというSFPメーカーがOEM提供しているintel X710のチップが乗った4Portの10GbEカードを購入しました。intel純正のX710のSFP+4Portはフルハイトのカードですが、このipolex社のNICはロープロファイルでしたので私にとっては都合が良いものでした。\n\n\nなお、2023-2-8時点でamazon.comでもintel純正のSFP+モデルは完売、X710チップが乗った2Portの3rdベンダー製品で$270です。\nESXi7.0u3cのインストールUEFIの設定UEFIについては、以下の項目を設定しました。\n\n\n\n項目名\n設定値\n\n\n\nSVM mode\nEnable\n\n\nFast Boot\nDisable\n\n\nCSM Support\nDisable\n\n\nSecure Boot\nAdvanced\n\n\nしかし、最終的にはセキュアブートでインストールされませんでした。\nVMware Communityでも見かける内容ですが明確な答えは無いようです。これはマザーボードとESXiとの相性と考えられますが、今後もウォッチしていきたいと思います。\n\nhttps://communities.vmware.com/t5/ESXi-Discussions/Enabling-Secure-Boot-not-possible/m-p/2864968\n\n（2023-7-6更新）事後にある手順を経てESXi8.0でセキュアブートでセットアップすることができました。セキュアブートの手順はこちらの記事「ESXi8.0をRyzen5 5600Gで構築」を参照してください。\nインストールこれまで同様、Rufusで32GBのUSBメモリにISOファイルを登録しUSBブートからセットアップしています。64Gbyteのメモリを認識し、NICも4つ認識されました。\n\n\nNICの情報はこちらです。\n\n\nipolexはさらに製造をアウトソースしているのでしょうか、単に販売代理店でしょうか。MACアドレスを見る限りでは、「Beijing Sinead Technology」が製造しているようです。購入にあたってはipolexのサポートの方と色々やりとりができましたので安心して購入できました。\nストレージコントローラは以下の通りです。NVMe 1GBに加え、バックアップ用途で500GBのSSDを加えています。\n\n\n旧マシンからvmの移行環境が異なるため、vSwitchやポートグループの設定はやり直しになりました。NASに対するNFSのマウントなど、いくつかの作業はありますが、そう重い作業ではありません。旧マシンでghettoVCBのバックアップから新環境にレストア、こちらも特段問題がなく3つのvmはあっさり30分程度で終了です。セキュアブートにしていたubuntuやWin10などは問題なく起動しています。\nストレージのパフォーマンスvmのWindows10で実行したCrystal Disk Markの結果です。\n\n\nネットワークのパフォーマンスこちらはWindows10Proのvmから10GbEのNASに対するiperf3の結果です。シングルスレッドだと7Gbps程度が限界のようです。元々、Windows版のiperf3はUNIXからの移植のためのヘルパー機能であるランタイムライブラリ「Cygwin1.dll」を使っておりパフォーマンスが出づらい状況にあります。さらに対向する端末の能力が高くないとこのような結果になりやすいです。10並列でようやく期待値となりました。\n\nシングルスレッド\n\nC:\\Users&gt;iperf3 -c 192.168.x.x[ ID] Interval           Transfer     Bandwidth[  4]   0.00-10.00  sec  8.48 GBytes  7.29 Gbits/sec                  sender[  4]   0.00-10.00  sec  8.48 GBytes  7.29 Gbits/sec                  receiver\n\n\n10スレッド\n\nC:\\Users&gt;iperf3 -c 192.168.x.x -P10[ ID] Interval           Transfer     Bandwidth(省略)[SUM]   0.00-10.00  sec  10.9 GBytes  9.33 Gbits/sec                  sender[SUM]   0.00-10.00  sec  10.8 GBytes  9.28 Gbits/sec                  receiver\n\nubuntu20は問題なしです。\nuser@ubuntu1:~$ iperf3 -c 192.168.x.xConnecting to host 192.168.x.x, port 5201[  5] local 192.168.x.x port 55808 connected to 192.168.x.x port 5201[ ID] Interval           Transfer     Bitrate         Retr  Cwnd[  5]   0.00-1.00   sec  1.09 GBytes  9.39 Gbits/sec    0   1.69 MBytes[  5]   1.00-2.00   sec  1.07 GBytes  9.20 Gbits/sec    0   1.69 MBytes[  5]   2.00-3.00   sec  1.10 GBytes  9.42 Gbits/sec    0   1.69 MBytes[  5]   3.00-4.00   sec  1.09 GBytes  9.40 Gbits/sec    0   2.10 MBytes[  5]   4.00-5.00   sec  1.10 GBytes  9.42 Gbits/sec    0   2.21 MBytes[  5]   5.00-6.00   sec  1.09 GBytes  9.40 Gbits/sec  696   1.75 MBytes[  5]   6.00-7.00   sec  1.09 GBytes  9.41 Gbits/sec    0   1.75 MBytes[  5]   7.00-8.00   sec  1.10 GBytes  9.42 Gbits/sec    0   1.75 MBytes[  5]   8.00-9.00   sec  1.10 GBytes  9.42 Gbits/sec    0   1.75 MBytes[  5]   9.00-10.00  sec  1.06 GBytes  9.10 Gbits/sec    0   2.22 MBytes- - - - - - - - - - - - - - - - - - - - - - - - -[ ID] Interval           Transfer     Bitrate         Retr[  5]   0.00-10.00  sec  10.9 GBytes  9.36 Gbits/sec  696             sender[  5]   0.00-10.00  sec  10.9 GBytes  9.34 Gbits/sec                  receiveriperf Done.\n\n速度としては問題ありませんが、ubuntu側にRetrの数字が出ており、対向側端末の能力不足で送信側のTCPの再送が稀に入っています。\n電力チェック簡単な負荷テストを実施してみました。このESXi上にある仮想マシン2つを使ったテストです。ubuntu(2vCPU)からfast.comへの速度テストとSophos Firewall(4vCPU)でIPSによるSSL&#x2F;TLSインスペクションの負荷試験です。回線契約はauひかりの5Gbpsですが、FirewallのSSL&#x2F;TLSインスペクションが入るのでスループットは落ちます。CPUリソースおよび電力の記録は以下の通りです。\n\n\n\n\n\n\nCPU使用率は綺麗に分散していますしまだ半分ほど余力があります。Sophos FirewallのIPSは4つのスレッドで動作すると聞いていたことがあったので、1つのスレッド（vCPU）に偏るか最大4つのスレッドに偏るかと思いましたが、良い意味で予想は外れました。電力については、何もしていない時で35W、速度テスト実施中でも100Wに到達しない程度です。\nちなみに、数分速度テストを実施した後のダイレクトアタッチケーブルのSFP+モジュール部分は冷たく感じる程度で全く熱を持っていませんでした。\nSFP+について今回、SFP+の4PortのNICを選択しましたが、インターネット接続側のホームゲートウェイ（HGW)は従来のRJ-45の端子であることが殆どです。この場合は以下の選択肢があります。\n\n拡張性のあるマザーボードを選定し、2つのPCIeスロットに2枚のネットワークカードを挿す（1つはRJ45、1つはSFP＋）\nRJ45ポートとSFP＋ポートを持つスイッチングハブを経由し、ESXiからスイッチにはSFP＋で接続、スイッチからHGWにはRJ45で接続する。この場合はスイッチにおけるLAN側、WAN側とをVLANでネットワークセグメントを分離する必要があります（私はこの方法を選択）。\nSFP＋からRJ45への変換専用の小さなスイッチを用意する（CRS305-1G-4S+IN)。但し、この場合もRJ45変換のSFP＋トランシーバーは必要です。\n\n\nMikroTik\n\n https://mikrotik.com/product/crs305_1g_4s_in\nお勧めしないのは、NICのSFP＋ポートにRJ45変換のための10Gトランシーバーを接続することです。10GのRJ45トランシーバーは最大3W程度の消費電力ではありますが、触れなくなるほど高熱（70℃）になり、NICに接続するのはNIC破損の危険が高いです。またPCIからSFP+ポートへの電力供給不足でリンクアップしなかったり、2.5Gでリンクアップする場合があります。スイッチに10Gトランシーバーを接続する場合、ネットワーク機器を販売しているMikroTikでは以下のガイダンスを提示しています。\n\nMikroTik S+RJ10 general guidance 前述の通り、S+RJ10(10Gbps RJ45トランシーバー)は通常のトランシーバーよりも発熱が大きく、特にリニアSFPケージを4つ持つデバイスでは、並べて置くとオーバーヒートにつながる可能性があります。S+RJ10は2個おきに配置し、その間に光トランシーバーか空きポートを確保することをお勧めします。\n\n https://wiki.mikrotik.com/wiki/S%2BRJ10_general_guidance\nMikroTikのS+RJ10は高発熱で有名なモジュールですが、他の10GBase-T SFP+モジュールも相当な温度になります。トランシーバーの作りに問題があるわけではなく、そもそも10GBase-T（RJ-45）はかなりの発熱になってしまい、スイッチングハブであっても内部は相当な熱を持ちます。\nSFP+の詳細な情報については「 10GネットワークとSFP+ 」にまとめてあります。\nMellanoxの現行モデルはやはり在庫を殆ど見かけない状況ですが、Nvidia（Mellanox）のサイトではESXi7.0&#x2F;8.0のドライバはConnect X-4以上を対象にしています。\n\n\n\nMellanox End of Life Notification Procedure https://network.nvidia.com/related-docs/eol/LCR-000532.pdf\n\nintel X710の注意点についてX710は省電力で安定した動作をしますが、過去に何度もファームウェアの脆弱性が指摘されています。今の半導体不足の外部環境下において、もはやintel純正を購入することは困難ですが、サードパーティ製のNICでX710のチップが乗ったものを購入する場合であっても、ファームウェアの更新が必要になってきます。ESXiにおけるネットワークカードのファームウェアの更新方法も整理していますので、以下の記事を参照してください。\n\nESXiでネットワークカードのファームウェアを更新する\n\n","categories":["Hardware"],"tags":["ESXi","10GbE"]},{"title":"ESXi8.0をRyzen5 5600Gで構築","url":"/new-technology/2023/07/07/building-setup-esxi8/","content":"この記事で実現すること\n\n1年半前に、「ESXI7.0をRyzen7 5700Gで構築」の記事で、Ryzen7 5700GでESXi7のセットアップをしました。今回はESXi8.0の動作確認も含めてRyzen5 5600Gでセットアップしました。\n\n\nご注意事項2024&#x2F;1&#x2F;22に発表されたVMWareブログによりますと、スタンドアロン製品の提供を終了し、サブスクリプションモデルに変更されることとなりました。この無償版ESXiは今後提供停止となりますが、サポートは継続されるとの事です。無償版ESXiの利用にあたっては、まずこちらの記事「VMWare 無償版ESXiの提供終了について」を参照されることをお勧めします。\nESXi8のためのハードウェア選定検討実は最初からESXi8をセットアップするつもりはなく、WindowsPCを新調するつもりでした。私はゲームはやらないので、せいぜい4Kのビデオが見られれば十分というPCの使い方をしており、ビデオカードを購入する事は殆どありません。パソコン工房で「STYLE-S0P5-R55G-EZX」という5600Gを積んだ機種が8万円台と安かった事もあり、あまり深くは考えずに注文しました。\n\nパソコン工房 https://www.pc-koubou.jp\n\nハードウェア構成注文したPCは以下の構成でした。【OS】Windows 11 Home　【プロセッサー】AMD Ryzen 5 5600Gプロセッサー (3.9-4.4GHz&#x2F;6コア&#x2F;12スレッド&#x2F;16MBキャッシュ&#x2F;TDP 65W)　【CPU冷却グリス】【熱伝導率： 9W&#x2F;m K】 シルバーグリスArctic Silver 5塗布サービス　【CPUクーラー】静音CPUクーラー Wraith Stealth[トップフロー]　【グラフィックアクセラレーター】Radeon Graphics(CPU統合グラフィックス）　【メインメモリ】16GB(8GB×2)[DDR4-3200 &#x2F; デュアルチャンネル］　【1stストレージ［OSインストール］】500GB SSD &#x2F; NVMe M.2[PCIe 3.0×4]　【チップセット】AMD B550チップセット　【サウンド機能】High Definition Audio subsystem　【内蔵ネットワークカード】有線：1000BASE-T ※無線機能はついておりません　【光学ドライブ】DVDスーパーマルチドライブ［LG GH24NSxx]　【電源】400W[80PLUS BRONZE認証］&#x2F; TFX電源　【ケース】スリムタイプMicroATXケースHEC 7KJC[フロントUSB3.0]ブラック\nさて、PCが届いてから、ハードウェアを確認したところ、NVMeはウェスタンデジタルのBlueが組み込まれていました。また、マザーボードはASRock社のものです。そういえば、前回のESXi7.0のセットアップでは、セキュアブートは断念していました。Win11 Homeがセットアップされているモデルでしたが、WDのBlue（SN570）が入っていた事もあり、ふつふつとESXi8.0をインストールしたいと思い始め、ESXi8をクリーンインストールする事にしました。\nストレージ前回は、VMware Commmunityで鉄板だった970EVO Plusでした。ESXiではSamsungが確実という印象でしたが、980 Pro NVMeでは、ファームウェアの不具合で故障率が高いという報告が上がっています。ESXiはNVMeストレージの種類を選ぶため事前調査が必要ですが、今回、何となくうまく行くだろう感があってBlue（SN570）にESXi8をセットアップしました。結果、全く問題ありませんでした。なぜかESXiの事例としてあまり出てこないのが不思議です。。。\nうまく行かなければ、William Lam氏のNVMeに関する情報で、SabrentのRocket Plus NVMeを試そうと思っていたところでした。https://williamlam.com/2023/02/quick-tip-additional-nvme-vendors-sk-hynix-sabrent-for-esxi-homelab.html\nネットワークカード前回は、intelのX710のSFP+4Portを使いましたが、今回はSFP28の検証も兼ねてMellanox Connect X-5を選定しました。Connect X-4はWindowsやNASで使おうと計画してます。前回はセキュアブートがうまく行かなかった点は課題でしたが、実はそれが功を奏したところもありました。X710のESXiのドライバーはデフォルトではフローコントロール（pauseパラメータ）がオフになっています。それで、ブート時に、/etc/rc.local.d/local.shにpauseパラメータを有効にする設定を加えていました。もし、セキュアブートであれば、/etc/rc.local.d/local.shにスクリプトを記述しても無視されます。\nUEFIの設定さて、UEFIのリベンジです。色々な情報をこれまで収集し、セキュアブートの初期化をすればセキュアブートが可能と調べがついていました。\n最初、Secure Boot ModeをCustomに変更し、Install default Secure Boot keysを実施した上でセットアップしましたが、セキュアブートでインストールされませんでした。以下のページでGIGABYTEのマザーということでセキュアブートに関する情報がありました。\nhttps://support.pcdiy.newx.co.jp/hc/ja/articles/6572156997657--GIGABYTEマザーボード全般-Secure-Boot-の設定方法について\n\nRestore Factory Keys を選択していただき、ポップアップが表示されますのでYes(はい)を選択してください\n\n今回のマザーボードはASRockですが、以下の手順でセキュアブートにできました。\n\nSecure Boot ModeをNormalからCustomに変更する。\nClear Secure Boot Keysを実行する\nInstall default Secure Boot keysを実行する。\nSecure Boot ModeをNormalに戻す。\n\nこの手順を踏んでセットアップ開始したところ、無事セキュアブートが可能になりました。無償版ESXiはTPMは使えませんので、単に改ざん防止という事になります。簡単な確認方法として、セキュアブートが有効である場合、ESXiの管理コンソールのセキュリティとユーザーの許容レベルをパートナーからコミュニティに変更できなくなります。また、前述したlocal.shもスキップされます。\nインストールこれまで同様、Rufusで32GBのUSBメモリにISOファイルを登録しUSBブートからESXi8.0Update1aをセットアップします。なお、セットアップされる場合はVMWareのサイトで最新のバージョンを確認下さい。\nVMWare ESXi8.0https://customerconnect.vmware.com/jp/evalcenter?p=free-esxi8\n\nメーカーはiiyamaなのに、なんでMouseComputerなんだろう。。。\nネットワークドライバーはnmlx5_coreとなっています。SFP28のDACケーブルをスイッチに接続し、vmnic0が25Gbpsでリンクアップしています。\n\n\nESXi8にセットアップしたUbuntu22ではOS上は10GbEと認識していますが、速度は23Gbps近くは出ています。\n\n\nUbuntuからの送信\nyoshi@ub22:~$ iperf3 -c 192.168.x.20Connecting to host 192.168.x.20, port 5201[  5] local 192.168.x.182 port 47676 connected to 192.168.x.20 port 5201[ ID] Interval           Transfer     Bitrate         Retr  Cwnd[  5]   0.00-1.00   sec  2.61 GBytes  22.4 Gbits/sec  6519    967 KBytes[  5]   1.00-2.00   sec  2.54 GBytes  21.9 Gbits/sec  5013   1.01 MBytes[  5]   2.00-3.00   sec  2.50 GBytes  21.4 Gbits/sec  3376    667 KBytes[  5]   3.00-4.00   sec  2.57 GBytes  22.1 Gbits/sec  5961    612 KBytes[  5]   4.00-5.00   sec  2.53 GBytes  21.8 Gbits/sec  4767    648 KBytes[  5]   5.00-6.00   sec  2.57 GBytes  22.1 Gbits/sec  6294    765 KBytes[  5]   6.00-7.00   sec  2.55 GBytes  21.9 Gbits/sec  4271    489 KBytes[  5]   7.00-8.00   sec  2.56 GBytes  22.0 Gbits/sec  3493    573 KBytes[  5]   8.00-9.00   sec  2.55 GBytes  21.9 Gbits/sec  5756    789 KBytes[  5]   9.00-10.00  sec  2.58 GBytes  22.2 Gbits/sec  4816    546 KBytes- - - - - - - - - - - - - - - - - - - - - - - - -[ ID] Interval           Transfer     Bitrate         Retr[  5]   0.00-10.00  sec  25.6 GBytes  22.0 Gbits/sec  50266             sender[  5]   0.00-10.00  sec  25.6 GBytes  22.0 Gbits/sec                  receiveriperf Done.\n\nUbuntuの受信\nyoshi@ub22:~$ iperf3 -c 192.168.x.20 -RConnecting to host 192.168.x.20, port 5201Reverse mode, remote host 192.168.x.20 is sending[  5] local 192.168.x.182 port 44930 connected to 192.168.x.20 port 5201[ ID] Interval           Transfer     Bitrate[  5]   0.00-1.00   sec  2.68 GBytes  23.0 Gbits/sec[  5]   1.00-2.00   sec  2.73 GBytes  23.4 Gbits/sec[  5]   2.00-3.00   sec  2.72 GBytes  23.4 Gbits/sec[  5]   3.00-4.00   sec  2.73 GBytes  23.4 Gbits/sec[  5]   4.00-5.00   sec  2.73 GBytes  23.4 Gbits/sec[  5]   5.00-6.00   sec  2.73 GBytes  23.4 Gbits/sec[  5]   6.00-7.00   sec  2.73 GBytes  23.4 Gbits/sec[  5]   7.00-8.00   sec  2.73 GBytes  23.4 Gbits/sec[  5]   8.00-9.00   sec  2.73 GBytes  23.4 Gbits/sec[  5]   9.00-10.00  sec  2.73 GBytes  23.4 Gbits/sec- - - - - - - - - - - - - - - - - - - - - - - - -[ ID] Interval           Transfer     Bitrate         Retr[  5]   0.00-10.00  sec  27.2 GBytes  23.4 Gbits/sec  279             sender[  5]   0.00-10.00  sec  27.2 GBytes  23.4 Gbits/sec                  receiveriperf Done\n\n受信は25Gbpsのワイヤレートが出ています。Ubuntuからの送信側では再送が多いようです。これはまだESXiの構成または設定の問題なのか私の環境の問題なのかは分かっていません。NVidiaのサイトのInboxドライバの情報はESXi8.0向けは4.23.0.36-8vmwという事になっています。\n\nNVIDIA Native Drivers for VMware ESXi Inbox Drivers Release Notes https://docs.nvidia.com/networking/display/VMwareESXiInboxDriversReleaseNotes\n\nなお、最新のESXi8.0Update1aでのMellanoxのドライバのバージョンは以下の通りです。NVidiaのサイトのものよりも新しいですね。これはまた次回にドライバが更新されるかもしれません。\n[root@localhost:~] esxcli software vib list | grep nmlxnmlx5-core                     4.23.0.36-14vmw.801.0.0.21495797     VMW     VMwareCertified   2023-04-29    hostnmlx5-rdma                     4.23.0.36-14vmw.801.0.0.21495797     VMW     VMwareCertified   2023-04-29    host\n\n色々な情報を探してみてもやはりESXi7.0の情報は充実しており、まだESXi8.0は安定というには早いかなと感じます。\nESXiにおけるNICのフローコントロールについてESXiにはフローコントロールの制御について、送信、受信のpauseパラメータを設定できます。Connect X-5を使っている状況でESXiにSSHし、以下のコマンドでpauseパラメータの状況が確認できます。\n[root@localhost:~] esxcli network nic pauseParams listNIC     Pause Params Supported  Pause RX  Pause TX  Auto Negotiation  Auto Negotiation Resolution Avail  RX Auto Negotiation Resolution  TX Auto Negotiation Resolution------  ----------------------  --------  --------  ----------------  ---------------------------------  ------------------------------  ------------------------------vmnic0                    true      true      true             false                              false                           false                           falsevmnic1                    true      true      true             false                              false                           false                           false\nPause Params Supportedがtrueの場合は、フローコントロールの機能を持っています。Pause RXがfalseだとスイッチからpauseフレームの通知を無視してしまいます。またPause TXがfalseだと自身が飽和した時にpauseフレームを送信しません。上記ではデフォルトでフローコントロールがオンになっています。\n一方、ESXi7.0のintel x710では、以下の結果になりました。Pause RX&#x2F;TXがfalseとなっています。\n[root@esxi2:~] esxcli network nic pauseParams listNIC     Pause Params Supported  Pause RX  Pause TX  Auto Negotiation  Auto Negotiation Resolution Avail  RX Auto Negotiation Resolution  TX Auto Negotiation Resolution------  ----------------------  --------  --------  ----------------  ---------------------------------  ------------------------------  ------------------------------vmnic0                    true     false     false             false                              false                           false                           falsevmnic1                    true     false     false             false                              false                           false                           falsevmnic2                    true     false     false             false                              false                           false                           falsevmnic3                    true     false     false             false                              false                           false                           false\n\nこの場合は、前述した、/etc/rc.local.d/local.shにフローコントロールをOnにするコマンドを列挙します。\nesxcli network nic pauseParams set -n vmnic0 -t t -r tesxcli network nic pauseParams set -n vmnic1 -t t -r tesxcli network nic pauseParams set -n vmnic2 -t t -r tesxcli network nic pauseParams set -n vmnic3 -t t -r t\n\n繰り返しですが、これはセキュアブートではない場合にのみ設定が可能です。10GbEとWi-Fiなど、速度差がある端末同士で効率の良い通信を行うためにはフローコントロールは必要と言えます。フローコントロールが無い場合、私の環境ではWi-Fi6のiperf3の例では900Mbps→750Mbps程度には劣化します。Wi-Fi電波の範囲ギリギリとかWi-Fiの別のAPへのローミングなどセンシティブな箇所で安定度が高まるとお考えください。\nフローコントロールはこのようにホスト側での設定とネットワークスイッチ側と双方で有効にしておく必要があります。\nなお、ESXiにおいて少し高度な話としては、Single Root I&#x2F;O Virtualization（SR-IOV）による仮想マシンにNIC（NICが持つ仮想機能）を直接割り当てる方法で高速化する方法もあります。Windows ServerやRed Hat Enterprise LinuxなどOSを選びますが今後機会があればテストしてみます。\n\n\n※ESXi上のUbuntuはSR-IOVに対応していません。\nまとめ25GbEはあくまで実験的に検証しているものであり、私自身がパワーユーザーではない事もあり、今のところメインは10GbEとし、スイッチ間を25GbEで使うつもりでいます。ただし、アプリケーション同士で9Gbps程度の速度が25GbE環境下で出ているからといって、ネットワークを10Gbpsに変更しても影響が出ないかと言われるとそうでもなく、7Gbps程度に落ち込むケースも確認できています。今後色々検証していきたいと考えています。このブログで紹介している25GbEは簡単に接続できているように見えますが、私の使っているネットワークスイッチ（Ubiquiti PRO Aggregationスイッチ）とMellanox Connect Xカードとの相性が良い事もあります。\n","categories":["Hardware"],"tags":["ESXi","25GbE"]},{"title":"XG Firewall v18のポリシーをカスタマイズする","url":"/new-technology/2020/03/14/customize-policy/","content":"この記事で実現すること\n\nXG FirewallのWebポリシーをカスタマイズし、コンテンツのカテゴリ（ギャンブル、アダルト、Webメール）毎にアクセス可否を設定します。また閲覧を拒否する情報をインターネット上にあるデータベース等から入手し、XGに取り込めます。\n\n\nポリシーのカスタマイズXGにおけるWebのポリシーというのはコンテンツのカテゴリを意味し、カテゴリによってアクセスを認めない制御が可能です。ギャンブル、アダルトからネットショッピングやチャットやWebメールまで多岐に渡ります。設定するには左ペインメニューのWebをクリックします。\n\n\n”Default Policy”の内容がまず最初に表示されているはずです。初期値では、”Blocked URLs for Default Policy”と2番目の行に”Risky Downloads”および”Suspicious（※怪しいもの）”が選択されています。”Risky Downloads”、”Suspicious”が含まれていると、Google検索で”広告”という表示のあるページを正しく表示出来ない場合があります。レイヤ7Firewallルールのポリシーはこういった箇所のカスタマイズが重要となります。これらのポリシーは、SophosのWebカテゴリの記事にも日本語の解説があります。この内容を見ながらWebポリシーのカスタマイズを行ってください。この部分は防御というよりは倫理の概念です。膨大なサイトの分類が既に登録されている事は素晴らしい事ですが、さらに自分で分類を追加できます。\n\nSophos XG Firewall: Web カテゴリ https://community.sophos.com/kb/ja-jp/134155\n\n外部データベースを取り込む（2021-10-16更新）この章で説明しているモバイル広告ブロッカーは作者様の都合によって国内の企業に譲渡されました。長い間、一般ユーザーに貴重な情報をご提供いただいた事に感謝いたします。また、新しい引き継ぎ先でも当面ファイルの提供は継続されるとの事です。詳細は以下を参照してください。\n\n280blocker -280blockerの今後の運営について- https://280blocker.net/blog/20210921/3055/\n\n\n\nXGは外部のデータベース（ドメインのリスト形式）を取り込む事が可能です。ここでは「280blocker | モバイル広告ブロッカー」のデータ（ドメインテキスト形式）を取り込んでみます。名称の通り、スマホでの広告をカットするために利用されるデータベースです。利用については、ダウンロードのページの注意事項の確認をいただき、ご自身で利用の判断をお願いします。\n\n280blocker ダウンロードページ https://280blocker.net/download/\n\n　280blockerのページでは、ファイルのダウンロードLinkをクリックしてもダウンロードできません。”URL中の6桁のｘを現在の年・月の6桁の数字へ変更してください。”と記載されている通り、URLの修正が必要です。\n\n\n\nダウンロードするデータとして”ドメインテキスト形式”をダウンロードします\nXGの左ペインメニューのWebを選択し、”カテゴリ”のタブをクリックします\n名前は”280blocker”とします\n分類は”Objectionable”とします\n設定のカテゴリはローカルのラジオボタンを選択します\ndomainのインポートから、先ほどダウンロードしたファイルを選択し取り込みます\n“保存”ボタンをクリックします\n\n\n\n\n引き続き、Webのユーザーアクティビティをクリックします。\n\n画面右上の追加ボタンをクリックします\n名前は”280blocker”とします\n先ほど”カテゴリ”で作成した”280blocker”を選択し適用します\n最後に”保存”ボタンを押します\n\n再びWebのポリシータブをクリックし、”Default Policy”の内容を表示します。ここで右側の編集（ペンのアイコン）を選択します。\n\nルールの追加ボタンを押すと、先頭にルールが作成されます\n\n\n\n\n先頭ルールのアクティビティを選択し”すべてのWebトラフィック”を削除し、”280blocker”を追加します\n“アクション”は”HTTPをブロックする”という赤い盾のバツ印が表示されていますが、そのままにします\nステータスのトグルをOnにしてください\n最後に画面を下にスクロールし、保存ボタンをクリックします\n\nこれでブラウザやスマホなどで広告のあるサイトを閲覧すると広告が消えている事がわかります。また、ログビューアからWebフィルタを選択すると、”カテゴリ”に280blockerとURLが表示され赤字で拒否されています。スマホに広告ブロッカーを導入する事と結果は同じですが、XGで一括管理できるのとクライアントOSの種類に限らずIoTにも有効ですので導入する価値はあります。\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"XG Firewall v18でLAN内のホストをインターネットに公開する","url":"/new-technology/2020/04/11/dnat/","content":"この記事で実現すること\nXG Firewall v18において、LAN内のホストをインターネットへ公開できます。また日本国内からのアクセスに限るなど、防御を高めます。\n\n\n\n今回の説明の環境についてインターネットから宅内の環境に対し、VPNを使わず直接アクセスするケースを説明します。ネットワークストレージ（NAS）へのアクセスやWebサーバーのコンテンツ公開を対象としています。この記事ではインターネット側にホームゲートウェイ、その内側にXG Firewallがあり、さらに内側にLANがある事を前提とします。XG Firewallでは、一般的なルーターと同じように内部のホストをインターネットに公開するためには設定が必要となります。一般的な用語でもありますが、Sophosでは、このような外から内へのパブリックIPとプライベートIPとの変換を伴う接続形態をDNAT（Destination NAT）と呼んでいます。\n\n\n設定においては、上記の2つのサブネット（XGのWAN側、LAN側）があり、ホームゲートウェイ側からXGのWANインタフェースに対するポートフォワード、そしてXGからLAN内にあるホストへのポートフォワードとの2段階のポート転送が必要です。\nご注意\nこの記事はあくまで技術的にホストを公開する方法について記述していますが、昨今のサイバー攻撃はランサムウェアが猛威を奮っています。個人が行うサイバー攻撃対策ではとうてい太刀打ちできませんので、リスクを認識の上で設定してください。なお、インターネットから自宅のリソースへのアクセスは2要素認証付きのVPNによる接続をお勧めします。「XG Firewall VPNについて」の記事を参照してください。\n\n\n\nサーバーアクセスアシスタントv18では、サーバーアクセスアシスタントというウィザード形式で設定できる仕組みが導入されています。もちろん、このウィザードを使わなくてもDNATの設定は可能ですが、今回はウィザードを利用し設定します。\nホスト公開設定一般的な設定例として、内部にあるWebサーバーのhttpsアクセス（Port443）をインターネットから接続するケースで説明します。パブリックIPのPort443→プライベートIPのPort443に着信させる実例です。\nホームゲートウェイの事前設定VPNの導入の記事でも書きましたが、まずはインターネットから内部のホストにデータを届けるためには、ホームゲートウェイとXGそれぞれに設定する必要があります。以下のように、ホームゲートウェイでPort443のトラフィックをXGのWAN側IPアドレスに転送します。\n\n\nこの画面はホームゲートウェイの画面であり、契約しているインターネット回線業者により、提供される機器は異なりますのであくまで設定例という事で参考までに掲載しています。\nサーバーアクセスアシスタントの設定サーバーアクセスアシスタントを使ったDNATを設定します。まずXGの左ペインメニューから、ルールとポリシーを選択します。ルールの上にあるファイアウォールルールの追加をクリックし、サーバーアクセスアシスタントDNATをクリックします。そうすると以下のウィザード画面が表示されます。\n\n\nここでは、LANに設置してある、公開したいサーバーのIPとそのホストの名前を入力します。ここで入力したホストの名前とIPアドレスの組みは自動的にXGのIPホストとして登録されます。今回のケースではWebサーバーとそのIPアドレスを入力しています。入力後、次へをクリックします。\n2画面目では、以下のように公開したいパブリックIPアドレスを入力する画面となります。\n\nこれはパブリックIPアドレスからプライベートIPへ変換するためのマッピング情報の元となるものです。但し、注意点として、ここでの構成はあくまでホームゲートウェイによってプライベートIPに変換された後のXGのWAN側IPアドレス（つまりプライベートIPアドレス）を入力する事になります。XGのWAN側インターフェースのIPアドレスである、#Port2を選択し、次へをクリックします。\n3画面目では、内部に転送するサービスを選択します。Port443のHTTPSを選択しています。\n\n\n選択後、次へをクリックします。4画面目では、外部の送信元ネットワークとデバイスを選択します。\n\n\n表現が難しいのですが、WAN側のネットワークに制約を加える場合はここにネットワークの追加を行い、任意の設定を外す事になります。今回は、一旦はこのまま次へをクリックします。\n5画面目では、これまで設定してきた内容の確認画面となります。画面の後半にNATルールを3つ作成しますという記述があります。DNAT以外の2つは不要なので後から削除する事になりますが、これは後ほど説明します。\n\n\n保存して完了するをクリックしてください。これで、DNATの設定が完了しました。ルールとポリシーでは、作成されたルールは以下のようになっています。\n\n\n\nファイアウォールルールの一番上に新しいルールDNAT to xxxxが追加されています。引き続き、NATルールを見てみます。以下のように3つのルールが作成され、1番上にDNATルールが表示されています。\n\n\n\nこれでひとまず設定は完了しています。これでインターネットから内部ホストへアクセス出来るようになりました。\nDNSにプライベートIPを登録さて、インターネットからパブリックIPを使って内部ホストへアクセス出来るようになりました。一般的にはダイナミックDNSなどを用いてURLでアクセスする事になります。しかし宅内のLAN環境に入り当該サーバーへ同じURLを使って接続する場合は、わざわざパブリックIPにする事はなく、直接LANのプライベートIPに対してアクセスする事になります。この場合は、XGのDNSでスタティックとしてプライベートIPを登録します。左ペインのネットワークからDNSを選び、DNSホストエントリで、サーバーのURLとプライベートIPの組み合わせを登録してください。クライアントはXGのDHCPによってDNSがXG自身である事を指定されているため、当該ホストについてはプライベートIPでアクセス可能となります。\nDNATのウィザードで作成されるルールの詳細ウィザードでは、シンプルにまずは繋がる事を優先に最低限度の設定を行いました。まずDNATの理解を深めるために、ウィザードで作成されたファイアウォールルールのDNATについて見てみましょう。\n\n\n\n送信元とゾーンは、WAN\n宛先ゾーンは、LAN\nサービスは、HTTPS\n\n以上のように、それなりに理解出来るものが記載されています。しかし理解が進まないのは、宛先ネットワークの#Port2、つまりXGのWAN側IPアドレスが記述されている点です。宛先として直感ではLAN側のインタフェースである、#Port1のように感じます。まして、転送したいWebサーバーのホスト名が記載されている項目はここにはありません。実際のHTTPSのアクセスである、Webサーバーに転送するという項目はNATルールで記載されています。XG Firewll v18におけるDNATはポリシールールとNAT変換ルールはそれぞれ独立しているのです。\n\nLoopback NAT（不要） これはヘアピンNATとも呼ばれますが、内部ネットワークからパブリックIPアドレスを用いて再び内部ネットワークにある公開サーバーへアクセスしたい場合に使います。XGがWANの外に出ていこうとするトラフィックを無理やり内部の公開サーバーに振り向ける動作です。前述したとおり内部のホストには、DNSに登録したプライベートIPでアクセスするので不要です。\nReflexiv NAT（不要） これは普通に内部ホストからWAN向けのNATを伴う変換ルールです。インストール直後のSNAT（ソースNAT　※送信元アドレスを書き換える一般的なNAT）のルールが最初から存在している事、「XG Firewall v18のルールを作成する」において、To InternetというSNATのルールを作成しているので改めての作成は不要です。\n\nインターネットの接続可能な範囲を絞る公開するホストが国内からのアクセス用途に限定できるならば、少しFirewallらしい設定を加えてみましょう。ウィザードの4画面目で、任意とした外部の送信元ネットワークを活用します。もし、このWebサーバに対して日本国内からのアクセスに限れば、海外からの攻撃を防ぐ事ができます。この場合は、作成済みのDNATルールの送信元ネットワークとデバイスの任意を外し、Japanを加えてください。\n","categories":["Security","ホスト公開"],"tags":["XG Firewall"]},{"title":"VMware ESXiの仮想マシンをバックアップする","url":"/new-technology/2020/10/11/esxi-backup/","content":"\n\nこの記事で実現すること\n\n無償版ESXiの仮想マシンをバックアップ、レストアします。\n\n\nESXiのバックアップソフトウェア無償版ESXiの仮想マシン（VM)をバックアップするには以下の3つの選択肢があります。\n\nghettoVCBバックアップスクリプト（この記事で説明しています）\nSynology NASによるバックアップ「Synology NASでESXi仮想マシンのバックアップを取得する」を参照してください。\nNakivo Backup Free Edition 「無償版ESXiの高度なバックアップ」を参照してください。\n\nghettoVCBでバックアップするこのブログで紹介しているSophos Firewallは、ESXi上にセットアップする事をお勧めしています。その理由としては仮想マシンは比較的バックアップが取得しやすく、万が一のトラブル発生時に速やかに復元（レストア）しやすい事が理由でもあります。もちろん、Sophos Firewallには設定ファイルをバックアップする機能が存在しますが、バージョンアップやデバイスの入れ替え等何らかのきっかけでうまく稼働しなくなるリスクがあります。Firewall自体がOSとして起動するため、バックアップソフトウェアをインストールできません。このghettoVCBはESXi上で動作させるコマンドラインのスクリプトですが、利用は難しくありません。\nESXiのスナップショットESXiはスナップショットという機能を持っており、その時点の稼働状態について保存可能です。動画の一瞬を絵として切り取るという表現が適切でしょうか、これは一瞬で完了し、いつでもロールバックが可能です。複数の世代を持て使い勝手はとても良好です。ビジネスの世界では本番環境にパッチを当てる際などの最終確認フェーズで活用されます。つまり、万が一の時にはロールバックする事で速やかに以前の状態に戻す事が可能です。但し、このスナップショットを取ったまま長時間運用する事をVMWareは推奨していません。スナップショットを取得した後のメモリを含む稼働状況の差分をDiskに記録していく必要があり、これがパフォーマンスに悪影響を及ぼすためです。従い、スナップショットは恒久的なバックアップの役割にはなりません。\nghettoVCBについてこのghettoVCBはWilliam Lam氏が作成したMITライセンス（フリーソフト）のソフトウェアで、VMWareの正式な製品ではありません。但し、フリーのESXi向けにはデファクトスタンダードとも言えるスクリプトです。ソフトウェアはGitHub上にあります。以下のGitHubからCodeボタン→Download ZIPと進み、ghettoVCB-master.zipをダウンロードしてください。私はESXi7、ESXi8の環境で動作検証しています。\n\n\nghettoVCB(https://github.com/lamw/ghettoVCB )The ghettoVCB script performs backups of virtual machines residing on ESX(i) 3.x, 4.x, 5.x & 6.x servers\n\n\n\n\nhttps://github.com/lamw/ghettoVCB\n\nこのghettoVCBは前述したスナップショットを活用し、システムを止める事なくスナップショットを取り、バックアップを行ってくれるため非常に便利です。またバックアップを複数世代持つ事が可能です。単一のファイルとしてバックアップされるため、非常に取り扱いがしやすいのも特徴です。\nESXiをバックアップする製品はたくさん存在するのですが、基本はESXiの有償版が前提です。バックアップに使用されるvStorage APIは無償のESXi向けにはロックが掛かっており使えません。無償版ESXiにおける仮想マシンの基本的なバックアップはghettoVCBになります。William Lam氏のホームページは以下を参照してください。\n\nhttps://www.virtuallyghetto.com\n\nバックアップ先の準備ESXi上のディスクにバックアップを取得し、作成されたファイルをESXiのデータストアブラウザからダウンロードしたり、SCPを使いPCなどにファイルコピーする事は最もシンプルな方法です。しかし、NASがあると非常に便利です。最近のNASはNFSによるファイル共有が使えるので、予めNASに設定したNFSドライブをESXiからマウントし、その領域にghettoVCBでバックアップを取得するのがお勧めです。SynologyなどのNASメーカーは、NFSおよびブロックベースのiSCSIにも対応しています。万が一のサルベージ（復旧作業）はNFSやファイルベースのiSCSIの方がNASからファイルを確認できる事、NFSは特に扱いがシンプルなため、まずはNFSのファイル共有がお勧めです。なお、ESXiに別のディスクを接続しバックアップを取得する場合は以下のNFSの設定については不要です。\nNAS上でのNFSの設定まず、ESXiでサポートされるNFSのバージョンは3および4となります。v3はシンプルにクライアントのIPアドレスで認証し、v4はIPアドレスに加えユーザー単位の認証が可能です。\nここではSynologyのDisk Station Manager7.1を実例にNFSv4.1の設定を記載します。\n\nコントロールパネルの、ファイルサービスからNFSを選択し、NFSv4.1を有効にします。\n\n\n\n\n認証するバックアップ専用のユーザー（一般ユーザー）を作成します。\nバックアップを取得する共有フォルダを作成し、バックアップ専用ユーザーにアクセス権を付与します。コントロールパネルの、共有フォルダでバックアップを取得する共有フォルダを選択し、共有フォルダの権限を設定します。\n共有フォルダの設定では、さらにNFS権限のルールで、接続を許可するネットワークアドレス、Squashは「なし」を選択します。\n\n\n\nNASのセキュリティ強化のため、NFSv4.1で新規作成したユーザーに対し、NFS以外のNASアクセス権の解除およびWebサービスなどのログインは実質無効化する設定をお勧めします。\n\n\nESXiからNFSサーバーに接続するESXi側からNFSでファイルをマウントするのは簡単です。ESXiの左ペインメニューのストレージから、新しいデータストアを選択します。次にNFSデータストアのマウントを選びます。以下のダイアログが表示されますので、ESXiで使うボリューム名を決め、NFSサーバーのIPアドレス、マウント名、NFSv4.1であればユーザーIDとパスワードを入力します。NFSv3の場合は、ユーザーIDとパスワードを入力する場所はありません。\n\n\n赤枠で囲ったNASのマウントパスをESXiのNASシェアの項目に記述します。\n\n\nこれで、ESXiでは、”&#x2F;vmfs&#x2F;volumes&#x2F;NFSデータストア名”としてnfsサーバーのフォルダがマウントされます。\nESXiでの事前準備\nESXiにSSHで接続する必要があるため、ESXiの左ペインメニューのホスト→管理からサービスタブをクリックし、TSMおよびTSM-SSHを起動します。\nESXiのストレージ、nfsボリュームを選択し、データストアブラウザを開きます。アップロードボタンをクリックし、ダウンロード済みのghettoVCB-master.zipをアップロードします。\n\nghettoVCBの展開sshクライアントから、rootユーザーでESXiに接続し、ghettoVCBのzipを展開します。\nThe ESXi Shell can be disabled by an administrative user. See thevSphere Security documentation for more information.[root@esxi:~] cd /vmfs/volumes/your-nfs/[root@esxi:/vmfs/volumes/your-nfs] lsghettoVCB-master.zip[root@esxi:/vmfs/volumes/your-nfs] unzip ghettoVCB-master.zipArchive:  ghettoVCB-master.zip   creating: ghettoVCB-master/  inflating: ghettoVCB-master/README.md  inflating: ghettoVCB-master/ghettoVCB-restore.sh  inflating: ghettoVCB-master/ghettoVCB-restore_vm_restore_configuration_template  inflating: ghettoVCB-master/ghettoVCB-vm_backup_configuration_template  inflating: ghettoVCB-master/ghettoVCB.conf  inflating: ghettoVCB-master/ghettoVCB.sh  inflating: ghettoVCB-master/vghetto-ghettoVCB-offline-bundle.zip  inflating: ghettoVCB-master/vghetto-ghettoVCB.vib[root@esxi:/vmfs/volumes/your-nfs]\n\nバックアップするバックアップの設定バックアップを行う本体は、ghettoVCB.shです。新しく作成されたghettoVCB-masterフォルダに移動し、ghettoVCB.shをviで開きます。このスクリプトで変更すべき箇所は最低1箇所で、15行目のVM_BACKUP_VOLUMEでバックアップを保存するパスを指定します。\n# Author: William Lam# Created Date: 11/17/2008# http://www.virtuallyghetto.com/# https://github.com/lamw/ghettoVCB# http://communities.vmware.com/docs/DOC-8760###################################################################                   User Definable Parameters##################################################################LAST_MODIFIED_DATE=2020_10_10VERSION=4# directory that all VM backups should go (e.g. /vmfs/volumes/SAN_LUN1/mybackupdir)VM_BACKUP_VOLUME=/vmfs/volumes/your-nfs/backups\n\n上記で指定した”backups”フォルダを作成します。\n[root@esxi:/vmfs/volumes/your-nfs] mkdir backups[root@esxi:/vmfs/volumes/your-nfs]\n\nさらに、バックアップ対象となるvmのListを作成します。1行1ホストとなります。XGFirewall、Win10という仮想マシンが2つ存在しそれをバックアップするのであれば、以下のようにghettoVCB-masterフォルダでvmlist.txtなどの名前で仮想マシンの一覧を作成します。\n[root@esxi:/vmfs/volumes/your-nfs/ghettoVCB-master] vi vmlist.txtXGFirewallWin10\n\nバックアップの実行ghettoVCB-masterフォルダから以下のコマンドでバックアップが取得できます。\n[root@esxi:/vmfs/volumes/your-nfs/ghettoVCB-master] /bin/sh ./ghettoVCB.sh -f ./vmlist.txt\n\n私の環境での実行結果（一部ホスト名などは書き換えています）は以下の通りです。\n2020-10-10 13:29:17 -- info: Initiate backup for XGFirewall2020-10-10 13:29:17 -- info: Creating Snapshot &quot;ghettoVCB-snapshot-2020-10-10&quot; for XGFirewallOption --adaptertype is deprecated and hence will be ignoredDestination disk format: VMFS thin-provisionedCloning disk &#x27;/vmfs/volumes/datastore1/XGFirewall/XGFirewall/XGFirewall-0.vmdk&#x27;...Clone: 100% done.2020-10-10 13:30:59 -- info: Removing snapshot from XGFirewall ...2020-10-10 13:31:00 -- info: Slept 1 seconds to work around NFS I/O error2020-10-10 13:31:00 -- info: Backup Duration: 1.72 Minutes2020-10-10 13:31:00 -- info: Successfully completed backup for XGFirewall!\n\nバックアップ結果の確認実際にバックアップが作成されたフォルダを確認すると以下のようになっています。\n[root@esxi:/vmfs/volumes/your-nfs/backups/XGFirewall/XGFirewall-2020-10-10_13-29-16] ls -altotal 29407336drwxr-xr-x    2 root     root          4096 Oct 10 13:30 .drwxr-xr-x    5 root     root          4096 Oct 10 13:30 ..-rw-r--r--    1 root     root            30 Oct 10 13:30 STATUS.ok-rw-------    1 root     root       2621952 Oct 10 13:30 XGFirewall-0-ctk.vmdk-rw-------    1 root     root     42949672960 Oct 10 13:30 XGFirewall-0-flat.vmdk-rw-------    1 root     root           612 Oct 10 13:30 XGFirewall-0.vmdk-rwxr-xr-x    1 root     root          3712 Oct 10 13:29 XGFirewall.vmx\n\n環境によってファイル名は少し異なります。仮想マシンは、-flat.vmdkが本体です。私の場合は、別のバックアップソフトで差分バックアップを有効にしているため別にファイル名が”-ctk.vmdk”というものもあります。これはvSphereの機能であるCBT（Changed Block Tracking）を用いて更新のあったブロックのみを差分バックアップする機能で、これを使うとvmdkが2つ作成されます。このCBTはghettoVCBには必須項目ではありませんが、混乱を避けるために参考までに記載しました。\nファイルのサイズを確認すると、XGFirewall-0-flat.vmdkは40GByteとなっています。これはそもそもの仮想マシンを作成した時に設定したサイズが示されています。ghettoVCBはデフォルトのthinモードでバックアップするため、thickで構成された仮想マシンよりは実際の消費されているディスク量は小さく済みます。実際に消費されたディスクは以下の通り確認できます。\n[root@esxi:/vmfs/volumes/your-nfs/backups/XGFirewall/XGFirewall-2020-10-10_13-29-16] du -h28.0G\t.\n\nつまり、シンプロビジョニング（通称シンプロ）はこうやってディスク領域を節約する仕組みになっているわけです。\nデフォルトでは3世代バックアップを取得するようになっていますが、その他カスタマイズする箇所については、英語版の公式マニュアルを参照してください。\n\nvmware -ghettoVCB.sh - Free alternative for backing up VM’s for ESX(i) 3.5, 4.x, 5.x, 6.x &amp; 7.x- https://communities.vmware.com/docs/DOC-8760\n\nESXiのちょっと特殊な点このシェルを実行する時に、頭に/bin/shを加えました。単体でghettoVCB.shを実行すると-sh: ./ghettoVCB.sh: Operation not permittedと実行できません。ghettoVCB.shには、実行権も最初から付与されています。スクリプトの先頭にShebang（#!&#x2F;bin&#x2F;sh）が無いのでそれが原因かと思い加えても動作しません。これは、ESXiがUEFIのセキュアブートだとこのような挙動になるようです。スクリプトでバックアップができるようになると、Cronに登録して定期的に実行したくなりますが、改ざん防止のためそれも不可能なようです。ESXiのセキュアブートをしないように変更すれば可能ですが、XGを載せたFirewallの役割から考えると非常に悩ましいところです。冒頭に前述した無償ソフトウェアについての記事「無償版ESXiの高度なバックアップ」を参照してください。\nレストアするさて、バックアップから戻す場合です。ESXiのハードウェア毎故障してしまってもバックアップがあれば安全です。戻し方には2つあります。\n\nバックアップを取得した仮想マシンと同じ場所に戻す\nバックアップを取得した仮想マシンの情報で、新しい仮想マシンを作成する\n\n1の方法は元の仮想マシンを一旦ESXiメニューから削除してから同じフォルダを再作成して復旧するので比較的単純です。2の方法は重複して作成する事になるため、そのままだとネットワーク周りの環境が重複し、MACアドレスなど別の構成にしてレストアする事になります。より慎重な人は別の仮想マシンとして起動する事を確認してから元の仮想環境を削除する方法を選びたいのではないでしょうか。今回は少し手間が掛かりますが、上記でバックアップされたXGFirewallを新しい仮想マシンとして復元する方法について記載します。\nレストアの設定通常仮想マシンが稼働しているvmfsフォーマットのフォルダを確認します。通常は/vmfs/volumes/datastore1ですが、ここでは、｀&#x2F;vmfs&#x2F;volumes&#x2F;your-datastore&#x2F;&#96;とします。\nバックアップしたXGFirewallを新しい仮想マシンをレストアする場所として、datastore配下に”XGFW18”フォルダを作成します。\n[root@esxi:/vmfs/volumes/your-datastore] mkdir XGFW18[root@esxi:/vmfs/volumes/your-datastore]\n\n次に、ghettoVCBフォルダに移動し、レストア設定ファイルを新規作成します。以下の通り、バックアップしたファイル、戻し先と仮想マシンのディスクフォーマット（ここではデフォルトのzeroedthick”1”を指定）、仮想マシンの名称を記述します。\n[root@esxi:/vmfs/volumes/your-nfs/ghettoVCB-master] vi vm_restore_list.txt# DISK_FORMATS# 1 = zeroedthick# 2 = 2gbsparse# 3 = thin# 4 = eagerzeroedthick# e.g.&quot;/vmfs/volumes/your-nfs/backups/XGFirewll/XGFirewall-2020-10-10_13-29-16;/vmfs/volumes/your-datastore/XGFW18;1;XGFW18&quot;\n\nレストアの実行ghettoVCB-masterフォルダから以下のコマンドでレストアを実行します。\n[root@esxi:/vmfs/volumes/your-nfs/ghettoVCB-master] /bin/sh ./ghettoVCB-restore.sh -c ./vm_restore_list.txt\n\nレストア結果の確認################## Restoring VM: XGFW18  #####################Start time: Sun Oct 11 04:14:58 UTC 2020Restoring VM from: &quot;/vmfs/volumes/your-nfs/backups/XGFirewall/XGFirewall-2020-10-10_13-29-16&quot;Restoring VM to Datastore: &quot;/vmfs/volumes/your-datastore/XGFW18&quot; using Disk Format: &quot;zeroedthick&quot;Creating VM directory: &quot;/vmfs/volumes/your-datastore/XGFW18/XGFW18&quot; ...Copying &quot;XGFW.vmx&quot; file ...Restoring VM&#x27;s VMDK(s) ...Updating VMDK entry in &quot;XGFW18.vmx&quot; file ...Option --adaptertype is deprecated and hence will be ignoredDestination disk format: VMFS zeroedthickCloning disk &#x27;/vmfs/volumes/your-nfs/backups/XGFirewall/XGFW-2020-10-10_13-29-16/XGFirewall-0.vmdk&#x27;...Clone: 100% done.Registering XGFW18 ...10End time: Sun Oct 11 04:26:17 UTC 2020################## Completed restore for XGFW18! #####################Start time: Sun Oct 11 04:14:58 UTC 2020End   time: Sun Oct 11 04:26:17 UTC 2020Duration  : 11.32 Minutes\n\nこれでESXiのメニューを確認すると既に左ペインの仮想マシンに新しくレストアした”XGFW18”がインベントリ登録まで完了し停止状態となっています。すぐに起動といきたいところですが、今稼働中の仮想マシンとIPアドレスなど全てが重複しますので、事前に修正する必要があります。\nレストアした仮想マシンを起動します。初回起動時には以下のダイアログが表示されますので、コピーしましたを選択し回答します。バックアップした仮想マシンを既に削除している場合は、移動しましたを選択します。\n\n\nこれでバックアップされた仮想マシンが復元されました。ただし前述した通り、MACアドレスが初期化されていますので、ホームゲートウェイから割り当てられたIPアドレスが変わっています。また、LANで利用しているL2スイッチでMACアドレスフィルタなどACLを使っている場合も通信できなくなりますので、ご注意ください。\nレストアに関する詳細は、公式マニュアルを参照してください。\n\nvmware -Ghetto Tech Preview - ghettoVCB-restore.sh - Restoring VM’s backed up from ghettoVCB to ESX(i) 3.5, 4.x &amp; 5.x- https://communities.vmware.com/docs/DOC-10595\n\n","categories":["Software"],"tags":["ESXi","XG Firewall"]},{"title":"VMware vSphere Hypervisor（ESXi）の設定","url":"/new-technology/2020/03/01/esxi-conf/","content":"この記事で実現すること\nXG Firewall v18をESXi 6.7上で稼働させるために、ホームゲートウェイの後ろに、XGを挟み込んだネットワーク構成を説明します。また、ESXi上で2枚のNICを利用し仮想スイッチの設定を行い、2枚のNICを持った仮想マシンを作成します。\n\n\n\nネットワークの確認ESXiのWeb管理画面にログイン後、左ペインの”ネットワーク”をクリックし、”物理NIC”のタブをクリックすると、ESXiに認識されているNICの一覧がリストされます。\n\n\n1GbpsのNICであれば、ドライバーはne1000として認識されています。（環境にもより異なりますが）vmnic0、vmnic1という物理NICが2つ表示されている事を確認してください。\n  　物理NICが1つしかない場合は、XG Firewallのセットアップはできません。\n\n\n仮想環境上のFirewall向け構成ESXiにおけるネットワークの構成は、物理NICと仮想スイッチとの関係が重要です。以下の図のように、ESXiにおける物理NICはケーブルとして見立て、実際に仮想マシンが複数台存在する事を鑑み、ESXiの中にスイッチングハブが存在していると考えてください。\n\n\n※便宜上、一般的なホームユーザーの構成図としてLinuxの仮想マシンやWi-Fiアクセスポイント等を記載していますが、これまでのセットアップでは存在していません。また、XG Firewallのインストールに、LinuxやWi-Fiアクセスポイントは必要ありません。\nセットアップ状況の確認ここまでのセットアップで、以下の構成になっています。\n\n物理NICであるvmnic0、vmnic1\nバーチャルスイッチのvSwitch0\nネットワークポート（仮想IP）として、LAN側の管理用のManagement Networkおよびデフォルトで仮想マシンのために作成されているVM Network\n\nWANの仮想スイッチの作成\n\nXGのWAN側インタフェースを担う仮想スイッチを追加します（赤字の部分）。\n\nESXiの管理画面の左ペイン、ネットワークをクリック、続いて仮想スイッチのタブをクリックします。\n標準仮想スイッチの追加をクリックします。\nWAN側の仮想スイッチを作成するため、ここでは、vSwitch1と命名します。MTUは1500のままで構いません。\n“アップリンク1”は物理NICとの関連付けです。vmnic1などWAN側に使う予定の物理NICを選択してください。\n\n以下の通り、仮想スイッチの作成は完了です。\n\n\nネットワークポートの作成\nvSwitch1をクリックし、物理NICのWAN向けである、vmnic1と関連付けられている事を確認してください。\nXGのLANとWANのネットワークポートを作成します。左ペインのネットワークからポートグループのタブをクリックし、ポートグループの追加を選択します。\n新規ポートグループとして、LANはここではXG-LANと命名し作成します。LANなので、vSwitch0を関連づけます。\n続いてWANのために、XG-WANと命名し、vSwitch1と関連づけます。\n\nこれらの設定が終わり、LAN側のネットワーク構成は以下の通りとなります。\n\n\nWAN側のネットワーク構成は以下の通りです。\n\n\nこれで、ESXiのネットワーク設定は完了となります。一旦PCのネットワークをホームゲートウェイに接続し、XG Firewallのモジュールをダウンロードしてください。\n","categories":["Software"],"tags":["ESXi","XG Firewall"]},{"title":"無償版ESXiの高度なバックアップ","url":"/new-technology/2021/03/06/esxi-nakivo/","content":"\n\nこの記事で実現すること\n\n無償版ESXi6.7（VMware vSphere Hypervisor6.7）はvStorage APIが使えないため、有名なESXiのバックアップ製品は大半が利用できません。vStorage APIを使わないGUI製品であるNakivo Backup Free Editionを用いてXG Firewallなどの仮想マシンがバックアップできます。GUIによる設定、定期的なバックアップ、差分バックアップをサポートします。\n\n\n無償版ESXiのバックアップ環境「VMware ESXiの仮想マシンをバックアップする」の記事では、無償版ESXiのバックアップについて説明していますが、コマンドラインベースであることやUEFIシステムによってCronで定期的なバックアップが行えない制約がありました。一方、GUIによるバックアップ製品は多くの製品があります。「ずっと無償」などの言葉が並んでいますが、無償というのはバックアップ製品が無償という事であり、無償ESXiのバックアップは取れず、色々捜しつつもGUI製品には殆どめぐり合えないというのが実態です。\nNakivo Backupの無償の意味Nakivo backup Free Editionは無償のオープンシステムではなく、あくまでビジネス向けに収益をあげるモデルです。無償ライセンスは1年単位となっています。10以下の仮想マシンのバックアップなど制約はありますが、個人向けには十分な内容です。しかし、あくまで無償版はお試しという位置付けであり実際は個人向けでも正式なライセンスを購入してほしいようです。製品をダウンロードすると、米国の営業担当から電話がかかってきました&#x1f626;。私はメールでやりとりし、とりあえず1年間はこの無償版を使いますよという事になりましたが[1]、次回は有償版のライセンスにて更新するかどうするかは少し値段の面で悩んでいるところです。ライセンス費用も公開されていますが、マザーボードに物理接続されたCPUあたり＄99&#x2F;年という事です。ビジネス用途であれば極めて安価ですが、個人向けとしては悩みどころの価格帯です。また、ghettoVCBで事足りているというのもあります。\n他の無償製品に目を向けてみると、Unitrends Freeで無償版ESXiの仮想マシンがバックアップ可能ですが、これはエージェントモデルで、仮想マシンそのものにエージェントをインストールし、エージェントが自分自身のOSのバックアップを取得する事になります。これはLinuxやWindowsの仮想マシンには使えますが、XG Firewallなど他のモジュールインストールを認めていない仮想マシンはバックアップする事はできません。\n\nNakivo backup Free Edition https://www.nakivo.com/resources/download/free-edition/Unitrends Free https://www.unitrends.com/landing/free-backup-vmware-hyper-v-software\n\nNakivo Backupの必要環境ESXiの仮想マシンをバックアップするにあたり、スケジューリングによるバックアップがまずは期待されるところです。常時起動したままのOS、またはNASなどが適任です。対象OSは以下の通りです。なお、私のブログのテーマと関連するためESXiを前提として記事を書いていますが、Hyper-Vのバックアップも可能です。\n\nWindows\nLinux\nEsxiの仮想マシンとして\nNAS(Synologyなど)\n\nダウンロードおよびインストール上記のNakivoサイトからダウンロードしてください。\n\nダウンロードにはビジネスで利用しているメールアドレスが必要になります。昔はgmailやicloudメールが使えましたが、現在は認められないようで会社勤めの方であれば会社のメールアカウントを入力必要です。私は会社のメアドを登録するのは躊躇して登録していませんが、エンジニアの方であれば、一般的には自己啓発という名目もあり構わないと考えられるでしょうか。インストール自体は難しいものではありません。以下のURLから各環境に応じた手順でセットアップを行います。\n\nNakivo User Guide https://helpcenter.nakivo.com/display/NH/Installing+NAKIVO+Backup+and+Replication\n\nポイントは以下の2点です。\n\nユーザー名、メールアドレスの登録を行います。ここのメアドはバックアップ結果などの通知のために使うものでダウンロード時に用いたビジネスアカウントメールとは異なります。\n\n\n\n\nTransportarという複数のチャネルでバックアップを吸い上げる機能がありますが、この選択がある場合は、”Transportar only”で構いません\n\n\n\nセットアップ完了後、Nakivo BackupをインストールしたマシンのTCP4443ポートにブラウザから接続します。\nNakivo BackupからESXiのインベントリ確認Nakivo BackupからFree版のESXiに接続するにはESXiのHTTPS(Port443)、SSH(Port22)に接続できる必要があります。ESXiのSSHの有効化については「VMware ESXiの仮想マシンをバックアップする」の記事を参照してください。また、SSHの認証はパスワード認証となり、公開鍵認証は使えません。\nhttps:nakivo-host:4443に接続しログインします\n\n\nログイン後の全体像は以下のようになっています。\n\n\n初期セットアップとして、左ペインメニューのSettingsからESXiに接続し仮想マシンの一覧を取得します\n\n\nテストドライブとしてはrootで接続確認を行うでしょうけれども、恒久的にこのプロダクトを利用される場合は、「ESXi(無償版)のセキュリティを高める」の記事で示したように、SSHを開けたままにする事になるので、ESXiへのSSH接続可能なIPアドレスを制限する事、nakivo用の専用ユーザーアカウントをESXiに作成する事をお勧めします。接続が無事行えるとInventoryに仮想マシンの一覧が表示されます。\nBackup実行とスケジューリングダッシュボードからジョブの設定を行います。左ペインのDashboardからVMWare backup jobーCreateーVMWare vSphere backup jobをクリックします。\n\n\n設定の流れとしては以下の通りです。\n\n\n\n項目\n設定内容\n\n\n\n1.Source\n接続先のESXiから仮想マシンを選択します\n\n\n2.Destination\nバックアップするリポジトリとしての場所を指定します（任意）\n\n\n3.Schedule\n定期的なバックアップの指定をします\n\n\n4.Retention\nバックアップの世代管理をします\n\n\n5.Options\nジョブ通知のメールやバックアップ形式を指定します\n\n\n設定のポイントは以下の通りです。特に設定が難しいものはないでしょう。\n“Schedule” この例では月曜日の朝6時にバックアップを開始します\n\n\n“Retention” この例では過去5世代のバックアップを確保し、月次バックアップを過去2か月確保します\n\n\n“Options” この例では差分バックアップの指定とジョブの通知メールを指定しています\n\n\n差分バックアップについてはESXiの機能であるCBT(Changed Block Tracking)の機能を使えます。バックアップのストレージと時間の圧縮効果があるので設定をお勧めします。これは次の章で説明します。\nNakivo Backupのユーザーマニュアルの詳細は以下を参照してください。\n\nNAKIVO Backup &amp; Replication USER GUIDE https://helpcenter.nakivo.com/display/NH/User+Guide\n\nESXiのChanged Block TrackingESXiの機能であるChanged Block Trackingは仮想マシンが稼働していて前回バックアップしたものから未更新のディスクブロックをスキップして差分のみバックアップする機能です。途中で別のバックアップ製品によるバックアップ、例えばghettoVCBなどでバックアップされると、次回のNakivo BackupによるCBTはフルバックアップを行います。\n最初に仮想マシンがインストールされているディスクを調べ、そのSCSI-IDを確認します。ESXi管理画面の仮想マシンを選択し右クリックして設定の編集をクリックします。\n\n\n\nハードディスクの詳細を開き、コントローラの場所でSCSI-IDを確認します（SCSI(0:0)など）。\n\n\n仮想マシンを停止します。\nESXi管理画面の仮想マシンを右クリックして、設定の編集をクリックします。\n仮想マシンオプションタブをクリックします。\n詳細セクションを開き 設定パラメータの設定の編集をクリックします。設定パラメータダイアログが開きます。\nパラメータの追加をクリックします。\nctkEnabledパラメータを追加して、その値をtrueに設定します。\nパラメータの追加をクリックし、scsi0:0.ctkEnabledを追加して、その値をtrueに設定します（環境に合わせてscsi0:0の内容は変更してください）。\nOKボタンをクリックし設定を完了させます。\n仮想マシンを起動します。\nSSHでESXiに入り、仮想マシンが配置されているディレクトリで、&quot;vm-name&quot;-ctk.vmdkファイルがあることを確認します。\n\nCBTを無効にする場合はこの逆の手順、ctkEnabledの値をfalseに設定します。手順の詳細についてはVMWareのガイドを参照してください。\n\nVMware 仮想マシン上の変更ブロックのトラッキング（CBT） (1020128) https://kb.vmware.com/s/article/1031873?lang=ja&amp;queryTerm=changed+block+tracking\n\n定期的なバックアップをお勧めしますこの製品もghettoVCBと同様にスナップショットをとってからバックアップに入りますので、制約はほとんど感じる事がありません。せいぜい数ヶ月に1度のESXiパッチ適用の前に手動でバックアップを取る事くらいでしょうか。不慮の事故に備えて定期的なバックアップを取得される事をお勧めします。最近はOSもIoTもパッチの自動更新機能が充実してきました。多少意識する事としてはパッチ適用による自動リブートなどと、このバックアップとの時間帯が重ならないように留意する事くらいでしょうか。それでもジョブ通知があるのでバックアップ失敗が放置される懸念もありません。\n[1]営業担当曰く、「気に入ったら買って欲しい」との事でした。こちらはそこまでパワーユーザーじゃないからというやりとりのあと、こちらから「目的から外れるのならソフトウェアを削除するけど、そうした方が良い？」という質問には明確な回答がありませんでした。もちろん、ソフトウェアで収益を上げている事はビジネスとして当然の行為で、良いソフトウェアには適切な値段があるべきですが、できればそのあたりをWebサイトに明記されると良いのになと感じたところです。しかしホームユーザーとして悩む絶妙な価格設定&#x1f605;\n","categories":["Software"],"tags":["ESXi","XG Firewall"]},{"title":"ESXi(無償版)のセキュリティを高める","url":"/new-technology/2021/01/23/esxi-security/","content":"\n\nこの記事で実現すること\n\nVMwareから、”vSphereのセキュリティ”のドキュメンテーションがあります。350ページと膨大な量になります。この情報のうち大半はビジネスで利用するvCenter Serverを中心としたセキュリティ維持のための記載になりますが、個人向けESXiにポイントを絞り、どのようにセキュリティを高めるか確認していきます。\n\nvSphereのセキュリティ ESXi7.0 https://docs.vmware.com/jp/VMware-vSphere/7.0/vsphere-esxi-vcenter-server-70-security-guide.pdf\n\n\nvSphereのセキュリティ ESXi8.0 Update1https://docs.vmware.com/jp/VMware-vSphere/8.0/vsphere-esxi-vcenter-801-security-guide.pdf\n\n\n\nホームユーザーとしての無償版ESXiのセキュリティまずは情報セキュリティのポイントである機密性、完全性、可用性について確認していきます。可用性についてはバックアップとして「VMware ESXiの仮想マシンをバックアップする」の記事を紹介しています。完全性として不具合に対応するパッチの適用については「VMware ESXiにパッチを適用する」で記載しています。残るは機密性です。物理的セキュリティ（つまり盗難対策など）はここでは割愛し、ESXiにおける機密性の設定内容について記載します。\n前述したドキュメントを眺めると正直ビジネス向けプロダクトと個人向けとの説明が混在していて理解が難しいです。個人向けESXiでは以下は使えません。\n\nvCenter Server\nvShpere Client(Windowsで稼働させるクライアント。6.5から使えません）\nHost Client\nvShpere Client(HTML5)\n\nクライアント周りが非常にややこしい事になっていますが、無償版ESXiではvSphere Web ClientおよびESXi Shell（SSH）のみ利用可能です。実はこれだけに機能を絞るとあまり与えられた選択肢はありません。\n無償版ESXiで設定可能な項目上記ドキュメント全体を通して、設定可能な機密性に関する項目は以下の通りです。\n\nESXiに接続可能なIPを絞る\nSSHの起動、停止の実行\nSSHでログインし各種アクセスログの確認をする\nsyslogで外部syslogサーバーにログを転送する\nSSHで公開鍵認証を行う（必要であれば）\n\nここではv6.7のドキュメントを引用しながら設定方法について説明していきます。\n全般的な説明個々の設定に入る前に全体的な考え方について説明します。P41からの「ESXiのセキュリティに関する一般的推奨事項」を引用します。\n\nESXi ShellおよびSSHはデフォルトで無効になっています。デフォルトでは、限られた数のファイアウォール ポートのみが開いています。特定のサービスに関連付けられている追加のファイアウォール ポートを明示的に開くことができます。\nESXiは、その機能の管理に不可欠なサービスのみを実行します。ESXiの実行に必要な機能しか配布できません。\nデフォルトでは、ホストを管理するために必要でないポートは、すべて閉じられています。追加のサービスが必要な場合は、ポートを開きます。\nデフォルトでは、強度の低い暗号は無効になっており、クライアントからの通信はSSLで保護されます。チャネルの保護に使用するアルゴリズムは、SSLハンドシェイクによって異なります。ESXiで作成されたデフォルトの証明書は、署名アルゴリズムとして、RSA暗号化のPKCS#1 SHA-256を使用します。\nWebクライアントによるアクセスをサポートするため、内部ではESXiによってTomcat Webサービスが使用されています。このサービスは、管理と監視のためにWebクライアントで必要な機能のみを実行するように修正されています。そのため、ESXiは、さまざまな使用環境で報告されているTomcatのセキュリティ問題による脆弱性に対応できます。\nVMwareは、ESXiのセキュリティに影響する恐れのあるすべてのセキュリティ警告を監視し、必要に応じてセキュリティパッチを発行します。FTPやTelnetなどのセキュリティ保護されていないサービスはインストールされません。これらのサービス用のポートはデフォルトで閉じられています。SSHやSFTPなど、よりセキュアなサービスを容易に使用できるため、これらの安全性の高いサービスを選択し、セキュリティ保護されていないサービスの使用は避けるようにしてください。たとえば、SSHを使用できずTelnetを使用する必要がある場合、SSLを使用したTelnetを使用して仮想シリアル ポートにアクセスします。\nセキュリティ保護されていないサービスを使用する必要があり、ホストに十分な保護を実装している場合は、明示的にポートを開くことで対応できます。\nESXiシステムでUEFIセキュア ブートを使用することを検討します。「ESXiホストのUEFIセキュア ブート」を参照してください。\n\nESXiに接続可能なIPを絞るこの機能はESXiではFirewallと呼ばれ、Linuxのiptablesやufwと同様にシンプルなものです。ホームユーザーはシンプルなLANで閉じられたアクセスですが、安全のために設定を検討すべきです。P72に「ESXiファイアウォール設定の管理」があります。”「構成」をクリックし”と解説がありますが、いきなり見つけられません。実際にはWeb管理画面の左ペインメニューの ネットワークを選択し、ファイアウォールタブをクリックして見つける事ができます。デフォルトではESXiの管理インタフェースにアクセス可能であれば一切の制約なく接続可能になっていますので、ここではSSHとWeb Clientに接続可能なIPを絞る事にしましょう。ご自身が使われているプライベートネットワークアドレスや端末のIPアドレスでも構いませんが設定も簡単ですしお勧めします。\n\n\nSSHで接続してバックアップを取得する場合の「SSHサーバ」、Web管理画面の「vSphere Web Client」について接続IPアドレスまたはネットワークアドレスを指定します。\nSSHの起動、停止これは、管理メニューの左ペインホストー管理からTSMおよびTSM-SSHの起動・停止を行います。SSHは起動したままの状況は推奨されておらず、このドキュメントでも必要な時のみ起動するように記載されています。心配な方はSSHは起動したままにしないのが無難です。利便性のためにSSHは普段から起動したまま運用するならば接続IPを絞るなど何らかの工夫は加えたいところです。ここは個人の考え方で大きく運用は異なりますから、ベストプラクティスを定めるのは難しいのが実態です。\nSSHのログP113に「ESXiログ ファイルの場所」という章があります。ここでログインした際のログが確認できます。場所は/var/log/auth.logです。わざわざSSHでログインしなくとも、Web管理画面のホストー監視からログを閲覧できます。\nsyslogでログを転送するsyslogサーバをお持ちの方はログを転送して確認できます。NASなどは簡易なsyslogサービスを持っている場合があるので活用を検討してみてください。P112には以下の通り記載があります。\n\nvSphere Client または esxcli system syslog vCLI コマンドを使用して syslog サービスを構成できます\n\nこれも難しい記載になってますが、Web管理画面から設定できます。以下のように管理メニューの左ペインホストー管理からシステム、詳細設定と進み、右上のフィルタリストに”Syslog.global.logHost”と入力すると設定対象の項目が表示されます。\n\n\n“Syslog.global.logHost”の行でマウスを右クリックし、オプションの編集を選択します。ここではプロトコル、対象ホスト、ポート番号を指定します。受ける側のsyslogサーバに合わせUDPまたはTCPを選択し、udp://192.168.x.xxx:514のように指定します、また、syslogサーバでSSL対応がなされていない場合は、”Syslog.global.logCheckSSLCerts”の値をTrueからFalseに変更します。\nsyslogではひたすらログが流れてきます。SSHにおけるログイン失敗については、ファシリティ＝auth、重要度&#x3D;Errorの扱いです。また、Web Clientについては、重大度はInfoで”Invalid Login”というログが書かれるようですので、これらだけをフィルタしても良いでしょう。\nSSHで公開鍵認証を行う（必要であれば）P48から公開鍵認証について記載があります。これも記載が専用コマンドでわかりづらい記載になっており、実際には無償版ESXIの説明にはなっていません。ESXiはOpenSSHを使っていますので、そちらの設定で動作します。また、公開鍵のみでログインする場合/etc/ssh/sshd_configを修正したくなりますが、これは修正しないようにと説明されています。また同じP48で紹介している公開鍵認証に関するVMwareの説明ページがあります。OpenSSHの秘密鍵と公開鍵の作成についてはネットの様々な場所で説明されているのでここでは割愛しますが、以下の場所に公開鍵を配置するように説明があります。\n\nFor ESXi 5.x, 6.0, 6.5 and 6.7, the authorized_keys is located at: &#x2F;etc&#x2F;ssh&#x2F;keys-＜username＞&#x2F;authorized_keys\n\nつまり、rootユーザーですと、/etc/ssh配下にkeys-rootフォルダを作り、authorized_keysに公開鍵を記述せよという事です。\nESXi7、ESXi8では、”keys-root”フォルダおよびauthorized_keysファイルは最初から存在します（ESXi6.7では作成する必要がありました）。\n\n\n\nvmware -Allowing SSH access to ESXi&#x2F;ESX hosts with public&#x2F;private key authentication (1002866)- https://kb.vmware.com/s/article/1002866\n\nちなみに、ESXi側でもssh-keygenを実行すると、/etc/sshの配下に、公開鍵ssh_host_rsa_key.pubと秘密鍵ssh_host_rsa_keyが作成されます。それと同時に/etc/ssh/sshd_configにも公開鍵認証である、HostKey /etc/ssh/ssh_host_rsa_keyが挿入されるようです。これがあるとrootユーザーは公開鍵認証が必須という事になりますから、秘密鍵をダウンロードせずにそのままsshを閉じるとパスワードで接続できなくなるため注意が必要です。\nまた、このVMwareのKBによれば、以下の通りsshd_configを修正せよとあります。\n\nTo disable password login, ensure that the ChallengeResponseAuthentication and PasswordAuthentication are set to no.\n\nいったいどちらを信用すべきなんだろうと悩んでしまいますが、やるなと言われている事は敢えてやらずにsshd_configの書き換えはしない方向で進めます。一般的な方法でクライアントで秘密鍵、公開鍵のペアを作成し、ESXiの/etc/ssh配下にkeys-rootフォルダを作り、authorized_keysに公開鍵をコピーします。\n\nPCからESXi(192.168.x.x)の&#x2F;tmpに公開鍵をコピーします。ここではsshする前提なのでscpを使います。もちろん他の方法でも構いません。scp id_rsa.pub root@192.168.x.x:/tmp\nESXiにて&#x2F;tmpからAuthorized_keysに鍵をコピー（追記）します。 cat /tmp/id_rsa.pub &gt;&gt; /etc/ssh/keys-root/authorized_keys \n\nこれらの作業はリスクが高いものですので、他の端末から既に接続した状態にする、或いは他のユーザー（管理者権限）をESXiに作成し接続できている状態で作業される事をお勧めします。\n結局のところ、sshd_configを修正できないのであればパスワード認証を禁止するなどの対応はできません。しかし、普段からrootのパスワードは利用せず、公開鍵認証を利用することでパスワードの漏洩は防ぐことができます。\nESXiに別の管理者ユーザーを作成する”vSphereのセキュリティ”についてはこれまで説明したものが全てですが、root以外のユーザーを作成し、rootはできるだけ使わない事をお勧めします。これは一般論でありrootがよく知られたユーザー名だからです。「VMware ESXiの仮想マシンをバックアップする」で説明したバックアップスクリプトのghettoVCBはrootユーザーを必須としているので、運用上、どうしてもrootユーザーでのログインは必要になってきます。しかし仮想マシンなどの操作がメインとなるWebクライアントについては別の管理者アカウントで操作すべきで、可能な限りrootユーザーの情報が漏洩しないようにrootを使う機会を減らすべきです。以下の手順で管理者アカウントを作成します。\n\n管理メニューの左ペインホストー管理からセキュリティとユーザーに進み、ユーザーからユーザーの追加をクリックします。\n\n\n\nユーザー名とパスワードを登録してユーザーの作成を終えます。\n管理メニューの左ペインホストからアクションを選択し、プルダウンの権限をクリックします。\nさらにユーザーの追加を選択します。実際には上記で作成したユーザーと同一名のユーザー名を入力します。ロールについては”システム管理者”を選択します。\n\n\n\nこれで新しいユーザーが作成できたので、Web管理画面からログイン可能か確認してください。rootユーザーは長めのパスワードを再設定し、パスワード管理ソフトに登録し普段は使わないようにします。普段から使わずにパスワードを封印しておけばより安全になります。\nパスワード認証と公開鍵認証についてここからはESXiの話からは少し脱線します。一般的にパスワードより公開鍵認証の方が安全という記事をよく見かけます。それはその通りですが補足します。\nパスワードは確かにインターネット上にデータとして流れますから漏洩リスクはあります。「SSLインスペクションについて」でSSLのシーケンスを記載しましたが、経路の途中で悪意あるネットワーク機器によって改竄されてユーザーがそれに気づかず情報が漏洩する可能性はあります。それに比べれば、公開鍵認証は秘密鍵で署名した情報をサーバー側に配置してある公開鍵で検証するので鍵の情報が都度流れるわけではありません。オフィスでシステムを使う場合も、公開鍵認証＋パスフレーズで運用していれば、仮にパスフレーズだけが見られたとしても鍵が漏洩しなければパスワードよりは安全です。\nさらにパスワードはクリップボードからの読み取りやブラウザからの画面上の情報読み取りの機能があります。ブラウザの拡張機能は殆どがページの内容を読み取る事ができます。SSLでは全く保護できません。ブラウザの上で起きている話ですから。興味のある方はブラウザの拡張機能の権限で調べてみてください。拡張機能を使わないでという事ではなくて、信頼できる拡張機能を選んでください。\nしかし、こういった漏洩はあくまでオープンなネットワークに対して発生するものです。自宅でクローズなネットワークを利用してESXiを運用している場合は、パスワード認証と公開鍵認証とであまり違いはありません。\n一方、公開鍵認証は確かにパスワードの流出はありませんが、鍵は~&#x2F;.ssh&#x2F;id_rsaというファイルで保存されている方も多いでしょう。これは昔からの伝統ですが、現在では少し無防備ではないでしょうか。ウィルスに感染したり、ファイル共有から流出する可能性を考えるとパスワード、公開鍵認証どちらが安全という断定はできません。秘密鍵のパスフレーズを難解なものにするという方法もありますが、秘密鍵をダウンロードしじっくり解読すれば解読は十分に可能なものであり、パスワードと同様の複雑さの議論になってしまいます。結局いずれの方法を選択するにしても、対策は必要です。LAN内のログインで悩むくらいならパスワード管理ソフトからパスワードをコピー、貼り付けしてから速やかにクリップボードの内容を消す方がよほど安全ではないでしょうか。\nクライアントPCの秘密鍵を盗まれた上に自宅のローカル環境のESXiにログインされるというのは非常に稀な事です。しかし公開鍵認証を使うと決めたのであれば、秘密鍵はパスワード以上に取り扱いを厳重にしたいものです。\n公開鍵認証に関しては、一番先行しているのがビットコインなどの暗号資産であり、コールドウォレット（秘密鍵）の管理方法から学ぶ事は多いです。PCの管理とは全く次元の違う緊張感のあるなかで秘密鍵の保管はオフラインが大前提です。ハードウェアウォレットが推奨されており、これは一般的なITの世界ではyubicoのYubikeyによる物理セキュリティキーが相当します。取り扱う情報資産や金融資産の重要度に応じて、セキュリティに対する取り組み方が変わってきます。\n\nyubico https://www.yubico.com\n\nVMware Security AdvisoryVMwareに関する脆弱性情報は以下にあります。このページから Sign up for Security Advisoriesをクリックし、メールアドレスを登録することでVMware製品の脆弱性情報を入手できます。\n\nVMware Security Advisories https://www.vmware.com/security/advisories.html\n\n","categories":["Security"],"tags":["ESXi"]},{"title":"VMware ESXiを6.7から7.0にアップグレードする","url":"/new-technology/2021/12/25/esxi-upgrade/","content":"\nこの記事で実現すること\n\n無償版ESXi（VMware vSphere Hypervisor）について、ESXi6.7からESXi7.0にアップグレードします。ここではUEFI（セキュアブート）で構成されているESXiを対象とし、できるだけ安全にアップグレードを行います。\n\n\nご注意事項2024&#x2F;1&#x2F;22に発表されたVMWareブログによりますと、スタンドアロン製品の提供を終了し、サブスクリプションモデルに変更されることとなりました。この無償版ESXiは今後提供停止となりますが、サポートは継続されるとの事です。無償版ESXiの利用にあたっては、まずこちらの記事「VMWare 無償版ESXiの提供終了について」を参照されることをお勧めします。\nESXiの脆弱性を狙ったランサムウェアについてJPCERT&#x2F;CCより、2023-02-07にESXiのランサムウェア攻撃についての情報が提供されています。\n\nVMware ESXiを標的としたランサムウェア攻撃について https://www.jpcert.or.jp/newsflash/2023020601.html\n\n既知のOpenSLPのヒープオーバーフローの脆弱性（CVE-2021-21974）を悪用した攻撃とみられ、攻撃を受けるとファイルが暗号化され身代金の支払いを求めるメッセージが残されます。\nVMware ESXi 7.0系 Update 1cより前のバージョン（ESXi70U1c-17325551パッチ未適用）VMware ESXi 6.7系 ESXi670-202102001より前のバージョン（ESXi670-202102401-SGパッチ未適用）VMware ESXi 6.5系 ESXi650-202102001より前のバージョン（ESXi650-202102101-SGパッチ未適用）VMware Cloud Foundation 4系 4.2より前のバージョンに含まれるESXiVMware Cloud Foundation 3系 KB82705未適用のバージョンに含まれるESXi\nESXi7.0未満は既にEOSLを迎えていますので、早急にアップグレードをお勧めします。\nESXiのアップグレードまず正式なアップグレードに関するドキュメントがVMwareより提供されており、こちらでポイントを確認します。アップデートとアップグレードとは異なります。ESXiのバージョン体系は、”x”.”y” update “z” ビルド番号 という並びで表現されます。\n\nアップグレードは、前2桁（x,y）を上げることを指します。\nアップデートは、前2桁が変わりません。それ以降の数字があるケース、またはUpdate”z”などの形式があります。Update2を省略してU2、さらにU2a、U2cなど英数字が上がっていきます。\n\nアップデートによってこれまで動いていたハードウェアが動かなくなるという事は大々的にはおきません（ドライバーの更新によって認識しなくなったりうまく動作しないという一般的な理由はあります）。アップグレードではハードウェアのサポート対象の見直しが入ります。\n\nESXiのアップグレード https://docs.vmware.com/jp/VMware-vSphere/7.0/vsphere-esxi-70-upgrade-guide.pdf\n\n例によってVMwareのマニュアルは法人向けにvCenter Serverを中心に記載されているのでポイントを無償版ESXiに絞ります。\n\nVMWare互換性ガイドでアップグレードが可能か確認する（P8）\nバージョン6.5または6.7から7.0にバージョンアップ可能（P9）\nESXi7.0にアップグレードするとダウングレードできない（P15）\nesxcliコマンドまたはISOブートからのアップグレードの2種類がある（P38,P64）\nアップグレードには新たにESXi7.0向けの（無償版ESXiの）ライセンスを登録する（P80）\n仮想マシンとVMware Toolsのアップグレード（P12）\n\n注意点は以下の通りです。\n\nesxcliコマンドを使用してアップグレードすると、古いバージョンのESXiは新しいVIBのインストールを実行するため、署名が保存されずセキュアブートは実行できません。ISOを使用してアップグレードすると、新しいVIBは署名を保存できます。（P80）\n\n上記の注意点の通り、UEFIのセキュアブートで稼働しているESXiのバージョンアップにはISOを使用してアップグレードすべきと読めます。一方、セキュアブートでなければ、esxcli software profile update --depot=&lt;depot_location&gt; --profile=&lt;profile_name&gt; のコマンドでアップグレード可能です。詳細は、「VMware ESXiにパッチを適用する」の記事を参照してください。但し、ESXi7.0におけるハードウェア互換性が維持できるか慎重に確認するためには、ISOでのアップグレードを検討してください。\nVMware互換性ガイドは個人向けのハードウェアが殆ど列挙されておらずチェックが困難なのが実態です。ハードウェアが準拠しているかどうかのチェックについては後述します。\nまた、上記マニュアルには注意点としての記載がありませんが、スナップショットを取得していない状態でアップグレードされる事をお勧めします。\nこの記事はESXi6.7からESXi7.0にアップグレードする例を記載しています。厳密なアップグレードパスについては以下を確認してください。\n\n\n\nVMware Product Interoperability Matrix https://interopmatrix.vmware.com/Upgrade?productId=1&amp;isHidePatch=true\n\n仮想マシンのバックアップ（任意）バージョンアップの前には仮想マシンのバックアップを別の筐体またはメディアに取得される事をお勧めします。「VMware ESXiの仮想マシンをバックアップする」の記事を参照してください。ghettoVCBを使ったバックアップでは、ESXiにsshした上で、次のコマンドで全ての仮想マシンのバックアップ取得が可能です。/bin/sh ./ghettoVCB.sh -a\nアップグレード対象のESXi7.0を確認するESXiのISOインストーラのダウンロードは、2023年2月8日時点ではESXi7.0 Update3gとなっています。\n\nVMware vSphere Hypervisor 7.0 Update3g ダウンロード センター(※VMware Customer Connectへログインが必要です) https://customerconnect.vmware.com/jp/web/vmware/evalcenter?p=free-esxi7\n\nESXi7.0インストールメディア（USB）の作成ここではUSBメモリを用意し、ESXi7.0のインストーラーをセットアップします。事前にハードウェア互換リストを元に互換性があるかチェックしたいところですが、実際に個人向けのハードウェアは殆ど列挙されていません。\n\nVMware Compatibility Guide https://www.vmware.com/resources/compatibility/search.php\n\n運まかせでアップグレードを実行するのは勇気が要ります。また、ESXi7.0にアップグレードした後はダウングレードできません。そこで、32GBのUSBインストールメディア自身にESXi7.0をクリーンインストールし、検証する方法をお勧めします。つまり、USBメディアにインストールするISOイメージをセットアップし、マシンブートしセットアップを開始しますが、実際のセットアップはそのUSBをフォーマットしてUSB上にESXi7.0を新規でセットアップするというものです。フォーマットしてしまったらセットアップが動かなくなりそうですが、インストーラは最初にモジュールを全て読み込むのでこの方法が可能になります。これで既存の環境を壊さず、そのハードウェアにESXi7.0が導入できるかテストできます。もちろん、正式なセットアップをするためには再度ISOのインストーラーをUSBにコピーする必要があります。\nESXi7.0 インストーラーのダウンロード以下からISOをダウンロードします。\nhttps://customerconnect.vmware.com/jp/web/vmware/evalcenter?p=free-esxi7\nダウンロードは、”VMware vSphere Hypervisor (ESXi ISO) image”をダウンロードします。\nまた、製品のライセンスキーが表示されていますので、メモを取っておいてください。\nRufusによるisoメディアの作成以下のサイトからRufusをWindowsでダウンロードし実行します。\n\nRufus https://rufus.ie/ja/\n\n 以下のオプションでUSBメディアにESXi7.0のインストーラーを書き込みます。\n \n UEFIのセキュアブートに対応させるためにはGPTとUEFIを選択してください。\nESXi7.0のテストインストールESXi6.7がインストールされているハードウェアにUSBを挿しUSBブートします。\n\nhttps://www.youtube.com/watch?v=eiZn54GPfzI\n\n\n\nビデオの45秒あたりのところで、どのディスクにインストールするか選択しますが、ここではUSBメモリを選択します。ここは少し緊張感が必要です。テストインストールですのでパスワードも簡単なものに、といきたいところですが、パスワード要件として小文字、大文字、数字、および特殊文字を含める必要があります。よってキーボードも日本語キーボードであればきちんとキーボードの種類も選択する必要があります。\n誤って既存のESXi6.7がインストールされているドライブに新規インストールを選択してしまうと、既存の環境が全てフォーマットされてしまいます。\n\n\nセットアップ終了後、再びUSBメモリからブートします。今度はセットアップではなく、ESXi7.0が起動します。ブートシーケンスが既存のSSD等から起動した場合はESXi6.7が起動してしまいます。一旦この状態で、PCをESXiに接続し、ブラウザからESXiにログインし、ストレージやネットワークが使えるか確認できます。当然ながらここには既存の仮想マシンは存在しません。\nESXi7.0へのアップグレード再び、Rufusを使い、USBメディアにISOイメージを作成します。そして前述したビデオを参考に今度は既存のESXi6.7がインストールされているSSDに対してアップグレードを選択します。\n\nhttps://www.youtube.com/watch?v=eiZn54GPfzI\n\n\n\n今回はアップグレードが終了し、再起動する際にはUSBメディアは外してください。\n無事再起動したら管理画面にログインします。ESXi7.0はWebUIではビルド番号までは判明しません。sshでESXiに接続し、esxcli system version getを実行し確認します。\n[root@esxi:~] esxcli system version getProduct: VMware ESXiVersion: 7.0.2Build: Releasebuild-20328353\n\nコマンドで確認する際は、Versionとビルド番号で見るのが確実です。VMwareのサイトではパッチは7.0を対象に検索し、あとはビルド番号で照会します。\n後処理無事アップグレードが成功したら、以下の作業を行います。\n\nESXi7.0のライセンス登録 ESXiにログイン後、左ペインメニューのホスト-管理からライセンスタブを選択し、ライセンスの割り当てでダウンロード時に控えたライセンスキーを登録します。\nESXi7.0の最新パッチ適用 ESXiのパッチ適用については、「VMware ESXiにパッチを適用する」を参照してください。\nESXi7.0の構成情報のバックアップ（任意）\n\n仮想マシンのアップグレード（任意）ESXiのバージョンアップ後、仮想マシンのバージョンをアップグレードできます。\nVMware ToolsのアップグレードはESXiをアップグレード後、仮想マシンを起動させた時にアップグレードが可能な場合、WebUIの当該仮想マシンの項目にメッセージが表示されます。\n\nアップグレードしたESXi7.0VMware Toolsよりも新しいバージョンがある場合は以下のように表示されます。\n\nこの場合はWebUIで左ペインの仮想マシンで対象仮想マシンを選択し、アクションメニュー→ゲストOSからVMware Toolsのアップグレードを実行します。\n詳細は以下の内容を参照してください。\n\nVMware Tools のアップグレード https://docs.vmware.com/jp/VMware-Tools/11.3.0/com.vmware.vsphere.vmwaretools.doc/GUID-A2491004-1C67-4E14-B47B-807E20C19108.html\n\nVMware Toolsを最新にした後、仮想マシンハードウェアをアップグレードすることができます。ただし、下記のドキュメントに注意書きがある通り、新しいハードウェアバージョンの付属機能が必要な場合のみ実行することとあり、これはESXiのアップグレードに対して必須事項ではありません。\n\n仮想マシンの互換性の手動アップグレード https://docs.vmware.com/jp/VMware-vSphere/7.0/com.vmware.vsphere.vm_admin.doc/GUID-60768C2F-72E1-42E0-8A17-CA76849F2950.html\n\n\n仮想マシン ハードウェアをアップグレードすると、一部のアプリケーションまたはオペレーティング システムが適切に動作しなくなることがあります。ハードウェア バージョンのアップグレードは、新しいハードウェア バージョンの付属機能が必要な場合のみ実行します。\nMicrosoft Windows 仮想マシンで VMware Tools をアップグレードする前に互換性をアップグレードすると、仮想マシンのネットワーク設定が失われることがあります。\n\n\n\nこの操作は以下の通りWebUIで左ペインの仮想マシンで対象仮想マシンを選択し、アクションメニューから仮想マシンの互換性のアップグレードを実行します。\n\n\nESXi6.7のダウングレード（ご参考）（この章は、ESXi6.7からESXi7.0Update2aへのアップグレード時にエラーが発生するケースがあり記載しています）\nESXi6.7のパッチバージョンがESXi670-202111001の場合、ESXi7.0Update2aへのアップグレードが行えません。\n\n\nVMW_bootbank_vmkusb_0.1-4vmw.670.3.159.18828794と依存関係の問題があるとのことです。\n対策としてESXi6.7のひとつ前のパッチリリースに戻すことを検討します。ESXiホストを再起動し、起動中にShift+’R’キーを押すことによって1つ前のバージョンに戻せます。\n\nVMware ESXi を前のバージョンに戻す (1033604) https://kb.vmware.com/s/article/1033604?lang=ja\n\n\nHypervisor のプログレス バーの読み込みが開始されたら、Shift+R を押します。(これはバーが表示されたロード後ではなく、ロード中に実行する必要があります。コマンドを実行するタイミングを逃さないよう、”system is preparing to boot” 表示中に Shift+R を繰り返し押すことをお勧めいたします)。\n\n 私の環境では以下のように表示されました。\n\n\n戻す対象のビルド番号は17700523と表示されています。これは、Patch Release ESXi670-202103001であり、2021年3月18日にリリースされているESXi6.7の一つ前のパッチリリースです。これはリリース日付が逆転しておらず、うまくいきそうです。ここでロールバックを実行します。\n","categories":["Software"],"tags":["ESXi"]},{"title":"VMware ESXiを8.0にアップグレードする","url":"/new-technology/2023/06/18/esxi-upgrade8/","content":"\nこの記事で実現すること\n\n無償版ESXi（VMware vSphere Hypervisor）について、ESXi8.0U1にアップグレードします。最新のESXiは8.0U3bとなっています。\n\n\nご注意事項2024&#x2F;1&#x2F;22に発表されたVMWareブログによりますと、スタンドアロン製品の提供を終了し、サブスクリプションモデルに変更されることとなりました。この無償版ESXiは今後提供停止となりますが、サポートは継続されるとの事です。無償版ESXiの利用にあたっては、まずこちらの記事「VMWare 無償版ESXiの提供終了について」を参照されることをお勧めします。現時点では、ESXi8のライセンスキーをお持ちの方が対象です。Broadcomサイトでは最新のisoモジュールがダウンロードできますが、ライセンスキーを新たに取得することはできません。\nESXiのアップグレードまず正式なアップグレードに関するドキュメントがVMwareより提供されており、こちらでポイントを確認します。アップデートとアップグレードとは異なります。ESXiのバージョン体系は、”x”.”y” update “z” ビルド番号 という並びで表現されます。\n\nアップグレードは、前2桁（x,y）を上げることを指します。\nアップデートは、前2桁が変わりません。それ以降の数字があるケース、またはUpdate”z”などの形式があります。Update2を省略してU2、さらにU2a、U2cなど英数字が上がっていきます。\n\nアップデートによってこれまで動いていたハードウェアが動かなくなるという事は大々的にはおきません（ドライバーの更新によって認識しなくなったりうまく動作しないという一般的な理由はあります）。アップグレードではハードウェアのサポート対象の見直しが入ります。\n\nESXiのアップグレード https://docs.vmware.com/jp/VMware-vSphere/8.0/vsphere-esxi-80-upgrade-guide.pdf\n\n例によってVMwareのマニュアルは法人向けにvCenter Serverを中心に記載されているのでポイントを無償版ESXiに絞ります。\n\nVMWare互換性ガイドでアップグレードが可能か確認する（P8）\nESXi8のハードウェア要件（P17）\nアップグレード後はDiskのパーティション要件にてロールバック不可（P19）\nesxcliコマンドまたはISOブートからのアップグレードの2種類がある（P37,P70）\nアップグレードには新たにESXi8.0向けの（無償版ESXiの）ライセンスを登録する（P87）\n仮想マシンとVMware Toolsのアップグレード（P11）\n\n注意点は以下の通りです。\n\nesxcliコマンドを使用してアップグレードすると、古いバージョンのESXiは新しいVIBのインストールを実行するため、署名が保存されずセキュアブートは実行できません。ISOを使用してアップグレードすると、新しいVIBは署名を保存できます。（P88）\n\n上記の注意点の通り、UEFIのセキュアブートで稼働しているESXiのバージョンアップにはISOを使用してアップグレードすべきと読めます。一方、セキュアブートでなければ、esxcli software profile update --depot=&lt;depot_location&gt; --profile=&lt;profile_name&gt; のコマンドでアップグレード可能です。詳細は、「VMware ESXiにパッチを適用する」の記事を参照してください。但し、ESXi8.0におけるハードウェア互換性が維持できるか慎重に確認するためには、ISOでのアップグレードを検討してください。\nVMware互換性ガイドは個人向けのハードウェアが殆ど列挙されておらずチェックが困難なのが実態です。ハードウェアが準拠しているかどうかのチェックについては後述します。\nまた、上記マニュアルには注意点としての記載がありませんが、スナップショットを取得していない状態でアップグレードされる事をお勧めします。\nESXi8にアップグレードする例を記載しています。厳密なアップグレードパスについては以下を確認してください。\n\nvCenter Server Back-in-time release https://kb.vmware.com/s/article/67077#vCenterServer_7.0.x_to_8.0_upgrade_matrix\n\n仮想マシンのバックアップ（任意）バージョンアップの前には仮想マシンのバックアップを別の筐体またはメディアに取得される事をお勧めします。「VMware ESXiの仮想マシンをバックアップする」の記事を参照してください。ghettoVCBを使ったバックアップでは、ESXiにsshした上で、次のコマンドで全ての仮想マシンのバックアップ取得が可能です。/bin/sh ./ghettoVCB.sh -a\nアップグレード対象のESXi8.0を確認するESXiのISOインストーラのダウンロードは、2024年9月29日時点ではESXi8.0 Update3bとなっています。\nESXi8.0インストールメディア（USB）の作成ここではUSBメモリを用意し、ESXi8.0のインストーラーをセットアップします。事前にハードウェア互換リストを元に互換性があるかチェックしたいところですが、実際に個人向けのハードウェアは殆ど列挙されていません。\n\nVMware Compatibility Guide https://www.vmware.com/resources/compatibility/search.php\n\n以前は検証のためにUSB上にESXi7.0をセットアップできましたが、 ESXi8からはUSBへのテストセットアップできなくなっています。ハードウェアが準拠せずアップグレード後起動しない、NICが利用できない可能性があるため、仮想マシンのバックアップを確保される事をお勧めします。なお、個人向けのハードウェアで関係するところは、Mellanox Connect X-3がサポート対象外となりました。Mellanoxユーザーとしては、Connect X-4&#x2F;X-5を使う事になるでしょう。\nESXi8.0 インストーラーのダウンロード（Broadcomサイト）Broadcomサポートポータルにサインインし、画面上部のメニューのVMWare Cloud Foundationをクリックします。\n\nBroadcom Support Portal https://support.broadcom.com/\n\n\n\nさらに、左ペインのMy Downloadをクリックし、さらに画面左にある絞り込みのテキストボックスに”vSphere”と入力します。\n\n\nVMWare vSphereを選択します。\n\n\n次に”Solutions”のタブをクリックします。\n\n\n“VMware vSphere Standard”をクリックし、バージョンの”8”をクリックします。\n\n\n本来であれば、vSphere Hypervisorが選択肢としてあるべきですが、Standardを選びます。\n最新のパッチである”VMware-ESXi-8.0U3b-24280767”のリンクが現れるのでクリックし、画面下部に移動し”VMware-VMvisor-Installer-8.0U3b-24280767.x86_64.iso”をダウンロードします。\nRufusによるisoメディアの作成以下のサイトからRufusをWindowsでダウンロードし実行します。\n\nRufus https://rufus.ie/ja/\n\n 以下のオプションでUSBメディアにESXi8のインストーラーを書き込みます。\n \n UEFIのセキュアブートに対応させるためにはGPTとUEFIを選択してください。\nESXi8.0へのアップグレード以下の動画を参考にしてください。特に難しいものはありません。途中、新規インストールかアップグレードかを選択する箇所があります。この動画では新規インストールを選択していますが、アップグレードを選んでください。\n\nhttps://www.youtube.com/watch?v=eiZn54GPfzI\n\n\n\nアップグレードが終了し、再起動する際にはUSBメディアは外してください。\n補足：この記事でのアップグレードの検証について私は現時点でESXi7がインストールされている検証機を保有していないため、ここでは今回ダウンロードしたESXi-8.0U3bのISOファイルをクリーンインストールして検証しています。インストールの中でクリーンインストールかアップグレードかを選択するため、特にアップグレードでも問題が発生することは無いものと考えられます。従来の”vSphere Hypervisor”ではなく、BroadcomではStandardのvSphereということで大丈夫なのかという疑問はあるでしょうが、これはライセンスキーを投入したところで”vSphere Hypervisor”としての挙動になります。\n\n\n無事、vSphere Hypervisorのライセンスキーが通ります（手順は後述します）\n\n\nvSphere HypervisorとなってvMotionも無効になっています。\n\n\nそういえば、ESXiはNVMe（コントローラー）の認識について厳しかったことをすっかり忘れていましたが、Lexar NM790 2TBは特に問題なく認識されています。\n\n\nアップグレード後のログイン無事再起動したら管理画面にログインします。sshでESXiに接続し、esxcli system version getを実行し確認します（これはESXi8U1のケースです）。\n[root@localhost:~] esxcli system version get   Product: VMware ESXi   Version: 8.0.1   Build: Releasebuild-21495797   Update: 1   Patch: 0[root@localhost:~]\n\n管理画面でもESXi8になっていることは確認できますし、vmware -lコマンドでも確認できますが、Versionとビルド番号で見るには上記コマンドを使います。\n後処理無事アップグレードが成功したら、以下の作業を行います。\n\nESXi8.0のライセンス登録 ESXiにログイン後、左ペインメニューのホスト-管理からライセンスタブを選択し、ライセンスの割り当てで（VMWare時代の）ダウンロード時に控えたライセンスキーを登録します。※私はBroadcomサイトでのvSphere Hypervisorのライセンスのダウンロードは既に行えないものと理解しています（新規製品提供終了のため）\nESXi8.0の最新パッチ適用 ESXiのパッチ適用については、「VMware ESXiにパッチを適用する」を参照してください。\nESXi8.0の構成情報のバックアップ（任意）\n\n仮想マシンのアップグレード（任意）ESXiのバージョンアップ後、仮想マシンのバージョンをアップグレードできます。\nアップグレードしたESXi8.0VMware Toolsよりも新しいバージョンがある場合は以下のように表示されます。\n\n\nこの場合はWebUIで左ペインの仮想マシンで対象仮想マシンを選択し、アクションメニュー→ゲストOSからVMware Toolsのアップグレードを実行します。\n詳細は以下の内容を参照してください。\n\nVMware Tools のアップグレード https://docs.vmware.com/jp/VMware-Tools/11.3.0/com.vmware.vsphere.vmwaretools.doc/GUID-A2491004-1C67-4E14-B47B-807E20C19108.html\n\nVMware Toolsを最新にした後、仮想マシンハードウェアをアップグレードできます。ただし、下記のドキュメントに注意書きがある通り、新しいハードウェアバージョンの付属機能が必要な場合のみ実行することとあり、これはESXiのアップグレードに対して必須事項ではありません。\n\n仮想マシンの互換性の手動アップグレード https://docs.vmware.com/jp/VMware-vSphere/7.0/com.vmware.vsphere.vm_admin.doc/GUID-60768C2F-72E1-42E0-8A17-CA76849F2950.html\n\n\n仮想マシン ハードウェアをアップグレードすると、一部のアプリケーションまたはオペレーティング システムが適切に動作しなくなることがあります。ハードウェア バージョンのアップグレードは、新しいハードウェア バージョンの付属機能が必要な場合のみ実行します。\nMicrosoft Windows 仮想マシンで VMware Tools をアップグレードする前に互換性をアップグレードすると、仮想マシンのネットワーク設定が失われることがあります。\n\n\n\nこの操作は以下の通りWebUIで左ペインの仮想マシンで対象仮想マシンを選択し、アクションメニューから仮想マシンの互換性のアップグレードを実行します。\n\n\n構成情報のバックアップ（任意）今後、パッチ適用を重ねていきますが、ある時点にロールバックしたいと思った時に、ホスト構成バックアップから戻す必要が出てきます。パッチを当てる度に構成情報のバックアップを取得されることをお勧めします。\n参考にするドキュメントはこちらです。\n\nESXi ホストの構成のバックアップ方法 (2042141) https://kb.vmware.com/s/article/2042141?lang=ja\n\n\nSSHでESXiに接続します。\nストレージの確実な同期のためのコマンドvim-cmd hostsvc/firmware/sync_configを実行します。\nバックアップコマンドvim-cmd hostsvc/firmware/backup_configを実行します。\n画面にダウンロードパスが表示されるのでそのURLにブラウザから接続し構成情報をダウンロードします。\n\n[root@esxi:~] vim-cmd hostsvc/firmware/sync_config[root@esxi:~] vim-cmd hostsvc/firmware/backup_configBundle can be downloaded at : http://*/downloads/52ce000f-cad4-20c0-078d-a111fa1ad82x/configBundle-esxi.local.tgz[root@esxi:~]\n\n先頭にhttp://*/とありますが、ここはESXiのホスト名またはIPアドレスを指定しブラウザからアクセスします。例えば、http://192.168.1.1/downloads〜という具合です。万が一レストアが必要になってしまった場合はバックアップを取得したバージョンのパッチを適用の上、メンテナンスモードに移行してからvim-cmd hostsvc/firmware/restore_config /your_backup_location/configBundle-esxi.local.tgzで戻します。バックアップを取得してから既にハードウェア構成が変わっていたりする場合は戻せない場合があります。仮想マシンはデータストアブラウザから再登録する必要があります。詳細は上記VMwareのドキュメントを参照してください。\n","categories":["Software"],"tags":["ESXi"]},{"title":"VMware vSphere Hypervisor（ESXi）のインストール","url":"/new-technology/2020/02/29/esxi/","content":"この記事で実現すること\n\nSophos Firewall（旧名称はXG Firewall）を仮想環境で稼働させるために、VMware ESXiをインストールします。\n\n\nご注意事項2024&#x2F;1&#x2F;22に発表されたVMWareブログによりますと、スタンドアロン製品の提供を終了し、サブスクリプションモデルに変更されることとなりました。この無償版ESXiは今後提供停止となりますが、サポートは継続されるとの事です。無償版ESXiの利用にあたっては、まずこちらの記事「VMWare 無償版ESXiの提供終了について」を参照されることをお勧めします。\nESXiについて 無償版の仮想環境ESXiはvSphere Hypervisorという名前が付けられています。Sophos Firewallの導入に必須ではありませんが、XG自体をバックアップすることやバージョンアップの際にその状態を一時保存するスナップショットなどとても便利なので、仮想環境を構築しその上に仮想ホストとしてXGをインストールします。vSphereという製品群、その中の1つの無償版バージョンとして、”vSphere Hypervisor”があります。ESXiは製品名というよりは直接ハードウェアを制御するVMWareの仮想化ソフトウェア、これに対する一般用語としては”ハイパーバイザー”です。そして、ESXi（ハイパーバイザー）上で稼働する実際のOSをVirtual Machine（VM:仮想マシン）と呼びます。\n（2022-11-23追記）ESXiの最新Versionは2022-10-11に発表された8.0となっています。\nこのホームユーザー向け（無償版）ESXi（vSphere Hypervisor）に関するドキュメントは、VMWareのサイトを参照してください。\n\nVMware vSphere Hypervisor https://www.vmware.com/jp/products/vsphere-hypervisor.html\n\nハードウェア互換リスト事前にハードウェア互換リストを参照し、用意したハードウェアに互換性があるかチェックしたいところですが、実際に個人向けのハードウェアは殆ど列挙されていません。\n\nVMware Compatibility Guide https://www.vmware.com/resources/compatibility/search.php\n\nCPUはAMDのRyzenが無難であり、Eコア&#x2F;Pコアを持つintel CPUはうまくセットアップできないという口コミもあり、コミュニティなどの情報を確認することが必要です。ネットワークカードはintel&#x2F;Mellanox(現NVidea)の互換性が高いというより他はなく、明確な機器をリストアップすることが困難です。CPUとネットワークカードはintel製を選択されるのが無難です。ストレージに関しては、SATAのSSDであれば大半のメーカーのものは認識するようですが、NVMeについてはSamsung 970EVO Plus、WD-Blueなどを選択されるのが無難です。\nインストールメディアの準備\nESXiをインストールする予定の2つのNICを持ったPC1台と、ISOファイルをインストールするための最低8GB、推奨32GB以上のUSBメディアを用意してください。\nESXiのダウンロードにはVMwareのアカウント（無償）が必要です。VMWareのサイトでアカウント作成、製品（vSphere Hypervisor）をダウンロードします。\n\n\nvSphere Hypervisor 7.0  https://my.vmware.com/jp/web/vmware/evalcenter?p=free-esxi7\n\n\nvSphere Hypervisor 8.0  https://my.vmware.com/jp/web/vmware/evalcenter?p=free-esxi8\n\n\n\nvSphere Hypervisor 7.0(https://my.vmware.com/jp/web/vmware/evalcenter?p=free-esxi7)このダウンロード センターには、技術資料、インストール デモ、およびvSphere Hypervisorのトレーニングが用意されています。\n\n\n\n\n\nvSphere Hypervisor 8.0(https://my.vmware.com/jp/web/vmware/evalcenter?p=free-esxi8)このダウンロード センターには、技術資料、インストール デモ、およびvSphere Hypervisorのトレーニングが用意されています。\n\n\n\n\n\n\n以下のYouTube動画を参考にメディアを作成します。USBメディア作成に用いるRufusは64bit版のWindows OSが必要です。\nhttps://www.youtube.com/watch?v=7gYnyIaQH9A\n\n\n\n \n\n\nRufus https://rufus.ie/ja/\n\n \n ESXiのインストール対象マシンがUEFIのセキュアブートに対応しているのであればこのようにGPTとUEFIを選択してください。\nESXiのインストールネットワーク構成普段利用しているネットワークとは別のネットワークのIPアドレスを振ってセットアップします。いつもが192.168.0.0/24なら、今回は仮に192.168.1.0/24のネットワークに配置する予定としてESXiをセットアップする事にしましょう。これまでのネットワークにXG Firewallを挟み込む事になり、従来のネットワークはXGのWAN側とホームゲートウェイに利用され、XGのLAN側は新しいネットワークになるためです。新たにXGのLAN側と同じネットワークにESXiの管理ネットワークを構築する必要があります。なお、XGのLAN側のデフォルトIPアドレスは、172.16.16.16となっています。ここではXGのIPもセットアップ時に192.168.1.0/24のネットワークに変更する事とします。XGのセットアップが完了し、192.168.1.0/24のネットワークからXGを介してインターネットに接続できたら、今の192.168.0.0/24にある機器をXGのLANを経由するように移設していきます。\n\n\n上記の図のように、1台のハードウェアにESXiをインストールし、ESXiのインストール終了後はブラウザでESXiを制御するための別のPCが必要となります。\nUSBメディアからインストールインストールについては、以下のYouTube動画を参考にRufusでセットアップしたUSBメディアからブートしてください。インストール対象のハードウェアがUEFIブート可能である場合は、BIOSの設定でセキュアブートを有効にし、UEFI(GPT)としてESXiをセットアップされる事をお勧めします。セキュアブートによってマルウェア等からの改ざん防止としての効果が期待できます。一方、勝手にユーザー作成モジュールをインストールできないという制約も加わります。\n\nhttps://www.youtube.com/watch?v=eiZn54GPfzI\n\n\n\n\nvCenterはホームユーザー向けには使いませんので無視してください。\nNICが2枚ある事を前提にすると、ESXiの管理画面はLAN側のNICを対象とするように設定してください。今の時点では、WANは使いません。新しく振ったIP（192.168.1.1/24）をESXiの管理用IPとして、セットアップします。\n上記のビデオ（2:35前後の説明）では「冗長性のためにnicを2枚以上選択することが推奨されます」と説明がありますが、今回は冗長化を使いません。先頭のvmnic0をLAN側のNIC（管理用）としてセットアップしてください。また、ここではVLANも使いません。\nESXiでは、vSphere Clientは使いません。インストールしたESXiのLAN側のIPアドレスに対してブラウザで接続し、ESXiのWeb管理画面を利用します。\n\nセットアップ終了後、USBメディアを抜いて再起動後、ESXiの画面にIPアドレスが表示されます。ESXiのLAN側のNICと操作用のPCとを繋ぎます。PCのIPを設定（例えば、192.168.1.101/24）し、ESXiのIPアドレスにブラウザで接続してください。ログインは、ユーザー名がroot、パスワードはセットアップで指定したものになります。\n","categories":["Security"],"tags":["ESXi","XG Firewall"]},{"title":"VMware ESXiにパッチを適用する","url":"/new-technology/2020/06/14/esxi67-patch/","content":"\nこの記事で実現すること\n\n無償版ESXi（VMware vSphere Hypervisor）について、BroadcomおよびVMWareのサイトから製品パッチに関する情報を入手し、ESXi上でパッチを適用します。この記事ではESXi8.0を対象にしていますが、コマンド自体はESXi7.0も変わりません。\n\n\nBroadcomのパッチのダウンロードについて2025-03-08の時点でESXi8.0は　Update3dのパッチが提供されています。しかしながら、私のBroadcomアカウントが個人のgmailで登録していたためか、Broadcomのサイトからパッチがダウンロードできなくなっています。個人のProfileを構成しなくてはなりませんが、「non-corporate email domain」はProfileが構成できないとのことです。無償ユーザーは少しづつ制約が加えられてきていることをひしひしと感じます。昨年はパッチをダウンロードできていましたが、現時点ではこれまで紹介してきた方法では実施できなくなっています。とはいえ、このブログは個人のためのものであり、自分が勤めている会社のメールを登録するつもりは全くありませんし、他の方法を模索しなくてはなりません。\nこの記事に記載していることはメーカーの推奨する正しい方法ですのでこの記事は残しておきます。\nESXi8.0 Update3dのパッチ適用方法については「VMware ESXi8 Update3dのパッチを適用する」で、新たな記事を書いています。\n従来のパッチ適用方法についてここから先は、Esxi8のUpdate3cまでパッチ適用に利用していたBroadcomの推奨する方法です。\nパッチ適用に必要なものSSHでESXiに接続し、コマンドラインでパッチを適用します。Windows11ではOpenSSHがデフォルトで導入されています。Windows10ではOpenSSHがサポートされていますので、オプション機能を追加するからOpenSSHクライアントを有効にし、コマンドラインからssh  root@ESXiのIPアドレスで接続可能です。\nVMwareのパッチ情報ESXiのパッチ情報は以下を参照してください。当該ページの左ペインメニューには最新パッチの情報が掲載されていますので、最新のパッチ情報を辿ってください。また、過去のパッチの情報も提供されています。\n\nVMware ESXi 8.0 Update 3c （2024-12-12リリースノート発表） https://docs.vmware.com/en/VMware-vSphere/8.0/rn/vsphere-esxi-80u3c-release-notes/index.html\n\nアップデートで稀に動作しなくなるデバイスが発生するケースもありますので事前の仮想マシンのバックアップをお勧めします。\nESXi7.0も2024-12-12に提供されています。\n\nVMware ESXi 7.0 Update 3r https://knowledge.broadcom.com/external/article/383775\n\n この記事ではESXi7.0のパッチ適用の詳細は説明していません。ESXi8.0のものを参考に最新パッチをダウンロードし適用してください。\n\nBroadcom サポートページ　VMware-ESXi-7.0U3r-24411414-depot https://support.broadcom.com/web/ecx/solutiondetails?patchId=5633\n\n製品パッチの情報を入手する（Broadcomサイト）Broadcomサポートポータルにサインインし、画面上部のメニューのVMWare Cloud Foundationをクリックします。アカウントを保有していない方は右上のRegisterからユーザー登録を行います。\n\nBroadcom Support Portal https://support.broadcom.com/\n\n\n\nさらに、左ペインのMy Downloadをクリックし、さらに画面左にある絞り込みのテキストボックスに”vSphere”と入力します。\n\n\nVMWare vSphereを選択します。\n\n\n次に”Solutions”のタブをクリックします。\n\n\n“VMware vSphere Standard”をクリックし、バージョンの”8”をクリックします。\n本来であれば、vSphere Hypervisorが選択肢としてあるべきですが、Standardを選びます。\n最新のパッチである”VMware-ESXi-8.0U3c-24414501-depot”のリンクが現れるのでクリックし、画面下部に移動し、”VMware-ESXi-8.0U3c-24414501-depot.zip”をダウンロードします。\n\n\n基本的にESXiは修正パッチを適用する場合はこの7.0、8.0という2桁の数字は変わりません。この数字が変わる更新をアップグレードと呼びます。それ以外の小さい更新をパッチまたはアップデートと呼びます。但し、Update2,Update3というグループがあり、さらにUpdate3k、Update3lという具合にグループ単位でパッチ毎に末尾の英字が大きくなっていきます。VMwareのパッチは累積パッチとなるため、最新のパッチを適用するだけでよく、古いパッチの適用は必要ありません。ここでは最新版のパッチをダウンロードします。\n事前準備ESXiにログインし、以下の作業を行います。\n\nSSHを有効にします\n仮想マシンを全てシャットダウンします\nESXiをメンテナンスモードに切り替えます\nダウンロードしたパッチファイル（ZIPファイル）をESXiにアップロードします\nSSHでESXiにログインします\nパッチ適用コマンドを入力、リブートします\nメンテナンスモードを終了します\nSSHを無効にします\n仮想マシンを起動します\n\n\nSSHを有効にする ESXiの左ペインのホストー管理から、”サービス”のタブをクリックし、”TSM-SSH”を選択し”起動”ボタンをクリックし、SSHを有効にします。\n\n \n\n\n仮想マシンを全てシャットダウンします\n\nESXiをメンテナンスモードに切り替えます\n\n\n \n\n\nパッチファイルのESXiへのアップロード ESXiの左ペインメニューの”ストレージ”を選択、メインのストレージ（一般的にはdatastore1）を選択し、”データストアブラウザ”をクリックします\n\n \n アップロードボタンをクリックし、ダウンロードしたパッチファイルをZIPのままアップロードします。\n ここの例ではディレクトリの作成ボタンでupdateフォルダを作成し、そこにアップロードします。\n\nSSHでESXiにログイン ログイン後、パッチをアップロードしたフォルダ（datastore1&#x2F;update）に移動しアップロードしたパッチファイルが存在するかlsで確認します\n\n [root@esxi:~] cd /vmfs/volumes/datastore1/update[root@esxi:~] ls\n\nESXiのパッチ適用パッチ適用のコマンドは7.0、8.0とで違いはありません。ここでは直近バージョンからのパッチ適用のための具体的なコマンドを記載しています。\nパッチ適用(ESXi8.0の場合)ここでは、ESXi8.0の情報を掲載します。ESXi7.0についてもコマンド自体は変わりません。\n現在稼働中のプロファイルを確認 新しいドライバやバグフィックス、セキュリティパッチなど含めたprofileとして整合性が取れたvibのアップデートはprofile updateを実行します。ここでは、ESXi8.0Update3bからUpdate3cにアップデートすることを例にします。\n 現在の実行中のprofileを確認します。esxcli software profile get [root@localhost:~] esxcli software profile get(Updated) ESXi-8.0U3b-24280767-standard   Name: (Updated) ESXi-8.0U3b-24280767-standard   Vendor: VMware, Inc.   Creation Time: 2024-09-25T10:50:12   Modification Time: 2024-12-21T00:38:33   Stateless Ready: True\n 一般的にはバージョンの最後に”-standard”の文字が付いています。standard版がインストールされている事を示します。\n 次に、パッチファイルに登録されているprofileを確認します（パッチはフルパス指定が必要です）。 [root@localhost:/vmfs/volumes/datastore1/update] esxcli software sources profile list -d /vmfs/volumes/datastore1/update/VMware-ESXi-8.0U3c-24414501-depot.zipName                           Vendor        Acceptance Level  Creation Time        Modification Time-----------------------------  ------------  ----------------  -------------------  -----------------ESXi-8.0U3c-24414501-no-tools  VMware, Inc.  PartnerSupported  2024-12-12T00:00:00  2024-12-12T00:00:00ESXi-8.0U3c-24414501-standard  VMware, Inc.  PartnerSupported  2024-12-12T00:00:00  2024-12-12T00:00:00\n今回はVMWareTools有&#x2F;無のシンプルなパターンですね。今回はツール有りの、”ESXi-8.0U3c-24414501-standard”を適用します。\nパッチ適用以下のようにパッチファイルのzipをフルパスで指定し、VMwareのパッチ情報にあるプロファイル名を指定しパッチを適用します。ここではstandardを指定します。\n[.../update] esxcli software profile update -d /vmfs/volumes/datastore1/update/VMware-ESXi-8.0U3c-24414501-depot.zip -p ESXi-8.0U3c-24414501-standard\n\nesxcli software profile updateの実行後しばらくしてから、結果が表示されます。\nUpdate Result   Message: The update completed successfully, but the system needs to be rebooted for the changes to be effective.   ...   Reboot Required: true\n\n再起動と結果確認コマンドプロンプトから、rebootとしてESXiを再起動します。\n再起動完了後、ESXiにログインします。左ペインメニューの”ホスト”をクリックし、バージョンの表記に今回パッチを当てたビルド番号が表示されている事を確認してください。今回はU3cとなっているはずです。\n\n\nまたは、sshでESXiに接続し、vmware -vを実行し確認します。\n [root@localhost:~] vmware -vVMware ESXi 8.0.3 build-24414501\n\n事後作業これまで実施してきたメンテナンス準備とは反対の作業をします。メンテナンスモードの終了・SSHの無効化・仮想マシンの起動と続けます。\nパッチのロールバックあまり考えたくはありませんが、パッチ適用後、うまく動作しないなどの場合にはロールバックします。ESXiはひとつ前のバージョンに戻せます（アップグレードの場合は戻せない場合があります）。ESXiホストを再起動し、起動中にShift+’R’キーを押します。\n\nVMware ESXi を前のバージョンに戻す (1033604) https://kb.vmware.com/s/article/1033604?lang=ja\n\n\nHypervisor のプログレス バーの読み込みが開始されたら、Shift+R を押します。(これはバーが表示されたロード後ではなく、ロード中に実行する必要があります。コマンドを実行するタイミングを逃さないよう、”system is preparing to boot” 表示中に Shift+R を繰り返し押すことをお勧めいたします)。\n\n 以下の通り、今動いているビルド番号と前のビルド番号が表示されます。\n\n\nここでロールバックを選択します。\n構成情報のバックアップ（任意）今後、パッチ適用を重ねていきますが、ある時点にロールバックしたいと思った時に、ホスト構成バックアップから戻す必要が出てきます。パッチを当てる度に構成情報のバックアップを取得されることをお勧めします。\n参考にするドキュメントはこちらです。\n\nESXi ホストの構成のバックアップ方法 (2042141) https://kb.vmware.com/s/article/2042141?lang=ja\n\n\nSSHでESXiに接続します。\nストレージの確実な同期のためのコマンドvim-cmd hostsvc/firmware/sync_configを実行します。\nバックアップコマンドvim-cmd hostsvc/firmware/backup_configを実行します。\n画面にダウンロードパスが表示されるのでそのURLにブラウザから接続し構成情報をダウンロードします。\n\n[root@esxi:~] vim-cmd hostsvc/firmware/sync_config[root@esxi:~] vim-cmd hostsvc/firmware/backup_configBundle can be downloaded at : http://*/downloads/52ce000f-cad4-20c0-078d-a111fa1ad82x/configBundle-esxi.local.tgz[root@esxi:~]\n\n先頭にhttp://*/とありますが、ここはESXiのホスト名またはIPアドレスを指定しブラウザからアクセスします。例えば、http://192.168.1.1/downloads〜という具合です。万が一レストアが必要になってしまった場合はバックアップを取得したバージョンのパッチを適用の上、メンテナンスモードに移行してからvim-cmd hostsvc/firmware/restore_config /your_backup_location/configBundle-esxi.local.tgzで戻します。バックアップを取得してから既にハードウェア構成が変わっていたりする場合は戻せない場合があります。仮想マシンはデータストアブラウザから再登録する必要があります。詳細は上記VMwareのドキュメントを参照してください。\n","categories":["Software"],"tags":["ESXi"]},{"title":"iPhone15 ProとWiFi6E","url":"/new-technology/2023/10/21/iPhone15pro/","content":"\n\nこの記事で実現すること\niPhone15 Proを購入しました。代表的なものはWi-Fi6Eへの対応ですが、色々なものに繋いだ所感を書いていきます。\n\n\n\nWi-Fi 6Eネットワークに興味がある方としては、iPhone15 Pro&#x2F;Pro MAXがWi-Fi 6Eに対応した事が大きいですね。160MHz幅で接続可能です。 MacbookであればTimeMachineでバックアップの時間短縮できるなど明らかなメリットがあるのですが、スマホではそのメリットが感じにくいところではあります。撮影した4K動画のNASへのアップロードが短縮できることや、画面のリフレッシュ速度も向上し端末全体が高速化しているので、Webブラウジングもより快適に感じます。\n\nSpeedTest\n\n\n\n\niPerf3\n\n\n\nまずまずの速度が出ています。私の環境ではInternet向けにはFirewallが入っていることもあり、一般的にはもう少し速度が出るかもしれません。\nなお、iOSに限らず、macOSでもそうなんですが、Appleデバイス全般の注意事項としては、Wi-Fi 6E単独のチャンネルでは安定せず、2.4GHz、5GHz、6GHz全てを有効にしたSSIDを作成する必要があります。\n\nApple 製デバイスで Wi-Fi 6E ネットワークを利用する https://support.apple.com/ja-jp/HT213433\n\n単独のWi-Fi6EではSpeedtestでも安定せず途中でテストが終了したり不安定です。これはMacbook Pro(2023)でも同じです。6E単独で接続した場合は、iOSで以下の警告が表示されます。\n\n\n制約のように見えますが、Wi-Fi6Eの電波の見つけ方の方法によってこのような挙動になります。Apple製品のように、必ずしもWi-Fi6Eのみに接続されていない5GHzの端末ともスムーズに連携するためには必要なのでしょう。\nWi-Fi ローミングWi-Fiローミングというのは同一SSIDで異なるアクセスポイント（AP)に自動で切り替わることです。最近の無線ルーターではメッシュ機能を持つものが増えてきました。例えば、1階から2階に移動した時に近くにあるアクセスポイントに自動的に切り替わり、より快適に使えるようになるというものです。\nこのローミングについて説明しだすとかなり長くなるのでここでは簡単にiPhoneに関して説明します。iPhoneはWi-Fiの電波が-70dBmを下回ると、他のAPにローミングしようとします（厳密には他のAPを探すという工程も含まれます）。その際、高速にローミングが行えるかどうかというのがスマホの使い勝手では重要です。\n一般的にスマホがWi-Fiに繋がる場合は、無線に接続する際の認証が行われ、DHCPによってIPアドレスを割り当てるという手順が入ります。この手順をAPが変わるたびに実施していたのでは最低でも1秒程度の切断が発生します。つまり通話中にフロアを移動していると途中でパケットの再送が入りますが、IPアドレスの再取得をやっていたのでは通話、アプリが切断されることになります。これらに対処するものが高速ローミングです。\n高速ローミングは認証情報がキャッシュされることが必須です。私たちが一般的に使うようなSSID毎のパスワードであったり、企業で使われるRADIUS認証によるユーザー認証情報をキャッシュし、別のAPで速やかにIPアドレス引き継ぎと高速な再認証が必要です。\nこのような方法によって、高速ローミングが実現し、数十ミリ〜遅くとも100ミリ程度でAPが切り替わり、その際に通話が途絶えることはありません。パケットの再送は確実に行われますが、スマホやリモート会議などでは1秒近くのバッファリングがあるので再送による遅延にユーザーが気づくことはあまりありません。\nお使いのAPによって挙動は変わりますが、以下は私が自宅で1階から2階に移動した時のPingの結果です。PingPlotterというアプリでGoogleまでのラウンドトリップを計測しています。最初に他のAPを探すところで第1段階の遅延、切り替わるところで第2段階の遅延が発生します。\n\n\n丸を2つ示していますが、左側が最初の遅延で250ミリ秒近くあります。これはAPを探している状態に入っています。このタイミングではAPー端末間の通信が保留になり遅延が発生します。本当にタイミングが悪ければパケットを取りこぼすこともあり再送が入ります。が、極めて小さな時間でありTCP&#x2F;IPやアプリケーションの再送機能によって大半はカバーされます。これはやや悪いケースの計測結果であり、一旦情報がキャッシュされるなどしていて、良いケースではその半分程度まで遅延が軽減されます。右側の丸辺りで実際にローミングしています。これは20ミリ秒程度の遅延です。スマホのWi-Fiのアンテナ表示が変わったタイミングを目視により確認しました。\nなお、APを探すところで250ミリあるのは私の環境の問題にも関わっており、iPhoneがAPから離れすぎた状況（-75dBmを下回る）のためと考えられます。電波の強さと端末との距離を考えながらAPの配置を行う必要があり、これには計測とトライアンドエラーの繰り返しが必要です。ちょうど家の端の階段の辺りが電波の弱いところで、そこにAPをさらに置いても良いのですが、100ミリ秒程度の改善でそこまで対応する気にもならずそのままにしています。\niPerf3を実行しながらフロアを移動した場合、瞬間的にはAPを探すところで数十Mbpsまでに落ち込むケースもありますが、完全に0となったりエラーになることはありません。\nこれ以上の話は複雑なのでまた別の機会があれば触れてみたいと思いますが、リビングでTeamsやZoomなどのリモート会議をしていて、家族が帰ってきてバタバタと2階に移動する際にも相手の発言が途切れることはありません。\niPhone15Proは、以前のiPhone11やiPhone12よりも電波を掴む力は強いように感じます。5GHzの電波ではまれに公衆回線に切り替わっていたお風呂でのブラウジングが捗ります😊\n有線バックホールとメッシュWi-FiAPは一般的に有線で接続され、前述したようにローミング機能を提供しますが、個人向けのメーカーでは有線バックホールという名前が使われる場合があります。AP同士のコミュニケーションや通信を有線によって行うためです。一方、この有線バックホールを使わず、AP同士が無線で接続する形態をメッシュと呼んでいるようです。\nこのメッシュも独立したチャンネルを使う方法や端末と同一のチャンネルを使う方法など色々あり、各社のマニュアルを見ても、それについてはあまり明確に記載されていないものが多いようです。\nなお、一般的にビジネスで用いられるローミング方式（有線バックホール）では、AP同士は異なる周波数（チャネル）にするのが基本です。異なるAPで同じ周波数を使っていると、昔の中継機と同じでそれぞれのAPが出す電波同士で干渉してしまい、パフォーマンスが出ません。メッシュにすると遅くなるという感覚をお持ちの方も多いのではないでしょうか。\n高速なローミングとWi-Fiの最大限のパフォーマンスを引き出すにはAP同士は異なるチャンネルを設定する必要があります。これは製品によって対応できないものもあるようですので確認をお勧めします。\n有線バックホールを使わないケース、これは4LDK以上の広いフロアで物理配線が引けないなどの制約がある場合にやむなくAPをメッシュで分散配置する事については意味があります。ただそのような環境では後述するDFSを除けば、Wi-Fi6Eとなるメリットはあまり見出せないかもしれません。5GHzよりは6GHzの方が壁を通す力は落ちますから、5GHzの方がより電波は強力です。\nメッシュWi-FiとDFS個人向けの5GHzでは割り当てられた電波の幅によって80MHz単位で使うことが一般的ですが、5.2GHz帯のみDFSが無く、5.3GHz、5.6GHzはDFSがあります。レーダーを受信するとAPが停波してしまうことになりますから、レーダー回避のために6GHzを使うのは有効です。\n私の環境私の環境ではUbiquitiのUniFi製品を利用しています。以下はUniFiのトポロジーで自動的に構成されたネットワーク図です。上流のインターネット回線は、auひかり（10GbE）を使っています。\n\n\nAPはU6 Enterpriseという製品で、PoEで2.5GbEのLAN接続と併せてスイッチから電源を取ります。よくよく考えてみれば、クライアントが繋がっているスイッチからいきなりローミングして別のスイッチに切り替われば、スイッチは「いきなり別のスイッチポートから同じMACアドレスの端末のデータが届きネットワークループしてるのではないか」と混乱するはずです。しかし、そこはきちんと制御され、ローミングしたクライアントについて、接続されたすべてのスイッチのMACアドレステーブルを瞬時に更新しにいくようです。\n\nU6 Enterpriseアクセスポイント https://jp.store.ui.com/collections/unifi-network-wireless/products/u6-enterprise\n\n\nSwitch Enterprise 8 PoE スイッチ https://jp.store.ui.com/collections/unifi-network-switching/products/switch-enterprise-8-poe\n\nUniFi製品については、このブログでも取り上げています。\n\n「Ubiquiti UniFiの世界」\n「UniFiスイッチ」\n「UniFi Wi-Fiシステム」\n\n公衆回線（5G）公衆回線（5G)においては、iPhoneの実力というよりは公衆回線の環境が色濃く出ると思いますが、どうでしょうか。海外サイトのSpeedSmartでは、5Gの速度テストにおいて、iPhone15 ProはiPhone14 Proよりも24％速いとレポートしています。\n\nSpeedSmart.net https://speedsmart.net/blog/post/2005/iPhone-15-Pro-up-to-24-Faster-5G-Download-Speeds\n\n米国での5G速度は300Mbpsオーバーとの事です。都内の某所（勤務先）で帰宅時に計測してみました。5G(5Gオート）と4Gとそれぞれ切り替えて計測してみます。\n5G\n\n\n4G\n\n\n都心ではまずまずの速度です（5Gでは500Mbps超えると期待していましたが）。ビルの中に入っても100Mbps程度しか落ち込みません。\n最も混雑する時間帯と言われる12時過ぎの状況は以下の通りです。\n5G\n\n\n4G\n\n\n5Gは快適ですが、4Gは少し苦しいですね。やはりお昼時は4Gのユーザーがまだまだ多く速度が落ち込むようです。もちろん、地下鉄では4Gですし、5G網も郊外に行くと4Gに切り替わったり途端に数十Mbps程度まで落ち込みます。また、私の計測した場所は「都内でたまたま計測した場所」ですので、ご参考に留めていただければと思います。\nUSBハブに繋げてみるiPhone15 ProはUSB-Cに対応しました。USB 3.2 Gen2に（USB3.1 Gen2と同義）対応し、10Gbpsの速度が出ます。パッケージに付属してくるUSB-CケーブルはUSB 2.0に対応（480Mbps)との事で高速通信のメリットは活かせません。\n\nApple iPhone 15 の USB-C コネクタで充電および接続する https://support.apple.com/ja-jp/HT213839\n\n「Belkin 7 in 1 USB-C 2.5Gbpsイーサネットハブ」に繋いでみます。\n\n\niPhoneの画面はUSBハブからHDMIで接続されたモニタにも映し出されますし、ネットワーク通信も可能で2.5GbEでの速度が当たり前のように出ます（ハブはUSB-PD電源に接続しています）。\n\n\n念の為、無線を利用しないように機内モードに設定しています。\nスマホの写真をNASに大量にアップロードする時などは、WiFi6Eが速いと言っても、2.5GbEの有線はレイテンシが小さいことによって高速にアップロード可能です。今回、NASにある無駄な写真や動画を一旦削除してスマホから整理済みの全ての写真・動画をSynologyのPhoto Mobileというアプリを使って再アップしたのですが、非常に高速でした。感覚的ですがWiFi6Eの2、3倍といった感じです。アプリの作りにもよりますけれども、写真または動画を1枚単位にアップロードする仕組みのアプリケーションでは、5本も6本ものスレッドで分散してアップロードはしないと思われますのでハードウェアでカバーできる一例でしょうか。こういったケースは今回のようなスマホ入れ替え時など滅多に発生しないケースですが、USB 3.2 Gen2（10GbE）となった事で非常に便利になりました。\n\nBelkin https://www.belkin.com/jp/usb-c-7-in-1マルチポートアダプター/INC009btSGY.html\n\nMacbookに繋げてみるMacbookはテザリングの逆、iOSにネットワーク機能を提供できます。\n\n\n実用性を考えると利用するシチュエーションはなかなか見出せませんが、Macbookが10GbEのネットワークに接続されている環境があれば、iPhone15 Proはさらに高速に通信が可能となります。\n\n\nUSB 3.2 Gen2やネットワークも10Gbpsとなればそれを基準と考え、その他周辺機器ともできるだけ速度差を無くしたいものです。例えばUSBメモリやSDカードはどうでしょうか？昔ながらにOSのセットアップなどに使ってきた経緯がありますが、技術の進歩でSDカードが大容量になったとしても速度とのバランスが悪いのではないでしょうか。今は10GbpsのUSBのSSDケース（M2.2280）が2、3千円で買えますので、廉価となったNVMeのSSDを挿して使うのはいかがでしょうか？USB3.2 Gen2であれば読み込み、書き込み共に10Gbps出ますし、NASのキャッシュ用で使っていた余りなどがあればそれを再利用するのも良いですね。\nApple CarPlayApple CarPlayは既に知られたサービスでiPhone15 Proになったからといって何かが変わるわけではありません。iOS17からはSharePlayという機能が追加され、車の中で搭乗者が（iPhoneを持っていれば）Apple Musicのセッションに参加し、搭乗者の好きな音楽を運転者のiPhoneのCar Playで再生できるようになりました。仕組みとしてはこれまであったAir Playに近いものがありますね。仲間で音楽もシェアする、時代を感じさせるサービスです。Siriの機能と組み合わせてマップの到着予定時刻を家族に共有できます。iPhoneが車載のBluetoothに接続するとiOSの集中モードが自動的に運転モードに変わり通知などを制限できるようにもできます。CarPlayも地道なアプリケーションの改善によってかなり使い勝手の良いシステムとなっています。\n\n個人的にはThunderbolt3ケーブルでiPhoneとカーナビとを繋いでいるという事実が感慨深いものがあります。。。\n画面との距離iPhone15 Proと直接関係ありませんが、iOS17からFaceIDに関連する機能追加として画面との距離があります。これはスマホに顔を近づけすぎると眼精疲労警告のため、画面全体が警告メッセージで覆われるというものです。これは子供の視力悪化対策に有用です。iPadでFaceIDに対応している製品は最新のiPad Proしかない（他はTouchID）ので、iOSのタブレットでこの機能を使いたければ（子供に利用させたければ）iPad Proを購入することになるのでしょうか。。。\n\n","categories":["Hardware","Network"]},{"title":"XG FirewallでIPSのポリシーを確認する","url":"/new-technology/2020/05/04/ips-policy/","content":"この記事で実現すること\nXG FirewallのIPSポリシーは複数存在しますが、それぞれの内容について説明します。\n\n\n\nXGのIPSポリシーについてIntrusion Prevension System(IPS)は侵入防御を意味し、サイバー攻撃から内部のホストを防御します。「XG Firewall v18のルールを作成する」では、IPS Policyの選択として、”lantowan_general”を設定しました。初期セットアップではあまり十分な説明をしていませんでしたので、改めて中身を説明します。XGのIPSポリシーは、左ペインメニューの侵入防御のIPSポリシーから確認できます。デフォルトで登録されているものには、以下の内容があります。\n\nDMZ TO LAN\nDMZ TO WAN\nLAN TO DMZ\nLAN TO WAN\nWAN TO DMZ\nWAN TO LAN\ndmzpolicy\ngeneralpolicy\nlantowan general\nlantowan strict\n\n前半の6つはそれぞれの接続形態に合わせたポリシーです。LAN TO WANでは、ブラウザやアプリからインターネットに接続する場合の攻撃を想定した防御ポリシーとなっています。XGの左ペインメニューの侵入防御からIPSポリシーを選択し、さらに”LAN TO WAN”を選択すると、以下の画面が表示されます。\n\n\nこのポリシーは、カテゴリ、重要度、プラットフォーム、対象というそれぞれのメニューに分かれています。これはブラウザなどのクライアントを対象として、WindowsやLinuxのクライアントOSが確認できます。macOSはありませんが、実際に”All Client”として組み込まれているようです。このポリシーはどのような意図で作成されたのかは不明です。なぜWindowsとLinuxだけを切り出しているのでしょうか。さらに、前半6つの”DMZ TO LAN”〜”WAN TO LAN”ポリシーはカスタマイズ出来ません。”dmzpolicy”〜”lantowan strict”の4つのポリシーの中身はフィルタの種類の名前が異なっていますが、7126個あるXGのIPSポリシーが全て選択されており、4つのポリシーの中身は全く同じで何を選んでも変わりません。昔からカスタマイズ前提で用意されており、明確な違いは無いというのが実態のようです。\n明らかに不要なポリシーを外せばパフォーマンスアップするという期待がありますが、XGでは既にパフォーマンス上工夫されていて、ポリシーを絞ったとしても殆ど効果はありません。XG v18の”Xstream Network Flow Fast Path”というトラフィック検査の高速化が功を奏しているのかもしれません。\nXGのIPSはオープンソースのセキュリティソフトであるSnortを使っているようです。私の検証では、下手にポリシーを絞り込むとかえってパフォーマンスが出なくなるように見えます（何10回も繰り返し統計をとったわけではありません）。”lantowan general”などの絞り込まないポリシーで全く不都合がないため、このままフィルターせずに利用しています。\n脆弱性をXGで防御すること話は変わりますが、Webサーバーのシェアは2017年に過半数を占めていたApacheは2021年10月には31.0％までシェアを落としています。代わりに高速性が売りのnginxが、足元33.9%でシェア1位を獲得しています。\n\nHistorical quarterly trends in the usage statistics of web servers https://w3techs.com/technologies/history_overview/web_server/ms/q\n\n「パッチが多いのでアパッチ」と揶揄される事もありますが、XGのIPSにも253個のアパッチ用ポリシーがあります。一方、nginxは、まだ歴史が浅いという事もありますが、XGのポリシーを検索してみると2つしか見つかりません。全ての製品の脆弱性をXGがカバー出来るかといえば難しく、やはり利用しているプロダクトの製品パッチを適用するのが本筋です。\n再びホームユーザーとしての話に戻すと、原則、Windows10やmacOS、スマホは脆弱性に対するパッチとして自動更新の機能があるので、それを行うのが確実です。むしろ危ないのは自動更新にしていないOSや、IoT機器・無線ルーター・NAS・家電などです。昨今、数多くの脆弱性が発見され、パッチが出ている現況においては、IPSに全ての製品の脆弱性の保護を頼るのは厳しいと考えます。きちんとベンダーからの通知システムを活用し、適切なパッチを適用する事が何よりも重要です。私はIT機器やソフトウェアを導入する場合には、こういったパッチが迅速に提供されるもの、また自動更新や通知の仕組みがあるものを選定するようにしています。そういう意味では、XGのIPSはあくまで補助的に使い、日常ログの確認も併せて行いたいところです。\nXGのIPSはこれだけにの機能に限らず、レイヤ7のファイアウォール機能として立派に役目を果たしてくれます。怪しいサイトに接続しない事は本人の心がけも重要ですが、XGである程度そういったサイトを遠ざける事も出来ます。2要素認証のように、面倒ではありますが複数の管理策を重ねる事と、日頃のログの確認や情報をウォッチする事が防御を高める事になります。\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"IPv6のUnique Local Addressを生成する","url":"/new-technology/2020/04/18/ipv6/","content":"この記事で実現すること\nプライベートなIPv6アドレスを利用するため、機器のMACアドレスを用いて、Unique Local Address（ULA）を生成します。\n\n\n\nIPv6 Unique Local Address（ULA)についてIPv6はその広大なアドレス空間により、NATを必要としません。ホームユーザー向けのインターネットサービスにおいても、多くのプロバイダでパブリックIPv6が振られ、NAT変換無しでインターネットに接続できます。ただしホームユーザー環境においての実運用としては、パブリックIPアドレスが変わった場合に宅内のIPアドレスも変更しなければならず、内側のホスト間通信の運用が困難になります。Firewallなど内部ホストを管理する必要のあるネットワークでは、IPv4のプライベートIPに近い考えであるIPv6のULAを使い、インターネットに対してはNAT変換することが考えられます。厳密には、ULA≠プライベートIPアドレスなので、外部のサイトとは重複しないアドレスを利用する事が求められます。\nULAは、MACアドレスと時刻からおおよそ一意となるIPv6アドレスを作成することが可能となります。アドレスは、fd00::/8から始まる48ビットのプリフィックス（prefix）を持ちます。従い、fdxx:xxxx:xxxx::/48のプリフィックスに加え、0000〜ffffまでのサブネットの範囲を持ちます。\nfdxx:xxxx:xxxx:0000::/64 - fdxx:xxxx:xxxx:ffff::/64\nIPv6 ULAの生成を行うULAを求めるPythonプログラムを私の方で用意し、JDoodleに配置しています。JDoodleでPythonプログラムを実行できます。JDoodleは、教育用としてプログラムソースコードを登録すると、プログラムが実行できる機能を提供しています。[1]\n最初にIPv6を割り振りたいホストのMACアドレスを調べておいてください。算出時にMACアドレスを入力するので、XX:XX:XX:XX:XX:XXまたはXX-XX-XX-XX-XX-XXと表示されているMACアドレスを予めコピーしてください。大文字小文字はどちらでも構いません。また、仮想環境でサーバーなどを構築されている場合は仮想MACアドレスではなく、物理MACアドレスを採用される事をお勧めします。\n\nJDoodle -ULA Generator- https://www.jdoodle.com/a/20tR\n\n\n\n\n入力エリア　Stdin Inputs\n実行ボタン　▶︎Execute\n実行結果　Result\n\n\nStdin Inputsに入力します。MACアドレスを貼り付け、▶︎Executeボタンをクリックしてください。\n\nResultに、以下の4つの項目が表示されます。これらがプライベート環境で利用するユニークなIPv6アドレスです。MACアドレスが正しく入力されなかった場合は、\"Bad MAC Adderss\"と表示されます。\n\nIPv6 ULAのプログラムについて\nRFC4193に基づき生成しています\nMACアドレスからModified EUI-64を生成するにあたり、RFC4291に基づき生成しています\n本来はNTPを利用してハッシュキーの一部に利用しますが、通信は行わずホストの時間を取得し、NTP時刻に変換しています\nNTPは64ビットのデータ型となっており、2036年にオーバーフローします。しかし、RFC4330で定義されているように再び0から開始し、正しく動く処理をしています\nJDoodleサイトは2021年10月17日時点でCookieを求められます。\nソースコードはGitHubのリポジトリにあります。\n\n https://github.com/yoshi0808/ula-generator\n[1]JDoodleの利用規約などを探してみましたが見つかりませんでした。学生向けに教育用としての利用を想定されているようです。このブログの目的から鑑み、利用目的が逸脱している事は無いと考え、利用させていただいております。\n","categories":["Network"],"tags":["XG Firewall","IPv6"]},{"title":"IPv6のULAをIPv4より優先する","url":"/new-technology/2021/06/26/ipv6-first/","content":"\nこの記事で実現すること\n\nFirewallなどルーターの内側（LAN）がユニークローカルアドレス（ULA）となるネットワーク構成、かつ、NATでインターネットに接続しているIPv4、IPv6のデュアルスタック環境では通常IPv4が優先されます。クライアント側のWindowsおよびLinuxではシステム設定変更を行う事でULA環境下でもIPv6を優先させる事ができます。\n\n\nIPv4を優先するULA現時点でIPv6&#x2F;IPv4の優先度を確認する方法の1つは、The KAME projectにブラウザでアクセスし、亀が踊っていればIPv6接続、動かなければIPv4接続という事になります。プロバイダのWebサイトの右上に「IPv6（IPv4）で接続しています」との記載も見かけます。\n\nThe KAME project http://www.kame.net\n\nブラウザやOSがIPv6優先であっても、ULAそのものはインターネットにルーティングしないという大前提があります。IPv6において、NATは一般的に推奨されない構成でもあります。\nOSの設定を変更することで、ULAを使いながらIPv6優先に変更できます。\nIPv6優先設定IPv6やIPv4の通信優先度を決定するPrefixポリシーというものがあり、これをIPv6優先にします。ネットワークのグループ（Prefix）毎に優先度を決めます。Windows、Linuxで設定は異なりますが、概念は同じです。残念ながらmacOS（Catalina）やスマホについては、この設定を見つける事ができませんでした。\nPrefixポリシーの説明Windowsの場合、このPrefixポリシーを表示させると以下の表示がされます。\nC:\\&gt; netsh interface ipv6 show prefixpolicies優先順位   ラベル  プレフィックス----------  -----  --------------------------------        50      0  ::ffff:0:0/96        40      1  ::1/128        30      2  ::/0        20      3  2002::/16         5      5  2001::/32         3     13  fc00::/7         1     11  fec0::/10         1     12  3ffe::/16         1      4  ::/96\n\n各プレフィックスの説明は以下の通りです。\n\n\n\n\nPrefix\n説明\n\n\n\n::1&#x2F;128\nLoopback\n\n\n::&#x2F;0\nグローバルスコープ\n\n\n2002::&#x2F;16\n6to4\n\n\n::&#x2F;96\nIPv4互換アドレス（廃止）\n\n\n::ffff:0:0&#x2F;96\nIPv4マップドアドレス\n\n\nfec0::&#x2F;10\nサイトローカルアドレス（廃止）\n\n\nfc00::&#x2F;7\nユニークローカルアドレス\n\n\n2001:0::&#x2F;32\nTeredo\n\n\n\nIPv4マップドアドレスは、IPv6の世界でIPv4を表現したものです。具体的には、::ffff:192.168.0.1という形となり、IPv6アドレスの前半64ビットは0、65〜96ビットの32ビットがffff、97ビット〜128ビットの32ビットがIPv4アドレスとなります。“グローバルスコープ”は、0ビットのマスクなので全てのアドレスにマッチします。インターネットのIPv6アドレスであるグローバルユニキャストアドレス（GUA）は2000::/3ですが、このPrefixポリシー上ではグローバルスコープが該当します。fc00::/7はおなじみULAです。\n設定のポイントは2箇所です。\n\n優先度は数字が大きいものほど優先度が高く、IPv6 Loopback → ULA → グローバルスコープ → IPv4マップドアドレスの順に並べます\nULAからインターネット宛（GUA）にルーティングを認めるために、ネットワーク単位に割り振られているラベルについてULAとグローバルスコープのラベルを同じ数字にします\n\nWindows10\nコマンドプロンプトを管理者権限で実行します。\n出力結果は環境によって異なりますが、概ね以下のように出力されます。\n\n C:\\&gt;netsh interface ipv6 show prefixpoliciesアクティブ状態を照会しています...優先順位   ラベル  プレフィックス----------  -----  --------------------------------        50      0  ::ffff:0:0/96        40      1  ::1/128        30      2  ::/0        20      3  2002::/16         5      5  2001::/32         3     13  fc00::/7         1     11  fec0::/10         1     12  3ffe::/16         1      4  ::/96\n\n\nIPv6(::&#x2F;0、fc00::&#x2F;7) &gt; IPv4(::ffff:0:0&#x2F;96)となるよう、管理者権限で以下のコマンドを1行づつ投入します。\n\n netsh interface ipv6 set prefixpolicy ::ffff:0:0/96 25 0netsh interface ipv6 set prefixpolicy ::1/128 40 1netsh interface ipv6 set prefixpolicy ::/0 30 2netsh interface ipv6 set prefixpolicy 2002::/16 20 3netsh interface ipv6 set prefixpolicy 2001::/32 5 5netsh interface ipv6 set prefixpolicy fc00::/7 35 2netsh interface ipv6 set prefixpolicy fec0::/10 1 11netsh interface ipv6 set prefixpolicy 3ffe::/16 1 12netsh interface ipv6 set prefixpolicy ::/96 1 4\n 表示されるラベルおよび優先度は環境によって異なる場合があります。\n\n\n\n設定内容を改めて確認します。\n\n\n\nこれで設定完了です。OSを再起動して設定が変わっていない事、IPv6が優先されている事を確認してください。設定をやり直す場合は、PrefixPolicyをリセットしてからOSを再起動します。\nnetsh interface ipv6 reset\nLinux(ubuntu)Linux（ubuntu）の場合は、/etc/gai.confに設定ファイルがあります。\n\nviなどでファイルを開きます。sudo vi /etc/gai.con\nファイルの中身は全てコメントアウトされています。plefixpolicyは以下の通りです。\n\n label   &lt;mask&gt;   &lt;value&gt;#    Add another rule to the RFC 3484 label table.  See section 2.1 in#    RFC 3484.  The default is:##label ::1/128       0#label ::/0          1#label 2002::/16     2#label ::/96         3#label ::ffff:0:0/96 4#label fec0::/10     5#label fc00::/7      6#label 2001:0::/32   7\n つまり、コメントされた状態がデフォルト設定であり、カスタマイズが必要な場合はコメントを外して対応できるようになっています。3. 上記の8行あるplefixpolicyについてすべてのコメントを外し、ULAfc00::/7のラベル6を::/0のラベルである1に修正します。4. 続いて、このファイルのさらに下を見ていくと優先度の項目が並びます。 #precedence  ::1/128       50#precedence  ::/0          40#precedence  2002::/16     30#precedence ::/96          20#precedence ::ffff:0:0/96  10 ネットワーク（Prefix）毎に優先度を決めています。Windowsと設定する項目の意味は同じです。5. 上記5行のprecedendeのコメントを外し、ULAのリストを加えます。Loopback→→ULA→::/0→IPv4の並びにします。修正後は以下になります。 label ::1/128       0label ::/0          1label fc00::/7      1label 2002::/16     2label ::/96         3label ::ffff:0:0/96 4label fec0::/10     5label 2001:0::/32   7precedence  ::1/128       50precedence  fc00::/7      45precedence  ::/0          40precedence  2002::/16     30precedence ::/96          20precedence ::ffff:0:0/96  10\n\nファイルを保存し、OSを再起動します。\n\n以上でIPv6が優先となります &#x1f422;\nなお、LinuxでmDNS（Bonjour）が使える環境にあり、LANにおける名前解決がIPv4指定となっている場合は、/etc/nsswitch.confを修正する事でIPv6対応に変更可能です。LAN内の端末をIPv6で明示的に指定することはあまりないのでここは参考程度に留めておいてください。\n# 以下の行をコメントアウトします#hosts:          files mdns4_minimal [NOTFOUND=return] dns# 代わりに以下の行を追加しますhosts:          files mdns_minimal [NOTFOUND=return] dns\n\ngetaddrinfo()送信元IPアドレスと送信先アドレスでPolicyによってどのネットワークを使うかは、RFC6724で詳細が記載されています。\n\nhttps://datatracker.ietf.org/doc/html/rfc6724\n\n多くのアプリケーションは、getaddrinfo()という関数を使い、URLから名前解決されるとともに、プレフィックスポリシーを踏まえてIPv4またはIPv6の優先度が決定されます。nslookupでgoogle.comを見てみます。\n$ nslookup google.com.Server:\t\t127.0.0.53Address:\t127.0.0.53#53Non-authoritative answer:Name:\tgoogle.comAddress: 172.217.xxx.110Name:\tgoogle.comAddress: 2404:6800:4004:xxxx::200e\n\n上記のようにIPv4とIPv6のアドレスが両方定義されています。getaddrinfo()はpythonのインタラクティブシェルで確認できます。以下はIPv6が優先のケースです。\n&gt;&gt;&gt; import socket&gt;&gt;&gt; socket.getaddrinfo(&quot;google.com&quot;, 80, proto=socket.IPPROTO_TCP)[(&lt;AddressFamily.AF_INET6: 10&gt;, &lt;SocketKind.SOCK_STREAM: 1&gt;, 6, &#x27;&#x27;, (&#x27;2404:6800:4004:xxxx::200e&#x27;, 80, 0, 0)), (&lt;AddressFamily.AF_INET: 2&gt;, &lt;SocketKind.SOCK_STREAM: 1&gt;, 6, &#x27;&#x27;, (&#x27;172.217.xxx.110&#x27;, 80))]\n1-2行目で関数を呼び出し、3行目の関数の出力はタプル（List形式）で2要素あります。0番目の要素にIPv6アドレスが入り、1番目の要素にIPv4アドレスがあります。PrefixPolicyをIPv4優先に変更した場合は、このレスポンスの順番が入れ替わります。macOSでは0番目の要素にIPv4アドレスを返します。\n&gt;&gt;&gt; import socket&gt;&gt;&gt; socket.getaddrinfo(&quot;google.com&quot;, 80, proto=socket.IPPROTO_TCP)[(&lt;AddressFamily.AF_INET: 2&gt;, &lt;SocketKind.SOCK_STREAM: 1&gt;, 6, &#x27;&#x27;, (&#x27;172.217.xxx.238&#x27;, 80)), (&lt;AddressFamily.AF_INET6: 30&gt;, &lt;SocketKind.SOCK_STREAM: 1&gt;, 6, &#x27;&#x27;, (&#x27;2404:6800:4004:XXXX::200e&#x27;, 80, 0, 0))]\nRFC6724を読んでいると色々な設定が見られます。例えば以下のようにIPv6のリンクローカルアドレスの優先度をグローバルよりも下げてしまうなどです。\n\n10.4.  Configuring Preference for Link-Local AddressesThe destination address selection rules give preference to destinations of smaller scope.For example,a link-local destination will be sorted before a global scope destination when the two are otherwise equally suitable.An administrator can change the policy table to reverse this preference and sort global destinations before link-local destinations:\n\n\n宛先アドレス選択ルールは、スコープの小さい宛先が優先されます。 例えば、リンクローカルな宛先は、グローバルな宛先と同等に適している場合にグローバルな宛先よりも優先されます。管理者はポリシーテーブルの優先順位を逆転させることで、リンクローカルな宛先よりもグローバルな宛先を優先するように変更できます。\n\nPrefix        Precedence Label::1/128               50     0::/0                  40     1::ffff:0:0/96         35     4fe80::/10             33     12002::/16             30     22001::/32              5     5fc00::/7               3    13::/96                  1     3fec0::/10              1    113ffe::/16              1    12\n\n※（補足）スコープの小さい宛先が優先されるというのは、送信先アドレスと送信元アドレスの上位ビットからの一致ビット数によって決定されることでロンゲストマッチアルゴリズムと呼ばれます。fdxx〜のULAアドレスは::/0とfc00::/7とにマッチしますが、優先度が高い::/0にマッチするのではなくて、一致ビット数が多いもの、つまりfc00::/7にマッチします。その上で、getaddrinfo()で有効なネットワークが複数あればそこで初めて優先度について評価されます。\n上記の例は自身のホストにグローバルなIPv6アドレスが振られている事を想定しているはずで、今回のようなULAを使うケースとはまた違うシチュエーションですので、あくまで参考となります。\nHappy EyeballsHappy Eyeballsは、ブラウザに実装されている機能で、IPv6を優先しつつも、IPv4と応答の早い結果を採用するという合理的な仕組みです。Happy EyeballsはRFC6555、Happy Eyeballs ver2については、RFC8305で定義されています。Eyeballsというのはユーザーを意味します。ユーザーにとってハッピーな仕組みという事でしょうか。\n\nRFC6555 https://datatracker.ietf.org/doc/html/rfc6555RFC8305 https://datatracker.ietf.org/doc/html/rfc8305用語解説 https://dictionary.cambridge.org/dictionary/english/eyeballs\n\nLANから挙動を見る限り、IPv6を優先としたOSでの挙動はブラウザからもIPv6が優先されているように見えます。macOSやiPhoneで見る限りは応答の早い方に接続するようです。Test your Happy Eyeballsでは、その挙動を確認できます。\n\nhttp://he.test-ipv6.com\n\n\n\n私の環境ではmacOSが6:4、iOSが7:3でそれぞれIPv4が多く選択されました。このサイトではランダムなホスト名を生成し、そこに毎秒接続確認をする手法を取っているようです。ただし、このサイトに限らずULA環境におけるmacOSでは一度接続した情報がOS上のキャッシュに残ると次からはIPv4に接続します。ネットワークのキャプチャを見ると、名前解決ではAAAAレコードとAレコードとを同時にクエリ要求しますが、キャッシュされた接続先がある場合はIPv6には接続せずIPv4のみ接続開始しています。OS内部ではLinux同様にPrefix管理テーブルがあるものと考えられます。\n”test-ipv6.com”についてIPv4のFirewallルールで拒否する設定をするとエラー無くIPv6で接続されます（macOSのSafariの場合）。\n\n\n可用性としては優れた仕組みですが、IPv4の国別フィルタで意図的に宛先国をブロックする運用をしている場合、IPv6の国別フィルタの機能がFirewallに無ければセキュリティリスクに見えます。ホームユーザーにとってリスク対策のためにIPv6を無効にするまでは無いと考えていますが、こういったブラウザの挙動も頭の片隅に置いておく必要がありそうです。\n","categories":["Network"],"tags":["XG Firewall","IPv6"]},{"title":"L2ネットワークとESXi","url":"/new-technology/2023/04/29/l2-esxi/","content":"\n\nこの記事で実現すること\n\nネットワークの教本といえば、TCP&#x2F;IP、つまりレイヤ3が中心の解説が中心です。ここでは、普段なかなか目にすることのないL2ネットワークの基礎、 ESXiにおけるネットワークの設定について説明するものです。\n\n\nL2ネットワークとIPアドレス個人向けのWi-Fiルーターなどを使い、PCやスマホ、またはNASや仮想環境などを使うようになれば、IPアドレスやDHCP、そして個々の端末が保有するMACアドレスというところは良く目にすることでしょう。Wi-Fiルーターと無線接続する端末だけだと、なかなかL2レイヤは気にすることは無いかもしれません。ネットワークを高度化して、ESXiなどの仮想環境を使い始めると、L2レイヤの知識が必要となってきます。何となくは理解して仮想環境を使われている方が多いかと思いますが、L2スイッチとVLAN、スタンドアロン（無償版）ESXiのvSwitchなどの具体的な設定などを確認していきます。\nスイッチングハブ個人向けに販売されているスイッチングハブといえば、一般的にL2スイッチを指します。TCP&#x2F;IPのルーティングができるL3スイッチもありますが、高額です。L2スイッチも大まかには2種類あり、VLANの設定ができるタイプと、設定が出来ないタイプとの2種類あります。スイッチングハブのネーミングの理由としては、指定されたMACアドレスがあるポートにのみデータを転送する機能を持つものです。昔のハブは電気的に全てのポートにデータを送っており、さらに半二重通信（片方が送信している時は相手側は送信できない。Wi-Fiと同様）でしたが、今のスイッチングハブといえば、全二重で双方向通信が可能であり、複数端末の同時通信でデータ送受信の競合がないようになっています（半二重通信ができる製品もあります）。スイッチングハブではない昔ながらのハブはダムハブやリピーターハブと呼ばれましたが昨今ではむしろその製品を探すのが難しくなっています（ダムハブは隣の端末の通信を傍受できるのでパケットキャプチャとしての使い道はあります）。\nスイッチングハブをタイプ別と特徴で示すと以下の通りです。\n\n\n\nタイプ\n説明\n特徴\n\n\n\nアンマネージ\n電源OnしてLANケーブルを繋いですぐに使える製品。設定画面などは一切ない。\n安価\n\n\nスマートスイッチ\n管理画面があり、VLAN、MACアドレスフィルタやパケットの優先度設定などが可能\n個人向けには少ない\n\n\nマネージド\nVLAN、高度な管理（SNMP、Portミラーリング、コマンドライン）\nやや高額。L2スイッチではスマートスイッチとマネージドとの区別が付けづらくなってきている\n\n\nL3スイッチ\nDHCP機能、ネットワークアドレスを分離し、ルーティングが可能。マネージドスイッチの扱い。\n高額。ネットワークの知識が必要な難解なコマンドライン中心の製品が多い。\n\n\nホームユーザーとしては、こういった情報よりも、10GbEとか2.5GbEなどのポートの速度を優先したり、発熱を気にしてファンレスか否か、ファンがどれだけ静かなのかをポイントにしてスイッチングハブを購入されていることでしょう。単にネットを使うだけであればそれで充分で、普段はL2ネットワークの事を気にする必要はありません。\nリモートワークで家の機器と会社の機器とを分離したい場合、一般的にWi-Fiルーターではゲスト用ネットワーク（ゲスト用SSID）があるので、昔ほどVLANを必要としなくなっています。こういった単にネットを使うだけで何も管理できないスイッチをアンマネージスイッチと呼びます。\nスイッチング能力スイッチの性能の一つにスイッチング能力、別名、スイッチングファブリックというものがあります。比較サイトでも必ずスペックとして出ているものですが、この数値は、基本的に全てのポートが全二重でブロッキングせずにデータを送信できるものとして計算された数値となっています。8Portで全て10GbEなら以下の通りです。\n\n10Gbps×8(Port)×2（全二重）&#x3D; 160Gbps\n\n10GbEが4Port、1GbEが8Portの製品なら、96Gbpsという具合です。ですので、製品を比較して「こちらのハブのスループットが高そうだ」という事にはなりません。\nスマートスイッチ・マネージドスイッチ全く管理画面が無いL2スイッチはIPアドレスを持ちませんが、スマートスイッチ・マネージドスイッチと呼ばれている製品はIPアドレスを持ちます。この”スマート”や”マネージド”というネーミングも実は明確な定義はありません。各社によって呼び名が少しづつ異なっており、はっきり言えばマーケティング用語です。Webの管理画面があってもVLANが無いL2スイッチもあります。\nIPアドレスを持っているとはいえ、スイッチ経由で通信をする際に、ルーターのようにスイッチのIPアドレスを経由する訳ではありません。以下のように見えないPort0番にAmazon Fire Stickをさらに小さくしたような組み込み機器で独立したOSが接続されていて、そこに最低限のネットワーク通信と管理のためのOSの機能を持っていると考えてください。スイッチングハブとしてパケットを転送している機能はハードウェアであるASIC(Application Specific Integrated Circuit)が担っており、この小さな機器は殆ど使われません。最近のWi-Fi機器もこういった形になっており、管理画面の遷移が遅いからといって転送能力が劣っているという訳でもありません。PCなどからスイッチへのpingを打つと、このPort0番に着信して応答を返す仕組みになります（pingの応答速度も一般的に遅いです）。\n\n\n日本では、全くITの知識が無い人向けに分かりやすくスイッチを提供するという事が主眼に置かれているため、アンマネージスイッチが主力製品として販売されていますが、値段なりの品質です。仮想環境やNASなど24時間の運用を前提で考えるのであれば、スイッチにもそれなりの品質を求めるべきです。アンマネージで不具合が出ると回収するしかありません。ファームウェアの更新ができるもの、かつ、きちんと定期的にアップデートが行われている製品を選定されることをお勧めします。\nL2ネットワークとMACアドレスL2スイッチはMACアドレスを宛先として判断し、パケットを目的のポートに転送します。この世界ではIPアドレスはデータの中身として扱われ、宛先として使われることはありません。例えば、以下のPCとL2スイッチとの関係で確認してみます。\n\n\nPC1からPC2にpingを打つこととします。\n\n\nsequenceDiagram\nparticipant pc1 as PC1\nparticipant sw as SWitch\nparticipant pc2 as PC2\n\nNote over pc1: 1.PC2へのpingコマンド投入\npc1 -&gt;&gt; sw : 2.ARP Request(PC2)をブロードキャスト\nNote over sw: 3.PC1のMACを自己学習\nsw -&gt;&gt; pc2 : 4.ARP Requestをブロードキャスト\npc2 --&gt;&gt; sw : 5.ARP Reply(PC2のMAC)\nNote over sw: 6.PC2のMACを自己学習\nsw --&gt;&gt; pc1 : 7.ARP Reply(PC2のMAC)\npc1 -&gt;&gt; sw : 8.ICMP Echo Request\nsw -&gt;&gt; pc2 : 9.ICMP Echo Request\npc2 --&gt;&gt; sw : 10.ICMP Echo Reply\nsw --&gt;&gt; pc1 : 11.ICMP Echo Reply\nNote over pc1: 12.ping応答\n\n\n\nこのシーケンスの実行の結果は以下の通りです。\nPC1のarpテーブルは以下になります(Windowsでの実行を想定)\nC:\\Users\\yoshi&gt;arp -aインターフェイス: 192.168.100.129 --- 0x10 インターネット アドレス 物理アドレス           種類  192.168.100.161       04-69-f8-aa-bb-cc      動的  255.255.255.255       ff-ff-ff-ff-ff-ff     静的\n\nPC2のARPテーブルは以下になります(macOSでの実行を想定)\n$ arp -a? (192.168.100.129) at 30:59:b7:00:11::22 on en0 ifscope [ethernet]\n\nそして、スイッチ上のMACアドレステーブルは、MACアドレスと接続されているPortの組み合わせが登録されています（ここではUbiquiti社のPro Aggregationスイッチを使っています。各社、機種毎に取得方法は異なります）。\n(UBNT) &gt;show mac-addr-tableVLAN ID  MAC Address         Interface              IfIndex  Status-------  ------------------  ---------------------  -------  ------------1        30:59:B7:00:11:22   0/1                    1        Learned1        04:69:F8:AA:BB:CC   0/28                   28       Learned\n\nVLANはデフォルトVLANが1の製品が大半です。MACアドレステーブルにはVLANのIDが必要ですが、詳細説明は割愛します（機種により実装の違いがあります）。\nさて、このようにして、PC同士はL3レイヤ（IPアドレス）からL2レイヤ（MACアドレス）への変換の情報をお互いに持ち、スイッチはMACアドレスとそれがどのPortに接続されているかを管理しています。\nスイッチ自身に管理画面がないと、スイッチの中身がどうなっているか分からないんですが、アンマネージスイッチでは管理IPアドレスを持たないだけで、しっかりとMACアドレステーブルの管理は行われています。\nちなみに、MACアドレスは6バイトでコロン区切りかハイフン区切りとなっています。先頭の3バイトがVendorIDとなっていて、上記の例だと、30:59:B7はMicrosoft社であり、04:69:F8はApple社になります。\nご自身のPCでもarp -aを実行してみてください。LANにあるさまざまな端末のIPアドレスとMACアドレスの一覧が確認できるはずです。\n\nUbiquiti Switch Pro Aggregation https://jp.store.ui.com/collections/unifi-network-switching/products/unifi-switch-aggregation-pro\n\nESXiのL2ネットワークここではVSphere Hypervisor（無償版ESXi）についての説明になります。ESXiは仮想環境として端末を動作させる機能とvSwitchという仮想ネットワークスイッチの機能を持っています。実際は1つのネットワークカードに対して、複数の仮想マシンを動作させることが可能となっています。\n仮想マシンのNIC仮想マシンの構成としての一例を挙げます。\n\n\nこの仮想マシンはUbuntuで、1つの仮想ネットワークアダプタを持っています。最もシンプルな構成です。MACアドレスの先頭3バイトは00:0c:29となっており、これはVMwareのVenderIDです。下位3バイトは仮想マシンの構成時に自動的に振られます。\n続いて、仮想ネットワークスイッチの説明です。\n\n\nこの例では仮想スイッチ1つに物理アダプタを1つ加えています。ESXi本体のハードウェアに付属するネットワークカードが物理アダプタです。\n\n\nこの物理アダプタには当然ですが物理MACアドレスがあります。仮想ネットワークアダプタに到達するためには、この物理アダプタを経由する必要があります。しかし、ESXiのネットワークドライバのレベルで仮想ネットワークアダプタがNICの物理デバイスと接続されており、物理ネットワークアダプタ80:61:5f:xx:xx:xxは使わず、仮想MACアドレス00:0c:29:4f:2e:05が仮想マシンに接続されています。80:61:5f:xx:xx:xxは使われていないと書きましたが、ESXiを構成すると、vmnic0の物理MACアドレスはESXiのVMKernelのvmk0に使われるようになっています。ESXiの世界ではネットワークの障害時の切り替えなども考慮し、物理MACアドレスはあまり重要ではありません。\n過去の技術ですが、物理MACアドレスがデータを受け取って仮想MACアドレスに変換して受け渡す、いわゆるNATの技術も実際には存在します。しかし、今のESXiでは物理NICから実際の仮想MACアドレスのデータが流れていきます。\n一例として、私の保有しているスイッチでPort19のESXiの物理NICとESXiの仮想MACアドレステーブルを表示させると以下のようになっています。（物理MACアドレスの値と一部のVLANの値は修正しています）前述したように、先頭３バイトが00:0C:29のものが仮想マシンです。\n (UBNT) #show mac-addr-table | include Interface|00:0C:29|80:61:5FVLAN ID  MAC Address         Interface              IfIndex  Status200      00:0C:29:4F:2E:05   0/19                   19       Learned200      00:0C:29:C8:1F:97   0/19                   19       Learned200      80:61:5F:00:00:03   0/19                   19       Learned\n\nVLAN200の２つの仮想マシンが存在している事が分かります、スイッチはこのようにして仮想マシンのMACアドレス１つ１つを管理し、適切なスイッチポートに転送していることがわかります。\nちなみに物理スイッチを多段接続した場合にも、1つのポートから先のスイッチ経由で複数の端末が接続されていれば同様に1つのポートに複数の端末のMACアドレスがテーブルに管理されます。\nvSwitchvSwitchでは物理NICを経由して仮想マシンと接続するためのポートグループが必要です。仮想マシンにネットワークアダプタを加える時にはこのポートグループが必要です。ESXiのセットアップ完了後は、vSwitch0  がデフォルトのvSwitchとして作成されており、ポートグループとして、Management NetworkおよびVM Networkの2つが作成されています。\n\n\nManagement Networkは、ESXiのWebにログインしたり制御のためのポートグループです。このグループの中にデフォルトでVMKernel NICとしてvmk0が自動作成されています。VMKernel NICはESXiのWebサービスを始めとする管理系のサービス提供のためのIPアドレスを持ちます。前述したL2スイッチの説明ではPort0として小さな組み込み機器としてOSが稼働していると表現しましたが、それと目的は同じです。VMKernelはvSwitchを制御するというよりは、ネットワークセグメント単位に持ち、ESXiを管理するためのIPアドレスとなります。\n\nVM Networkもポートグループです。仮想マシンが何もない初期状態では特に仮想IPアドレスも保有していません。仮想マシンを作成し、ネットワークアダプタを追加する際に、このVM Networkを選択することになります。そうすると自動的に仮想IPアドレスが振られます。もちろん、新規にポートグループを作成し、仮想マシンにネットワークアダプタを追加する事もできます。また、ポートグループという”グループ”の意味としては、複数の仮想マシンを同一のポートグループに追加できます。この際、MACアドレスが同じになったりはしません。\n\nポートグループ1つで複数の仮想NICと接続できます。仮想マシン作成時、仮想MACアドレスは自動的に割り当てられます。物理NICを2つ以上保有する場合、障害対策と負荷分散ができます。負荷分散の際、ESXiのデフォルトでは、ポートグループ単位に複数の物理NICを使い負荷分散をします。\n\n\nManagement NetworkとVM Networkのポートグループが分かれているのは、本来、マネジメントネットワークとクライアントやサーバーがある仮想マシンのネットワークとは分離すべきという考えに基づいています。\n\n\nなお、仮想マシンをバックアップから戻した場合には、既存の仮想マシンと同一のMACアドレスで復元してしまうと通信が正しく行えなくなります。従って、仮想マシンの復元後、初期起動時には以下のダイアログが表示され、コピーしましたを選択すると、新しい仮想MACアドレスが割り当てられます。\n\n\n特殊な設定vSwitchには以下の2つの特殊な仮想マシンのための追加設定ができます。\n\n\n\n無差別モードを許可\n ファイアウォールやIPS&#x2F;IDS（Intrusion Prevention System&#x2F;Intrusion Detection System）などセキュリティ製品におけるブリッジモードのように、同一LAN内でパケットの検証をする際にはこれをはいに変更します。セキュリティ製品の先に接続されている端末も同一のL2ネットワークとして全てパケットを転送してあげる動作です。自分宛のMACアドレスでなくとも受け取る挙動であり、仮想マシンはダムハブに見えるわけです。また、仮想マシンのネットワークキャプチャを行う場合に使えます。\n\n偽装転送を許可/MAC変更を許可\n 上記と同じようにセキュリティ製品（ゲートウェイ）がバックヤードにある端末のパケットを相互にやりとりするわけですから、自分自身のMACアドレスではないMACアドレスを持ったデータを送信する事になります。一般的にはセキュリティ上認めていないものですが、セキュリティ製品ではMAC変更を許可をはいを、偽装転送を許可をはいにします。\n\n\nこれらはいずれもセキュリティ強化のためにデフォルトではいいえになっています。これらの機能の詳細はVMwareの以下のドキュメントを参照してください。\n\nvSphere 標準スイッチのセキュリティ強化 https://docs.vmware.com/jp/VMware-vSphere/7.0/com.vmware.vsphere.security.doc/GUID-3507432E-AFEA-4B6B-B404-17A020575358.html\n\nESXiのVLAN無償版ESXiではVLAN設定が可能です。ESXiにおけるデフォルトVLAN（タグ無し）はVLAN ID＝0となります。通常のスイッチはVLAND ID＝1のものが多いのですが、基本的にタグ無し同士の通信であれば問題になりません。デフォルトVLANを変更し、さらにそれをネイティブVLAN（タグ無し）にする時は少し考える必要がありますが、ホームユーザー向けではそこまで考えることも無いでしょう。\n\n\n\nESXiのVLANのタイプ\n説明\n\n\n\nEST\n通常のタグ無し。物理スイッチのアクセスポートに接続する場合でスイッチ側でタグが外される事を期待。\n\n\nVST\nタグ付き（1〜4094）。物理スイッチからタグ付きで接続する場合。\n\n\nVGT\nタグ付き（4095）。仮想マシンに複数のタグ付きパケットを流す場合\n\n\n3種類それぞれのネーミングがあります。\nEST（タグ無し）はVLANを意識しないモードです。タグ無しでvSwitchのポートグループに渡されることを期待している設定です。物理スイッチがアクセスポートの場合は、タグが外されるのでvSwtichおよびポートグループでは特に何もしませんし、仮想マシンでも何も意識しません。\nVSTは、VLAN IDをポートグループに設定します。例えば、ESXiのマネジメントネットワークはタグ無し、仮想マシンはユーザー側ネットワークとする場合にvSwitchで2つのセグメントのデータを受け入れ、VMKernelはタグ無しのまま、仮想マシンはポートグループでIDに200を指定します。この場合はVLAN200について、vSwitchでタグが外され仮想マシンにパケットが届きますので仮想マシンでVLANの意識はしません。\nVGTは物理スイッチにおけるトランクポートの役割と同等です。ポートグループに4095を設定します。仮想マシン自身がタグVLANを解釈できる場合に複数のVLANのタグ付きパケットを流し、仮想マシン側でタグを外すような使い方となります。また、VSTではESXiの仕様として1〜4094とありますが、一般的にタグありのVLANは2〜1005の間で作成しますし、個人向け環境のVLANはネットワークアドレスの第3オクテットの数字と合わせるのが無難です。192.168.xxx.0/24全てのVLANデータが流れて不要なものは仮想マシン側で破棄する事になるので負荷が高くなりやすく、物理スイッチからは必要なVLANのみのデータを流すことが求められます。\n\n\nVSTの例ですが、Win10ProのVLAN IDを300とすると、ポートグループの設定でVLANの値を明示します。\n\n\nこのvSwitchの例で言えば、タグ300のパケットは、VGT（ID&#x3D;4095）、300と明示した2つの仮想マシンのみに転送されます。VLAN ID0のVM NetworkおよびManagement Networkにはタグ300のパケットは流れません。\nこのように、vmnic0に接続されたvSwitchネットワークはvmk0のIPネットワークが192.168.1.0/24だとすれば、全ての仮想マシンが192.168.1.0/24のIPアドレスを持つのがシンプルな構成ですが、このようにタグVLANを組み合わせることで、物理NICの数が少なくても複数のVLAN、つまり複数のネットワークセグメントのデータを通すことができます。\nVGTの場合は、物理スイッチ側のMACアドレステーブルは以下のようになっています。仮想マシン自体がVLANのトランクポートを扱えるため、１つのMACアドレスに複数のVLANが割り当てられている事が分かります。\nVLAN ID  MAC Address         Interface              IfIndex  Status1        00:0C:29:EB:B3:CC   0/15                   15       Learned200      00:0C:29:EB:B3:CC   0/15                   15       Learned300      00:0C:29:EB:B3:CC   0/15                   15       Learned4040     00:0C:29:EB:B3:CC   0/15                   15       Learned\n\nESXiのVLANタグについては以下のドキュメントを参照してください。英語ですが3つのVLANについての解説ビデオもあります。\n\nVMware VLAN 構成 https://docs.vmware.com/jp/VMware-vSphere/7.0/com.vmware.vsphere.networking.doc/GUID-7225A28C-DAAB-4E90-AE8C-795A755FBE27.html?hWord=N4IghgNiBcIBwAYBMA6AjARRAXyA\n\n","categories":["Network"],"tags":["ESXi"]},{"title":"MIスマートバンド5を活用する","url":"/new-technology/2020/11/28/miband5/","content":"\n\nMIスマートバンド5(MI band5)で健康になる「健康になる」とは言うものの、多くの人の一番の興味はダイエットではないでしょうか。MIスマートバンド5は、中国の小米（シャオミ）から2020年10月に日本で発表されたスマートウォッチです。実売価格は4,000円前後からとリーズナブルで、小型で軽量、とても多機能です。特にリモートワークが増え、運動不足が気になる人にはまずは試していただきたいスマートウォッチです。ウォーキングやランニングをはじめ、11種類のワークアウトに対応しており、継続的に利用する気にさせる優れたデバイスです。現時点で日本語版として流通している製品はあるようですが（こちらの価格は5,000円前後）、正式に日本で発売されたという情報は見当たりません。日本語版・中国語版・グローバル版の3種類が存在するようです。グローバル版は、技適の認証を受けており、日本国内で利用可能です。MI band本体の操作メニューは英語であるものの、スマホからの通知メッセージなどは日本語表示が可能となっています。また、時計機能以外の操作はMI Fitと呼ばれるスマホアプリで操作します。アプリは完全に日本語となっており、操作に困る事はありません。\n\n\nこの記事は2020年のものであり、MI bandの最新版は2022年4月時点でMI band6となっています。スマートバンドを管理するスマホアプリも当時とは名称が変わっていますのでアプリの使い方などは「MIスマートバンド6を活用する」の記事を参照してください。\n\n\n\nMI band 5の特徴（抜粋）\n\n\n活動指数（PAI）の管理\nストレスモニタリング\n心拍数モニタリング\n睡眠モニタリング\n電話、メール、SMSなどの通知機能（スマホ連動）\n音楽再生（スマホ連動）\n11種類のワークアウトの記録\n14日間のバッテリー持ち\n50m防水\n軽量11.9g\n\nMI band5の活用リモートワークの機会が増え、時計をする機会が減った方も多いのではないでしょうか。様々なスマートウォッチがありますが、私が利用したいスマートウォッチは頻繁に充電を必要としないもので、歩数や運動した記録を残すものでした。なお、スマートウォッチ単体で音楽を聴きたい、電子決済で買い物したいというニーズも多いでしょうがMI bandにはその機能はありません。※中国版ではNFCの機能はありますが、グローバル版にはありません。その他機能紹介はシャオミのWebサイトなどでご確認いただき、健康に重きを置くユーザーの視点として使い勝手および活用の紹介をしていきます。スマホアプリのMi FitはiOS、Androidに対応しています。\n・ダイエットしたい・アスリートではないが、手軽に活動量計として記録したい・運動不足を解消する目安を知りたい・睡眠の状況を客観的に把握したい\n体を動かす事を習慣に密室を避ける意味でジムにも通いづらくなり、外でウォーキングやランニングをする事になるのか、最近はウォーキング、ランニングしている人を多く見かけるようになりました。スマホアプリをインストールして使う事になりますが、GPSの記録に拘らない場合は、常にスマホと一緒に持ち歩く必要はありません。小型で非常に軽いため、手首に付けている事が殆ど気になりません。わざわざワークアウトの開始を宣言せずとも記録を続けてくれる、着けている事を忘れさせてくれる、そんなデバイスです。私はグローバル版を8月くらいにネットで購入し、継続して使っています。\nMI FitアプリMI bandを最初に使う時はMI Fitアプリをインストールしてから、スマホとbluetoothでペアリングし、アカウントを作成します。MI Fitを起動した画面は以下になります。\n\n\nMI bandの設定ですが、2週間弱程度での充電を許容される方は、心拍数モニタリングは最も頻度の高い「自動心拍数モニタリングと睡眠アシスタント」を選んでください。また、モニタリング頻度も1分に設定します。もう少し電池持ちを良くするためにはモニタリング頻度を落とす事になります。\n最初の画面の表示内容はカスタマイズできますが、歩数、PAI、睡眠記録、心拍数と続きます。この日（前日の金曜日）はリモートワークでしたが、ほんと動かないですね。1日でたったの1,012歩。これではやっぱり不健康ですし、太ります。そのくせ10時間も寝てるという。通勤時間も無くなれば多く寝てしまいますよね。\nPAI(パーソナルアクティビティインテリジェンス）MI bandには活動に反応して活動量を計測し指数化してくれる機能があります。心拍数を計測し活動量が増加すると、心拍モニタの頻度が上昇し、心拍数を細かく記録していきます。PAIは7日間の合計でスコアリングされます。これを100以上に保つ事で健康が維持されるとの事です。ロジックは公開されていませんが、年齢・性別・安静時心拍数・過去7日間の心拍数に基づきPAIスコアが計算されます。強度が低いウォーキングであれば加算される数字は小さいですし、強度の高い運動であれば数字は大きくなります。1週間前のデータは無効となるため、継続的な運動が必要です。1日全く活動しなくても構いませんが、数字はどんどん減っていきます。この数字を見ながら活動する事である程度の運動強度を意識し、PAIを100以上にし続ける事が推奨されています。このPAIは心疾患の予防の観点が主ですが、ダイエット目的にも活用できます。\nPAIはその人固有の状況に合わせて管理されるので、その人にとっては早歩きのウォーキングも強い活動量という事であればPAIの値も大きく増加します。一方、それなりの運動を継続している人であれば意識して早く歩き、心拍数をそれなりに上げないとPAIカウントは増えていかないようです。\nこれらの仕組みによって、まずは自分の出来る範囲での活動から記録していく事で飽きずにモチベーションを長く維持できる仕組みとなっています。\n軽く30分ほど運動した日は以下の通り、PAIが16ほどカウントされています。これも特段Mi Fitでワークアウトを開始・終了を指示しておらず、自動的に計測されているものです。PAIは高・中・低の3種類の運動量で記録されています。\n\n\n通勤時や仕事での移動には少し早歩きしたり階段を使う事を意識するとPAIの数字が上がり、活動した実感が出てきます。PAIは100以上の数値を求めてより多く運動してもあまり効果は無いとの説明がありますが、これは心肺機能に限っての説明ですので、長い時間運動すればダイエットには効果があるでしょう。また、PAIの数値が上がれば上がるほど数字は増えにくくなる仕組みとなっているため、適度な数字を目安にすべきと考えられます。こういう数字を見る習慣をつけると、エスカレーターやエレベーターを使わずに階段を使ったり、ひと駅分は歩こうかなという気にさせてくれます。\n睡眠スコア睡眠スコアの画面です。MI bandを着けたまま寝ると睡眠スコアが記録されます。深い眠り、浅い眠り、REM睡眠、覚醒時間と分かれています。また日中に昼寝をすると、仮眠が記録されます。\n\n\n\n\nREM睡眠となっている部分は自分のなかでは殆ど起きているような感じを持っていますが、結構この感覚とMI Fitの結果と合っています。長い時間寝てもぐっすり眠れなかったなと気がする時は大体深い眠りが短くなってしまっています。睡眠の質分析と共に、類似したユーザーとの比較もあるので、自分の改善ポイントが良くわかります。しかし、ぐっすり深く眠るというのはなかなか難しいものだと痛感します。寝る前のコーヒーを控えたり、日中に適度な運動をしたり、自分に合った睡眠の工夫をする機会が得られます。\n心拍数MI Fitはなんと言ってもこの心拍数を記録する機能が重要です。\n\n\n特に運動する場合において重要な心拍数ゾーンが管理できます。Mi Fitでは以下のようにゾーンが分類されています。\n\n最大酸素摂取量\n無酸素\n有酸素\nインテンシブ\nライト\nリラックス\n\n上が一番激しい運動で下に行くほど軽い運動となるわけですが、運動する際はどのゾーンでどれだけ運動するかがポイントになります。これは年齢や日頃の運動している状況によってかなり変わるのであくまで目安となるものです。強すぎる運動（無酸素運動）では長い時間行えませんし、ダイエットの観点では脂肪燃焼どころか筋肉の減少や怪我に繋がるおそれがあります。また負荷が軽すぎる遅いウォーキングでも効果はあまりみられません。その人にとっての心拍数ゾーンが存在します。なお、体調のバロメーターとして、安静時心拍数が取得できます。私は普段60弱ぐらいの数字ですが、60を超える時はやや調子が悪いので朝起きた時にこの数字を確認し、数値が悪い場合はあまり無理をしない日にしようと意識するようにしています。\nストレスレベルストレスレベルも自動で計測してくれます。MI bandのストレス計測方法はどのように行っているかはわかりませんでした。しかしいくつかの文献では、ストレスを感じていない時は心拍数にゆらぎ（常に一定間隔ではない）が発生しているのが通常であって、ストレスを感じた時はその間隔が一定になるとの事でそのような仕組みを利用していると推測されます。少しストレスを感じている時は気分転換をしたり深呼吸をすれば、ストレスを下げる事ができます。\n\n\n通知機能MI bandはスマホとBluetoothで接続状態にある場合は、電話、メール、アプリなどの通知を行ってくれます。LINEやTwitterも通知できますが、上記以外はアプリとして一括りですので、着信を許可したいもの、したくないものとのカスタマイズは限られます。とはいえ、PCを使っている時にSMSでワンタイムパスワードを受け取る時などは、結構便利です。以下のようにグローバル版であっても漢字を含む日本語は明瞭に表示されます。\n\n\nランニングを計測してみるMI bandにワークアウト開始を指示すると、細かい情報が取れます。GPSの記録を行う場合はスマホを持ってランニングする必要があります。\n\n\n平均心拍数や平均ペース（kmあたりの所要時間）に加え、ケイデンス（回転数※この場合は歩数）、ストライド（歩幅）まで出るのは驚きです。また、kmあたりのペース（スプリット）まで出るのは本格的です。心拍数も、心拍ゾーンが表示されます。この例ではかなりゆっくり、自身では心拍数は130程度を維持し負荷はほとんど感じない内容ですが、心拍ゾーンは有酸素に多く割り当てられています。インテンシブと書かれている項目は脂肪燃焼ゾーンといったほうがわかりやすいですが、自分の感覚ではもう少し低い負荷で走っているつもりが有酸素となっているのは若干違和感がありました。また、私は音楽を聴きながらのんびり走る事が多いのですが、ワークアウトを開始するとMi bandのミュージックコントロールが行えなくなってしまいます。これは仕様のようですが、若干不便なところが気になりました。\nASICSのRunkeeperを併用するランニングをする方には絶大な人気があるASICSのRunkeeperというスマホアプリがあります。MI bandの説明には何も書かれておらず、正式サポートはしていないかもしれませんが、このRunkeeperでMI bandから心拍数を取得できます。また、Runkeeperは音楽を再生する事が出来ます。加えて定期的に音楽のボリュームを下げて、現在の距離、ペース、心拍数などを音声で読み上げてくれるのでなかなか便利です。太陽の下でMI bandの画面を走りながら小さい画面の文字の心拍数を見るのはかなり厳しく、音声のほうが便利です。MI bandも音声読み上げ機能はありますが、Runkeeperの方ががやはり本格的です。\nRunkeeperとMI bandのペアリングRunkeeperの設定画面を開くと、以下のようにデバイス＆ハードウェアという項目があります。\n\nここからペアリングします。ペアリングの際はMI bandの画面を点灯させたまま行うと認識しやすいです。\nRunkeeperとMI bandの音声ガイド実際の音声ガイドについては以下の項目が選択できるようになります。MI bandの情報は平均心拍数と現在の心拍数の読み上げが可能です。心拍数ゾーンという項目もありますが、これはMI bandでは利用できないようです。\n\n\nRunkeeperの読み上げは数分単位、距離単位と細かな設定が可能ですので、ペースの調整に役立ちます。以下は7分弱&#x2F;kmのペースで5km走ったRunkeeperの分析データです。ずっと同じペースで走っていますが、スタートから10分までは心拍数が急に上昇しその後はスッと落ちています。このあたりは少し見た目でわかりやすくなっていて数秒毎で平均値を取っているようにみえます。iOSの場合、Runkeeperの結果はヘルスケアに取り込めます。\n\n\nMI bandと、Runkeeperを活用し、ペースを意識しながら走る（Runkeeperは自転車の計測も可能です）ことや、もっと遅いゆっくりとしたペースで家族や友人と会話を楽しみながら走るのも良いものです。\n他のデバイス、アプリとの連携Runkeeperは、Withingsの体重計と連携でき、RunkeeperのPCサイトでは運動と体重の推移が確認できますので、自身の健康管理にも役立ちます。Withingsの体重計のデータはWi-FiでWithingsのクラウドに自動アップロードされるため、とても便利です。\n\nWithings https://www.withings.com/jp/ja/scales\n\nなお、心拍数とゾーンの関係についてのもう少し詳細な説明は、以下の記事を参照してください。\n\nearnest.fit -体脂肪が効率よく燃える有酸素運動の適切な心拍数について、計算式から徹底解説- https://earnest.fit/intensity-aerobic-exercise/\n\niOS限定ではありますが、RunkeeperからAppleヘルスケアにデータ連携させておけば、その後、Zonesというアプリを利用する事でゾーン毎の運動時間を把握できます。\n\n\n音楽を聴きながらジョギングする場合は公園など安全な場所で行ってください。さらに外音を取り込む機能のあるイヤホンを利用される事をお勧めします。\n\n","categories":["SmartWatch"],"tags":["miband"]},{"title":"MIスマートバンド6を活用する","url":"/new-technology/2021/07/24/miband6/","content":"\n\nMIスマートバンド6（MI band6）の発売2020年の10月に発売されたMI band5から1年も経たずに、MI band6が2021年7月9日に発売されました。ディスプレイが大きくなり、SPO2（血中酸素濃度）が計測可能という触れ込みです。AmazonではXiaomi公式で5,990円で発売しています。私は一足先にグローバル版を購入して数ヶ月使っていますので使い心地などを書いていきます。グローバル版は、技適の認証を受けており、日本国内で利用可能です。MI band本体の操作メニューは英語であるものの、スマホからの通知メッセージなどは日本語表示が可能です。Zepp Lifeと呼ばれるスマホアプリで操作します。\n\n\nMI band 6の特徴（抜粋）\n活動指数（PAI）の管理\nストレスモニタリング\n心拍数モニタリング\n睡眠モニタリング\n電話、メール、SMSなどの通知機能（スマホ連動）\n音楽再生（スマホ連動）\n30種類のワークアウトの記録\n14日間のバッテリー持ち（フル機能活用では実質4日〜5日程度）\n水深50m防水\n\nMI band5と比較してMi Band 6のディスプレイはサイズが1.56インチ、解像度が486ｘ152ピクセルとなっています。Mi Band 5は1.1インチ、294ｘ126ピクセルでしたから、視認性が高くなっています。また、ディスプレイの大型化で操作性が向上し、スマホアプリを使わずband単体で操作できる事が増えています。\n追加されたSPO2計測については、体内にきちんと酸素が取り込めている事を検査する目的ですが、MI band6は医療機器では無いのであくまで参考程度に考えておいたほうが良いでしょうか。\nMI band5はモニタリング機能を全て有効にして約2週間の電池持ちでしたが、band6の「睡眠事呼吸の質（beta機能）」を有効にし、設定頻度を全て高めにすると4日程度の電池持ちになります。これくらいであれば許容範囲ではないでしょうか。\nZepp LifeアプリMI bandを最初に使う時はiOSまたはAndroidのZepp Lifeアプリをインストールし、アプリからペアリングします。アプリを起動した画面は以下になります。\n\n\n大型ディスプレイMi Band 6のディスプレイはサイズが1.56インチ、解像度が152ｘ486ピクセル。Mi Band 5は1.1インチ、126ｘ294ピクセルでした。あまり大きくなると煩わしくなりますが、操作性はかなりアップしています。\n\n\nメインディスプレイのそれぞれの機能の場所をタッチするとサブメニューに移動します。band5では画面を一旦タッチしてからメニュー一覧をスライドさせて目的の機能に移動していましたからかなり便利です。多機能になった事でband6のメニュー一覧も増えていますが、量が多すぎますので表示メニューをカスタマイズし、減らす事ができます。\n\n\n私の場合、普段もっとも使う通知とジョギング時のミュージックコントロールはショートカットメニュー（横スワイプで表示）に割り当ているのでディスプレイ設定はストレス〜アラームの4つのみです。\nこの1年ほどMI bandを使ってきてタイマーやストップウォッチは殆ど使う事がなく、イベントリマインダーもスマホアプリから設定する必要があるので使いづらく、使うのはアラームのみになっています。長時間の移動や乗換えタイミングなど到着5分前にアラームを設定しています。スマホのアラームだとアラーム音が鳴り響くので外出時には使いづらく感じます。平日の目覚まし目的にしてもアラーム音で起こされるよりはMI bandのバイブの方が心地よく目覚められます。\n\n\nこのように画面が大きくなった事で操作性が高くなりアラームの設定もしやすいです。\nSPO2MI Band6のウリとしているSPO2計測ですが、その精度を確認してみました。医療機器として認定を受けているパルスオキシメーターとMI band6とで同時計測した場合、2％-3％程度の誤差はありましたが、脈拍含めて大きな誤差はありませんでした。MI band6はバンドの締め方などでSPO2の測定値が変わる一方、パルスオキシメーターは98％〜99％で安定していました。パルスオキシメーターは例えばSPO2が90％を割り込んだ場合など、呼吸器疾患がある場合にこそ価値があるものですが、健康な人間が計測する限りでは比較や評価は難しいところです。\n\n\n睡眠スコア睡眠スコアの画面です。MI bandを着けたまま寝ると睡眠スコアが記録されます。深い眠り、浅い眠り、REM睡眠、覚醒時間と分かれています。また日中に昼寝をすると、仮眠が記録されます。\n\n\n今回、睡眠呼吸の質という項目が加えられています。Betaの表記がありますので、最終的にどのような機能になるかはわかりません。100点満点のスコアのうち、90点以上であれば合格のようです。アプリ上での説明では、以下のポイントが記載されています。\n\n就寝前に飲酒しない\n横向きの姿勢で寝る\n減量\n運動\n\n繰り返しになりますが、医療向けの製品ではありませんのであくまで参考に留め、寝る前のコーヒーを控え日中に適度な運動をしたり、自分に合った睡眠の工夫をするのが一番でしょうか。\nストレスレベルストレスレベルも定期的に計測してくれるので、わざわざ計測するというアクションは不要です。スマホは不要でストレスが高いかなと思った時にbandのストレス項目を確認できます。数値が高ければ深呼吸するというルーティンを作るのがおすすめです。時々計測されない時間帯がありますが、これは移動したり運動をしている時に計測しないように見えます。\n\n\n心拍数bandディスプレイの心拍数がそれなりの頻度でモニタリングしてくれるのでスマホアプリで確認する必要はありません。日常生活では歩き出すとbandが計測頻度を高めてくれるので、よく使う階段などでおおよそ心拍数がどれだけ上がったかを確認できます。\nPAI(パーソナルアクティビティインテリジェンス）MI bandには活動に反応して活動量を計測し指数化してくれる機能があります。心拍数を計測し活動量が増加すると、心拍モニタの頻度が上昇し、心拍数を細かく記録していきます。PAIは7日間の合計でスコアリングされます。これを100以上に保つ事で健康が維持されるとの事です。ロジックは公開されていませんが、年齢・性別・安静時心拍数・過去7日間の心拍数に基づきPAIスコアが計算されます。強度が低いウォーキングであれば加算される数字は小さいですし、強度の高い運動であれば数字は大きくなります。1週間前のデータは無効となるため、継続的な運動が必要です。1日全く活動しなくても構いませんが、数字はどんどん減っていきます。この数字を見ながら活動する事である程度の運動強度を意識し、PAIを100以上にし続ける事が推奨されています。このPAIは心疾患の予防の観点が主ですが、ダイエット目的にも活用できます。\nPAIはその人固有の状況に合わせて管理されるので、その人にとっては早歩きのウォーキングも強い活動量という事であればPAIの値も大きく増加します。一方、それなりの運動を継続している人であれば意識して早く歩き、心拍数をそれなりに上げないとPAIカウントは増えていかないようです。\nこれらの仕組みによって、まずは自分の出来る範囲での活動から記録していく事で飽きずにモチベーションを長く維持できる仕組みとなっています。\n軽く30分ほど運動した日は以下の通り、PAIが16ほどカウントされています。これも特段Zepp Lifeでワークアウトを開始・終了を指示しておらず、自動的に計測されているものです。PAIは高・中・低の3種類の運動量で記録されています。\n\n\n通勤時や仕事での移動には少し早歩きしたり階段を使う事を意識するとPAIの数字が上がり、活動した実感が出てきます。PAIは100以上の数値を求めてより多く運動してもあまり効果は無いとの説明がありますが、これは心肺機能に限っての説明ですので、長い時間運動すればダイエットには効果があるでしょう。また、PAIの数値が上がれば上がるほど数字は増えにくくなる仕組みとなっているため、適度な数字を目安にすべきと考えられます。こういう数字を見る習慣をつけると、エスカレーターやエレベーターを使わずに階段を使ったり、ひと駅分は歩こうかなという気にさせてくれます。\nband計測対象のカスタマイズアプリの設定で心拍数モニタリングという項目があり、その設定は以下の画面の通りです。\n\n\nASICSのRunkeeperを併用する（この章は「MIスマートバンド5を活用する」の再掲です）ランニングをする方には絶大な人気があるASICSのRunkeeperというスマホアプリがあります。MI bandの説明には何も書かれておらず、正式サポートはしていないかもしれませんが、このRunkeeperでMI bandから心拍数を取得できます。また、Runkeeperは音楽を再生する事が出来ます。加えて定期的に音楽のボリュームを下げて、現在の距離、ペース、心拍数などを音声で読み上げてくれるのでなかなか便利です。太陽の下でMI bandの小さい画面の文字の心拍数を見るのはかなり厳しく、音声のほうが便利です。MI bandも音声読み上げ機能はありますが、Runkeeperの方が本格的です。\nRunkeeperとMI bandのペアリングRunkeeperの設定画面を開くと、アプリ、サービス、およびデバイスという項目があり、さらにデバイス＆ハードウェアという項目があります。\n\n\nここからペアリングします。ペアリングの際は、Zepp Lifeアプリを終了させ、MI bandの画面を点灯させたまま行うと認識しやすいです。\nRunkeeperとMI bandの音声ガイド実際の音声ガイドについては以下の項目が選択できるようになります。MI bandの情報は平均心拍数と現在の心拍数の読み上げが可能です。心拍数ゾーンという項目もありますが、これはMI bandでは利用できないようです。\n\n\nRunkeeperの読み上げは数分単位、距離単位と細かな設定が可能ですので、ペースの調整に役立ちます。以下は7分弱&#x2F;kmのペースで5km走ったRunkeeperの分析データです。ずっと同じペースで走っていますが、スタートから10分までは心拍数が急に上昇しその後はスッと落ちています。このあたりは少し見た目でわかりやすくなっていて数秒毎で平均値を取っているようにみえます。iOSの場合、Runkeeperの結果はヘルスケアに取り込めます。\n\n\nMI bandと、Runkeeperを活用し、ペースを意識しながら走る（Runkeeperは自転車の計測も可能です）ことや、もっと遅いゆっくりとしたペースで家族や友人と会話を楽しみながら走るのも良いものです。\n","categories":["SmartWatch"],"tags":["miband"]},{"title":"Xiaomi Smart Band 9を活用する","url":"/new-technology/2024/09/23/miband9/","content":"\n\nMIスマートバンド9（MI band9）2024年に発売となったXiaomi Smartband 9（Band9）を使って健康促進のための使い方を初級者向けに紹介します。このブログでも過去にBand 5,6はレビューしてきて、久しぶりのMI bandです。これまではZepp Lifeと呼ばれるスマホアプリで操作していましたが、Band8からはMI Fittnessというアプリに変わっています。ここでは昨年発売されたBand8との比較もします。\n\n\nBand9の主な機能主な機能としては以下の通りです。\n\n\n\n大項目\n分類\n機能\n\n\n\nバッテリー接続時間\n通常使用時\n21日間\n\n\n\nDisplay ON\n9日間\n\n\nヘルス\n\n日々の活動記録\n\n\n\n\n心拍数モニタリング\n\n\n\n\n血中酸素モニタリング\n\n\n\n\n睡眠モニタリング\n\n\n\n\nストレスモニタリング\n\n\n\n\n月経周期リマインド\n\n\n\n\n深呼吸トレーニング\n\n\nスポーツ\n\n150以上のスポーツモード\n\n\n機能\n\nミュージックコントロール\n\n\n\n\nアラーム\n\n\n\n\nタイマー\n\n\n\n\nストップウォッチ\n\n\n\n\nフラッシュライト\n\n\n\n\n天気\n\n\n\n\nイベント\n\n\n\n\nタスク\n\n\n\n\nスマホを探す\n\n\n\n\n世界時計\n\n\n\n\n集中\n\n\n\n\nカメラシャッター\n\n\nスペックは以下の通りです。\n\n\n\n項目\n内容\n\n\n\nサイズ\n46.53 × 21.63 × 10.95 mm（ストラップ除く）\n\n\n重量\n15.8g（ストラップ除く）、27g（ストラップ含む、実測）\n\n\nストラップ\nTPU（シリコン）\n\n\nディスプレイ\n1.62インチ\n\n\n解像度\n192 × 490 ピクセル\n\n\n輝度\n最大1200nits（調節可）\n\n\nバッテリー\n最大21日間\n\n\nバッテリー容量\n233mAh\n\n\n防水性能\n5ATM\n\n\n引き続きGPSは搭載していません。厳密な距離を測るならスマホも同時に持ち出す必要があります。ですが、スマホがなくとももちろん十分活用可能です。何より寝ている時も身につけることを考えると軽くてサイズが小さく、バンドがしなやかなものが最適です。\nBand8と9との比較\n\n\n項目\nBand9\nBand8\n\n\n\nボディ素材\nアルミニウム\n強化ファイバーポリマー\n\n\n画面輝度\n1200ニト\n600ニト\n\n\nバッテリー\n233mAh\n190mAh\n\n\nBluetooth\n5.4\n5.1\n\n\n重さ\n15.8g\n13.5g\n\n\nセンサー\nジャイロスコープ、加速度\n高精度 6 軸\n\n\n機能的にはBand9とBand8との違いは殆どありません。大きさとしては、Band9の方が1mmほどディスプレイが小さいのですが、殆ど気づくことはありませんし、Band9の方が2gほど重いのですがこれもまた気づきません。バッテリーの持ちは使い方によって大きく変わってきますが、今回この記事で推奨するモニタリングの方法は、ディスプレイは自動点灯（ジャイロセンサーでバンドを見た時に反応）、各種モニタは殆ど詳細機能を有効にし、通知は10件程度&#x2F;日という前提でBand8で7日間弱の持ち、Band9で10日間の持ちでした（毎日1時間弱のウォーキング、12,000歩前後の活動で、シャワー時以外は装着状態で計測しました）。Band8ではジャイロスコープと加速度がセットで6軸センサーになっていたものがBand9では分離していますが、使い勝手に違いは殆ど感じません。若干Band9の方が反応は良さそうですが、気になりません。1200ニトの画面輝度は夏場の日差しがよほど強い状況でなければ視認性には問題ありません。\n曇りの日で外に撮った写真で比較しています。右がBand8、左がBand9です。\n\n\nこうやってみると違いはありますが、決定的な違いはありません。バッテリー持ちの違いも合わせて検討する必要がありますが、24時間、睡眠の詳細までフルに記録して1週間程度持ってくれるならBand8でもBand9でもどちらでも殆ど違いはないと考えて良いのではないでしょうか。値段でみると海外通販ではBand8は3,000円台で売っており、Band9は5,000円台ですが、これもまた大きな違いはありません。そもそも、この値段で健康に役立つと考えるならば殆ど誤差でしょう。少しBand9の方が良いと思われる点はデフォルトのディスプレィの表示項目です。左がBand8、右がBand9です。\n\n\n私の場合、実際の消費カロリーや歩数などは具体的数字があった方がありがたいです。Band8のようにオレンジ、黄色、青色のアクティブ指標の視覚的な表示にここまで領域を多く使わなくても良いかなとは感じます。もちろんバンドディスプレイは気に入ったものに変更できます。でもデフォルトが一番良いんですよね。。。\n機能的にBand9のみ持つ機能としては、ランニングコースという機能で、基礎ラン、脂肪燃焼ラン、MIITランなどレベル、強度に合わせたランニングモードを搭載している点です。\nここから先はBand9を中心に説明しますが、目的は健康になることに主眼を置き使い方を見ていきます。\n健康管理にSmart Bandを活用するXiaomiのSmart Bandに興味のある方はトレーニングを趣味としているよりは健康に少し気を使いたいユーザーになるかと思います。このブログでも心拍数の機械的な厳格さなどを記載の目的にしていません。どのように健康に活用できるかをテーマにしたいので初級者向けの記事になります。10kmを週3回は走るのが趣味という方は恐らくもっと高度なスマートウォッチなどを利用されていることでしょう。\n\n運動不足と感じる方\n痩せたいと考えている方\n心拍機能を強化したい方\n健康管理全般（血圧、ストレス、睡眠）\n\n私もコロナ禍の時は大半がリモートワークだったので、5kmくらいを30分強程度でゆっくりと走っていましたが、今は殆ど出社していることもあり、殆ど走らなくなってしまいました。特にデスクワークの方は気付かないうちに運動不足になっていってしまいます。\n私の場合、運動（減量）しようと決めた期間は24時間バンドは着けたままにしています。睡眠も大事です。運動不足だと良い睡眠も取れない実感があります。目標が達成したら、寝ている時は外したりもしますが着けている限りは努力しようというか少し気が引き締まる感じもあります。\nいきなり走るのは。。。と躊躇される方もいらっしゃるかと思います。ウォーキングだけでも十分効果はあります。Smart Bandでは心拍機能の向上を目指したり運動強度の分類も確認できるようになっていますが、ここではできるだけ体に大きな無理をせずに健康になることを目指したいと思います。何より怪我をしては元も子もありません。最初はウォーキング、そして軽いジョギングまでを説明していきます。\n今年の夏も、早朝であっても暑くて運動するのは難しかったですが、9月になり朝や夕方は随分涼しくなってきました。夏はエアコンの部屋で大人しくしていた方も良い季節になりましたのでSmart Bandを活用されてはいかがでしょうか。\nSmart Bandのセットアップパッケージの内容は以下になります。\n\n\nバンドの充電のためにUSB Type-Aの充電器が必要です。最初にバンドの電源をOnにするには充電開始する必要があります。充電が開始されるとバンドの電源がOnになります。\nバンドで日本語を選択すると、スマホアプリのセットアップのためにQRコードが表示されます。\n\n\nここからMi Fitnessアプリをダウンロードします。ここではiPhoneでの操作を説明しています。\n\n\nMi Fitnessを起動し、アカウントを作成します。その後、バンドとスマホとを接続します。スマホのBluetoothを有効にしておきます。\n\n\nウェアラブルからデバイスの追加とタップし、バンドとペアリングします。\n\n\n\n続いてバンドのファームウェアをアップデートします。バンドへのダウンロードに15分程度掛かるのでそのまま待ちましょう。\n\n\nバンドが再起動してアップデートが実行されます。\nSmart Bandの初期設定ここから初期設定に入ります。設定の紹介をしながらお勧めの設定をしていきます。\n\n12日程度の電池持ちを前提（Band9）、6日〜7日程度の電池持ちを前提（Band8）\n24時間詳細情報のモニタリング\nスマホアプリ通知などを設定\n夜間の通知しない時間帯、目覚ましの設定\n\nMi Fitnessのデバイスメニューからバンドが接続されていることを確認します。\n\n\n以下のメニューの表示順にセットアップしていきます。\n\n\n最初のランニングモードを切り替えるの項目は初期のバンドモードのままにします（リストバンドとして心拍を計測します）。\n通知と通話（設定を推奨）Mi Fitnessのデバイスメニューの通知と通話では、電話やメッセージなどをスマホで受信した際にバンドに通知します。仕事中など、必要なメッセージだけをバンドに通知されるのはとても便利です。なお、バンドで電話は受けられませんし、メッセージを送信できません。あくまでメッセージ本文が通知されバンドで読める機能です。\n\n\nアプリ通知、スリープ解除、装着時のみ通知を有効にします。個別に通知を受信するためのアプリを選択します。電話、メッセージ、メールの基本設定など、これは受信したいメッセージアプリを有効にしていきます。LINE、Gmail、Outlookなど様々なアプリが登録できます。ここに登録が無いものはその他を選ぶとスマホの通知が全てバンドに通知されます。なお、カレンダー（イベント）は別の項目で設定します。\n\nフィットネスと健康Mi Fitnessのデバイスメニューのフィットネスと健康では、以下のメニューがあります。\n\n\n心拍数（推奨）連続モニタリングはデフォルトでスマートとなっています。自動という事ですね。ワークアウト中は頻繁な連続モニタリングを行いますが、動きがない場合は少し間隔を空けてモニタリングします。この設定はバンド本体のみでも行えます。（任意）心拍数が異常値の場合、アラートを通知します。\n睡眠（推奨）高度なモニタリング、呼吸数を有効にします。これで睡眠の詳細、呼吸数が記録され、眠りの深さや安静時心拍数がわかるようになります。\n血中酸素レベル（推奨）高度なモニタリング、呼吸数を有効にします。血中酸素レベルは90％以上で十分と言われます。健康な方なら90％を割ることは殆ど無いと思われます。また、ジョギング中でもこういった数値が異常値になる経験はありませんが、何かしらの気づきになる可能性もあるので有効にしておきましょう。\nストレス（推奨）終日モニタリング、リラックスリマインダーを有効にします。ストレスを感じた際は気分転換する機会が得られます。あまりストレスを感じていると熟睡できなくなりますので有効にしておきましょう。\nスタンディング（任意）立ち上がることをリマインドを有効にします。デスクワークの方は、気分転換を兼ねてストレッチをする機会が得られます。なお、通知の開始、終了時刻が設定できます。DNDという項目があり、これはDo Not Disturb（知らせない）の略ですが、昼休みなど本当に休む場合で起こされたくない場合は追加設定しておきます。なお、夜間に通知してほしくないことも当然ですが、これは別の項目で設定します。\n統計（必須）ここでは毎日の目標を設定し、目標達成したらリマインダーで通知できます。MI Fitnessからバンドを登録した時に最初に目標設定を促されますが、この項目でいつでも変更可能です。カロリーについてはあまり目安というのは難しいのですが（体重や運動強度などもあり複雑）、以下で紹介する「健康づくりのための身体活動・運動ガイド2023（概要）」の成人のケースに基づき、以下の設定ではいかがでしょうか。\n\n\n\n項目\n目標\n\n\n\nカロリー\n300キロカロリー\n\n\n歩数\n8000歩\n\n\n中高強度の運動\n60分\n\n\nカロリーは以下の文献から1日、300キロカロリーを目安としています。\n\n厚生労働省　身体活動・運動 (注）1日1万歩の根拠　海外の文献から週当たり2000kcal（1日当たり約300kcal）以上のエネルギー消費に相当する身体活動が推奨されている6)。歩行時のエネルギー消費量を求めるためのアメリカスポーツ医学協会が提示する式を用いて、体重60kgの者が、時速4km(分速70m)、歩幅70cm、で10分歩く（700m、1000歩）場合を計算すると、消費エネルギーは30kcalとなる。つまり1日当たり300kcalのエネルギー消費は、1万歩に相当する。 https://www.mhlw.go.jp/www1/topics/kenko21_11/b2.html\n\n ※1日1万歩と記載があり、これは多い気がしますが、分速70mというのは強度が少し低めです。ここではもう少し歩く距離を減らし、速度を上げる方向で記載しています。\n健康づくりのための身体活動・運動ガイド2023（概要）https://www.mhlw.go.jp/content/001204942.pdf\n以下の厚生労働省のWebページでは成人、老人、子供、または慢性疾患がある場合の方向けにどの程度の強度の運動をすべきか記載されているので、一読されることをお勧めします。\n\n厚生労働省　身体活動・運動の推進https://www.mhlw.go.jp/stf/seisakunitsuite/bunya/kenkou_iryou/kenkou/undou/index.html\n\nこれらの設定はかなり意識して実行しないと達成しません。中高強度の運動が60分と言われると少し厳しい感じがしますが、普通の人が達成できない目標でもありません。運動不足の方でも最初はウォーキングからしっかりと目標を立てて頑張って取り組みましょう。\n活力スコアの設定（推奨）活力スコアの設定は、目標達成通知、7日間のプログレス、毎日のプログレスとあり、それぞれ通知設定が可能です。\nこの活力スコアについては、MI Fitnessの不具合なのかアプリから詳細をタップするとアプリが落ちてしまいます。ヘルプを見る限りでは、WHOガイドラインに基づき、1週間で100という指標を目指すものとなっています。つまり過去7日間で継続的に100を達成していることが目標になります。MI Fitnessのヘルプに基けば「成人の場合、大きな健康効果を得るためには、週に150〜300分の中強度の有酸素活動、75〜150分の高強度の有酸素活動、または中強度と高強度の活動を同量ずつ組み合わせて行うことが望ましいとされています」とのこと。昔のMI Bandで用いられていたPAIに相当するものになるでしょうか。一応、ウォーキングだけでもそれなりに数値は上がっているので高強度の運動までは厳しいと感じる方でも参考になるでしょう。MI Fitnessに慣れてきて週3回くらい高強度の運動をする方は目安として強度が不足、または回数が不足していることなどの気づきになるでしょう。\n2024-09-29 追記最新ファームウェアのアップデートがあり、このアプリが落ちるのは解消されました。日付ごとに活力スコアが確認できます。ここでは心肺機能の強化を目的としているのか、中強度、高強度の運動も求められます。こちらはワークアウトが習慣化された後に大事になってくる項目になるでしょう。\nアプリアプリというのは、バンド上の機能です。機能単位にアプリという形で管理されています。以下の項目が設定できます。\n\n\nアラーム（推奨）アラームはもちろん個人のライフスタイルによって任意項目ですが、就寝時にもバンドを着けている方にとっては便利なのでお勧めです。曜日指定ができますし、スマート起床を選ぶと睡眠サイクルで適切なタイミングでバンドが振動してお知らせします。\n\n\n個人的にはスマホなどのアラームの音で驚いて目覚めるよりはバンドの振動で起こされた方が目覚めは良いです。余談ですが、さらにその10分前くらいに、Amazon Echoで最小ボリュームで鳥の鳴き声（Apple Music）を再生するようにしています。睡眠に入る時も静かな音楽をタイマーで30分ほど流しますが、こういった組み合わせによってより深い眠りができる気がしています。\nイベントを同期（推奨）カレンダー登録されたものはこの設定を有効にすることで通知されます。仕事に没頭していてもリマインダーとして便利です。\nその他タスクリマインダー、天気、世界時計（アプリはデフォルトで非表示）があります。Band9のデフォルトの画面では一番下に天気が表示されています。最低気温と最高気温までが青色のゲージ表示になっており、今の気温がわかるようになっており便利です。\nシステム設定以下の設定ができます。\n\n\nウィジェットデフォルトではバンド上で設定する項目、気温、音楽、睡眠・心拍数などのショートカットがウィジェットとしてまとめられています。これはバンドのディスプレイから左右のスワイプでより詳細の機能にアプローチできます。バンドを右から左にスワイプするとデフォルトでは睡眠と心拍数の2つが表示されるウィジェットとなっています。私はこの2つセットのウィジェットを削除し、心拍数のみを登録しています。例えば通勤時にいつもの階段を登りきった後、心拍数をみて普段より過度に心拍数が上昇していないか体調のバロメータとしてよく使います。ワークアウトを開始せずともスワイプ一度で心拍数が見られる（計測スタートする）のはとても便利です。\nアプリを並び替えるバンドのディスプレイを下から上にスワイプさせるとアプリが表示されます。このアプリの順番を変えたり、アプリを追加したり非表示にしたりできます。\n\n\nスリープモード（推奨）大体寝る時間と起きる時間が決まっている方は、ここでスリープモードの時間帯を有効にしておくと、腕を上げる時にディスプレイが点灯しません。タップすると点灯します。これで寝返りを打っても勝手にディスプレイがOnになりその明るさで目覚めるという事がなくなります。なお、目覚ましアラームの機能がありますが、ここでは有効にしないことをお勧めします。前述したアラームの方が高機能で、この目覚ましアラームは毎日が原則ですので使い勝手が悪いです。\n追加設定このメニューではバンドのファームウェアアップデートができます。またバンドに関する使い方のヘルプもここから確認します。\nバンドの装着安定して心拍数を測るためにはそれなりに密着させてバンドを締める必要があります。女性の方など手首が細い方（13cm以下の方）は隙間が空いてしまうかもしれません。AliExpressなどにマジックテープで留めるタイプのバンドが数百円で売っていたりするので、そちらで調整することをお勧めします。\nバンド本体の設定バンドのディスプレイを右にスワイプし、設定→ディスプレイ→持ち上げてスリープ解除を選ぶと、デフォルトで開始が8：00、終了が22：00になっているはずです。この設定を前述したスリープモードの時間帯と合わせておくことをお勧めします。\nまた、設定→自動検出というメニューがあるので、自動検出をOffに、ワークアウトの終了を検出をOnにすることをお勧めします。ワークアウトは実施の前にご自身で開始されるでしょうし、これが有効であると通勤時に誤判定されるので不便です。\nワークアウト（ウォーキング）MI Fitnessのワークアウトからウォーキングを選ぶか、バンドのディスプレイを下から上にスワイプして、ワークアウト、ウォーキングと進みます。アプリの権限で位置情報を「常に許可」（iOSの場合）にしておく必要があります。恐らく、スマホを使わずともバンド操作で十分でしょう。時間のある時にゆっくり分析する時にはMI Fitnessアプリを使うことになります。\n\n\nGOをタップして早速ウォーキングしてみましょう。\n\n\n\nバンドのディスプレイには上から小さく現在時刻（小さくてワークアウト中には読み取れません）、ワークアウトの経過時間、距離、心拍数、その下にスワイプしていくと、現在のペース、平均ペースなどが表示されます。ウォーキングなどの速度を表すペースは時速◯キロ（km&#x2F;h）の表記ではなく、1kmあたり◯分という表記になります。\nウォーキングで良く言われるのは、ゆっくり歩いていてはトレーニングにならないという事です。MI Smart Bandでの心拍数は、ウォームアップ、インデンシブ、有酸素、無酸素、最大酸素摂取量という具合に強度が分かれています。効率良く脂肪燃焼を行うにはインテンシブ〜有酸素の心拍数の幅が脂肪燃焼ゾーンと言われています。この分類、つまり心拍数の幅は人によって異なりますが、ざっくりと言うと、最大心拍数の40％〜60％程度です。最大心拍数は単純計算で220 - 年齢で求められます。40歳なら220 - 40 &#x3D; 180が最大心拍数の目安であり、脂肪燃焼ゾーンは72〜108です。\n仮に最大心拍数の50％だとすれば90あたりでしょうか。\n減量（体脂肪の減少）実験とバンドの電池持ちの確認を兼ねて17日間（バンド8で7日、バンド9で10日）毎日4km〜5km程度のウォーキングをしてみました。\n17日経過し、体重は-1.7kg、体組成計（体重計）では筋肉量が＋1.4kg、体脂肪が-3.1kgでした。また、普段あまり血圧は気にしていませんでしたがこの期間も継続して計測してみました。週間平均115&#x2F;82→113&#x2F;79と微減しました。ウォーキングだけでなく、食事では糖質を控えめ（米、パン、麺などの炭水化物を抑制）し、タンパク質を多めに摂取しました。朝食なら、豆腐、納豆、ヨーグルト、それ以外にたまに海藻類という具合です。夜は2日に1度の頻度でお酒（糖質低めのハイボール）は飲みました。夜は肉、魚、野菜を積極的に摂りご飯は白米から玄米に変えるという感じです。3食はしっかりと食べており厳しい食事制限は一切していませんし、お酒も常識的な頻度で飲んでこの程度は達成できるということはわかりました（この間1度だけ会食があり、糖質の高い日本酒などを飲むことになり実験を台無しにしそうでしたが、なんとか持ち直しました笑）。この程度であれば多くの方が気軽にチャレンジできる内容ではないでしょうか。今回はSmart Bandの記事なので食事のコツについては割愛しますが、食べないだけのダイエットや極端な糖質ダイエットは体の水分を抜くだけで筋肉量が落ちます。すぐに体重が減ってもリバウンドしやすいと言えます。しかし血糖値の急上昇を抑えることなど精製された加工度の高い炭水化物を抑制することは意味があり（ケーキやジュースなど）、糖尿病とは無縁とお考えの方でも、糖尿病対策についてよく調べていくと糖質を抑えることは健康のために効果が高いことが分かります。また、糖質、タンパク質が4kcal&#x2F;gに対して、脂質は9kcal&#x2F;gであることから脂質には留意する必要があります。結局のところカロリーコントロールが大切であり、生活習慣病対策となります。つまり、極端なことをせずとも、お酒や間食を減らし運動・睡眠・喫煙をきちんと考えた結果、適正な体重になっていくことは間違いありません。\n適正な食事量に加え、運動量及び日中の疲れをぐっすり寝て体を癒すことの2つは、MI Smart Bandで見える化できます。\nさて、個人によって歩く速度（運動強度）は異なるものの、ウォーキングの速度の1つの目安としてkmあたり10分という時間は男性・女性ともに共通の目線です。これは明らかに運動している状態の速度であり、この速度で長時間歩くとこの季節は汗もかきます。しかしこの速度は、足がもつれたり、呼吸が厳しくなるような状況には到底なりません。喋りながら歩き続けられるレベルです（個人差はあります）。\nバンドの表記の上部にある経過時間を見ていれば、10分経過した時に、その距離が1kmであれば10分&#x2F;kmの速度であり、適切なペースということになります。この時の心拍数がご自身の脂肪燃焼ゾーンに足りない場合は、軽いジョギングに移行されることを検討します（子ども、高齢者はこの限りではありません）。\nウォーキングが終了したらバンドを左から右にスワイプし、終了ボタンを2秒ほど長押し（ロングタップ）してワークアウトを終了します。\n後からスマホアプリでワークアウトの結果を確認できます。以下は約10分&#x2F;kmのペースで5kmウォーキングした結果です。\n\n\n\n\n\n\nこのように心拍数、ペース、ケイデンス（回転数、この場合は歩数）、ストライド（歩幅）が明瞭にわかります。\nストライド（歩幅）は一般的に身長　- 100cmが目安と言われています。速度を上げるためにケイデンスを上げるよりも少し大股で歩く意識で腕を振り、リズムを重視した方が速度アップに繋がります。\nこれらの結果を見ながら自分に合った強度や速度を見つけていくことになります。いきなり10分&#x2F;kmで歩き出すのではなく、ゆっくりの速度から始め、少しづつ速度を上げていきましょう。体組成計があれば、筋力の上昇が確認できますから、それを見ながら（筋力の上昇が安定したら）強度を少しづつ上げていきましょう。一番下の回復という項目で4時間と表記されていますが、次のワークアウトまで4時間は間を空けるようにすべきとの助言になっています。休息を取りながら時間に余裕のある範囲でウォーキングを継続しましょう。\nウォーキングの最中、バンドの表記がインテンシブではなくずっとウォームアップの状態なのであれば強度が足りません。これは歩き方にもポイントがあって、歩くときに踵から着地し、足の母指球で蹴り上げるように歩く方は足首のスナップを使う形になり、体全体に負荷が掛かりません。腿を上げることを意識し、緩やかな登り階段を上るように大股で歩き、足裏全体で着地し、着地した足を使って体を前にスライドさせ、できるだけ長く足裏全体を地面につけておくことです（つまり足首・母指球で蹴らない）。移動を考えると非効率でスピードも出ませんが、長時間、早く歩けば良いものでもありません。怪我のリスクを抑え効率良く有酸素運動の効果を高めるためには負荷の高いウォーキングを意識してみてください。ほとんど同じ速度で歩いても、腿上げを意識しながら歩くと心拍数は違ってきます。\n\n\n\n\n平均心拍数は106（インテンシブ）から125（有酸素）に上がり、一部無酸素の状態も含まれています。ペースが全体的に同じであってもワークアウト後半は心拍数が高めになります。\nランニングコースBand9よりランニングコースという機能が追加されています。バンドを下から上にスワイプし、ワークアウトではなく、ランニングコースのメニューを選択します。すると、以下のような項目が表示されます。\n\n基礎ラン\n上級ラン\n基礎ジョグ\n脂肪燃焼ラン（基礎）\n脂肪燃焼ラン（上級）\nMIITラン\nその他。..\n\nこれらのうち、最も易しいのが基礎ランです。\n\nウォーキング　2分×4回\nジョギング　3分×3回\n\nウォーキング→ジョギング→ウォーキングと繰り返して17分のメニューとなっています。ウォーキングからジョギングに切り替える際はまずは易しいこのメニューを使ってはいかがでしょうか？17分だと物足りないので2回行っても良いですね。これで慣れてくれば上級ラン（ジョギングが5分になったもの）に進み、基礎ジョグ（最初と最後の3分のウォーキング、21分のジョギング）ができるように目指すのも良いですね。\nワークアウト中は、目指す心拍数ゾーンと現在の心拍数が表示されています。\n\n\n私の場合、10分以上は走らないと心拍数は高いままで落ち着かないので、あくまで参考までにと割り切っています。\nさて、実際に基礎ランをやってみた結果です。\n\n\n\nMI Fitnessの方でもウォーキングとジョギングのペースが表示されています。なお、心拍数のラベルは不具合があるようで、よくわからない表記になってますね。上からウォームアップ、インデンシブ、有酸素、無酸素、最大酸素摂取量は変わらないので色の分類でも何となくわかるでしょうか。こちらも不具合報告は上げておきました。\nこちらはジョギングを3kmやった結果です。\n\n\n\n\nkmあたり8分のペースでゆっくりと走っています。このペースだと会話しながら余裕でジョギングできます。私の場合、ジョギングで楽だなと感じる時は心拍数135あたりが目安ですが、MI Fitnessの結果では大部分の時間が無酸素に割り当てられています。ここは自分の感覚と違和感があります。無酸素程度の速度だとかなり言葉少なで走ることになります。バンドの有酸素運動か無酸素運動かの違いはあくまで参考としてご自身の心拍数を見ていくのが良いのではないかと思います。\n走ると膝が痛くなるという方は、走るフォームの見直しで改善する場合があります。サポーターなどはほぼ気休めだと思います。特に猫背の方で重心が前にあったりする人は1kmほど走ると膝が痛むようになるという声が多いようです。足の着地は体の真下で膝下は地面に垂直近くというのが基本です。ジョギングは速度を出さないので、着地の後、足を母指球で蹴らず、足裏全体で体を前にスライドさせ進みます。膝が曲がっている状態で着地するとジャンプから着地する力と前に進む方向に対してブレーキを掛ける力も加わり、相当の負担を膝で受け止めることになります。\n余談ですが、ゴルフをやる方は、左膝を痛めている方がとても多いですよね（右利きの場合）。ボールを飛ばすのも地面との反発力ですが（プロゴルファーのショットの瞬間、上半身を縮めて足元が地面から浮き上がる様は凄いですよね）。ランニングも同様、地面の反発がとても大事ですが、早く走ろうとするとやはり膝を痛めやすいです。腿を振り上げても着地の瞬間まで足を体の真下まで引き寄せ反発を使えば、前述した足裏で体を送るなんてことをしなくとも勝手にポンポンと体が前に進んで気持ちよく走れます。\n自分の目標に合わせた負荷でワークアウトができるようにバンドを活用してみてください。\nゴルフゴルフの計測もやってみました。スループレーで途中休憩無し、カートでホール間の移動は行うものの、プレー中はカートを一切使わず歩き（または小走り）での計測です。\n\n\n特にスイング回数が分かるでもなく、また歩数が表示されるでもなく、心拍数のみ記録がされています。スマホはカートのキャディバッグの中に置いてあったので、プレー中は度々スマホとのBluetooth切断と再接続が行われ、その度にバンドが振動するので結構気になりました。後で歩数を確認しましたが、16,000歩程度でした。早めのウォーキングを意識したり、芝生の上なので大きな歩幅で走ったりしていたので、歩数自体は思ったよりも少なくカウントされていました。まぁゴルフは特にワークアウトにしなくても良いかな、、という感想です。\n山登り（トレッキング）おおよそ110分、2.8kmのコースの山登りを計測してみました。休日ともあって人が多く、渋滞で127分掛かりました。\n\n\nここでのペースの表記は時速（km&#x2F;h）となっています。山登りなのでインテンシブ、有酸素、無酸素、最大酸素摂取量とバランス良い数字ですね。但し、この無酸素47分とか最大酸素摂取量が17分とかはなかなかキツいものがあります。しんどいですが行き交う方々と「こんにちは〜」と挨拶しながらの山登りは良いものですね。早く登ることを目的としていませんが、山登りの記録としても残せるのは良いですね。\n睡眠バンドを手首につけたまま寝ると、翌朝には睡眠分析が表示されます。\n\n\n\n\n実際によく眠れなかったなと感じる時はこの睡眠スコアも悪いわけですが、継続的に統計をとることで、どれだけ寝ているのかあるいは無駄に長く寝ているのかということもわかります。また、最初に可愛いヒグマの絵が出ていますが、7日間連続で睡眠データが取れると、どの動物と似ているかというレポートを出してくれます（他に、サメ、ペンギン、フクロウ、コアラ、ヒツジがあるようです）。\n\n\n\n\nバンドを日中継続して着けておくことで、ストレスの状況や、夜中に目覚めた回数なども記録されています。寝る前の強度の高い運動も警告されます。\nまとめ以上、MI Band9の機能をレポートしてみましたが、いかがでしたでしょうか。厳しい暑さがようやく落ち着いてきた今から、少しダイエットなど取り組もうと考えられている方にはぴったりのデバイスだと思います。電池持ちも十分で小型であることに加え、シリコンバンドも柔らかいのでデスクワークでキータイプしていてもほとんど気になることはありません。\n結局のところ健康になるためには、お酒と間食を減らし、食事を決まった時間に摂り(※)、適度な運動が必要という結論に行き着くのですが、その支援ツールと考えれば費用対効果は高いと思われます。※ 日本の食事は炭水化物が多めですので糖質を摂りすぎと言われます。糖質カットは意識した方が良いでしょう。\n","categories":["SmartWatch"],"tags":["Xiaomi Smart Band 9"]},{"title":"マルチカレンシー口座 WISE","url":"/new-technology/2022/06/28/multi-currency-account/","content":"\n\nこの記事で実現すること\n\n最近の円安や物価高と慢性的な在庫不足によりIT機器も買いづらい状況が続いています。海外通販でパーツ等を購入する時、クレジットカードやPayPalを使われている方は自動で両替されるためあまり為替レートを意識することも少ないかもしれません。輸送コストに加え、この為替の両替手数料は意外とトータルコストに響きます。少しでもコストを抑えてショッピングできる、WISEデビットカードが便利です。カードを作るのに1,200円が掛かることと多少本人確認作業に手間は掛かりますが月額の口座管理料などは掛からないため持っておくと便利なカードです。外貨口座を持てるので、海外送金も廉価に行えます。アカウントを作るにはマイナンバーカードが必要です。\n\n\n匿名によるショッピングのメリットと為替手数料米国eBayをはじめとする海外の通販サイトでパーツやIT機器をショッピングされる方はPayPalを使っていらっしゃる方が多いのでは無いでしょうか。クレジットカードを使う際のトラブルなどを考えると、住所はともかく、クレジット番号を販売者に知られたくないというのはもはや基本事項になってきていると感じます。ApplePayの利用は海外では大きく売上を伸ばしていると聞きます。日本でも個人対個人における商取引のメルカリなどは住所や支払い口座など匿名が大原則ですね。\nPayPalはeBayをはじめ対応しているサイトが多く、日本国内、海外に限らずよく利用されます。しかしながらPayPalの場合は日本のユーザーだと円決済でPayPalが為替レートを提示し、そのレートで外貨に両替の上取引が成立します。この手数料が4％とかなり高額です。\nもちろん、商売でやっていることなので一定のフィーが掛かるのはわかりますが、そのコストをユーザーからわかりづらくして4％という高額な手数料を徴収するのは私は少し抵抗があります。また、海外サイトでの為替レートの提示は例えば130円&#x2F;ドルという我々が見慣れた表記ではなく、ドル&#x2F;円表記なので”0.00769”と提示されるため余計に分かりづらくなっています。\nドルの両替相場円からドルに交換した場合、有名なクレジットカード会社、Amazon.com、PayPal、Wiseと比較しています。\n\n\n\n両替会社\n手数料\nURL\n\n\n\n三井住友カード\n2.20%\nhttps://www.smbc-card.com/mem/service/sec/kaigai01.jsp\n\n\n楽天カード Mastercard\n1.63%\nhttps://www.rakuten-card.co.jp/overseas/payment/\n\n\n楽天カード Visa\n1.63%\n\n\n\n楽天カード JCB\n1.60%\n\n\n\nイオンカード Mastercard\n1.60%\nhttps://www.aeonbank.co.jp/aeoncard/use/shopping_w/\n\n\nイオンカード Visa\n1.60%\n\n\n\nイオンカード JCB\n1.60%\n\n\n\nPayPayカード Mastercard\n2.20%\nhttps://card.yahoo.co.jp/service/faq/04usage/oversea/1401.html\n\n\nPayPayカード Visa\n2.20%\n\n\n\nPayPayカード JCB\n1.60%\n\n\n\nAmazon.com\n1.45%\nYahoo  financeの週末レート(134.9600)とAmazon.comのCheckoutレート(136.9163950055)を確認（6&#x2F;18）\n\n\nPayPal\n4.00%\nhttps://www.paypal.com/jp/webapps/mpp/paypal-fees#no-fee\n\n\nWise\n0.60%\nhttps://wise.com/jp/pricing/card-fees?sourceAmount=100000&amp;sourceCcy=JPY&amp;targetCcy=USD\n\n\n10万円のものを購入して、Wiseでは約600円、2.2％のカード会社であれば約2,200円です。PayPalに至っては約4,000円にもなります。\nWise社とはWiseは、第二種資金移動業として関東財務局に「ワイズ・ペイメンツ・ジャパン株式会社」として登録されています。金融というよりはFintechの会社というところでしょうか。また、顧客から預かった資産は自己の資産とは分別して管理されています。\n\n金融庁　資金移動業社登録一覧 https://www.fsa.go.jp/menkyo/menkyoj/shikin_idou.pdf\n\nWise社はエストニア出身の二人が作った会社でロンドン証券取引所に上場しています。世界各国にWebサイトがあります。Wiseデビットカードを作ると200カ国で利用できます。このブログではその機能の一部、海外通販の決済についてしか触れませんが、海外のATMで外貨を引き出したり海外送金したり外貨を受け取ることができます。\n\nWisehttps://wise.com\n\n口座開設口座を作るのは無料ですが、実質的にデビットカードが必要ですので1,200円が掛かります。年会費は無料です。\n口座開設は本人確認が必要ですが、日本の金融機関と同じように、2つの本人確認、つまり、本人の証明と身元確認が必要です。日本の法律としては犯罪収益移転防止法と税法との関係で、マイナンバーカードが必要になります。本人確認はFintech企業らしく、eKYCで行われます。免許証・マイナンバーカードで犯収法の確認を行い、さらに税法上、マイナンバーの提出義務があります。この2つが身元証明です。そしてメモ紙に4桁の数字を書かされ、それを持った自分自身を写メし、画像をアップロードすることで間違いなく本人であることの証明が行われ、口座開設の本人確認が終了します。運転免許証で犯収法への確認はOKですが、税法上の理由で結局はマイナンバーカードが必要です。過去に発行されたマイナンバーの通知カードでは対応できません。\nマイナンバーカードの写メを撮ってアップロードしたり、4桁の数字を片手で持ってもう片手のスマホで写メを撮って海外企業に送るというのは、若干の抵抗はあります。が、今の日本の法律がそれを求めているので必要なことです。\nデビットカード口座開設が完了したら、まずは口座に入金が必要です。国内の指定された銀行口座に円で振り込みます。最低1,200円を振り込み、デビットカードの作成に進みます。クレジットカードとは異なり、後払いではなく事前入金が必要です。入金時は、振り込み名義人にWiseの口座番号を指定するのが必要です。これを行わず普通の仮名氏名で送ってしまうと入金確認に数日掛かってしまいます（私は最初これで数日掛かってしまいました）。通常は3時間程度で反映されます。\nまた米ドルやユーロなど使うと想定される口座を開ける必要があります。米ドル口座を開くと日本の金融機関では馴染みのない、個人のルーティングナンバーが付与され、米ドルの銀行口座として使用可能になります。海外で仕事をする時など、このルーティングナンバーを指定して振り込んでもらいます。海外通販の決済に使う場合はこのルーティングナンバーは使うことはありませんが、日本に居ながらここまでできるのは結構すごいことだなと感心しました。\nその後、マスターカードのアイコンがついたデビットカードが2〜3週間程度で届けられます。\n黄緑色のカードで表には識別する番号や名前などはありません。Mastercardのマークついており、裏面にはカード番号、名前が記入されています。\nさて、届いてすぐに使えるわけではなく、後払いのクレジットカードとは違い、まず円で入金しておかなければなりません。デビットカードを作るときに余分に円を入れておけばその金額分は普通にショッピングで使えます。Mastercardコンタクトレス、すなわちタッチ決済が使えますので、国内のコンビニでも気軽に使えます。\n最初に使うのにはお作法が必要で、指定のATMで残高照会をしてデビットカードを有効化する必要があります。以下のページにあるように、有効化には以下の場所で残高照会をする必要があります。\n\nイオン\nイーネット\nビューカード\nデイリーヤマザキ\n\n私はイオン銀行のATMで残高照会をしてみましたが使えないカードと言われてしまいました。。。結局ファミリーマートのATMのイーネットで残高照会をし有効化できました。残高照会時に照会する口座種別を聞かれたように記憶していますが、その際は「チェッキング」を選択します。チェッキングは決済用口座で一般的に決済用の用途で利用され、金利がつかない口座のことです。\n\nWiseデビットカードを有効化する方法 https://wise.com/ja/help/articles/2978024/\n\nその日のうちにコンビニでタッチ決済を使ってみましたが、利用の記録もアプリで確認できました。\nアプリと両替Wiseのアプリをスマホにインストールしておくと便利です。好きなタイミングで外貨に交換できます。円貨のまま保有していても通販で購入時にWise側で外貨に自動的に両替してくれるので便利です（特に割り増し手数料などはありません）。アプリは2要素認証に対応しており、Webログイン時にプッシュ通知で確認を求められるように設定できます。予め外貨に換えておく事も可能ですが、税金などについて確認されることをお勧めします。\n両替自体はマーケットレートを使って一瞬で交換が成立します（その時に手数料も差し引かれます）。\nなお、自動両替という機能もあり、レートを指定しておくと、そのレートになった時に両替してくれる機能もあります。\nネットショッピングでの使い方Amazon、eBay(PayPal)など外貨で決済を使うユーザーに最も適しています。\neBayの場合仮にConnect X-3をeBayで購入するとしましょう。\n\n\nカートに入れて…USDを選んで…\n\n\n確認、ここで気を付けてください！！「今すぐ支払う」をクリックしてはいけません。\n\neBayでドル払いと言いつつ、PayPalが円からドルに4％の手数料で両替し、円＋手数料をPayPalに払うことになってしまうんです。わざと目立たなくしている、「通貨オプションを表示」をクリックする必要があります。ここでは私が赤枠で囲っていますが、人間の目線をうまく回避するかのような絶妙な右側の外れた位置にポツンと円表記があります。\n\nこれは毎回「通貨オプションを表示」をクリックする必要があります。\nUSDをクリックして確実にWiseでドル払いにして決済します。\n\n\nAmazon.comの場合こちらも同じような状況です。ipolexの2PortのX710がありました。でも高いですね。。。4ヶ月前にX710の4Portが$500だったのに2Portで＄420です。。\n\n\nAmaon.comの場合は、普通にクレジットカードのようにカード番号を入力して購入します。私はドル払いでしかAmazon.comで購入したことはありませんが、デフォルトは円払いになっています。良い点は為替レートが良心的であることでしょうか。それでも約1.5％ですね。あとは1ドル137円という表記で多少は分かりやすいのが良いところでしょうか。\n\n\nこちらもドル払いに変更して、チェックアウトします。\nリスク便利なデビットカードによるショッピングですがデメリットもあります。一般的なクレジットカードに付帯されている海外通販などの保険がありません。Wiseの約款においてはショッピング保険などの対応は一切できないことが明確です。従い、多くのサイトでカード番号を入力せずに、信頼のおけるサイトやタッチ決済などのクレカ番号が相手に知られない決済方法に限り利用すべきでしょう。\n利用限度額Wiseのアプリでは利用限度額が設定できます。\n\nATM引き出し\nICチップ決済（暗証番号を使った決済）\n磁気ストライプ決済\nオンラインでの支払い\nコンタクトレス決済\n\nこれだけ細かく設定できればカード紛失を想定しあらかじめ設定しておけるでしょう。\nまとめ海外の色々なものが割高になっているので気軽に買い物できる状況には無いかもしれませんが、持っておいて損はないカードです。是非検討される事をお勧めします。\n"},{"title":"ESXiでネットワークカードのファームウェアを更新する","url":"/new-technology/2022/04/02/nic-firmware/","content":"\n\nこの記事で実現すること\n\nESXiにおいてネットワークカードの主要ITベンダーであるintelおよびMellanox(NVidia)のファームウェアをアップデートします。sshでESXiホストに接続したままアップデート可能です（作業中は何度かのシステムリスタートが必要になります）。\n\n\nネットワークカード自体の脆弱性（2023-3-5更新）2023-2-14にintelのサイトで700シリーズおよびE810シリーズでCVE-2022-36382の脆弱性について発表がありました。境界外への書き込みでサービス拒否に繋がるとの事（Base Score: 6.0 MEDIUM）です。\nその数日後の23-2-17に700シリーズでは新しいv9.2、およびE180シリーズではv4.2のファームウェアが発表されています。\n\nIntel® Ethernet Controllers and Adapters Advisory https://www.intel.com/content/www/us/en/security-center/advisory/intel-sa-00754.html\n\n\nIntel 700 nvmupdate v9.2 https://www.intel.co.jp/content/www/jp/ja/download/18638/non-volatile-memory-nvm-update-utility-for-intel-ethernet-adapters-700-series-vmware-esx.html?wapkw=nvm%E3%80%80update\n\n\nIntel E810 nvmupdate v4.2 https://www.intel.com/content/www/us/en/download/19624/non-volatile-memory-nvm-update-utility-for-intel-ethernet-network-adapter-e810-series.html\n\n\nNATIONAL VULNERABILITY DATABASE https://nvd.nist.gov/vuln/detail/CVE-2022-36382\n\n脆弱性対策情報データベースである、JVN iPdeiaでの検索では、2020年以降、Intel(R) Ethernet I210 Controller、Intel(R) Ethernet 700 Series Controller 、Intel(R) Ethernet Network Controller E810において脆弱性が発見されています。\n\nJVN iPdeia （”Intel Ethernet Controller”で検索）\n\n https://jvndb.jvn.jp/search/index.php?mode=_vulnerability_search_IA_VulnSearch&amp;lang=ja&amp;keyword=Intel+Ethernet+Controller&amp;useSynonym=1&amp;vendor=&amp;product=&amp;datePublicFromYear=&amp;datePublicFromMonth=&amp;datePublicToYear=&amp;datePublicToMonth=&amp;dateLastPublishedFromYear=&amp;dateLastPublishedFromMonth=&amp;dateLastPublishedToYear=&amp;dateLastPublishedToMonth=&amp;cwe=&amp;searchProductId=\nMellanox(NVIDIA)のネットワークカードについては脆弱性は見つかっていないようです。\nネットワークカード(NIC)の保守期限ESXiでのドライバはintelやMellanoxを使っている限りは最適なドライバがパッチ公開のタイミングで提供されます。但し、チップを動作させるネットワークカード上のファームウェアは別途NICの提供ベンダーからのパッチを適用する必要があります。ESXiのハードウェア互換リストでは古いネットワークカードでも対応している場合があります。しかし、ベンダー側でサポート終了（EOSL）となっている製品もあり注意が必要です。ビジネス用途でなければ使えるうちは使うといった対応が取れますが、万が一ファームウェアで脆弱性などが指摘された場合は、そのNICの利用を取りやめる必要が出てきます。\nintelのサポート終了NIC以下のリンクではintelの製造終了のNIC一覧情報があります。さらに5年経過でサポート終了という事です。X520やX540なども製造終了しており、5年間の保証ポリシーの対象となっています。\n\nintel\n\n https://www.intel.co.jp/content/www/jp/ja/support/articles/000026530/ethernet-products/legacy-ethernet-products.html\nしかし、X520とX540の新しいファームウェアのダウンロードについては見つかりませんでした。私の見落としでなければ、最新版のファームウェアの提示が無いというのはこれから新規導入する場合、リスクが大きく感じます。\nMelanoxのサポート終了NICMellanoxにおいても”Products End-of-Life Policy”というものがあり、販売終了から5年経過し、End of Supportとなるようです。以前にはEOSの製品一覧が記載されているExcelファイルが置いてあったんですが、最近は無くなってしまいました。\n最近は$40で購入できるMCX311A-XCATなどは2020年3月31日に販売終了となっています。Mellanoxの場合はVMwareの互換リストから外れているConnect X-3についてもWebにはファームウェアの情報が掲載されているので、いつでも最新のファームウェアに更新できます。\nintelのNICファームウェア更新intelの純正のNICであればそのカード名称でintelのサイトを検索しファームウェアを更新します。また、3rdベンダーがintelチップを採用し製造したNICだとintelのチップの名称でファームウェアをダウンロードする必要があります。「ESXI7.0をRyzen7 5700Gで構築」では、私は3rdベンダーが製造したintel X710を搭載したNICを購入したと書きましたが、このようなケースではintelが提供するファームウェアを適用可能なのか、それとも3rdベンダーが提供するファームウェアがあるのか事前に確認する必要があります。X710のSFP＋を4Portというのは低消費電力・低発熱で魅力的ですが、前述した脆弱性について既に確認していたため、ファームウェアのアップデートに言及できるベンダーのものを選定しました。販売者の中には「できるはずだがお勧めしない」という回答もありました。3rdベンダーの場合は、ファームウェアアップデートの設定ファイルの書き換えが必要な場合もあります（私の購入したNICはこの修正が不要でした）。\n導入はシンプルでnvmupdateというファームウェア更新ツールとセットになったNICのファームウェアをintelのサイトからダウンロードし、ESXiにSSHで接続し実行するだけです。留意点としては、誤った種類のファームウェア適用によりNICが使えなくなってしまった場合は自己責任であり、リスクはあります。\n導入手順を説明します。intelのサイトで”nvm update”を検索します。するとX550シリーズ、700シリーズ、E810シリーズとnvmupdateについて表示されるのでお使いのチップに相当するモジュールをダウンロードしてください。intel純正のカードであればカード名で検索も可能です。\n\nX550シリーズ\n\n https://www.intel.co.jp/content/www/jp/ja/download/19362/non-volatile-memory-nvm-update-utility-for-intel-ethernet-adapters-550-series-vmware-esx.html?wapkw=nvm%20update%20esxi\n\n700シリーズ\n\n https://www.intel.co.jp/content/www/jp/ja/download/18638/non-volatile-memory-nvm-update-utility-for-intel-ethernet-adapters-700-series-vmware-esx.html?wapkw=nvm%E3%80%80update\n\nE810シリーズ\n\n https://www.intel.co.jp/content/www/jp/ja/download/19628/non-volatile-memory-nvm-update-utility-for-intel-ethernet-network-adapters-e810-series-vmware-esx.html?wapkw=e810%20nvm%20update\nそれぞれのダウンロードページには、クイック使用ガイドというものがありますのでそこに詳細な手順が記されています。\n https://www.intel.co.jp/content/www/jp/ja/embedded/products/networking/nvm-update-tool-vmware-esx-quick-usage-guide.html\n700シリーズのファームウェア適用の実例です。まずNICのFirmwareを確認します。対象のNIC（vmnicx）を指定し内容を確認します。esxcli network nic get -n [物理NICのID]\n[root@esxi2:~] esxcli network nic get -n vmnic0   Advertised Auto Negotiation: true   Advertised Link Modes: Auto, 10000BaseT/Full   Auto Negotiation: true   Cable Type: DA   Current Message Level: 1   Driver Info:         Bus Info: 0000:01:00:0         Driver: i40en         Firmware Version: 8.50 0x8000b6c5 1.2074.0         Version: 1.11.1.31   Link Detected: true   Link Status: Up   Name: vmnic0   PHYAddress: 0   Pause Autonegotiate: false   Pause RX: true   Pause TX: true   Supported Ports: DA   Supports Auto Negotiation: true   Supports Pause: true   Supports Wakeon: true   Transceiver:   Virtual Address: 00:00:00:00:00:00   Wakeon: MagicPacket(tm)\n続いてダウンロードしたファイル（700シリーズは2023年3月5日時点では最新がv9.2です）をscpかストアブラウザを使ってESXi上にアップロードします。その後展開し実行します。特に注意点はありませんが、私は実行にあたりメンテナンスモードにして（VMを停止）から開始しました（アップデート中に、仮想マシンが止まるようなことはありませんが）。\n[root@esxi2:] tar -xvf 700Series_NVMUpdatePackage_v9_20_ESX.tar.gz#展開されたフォルダに入り以下を実行します。[root@esxi2:] ./nvmupdaten64e\n\n以下ではNICを全て対象、NVMイメージのバックアップは有りということで実行したログになります。\nIntel(R) Ethernet NVM Update ToolNVMUpdate version 1.39.32.6Copyright(C) 2013 - 2023 Intel Corporation.WARNING: To avoid damage to your device, do not stop the update or reboot or power off the system during this update.Inventory in progress. Please wait [****......]Num Description                          Ver.(hex)  DevId S:B    Status=== ================================== ============ ===== ====== ==============01) Intel(R) Ethernet Controller X710  8.112(8.70)   1572 00:001 Update    for 10GbE SFP+                                               availableOptions: Adapter Index List (comma-separated), [A]ll, e[X]itEnter selection: AWould you like to back up the NVM images? [Y]es/[N]o: YUpdate in progress. This operation may take several minutes.[....|*****]Num Description                          Ver.(hex)  DevId S:B    Status=== ================================== ============ ===== ====== ==============01) Intel(R) Ethernet Controller X710   9.32(9.20)   1572 00:001 Update    for 10GbE SFP+                                               successfulReboot is required to complete the update process.Tool execution completed with the following status: All operations completed successfully.Press any key to exit.[root@esxi2:~] reboot\n最後にリブートが必要とのことでリブートしています。\nホストが再起動後、ファームウェアが適用されているか再び確認します。\n[root@esxi2:~] esxcli network nic get -n vmnic0   Advertised Auto Negotiation: true   Advertised Link Modes: Auto, 10000BaseT/Full   Auto Negotiation: true   Cable Type: DA   Current Message Level: 1   Driver Info:         Bus Info: 0000:01:00:0         Driver: i40en         Firmware Version: 9.20 0x8000d8bc 1.2074.0         Version: 1.11.1.31   Link Detected: true   Link Status: Up   Name: vmnic0   PHYAddress: 0   Pause Autonegotiate: false   Pause RX: true   Pause TX: true   Supported Ports: DA   Supports Auto Negotiation: true   Supports Pause: true   Supports Wakeon: true   Transceiver:   Virtual Address: 00:00:00:00:00:00   Wakeon: MagicPacket(tm)\n\nFirmware Version: 9.20ということで、無事更新されました。\nintelの手順書では、NOTEとして、以下の説明があります。\n\nOn 700 Series and 500 Series devices, updating to the most current NVM (with the NVM Update Package) and driver does not update the Option ROM. Intel recommends an Option ROM update after the NVM and driver are updated. Refer to the User Guide for Intel® Ethernet Adapters page for the most current Option ROM update process version.\n\nこれはネットワークブート時のUEFI Network Driver Option ROMをLinuxまたはUEFIシェルを使ってUEFIネットワークドライバを更新するものです。今回はこの作業については割愛します。\nMellanoxのNICファームウェア更新Mellanoxの場合は、NVIDIAのサイトに”How-to: Install NVIDIA Firmware Tools (MFT) on VMware ESXi 6.7&#x2F;7.0.”というマニュアルがありますので、そこで手順を確認します。\n\nHow-to: Install NVIDIA Firmware Tools (MFT) on VMware ESXi 6.7&#x2F;7.0. https://docs.nvidia.com/networking/pages/releaseview.action?pageId=15049813\n\nNVIDIA Firmware Toolをダウンロードし、ESXiにインストールします。その後別途ファームウェアをダウンロードしてファームウェアのアップグレードを行います。昔はflintでしたが、上記手順によれば今はmlxfwmanagerというのが使われるようです。Windowsではそのサブセットのmlxupが一般的です。\n\nツールを2つダウンロードするために、ダウンロードページにアクセスします。\n\n http://www.mellanox.com/page/management_tools\n\nここの例ではESXi7.0向けのVersion4.18.1を使い進めます。\n“7 Native”、”x64”を選択し、”Mellanox-NATIVE-NMST_4.18.1.14-1OEM.700.1.0.15843807_19206114-package.zip”をダウンロードし展開します。\nZIPの中にはさらにZIPファイルがあり、”MEL_bootbank_nmst_4.18.1.14-1OEM.700.1.0.15843807.vib”というESXiのモジュールファイルを見つけます。 \n続いて、”Mellanox-MFT-Tools_4.18.1.14-1OEM.700.1.0.15843807_19206112-package.zip”をダウンロードし展開します。\nこちらもZIPの中にさらにZIPファイルがあり、”mft”というフォルダの中に”MEL_bootbank_mft_4.18.1.14-0.vib”のモジュールファイルを見つけます。別にOEMというフォルダがあり、NVIDIAの手順書でもファイル名からもOEMを選ぶべきのように見えますが、OEMのフォルダのものは必要なモジュールが見つかりません。\nscpかストアブラウザを使いこの2つのファイルをESXiにアップロードします。2つのモジュールは1つづつインストール、リブートが必要になりますので、&#x2F;tmpにコピーする場合は最初のリブートで&#x2F;tmpがクリアされるのでお気をつけください。\nESXiにSSHで接続し、最初のモジュール(NMST)をインストールします。esxcli software vib install -v /tmp/MEL_bootbank_nmst_4.18.1.14-1OEM.700.1.0.15843807.vib -f\n\n [root@localhost:/tmp] esxcli software vib install -v /tmp/MEL_bootbank_nmst_4.18.1.14-1OEM.700.1.0.15843807.vib -fInstallation Result   Message: The update completed successfully, but the system needs to be rebooted for the changes to be effective.   Reboot Required: true   VIBs Installed: MEL_bootbank_nmst_4.18.1.14-1OEM.700.1.0.15843807   VIBs Removed:   VIBs Skipped:\n\nここで一旦リブートします。\nSSHで接続後、2つ目のモジュール(MFT-Tools)をインストールします。esxcli software vib install -v /tmp/MEL_bootbank_mft_4.18.1.14-0.vib -f\n\n  [root@localhost:/tmp] esxcli software vib install -v /tmp/MEL_bootbank_mft_4.18.1.14-0.vib -fInstallation Result   Message: The update completed successfully, but the system needs to be rebooted for the changes to be effective.   Reboot Required: true   VIBs Installed: MEL_bootbank_mft_4.18.1.14-0   VIBs Removed:   VIBs Skipped:\n\n再びリブートします。\nESXiにインストールされているモジュールを確認します。esxcli software vib list 先頭に以下のモジュールがあるはずです。PartnerSupportedとなっており、セキュアブートのESXiでも問題ありません。\n\n  Name                           Version                                Vendor  Acceptance Level  Install Date-----------------------------  -------------------------------------  ------  ----------------  ------------mft                            4.18.1.14-0                            MEL     PartnerSupported  2022-03-13nmst                           4.18.1.14-1OEM.700.1.0.15843807        MEL     PartnerSupported  2022-03-13\n\nSSHで接続後、ツールの動作確認をします。ここではConnectX3がある環境です。cd /opt/mellanox/bin,./mst start,./mst status,./mst status -vv\n\n [root@localhost:/opt/mellanox/bin] ./mst startModule mst is already loaded[root@localhost:/opt/mellanox/bin] ./mst statusMST devices:------------mt4099_pciconf0mt4099_pci_cr0[root@localhost:/opt/mellanox/bin] /opt/mellanox/bin/mst status -vvPCI devices:------------DEVICE_TYPE             MST                           PCI       RDMA            NET                       NUMAConnectX3(rev:1)        mt4099_pciconf0               01:00.0   net-vmnic0ConnectX3(rev:1)        mt4099_pci_cr0                01:00.0   net-vmnic0\n\nファームウェアアップデートに使うmlxfwmanagerの動作確認をします。./mlxfwmanager --query\n\n [root@localhost:/opt/mellanox/bin] ./mlxfwmanager --queryQuerying Mellanox devices firmware ...Device #1:---------- Device Type:      ConnectX3 Part Number:      MCX311A-XCA_Ax Description:      ConnectX-3 EN network interface card; 10GigE; single-port SFP+; PCIe3.0 x4 8GT/s; RoHS R6 PSID:             MT_1170110023 PCI Device Name:  mt4099_pci_cr0 Port1 MAC:        0002c9xxxxxx Port2 MAC:        0002c9xxxxxx Versions:         Current        Available    FW             2.33.5220      N/A    PXE            3.4.0467       N/A Status:           No matching image found\n 今回のケースでは、ebayにて＄50で購入可能な、ConnectX-3（MCX311A-XCAT）を対象としています。\n\nNVIDIAのサイトからファームウェアをダウンロードします。　https://network.nvidia.com/support/firmware/firmware-downloads/\n該当するEthernetファームウェアを選択し、ZIPファイルをダウンロードし展開します。*.binというファイルが抽出されます。\n\n \n\n\nscpまたはストアブラウザでbinファイルをESXiの&#x2F;tmpにアップロードします。\nファームウェアのアップデートを行います ./mlxfwmanager -u -i /tmp/ファームウェア.bin。ファームウェアの実行直前に確認が求められるので、”y”を入力します。\n\n [root@localhost:/opt/mellanox/bin] ./mlxfwmanager -u -i /tmp/fw-ConnectX3-rel-2_42_5000-MCX311A-XCA_Ax-FlexBoot-3.4.752.binQuerying Mellanox devices firmware ...Device #1:---------- Device Type:      ConnectX3 Part Number:      MCX311A-XCA_Ax Description:      ConnectX-3 EN network interface card; 10GigE; single-port SFP+; PCIe3.0 x4 8GT/s; RoHS R6 PSID:             MT_1170110023 PCI Device Name:  mt4099_pci_cr0 Port1 MAC:        0002c9232da0 Port2 MAC:        0002c9232da1 Versions:         Current        Available    FW             2.33.5220      2.42.5000    PXE            3.4.0467       3.4.0752 Status:           Update required---------Found 1 device(s) requiring firmware update...Perform FW update? [y/N]: yDevice #1: Updating FW ...DoneRestart needed for updates to take effect.\n\nリブートします。\n再び、./mlxfwmanager --queryを実行し、ファームウェアがアップデートされたか確認します。\n\n [root@localhost:/opt/mellanox/bin]  ./mlxfwmanager --queryQuerying Mellanox devices firmware ...Device #1:---------- Device Type:      ConnectX3 Part Number:      MCX311A-XCA_Ax Description:      ConnectX-3 EN network interface card; 10GigE; single-port SFP+; PCIe3.0 x4 8GT/s; RoHS R6 PSID:             MT_1170110023 PCI Device Name:  mt4099_pci_cr0 Port1 MAC:        0002c9xxxxxx Port2 MAC:        0002c9xxxxxx Versions:         Current        Available    FW             2.42.5000      N/A    PXE            3.4.0752       N/A Status:           No matching image found\n\nまとめintelでは新しいファームウェアについて推奨と書かれる場合があり判断が難しいケースがありますが、脆弱性や製品の組み合わせなど問題が顕在化する環境に当てはまる場合のみ、新しいファームウェアを適用すべきでしょうか。ファームウェアとドライバーとの整合性もあるのでリリースノートを参照されることをお勧めします。\n","categories":["Hardware","Network"],"tags":["ESXi"]},{"title":"子供のスマホ・タブレットの使い方","url":"/new-technology/2022/01/29/parerentalcontrol/","content":"\n\n子供のスマホ・タブレットについては、未就学児・小学生低学年においては、親のものを使うケースが多いようです。そして、小学生の高学年以上ともなると子供のスマホ保有率も高まります。なお、本年4月より民法改正で18歳から大人になります。子供がスマホ・タブレットを使うリスクを踏まえた適切な利用の仕方を考えてみます。\n\n\n子供のスマホ・タブレット利用のリスク色々なニュースで子供のスマホ・タブレットの利用に関わるトラブルを耳にします。未就学児〜小学生低学年、小学生中学年、小学生高学年〜中学生とそれぞれの世代で問題となる内容は異なるようです。子供の成長に合わせて子供自身で出来ることが増えてくるため、年齢を重ねるたびに、結果的に抱えるリスクが増えます。総務省では「インターネットトラブル事例集（2021年度版）」として公開している情報があります。この事例集からトラブルを抜粋してみます。\n\n\n\n分類\n内容\n\n\n\n日常生活\nスマホの過度な使用による生活や体調への支障\n\n\n\nながらスマホが招いた自転車衝突事故\n\n\n\nメッセージアプリでの悪口・仲間外れ\n\n\n\n腕試しで自作したウイルスをネットに公開\n\n\n\n個人や学校などへの脅迫行為や犯行予告\n\n\n個人情報\n入力した個人情報の意図しない二次利用\n\n\n\nメールからの誘導によるフィッシング詐欺被害\n\n\n\n悪意あるWi-Fiスポットを利用したことによる情報流出\n\n\nネット取引\nフリマなどネットを介した取引によるトラブル\n\n\n著作権\n他者の権利を侵害する投稿・二次利用・ダウンロード\n\n\nゲーム\nゲーム上でのやり取りから生じたトラブル\n\n\nSNS\n悪ふざけなどの不適切な投稿\n\n\n\n投稿から個人が特定されたことによる被害\n\n\n\n旅行中の写真投稿や書き込みによる空き巣被害\n\n\n\n自画撮り写真の交換に端を発した脅迫被害\n\n\nネットのコミュニケーション\nコミュニティサイトなどでの未成年によるアプローチ\n\n\n\nアルバイト応募が招いた犯罪への加担\n\n\n\n心のよりどころだったSNS上の知人による誘い出し\n\n\n\nSNS等での誹謗中傷による慰謝料請求\n\n\n出典：総務省ホームページ（https://www.soumu.go.jp/main_content/000707803.pdf）\n上記以外にも、表面化しづらい以下のようなものがありますね。\n\n\n\n分類\n内容\n\n\n\n金銭的被害\nアプリに課金\n\n\n\n投げ銭（YouTubeスーパーチャットなど）\n\n\n健全性の問題\nスマホ・タブレットに多くの時間を費やす\n\n\n\n家族との会話がなくなる\n\n\n\nアダルトサイトや好ましくないサイトの閲覧\n\n\n子供のネット利用について子供のネット利用は以下のものが挙げられます。\n\n動画視聴\n知育アプリ・教育\nゲーム\nSNS\n音楽視聴\n情報検索（ニュース、ナビ）\n\n内閣府からは「令和2年度青少年のインターネット利用環境実態調査調査結果（速報）」が公開されています。 https://www8.cao.go.jp/youth/kankyou/internet_torikumi/tyousa/r02/net-jittai/pdf/sokuhou.pdf\n詳細は上記リンクを参照いただければと思いますが、低年齢層では親のスマホを利用させるケースが圧倒的に多いことがわかります。子供が成長するに伴い、上記リスクを踏まえるとどこかできちんと管理しなければならない時期が来ると考えられます。低年齢層では親と共用しているスマホ・タブレットがメインであっても、年齢と共に親と共用する比率が減っていきます（P10）。中学生ともなればほぼ子供専用のスマホを保有しているでしょうけれども、この資料を参考にどのタイミングで子供専用のスマホを持たせるべきかのタイミングがわかります。\n小学生高学年〜中学生になって個人のスマホを持つようになり、音楽視聴、SNS、情報発信など個人にフォーカスした利用が増加することになります。サービスの幅が広がり、コミュニケーション、課金、法律の理解に加えモラルと犯罪防止（身を守る）というテーマに親子でどう向き合うかが課題となります。個人中心になれば親の目も届かなくなります。このタイミングで様々なリスクが顕在化します。\n小学生の高学年までには自然に覚えていく事も多いでしょうが、親としてそれまでに徐々に学ぶ機会を与えてあげるべきではないでしょうか？\n低年齢層では親自身がIT機器やアプリに対する理解が必要となります。子供にできる事も少ないですが、リテラシーがない子供に能力以上の権限を与えないのは親の役目になります。\nまた、スマホ・タブレットの活用という考え方ではなく、緊急連絡の手段として子供にスマホを持たせるケースもあります。\n低年齢層（5歳〜8歳）への管理策&lt;低年齢層の子供への技術的対策&gt;\n\n親が認めたアプリのみ利用を可能にする\nスマホ・タブレットの利用時間を制限する\nSNSなど家族以外の知らない人とのコミュニケーションを制限する\n有料サービスなど課金の仕組みに制限をつける\nWeb閲覧はホワイトリストを利用する\n\n子供専用の端末を用意する場合はiOS・Android共にアプリケーションで対策が可能です（後述します）。実際には知育アプリやゲームのみを利用可能にし、メール、SNSは禁止にするという単純なルールでも良いですね。ただ難しいのはゲームの中に色々な人とコミュニケーションを取れるものがあるということです。この世代に家族以外とのコミュニケーションを取ることができるアプリは親がしっかりと確認し制限すべきでしょうか。そのうち知育アプリでも子供から課金して使いたいと言われる事もあるでしょう。その場合は親の判断が必要です。\nYouTubeはキッズ版がありますが、実際親が見せたい（ためになる）動画はキッズ版になかったりと理想通りにはなかなか上手く行かないようです。スマホのYouTubeアプリからリビングのTVに飛ばすことができるのでそれで（親が見せたい）動画を子供に見せることができます。ブラウザについては子供向けサイトなど決められたサイトのみの範囲であればホワイトリスト方式（親が認めたサイトのドメインを一覧化）で管理できます。なお、OSやアプリなどの仕組みでは管理できないものもあります。\n&lt;低年齢層の子供への運用的対策（例）&gt;\n\n1日で使う時間を相談して決める（体への影響を説明することが必要です）\n食事の時は使わない\n使う場所はリビングのみ\n外で使う時は親に確認する\n\nルールを決めたら、都度使っていい、よくないと判断・説明するより自主的な利用を促したいものです。 知育アプリであってもお金を払えば色々なものが追加で使えるというのがわかるようになっていきます。ただ、この頃の子供はブラウザの使い方や調べ方も良く分からないでしょうから親のスマホ・タブレットを貸与する方法でも十分運用は回ります。\n小学校に入ったら見守りを目的としてGPSで子供の居場所を確認したいニーズが出てきます。小学校ではスマホの持ち込みを禁止しているところもあり、小さいGPS機器、例えば株式会社ミクシィが提供している「みてねみまもりGPS」などの小さいGPS機器を持たせる方が使い勝手が良いと思われます。\n\n\n\nみてねみまもりGPS https://mitene.us/gps\n\n小学校3、4年（9歳〜10歳）への管理策ブラウザによる検索など、Webでの調べ物をするのであればブラックリスト方式、これは通信キャリアが提供する「あんしんフィルター」を活用できます。漢字の読みも含めて親がそばで使い方を教えてあげる必要があります。この辺りから道徳心や判断力を学んでいくことになりますし、親のスマホを貸与する方法では運用が難しくなってきます。情報発信は認めず、閲覧だけは認める事を前提に、調べる能力を養うことができます。記事の正確性以前にこの年代の子供には難しすぎることを一生懸命調べても逆効果な事もあります。これは親が教えていく以外ありません。まだ外へのスマホ持ち出しは早いかもしれませんが両親ともに共働きの場合は緊急連絡手段の電話として持つケースも出てくる頃でしょう。\n&lt;小学校中学年の子供への技術的追加対策&gt;\n\nあんしんフィルターを活用する\n\n&lt;低年齢層の子供への運用的追加対策&gt;\n\nアプリケーションの利用時間を把握する\nウェブ閲覧は親が一緒に手伝う\n\n既にキッズ版のYouTubeは見てもいないでしょうし、ブラウザに関してはホワイトリスト管理は煩雑すぎて運用が回らないのではないでしょうか。家族以外とのコミュニケーションは禁止しつつ、敢えて色々な事は教えない事も親の方針の1つでしょう。なお、TV番組「Why?!プログラミング」で有名なScratchも8歳以上が想定されています。コミュニティにアップして評価を受けたりできます。全てのやりとりを拒絶するというのは現代では難しくなっているように感じます。参考になるのは、「Scratchコミュニティのガイドライン」です。非常にコンパクトにまとめられていますが、「誰にでも敬意を持って接すること」、「安全を保つこと: 個人情報や連絡先を公開しないでください」、「役立つコメントをすること」など子供にとって大切なことが書かれており参考になります。\n\nScratchコミュニティーのガイドライン https://scratch.mit.edu/community_guidelines\n\n 他の子供よりも少し進んでいることになるかもしれませんが、リテラシーを学んでいくにはこの頃が良いのかもしれません。\n小学校高学年〜中学生（9歳〜14歳）への管理策、教育・啓蒙小学校高学年からいよいよ個人のスマホの活用が広がります。コミュニケーションは最初のうちは仲間内にとどめるべきと言われます。アプリやスマホ本体で制約はしつつも、この年齢になると重要なのは親子の信頼関係です。インターネットに向けて情報公開（発信）するにはまだ早いとも思われる場合、親が十分に関与してあげる必要があります。不正アクセスやフィッシング、著作権違反などありとあらゆるリスクを抱えます。色々な共通の趣味を持つ人たちとのつながりを求めるようになる時期ですが、犯罪や事故に巻き込まれないために親の指導が大切です。様々なインターネット犯罪について子供と話し合う必要が出てきます。この世代が一番難しいと思います。本来、中学生や高校生でゆっくりと友人とのコミュニケーションを学んでいく事がこの年代でスマホを保有することによって急に知識・能力以上の物を求められてしまうからです。\nもうこの頃には子供が見たいものと親が見せたいものとは一致しない事も多いでしょうか。\n低年齢層の頃はルールや安全管理措置に重点を置くことが大事でしたが、この頃からは、道徳心・判断力を身につけてもらう必要があります。親子ともに犯罪やトラブル事例集から身を守るために考えることが大事です。この世代の親ならば学校やPTAの会合で啓発や学習の機会もあることでしょう。子供は悪気はなくとも興味の方が勝ってしまう事もあるでしょうから、未使用のクレジットカードなどの保管場所にも気を使う必要が出てきます。これは親の暗黙のルールの一つとして考えたいものです。\n&lt;小中学生の子供への技術的追加対策&gt;\n\nキッズスマホ\n\n&lt;小中学生の子供への運用的追加対策&gt;\n\nニュースや様々な子供のネットに関する問題を親子で話し合う\n著作権、法律に関する知識をわかりやすい形で学んでもらう\nメールやSNSを始めるときはまずは友達など顔を知っている人間のみに限定する\nフィッシングや詐欺など犯罪に関する知識を学ばせる\n\nキッズスマホの代表格でもあるトーンモバイルは親が安心する機能が盛り込まれています。ただ中学生になると子供はiPhoneを欲しがるかもしれません。\n\nトーンモバイル https://tone.ne.jp/lp/a/b1.html\n\nある程度子供側の道徳心や判断力が高まったのであれば、子供のプライバシーにも配慮し、ブラウザのアクセス履歴を親がチェックする必要もないでしょう。\n高校生（15歳〜17歳）民法改正によって成人18歳への移行もあと2か月強ですが、正直、この年齢ならば親の制約というのも難しくなっているでしょう。働いていない高校生に課金を制約するのは子供も一定の理解を示すことと思いますが、18歳で大人の同意なしにスマホの契約が可能になります。高校生であっても自分で決定し、自己責任を持つことになります。これまで子供扱いだったものが高校3年生でいきなり大人の自己責任と言われても無理があります。言い方を変えると学ぶ機会が不十分であれば子供の自主性に任せるということはできません。\n成人18歳となり、今の高校生は起業やクレジットカードに興味がある一方、自己責任という重さも認識を持っているようです。金銭の使い方を身につける必要があり、投資の詐欺などから身を守る必要があるため、かなり短期間で学習する必要があります。大学進学を考えるとここに全てを集中するのは非常に難しい問題です。\n結局のところ、早めの教育機会を確保し、子供のリテラシーを向上させ無理なく大人になるための階段を用意してあげたいところです。\nもうここまで来ればビジネス（社会）と同じです。報告・連絡・相談、権利と義務。ルール遵守から行動規範への変化です。定期的に話し合い、必要に応じて改善を促すことになるでしょう。\nここまでの整理子供の成長の段階で、低年齢層の子供は管理中心に考えることになりますが、子供の成長とともに管理よりは学習、啓蒙が重要になってきます。子供への制約、管理だけを中心に考えていると後からが大変になりそうです。\n子供の端末を管理する低年齢層の時代から制約を主眼にするのではなく、子供に色々な発見の機会を与え自主的に行動してもらうためにも、子供専用端末を用意することを検討してみてください。子供が小さいうちであれば「こういうもの」として納得感は得られやすいですが、大きくなってからだと「権利が剥奪された」と感じてしまう可能性があります。繰り返しですがルールを明確にし子供に説明し、納得してもらいましょう。iOS、Androidそれぞれ操作方法は異なりますが、子供専用端末によって以下の事が管理できるようになります。\n\n親が認めたアプリのみを使用可能とする\n使用時間帯の制限が可能\nアプリ毎の利用時間を設定可能・利用時間の確認が可能\nブラウザはホワイトリスト、ブラックリストによる運用が可能\n親の判断で臨機応変に利用時間の延長が可能\n子供の居場所の確認\n\n基本的には親のスマホで子供の端末をコントロールします。アプリのインストールは以下の流れです。子供端末でアプリインストール→親の承認→インストール実行\n子供端末がAndroidの場合、親のスマホはAndoroidでもiOSでも可能です。子供端末がiOSの場合は、親のスマホはiOSが必要です。\n両方で共通ですが、Androidならば子供のGoogleアカウント、iOSならば子供のAppleアカウントを作成する必要があります。\n子供の端末がAndroidAndroidには古いタブレット・スマホでも利用可能なGoogleファミリーリンクというアプリがあります。これはタブレット・スマホを子供専用とし、親のスマホからコントロールするものです。\n\n\n個人的にはiOSよりもAndroidのファミリーリンクの方がより機能が分離されており使い勝手が良く感じます。\nAndroidhttps://play.google.com/store/apps/details?id=com.google.android.apps.kids.familylink\niOShttps://apps.apple.com/jp/app/google-family-link/id1150085200\nソフトバンクからYouTube動画が提供されていましたので紹介します。\n\nファミリーリンク 保護者さまの端末から設定する方法（12歳以下のお子さま用） https://www.youtube.com/watch?v=uCcaFvRyYlY\n\n\n\n\nファミリーリンク 保護者さまの端末から設定する方法（13歳以上のお子さま用） https://www.youtube.com/watch?v=rFO-nXEnC-Y\n\n\n\n子供の端末がiOS\nApple 「iPhone、iPad、iPod touch でスクリーンタイムを使う」 https://support.apple.com/ja-jp/HT208982\n\niOSの場合はアプリのインストールは不要です。まず、子供のAppleアカウントを作成し、iOSに子供のアカウントでログインします。また親のスマホで設定のファミリー共有から子供のアカウントをファミリーに加えます。その後、子供端末の設定からスクリーンタイムを選び、設定します。\n使い方の一例ブラウザのホワイトリスト低年齢層の子供に見せたいサイトをブックマークなどして使えるようにし、他の難しすぎるサイトは許可しないとする場合、都度ホワイトリストのURLを更新する必要があります。この場合は、以下の使い方で効率よくホワイトリストが加えられます。\niOSの場合 AirDropを使う iOSの場合は親のスマホなどで見せたい（許可したい）URLがあれば、それを子供の端末に向けてAirDropします。子供端末のSafariで開き、その時に「以下のページは制限されているのでブラウズできません」という表示とともに「Webサイトを許可する」リンクもあるのでそちらをタップします。 その後、スクリーンタイム・パスコードの4桁の数字を入力し、許可します。\n Androidの場合  Googleチャット（旧ハングアウト）などのチャットツールを使う  URLなどを親の端末から子供の端末に送り、そこからChromeなどでアクセスします。子供の端末から親のスマホへの閲覧リクエストが送られ、親のスマホでドメインを許可するようになります。\nなお、iOS、AndroidともにWebサイト単位の許可となりURLパラメータまでは含まれず、YouTubeの個別の動画を指定するということはできません。しかし、実運用としては、このホワイトリスト管理はかなり大変です。キャリアが提供する「あんしんフィルター」や「iフィルター」などの有償ソフトウェアで管理に任せるという考え方も現実的でしょうか。\n\niフィルター https://www.daj.jp/cs/purchase/#md\n\n家族のメッセージやビデオチャットiOSの場合 スクリーンタイムでFaceTimeやMessageについて連絡先に登録されている人のみに絞ることができます。\nAndroidの場合 前出のGoogleチャット、Google Meetでビデオ通話ができます。明確に相手を絞ることは難しいようですがGoogleアカウントをネットなどで公開していなければそう問題になることはないと考えられます。\n ゲームはゲーム機として、スマホ・タブレットは学習の道具というイメージを子供に持ってもらう方法も良いのではないかと思います。私は家族のコミュニケーションはAmazonのエコーショーを使っています。遠方の家族ともビデオチャットができます。「アレクサ、●●さんに電話して」の呼びかけは低年齢層の子供、高齢者にも扱いやすく、高齢者の見守りと低年齢層の知育とが両立できます。子供が留守番というシチュエーションでも親のスマホのアレクサアプリから自宅のエコーショーにビデオ通話ができますし、その逆も可能です。留守番をしている子供は親の顔を見て話ができるので安心感が得られます。\n\n\n利用時間の延長例えば、平日は2時間以内、休日は4時間以内としつつも、祭日や少し多く使いたい場合があるケースなど延長が可能になります。iOSではあらかじめ決めた子供の端末上で4桁のパスコードで許可します。Androidは親のスマホで6桁のワンタイムパスワードを使って子供の端末を操作可能です。\nAndroid固有の情報\nAndroidは何故かアプリのアンインストールが許可なしで実行できてしまいます。セキュリティソフトをアンインストールされると困りますね。\nAndroidでは管理者の他に1名保護者が設定できます。従い、夫婦で子供のリクエストを承認できます。\n\nSophos Firewallを利用する子供のWeb閲覧のフィルタリングのためにこのブログで紹介しているSophos Firewallを使うこともできます。ただし、子供のWebアクセスのフィルタリングの目的だけにFirewallを導入するのはハードウェアの用意など大掛かりすぎますので、iフィルターの方が現実的です。既にSophos Firewallを導入されている方は設定してみる価値はあります。\n「Sophos Firewallの導入」\nかなり細分化されたリストになっていますが、これでもある程度絞り込んでいます。ここからさらに許容するものを選択から外します。\n\n\n\nカテゴリ\n説明\n\n\n\nAdvertisements\n広告画像やポップアップ広告などを含むサイトです。\n\n\nAlcohol &amp; Tobacco\n酒や煙草の売買を促進するサイトです。\n\n\nAnonymizers\nURL 変換を行うサイトです。プロキシサーバーを経由せずに URL にアクセスするため、未承認のアクセスが発生する可能性があります。\n\n\nAuctions &amp; Classified Ads\n個人向けに物品やサービスの宣伝や取引に関するサービスを提供するサイト。\n\n\nBusiness Networking\nビジネスや仕事に特化した SNS のサイトです (LinkedIn など)。\n\n\nCRL and OCSP\n証明書失効サービス。\n\n\nCommand &amp; Control\n感染したマシン上の悪意のあるソフトウェアからのコマンド＆コントロール (C2) 通信で接続されたサイトおよびトラフィック。\n\n\nControlled substances\nマリファナ以外の法規制によって制御や規制が行われている薬物に関する使用、取引、製造に関する情報や宣伝を行っているサイトが含まれます。\n\n\nCriminal Activity\n錠破りや窃盗をはじめとする違法行為や、自殺の方法を紹介するサイトです。\n\n\nExtreme\n暴力や傷害 (自傷を含む) を主とするサイト。死体や傷、グロテスクなイメージや恐怖感を呼び起こす描写を含むものです。ただし、ニュース、歴史的事件、報道事件は除きます。\n\n\nFinancial services\n金融サービス、経済、経理など金銭に関わる情報を提供するサイト。国民保険、国際保険、その他の保険に関わる情報を提供するサイトも含みます。\n\n\nGambling\nギャンブルに関する情報を掲載したり、オンラインギャンブルを促進するサイトです。\n\n\nGames\nゲーム情報を提供するサイト。ビデオゲーム、コンピュータゲーム、ロールプレイングゲーム、オンラインゲームなどが含まれます。\n\n\nHacking\n不正アクセスを助長するサイト。コンピュータや通信機器、ソフトウェア、データベースへの違法アクセスに関する情報を含みます。\n\n\nHunting &amp; Fishing\n残酷な画像を含む可能性のある狩猟や釣りなどに関する専用のサイト。\n\n\nIntolerance &amp; Hate\n人種差別や男女差別などを助長するサイトです。\n\n\nJobs Search\n就職活動や転職活動をサポートする情報を提供するサイトです。\n\n\nLegal highs\n規制されていない麻薬的物質の栽培&#x2F;取引&#x2F;使用に関する情報を提供するサイトです。\n\n\nLive audio\nインターネットラジオやインターネットテレビ番組を配信するサイトです。\n\n\nLive video\nイベントやプログラミングに関するライブ動画のストリーミングを提供するサイト。\n\n\nMarijuana\n違法ドラッグの栽培、調合、使用についての情報を提供するサイトです。\n\n\nMilitancy &amp; Extremist\n反政府的な思想や行動を主導・主張するグループの情報を提供するサイトです。\n\n\nMilitary\n軍隊および関連機関が提供するサイトです。\n\n\nNGOs &amp; Non-Profits\n非政府組織によるコンテンツを含むサイトです (非営利団体、労働組合、支援団体など)。\n\n\nNudity\nヌードやセミヌード写真を提供するサイト。過度な性的表現を含むものは除きます。映画俳優やモデル、ヌードアートや写真を含みます。\n\n\nOnline Chat\nWeb チャットサービスを提供するサイトや、HTTP&#x2F;IRC　経由でのチャット情報を提供するサイトです。\n\n\nOnline Shopping\n一般消費者向けのオンラインショッピングサイト (性的なもの、下着、水着、投資、薬品、教育、コンピュータのソフトウェア&#x2F; ハードウェアは除きます)。ショールームや、一般消費者向け店舗のサイトも含みます。\n\n\nParkedDomain\nドメインを取得後、コンテンツがアップロードされていない未完成のサイトです。アクセスすると、検索エンジンやポータルページにリダイレクトされることがあります。\n\n\nPeer-to-peer &amp; torrents\nBittorrent などの P2P テクノロジーを使用して取得できるコンテンツへのリンクを提供するサイトです。業務に関連のない帯域幅の大量消費や IP &#x2F; 著作権侵害を阻止できます。メッセージや写真の投稿を通じ、他のユーザーと気軽にコミュニケーションできるサイトです。\n\n\nPhishing &amp; Fraud\n悪質な目的で個人情報 (名前、住所、クレジットカード番号、学歴、スケジュールなど) を収集するサイトです。\n\n\nPro-Suicide &amp; Self-Harm\n自殺、自傷行為を促す内容を提供するサイト。\n\n\nRadio &amp; Audio Hosting\n音楽検索サービスを提供するサイトです。\n\n\nReal Estate\n不動産の売買・賃貸情報や住宅ローン情報を提供するサイトです。\n\n\nRestaurants &amp; Dining\nレストランなどの外食を促進するサイト。予約サービス、レビュー、おすすめ情報などを含みます。\n\n\nSex Education\n性教育に関する情報や、性の悩みを解決する薬品を提供するサイトです。ポルノ的なコンテンツは除きます。\n\n\nSexually Explicit\n18歳未満にはふさわしくないアダルト向けコンテンツのうち、Porn、Nudity、SwimwearAndLingerie、SexHealthAndEducation、HealthAndMedicines に該当しないサイトです。\n\n\nSocial Networking\nメッセージや写真の投稿を通じ、他のユーザーと気軽にコミュニケーションできるサイトです。\n\n\nSpam URLs\n一方的なスパムメールに含まれる URL です。これらの URL のコンテンツには、製品を売り込む目的のものから、詐欺などの不正なサイトまでがあります。\n\n\nSpyware &amp; Malware\nユーザーが気が付かないようにソフトウェアのダウンロードを行うサイトまたはページ (簡単なユーザー認証を除く)。\n\n\nStocks &amp; Trading\n株式市場、株式売買に関する情報やチャート、フォーラムを提供するサイトです。オンライン株取引や証券会社のサイトも含みます。\n\n\nSwimwear &amp; Lingerie\n下着&#x2F;水着のモデルや雑誌のサイトです。ヌードや性的なものは除きます。アート的な大人の画像や、下着のショッピングサイトを含みます。\n\n\nUnauthorized Software Stores\nモバイル機器&#x2F;コンピュータ向けに、違法な可能性があるソフトウェアやアプリを提供しているサイトです。\n\n\nVideo hosting\n動画検索サービスを提供するサイトです。\n\n\nWeapons\n武器に関する情報を提供したり、売買をサポートするサイトです。\n\n\nWeb E-Mail\nWeb メールサービスを提供するサイトや、メールサービスに関する情報を含むサイトです。\n\n\n\n上記はSophosのサイトより引用「Sophos XG Firewall: Web カテゴリ」 https://support.sophos.com/support/s/article/KB-000038862?language=ja\n\nSophos Firewallでは子供の端末をIPアドレスで特定した上で、Sophos FirewallのWebポリシーで設定し、Firewallルールを記述することになります。\nまとめホワイトリストや都度アプリのインストールなど、親の方がそれなりに時間を使うことを覚悟しないとなかなかこの運用は難しいとも感じます。しかし自分の子供があまり素性の良くないアプリを入れることを友達から勧められた場合、親の承認が必要だからと断る事も可能になり、制約が長所になります。\n小さいうちに野放しだったものが、大きくなってからいきなりスクリーンタイムを親が一方的に設定すると子供にはネガティブな感情が生まれ、回避する方法を探します。 Web上には不満とともに回避する方法を探す投稿なども見かけます。ITの仕組みはフェールセーフくらいに考え、対話を重ねることが何よりも大事と考えさせられます。\n","categories":["Security"]},{"title":"XG Firewall自身を防御する","url":"/new-technology/2020/06/24/protect-xg/","content":"この記事で実現すること\nホームユーザー向けにXG Firewall自身を防御する、ベストプラクティスとなる設定をします。\n\n\nBest practices for securing your firewall2020-6-24にSophos Communityのお勧め記事に「Sophos XG Firewall: Best practices for securing your firewall」というタイトルの文書が投稿されました。以下の記載があります。\n\nこのドキュメントの焦点は、Sophos XG Firewallを最低限のレベルでセキュリティを確保するための基本的なガイダンスを提供することです。この文書では、内部ネットワークデバイスやリソースを保護する個々のファイアウォール機能についてのガイダンスは提供しません （詳細な Sophos XG Firewall ベストプラクティスガイドは後日公開される予定です）。\n\n\n\n「XG Firewall v18の設定におけるベストプラクティス」で記載した通り、ルールやポリシーについてのベストプラクティスを記載していますが、将来Sophosから詳細なベストプラクティスガイドが公開されるとの事です。今回公開されたものはルールやポリシーではなく、運用について記述されたものであり、どのようにしてFirewallを守るかに言及されています。IPSの設定については、過去記事をアップデートしています。\n\nSophos XG Firewall: Best practices for securing your firewall https://community.sophos.com/products/xg-firewall/f/recommended-reads/121461/sophos-xg-firewall-best-practices-for-securing-your-firewall\n\nFirewall自身のセキュリティ強化まずこのガイドの先頭には以下の説明があります。\n\n管理者は、ファイアウォール自体の安全性を確保する前に、内部ネットワークやリソースを保護するために、ファイアウォールの機能や機能を設定することに集中してしまうことがよくあります。\n\nこれはご指摘の通りで、確かにXG自身にログインするパスワードもLAN内からのアクセスだからという理由で単純なパスワードにしがちです。業務で利用するほど厳格では無いにせよ、ホームユーザーとしてもFirewall自身の管理をしっかりと行うべきです。具体的なドキュメントについては、上記のページにあるPDFを参照いただくのが一番ベストですが、ここではホームユーザーにとって重要と思われるものを紹介します。\nローカルサービスACLXGの左ペインメニューの管理の”デバイスのアクセス”でWANなど外部ゾーンからのすべてのサービスを削除します。使わないサービスはオフにするのが原則であり、SSHを利用しないのであればLANゾーンのSSHもオフにしてしまうのがお勧めです。\n\n\nこのSophosのドキュメントではSSHのために、公開鍵認証を行う事を勧めています。もし、LANやVPNからSSHを使うのであればこのデバイスのアクセスの画面の下部に管理者の公開鍵認証の項目があるので、そこで公開鍵を追加できます。\nDDoS防御これまでも特にDDoS防御については説明してきていませんでした。ホームユーザーには不要と考えているためです。ping関連のDDoS防御の勧めが記述されていますので紹介します。しかしこの設定を行うとダウンロードのスループットが低下するので確認しながら利用の判断可否が必要です。XGの左ペインメニューの侵入防御の”DoS／スプーフ防御”のタブにてICMP&#x2F;ICMPv6フラッドの項目を以下の図のように設定します。\n\n\nこのドキュメント上で”XG550”、”XG650”および”XG750”のハードウェア提供モデルのDDoS防御の設定が記載してありますが、XG Home（ソフトウェアバージョン）はこのDDoS防御の機能は持っていません。\n管理者IDXGの左ペインメニューの管理の”管理の設定”で以下のように管理者のログイン失敗時のブロック、パスワードの複雑性の登録を行います。新しい管理者アカウントを作成し、2要素認証の設定は可能ですが、デフォルト管理者のadminアカウントは無効に設定できません。業務上利用する場合は担当者が変わる場合など意味がありますが、ホームユーザーが利用する場合は定期的なパスワード変更も不要であり、2要素認証の設定は現時点ではあまり魅力はありません。adminアカウントの無効化対応を期待します。\n\n\n「XG Firewallの通知設定を行う」で記載した通り、通知設定を行う事でログイン失敗の状況も迅速にキャッチが可能です。\nHotFixの自動インストールXGに脆弱性が見つかった場合に、過去の事例では極めて迅速にパッチが自動適用されます。具体的には下記の図のように、左ペインメニューのバックアップ＆ファームウェアの”ファームウェア”タブの画面にある、”ホットフィックスの自動インストールを許可する”にチェックが付いている事を確認してください。\n\n\nまた、定期的な設定のバックアップが推奨されています。このバックアップ＆ファームウェアメニュー上でのバックアップを取得されると共に、仮想環境をお使いの方は仮想環境上でのバックアップを取得される事をお勧めします。\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"PC（ハードウェア）の準備","url":"/new-technology/2020/02/25/provision/","content":"ネットワーク構成Sophos Firewall(XG Firewal 以下、XG)を導入した場合のネットワーク構成は以下の図のようになります。一般的にはプロバイダーから貸与されるホームゲートウェイ（外側の光モデム等は省略）に直接PCを繋ぐか、ホームゲートウェイの無線機能でPCやスマホを接続する事になります。XGを導入する場合は、ホームゲートウェイとPCの間にXGを挟み込む形になります。\n\n \n\nこの構成はXGのWAN側とXGのLAN側と2つのネットワークを持つ事になり、XGには2枚のネットワークカード（以下、NIC）あるいは、2つ以上のPortを持っているNICを1枚用意する事になります。XGのWAN側のインタフェースは、ホームゲートウェイからDHCPでプライベートIPアドレスやDNSを割り当てられます。そして、LAN側のPCやスマホのために、XGはあらかじめユーザが決めたプライベートネットワークアドレスを割り当てます。XGはこのIP割り当てのためのDHCP機能やDNS機能を持っています。また、スマホのネット接続のために無線ルータを別途用意する必要があり、この場合は無線ルータをブリッジモードでセットアップする事になります。\nハードウェア構成の検討上記の構成のために、2つのネットワークPortを持ったPCが1台必要になります。XGの制約としては、6Gbyteのメモリ上限とCPUが4coreまでとなります。物理サーバにそのままXGをインストールしても良いし、ESXi等の仮想ソフトの上にVMを構築しても良いです。ESXiの場合は、ハードウェア互換が厳しいため、本質的には互換リストを元にハードウェアの互換性を事前に確認します。\n\nVMware Compatibility Guide https://www.vmware.com/resources/compatibility/search.php\n\nネットワークカードを検索する場合は、検索カテゴリにI/Oデバイス、I&#x2F;OデバイスタイプにNetworkを選択します。お目当ての製品がある場合は製品名を入力し検索すると良いでしょう。\nただし、法人向けの要素が強く個人が利用するデバイスがあまりリストされていません。CPUおよびネットワークカードはintel製が比較的認識しやすいという傾向があります。一般的には、以下のものが安全策で好まれるようで、私も昔はこのNICを2枚差してXGを使っていました。また、ストレージについてはESXi6.7からはsataのSSDで認識しないというのは少ないようですが、M2.NVMeは対象が絞られます。\n\nインテル® ギガビット CT デスクトップ・アダプター https://www.intel.co.jp/content/www/jp/ja/products/details/ethernet/gigabit-network-adapters/gigabit-ct-desktop-adapters.html \n\n2022年2月までは以下の10GbpsのNICをESXiで使っていました。\n\nインテル® イーサネット・コンバージド・ネットワーク・アダプター X550 https://www.intel.co.jp/content/www/jp/ja/products/details/ethernet/gigabit-network-adapters/gigabit-ct-desktop-adapters.html \n\nこのNICだと、1つのPCI Expressバスにこのカード1枚を刺し、WanとLanのインタフェースを用意できます。\n（2022-3-25更新）最近、Ryzenでマシンを一新しました。NVMeも動作させており、ネットワークカードはX710に変えました。参考までにこちらの記事も参照して下さい。\nESXI7.0をRyzen7 5700Gで構築\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"安全快適にリモートワークを行う","url":"/new-technology/2020/08/14/remote-work/","content":"\n\n安全快適な在宅勤務を行うためにすっかり在宅勤務が新たな日常として定着しつつありますが、2020-07-01にICT-ISAC（アイシーティ・アイザック）から「家庭内で安全快適に在宅勤務を行うためのリファレンスガイド」が公開されています。ICT-ISACは、サイバーセキュリティに関する情報収集・調査・分析等の業務を行っている組織で、IPA情報処理推進機構と同様に、情報セキュリティについて分かり易く記事が掲載されています。ガイドの詳細は、以下の記事を参照してください。\n\nICT-ISAC（アイシーティ・アイザック） https://www.ict-isac.jp/index.htmlIPA情報処理推進機構 https://www.ipa.go.jp家庭内で安全快適に在宅勤務を行うための リファレンスガイド https://www.ict-isac.jp/news/remote%20work%20reference%20guide.pdf\n\n\n在宅勤務のための技術的要件上記のリファレンスガイドは、大事な会議の内容を家族などに聞かれないなどの体制面の話と、Wi-Fiルーターの設定などの技術面の2つを両立する必要があります。会社のノートPCを貸与され、自宅の無線ルーターおよびインターネット回線を用い、VPNで会社に接続するのが一般的な形態ではないでしょうか。ここでは技術的要件として、セキュリティ上安全である事を筆頭に、大事な会議中に無線が切断されてしまう事の無い安定したリモートワークを実現するための無線ルーターの設定やソフトウェアなどの活用について紹介します。\nまず、上記のリファレンスをチェックシートにすると以下の内容となります。\n\n\n\n要件\n対応方法\n\n\n\nP6自宅のルーターの管理画面や機器がインターネットから見えていないこと\n（1）無線ルーターについて\n\n\nP8自宅のルーターの管理画面のパスワードを適切に設定しておく\n（2）パスワード管理ソフトの導入\n\n\nP9自宅のWi-Fiネットワークのセキュリティを適切に設定する\n（1）無線ルーターについて\n\n\nP12パソコンの共有設定を確認しておく\n（1）無線ルーターについて\n\n\nP13自宅のLANに接続されている機器を確認しておく\n（4）ネットワークチェックツールの利用\n\n\nP15すべての機器のファームウェアを更新する\n（1）無線ルーターについて\n\n\nP16すべての機器に対して適切なパスワードを設定する\n（2）パスワード管理ソフトの導入\n\n\nP18パソコンに接続されたマイクやカメラの状態を意識する\n（3）セキュリティ対策ソフトの導入\n\n\nP20利用機器のサポート体制を確認する\n（1）無線ルーターについて※メーカーWebサイトの確認\n\n\n（1）無線ルーターについて無線ルーターの設定のポイントは上記で示すようにたくさんあります。無線ルーターは毎年規格が新しくなっていくもので、耐用年数もPCなどと比較し、寿命が短いと言えます。\n\nルーターの設定画面がインターネットから見えていないこと\nWi-Fiネットワークのセキュリティを適切に設定する\n利用機器のサポート体制を確認する\n\n上記の1点目はデフォルト設定で特に問題は起きない内容ではあります。ルーターの設定画面についても、業務用ルーターを間違った使い方をしない限りは発生しないものです。Wi-Fiのセキュリティについて、WPA2も一時は脆弱性で話題となりましたが、最近発売されているルーターはきちんと対応がなされています。しかし、過去に販売されているものを継続して使っている場合はサポートが切れていないか確認が必要です。サポートが切れている機器はセキュリティ事故が発生する前に、速やかな交換が必要です。Wi-Fiセキュリティについて、最近はWPA3に対応した製品も発売されています。WPA3&#x2F;WPA2と併用できる設定もありますが、脆弱性の対応がなされているWPA2（AES）であれば無理をしてWPA3を併用する必要はありません。Apple社のWi-Fiアクセスポイントに関する推奨としては、WPA3→WPA3&#x2F;WPA2（AES）併用→WPA2（AES）の順に推奨されています。詳細は以下を参照してください。\n\nNECプラットフォームズ：【重要】「WPA2」の脆弱性に関するお知らせ https://www.aterm.jp/product/atermstation/info/2017/info1018.htmlバッファロー：無線LAN商品のWPA2の脆弱性について https://www.buffalo.jp/news/detail/20171017-01.htmlApple -Wi-Fi ルーターと Wi-Fi アクセスポイントの推奨設定- https://support.apple.com/ja-jp/HT202068\n\n機器のファームウェアを更新する国内の無線LANの有名メーカーでは、ファームウェアは自動更新する方式に変わってきています。もし無線ルーターを買い換えるのであれば自動更新機能がついた機器を購入される事をお勧めします。過去の発売された無線ルーターもファームウェアの更新で、自動更新モードが加えられるケースもあります。脆弱性対応のために自動更新を設定する事をお勧めします。\n「ご家庭でWi-Fiルーターをより安全にお使い頂くために」というタイトルで、Wi-Fiルーターを利用する上での注意喚起が公開されています。提言しているのは以下の4社です。ITリテラシーの啓蒙だけではなく、こういう形でメーカー自らが主導する取り組みは素晴らしい事です。詳細は以下を参照してください。\n  ・株式会社アイ・オー・データ機器  ・NECプラットフォームズ株式会社  ・エレコム株式会社  ・株式会社バッファロー\n\n一般社団法人デジタルライフ推進協会-ご家庭で Wi-Fi ルーターをより安全にお使い頂くために- https://dlpa.jp/pdf/dlpa_pr_20191218.pdfNECプラットフォームズ：【重要】Wi-Fiルータをより安全にお使いいただくためのお願い https://www.aterm.jp/product/atermstation/info/2019/info1218.htmlバッファロー：Wi-Fiルーター&#x2F;中継機を最新のファームウェアに更新する方法（ファームウェア自動更新機能を利用） https://www.buffalo.jp/support/faq/detail/15923.html\n\nパソコンの共有設定を確認する会社から貸与されたPCを使う上でのポイントを記載します。会社が貸与するPCは流石にセキュリティ対策もしっかりしたものが行われていると考えられますが、完全にそれを信頼するわけにはいきません。逆もまた然りで、個人の利用するPCが会社の貸与PCに対しての脅威となる可能性があります。パソコンの共有設定を制限する代わりに、ゲスト用の無線APに接続する事で対策が可能となります。バッファローでは”ゲストポート”、NECプラットフォームズでは”ネットワーク分離機能”と呼ばれます。有線接続を含めた個人の機器へ一切アクセスさせずにインターネットの接続が可能となります。\n無線ルーターのチェックポイント価格．COMの無線LANルーター(Wi-Fiルーター) 人気売れ筋ランキング2022年3月によれば、人気のある無線ルーターは、バッファロー、NECプラットフォームズ（Aterm）などの国内製品が上位20位までに19がランクインしています。私見ですが、少しでも安定稼働、安全に利用するためのポイントを記載します。\n\n無線LANのAPモードにでは、固定IPを振る無線LANをAPモードにする場合は親機やプロバイダ貸与のHGWからのDHCPによってIPを割り当てられますが、固定IPとする方が瞬断などの不具合の可能性を下げられます。\n\nWi-Fiの5GHzはW52固定を利用する気象レーダーや軍事レーダーの影響でW53およびW56は1分間無線の出力を停止してしまう可能性があります。大事な会議では致命的です。自宅がレーダーの影響を受けないと確認できていれば気にする必要はありません。無線チャンネルが自動選択の場合（Atermではオートチャネルセレクトと呼ばれます）も瞬断の原因になりやすいため、使わない方が無難です。また最新の高性能ルーターでは160Mzhのオクタチャンネルで高速化を図る製品も出ていますが、これもW52の4チャネルでは不足し、他のチャネルを併用することになります。つまり、レーダーの影響を受ける事になるため、W52のクアッドチャネルまでに留めておいたほうが無難です。\n\n暗号キーの自動更新間隔について設定画面で暗号キーを一定間隔で更新するという機能があり、更新間隔の設定項目があります。基本的にビジネスで利用するアプリケーションは殆どがユニキャスト通信（1対1の通信）で、これの暗号キーはフレーム単位に鍵を変化させており、この設定間隔とは関係ありません。但しブロードキャストおよびマルチキャストのような1対1通信ではない場合は、1フレーム毎に変更というわけにはいかず、暗号キーを一定期間で更新する仕組みを取っています。従い暗号キーを一定間隔で更新しない事が即座に脆弱性となるわけではなく、ネットワークが混乱しないようにする仕組みと考えた方が良いようです。バッファローの初期値は0（更新しない）、Atermは30分となっています。ビジネス用途ではありませんが動画配信のDLNAプロトコルはマルチキャストですから、アプリケーションが利用するプロトコルによってはこの鍵更新のタイミングで途切れる場合があります。\n\nマルチキャストの速度設定上述したDLNAはひかりTVなどで利用されます。このDLNAに利用されるマルチキャストは、バッファローであればマルチキャストレート、Atermであればマルチキャスト伝送速度という名前で記載されています。例えばAtermですと初期値が6Mbpsで、これだと十分に番組を伝送出来ない可能性があります。従いその値を増やす事でTV映像は安定します。しかし、マルチキャストは1対多で指定した帯域を確保し伝送するわけですから、全ての端末にデータ配信が行われます。無線機に接続された仕事用の端末はマルチキャストパケットの帯域確保が優先されてしまう事で仕事上のTV会議などが思わず影響を受けてしまう事になります。従いマルチキャストレートは上げすぎても良くないという事になります。マルチキャスト通信も種類があり、上述のひかりTVは番組を視聴している間ずっとマルチキャストを転送し続けますが、PanasonicのプライベートビエラなどのPortableTVなどは最初だけマルチキャストで接続を確認した後はユニキャストになります。\n\nPanasonic プライベートビエラ\n\n\n\n https://panasonic.jp/privateviera/\n\nUPnpの停止Universal plug and playの機能でホームゲートウェイなど光回線に接続する機器には装備されている機能です。インターネットからLAN内の機器に接続する仕組みです。これは過去から脆弱性攻撃に利用されやすいものですので明確に必要としていない場合はこの機能を停止する事をお勧めします。\n\n（2）パスワード管理ソフトの導入無線ルーターの設定では、機器にログインするためのIDとSSIDに対するパスワード（暗号キー）を必ず変更して下さい。Wi-Fiに入られない限り安全だろうという理由で、無線ルーターのパスワードが短かったり単純なものは危険です。悪意のあるスマホアプリからWi-Fiを経由し、簡単に無線ルーターの乗っ取りが可能です。個人的にはパスワード管理ソフトとして、米国のbitwardenがお勧めです。\n\nbitwarden https://bitwarden.com/\n\n\nパスワードの自動生成が可能\nWindows、macOS、iOS、Androidに対応\nスマホは指紋認証（Touch ID）や顔認証（Face ID）に対応\n主要ブラウザに対応\nサイトのURLに反応しID、パスワードを自動入力可能（フィッシング対策としても有効）\n無償（有償オプションもあるが無償でも十分利用可能）\n暗号化に関する部分のソースコードが公開されている\n日本語対応\n\nパスワードの使い回しが良くない事と理解しつつも、少しだけ変えた似たようなパスワードを使い、しかも忘れてしまいパスワードの再作成というのはよく経験する事でないでしょうか。ブラウザからでもオートコンプリートで一発入力なので非常に快適です。クラウド上にパスワードを置くのが怖いという考え方もありますが、2要素認証の標準化により、昔ほどパスワード漏洩が脅威では無くなりつつあります。何よりパスワードの使い回しより遥かに安全です。私は本当に重要なサイト、2要素認証アプリのパスワードを除き、bitwardenでランダムに生成した13桁程度の文字列をパスワードに利用し、全てbitwarden任せです。詳細は「パスワード管理ソフトのbitwardenを活用する」を参照してください。\n（3）セキュリティ対策ソフトの導入Windowsをお使いの方であれば、WindowsDefenderがありますから敢えて別のウィルス対策ソフトを購入する必要はありません。ただ付加機能として、有名どころのNortonやカスペルスキーなどでは、個人PCのカメラを意図して使われないようにコントロールできる機能を持っています。リモートワークでのTV会議の風景を録画されてしまう事の対策として利用を検討してみて下さい。個人的には多少ITスキルを要求しますが、ルーマニアのBitdefender SRL社が提供するbitdefenderをお勧めします。私は、Windows、macOSなど複数の端末を持っているため、”トータルセキュリティ2020”という製品を利用しています。ちょっとだけ微妙な日本語はご愛嬌ですが、よりプライバシーに配慮したセキュリティ対策ソフトです。彼らのプライバシーポリシーはとても丁寧に記述されている事、どのソフトが通信しているかコントロールしやすい（かといって煩雑すぎもしない絶妙なバランス）点が挙げられます。カメラのコントロール、マイクを使うタイミングでのアラート機能が装備されています。こちらは有償のソフトウェアですが、対応している機能からすれば非常に安価です。\n\nbitdefender https://www.bitdefender.com/\n\nmacOS、Linuxでも「ウィルス対策ソフトは本当に必要か？」という議論を見かけますがほとんどのケースで必要と考えています。対策ソフトで完璧に防ぐ事は困難ですが、自身の不注意から最悪のシナリオに繋がるケースから守ってくれる事もあります。「全てのOS、利用しているアプリケーションの脆弱性に伴うパッチを公開初日に確実に適用する自信がある」かつ「信頼できない未確認のサイトにアクセスしない」とわかっている場合のみウィルス対策ソフトは不要です（パッチ未公開の攻撃はホームユーザーにとって防御が困難です）。IoTはウィルス対策ソフトが導入できない代わりに「パッチの自動更新が必須」でありインターネットへアクセス可能な範囲を絞るべきです。ウィルス対策ソフトで確実に防御できるわけではありません。対策ソフトにも優劣がありますし限界があります。申し上げたいのは稼働させられるウィルス対策ソフトを使っていなかった、つまり本人の過失とならないように稼働させる事をお勧めするものです。\nでは、WindowsDefenderを導入しておけば絶対安全か？と言われればそうではありません。デフォルトでWindowsにインストールされているウィルス対策ソフトで防御されてしまうレベルの攻撃では全く意味がない事を攻撃者は理解しているからです。繰り返しになりますがウィルス対策ソフトは稼働させた上でデータのバックアップや頻繁なパッチ適用をお勧めします。\nまた、音声で留意する点は、Google Home、Apple HomePod、Amazon Echo（Alexa）の存在です。これはどのタイミングで音声をキャプチャされているか分かりませんので十分気を付ける必要があります。\n（4）ネットワークチェックツールの利用簡易なネットワーク脆弱性チェック上述したbitdefender社から、Home Scannerという無償ツールが公開されています。これは彼らの製品であるbitdefender BOXと呼ばれるFirewallを売るためのチェックツールでもあります。ネットワーク上の端末やIoT機器に脆弱性のリスクがあると警告してくれます。実際の対策内容は”bitdefender BOXの導入を”となります。初級者〜中級者向けにはこのツールを使い、まずは当該機器のファームウェア更新の有無を確認するために活用できるでしょう。また、忘れがちのIoT機器に気づくきっかけとなります。前述した「家庭内で安全快適に在宅勤務を行うためのリファレンスガイド」ではトレンドマイクロ社の「オンラインスキャンfor Home Network」が紹介されています。これは家庭向けIDS(Intrusion Detection System)といったところの機能です。仕組み上、ネットワーク全体の速度としての遅延が発生しますので、このブログでお勧めしている Sophos Firewallの導入 ほど手間を掛けられないが安心は得たいという事であれば検討してみる価値はあります。\n\nbitdefender Home Scanner https://www.bitdefender.com/solutions/home-scanner.html\n\n脆弱性検証ツール「Nessus」上級者向けには、ビジネスでは有名どころのTenable社のNessusが候補に挙げられます。Nessusは16IPを上限に検査できるNessus Essential（無償）が提供されています。しょっちゅう稼働させるプロダクトではありませんので、ノートPCにインストールしておき、普段はサービスを停止させておくと便利です。\n\nNessus https://jp.tenable.com/products/nessus\n\nOSのファイアーウォール設定私見ですが、自宅のネットワーク環境を安易に信頼しない事です。Windowsはパブリックネットワーク、macOSではOSが持つFirewallを有効にする事を検討してください。パブリックネットワークの設定でもプリンターは使えますし、さほど不便はありません。FirewallでSSLインスペクションが使えないIoTやAndroid端末もネットワークの他のホストとは通信させず可能な限り分離させています。もちろん絶対に通信させてはいけないという事ではなく、あらかじめ利用がわかっているものはもちろん明示的に許可をします。あくまで使わないものは遮断しておくのが安全です。私はAppleのAirDropはとても便利なので明示的に許可しています。\n（2020-09-30追記）iOS14では設定にローカルネットワークという項目が追加されました。悪意のあるスマホアプリがネットワーク上の機器に不正アクセスするリスクが懸念されますが、ネットワーク内にある他の端末にアクセス可能なアプリを最低限度に抑える事ができるようになりました。こちらも是非設定される事をお勧めします。\n可用性のために検討すること会議の時に自宅が停電というリスクを考えると、デスクトップPCよりはノートPCのほうが可用性が高いです。また、Wi-Fiルーターが停止した場合の予備機を考えるよりは、スマホのテザリングでしのぐ方が現実的ですのであらかじめスマホとPCにそれぞれ設定される事をお勧めします。\n","categories":["Security"],"tags":["Wi-Fi"]},{"title":"XG Firewall v18のルールとポリシーについて","url":"/new-technology/2020/03/14/rule-policy1/","content":"この記事で実現すること\nXG Firewall v18のルールとポリシーの基本的な機能を紹介します。また、インストール後、最初から設定されているデフォルトポリシーの内容を説明します。\n\n\nルールとポリシーの機能説明この記事では、XG Firewallの具体的な設定を行います。Firewallは、TCP&#x2F;UDPのレイヤ3またはレイヤ4の制御が一般的です。httpsであればPort443、SSH（セキュアシェル）であればPort22などに対し、通過させるか拒否するかを決めます。XG Firewallはレイヤ7、つまりアプリケーションの中身を見て可否を判断する事が可能です。サイトがどういうサービスを提供しているかジャンル分けされており、好ましくないサイトには接続しないように設定が出来ます。従来の方法、例えばSSHであればPort22を止めるだけのFirewallは時代に合わなくなってきています。\nあやしい振る舞いをするアプリケーションの挙動を見ていると、httpsの443で繋いでみてダメだったら一般的なProxyである8080などからの接続を試み、さらにダメならPort80と続きます。次に接続ドメインを変えたりするなど、ありとあらゆる手段を使って外部との接続を試みようとします。このような問題のあるアプリケーションをインストールしない事が一番良いのですが、ファイル交換サイトへのアクセスは禁じるという設定を行う事で一定の抑止力が発揮できます。\nXGのインストール直後は内部”LAN”からインターネット”WAN”への接続は、初期設定として全て通します。前述したレイヤ3、レイヤ4については一切制約は掛かっていません。原則WANへの通信は通すというのが最初の状態です。逆インターネットから内部のサーバに向けた接続は行えず、1つの接続対象毎に都度ルールを作成していく事になります。\n左ペインのルールとポリシーを選択し、デフォルトの設定を見てみましょう。ルールグループというグループ化されたルールとデフォルトルールがあります。\n\n\n\nTraffic to Internal Zone Firewallの内側（内部のLANにサーバを立てる場合）にアクセスするルールを記載します。\nTraffic to Wan インターネットにアクセスするルールを記載します。\nTraffic to DMZ 今回は使いません。そもそもは業務上サーバを立てる場合はDMZにWebサーバやメールサーバを配置し、内部クライアントとは分離するのが業務上一般的です。今回の設定では、個人でそこまでは不要としています。\nDefault Network Policy 上から順にルールを実行してきて、全てをチェックし、最後に全てを許可するルールとなっています。一番右の（•••）マークでルールのOn&#x2F;Offをトグルで切り替えられるようになっています。\nすべてをドロップ これは設定変更できず、視覚的に最後は全てドロップする事を示しています。\n\n“Default Network Policy”の説明\nこのルールは「許可する」となっています。なお、「破棄する」は無応答で相手はタイムアウトを待つ事になります。「拒否する」は接続要求をAcceptせず、接続を確立させず、すぐにエラーとなります。\n\nここでは、LANからWANへの通信を対象としています。送信元デバイスはLANにあるクライアントを指定出来るようになっています。サービスはプロトコルの設定を行うためのものですが、Port番号の数字ではなく、「ftp」や「ntp」などサービスとして登録できます。宛先ネットワークという項目もあります。これは国を指定する事、ビルトインの”FQDNホスト”または”FQDNホストグループ”として、”Apple Services”や”Google API Hosts”など宛先サーバー指定する事が可能です。\n次に、アプリケーションFirewallの設定です。\n\nレイヤ7のファイアウォールでは、データの中身を見てNGと判断すると、接続を許可しません。このために、Webポリシー&#x2F;IPS&#x2F;アプリケーションコントロールなど設定が出来るようになっています。\nWebポリシーは、Default Policy、Allow Allなど複数のポリシーが存在しています。サイトの属性（広告、ギャンブル、アダルト）によって拒否する事が可能です。”Allow All”は原則全てを通します。”Default Policy”は一定のリスクがあるものを対象とし、ある程度XGにお任せで制御するポリシーです。まだ初期セットアップの段階なので、ここで慌てて何かを決める必要はありません。いきなり厳しくしないのであれば、”Allow All”に一旦変更しても良いでしょう。\nIPSは攻撃防御としてXGにお任せで”lantowan_general”として下さい。悪意のあるサイトからの脆弱性攻撃を防御するものであり、通常の利用で不便な事はありません。アプリケーションコントロールは、使いたく無いアプリケーションを拒否するものですが、ホームユーザーにとっては危険なVPNやProxyなどを停止する用途になります。初期セットアップが終わってから改めて検証しながら設定するべきものです。初期セットアップ時は”なし”にしておくのが無難でしょう。\nSSL&#x2F;TLSインスペクションの機能について補足します。v18では以下のオプションは利用しません。\n\nDPIエンジンでなくWEBプロキシを使用する\nWebプロキシでのフィルタリング中にHTTPSを復号化する\n\nこれは前バージョンのv17まではPort443のみをProxyとしてhttpsの解析を行っていました。v18の目玉機能であるDPIエンジンはPortに依存しないため、複数Portを検査できる方法、つまりWEBプロキシは利用しない事が前提になります。SSL&#x2F;TLSインスペクションの詳しい説明については、「SSLインスペクションについて」を参照してください。\nここまで、”Default Network Policy”について設定されている内容を説明しました。もちろんこのルールを修正する事は可能ですが、このデフォルトルールは最後のルールとし、それより優先度の高い”上部に位置する”ルールを追加していくのが通常です。”上部に位置するルール”で許可するものを細かく設定し、最後のルールは”拒否”にする方法ももちろん可能です（業務系ファイアウォールは原則拒否で、必要なもののみ許可設定を行います）。\nファイアウォールルールの組み立て方上記で説明してきた通り、レイヤ7のファイアウォールはHTTPSプロトコルを通すという前提で、コンテンツの中身についてどのように制御するかを設定していく事になります。最初から存在しているDefault Network Policyはいくつもの上位ルールを通り抜けてきて最後に処理するルールです。以下にXGで対応可能なファイアウォールルールの組み立て方の一例について記載します。これは端末ごとにルールを決めていくやり方で、比較的シンプルな方法です。基本的に上位のルールはより絞り、下位のルールは甘めになります。\n\n不要国のアクセスは拒否\nIoT機器の利用プロトコル、接続先を制限するルール\nサーバー用途端末のルール。WANに対してhttp&#x2F;https&#x2F;ntpの接続のみ\n子供の端末向けの好ましく無いジャンルの禁止ルール\nSSLインスペクションを行えないクライアント向けルール（プロトコル制限）\nSSLインスペクションを行える一般端末のルール（やや緩めでプロトコル制限無し）\nDefault Network Policy（全て許可）、または全て拒否\n\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"XG Firewall v18のルールを作成する","url":"/new-technology/2020/03/14/rule-policy2/","content":"この記事で実現すること\nXG Firewall v18を使ったインターネットアクセスのための、デフォルトのルールを作成します。この際にリスクの大きい通信を止めたり、Webのポリシー（閲覧が好ましくないサイト）の設定ができるようになります。また、v18のNATについて説明します。\n\n\nTraffic to Wanルールの作成いよいよ、実際の基本的なルールを作成します。ルールとポリシーのメニューから、ファイアウォールルールの追加ボタンを押し、”新しいファイアウォールルール”を選択します。ルール名にはここでは”To_Internet”とします。ルールグループは”自動”のままで構いません。アクションは”許可する”のままです。ファイアウォールのログは出力するようにチェックしておきます。現時点で”選択した条件に一致しないため、ルールを既存のグループに追加できません”との表示がありますが、その下のルール設定に進みます。\n\n\n 送信元ゾーンには、”LAN”を設定します。今後、VPNを使う方は”VPN”も加えてください。宛先ゾーンは”WAN”を指定します。その他は変更しません。これを設定した段階で上部に表示されていた注意メッセージが”このルールは自動的にルールグループTraffic to WANに追加されます”という表記に変わります。\n 続いて、アプリケーションファイアウォールの設定です。\n\n\nセキュリティ機能のWebフィルタリングをクリックし、詳細メニューをオープンします。今回は基本的なルール追加の説明としてスタンダードな内容を設定します。\n\nWebポリシーは”Default Policy”を選択します\n“HTTPおよび復号化したHTTPSをスキャン”をチェックします\n“FTPのマルウェアをスキャン”をチェックします\nQUICプロトコルのブロックは任意選択です Googleのサービスで利用されています。私はチェックしています。Google自体は問題ないですがそのプロトコルを利用した悪質なサイトがFirewallを回避するリスクを減らすという意味で選択しています\nその他のセキュリティ機能でアプリケーションコントロールを選択します 最もリスクが高いアプリケーションを拒否する”Block very high risk(Risk Level 5) apps”を選択します\nIPSは一般的なルール”lantowan_general”を選択します\n\n保存ボタンをクリックするとルールの追加が行われます。Webポリシーが”Default Policy”で広告が禁止されていればブラウザではエラー画面が表示されます。またサイトのカテゴリ（ギャンブル、アダルト）などもDefault Policyの設定内容によって、どのようにアクセスが止まるのか確認をしてください。XG画面の右上にログビューアがあるので、”ファイアウォールルール”、”アプリケーションフィルタ”、”Webフィルタ”のログを確認してください。許可・拒否のログを確認しながら、さらに新しいルールを加えるなど、カスタマイズを進めてください。Webフィルタについての解説は、「XG Firewall v18のポリシーをカスタマイズする」、「XG FirewallのWebとアプリケーションフィルタについて」を参照してください。なお、SSL&#x2F;TLSインスペクションの設定が有効になるまでは、アプリケーションフィルタやWebフィルタも完全には動作しません。Windows、macOS、iOSにはSSL&#x2F;TLSインスペクションを設定される事をお勧めします。SSL&#x2F;TLSインスペクションについては「SSLインスペクションについて」を参照してください。\n宛先ネットワークの留意点宛先ネットワークの指定は、ドメインで絞るなど使い方によっては非常に便利です。しかし、昨今では目的のサービスがAWS上にホストされていたりCDN（Content Delivery Network）に登録されているケースもあり、ドメインで絞る事が難しい場合もあります。FirewallのログにはIPアドレスが表示されていても、どのドメインに対してのアクセスなのかは判別が難しく少し煩雑な対応を必要とするケースがあります。\n3つのルールルールとポリシーのメニューには、”ファイアウォールルール”と”SSL&#x2F;TLSインスペクションルール”、NATに関する”NATルール”の3つの設定があります。最初からビルトインされている”Default SNAT IPv4”というNATルールは、プライベートIPアドレスからWANへ出ていく時に、パブリックIPへと変換するためのNATの仕組みが記述されています。具体的には、NATルールのインターフェースの一致条件において、”Port2”から出ていくパケットはSNATの”MASQ”が必要と記述されています。\nXG v17まではファイアウォールのルール1つ1つに対して、NATを行うか否かを設定していました。v18では、ファイアウォールルールとNATルールとは切り離されました。v18ではLANからWAN、VPNからWANなどのインタフェースやIPアドレス単位でNATの設定を行います。v17からv18にバージョンアップした際はマイグレーションプロセスによって、ファイアウォールルールとリンクされたNATが1つづつ作成されます。ホームユーザーにおいては、よほど複雑な環境でなければNATのルールはVPN+LANからWANへの1つで十分です。\n3つのルールの関係\n\n\nルール\n内容\n\n\n\nファイアウォール\nインタフェース、接続元ホスト、接続先ホスト、プロトコル単位に許可、拒否のルールを決定します。今回は”To Internet”というLAN（VPN）からWANに対して全てのトラフィックを通過させるルールを追加しました。\n\n\nNAT\nインターフェース、IPアドレス単位にNATを行うか否かを決定します。最初からNATルール”Default SNAT IPv4”が登録されており、WANから出ていくトラフィックはファイアウォールルールの種類に関わらず、原則NATされます。\n\n\nSSL&#x2F;TLSインスペクション\nSSL&#x2F;TLSインスペクションを行う端末か対象外の端末かを決定します。TLSの低いバージョンを除外する仕組みを持ちます。また検査除外するドメインも指定可能です。\n\n\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"Withings ScanWatch","url":"/new-technology/2021/04/26/scanwatch/","content":"\n\nWithingsのスマートウォッチScanWatchWithingsのScanWatchはスマートウォッチというには、ITっぽくない、お洒落な時計です。落ち着いた文字盤で、ぱっと見は全くスマートウォッチには見えません。サファイアガラス、38mm、42mmの2つのサイズが用意されており、とてもお洒落な時計です。電池持ちは公称では30日という事です。設定によりますが、実稼働でも20日は持ち、充電の煩雑さは全くありません。5気圧防水で日常で使いやすいものです。2021年9月よりSPO2の計測に対応しました。\n\n\n時計がお好きな方にお勧めです「MIスマートバンド5を活用する」で紹介したスマートバンドとは全く異なる、どちらかといえばビジネスシーンを中心にカジュアルなエクササイズにも使える時計です。腕の細い人が多い日本人には38mmが合うと思いますが、若い方であれば42mmも素敵です。いかにもスマートウォッチというものでなく、多分言われないと気づかない品の良さを兼ね備えています。控えめながら機能美を持つこの時計は魅力的です。私の場合、休日・テレワークではもっぱらMI Bandですが、出社する時、ジャケットを着る場合、最近は殆どScanWatchです。おかげで他の時計は殆ど着けなくなってしまいました。\nScanWatchの機能\n心拍数モニタリング\n睡眠中の呼吸の乱れを追跡\nアクティビティ自動検出、記録\nGPS接続機能（スマホとの接続）\n睡眠サイクル、睡眠スコア、SmartWake-up\nスマホ通知\nHEALTH MATEアプリとの連携\nアスリート御用達STRAVA連携\n\nこれらの機能はスマートウォッチとしての基本を押さえています。\n機能美下の写真はScanWatchの盤面ですが、小さい赤い針は何だと思いますか？クロノグラフのように秒針があるわけではないですし。\n\n\nScanWatchでは1日における自身の目標歩数に対する達成率（針が1周すると100％達成）なんです。ここを敢えてアナログにしているところにとてもスマートさを感じます。\nSPO22021年9月にScanWatchはSPO2に対応しました。計測の様子は以下になります。\n\n\n数分後にパルスオキシメーターでSPO2を計測してみました。ScanWatchと近い値が出ています。\n\n\n体調不良時にどのように違いが出てくるのかという確認は難しいのですが、後述する睡眠時のチェックは有用です。\n日本では医療関連の認可が厳しいという理由で「心電図」測定機能が今のところロックされています。\nHealth MateアプリHealth Mateはフィットネス、健康管理の総合アプリという位置付けです。Withingsは体重計や血圧計、体温計など様々なヘルスケア製品を販売していますが、これらを統合的に管理するのがHealth Mateです。ScanWatchはbluetoothでスマホアプリと接続され、Withingsのクラウド上にパーソナルデータとして管理されます。私はWithingsの体重計も愛用していますが、Wi-fiに一瞬接続してクラウド上にデータを更新してくれますので、体重計に乗るときスマホを操作する必要はありません。ScanWatchも一度スマホと接続が必要ですが、一旦ペアリングしたあとは殆どIT機器として意識する事はありません。\n後述する、呼吸スキャンはバッテリーを多く消費してしまいますが、通常の利用であれば電池持ちを気にする事は殆どありません。電池持ちにも徹底して拘り、時計はシンプルに時計としての使い勝手を、多機能な健康に関する分析機能はスマホアプリで。切り分けが明快です。\n睡眠中の呼吸の乱れを追跡呼吸スキャンは月に1度を目安に実行するものです。\n\n\n睡眠呼吸障害を検知というほど、医療向けに作られているデバイスではありませんが、客観的な情報を得られます。ストレスも多い現代ですから、なかなか夜ぐっすり眠るというのは難しいでしょうし、お酒を飲み過ぎた場合や体調がすぐれない場合も客観的なデータで確認できます。\nSPO2の計測が可能となり、睡眠中のSPO2を定期的に計測できるようになりました。\n\n\n睡眠時無呼吸症候群（SAS）の確認として睡眠中にもSPO2を定期的に計測してくれるのはありがたいですね。\nアクティビティ自動検出ウォーキングは操作する事が不要で、時計を着けているだけです。WithingsのWebでは、「ScanWatchを付けるだけでを歩くことや走ること、または泳ぐことで自動的にアクティビティを記録します」とあります。\n\nウォーキング\nランニング\nサイクリング\nテニス\n卓球\nスカッシュ\nバドミントン\nボディビル\nバスケットボール\nサッカー\nバレーボール\nダンス\nボクシング\n\nボディビルってどうやって検知するんでしょうね&#x1f601;。ちなみに、ScanWatchを着けてゴルフをしても、普通のウォーキング扱いになる事もあります。ランニングも何となくランニングの計測をスタートしてから（竜頭を長押しで開始します）走り始めるのとそれが手間でもないので私の場合自動計測はあまり意味が無いようです。いろいろなスポーツをされる方は便利な機能になりますね。\nアクティビティの記録ランニングの記録はアプリで以下のように表示できます。\n\n\n走ったコース、心拍数の推移と運動強度、こちらも年齢などから自動的に中程度、激しい、ピークと分類してくれます。ダイエットを考えた場合に、心拍数とゾーンの関係についての詳細な説明は、以下の記事がわかりやすいですが、以下の簡易的な計算で求められます。\n\n体脂肪が効率よく燃える有酸素運動の適切な心拍数について、計算式から徹底解説 https://earnest.fit/intensity-aerobic-exercise/\n\n\n運動時の心拍数が最大心拍数の50〜70%の範囲になると、ファットバーンゾーンに突入して体脂肪の燃焼効果が高まることが分かっており、これは体感的には少しきつめの運動になります。これよりも軽い負荷で運動をしても、消費カロリーがあまり増えないため体脂肪の燃焼効果も良くありません。また、前述したようにこれ以上の心拍数になる激しい運動をすると、有酸素運動自体の効果は高まっても体脂肪の燃焼効果は下がります。\n\n\n目標心拍数＝(220−年齢）×0.5〜0.730歳の場合は（220−30)×0.5〜0.7＝95〜133\n\nこれは個人差がありますが、Health Mateの心拍数ゾーンの激しいというのが、ファットバーンゾーンに該当する事になるでしょうか。\nまた、ランニングのペースは詳細画面から確認します。\n\n\n内容的にはアスリート向けという事はなく、健康に気を遣う方のライフログとしては十分なレベルを目指したというところかと思います。走っている最中はスマホの画面はいちいち見ていられませんから、ScanWatchに時々目をやるようにしてペース配分を確認します。ワークアウト中はScanWatchのディスプレイを常にOnにする設定があり、この設定をお勧めします。kmあたりのペースや心拍数を把握できるので上記のように、例えば、6分半のペースで走ろうとした時にはそれなりにバランスを取りながら一定のペースで走る事ができます。\n健康レベルHealth Mateには、健康レベルという評価数値があります。これは以下のデータを元に算出します。\n\n当社の健康レベル評価は、いくつかの要因に基づいて計算されます。最も重要なものには、心拍数、年齢、性別、体重などがあり、これらはランニングセッション中にScanWatchで追跡されたGPSデータと組み合わせられます。その後健康レベルは、あなたの心拍数とペースを比較して推定されます。\n\n詳細については、Withingsのサイトを参照してください。\n\n健康レベルに関するよくあるご質問 https://support.withings.com/hc/ja/articles/360010120778-ScanWatch-健康レベルに関するよくあるご質問\n\nこのScanWatchはITっぽさを感じず、それ故に物足りなさを感じる方もいらっしゃるかもしれませんが、逆にスマートウォッチっぽくなく、むしろ古典的な時計に見えるようで、「それ、どこの時計？」と良く聞かれます。ITに特段詳しく無い方でも時計として使う分には全く難しいものではありませんし、大切な方へのプレゼントにも良いかもしれませんね。\n","categories":["SmartWatch"],"tags":["scanwatch"]},{"title":"SFP+の2.5GbE対応","url":"/new-technology/2022/07/30/sfp-plus-nbaset/","content":"この記事で実現すること\n\nスイッチングハブのSFP&#x2F;SFP+ポートは2.5Gbps&#x2F;5Gbpsに対応していない製品が多いです。元々、10GBase-T&#x2F;1000Base-Tなどもスイッチに対し無理やり10G Base-SRのように見せかけて動作させており、SFPの世界にはNBase-Tが一般的に存在しません。ビジネス向けスイッチではそもそもの対応がされていない製品も多く、ホームユーザー向けもSFPがあまり一般的ではないことから2.5GbEのサポートは普及していません。しかしながら対応モジュールを組み合わせることで回避することは可能です。\n\n\nSFP+スイッチの2.5Gbpsサポート一般的なSFP＋スイッチは1G&#x2F;10Gのみのインタフェースとなります。また、10GBase-Tモジュールでは「ASF-10G-T」という型番のSFP＋モジュールが一般的に良く知られています。日本のAmazonだと10GTek、ipolexの取り扱いがあります。これは内部のチップにMarvell社の88X3310が使われています。これはNBase-Tに対応したチップが使われており、スイッチ側をオートネゴシエーションにしておくとスイッチ上は10Gと認識していますが、端末側の速度に合わせ2.5G、100Base-TXもリンクアップします。\n必ずしも全てのモジュールがオートネゴシエーションでリンクアップするわけではありません。例えば、Broadcomチップで80m対応の省電力モジュール「Cisco SFP-10G-T-80互換」は2.5GbEに対応したスイッチで2.5GbEと認識し正しく通信できますが、オートネゴシエーションモードではリンクアップしません。10GBase-Tで慣れている方はNBase-T対応が当然でもあり、少し違和感があるのでは無いでしょうか。\nSFPモジュールの2.5Gbps対応状況について、まずは結論です。\n\n\n\n10GBase-Tモジュール\nメーカー\n2.5GbE速度\n2.5GbEオートネゴ\n発熱\n\n\n\nASF-10G-T\nipolex,10GTek\n×\n◯\n◯\n\n\nCisco SFP-10G-T-80互換\n各社\n◯\n×\n◯\n\n\n2.5GBase-Tモジュール\nFSなど各社\n◯\n×\n◎\n\n\nS+RJ10\nMikroTik\n◯\n◯\n×\n\n\nAquantiaモジュール\nSupermicro,FS\n◯\n◯\n◯\n\n\nスイッチのPortをオートネゴ（10gbps）とし、モジュール側で2.5GbEをサポートする場合の制限は2つあります。1つ目は熱の問題で、2.5Gや100Baseであってもチップ自身は10Gbpsですから、消費電力および発熱量は高くなります。2つ目は相手を2.5Gbpsと認識しているのはモジュール内部のチップだけであり、スイッチはその事実を全く知らないため、10Gbpsの速度でスイッチからSFP+モジュールに対してデータ送信します。このためSFP+モジュールはキャパオーバーとなり、データバッファが溢れ、データ再送が繰り返される事になります。つまり、一般的によく出回っているASF-10G-T（Marvell社の88X3310チップ）は2.5GbEとしては全く実用的ではありません。\n実際に問題となるケースを説明します。クライアントは2.5GBase-Tを持つWindows10で10GBase-TのSFPモジュールを使いSFP＋スイッチにオートネゴモードで接続されています。サーバーはUbuntu20で10GbpsのSFP+DACケーブルで同じスイッチに接続されています。サーバーからデータをダウンロード、アップロードすることを想定し、iperf3を実行します。\n\n\n# クライアントで実行：上りC:\\Users\\yoshi&gt;iperf3 -c 192.168.x.181Connecting to host 192.168.x.181, port 5201[  4] local 192.168.x.164 port 62653 connected to 192.168.x.181 port 5201[ ID] Interval           Transfer     Bandwidth[  4]   0.00-1.00   sec   283 MBytes  2.37 Gbits/sec[  4]   1.00-2.00   sec   282 MBytes  2.37 Gbits/sec[  4]   2.00-3.00   sec   282 MBytes  2.37 Gbits/sec[  4]   3.00-4.00   sec   283 MBytes  2.37 Gbits/sec[  4]   4.00-5.00   sec   282 MBytes  2.37 Gbits/sec[  4]   5.00-6.00   sec   282 MBytes  2.37 Gbits/sec[  4]   6.00-7.00   sec   281 MBytes  2.36 Gbits/sec[  4]   7.00-8.00   sec   282 MBytes  2.37 Gbits/sec[  4]   8.00-9.00   sec   282 MBytes  2.37 Gbits/sec[  4]   9.00-10.00  sec   282 MBytes  2.37 Gbits/sec- - - - - - - - - - - - - - - - - - - - - - - - -[ ID] Interval           Transfer     Bandwidth[  4]   0.00-10.00  sec  2.76 GBytes  2.37 Gbits/sec                  sender[  4]   0.00-10.00  sec  2.76 GBytes  2.37 Gbits/sec                  receiveriperf Done.# クライアントで実行：下りC:\\Users\\yoshi&gt;iperf3 -c 192.168.x.181 -RConnecting to host 192.168.x.181, port 5201Reverse mode, remote host 192.168.x.181 is sending[  4] local 192.168.x.164 port 62643 connected to 192.168.x.181 port 5201[ ID] Interval           Transfer     Bandwidth[  4]   0.00-1.00   sec   184 MBytes  1.54 Gbits/sec[  4]   1.00-2.00   sec   153 MBytes  1.29 Gbits/sec[  4]   2.00-3.00   sec   127 MBytes  1.06 Gbits/sec[  4]   3.00-4.00   sec   121 MBytes  1.02 Gbits/sec[  4]   4.00-5.00   sec   120 MBytes  1.01 Gbits/sec[  4]   5.00-6.00   sec   121 MBytes  1.02 Gbits/sec[  4]   6.00-7.00   sec   123 MBytes  1.03 Gbits/sec[  4]   7.00-8.00   sec   121 MBytes  1.02 Gbits/sec[  4]   8.00-9.00   sec   120 MBytes  1.00 Gbits/sec[  4]   9.00-10.00  sec   119 MBytes  1.00 Gbits/sec- - - - - - - - - - - - - - - - - - - - - - - - -[ ID] Interval           Transfer     Bandwidth       Retr[  4]   0.00-10.00  sec  1.28 GBytes  1.10 Gbits/sec  16710             sender[  4]   0.00-10.00  sec  1.28 GBytes  1.10 Gbits/sec                  receiveriperf Done.\n\nWindows（クライアント：2.5Gbps）からUbuntu(サーバー:10Gbps)へのアップロードは2.5Gbps相当の速度が出ていますが、Ubuntu(サーバー:10Gbps)からWindows(クライアント：2.5Gbps)にダウンロードする方向で1Gbps程度の速度に落ち込みます。ubuntuの送信リトライの数が16710と大きな数字になっています。\n上記のiperf3の実行結果についてクライアント側でネットワークアナライザのWireSharkを使い、下りデータをキャプチャしたものが以下のグラフです。\nまずは、往復遅延時間（Round trip）です。\n\n\nX軸が時間の経過で10秒間、Y軸が往復遅延時間です。問題は2つあります。1つ目は1ms（ミリ秒）を超える遅延（青いドット）がいくつか発生しています。2つ目は0ms〜1msの間に青いドットが集約され、青い帯のように見えます。LANの通信で帯に見える場合は数百μs（マイクロ秒）のレイテンシが発生し断続的に遅延が発生しています。レイテンシが小さいなら太い実線程度であり帯のようには見えません。\n次に、スループットです。\n\n\nX軸は時間の経過、Y軸は2つあり、茶色の実線および右の目盛りはスループットを表します。青色の点および左の目盛りは受信したデータ長を表します。茶色のスループットは最初1.5Gbpsまでは上がり、その後スループットが落ち込んでいきます。グラフ上部の青い水平線はTCPのデータ1460バイトの点がプロットされたものが集まっており、実線に見えます。また、パケットが欠損するとこのように全体に青いドットが散らばり、中途半端なバイト数の受信を示します。\n実際のパケットの中身を確認してみます。\n\n\nIPの末尾181がubuntu、IPの末尾164がWindowsです。No307,309,310と1460バイトのTCPデータが受信されていますが、No311で318バイトを受信しています。ここで恐らくパケットが欠損したと思われます。その次の受信は、No313でシーケンス365001、No314でシーケンス366461を受信しています。受け損ねたと思われるNo311のシーケンスは360621です。(366461-360621)&#x2F;1460&#x3D;4とちょうど割り切れるため、サーバー側はTCP1460バイトを連続で送っていたものとみられます。No311で318バイトの残り1142バイトをロストし、次のシーケンス363541も1460バイト全体をロストしたのでしょう。\nこの後、クライアントは、あくまで自身が欲しいパケットのシーケンスは欠損した360621なのでDup ACKを送出しこれを要求しますが、要求している間にもどんどん次のトラフィックが送信されてきます。最終的には、360621の再送要求がサーバーに届き、サーバーは優先度を上げて360621を再送しますが、それまでに結構なタイムロスがあります。\niperf3など同一LAN内であれば、再送によるレイテンシも小さく済みますが、相手サーバーがInternet経由だとレイテンシが数ミリ秒〜数十ミリ秒あります。このためハイトラフィックテストや大きなファイルのダウンロードは更に落ち込む事になります。私の環境では200Mbpsが精一杯でした。\n要約すると以下の通りです。\n\nSFP＋スイッチの2.5GbEサポート状況はメーカー次第\nSFP＋ 10GBase-Tモジュールのいくつかは2.5GbEをサポートするが、対応状況は不明瞭\nスイッチが2.5GbEに対応しない場合、10GBase-Tモジュールで2.5GbEを認識する場合があるが、片側の速度が1Gbps未満に落ち込むモジュールが大半\n2.5GbE接続であっても10GbEチップを使えば発熱量は増える\n\n\n\n\nWireShark https://www.wireshark.org\n\nFS社のAquantiaチップ特注モジュールFS社では特にホームページで記載されていないものの、実はAquantiaチップを使ったRJ45 10GbEモジュールを特注で提供してくれます。Aquantiaチップのモジュールは、数年前よりSupermicro社が提供するRJ45モジュールで唯一の2.5GbE&#x2F;5GbE対応のものと言われていましたが、$200と高価なものでした。\n\n\n（ラベルは至って普通。でも特注です）\nSFP+スイッチでこのモジュールを10GbEオートネゴで使い、上記の2.5Gbpsのテストをやってみたところ、十分な速度が出ました。今回はリトライもありません。\nConnecting to host 192.168.x.181, port 5201Reverse mode, remote host 192.168.x.181 is sending[  4] local 192.168.x.164 port 54413 connected to 192.168.x.181 port 5201[ ID] Interval           Transfer     Bandwidth[  4]   0.00-1.00   sec   279 MBytes  2.34 Gbits/sec[  4]   1.00-2.00   sec   283 MBytes  2.37 Gbits/sec[  4]   2.00-3.00   sec   283 MBytes  2.38 Gbits/sec[  4]   3.00-4.00   sec   283 MBytes  2.37 Gbits/sec[  4]   4.00-5.00   sec   283 MBytes  2.37 Gbits/sec[  4]   5.00-6.00   sec   283 MBytes  2.38 Gbits/sec[  4]   6.00-7.00   sec   283 MBytes  2.37 Gbits/sec[  4]   7.00-8.00   sec   283 MBytes  2.37 Gbits/sec[  4]   8.00-9.00   sec   283 MBytes  2.37 Gbits/sec[  4]   9.00-10.00  sec   283 MBytes  2.37 Gbits/sec- - - - - - - - - - - - - - - - - - - - - - - - -[ ID] Interval           Transfer     Bandwidth       Retr[  4]   0.00-10.00  sec  2.76 GBytes  2.37 Gbits/sec    0             sender[  4]   0.00-10.00  sec  2.76 GBytes  2.37 Gbits/sec                  receiveriperf Done.\n\nAquantiaチップの特性でデータロストから耐えられたように見えます。スループットを見てみましょう。\n\n\n茶色の実線のスループットは最初の1秒で2Gbpsまで順調に伸びています。1460バイトのTCPデータが連続して受信されている事が青色の実線でわかります。制御のためのデータ送受信もあり、全てが1460バイトにはなりませんが、中途半端なレングスのパケットが点在していません。iperf3の結果だけ見るとすこぶる結果は良好ですが、実際のグラフにしてみるとそれなりに速度の変動は発生しています。\n次にRound tripです。\n\n\niperf3の開始直後は5msを超える遅延（青いドット）がいくつか発生しています。断続的に1msに近いレイテンシは10秒間の全体を通して発生しています。見た目だけですと最初の「ASF-10G-T」よりも悪くなっているように見えますが、遅延が0に近い場所の青い線の厚みがあることで「ASF-10G-T」よりは遅延の数が少ないと想定されます。何よりスループットは十分な速度が出ていますので許容範囲と考えるべきでしょう。10Gbpsと2.5Gbpsという速度差から発生するギャップがあり、TCP通信の初期段階で通信速度の差をある程度調整することになりますが、一定の数の調整を無くすことはできません。\nスイッチのフローコントロール2.5GbEに対応していないSFP+スイッチであっても、Aquantiaモジュール側の2.5Gbpsの自動認識および速度調整によって上手くいくことが確認できました。それはスイッチのフロー制御によっても支えられています。「フローコントロール」を無効にしてみます。\n$ iperf3 -c 192.168.x.1 -RConnecting to host 192.168.x.2, port 5201Reverse mode, remote host 192.168.x.2 is sending[  5] local 192.168.x.1 port 49780 connected to 192.168.x.2 port 5201[ ID] Interval           Transfer     Bitrate[  5]   0.00-1.00   sec   176 MBytes  1.47 Gbits/sec[  5]   1.00-2.00   sec   172 MBytes  1.45 Gbits/sec[  5]   2.00-3.00   sec   159 MBytes  1.34 Gbits/sec[  5]   3.00-4.00   sec   163 MBytes  1.37 Gbits/sec[  5]   4.00-5.00   sec   170 MBytes  1.42 Gbits/sec[  5]   5.00-6.00   sec   183 MBytes  1.54 Gbits/sec[  5]   6.00-7.00   sec   176 MBytes  1.47 Gbits/sec[  5]   7.00-8.00   sec   183 MBytes  1.53 Gbits/sec[  5]   8.00-9.00   sec   194 MBytes  1.63 Gbits/sec[  5]   9.00-10.00  sec   183 MBytes  1.53 Gbits/sec- - - - - - - - - - - - - - - - - - - - - - - - -[ ID] Interval           Transfer     Bitrate         Retr[  5]   0.00-10.00  sec  1.73 GBytes  1.48 Gbits/sec  13430             sender[  5]   0.00-10.00  sec  1.72 GBytes  1.48 Gbits/sec                  receiveriperf Done.\n\n汎用モジュールの「ASF-10G-T」ほど数字は落ち込みませんが、AquantiaチップのSFP＋モジュールでも2.5Gbpsのレートは出ません。こちらはRetrの数字が大きいことから、スイッチのフロー制御が無いまま、TCPの世界でリトライが多発しているように見えます。これはスイッチによっても差がでます。\nスイッチのフローコントロールは、送信側にPauseフレームをマルチキャスト送信し、送信側を一時停止させます。システムの速度差が問題を引き起こすため、何らかの理由でスイッチのバッファが溢れそうになる時にはスイッチのフローコントロールによってネットワーク全体が安定的に動作します。ここまでの検証で、Aquantiaチップは十分なバッファを持っていることである程度は大量のトラフィックに耐えますが、バッファが溢れそうになった段階でスイッチに限界を通知し、スイッチにPauseフレーム送信を促すことにより通信が安定するものとみられます。\nFSでのAquantia　10GbE SFP＋モジュール（RJ45）の指定方法これはFS社から教わりましたが、注文時に備考欄に  Aquantia方案と記載して欲しいとのこと。この指定が無ければMarvellチップのモジュールになります。受注生産とのことで納品まで1か月程度掛かりますが、これはホームユーザーにとって強い味方になると思われます。\n\n\n2.5GbE SFP＋モジュール（RJ45）スイッチが2.5GbEに対応しているなら、日本ではあまり見かけない2.5Gbase-Tモジュールが利用できる可能性があります。これはスイッチの対応状況に依存するため、事前にモジュールメーカーへ問い合わせが必須となります。スイッチのパフォーマンスを最大限活かせること、10GbEのチップほど温度が上がらないメリットがあります。モジュール自体の価格も10GBase-Tのものよりは安価です。\n\n\nモジュールの温度モジュールの温度に関して具体的な数値の記録は以下の通りです。\n前回記事「10GネットワークとSFP+」と同様にモジュールの表面に金属センサーを接触させ計測しています。\n\nファンレススイッチでオートネゴによる10Gbpsと2.5Gbpsでのリンクアップの違い\n\n\n\n\n10GBase-Tモジュール\n速度\n温度\n\n\n\nASF-10G-T\n2.5Gbps\n46℃\n\n\nAquantia10Gモジュール\n2.5Gbps\n45℃\n\n\nASF-10G-T\n10Gbps\n49.4℃\n\n\nAquantia10Gモジュール\n10Gbps\n49.5℃\n\n\n（室温29℃）\n\n\n\n\n Marvell、Aquantiaのモジュールは温度に関して違いは見られません。そういえば、Aquantiaは3年前にMarvellに買収されましたね。今となってはMarvell、Aquantiaという名前で比較するにはふさわしく無いのかもしれません。\n\nファン付きスイッチで2.5GbEチップと10GbEチップ（2.5Gbpsオートネゴ接続）との比較\n\n\n\n\nモジュール(2.5Gbpsで接続)\n温度\n\n\n\nCisco SFP-10G-T-80互換\n37.7℃\n\n\nAquantia 10Gモジュール\n38℃\n\n\nMarvell 2.5Gモジュール\n35.8℃\n\n\n（室温31℃）\n\n\n\n Cisco SFP-10G-T-80互換のBroadcomチップは低発熱で使いやすいモジュールですが、やはり2.5Gbps専用チップに軍配が上がります。\n補足2.5Gbps対応スイッチとオートネゴのASF-10G-Tとの遅延を比較したグラフのスケールを拡大して比較したものを載せておきます。上記ではレイテンシの幅について「帯」という表現をしましたが、拡大してみるとレイテンシの状況にはかなりの違いが見られます。\n\n\n左：2.5Gbpsモジュール（フローコントロール無し）右：ASF-10G-T（2.5GbEオートネゴシエーション）\n0.5秒前後を切り取っただけであり、どちらのモジュールも1msを超える大きな遅延はあります。順調なケースと問題を抱えているケースとしての比較です。左はかなり良い状態を切り取っています。どのモジュールでも数百μsの遅延は定期的に発生します。しかし帯と表現した右側のグラフでは、300μsを超えるレイテンシが継続して発生しており、何らかの問題を抱えていることがわかります。遅延だけでなく、スループットを併せて見ることで遅延は無いが送る量が少ないケースも見極める必要があります。\niperf3の出力結果だけでもある程度の状況は把握できますが、WireSharkで厳密にスループットのグラフや往復遅延時間を確認し、スイッチやモジュールの能力を見極められます。\n","categories":["Hardware","Network"],"tags":["SFP+"]},{"title":"SSLインスペクションについて","url":"/new-technology/2020/03/20/ssl-inspection/","content":"この記事で実現すること\nXG Firewallなどの次世代Firewallで利用されているSSL/TLSインスペクションについて、PCやiPhone等（Windows/macOS/Linux/iOS）を防御する仕組み、および必要となる対応を説明します。\n\n\nSSLインスペクションとはhttps通信では、サーバーとクライアント間がSSLで暗号化されます。SSLというのは本来はTLS（Transport Layer Security）が正しい名称ですが、SSLという言葉が過去より定着しているので、今日でも”SSL証明書”などSSLという言葉は一般的に使われます。この暗号化された通信をIPS（Intrusion Prevension System）は暗号を解読しながらコンテンツの中身の検査を行います。暗号通信の復号化方法としてSSL/TLSインスペクションという方式が採用されています。ここではSSL&#x2F;TLSインスペクションによりどのようにFirewallが暗号化された通信を「正当な方法で」解読するかをシーケンスで説明します。\nブラウザとサーバーのSSL&#x2F;TLS通信のシーケンス\n\nsequenceDiagram\nparticipant cl as クライアント&lt;br&gt;（ブラウザ）\nparticipant sv as Webサーバー\n\ncl -&gt;&gt;+ sv : 1.Webサーバーへの接続\nsv --&gt;&gt;- cl : 2.サーバー証明書と&lt;br&gt;公開鍵を送付\nNote over cl: 3.ルート証明機関でサーバーの証明書の正当性を検証\nNote over cl: 4.一時的な共通鍵を作成し、サーバーの公開鍵で暗号化\ncl -&gt;&gt;+ sv : 5.暗号化された共通鍵を送信\nsv --&gt;&gt;- cl : 6.共通鍵で暗号化されたデータの送信\nNote over cl: 7.共通鍵で復号\n\n\n\n上記のようにサーバーは公開鍵をクライアントに渡し、ブラウザ（クライアント）は保持しているルート証明書（ルート証明機関）への照合によってサーバーが正しいURLのものかを判別します。クライアントが生成した共通鍵はサーバーの公開鍵で暗号化されているため、サーバー自身が持つ秘密鍵でなければ解読できません。よって、クライアントとサーバーの間に第三者が割り込んでも電文の中身を解読できません。\nFirewallを経由するSSL通信のシーケンス正当な方法として、FirewallのCA証明書を予めクライアントに承認させることで、電文の検査を行う事ができます。実際にhttpsの通信を開始するシーケンスは以下の通りです。\n\n\nsequenceDiagram\nparticipant cl as クライアント&lt;br&gt;（ブラウザ）\nparticipant xg as Firewall\nparticipant sv as Webサーバー\n\ncl -&gt;&gt;+ xg : 1.Webサーバーへの接続\nxg -&gt;&gt;+ sv : 2.Webサーバーへの接続\nsv --&gt;&gt;- xg : 3.サーバー証明書と&lt;br&gt;公開鍵を送付\nNote over xg: 4.サーバー証明書に紐づくルート証明書でサーバー証明書の正当性を検証\nxg --&gt;&gt;- cl : 5.FWのサーバー証明書と公開鍵を送付\nNote over cl: 6.FWのルート証明書でFWの証明書の正当性を検証\nNote over cl: 7.一時的な共通鍵を作成し、FWの公開鍵で暗号化\ncl -&gt;&gt;+ xg : 8.暗号化された共通鍵を送信\nNote over xg: 9.FWの秘密鍵で復号化、共通鍵を取得\nNote over xg : 10.共通鍵をWebサーバーの公開鍵で暗号化\nxg -&gt;&gt;+ sv : 11.暗号化された共通鍵を送信\nsv --&gt;&gt;- xg : 12.共通鍵で暗号化されたデータの送信\nNote over xg: 13.共通鍵で復号\nNote over xg: 14.コンテンツの中身の検証\nxg --&gt;&gt;- cl : 15.共通鍵で暗号化されたデータの送信\nNote over cl: 16.共通鍵で復号\n\n\n\nFirewallはクライアントとWebサーバーとの間に入り、SSLの解読を行います。クライアントはFirewallが暗号化した電文を解読する事になります。\nこのシーケンスのポイントFirewallが間に入らない通常のシーケンスにおいては、間にFirewallが割り込んで共通鍵を取得しようとしてもWebサーバーの秘密鍵を持っていないため、解読できません。従い、共通鍵を取得するためにFiewallが自分自身の公開鍵をクライアントへ渡しますが、Firewallの独自証明書はクライアント側のルート証明機関の検証によって不正と扱われます。Firewallがセキュリティ対策のための正当なサーバーである事を明示するために、クライアントにはFirewallのCA証明書を事前に”ルート証明機関”としてインストールしておく必要があります。クライアントに、FirewallのCA証明書が登録されていない状態でSSLインスペクションを行うと、ブラウザは「信頼されないサイト」として警告を発します。このような仕組みでSSL通信は悪意を持った第三者攻撃を防ぎつつ、ユーザがFirewallのCA証明書を許可する事でSSL検査を可能にしています。\nSSL&#x2F;TLSインスペクションを行うためには、FirewallのCA証明書を端末毎にインストールする必要があります。\n\n\nコンテンツの中身の検証上記シーケンスの14番目がFirewallの大きな役割です。暗号化されたhttpsのデータを解読し、流れるデータの中にさまざまな脅威が無いか検証を行います。\nCA証明書のインストール上述した通り、SSL&#x2F;TLSインスペクションを行うためには、FirewallのCA証明書をクライアントにインストールしなくてはなりません。復号化については、以下の端末で検証をしています。\n\nWindows\nmacOS\niOS\nLinux(ubuntu)\n\nなお、Androidには証明書はインストール出来ますが、Chrome以外のアプリで証明書を信頼する事が出来ず、実質SSL&#x2F;TLSインスペクションは使えません。他の家電TVなども難しいと考えてください。\nSSL&#x2F;TLSインスペクションを設定後、ブラウザのURLの鍵マークにカーソルを合わせるとそのサイトで利用している本来の認証局ではなく、以下のようにFirewall（この実例ではSophos XG Firewall）の認証局が有効となっている事が分かります。\n\n\nSNIによる接続時検査次世代FirewallでSSL&#x2F;TLSの中身を検査するためにはCA証明書が必要と記載しましたが、URLの宛先サーバーのみのチェックであればSSL&#x2F;TLSインスペクションを利用せずとも可能です。https通信では、最初の接続時にどのサーバーに接続するかの文字列情報をSNI（Server Name Indication）でWebサーバーに通知します。これは平文です。Firewallはこのhttpsの通信開始時に宛先の正当性を検査し、接続を拒否する事が可能です。Firewallが持つURLフィルタ（ドメインフィルタ）機能はどのFirewall製品でも一般的なものですが、これはCA証明書のインストールは不要です。但し電文の中に含まれるマルウェアや脆弱性に対する攻撃などを防ぐには完全な電文の解読が必要です。\n余談ですが、”公衆WIFIでは、httpsを使えば安全”というWebサイト上の記載を見かけます。しかしながら、実際にユーザーがどのWebサイトを閲覧しているかは、こういったSNIの平文やDNSクリエストによって公衆WIFIの提供業者に把握されているのが実態です。\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"10GネットワークとSFP+","url":"/new-technology/2022/05/28/sfp-plus/","content":"\n\nこの記事で実現すること\n\nリモートワークやインターネット回線の高速化に伴い、10Gネットワークが普及し、10GBase-Tの発熱に対する声が聞かれます。10Gネットワークにおいては従来のLANケーブルではなく光ファイバーで省電力化と低発熱が実現できる、SFP+が選択肢となります。実はあまり知られていない低遅延の効果もあります。2023年4月以降段階的に各地で電気代が値上げされることになりました。また、5月中旬というのに夏のような暑さが到来しています。毎年恒例ですが、発熱対策の気になる季節になってきました。この記事は1年前に投稿したものですが、最近の情勢を踏まえて1年ぶりにアップデートするもので、10Gネットワークを前提にSFP+についてまとめています。\n\n\n10Gネットワークの消費電力と発熱10GBase-Tの消費電力は1Portあたり3W程度で、単体で見るとさほど大きいものではありませんが、スイッチなどそれが4Port&#x2F;8Portとなると全体で30W以上の消費電力となり、PC程度のものになってきます。10Gbase-Tのネットワーク機器が出す熱は軽く40度を超え、夏場は60度を超える場合もあります。そもそも10Gbpsという高速処理は負荷が高いのに加え、10GBase-Tに必要なエラー訂正とアナログ&#x2F;デジタル変換の負荷が高くなります。モジュールの消費電力に比例して温度も高くなる傾向があります。\n発熱はスイッチやネットワークカード、PC本体などその周辺機器に悪影響を与えます。特に真夏で部屋の温度が40度近くに達する場合は、これらの高熱を出す機器も内部温度は70度近くに上がってしまい一気に故障する可能性が高くなります。ファンが付いているスイッチは大きいファンノイズが発生しますし、エアコンやファンでエアフローにも気を遣う必要が出てきます。一般的な建売戸建やマンションでクローゼットに回線引き込みがされ、各部屋へのCD管またはPF管が集約されている場合、そこにルーターやスイッチングハブを設置せざるを得ません。こうなると発熱対策、騒音対策が結構な問題になってきます。\n私の自宅の2階のクローゼットの中にある、インターネット配線設備（マルチメディアポート）の内部。家の中で最も熱が篭る場所に配置されています。。。\n\n\n右手前がホームゲートウェイ、配線設備の内部にテレビアンテナケーブル（黒）、電話線（グレー）、auひかりのシングルモードファイバケーブル（白）、スイッチングハブから各部屋へのCat6 UTPケーブル（青）、マルチモードファイバケーブル（水色）を通しています。マルチメディアポートの奥に各部屋に繋がるオレンジ色のCD管（直径2cm）が見えます。\nSFP&#x2F;SFP+とはSFPはSmall Form-factor Pluggableの略で光ファイバーの通信に使われるもので、個人向けのネットワーク機器においても利用可能な価格帯のハードウェアです。本来は遠距離の通信や高速化が主で法人向けでしたが、普及に伴い、価格がこなれてきました。個人向けには発熱を抑えた高速通信という意味で利用価値があります。レイテンシが小さく、自宅の通信経路にFirewallやルーターを通しても遅延が少なく済みます。\n10Gネットワークのタイプとレイテンシ\n\n\n\nタイプ\nレイテンシ\n\n\n\n1000Base-T\n10マイクロ秒前後（幅が大きい）\n\n\n10GBase-T\n2〜2.5マイクロ秒\n\n\nSFP+\n0.3マイクロ秒\n\n\n1000Base-TのネットワークでFirewallやルータを挟むと10マイクロ秒のレイテンシが、HGW、ファイアウォールWAN、ファイアウォールLAN、クライアントへとそれぞれがパケット単位で時間を要し、ファイアウォール自身が高性能であっても「ファイアウォールが遅い」という話になります。また、大きなファイルをダウンロードしないから10Gネットワークが不要というわけではなく、一つひとつの処理をキビキビと動作させるためにSFP+の利用価値があります。通常1,500バイトのMTUを9,000バイトとしたジャンボフレームの設定で遅延を緩和できますが、抜本的改善としてSFP+を選択する効果は大きいです。\nSFPは主として光ケーブルを接続するためのインタフェースです。スイッチやネットワークカードにはSFPスロット（ポート）があり、SFPモジュール（トランシーバとも呼ばれます）を挿して使います。モジュールは光ケーブル、銅線のダイレクトアタッチケーブル、従来のLANケーブル（RJ-45端子）などを接続可能なインタフェースがあります。SFPはさまざまなモジュールを使い分けることにより、速度、距離、ケーブルの種類に対応できます。\n\n\nRJ45を持たず、SFP&#x2F;SFP+スロットしかないスイッチもあります。もちろん、前述したRJ45モジュールを接続して従来のツイストペアケーブルを使えます。\n距離、ケーブルの種類によるモジュールの使い分けホームユーザーが自宅でSFPモジュールを使い分けるには、既存ケーブルの有無、配線の距離、価格面の優位性を見ながら選択することになります。\n\n\n\n名称\n距離\nお勧め度\n消費電力\n発熱\n補足説明\n\n\n\nパッシブダイレクトアタッチケーブル(DAC)\n〜7m\n◎\n0.2w\n微弱\n安価。Twinaxとも呼ばれる\n\n\nアクティブダイレクトアタッチケーブル\n〜15m\n△\n1w未満\n弱\n殆ど見かけない\n\n\nアクティブオプティカルケーブル(AOC)\n〜100m\n◯\n0.5w〜2w\n弱\n流通量少ない（高価）\n\n\nMMFモジュール（10GBase-SR）+OM3ケーブル\n〜300m\n◎\n0.6W\n弱\n安価、取り回しやすい\n\n\nSMFモジュール＋SM1 or SM2ケーブル\n100m〜40km〜\n△\n0.6w〜1w\n弱\n長距離向け、ケーブルが折り曲げに弱い\n\n\n10GBase-Tモジュール\n〜80m\n◯\n2.5W〜3w\n強\n高発熱、やや高額\n\n\nSFP&#x2F;SFP+は対向機器の電源が入っていなくてもモジュールを挿すだけで電力を消費します。単体をスイッチに挿し、対向が接続していない状態でDACと1000Base-Tは0.1W程度の消費で誤差の範囲ですが、10GBase-SRは単体で0.5W消費します。10GBase-Tモジュールは1W程度消費します。\nDAC\n\nDACは1,500円&#x2F;mと安価であり、ケーブルにはモジュールも両端に付いているので別途モジュールを購入する必要はありません。DACのケーブル長はモジュールの端から端までの距離を示すため、50cmや1mのDACは思ったより短いという印象を持ちやすいです。\nパッシブDACは銅線（Copper）で、1mであればCat6の一般的なケーブルよりは細いですが、しなやかさは劣ります。7mまでの距離に応じて線の太さが太くなります。端末、スイッチ間の距離が7m未満であればパッシブダイレクトアタッチケーブル（DAC）を最優先に選定します。DACと言えば、一般的にはパッシブのことを言います。特に電流を増幅させずそのままデータを送信するので発熱が極めて少ないですが、距離の制限があります。ホームユーザーが熱対策を考える場合、どうにかして7mの距離以内に端末・スイッチを配置する事が最優先となります。アクティブDACは信号を増幅させる仕組みを使っていますが、現代では殆ど見かけません。\nAOC\n\nAOCケーブルは見た目はDACと同じで両端にモジュールが付いており、線の内部は光が使われます。短いケーブルはOM3ですが距離が長いAOCはOM4が使われます。ユーザーにシングルモード&#x2F;マルチモードのことやケーブルの種類を意識させず、ケーブルの距離だけを意識して選定するというソリューションですが、それなりに知識のある人がSFPを選定する事を考えると、SFPトランシーバとOM3、OM4ケーブルを個別に選定することが一般的で、購入先もなかなか見つからないかもしれません。\nMMF 10GBase-SR+OM3ケーブル7mを超える距離、例えば異なる部屋にLANを通す場合には、10GBase-SRモジュールとOM3光ケーブルを使います。SRとはShort Reach（短距離）の意味です。光ケーブルも発熱は少なく、マルチモードファイバは、かなりケーブルが細くしなやかです。ただし、ツイストペアケーブルほどは強いものではなく、極端な折り曲げは通信エラーになりますし、通線ワイヤーを使い各部屋を通す場合には強い力でぐいぐいと引っ張るわけにもいきません。うっかり足を引っ掛けると断線しますし、ケーブルを絨毯の下に這わせたり、ドアの隙間を通したりするのは難しいでしょう。丁寧に扱う必要があります。\n\n\nSFP+の10Gbpsで利用するマルチモードファイバは、LC-LCという2対の組みをトランシーバに挿して使います。2本の光ファイバがセットになり、送信用（Tx)と受信用（RX)とに役割があります。また、速度によってケーブルの被覆の色が決められており、OM3、OM4はアクアジャケットになります。2本の線があるからマルチではなく、1本の線の中で複数の光の波形を通すのでマルチモードと呼ばれます。\n\n\n\nMMF\n1Gbps\n10Gbps\n40Gbps\n100Gbps\nジャケット色\n\n\n\nOM1\n275m\n33m\nー\nー\nオレンジ\n\n\nOM2\n550m\n82m\nー\nー\nオレンジ\n\n\nOM3\nー\n300m\n100m\n70m\nアクア\n\n\nOM4\nー\n550m\n150m\n150m\nアクア&#x2F;バイオレット\n\n\nOM5\nー\n550m\n150m\n150m\nライム\n\n\nOM3は1,500円&#x2F;10m、2,500円&#x2F;20mです。OM4は2,200円&#x2F;10mです（販売会社によって若干のばらつきがあります）。ケーブルを自宅内に敷設するなら、将来の拡張性のために40Gbps&#x2F;100Gbpsを150mの距離に対応しているOM4を選択しても良いように見えます。しかし今のところ25GbpsのスイッチはSFP28インタフェースとなりOM3のLC-LCケーブルが使えますが、40Gbpsはスイッチ側がQFSPインタフェースとなり、LC-LCではなくMPOケーブルとなります。個人向けという意味では、PF管&#x2F;CD管を通す場合のMPOコネクタは幅・厚みがあることで、管を通すことが難しくなります。OM3のLC-LCであれば、（1ペアづつ地道に通線させ）直径2cmの管に3本〜4本程度のOM3ケーブルを通せます。\n10GBase-Tモジュール、1000Base-Tモジュール既存のRJ45端子のLANケーブル（UTPケーブル）を接続するためのモジュールです。10GBase-Tの口を持っていないSFP+のみのスイッチでは、このモジュールを利用し既存の10GBase-T環境と接続します。10GBase-TモジュールはLANケーブルの長さが30mまでを限界としている製品が多いです。ケーブルが長くなれば電力量が増え3Wを超えてしまうためです。通信量と消費電力とは殆ど関係ありません。確かにIEEE802.3azという規格では無通信時は省電力にする仕組みを持っていますが、消費電力は距離によって変わります。MarvellではなくBroadcomのチップを使った10GBase-Tモジュールも出てきており省電力で80mまで可能となっています。\nその他ケーブル、トランシーバ\nSCケーブル\n\n \n 古い規格の光ファイバ端子です。GBICとも呼ばれます。これが対となりSC-SCケーブルというものになりますが、SFP&#x2F;SFP+モジュールには接続できません。\n\nMPOケーブル\n\n \n 40GbpsのQFSPトランシーバ（QSFP-40G-SR4）に利用されます。SFP&#x2F;SFP+&#x2F;SFP28とは互換性がありません。\nモジュールの互換性・ベンダーロックインSFP+を語るときに外せないテーマが、互換性の問題とベンダーロックインです。まず互換性の問題ですが、背景としてはSGMIIというCiscoが提唱した方式がデファクトスタンダードとなり、他のメーカーがSGMII対応に倣ってきたため、各社仕様が微妙に異なる状況となっており、互換性の問題で接続できないケースが発生します。また、ベンダーロックインはCisco&#x2F;HP&#x2F;intelなどのメーカーが設定しており、動作を担保するためにテスト済みのモジュール以外は使えないようになっています。SFPはMSA（マルチソースアグリーメント）によって業界で標準化されたトランシーバデバイスとして、可能な限り規格を統一されるように取り組まれています。\nMMFモジュールの互換性MMFモジュールの互換性については、Cisco&#x2F;intel&#x2F;Dell&#x2F;Mellanox&#x2F;HPというグループに分かれます。この互換性に基づきMMFモジュールを購入する必要があります。\nMMFモジュールの互換性グループ\n\n\n\nメーカー\n企業属性\nその他互換性のあるメーカー\n\n\n\nCisco\nネットワーク\nUbiquiti、Mikrotik、NETGEAR\n\n\nHP\nサーバー\n\n\n\nDELL\nサーバー\n\n\n\nintel\n半導体\n\n\n\nMellanox\n半導体・ネットワーク\n\n\n\nネットワーク業界においてデファクトスタンダードとなったCiscoのグループは、一般的にUbiquiti、NETGEAR、Mikrotikというネットワーク機器メーカーで互換性があります。Dell&#x2F;HPはサーバーのメーカーです。intel&#x2F;Mellanoxは半導体メーカーです。全体を俯瞰してみると3社の関係性が見えてきます。Ciscoは最もシェアが大きいネットワークメーカーなので他のネットワークメーカーもその接続性が大事になります。また、サーバーメーカーは、自社のライザーカード&#x2F;メザニンカードという独自の拡張カードを提供し、その上にネットワークカードを載せていたため、そもそも他のサーバーメーカーとの互換性はありません。唯一、intel&#x2F;Mellanoxは彼らにとってHP&#x2F;DELLは大切なお客様なはずで互換性を持っても良いのでは無いかと思うところです。しかしながらNICとSFP+モジュールの関係においてはあまりサーバーのメーカーは関係がなく、半導体メーカーとしてのNICとSFP+はセットでサーバーメーカーに卸すため、半導体メーカーで相互に接続する事は求められなかったのでしょう。\nMMFモジュールのベンダーロックインそれぞれの業界のトップシェアの会社（Cisco&#x2F;HP&#x2F;intel）はベンダーロックインの道を選びました。ベンダーロックインはプリンタが良い例で、本体を安く販売し、メーカー専用インクで利益を上げるビジネスモデルです。NIC&#x2F;SFP+の場合は、同一のベンダーのSFP+モジュールでないと使えないというものです。ただ、個人的にはプロテクトというよりは、互換性のテスト済みか否かという点で牽制という意味合いが強いのでは無いかと思います（Ciscoはコマンドの設定で他社モジュールの利用を受容します）。昨今ではモジュールメーカーがこれらの互換性についてノウハウを持っており、過度にベンダーロックについて気にする必要はなく、上記のグループにおける互換性を守ることがまずは基本です。2015年にはHPは分社化し法人部隊がHPEとなり、Arubaも買収しているので、細かいことを言えばこの2つのメーカーはもう少し複雑です。\nこれらを守れば100％接続できるというわけではありませんので、事前の下調べをお勧めします。\nSFP+ RJ45モジュールも内部的にはMMFモジュールと見せかけて動作させるようになっているので互換性についてはMMFモジュールと同様です。\nDACの互換性DACについては、「Cisco、intelまたはその他色々なメーカー」という大まかな分類で売っていることが多いです。そして殆どのメーカーのNICにもネットワーク機器にも繋がるものですが、ネットワーク装置側が規格に対応していれば、という条件付きです。国内のネットワークメーカーなどではDACの種類を選ぶ機器もあるようです。まずはネットワーク機器を購入される前にネットワーク機器のメーカーに相談されることをお勧めします。海外製品は口コミも多いので状況がよく把握できます。セキュリティ製品などは互換性が厳しくなっています。稀なケースですが、互換性が不十分でDACで接続できない場合は、MMFモジュール＋OM3の方式で接続します。例えば、ホストのNICがintelでスイッチがCisco互換機であれば、両端のモジュールはそれぞれのベンダーのモジュールを購入します。\nDACでは（基本的には）ベンダーロックインというよりは繋がらないのはほぼ互換性の問題です。DACは既に両端にモジュールが付いていますから、異なるベンダーの機器を接続する時にどちらかのベンダーの互換性を重視して購入する事がポイントになります（ですのでDACでベンダーロックインという事になるとネットワーク機器とサーバー（NIC）間の他社接続が出来ないわけで現実的にそれを好むベンダーは存在しないというものです）。残念ながらDACであっても互換性の問題は実際に存在しますので、NIC側の互換性をメインに考えるか、スイッチなどのネットワーク機器の互換性をメインに考えるか判断が必要です。\nその他ネットワーク機器と接続するMMFモジュールの互換性NASメーカーからもスイッチは販売していますが、ネットワークの世界で見ればマイナーなメーカーとなり、あまりお勧めはできません。またNETGEARなどは純正モジュールを販売しており、互換モジュールへの対応状況はメーカーサポートとしても言及が難しくなります。過去からの経緯に鑑み、Cisco互換モジュールを中心に選定しますが、メーカーサポート&#x2F;コミュニティ&#x2F;口コミを参考に購入していくことになります。\nSFP+モジュールの価格それぞれのモジュールの価格帯は以下の通りです。\n\n\n\nタイプ\n国内価格\n\n\n\nDAC\n1,500円〜2,500円\n\n\nMMF+OM3\nMMF 3,000円強(1つの値段)、OM3ケーブル 1,500円前後&#x2F;10m\n\n\n1000Base-T\n3,000円〜4,000円（1つの値段）\n\n\n10GBase-T\n10,000円（1つの値段）\n\n\nFS社のモジュールは世界的に見てもよく利用されています。日本語のWebサイトがあり円建てで購入できます。海外通販を利用する際、通常は2％程度の為替手数料を、PayPalに至っては通貨の追加設定をしないと4％の割高な為替手数料を適用されます。また、最近高騰している輸送コストでかえって割高になってしまいます。\n\nFS 10Gモジュール https://www.fs.com/c/10g-sfp-2320\n\nFSのWebサイトは法人向けがメインとあって、モジュールの注文画面ではCisco、Juniper、Aristaと有名な海外ベンダー名が列挙されています。もっと＋ボタンをクリックするとNetgear、intel、Mellanoxなどの名前が出てきます。それでも該当するメーカーが無い場合はカスタムのボタンをクリックすると、カスタムモジュールの注文画面に遷移し、さらに細かなベンダー一覧が表示されます。見つからない場合、対応ブランドに「その他」を、デバイスの型番に、メーカーと型番を記入すればOKです（FS社から教えてもらいました）。無償の技術サポートがあり質問もできます。法人を対象にビジネスされているでしょうし、個人ユーザーが色々聞くのも気が引けるかもしれませんが、きちんと回答してもらえます。\n\n\nDACについても互換性が心配な場合は、同様にベンダー名や機器名を記入し注文します。\nFS社は互換性に関する知識が豊富です。しかしながら、あまり極端に「このメーカー専用のDAC」などの販売をしていては、ユーザーは「SFP+は原則互換性がなく、専門家のサポートが無ければ繋がらない」という誤認を与えてしまっているのではないかと思うところがあります。それでも、個人に対してもしっかりサポートしてくれます。\n日本で購入できるグローバルなネットワーク機器メーカーのうち、UbiquitiのSFP+MMFモジュールは廉価です。トータルソリューションとなっており、スイッチとMMFモジュールの接続で悩むことはありません。\n\nUbiquiti SFP アクセサリー https://jp.store.ui.com/collections/unifi-accessories/products/sfp-accessory \n\nSFP+モジュールの発熱室温26度の状況下でそれぞれのモジュールの温度を計測しました。計測するにあたり以下の機器を使いました。これでモジュールの表面にこの金属のセンサを当てて温度を測ります。\n\n\n併せてスイッチのコマンドラインからモジュールの温度が取得できるのでそれも加え比較します。\n\nファン付きスイッチ\n\n\n\n\nNo\nタイプ\n実際の温度\nスイッチ上のCLI\n\n\n\n1\nDAC\n27℃\nなし\n\n\n2\n10GBase-SR(10m)\n32.9℃\n36.8℃\n\n\n3\n10GBase-SR(20m)\n33.8℃\n39.1℃\n\n\n4\n10GBase-T “Broadcom”\n36.2℃\n40.7℃\n\n\n5\n10GBase-T “Broadcom” 2.5Gbps動作 [1]\n32.3℃\n29.5℃\n\n\n6\n10GBase-T “MikroTik” S+RJ10\n40.3℃\n61.0℃\n\n\n7\n1000Base-T ASF-GE-T\n34.2℃\nなし\n\n\n8\n10GBase-T “Marvell” ASF-10G-T\n40.2℃\nなし\n\n\n\n(スイッチ:Ubiquiti USW-Pro-Aggregation)\n\n\n\n\n[1]スイッチは2.5Gbpsに対応し、10GBase-Tモジュールを2.5Gbpsでリンクさせています。\nNo1-5は常にスイッチに挿したまま、6,7,8は計測の都度挿し替えしています。\n\nファンレススイッチ\n\n\n\n\nNo\nタイプ\n実際の温度\nスイッチ上のCLI\n\n\n\n1\n10GBase-SR(20m)\n43.6℃\n48.61℃\n\n\n2\n1000Base-T ASF-GE-T\n44.6℃\nなし\n\n\n3\n10GBase-T “Marvell” ASF-10G-T\n48.6℃\nなし\n\n\n4\n10GBase-T “Broadcom”\n45.4℃\n54.3℃\n\n\n5\n10GBase-T “MikroTik” S+RJ10\n49.5℃\n67.06℃\n\n\n\n(スイッチ:Ubiquiti USW-Aggregation)\n\n\n\n\nNo1,2は常にスイッチに挿したまま、3,4,5は計測の都度挿し替えしています。\nファンレスのスイッチは筐体内部に熱を持つため、それがモジュールにも伝播しているのが分かります。また、”実際の温度”はモジュールのコネクタ部分に近い箇所を計測しています。スイッチのCLIで表示される温度は、モジュールのセンサーの1か所の温度でありモジュール全体ではありません。10GBase-SRの出す熱の範囲は高温ながら範囲が限定的で、センサーがなかなか一定数値にはなりませんでした（最も高い数値を採用しています）。10GBase-Tは測る場所によって多少温度は異なりますがモジュール全体から発熱しています。\n60℃を超えるとハードウェア環境面としては相当に厳しいでしょうか。まずはエアフローが大事ということになります。特にファンレススイッチを使う場合、この時期は問題ありませんが、夏場はエアコンまたはサーキュレーターが必要そうです。次に、可能な限り10GBase-Tを使わずDACや10GBase-SRを使い、熱を抑える必要があります。クライアントの10GBase-Tの速度を2.5Gbpsに落とすのも効果的です。ファンレスのスイッチで10GBase-Tを多用すると、スイッチがスローダウンまたはシステムダウンする可能性があります。\n技術面でポイントをまとめると以下の通りです。\n\n10GBase-Tを多用する場合はファンレススイッチでは厳しい（特に数十mの距離のツイストペアケーブルでは発熱が大きい）\n10Gネットワークを使う場合は可能な限りDACや10GBase-SRへの移行を\n10GBase-TモジュールのBroadcomチップ対応のもの（80m対応）は熱対策には有効\n1000Base-Tのモジュールも意外と発熱する。リビングなど多くの100&#x2F;1000Mbps機器が揃う箇所にはSFPのスイッチはかえって不向き。4Portなどの小型ハブに逃した方が良い\n\n個人ユーザーのニーズとしては静かなファンレスのスイッチを好む傾向にあり、メーカー側もファンレスや静かなスイッチを販売せざるを得ない傾向のように見えますが、今の10GBase-Tのファンレススイッチは空調がある場所が必要というのが結論です。メインのネットワークスイッチはSFP+を中心に使い、各部屋にOM3で繋いだ上で、ある程度の速度が必要なWi-Fi APやクライアント端末を2.5GbEのUTPで接続する方法が現実的です。24時間稼働するNASもPCIeがあるのであれば、SFP+のネットワークカードを使う事をお勧めします。\nネットワークカードの消費電力intel X710の4Portについて、10GBase-TのモデルとSFP+のモデルとで比較します。\n\n\n\n型番\n接続方式\n通常消費電力\n最大消費電力\n\n\n\nX710T4(旧型)\nUTP(RJ45)4Port 10Gbps\n23.7W\n28.9W\n\n\nX710TL4\nUTP(RJ45)4Port 10Gbps\n13.6W\n14.2W\n\n\nX710TL4\nUTP(RJ45)4Port 2.5Gbps\n9.5W\n9.9W\n\n\nX710DA4\nSFP+4Port 10GBase-SR\n6.2W\n6.6W\n\n\nX710DA4\nSFP+4Port DAC\n3.6W\n3.8W\n\n\n10GBase-Tは従来のX710T4はものすごい消費電力でしたが、X710TL4となり随分と消費電力が抑制されています。2.5Gbpsであればさらに抑制することはできますが、速度が1&#x2F;4になったからといって、消費電力が1&#x2F;4に下がるわけではありません。X710（40Gbpsのチップ）のポテンシャルが無駄になっているということでしょうか。\nこれに対してSFPは光の10GBase-SRは最大6.6Wとかなり抑制され、DACに至っては最大で3.8Wです。1Portあたり1w未満です。\n\nintel https://www.intel.com/content/dam/www/public/us/en/documents/product-briefs/ethernet-x710-brief.pdf\n\nMellanoxは2PortのNICが多く出回っています。Connect X-4以降は100Gbpsのチップで高機能という理由もありますが、消費電力も増えるようです。\n\n\n\n型番（いずれもパッシブケーブル接続）\n通常消費電力\n最大消費電力\n\n\n\nConnect X-3(MCX311A-XCAT)１Port\n3.47W\n4.84W\n\n\nConnect X-4(MCX4121A-ACAT)2Port  ※25GbE\n9.6W\n11.6W\n\n\nConnect X-5(MCX512A-ACAT)2Port ※25GbE\n9.5W\n11.8W\n\n\n\nMellanox Connect X-3\n \n\nMellanox Connect X-4&#x2F;X-5 https://docs.nvidia.com/networking/display/CX4LxEN/Specifications#Specifications-MCX4111A-ACATandMCX4111A-ACUTSpecifications https://docs.nvidia.com/networking/display/ConnectX5EN/Specifications#Specifications-MCX512A-ACATandMCX512A-ACUTSpecifications\n\nConnect X-4&#x2F;X-5は25GbEのイメージが強いですが、SFP+として10GbEで使えます。\nクライアント側の発熱抑制デスクトップPCを都度電源オフにせずスリープにされる方は、スイッチ側のSFPモジュールは通電している状態かもしれません。Windowsの省電力の設定で殆どリンクダウン状態にする事でより省電力、発熱を抑えられます。WakeOnLanを使わない方は設定を検討してはいかがでしょうか。\n\n\nSFP&#x2F;SFP+モジュールの挿入、取り外しモジュールの挿入は差し込むだけです。カチッと音がし、ロックされます。取り出すときはケーブルを抜き、ラッチを引き下げるとロックが外れます。ラッチを下げないと抜けません。無理に引き抜こうとするとスイッチやNICが破損します。\n\n\nこのとき、光が出ている部分を覗き込むと目を痛める恐れがありますので注意してください。\nDACも同様に差し込むのは簡単です。取り外すときは、プルタブを指に引っ掛けて引き抜きます。本来は簡単に引き抜けるようになっていますが、Amazonで販売している製品（10Gtek）のDAC、モジュールは特に引き抜きづらいものがあり注意が必要です。無理に片手でプルタブを強く引っ張るとスイッチやNICが破損しますので注意してください。引き抜きづらい製品を購入してしまった場合は、以下のようにモジュールの横を押さえてプルタブを引く事でラッチが外れやすくなります。\n\n\n10GtekのDACがどうしても抜けない時の対応方法です。ラッチに細いマイナスドライバーや精密ドライバーを引っ掛けてラッチを引き下げる事で抜けるようになります。\n\n\nMMFモジュールのラッチもメーカーによって様々ですが、以下のようにラッチを精密ドライバーなどで引っ掛けて手前に引いてラッチを外したり、手前から奥に押し込むと外れるタイプもあります。いずれもバネで止まっているものであり大きな力は不要です。このようにドライバーを引っ掛けるといってもテコの力でグッと強く押したり引いたりすると破損しますので注意してください。\n\n\nネットワークカードへのSFP+モジュールの挿入PCやNASのSFP+対応のネットワークカードにはSFP+モジュールを挿しますが、ネットワークカードからSFPポートへの電力供給は最大3W程度です。従い、DACやMMFトランシーバはもちろん問題ありませんが、10GBase-Tモジュールは電力を要するので基本的にネットワークカードには10GBase-Tモジュールを挿しません。電力供給が不足する可能性が高く、2.5Gbpsに速度が落ちたり、安定しないなどの事象が発生します。また、発熱のためにネットワークカードが破損する可能性があります。\nOM3ケーブルを配管に通すにはLC-LCをそのまま直径2cm程度の既存配管に通すのは難しいのですが、一旦端子部分を繋いでいるコネクタを外す事ができます。 \n私の場合、UTPケーブルの被覆を使い、コネクタ部分を被せるようにしてテープを巻いています。CD管&#x2F;PF管の内径の大きさの問題もありますが、LCのコネクタは長いので、CD管&#x2F;PF管が曲がる箇所を通過させるのが難しいところです。コネクタとコネクタの間を少し大きく取り、CD管が曲がっている場所も通りやすくします。通線ワイヤーとテープでしっかりと繋いで配管を通します。電話線など他の配線があって通せない場合は工事業者さんにお願いした方が良いでしょう（一旦電話線を抜いて光を通し、電話線を再配線すると楽ですが、電話線の敷設は資格が必要です）。最近、ショートノーズの新製品が出てきているので配管を通す場合はお勧めです。\n \n\nOM3については、Amazon Basicの製品で10m&#x2F;20mのものがあり、廉価でお勧めです。\n失敗事例とスイッチのDDM光ケーブルは弱いと書きましたが、既に配管にケーブルがあるにも関わらず追加でOM3を通そうとして途中の配管のカーブで詰まってしまい、諦めて戻したことがあります。UTPケーブルなら体重を掛けてぐいぐい引っ張るところですが、さすがにOM3のケーブルなので片手で引っ張る程度で手加減したつもりでしたが損傷していました。SFPトランシーバはDDM(Digital Diagnostic Monitoring)の機能を持ち、スイッチのCLIで光の強さなども把握できます（スイッチがその機能を持つ必要があります）。\nケーブルに損傷がないかスイッチのCLIで見た結果が以下です。\n(UBNT) &gt;show fiber-ports optics all                                                 Output   InputPort    Physical Port/  Temp  Voltage  Current   Power    Power     TX     LOS        Lane Number     [C]   [Volt]     [mA]    [dBm]    [dBm]     Fault------  --------------  ----  -------  -------   -------  -------   -----  ---0/1     0/1-Lane1       43.9    3.321      7.7    -2.947   -3.036   No     No0/4     0/4-Lane1       44.4    3.348      7.8    -2.818   -2.476   No     No0/16    0/16-Lane1      43.4    3.389      7.8    -3.011  -11.733   No     No0/21    0/21-Lane1       N/A      N/A      N/A       N/A      N/A   N/A    N/A0/22    0/22-Lane1       N/A      N/A      N/A       N/A      N/A   N/A    N/A0/23    0/23-Lane1       N/A      N/A      N/A       N/A      N/A   N/A    N/A0/24    0/24-Lane1       N/A      N/A      N/A       N/A      N/A   N/A    N/A0/28    0/28-Lane1      46.7    3.372      6.0    -3.010   -3.010   No     No\n\n上記Port16が該当のケーブルなんですが、Input Powerが-11.733dBmとなっています。これはケーブルの品質が極めて悪化していることを示しています。光ケーブルの品質は以下の表が参考にすべき内容となっています。大昔よりEMC社が提示しているリストで、多くの方に目安として使われています。私のケースだと、-11.733dBmなので2Gbpsも危ういということがわかります。実際のiperf3の計測では4Gbps〜5Gbpsほどは出ていますが、このケーブルは廃棄するしかありませんでした。\n\n\n\nmicrowatt\nmilliwatt\ndBm\nDescription\n\n\n\n1\n0.001\n-30\nLoss of Signal\n\n\n10\n0.01\n-20\n\n\n\n25.1\n0.0251\n-16\n2Gbps minimum accept signal\n\n\n31.6\n0.0316\n-15\n4Gbps minimum accept signal\n\n\n50\n0.05\n-13.01\n\n\n\n100\n0.1\n-10\n2Gbps minimum send signal\n\n\n125.9\n0.1259\n-9\n4Gbps minimum send signal\n\n\n150\n0.15\n-8.24\n\n\n\n200\n0.2\n-6.99\nNormal range of optical signal strength\n\n\n250\n0.25\n-6.02\n\n\n\n300\n0.3\n-5.23\n\n\n\n350\n0.35\n-4.26\n\n\n\n400\n0.4\n-3.98\n\n\n\n現実的なネットワークカードの選定intelのNICは低電力でお勧めですが、インフレということもあり、X710の2Portで49,200円（秋葉原のオリオスペック）とそれなりの値段です。標準的なNICといえます。日本のAmazonではSFP+のNICを探すのは難しくなっています。X520が売れ残っている状況ですが、セキュリティリスクを理解した上で導入される事をお勧めします。既にEOSL（Discontinued）で最新ファームウェアのダウンロードもできませんし、NIC自体の脆弱性の状況も分かりません。https://ark.intel.com/content/www/us/en/ark/products/series/42489/intel-ethernet-server-adapter-x520.html\nintelはチップのみを販売していることもあって、intel純正のNIC以外に、他社製造のNICでチップがX710という廉価な製品も見かけます。この場合、一般的にネットワークドライバはintelのものを使えますが、ファームウェアはOEMとして個別に提供される場合があるので、購入前に販売者に確認される事をお勧めします。\nMellanoxのNICはeBayで揃えるのが1つの方法です。海外通販になりますし、発送元は大半が中国からです。返品不可の出品者が多く、少しハードルは高いです。一般的なセオリーですが、評価の高い出品者から購入するのが無難と言えます。NAS、ESXi7、Windows10など動くとわかっている枯れたOSであれば5,000円未満となるConnect X-3を使ってみるのはアリです。既にEOSLを迎えているのですが最新ファームウェアもダウンロードできますし、Connect Xの脆弱性のレポートは無く比較的安心して使えるNICです。新しいOSを使う場合はConnect X-3は見送った方が良いです。VMware ESXi8やWindows11は対応しません。\n新しいOS向けにこれからSFP+を導入するならば、MellanoxのConnect X-4&#x2F;X-5が対象になります。Connect X-4（MCX4121A-ACAT）が$100、Connect X-5（MCX512A-ACAT）が$170です。将来的に25GbEも考えてみようかなと思う場合は、手元に置いておいても良いかもしれません。\nNICについては、Fibre Channel、InfiniBandとEthernetとは異なります。SFP+のNICを購入される時は、Ethernetのものを購入してください。\nスイッチの選定ワンルームでスイッチを利用するならファンレスを検討したいところです。一般的な使い方として、NASだけであれば2.5GbEが中心でSFP+までは不要かもしれません。しかしサーバーを立てて、細かいデータファイルやモジュールのバックアップを取るとなると10Gの速度が欲しくなるでしょう。ファンレスの10GbEならSFP+が最有力候補です。\nLDK〜のマンションや戸建てになれば、Wi-Fiアクセスポイント（AP）も2台は置きたくなりますし、AmazonアレクサやAppleTVなどのIoT機器も増えるでしょう。やがて監視カメラなどを繋げるようになると安定した有線接続も必要になります。メインのスイッチはSFP+の口を多めのものに、そこにサーバー群を10G SFP+で接続、各部屋へ2.5Gbps&#x2F;1Gbpsのツイストペア接続、または10GbEのSFP+接続とし、各部屋のスイッチはWi-Fi AP、家電、IoT、監視カメラへと接続しやすい、マルチギガのスイッチまたはPoEスイッチを用意されると良いのではないかと思います。\n各部屋の配線全てを光ケーブルにする必要もありませんが、OM3を引いておけば、将来25GbEの対応は容易です。\n個人向けのWi-Fiルータは値段なりの機能・品質ですし、4Port程度の機器を繋ぐことができますが、高度なことは出来ません。リモートワークや今後のWi-Fiの進化などを踏まえ、VLANも用意した上でしっかりとしたネットワーク敷設を考えられるのであれば、ネットワークに特化したメーカーの製品を導入される事を検討されてはいかがでしょうか。メインスイッチはファン付きで信頼性のある安定した製品を選定されることをお勧めします。\nまとめもし、既存のネットワークで発熱、ファンの騒音、電気使用量が気になるのであれば是非SFP+にチャレンジしてみてください。低レイテンシ・低発熱のネットワークが構築できます。\nなお、SFPの注意点としてはNBase-T(2.5Gbps&#x2F;5Gbps)に対応していないスイッチも多く存在することです。一般的なRJ45のSFP+モジュールはNBase-Tへの対応を謳う製品もあり、リンクアップ出来る場合がありますが、モジュールが2.5GbEと認識できていてもスイッチ自体が10GbEと認識しており、速度のミスマッチにより十分な速度が出ません。2.5GbEに対応していないSFP+のスイッチであっても、ハックとして2.5GbEの機器と接続する方法は一応あります。SFP+のNBase-Tへの対応については「SFP+の2.5GbE対応」を参照してください。\n","categories":["Hardware","Network"],"tags":["SFP+","10GbE"]},{"title":"XG Firewall v18のSSLインスペクションの動作確認と調整","url":"/new-technology/2020/03/21/ssl-inspection2/","content":"この記事で実現すること\nXG FirewallのSSL/TLSインスペクションが有効に機能している事をテストマルウェアを使い検証します。また、SSL/TLSインスペクションによって接続出来なくなる場合は除外設定を行います。\n\n\nSSL&#x2F;TLSインスペクションの動作確認前回までの記事でXGのSSL&#x2F;TLSインスペクションの設定が完了している事を前提にしています。SSL&#x2F;TLSインスペクションに関する記事は以下を参照してください。\n\nSSLインスペクションについて\nXG Firewall v18のSSL&#x2F;TLSインスペクションの設定\n\nIPS（Intrusion Prevension System）によるSSLインスペクションでの動作確認のため、テストマルウェアの検知について行います。有名どころでは、eicarのテストマルウェアが挙げられます。早速、ダウンロードページにまいりましょう。eicarのダウンロードページに行くと、Download area using the secure, SSL enabled protocol HTTPSという項目があり、httpsの4つのダウンロードリンクがあります。\n\neicar https://www.eicar.org/?page_id=3950\n\n\n実行ファイル\n実行ファイルをtxtに拡張子を変えたもの\nzipに圧縮したもの\nzipの二重圧縮\n\n実行ファイルについては、マルウェアを検知する前にXGのポリシーによって、実行ファイルをダウンロードできないという表示になる可能性があります。その際はWebのポリシーで修正するか、ルールとポリシーを修正し実行ファイルを一時的に許可し、確認してみて下さい。前回までの記事で記載してきた通り、SSL&#x2F;TLSインスペクションが行えるクライアントと行えないクライアントで挙動は変わります。\nSSL&#x2F;TLSインスペクションが行えるクライアントは、この4つを全て検出し、ブラウザにはXGによるマルウェア検知のエラー画面が表示されます。PCに入っているウィルス対策ソフトが検知する以前にダウンロードは行わない挙動となります。また、SSLインスペクション対象外のクライアントからのアクセスについてはhttpsのダウンロードはマルウェアを検出できず、ダウンロードしてしまいます。\nIPSは速度と検出能力という相反する事を同時に成り立たせなくてはいけません。上記のようにマルウェアの検出は可能ですが、あくまで通信で怪しいものをカットする程度に考え、クライアントにはウィルス対策ソフト（Windows Defenderを含む）やマルウェア対策ソフトの導入をお勧めします。Sophosはホームユーザー向けに無償のウィルス対策ソフトを提供していますが、個人的には異なる会社のソフトを組み合わせて使う事をお勧めします。\nSSL&#x2F;TLSインスペクションの除外XGは、Webフィルターやアプリケーションフィルターなどのポリシーで接続の可否を判断しますが、実はSSL&#x2F;TLSインスペクションが理由で接続できないという問題も発生します。これは以下の通りです。\n\nTLSが正当ではないと判断される\nXGの証明書がアプリケーションに認められない\n\n接続できない理由は後述しますが、XGは、XG自身で最初からSSL&#x2F;TLSインスペクションの対象外とするドメインリストを既に保持しています。そのリストになく、自身で利用するサイトやアプリケーションがSSL&#x2F;TLSインスペクションによって動作しない場合は個別に当該ドメインをSSL&#x2F;TLSインスペクションの対象外と指定します。\nXGで最初からSSL&#x2F;TLSインスペクションの対象外となっているリストは、XGの左ペインメニューwebの”URLグループ”にManaged TLS exclusion listがあり、ここに複数の有名なWebサイトのドメインが列挙されています。\n\n\nこのリストは編集できません。ファームウェアの更新によって管理されます。\n\n\n除外設定除外リストManaged TLS exclusion listにドメインが列挙されておらず、またポリシー上は利用できるはずのWebサイトに接続できない場合、XGの画面右上のログビューアからSSL&#x2F;TLSインスペクションを選択しSSL&#x2F;TLSインスペクションでエラーが発生していないか確認を行います。Web→URLグループのLocal TLS Exclusion Listという個別にカスタマイズ可能なリストがあるので、そのリストにドメインを追加する事でSSL&#x2F;TLSインスペクションの対象外とできます。以下の通り、SSL&#x2F;TLSインスペクションルール画面では、デフォルトの除外リストにManaged TLS exclusion listおよびLocal TLS Exclusion Listが存在します。Local TLS Exclusion Listの初期状態は何も登録されていません。\n\n\n\nSSL&#x2F;TLSインスペクションによって接続できない理由SSL&#x2F;TLSインスペクションで接続できない理由の1つ目は、SSL&#x2F;TLS証明書の正当性を厳しくチェックしすぎる場合が該当します。過渡期ではありますが、まだまだ古いバージョンのTLSが利用されていサイトもあります。これを緩める場合は、XGの左ペインメニュールールとポリシーの”SSL&#x2F;TLSインスペクションルール”画面で、SSL&#x2F;TLSインスペクションを行っているプロファイルのルールを緩めるか、”SSL&#x2F;TLSインスペクションの設定”をカスタマイズします。\n\n\nもう1つの接続できない理由は、アプリケーション自体が、OSにインストールされた証明書などを認めていないケースです。こちらはアプリケーションの内部に証明書を保持しており、その証明書の正当性を確認しているケースです。以下の例ではpython関連のモジュールをアップグレードするケースで以下のエラーが発生します。\n&gt;pip3 install --upgrade pipWARNING: Retrying (Retry(total=4, connect=None, read=None, redirect=None, status=None))after connection broken by &#x27;SSLError(SSLCertVerificationError(1,&#x27;[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get local issuer certificate (_ssl.c:1076)&#x27;))&#x27;: /simple/pip/\n\nXGの画面右上にある”ログビューア”から”SSL&#x2F;TLSインスペクション”を選択し、どのURLのSSL&#x2F;TLSインスペクションが行われているのかを確認できます。また、エラーがある場合は、そこで除外を指定する事で自動的にLocal TLS Exclusion Listにドメインが追加されます。下記はあくまで一例ですが除外しておいた方が良いドメインを列挙します。追加した証明書を参照しないプロダクトはアプリケーションの挙動とこのログを見ながら手作業でLocal TLS Exclusion Listに除外するドメインを追加する作業を行います。\n\n\n\nドメイン\n内容\n\n\n\npypi.org, pythonhosted.org\nPython関連\n\n\nnpmjs.org\nNode.js関連\n\n\ngithub.com\nGitHub\n\n\nubuntu.com,snapcraft.io\nubuntu関連\n\n\nlivepatch.canonical.com\nubuntu関連\n\n\nauone.jp, paypay.ne.jp, merpay.com\n〜pay関連\n\n\nnorton.com\nNorton AntiVirus関連\n\n\nd.line-scdn.net\nLINE動画\n\n\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"XG Firewall v18のSSL/TLSインスペクションの設定","url":"/new-technology/2020/03/20/ssl-inspection1/","content":"この記事で実現すること\nXG Firewall v18のSSL/TLSインスペクションを使い、暗号化されたSSL/TLS通信を解読します。これにより、ウィルスやマルウェアなどの脅威を通信中に検出し、PCやiPhone等（Windows、macOS、Linux、iOS）が攻撃を受ける前に防御できるようになります。\n\n\nXG Firewall v18のメリットXGでは暗号化された通信を高速に解読し、ウィルスやマルウェアのダウンロードをPCやスマホが受信する前に防ぐ事が可能となります。また、利用を認めていないアプリケーションのデータのやりとりを未然に防ぐ事も可能です。v18では、全く新しいXStreamアーキテクチャによって、この解読（SSL&#x2F;TLSインスペクション）の速度が大幅に向上しました。\nSSL&#x2F;TLSインスペクションの対象ホストを決める「SSLインスペクションについて」に記載した通り、SSL&#x2F;TLSインスペクションを行うためには、PC等のクライアントにXGのCA証明書をインストールする事が必須となります。従いSSL&#x2F;TLSインスペクションの対象のグループ、家電やAndroidなどのSSL&#x2F;TLSインスペクションを使えないグループとに分類します。この2つのグループはIPアドレスの範囲で分割するのが最も簡単な方法です。例えば、SSL&#x2F;TLSインスペクショングループはスタティックでIPを割り当て、非SSL&#x2F;TLSインスペクショングループはDHCPで動的なIPアドレスを配布する方法があります。XGのDHCPサーバーはMACアドレスを元に固定IPをスタティックに割り振る事が可能です。\nSSL&#x2F;TLSインスペクションの対象をDHCPに登録する左ペインのネットワークからDHCPのタブをクリックし、Default DHCP Serverをクリックします。そこには、”スタティックIP_MACマッピング”があるので、DHCPで自動リースをしている以外のIPアドレスをスタティックに割り振って登録してください。管理の一例としては以下の通りです。\n\n証明書を登録できないIoTなどをDHCPで192.168.2.101〜192.168.2.128を動的割り当て\n証明書が登録可能なホストをスタティックIPマッピングで192.168.2.129〜192.168.2.192を固定割り当て\n\nここはユーザーの「決め」ですが、上記で証明書がインストール出来るグループを”IPホスト”としてXGに登録しましょう。左ペインのホストとサービスから、IPホストのタブをクリックし追加ボタンをクリックします。以下の通り、ホストのIPの範囲を示す名前を入力し、IPの範囲を入力して保存ボタンをクリックします。ここでは、CA_Client_IPv4として登録する事にします。\n\n\nファイアウォールルールの設定左ペインのルールとポリシーからルールとポリシーを選択します。「XG Firewall v18のルールを作成する」にて、デフォルトのルール”To_Internet”を作成しました。Traffic to WANのグループ配下に”To_Internet”ルールがある事を確認してください。このファイアウォールルールはLANおよびVPNからWANへの接続を許可するシンプルなものですが、今回これは修正しません。XG v18では、SSL&#x2F;TLSインスペクションとファイアウォールルールは互いに独立していて、別メニューで設定する事になります。\nSSL&#x2F;TLSインスペクションルールの設定ここで、SSL&#x2F;TLSインスペクショングループと非SSL&#x2F;TLSインスペクショングループとの明確化を行います。左ペインのルールとポリシーからSSL&#x2F;TLSインスペクションルールをクリックします。\n\n画面右側の追加ボタンをクリックします\nルール名を入力します。ここでは”Catch_SSL”とします\nルールの位置は”最下位”のままにします\n処理は復号化を選択します\n復号化のプロファイルはStrict Complianceを選択します\n送信元の送信ゾーンは、”LAN”と”VPN”を選択します\n送信元ネットワークとデバイスは、”任意”を外し、SSL&#x2F;TLSインスペクショングループとして作成した”CA_Client_IPv4”を選択します\n宛先とサービスの宛先ゾーンは、”WAN”を選択します\n最後に保存ボタンをクリックします\n\n暗号化のプロファイルのStrict Complianceは一番厳しいものです。左ペインのプロファイルの”復号化のプロファイル”を見てもらうと分かりますが、TLS1.0と1.1を認めないという事です。主要なブラウザは2020年上半期にTLS1.0と1.1を無効化するので、この設定が主流になると予想されます。\nXGのCA証明書をクライアントにインストール左ペインの一番下の証明書から、認証局（CA）をクリックします。この中にSecurity Appliance_SSL_CAという名前の証明書があります。今回これをクライアントに配布していく事になります。右の下向きの矢印があるダウンロードを選択してクライアントにルート証明書をダウンロードします。Security Appliance_SSL_CA.pemという名前になります。\n\n\nルート証明書をダウンロードした後、クライアントへのインストールについては、OS毎に手順をそれぞれ確認し設定します。\nWindowsにルート証明書をインストール\nプログラムとファイル名の検索のボックスにMMCと入力してMicrosoft Management Consoleを開きます。\nファイル-スナップインの追加と削除を選択して\"スナップインの追加と削除\"を開きます。\n\n\n\n\n一覧から証明書 を選択して、追加をクリックすると”スナップインの追加と削除”のウィンドウが開かれます。\nコンピュータアカウントを選択して、次へをクリックします。\nローカルコンピューターがラジオボタンで選択されている事を確認し完了をクリックします。\n“OK”をクリックして証明書をスナップインに追加すると”スナップインの追加と削除”のウィンドウに証明書（ローカルコンピューター）が表示されます。\n\n\n\n\n証明書（ローカルコンピューター）のコンテナを展開して、信頼されたルート証明機関を右クリックして、”すべてのタスク &gt; インポート”を選択して証明書インポートのウィザードを開始します。\n証明書インポートのウィザードでは、参照ボタンをクリックして、拡張子pemを読み込むためすべてのファイル(＊.＊)を選び、XGからダウンロードした、Security Appliance_SSL_CA.pemを選択します。\n\n\n\n\n\n9.信頼されたルート証明機関としてXGの証明書を登録し完了です。\nmacOSにルート証明書をインストール\niCloud Driveに証明書を配置します\nローカルドライブに証明書をコピーします\n証明書を開きます。キーチェーンアクセスが起動するので、以下のようにキーチェーンアクセスから証明書を”常に信頼する”設定を加えます\n\n\n\n\n\nLinuxにルート証明書をインストール\nLinux側にsshで接続できる事が前提です。PCなどからscpで証明書をLinuxにコピーします\n\n  $ scp ./SecurityAppliance_SSL_CA.pem linux-host:/tmp/ca.crt\n\n\nLinux上で証明書をインストールします。\n\n ubuntu、Debianの場合\n  $ sudo cp /tmp/ca.crt /usr/local/share/ca-certificates/$ sudo update-ca-certificates\n CentOS、Fedora、またはRedHatベースのシステムの場合  $ sudo cp /tmp/ca.crt /etc/pki/ca-trust/source/anchors/$ sudo update-ca-trust※ubuntu20.04で動作確認をしています。\niOSにルート証明書をインストールiOSで「ファイル」アプリを使います。\n\niCloud Driveに証明書を配置します\n“ファイル”アプリを起動します。iCloud Driveから証明書ファイルをタップしダウンロードします\n“プロファイルがダウンロードされました”と表示されます\n設定アプリを起動します\n“設定”→”一般”→”プロファイル”と進みます\nダウンロード済プロファイルに、Sophos SSL CA_xxxxが表示されているので、タップします\n画面右上の”インストール”をタップします\niOSのパスコードを入力します\n右上のインストールを再度タップし、インストールを完了します\n“設定”→”一般”→”情報”と進みます\n画面の一番下の”証明書信頼設定”をタップします\nSophos SSL CA_xxxxが表示されているので、スイッチを右側に移動させオン（緑色点灯）します\n\nFirefoxへの証明書インストールFirefoxはOSの証明書ストアを参照しないため、ブラウザ自身に証明書を取り込む必要があります。ブラウザの設定から以下の通り証明書を取り込みます（ubuntuの例）。\n\n\n動作確認ブラウザの鍵マークをクリックする事でXGの証明書によって再署名されている事が確認出来ます。XGのログイン後のコントロールセンターの左上にライセンスナンバーが記載されていますが、実際の証明書でもそのナンバーが確認出来ます。\n\n\nこれで証明書のインストールは完了です。この証明書のインストールがXG Firewallの設定で一番大切な部分です。\nXGのCA証明書がインストールできないIoT機器をSSL&#x2F;TLSインスペクションの対象とすると、証明書エラーとなり機器が正しく動作しなくなる可能性があります。\n\n\n（2020-09-30追記）iOS14より、Wi-Fiの設定にプライベートアドレスという項目が追加されています。これはWi-Fiネットワーク毎にMACアドレスを自動的に変更し、匿名性を保つ機能になります。このページでXGのSSL&#x2F;TLSインスペクションを利用する際は、MACアドレスを元にDHCPでいつも同じIPアドレスが配布される仕組みを推奨しています。つまり、このMACアドレスが毎回変わるようだと固定IPを割り当て出来ません。対策としては、自宅のWi-Fiについてはプライベートアドレスをオフにする（推奨）、或いはiOSに最初からスタティックのIPアドレスを割り振る方法があります。Apple社からのプライベートアドレスに関する説明がされています。この機能の目的は以下のようです。\n\nデバイスがすべてのネットワークで常に同じ Wi-Fi MAC アドレスを使っていると、時間の経過に伴い、ネットワークの事業者やその他のネットワーク観測者がそのアドレスをデバイスのネットワーク活動や位置情報に紐付けることがたやすくなります\n\n詳細は以下の記事を参照してください。\n\nApple -iOS 14、iPadOS 14、watchOS 7 でプライベート Wi-Fi アドレスを使う- https://support.apple.com/ja-jp/HT211227\n\n自宅での利用の場合は見知らぬMACアドレスがあると、知らない端末からの接続があったのかとちょっとびっくりしますので、自宅では使用しない選択が良いでしょう。\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"XG Firewall SSL-VPN","url":"/new-technology/2021/05/30/ssl-vpn/","content":"\nこの記事で実現すること\n\nXG FirewallのSSL-VPNを構成し、実家や友人宅または、ホテル滞在時など公衆Wi-FiをはじめとしたさまざまなWi-Fi環境下においてIPSec-VPNよりも接続可能性を高める事を目的にします。SSL-VPNのTCPの待ち受けポートを設定し、自宅がv6プラスの環境でも接続可能となる期待があります。公衆Wi-Fiによく見られるIPv4アドレスのみ払い出しされる環境においても、IPv4 VPNトンネルの中でIPv4&#x2F;IPv6デュアルスタックによるインターネットアクセス、および自宅LANリソースにアクセスできます。\n\n\nXG FirewallのIPSec-VPNIPSec-VPNは一般的に安全性が高く安定しているため、それが使える場合はまずは最優先候補に挙げられますが、制約があります。\n\nv6プラスの環境では接続に必要なポートが制限され接続できません（別途PPPoEで接続している場合は可能です）。\n公衆Wi-Fiの一部では最低必要なUDPを除き、UDP全般を止めているところがあります（VPNを禁止していないところでも）。\n公衆WIFIではIPv4のみ提供している場所が多いです。\n\nSSL VPNについてSophosは昨年（2020年10月）にSophos Connectクライアント Ver2を発表し、SSL VPNで接続できるようになりました。またv18 MR3より、SSL-VPNのパフォーマンスが向上しているとの事です。\n\nSophos Connectクライアント Ver2 https://partnernews.sophos.com/ja-jp/2020/10/products/sophos-connect-v2-remote-access-vpn/\n\nXGのIPSec-VPNの速度と安定性は大変満足していますが、IPv6インターネットに対応しません[1]。デュアルスタック環境のWi-Fiに接続した場合、VPNを張ってもIPv4のみがVPNを経由し、IPv6は素のままInternetに出ていきます。また大部分のUDPポートが止められているケースを想定し、IPSec-VPNとは別にSSL-VPNもセットアップしておこうと考えました。前述したSophosのドキュメントでは、”macOSサポートが間も無く予定されていますが”との事ですが、なかなか発表される様子がありません。Big Sur対応で苦労されているんでしょうか。現時点において、IPSec-VPNを補完するHTTPS接続によるSSL-VPN構成を考えてみます。\nSSL VPNの構成ここでは、一般例としてXGとインターネットとの間にホームゲートウェイ（HGW）が配置されている前提です。もちろん、IPv4のみのネットワーク環境でもVPNは構築できます。自宅のパブリックIPアドレスに接続するためにダイナミックDNS(DDNS)としてSophosが提供しているmyfirewall.coを使います。\n \n\n\n\n\nネットワーク\n内容\n\n\n\nIPv4 LAN Segment①\nLANで利用しているIPv4プライベートネットワーク\n\n\nIPv6 LAN Segment②\nLANで利用しているIPv6プライベートネットワーク。fdxx:xxxx:xxxx/48を先頭に持つ64ビットPrefixのユニークローカルアドレス（ULA）です。\n\n\nIPv4 Session③\nXGのWANに流れるInternet向けのトラフィックです。このセグメントは一般的にプライベートIPで、HGWでNAT変換されます。\n\n\nIPv6 Session④\nXGのWANに流れるInternet向けのIPv6トラフィックです。このセグメントは一般的にHGWからDHCPv6またはRouter Advertisement(RA)によって、パブリックIPアドレスが振られます。\n\n\nここまでが通常LANからInternetに接続する構成です。そしてSSL-VPNではIPv4のVPNトンネルを1つ、その中にIPv4セッション、IPv6セッションを張ります。このトンネルを張る事で、XGの物理インタフェースのWAN、LANに加えて仮想のVPNセグメントが設定されます。\n\n\n\nネットワーク\n内容\n\n\n\nIPv4 SSL VPN Tunnel⑤\nテザリングや公衆Wi-Fiで振られたIPアドレスから、Internetを経由し、XGのWANポートとを結ぶセッション。\n\n\nIPv4 VPN Segment⑥\nVPNトンネルの中で作成される仮想IPv4ネットワーク。これはLANとは異なるプライベートIPネットワークアドレスです。\n\n\nIPv6 VPN Segment⑦\nVPNトンネルの中で作成される仮想IPv6ネットワーク。これはLANとは異なるULAです。\n\n\n仮想のVPNセグメントは、LANとネットワークアドレスを重複させてはいけません。あくまで別のセグメントです。また可能性は低いですが、公衆Wi-FiなどプライベートIPを使う場所でVPNセグメントのプライベートIPと重複し、VPNセッションを張れない可能性があります。私が知る限り、公衆Wi-Fiでは10.x.x.xのネットワークが多く使われるようです。⑤のトンネルが張られると、クライアントでは仮想ネットワークインタフェースSophos TAP AdapterがActiveになります。 \nSSL VPNの事前準備\nVPNセッションのためのIPv4ネットワークアドレス（IPの範囲でも可能）を決める\nXGのSSL待ち受けポートを決める\nDDNSのホスト名を決定する\nVPNセッションのためのIPv6 ULAを決める\n\nXGのSSL-VPNはUDPがTCPの3倍ほど高速ですが、公衆Wi-Fiを使う場合、安全・安心・確実に接続するにはHTTPS(443&#x2F;TCP)を使う事が手堅いです。自宅がv6プラスの方はプロバイダーから自宅まで通す事のできるポートの範囲を選定する事になります。\nLANのIPv6は、「Sophos FirewallでIPv6の設定を行う（後半）」の記事で設定したように、ULAの48ビットPrefixにサブネットの16ビットを加えて64ビットPrefixを決定しました。今回のVPNはサブネットの16ビットの値を変える事で別のセグメントを割り当てます。\nサーバー（XG）側の設定SSL VPNの設定XGの管理画面の左ペインVPNを選択すると、右上にVPN設定を表示という項目があるのでこれをクリックします。さらにSSL VPNとL2TPのタブがありますので、SSLVPNを選択します。\n\n\n前の章で事前に決めた設定内容を加えていきます。\n\n赤枠で囲ったTCP&#x2F;UDPの別はTCPとポート番号、そして、ホスト名の上書きというところはNo-IPなどのダイナミックDNSホスト名を入力します。設定可能なダイナミックDNSについては、「XG Firewall VPNについて」の記事を参照してください。\nIPv4のVPNネットワークの範囲は、LANやその他競合しないと思われるプライベートIP群から設定します。デフォルトの10.xでも構いませんが、あまり使われない、192.168.200.x/24近辺を使ってはいかがでしょうか。\nVPNクライアントが参照するDNSはXGのDNSですので、XGのLAN側IPアドレスを入力します。\nIPv6は利用しているULAの別のサブネットを設定します。fd00:beef:cafe:2::/64をLANで使っているとすれば、fd00:beef:cafe:12::/64という具合です。\nIPv6を利用するのであれば、リースモードを”IPv4とIPv6の両方”を選択します。\n\n適用をクリックし変更を完了させます。\nもし、VPNの待ち受けポートを443&#x2F;TCPとするならば、ユーザーポータルがデフォルト443&#x2F;TCPですので合わせて変更する必要があります。これは、XGの左ペインメニューの管理→管理者とユーザーの設定にユーザーポータルHTTPSポートとありますので、そこの443を別のポートに変更します。\nホスト名の上書きにDDNSホストを登録しないとVPN設定ファイルにXGのWANのプライベートIPアドレスが含まれてしまい、VPN接続に大幅に時間が掛かりますので必ず設定してください。XGにパブリックIPアドレスが割り振られている環境の方は設定は不要です。\n\n\n利用セグメントのIPホストへの登録XGでは、セグメント間の通信には必ずそのネットワークの名前を登録し、その名前でアクセス許可を行うため、ネットワークやホストの名前を付ける必要があります。左ペインメニューのホストとサービス→IPホストでVPNとLANの相互アクセスのために、LANで利用しているIPv4のネットワークアドレスとIPv6のネットワークアドレスを登録します。\nまた、SSLインスペクションをVPNでも使う方は、VPNで割り当てる上記のIPv4の範囲とIPv6のネットワークアドレスを登録します。\n以下のように、VPNのネットワーク、いつも利用しているLANの合計4つ（IPv4のみであれば2つ）を名前をつけて登録します。\n\n\n\nVPNユーザーの作成初めてVPNを設定する方はユーザーの作成が必要です。既にIPSec-VPNを設定されている方は対応不要です。XGの左ペインメニューから認証を選択、ユーザーのタブから、追加ボタンをクリックします。そして以下のようにユーザー名、パスワードとメールアドレスを入力します。\n\n\n\nSSL VPN設定2左ペインメニューのVPNからSSL VPN（リモートアクセス）に進み、追加ボタンをクリックします。\n\n\n\n名前を決め、ポリシーメンバーには、ユーザーグループまたはユーザーを追加します。\nデフォルトのゲートウェイとして使用を\"ON\"にします。\n許可するネットワークソースには、上記で作成済みのLANのネットワークアドレスを追加します（VPNのネットワークアドレスではありません）。\n\n適用をクリックして登録を完了させます。\nXGをデフォルトゲートウェイとする事で、DNSを含めた全てのリクエスト情報を公衆回線に流さない事をお勧めします\n\n\nデバイスのアクセス左ペインメニューの管理からデバイスのアクセスに進み、ローカルサービスACLでWANにSSL VPNの権限を付与します。また、VPNからXGのDNSが参照できるように設定します。\n\n\nLANからVPNを張る事が無ければ、LANのSSLVPNのチェックは外した方が良いでしょう。\nファイアウォールルールファイアウォールルールでは、VPNからInternetとLANへのアクセスを許可します。送信元ゾーンがLANとVPNになっている事を確認します。\n\n\nまた、LANとVPNとが相互に許可されている事を確認します。\n\n\nこれらはIPv4、IPv6それぞれで設定が必要です。また、NATルールに関しては、WANポートから出ていくパケットが変換対象となるので追加設定は不要です。ただし、XGv17以前の互換性のために用意されているLinkedNATを利用されている方は、ファイアウォールルール毎に対応したリンクNATルールを追加してください。\nもし、VPNに対してもSSLインスペクションを有効にするのであれば、SSL&#x2F;TLSインスペクションのルールにVPNセグメントのネットワーク情報を追加します。\n\n\nホームゲートウェイの設定HGWはユーザーの環境によって異なりますが、IPsec VPNで設定したように、HGWでIPv4のSSL VPNに関するパケットをXGに着信させる設定を加えます。\n\n\nVPNクライアント（Windows）Windowsでは、Sophos提供のSophos Connectを利用します。クライアントとVPN設定ファイルのダウンロードのために、ユーザーポータルhttps://xgのIPアドレス:443/にログインします。ユーザーポータルの待ち受けポートを変更された方は443を適切な値に変更してアクセスしてください。\n\n\n赤枠で囲った”Download client for Windows”のリンクをクリックします。Windowsクライアントのセットアップは難しくありません、順に進めていけば完了します。セットアップが完了するとプロセスがタスクバーに常駐します。続いて、”その他のOS向け設定のダウンロード”を行います。ここでは拡張子ovpnのファイルがダウンロードされます。ダウンロードしたファイルをダブルクリックすると、VPN設定ファイルがSophos Connectに取り込まれます。\n\n\n少し判りづらいですが、Homeの項目がIPSec-VPNでmyfirewall.coのものがSSL-VPNです。\nユーザーIDとパスワードを入力し、接続ボタンをクリックすると接続に掛かる時間は12秒程度でしょうか、IPSec-VPNが2〜3秒程度なので、結構時間が掛かる気がします。\n\n\nこのSophosConnectはアプリケーションの作りが洗練されていません。一旦接続しにいくと、キャンセルをクリックしようとしてもボタンが押せず、タイムアウトが発生するまで、十数秒〜数十秒くらい待たされてしまいます。Sophos Connectの紹介記事ではmacOS向けにOPENVPN Connectを勧めていますが、OPENVPN Connectは、Windows版もあります。OPENVPN ConnectではVPNの接続ネゴシエーション中にキャンセルすると即座にVPNサーバーに対しRSTを送信すると共に、瞬時にUIもキャンセル応答します。このあたりは流石デファクトスタンダードというところでしょうか。もちろん、正しくセションを終了した時は行儀良くFINを送信し接続終了しています。IPSec-VPNとSSL-VPNとで2つのクライアントを持つのが嫌でなければ、操作性でシンプルなOPENVPN Connectのほうが使い勝手が良いでしょう。設定もovpnファイルを取り込むだけでそれ以外の設定はありません。\n\nSophos Connect https://partnernews.sophos.com/ja-jp/2020/10/products/sophos-connect-v2-remote-access-vpn/OPENVPN Connect https://openvpn.net/vpn-client/\n\n\n\nVPNクライアント（macOS）macOSはOPENVPN Connectがお勧めされているわけですが、私はTunnelblickをお勧めします。こちらはオープンソースでGNU GPLv2です。UIが少し古いかなという印象はありますが、日本語に翻訳されており細かい設定が可能で詳細なログも分かり易いのでエンジニア向けです。設定は2箇所あります。\n\nTunnelblick https://tunnelblick.net/\n\n\n\n\nIPv6無効のチェックを外しIPv6を有効にする\n不意の切断時に「ネットワーク接続を切断する」を選択する\n\nこの2つの設定を加えます。後者はいつの間にかVPNセションが切れていてVPNを通さず公衆Wi-Fiを使っていた、という事が無くなり、ピタリとアクセスが止まります。安全措置として良い機能です。\nmacOS Big Surではインストールに少し手間が掛かるようです。詳細は以下の記事を参照してください。\n\nInstalling System Extensions https://tunnelblick.net/cKextsInstallation.html\n\nこれら2つのクライアントは、Homebrewからもインストール可能です。brew install openvpn-connect --caskbrew install tunnelblick --cask\nTunnelblickは前述した接続キャンセル時の応答性も機敏です（RST送信と即座のUI応答）。\nVPNクライアント（その他）スマホ、Linux向けにも、OPENVPN Connectがあります。設定ファイルの取り込みは、クラウド経由やメールの添付などの方法でアプリに渡します。\nワンタイムパスワードXGではSSL-VPNにおいても2要素認証の設定が可能ですので設定される事をお勧めします。「XG Firewall VPNに2要素認証を設定する」の記事を参照してください。XGにおけるVPN-SSLのワンタイムパスワードはパスワードの文字列に続けてOTPの数字6文字を入力する事で2要素認証を行います。パスワードが”abcdef”でOTPが”123456”ならば、パスワードに”abcdef123456”を入力します。\n [1]IPSecによるサイト間接続VPNはIPv6に対応しています。クライアントからのリモートアクセスとしてのIPSecはIPv6未対応です。\n","categories":["Security","VPN"],"tags":["XG Firewall"]},{"title":"Ubiquiti UniFiの世界","url":"/new-technology/2022/08/27/ubiquiti-unifi/","content":"\n\nこの記事で実現すること\n\n米国Ubiquiti（ユビキティ）社のネットワーク製品群であるUniFiを紹介します。Ubiquiti社はAppleにも在籍経験のあるロバートJ・ペラ氏が立ち上げた会社でWi-Fiネットワークの製品に強みを持っています。NY証券取引所にも上場しており、ビジネス向けのネットワーク機器販売が主力のビジネスです。Ubiquitiにもいくつか製品群があり、このうちUniFiという製品群では、ネットワーク、監視カメラ、入退室管理などの製品があります。法人向けと個人向けのちょうど中間に位置するこの製品群は、ビジネスグレードという位置付けながら廉価です。Ubiquti製品群でも上級者向けのEdgeMaxシリーズがあり、初級者〜中級者向けをターゲットとしているのがUniFiです（ネットワークの知識は必要です）。ここではネットワーク製品のうちスイッチとWi-Fiにフォーカスを当ててどのような機能・サービスがあるのか説明していきます。ペラ氏はカリフォルニア大学において日本語の学士号を保有されており、親近感を覚えます。\n\nUniFiの世界へようこそ https://help.jp.ui.com\n\n\n\nUniFi製品の特徴UniFiはネットワークの「見える化」をテーマとした製品群と言えます。複数のネットワーク機器や個々の端末を集中管理することに長けています。代表的なのは特にWi-Fiですが、クライアントの通信量や電波の届き具合、通信量、どこのアクセスポイントに接続されているか把握・管理が容易です。ネットワークスイッチも同様でネットワークトポロジーが明瞭で設定内容やトラフィック量が把握できます。インターネットに接続するルーターの役目を果たすセキュリティゲートウェイはどのようなサイトに接続しているか、どれくらいのトラフィック量なのかが非常に見やすくなっています。また、直感的に分かりやすいGUIによる管理が可能で、難しい従来のコマンドラインは必要ありません（※詳細の情報把握にSSHでコマンド確認することも可能です）\nカメラや電話などのネットワーク製品を除いた、UniFiにおけるコアネットワーク製品を管理するためにはUniFi OS ConsoleまたはUniFiネットワークアプリケーションが必要です。\nUniFi OS Console\n\nUniFi OS ConsoleはUniFi環境において各ネットワーク機器を集中管理するために必要なものです。Wi-FiのAPやネットワークスイッチはそれぞれGUIなど持ち合わせていないため、GUI管理のためのConsoleが必要となります。UniFiコンソールをさらに分類するとUniFiゲートウェイがあります。 UniFiゲートウェイはUniFi Dream Machine(UDM)やUDM Proはセキュリティゲートウェイと各ネットワーク機器を管理するConsole機能を持ちます。Dream Machineはセキュリティゲートウェイ、Wi-Fi（日本では11ac対応）、Consoleとが一体になっています。UDM Proは、Wi-Fiの機能は持ちませんが、LAN&#x2F;WANに10GbE SFP+を持ち、IDS(侵入検知システム）&#x2F;IPS(侵入防止システム）のスループットが3.5Gbpsあります（iperf3で計測しているとの記載があります）。\n残念ながら、私はUniFiゲートウェイ製品のDream MachineやUDM Proを保有していないので、ここでUniFiの魅力的な製品の1つであるセキュリティ製品の説明ができません。現時点においては、UniFiのセキュリティゲートウェイは日本の環境におけるMAP-EやDS-Liteに対応していないように見えます。UDM ProなどはIPv6 Delegationに対応しており魅力的ですが、日本においてはプロバイダを選ぶ（具体的にはフレッツなどでひかり電話を契約し&#x2F;56などの複数のIPv6プレフィックスの割り当てが必要）ことになり、かなり利用環境が限定されます。ただし、日本でもUDM Proを動作させているユーザーもいらっしゃるようで、このあたりは日本のUbiquitコミュニティが参考になります。また、UniFiの監視カメラなどを導入されたい場合は、ハードディスクをセッティングする必要がありUniFiの専用ハードウェアが必要です。この場合は、UDMシリーズや後述するCloud Key Gen2 Plusを導入する必要があります。\nなお、ゲートウェイの機能としてUDMやUDM ProはIDS&#x2F;IPS、DPI（ディープパケットインスペクション）の機能を持ち、DNSフィルタやパケットのシグネチャを検査する仕組みを持っています。現時点では暗号化されたSSL&#x2F;TSL通信を解読できません。セキュリティゲートウェイではVPNはPPTP、L2TPに加え、最近Teleport VPNに対応しています。\n\nUDM Pro https://jp.store.ui.com/collections/UniFi-network-UniFi-os-consoles/products/udm-pro \n\n\nDream Machine https://jp.store.ui.com/collections/UniFi-network-UniFi-os-consoles/products/UniFi-dream-machine \n\nCloud Key Gen2は35,000円ほどしますが、監視カメラを導入する場合は必要です。予め1TBのHDDが用意されているので特に難しいセットアップは不要でUniFiの運用を開始できます。\n\nCloud Key Gen2 Plus https://jp.store.ui.com/collections/UniFi-network-UniFi-os-consoles/products/UniFi-cloudkey-gen2-plus-1 \n\nUniFi OS Consoleを購入しなくとも、WindowsやmacOSでUniFi Network Applicationをセットアップできます。別途、Java11のインストールが必要です。もし、仮想環境のESXiをお持ちであれば（一定のネットワークの知識があることが前提です）、ESXi上にUbuntuなどを導入し、そこにUniFi Network Applicationをセットアップできます。ネットワークアプリケーションのロールバックはサポートされておらず、旧バージョンを再インストールするか、ESXiによるバックアップからロールバックすることになります。UniFi本来のメリットを享受するためには見える化が大事ですから24時間365日の稼働とトラフィック収集が重要です。もちろんカジュアルユーザーは設定変更時だけ都度PCを起動し、UniFi Network Applicationを起動し、設定変更する方法もあります。\n自分でUniFi Network Applicationをセットアップする場合は自身で用意するハードウェア以外の費用はかかりません。UniFiソフトウェアは無償ですし、サブスクリプションなどの定額支払いもありません。Linuxの場合、最低2GByteのメモリ、HDDは最低10Gバイトが必要です。私はUbuntu Desktop上に構築しており、4Gバイトのメモリ、HDDは40Gバイトにしています。UniFiのセットアップやバージョンアップにGUIは不要ですが、ハードウェアスペックに余裕のある方はGUI(Ubuntu Desktop)をお薦めします。\n\nUniFi Help Center https://help.ui.com/hc/en-us/articles/360012282453-UniFi-Network-Self-Hosting-your-UniFi-Network-Without-a-Console-Advanced-\n\nUniFiの管理画面UniFiの管理画面は新旧の2種類あります。旧画面は日本語にも対応していますが、最新機器の製品名が表示されないなどちょっと中途半端な対応状況です。デザイン的にも少し洗練された新画面はまだまだ機能が不足しているというデメリットもありますが、徐々に機能拡充されていきます。これから利用を開始するユーザーは新画面で利用されることをお勧めします。\n新画面の抜粋\n\n\n\n\n旧画面\n\n\n\nスマホアプリUniFiの管理システムはハイブリッドクラウドのような仕組みがあり、無償で利用できます。完全なオンプレミスも可能ですが、外出先から自宅内のネットワーク機器を手軽にコントロールできるのは魅力的です。\n特にスマホアプリから行うWi-Fi機器やスイッチ機器のモニタリング、設定変更が容易で秀逸です。コントローラは2要素認証に対応しており、自宅でコントローラにログインすると、スマホにPush通知が来ますのでこれに応答することによりログインが完了します。アプリからはLANの直接接続、或いはUbiquitiのクラウド経由で自宅のConsoleまたはネットワークアプリケーションと接続されますが、クラウド経由の場合でも自宅のFirewallやルーターで特定のPortで待ち受ける（Port解放する）ことなく、UniFi Console（ネットワークアプリケーション）側からUbiquitiのクラウドにアクセスし、最終的にはコントローラーからスマホへ接続する形態です。セキュリティ的にも一段レベルが上で、ダイナミックDNSなどの準備が不要であることが特徴です。\nUniFi Networkアプリ（iOS&#x2F;Android)UniFiのシングルサインオンアカウントを使ってスマホアプリにログインします。自宅内でも自宅外であってもVPNなど意識することなく簡単かつ素早くUniFi機器の管理ができます。\n\n\n\n\n新しい機器をスイッチポートに接続する際にはどのVLANに属するか設定しますが、この場合はスマホアプリからConsoleを経由し大抵のことができます。SFP＋のDDM(Digital Diagnostic Monitoring)の値も取れますし、スイッチによっては機器本体の温度も把握できます。\nこのスマホアプリではARという機能があり、UniFiスイッチの第2世代以降は以下のビデオのようにスマホで実際のスイッチ機器をかざすことによって接続された端末がVR的にマッピングされたものを見られます。UniFiスイッチを一躍有名にした機能でもあります。\n\n\n\n UI Verifyアプリ（iOS&#x2F;Android) これはConsoleやUbiquitiのサイトにログインする際の2要素認証のためのワンタイムパスワードのスマホアプリです。\n\n\nこれを導入してシングルサインオンの設定をしておくとPCなどからログインした際にはプッシュ通知がされます。\n\n\nこれで2要素認証も簡単に対応できます。\nその他管理\nSyslog&#x2F;SNMPUniFi Console、各機器それぞれが統合管理されるので、1箇所のSyslogサーバにログを書き出せます。あくまでsyslogなので、UniFiシステムの障害切り分けに使うレベルのものです。また、SNMPv3の管理機能を持ちます。\n\nSSH スイッチの詳細情報を確認できます、パスワード認証、公開鍵認証が可能です。私はYubicoのYubiKeyで公開鍵認証を使っています。\n\nバックアップ 構成情報を定期的にバックアップできます。\n\n通知 メール、アプリにイベントを通知できます。ファームウェア更新の通知（自動更新も可能）、スイッチやWi-Fiを対象にすればクライアント（インタフェース）の新規接続、切断、ローミングが通知されます。他にもリスク管理の通知機能があります。\n\n\nオンラインストアUniFi製品は日本のオンラインストアがあります。製品はワールドワイドに展開されていますが、ONUと接続する可能性のあるセキュリティゲートウェイや電波を出すWi-Fi製品は技適マークもありますし、ネットワークスイッチの電源コードはPSEマークも付与されており安心して購入できます（電源ケーブルは3PINとなっており、日本のコンセントに合うように2PIN変換アダプタが別途必要です）。\n\nUbiquit Japan Store https://jp.store.ui.com\n\n世界的にはUbiquitiの製品・パーツは非常に廉価です。日本においては今年に円安のため2回ほど価格改定があり、以前と比べると特別廉価とは感じなくなっています。\n\nMMモジュール（10Gbpsマルチモード光学モジュール）2つで6,299円\n10GSFP+ RJ45モジュール10,009円\n\n日本のサイトでは今のところ送料が無料です。UbiquitiのMMモジュールは様々な機器に繋いでいますが、特段問題が発生したことはありません。Ubiquitiのスイッチに限りませんが、SFP&#x2F;SFP+の互換性の問題が出る場合があり、純正のMMモジュールまたは信頼のあるSFPベンダーからの購入をお勧めします。\nケーブルに関してはUbiquitiの純正のOM3ケーブルは部屋と部屋とを繋ぐにしては短すぎるものばかりなので別途FSやAmazonなどで調達する必要があります。\nUbiquitiのRJ45ケーブル（Cat6)はコネクタ付近で曲げることができるユニークなパッチケーブルです。基本的にCat6Aはなく、Cat6のケーブルのみの取り扱いですが、最大8メートルのパッチケーブルであれば10GbEでも問題が出ることはありません。\n\n\nネットワークスイッチここ数ヶ月、このブログでは省電力化および低発熱を目的としてSFP＋の説明をしてきましたが、UniFiスイッチを簡単に紹介します。\nUniFiスイッチはL2の製品群が主流です。設定はGUIのみで行います。SSHでスイッチに接続し、設定変更は行えますが再起動のタイミングにおいて、GUIで設定した内容に上書きされます。見える化やスイッチ全体の一括管理のために、全てのスイッチをUniFiのものに統一したくなりますが、部分的にUniFiスイッチを導入できます。UniFiスイッチはハードウェア自体は一般的なL2スイッチとあまり違いは無いので異なるメーカーのL2スイッチをUniFiスイッチに接続し、VLANで相互に運用できます。\n個人で利用する場合、無理にVLANを切る必要もありませんが、マルチプルVLANも対応しているので、1つのネットワークアドレスで複数のVLANに属する形を取ればネットワーク分離も簡単に行えます。\n一部の製品にはL3に対応したスイッチも存在しますが、IPv6に対応していないことや、アクセスコントロール（ACL）が行えないというものであり、L3としてはまだ使えるレベルには達していません。\nUSW-Aggregation\n\nファンレスL2スイッチです。SFP＋ポートを8つ持ちます。小規模なネットワークにも向いていますが、アグリゲーションという名前が付くだけあって、本来はいくつかのスイッチを束ねる目的のスイッチでもあります。MikroTikの8Portスイッチと値段も同程度でもあり、良く比較される対象になっています。奥行きは短いですが、基本は19インチラックに合うように作られているので結構幅があります。あまりIT機器のようにも見えないデザインでもあり、リビングに単独で置いても違和感はありません。\nUSW-Pro-Aggregation\nL3スイッチです。10G SFP＋ポートを28ポート、および25G SFP28ポートを4ポート持っています。私は寝室にあるクローゼットにこのスイッチを置いており、ファンの音はしますが、クローゼットのドアを閉めれば全く気にならない程度で静音といえます。L3は前述したように本来のL3としては制約がありますが、セグメント超えのiperf3を実行しても殆どスループットは落ちません。ここはさすがL3スイッチです。\nUSW-Enterprise-8-PoE\nL3スイッチです。Enterpriseという割には小ぶりでリビングに似合いそうなスイッチです。SFP＋を2ポート、2.5GbE（1GbE、100Base）のRJ45ポートを8ポート持ちます。ファンの音は殆どわかりません。実際にフロントのLCDパネルでファンの回転数を引き上げられ、その際はさすがにファンの音はするものの、やがて自動運転ではかなりの抑えた風量に戻るようです。米国ではTVとかオーディオなど色々な専用セグメントが必要だったりするのでL3が必要なのでしょうか。これはPoEスイッチでもあり、UniFiの世界では小型スイッチやWi-FiがPoE、つまりLANケーブル1本で通信と給電とが行われます。家が小さい日本ではあまり馴染みがないテクノロジですが、アメリカのように大きい家ではLANケーブル1本で各部屋まで配線し、天井や壁にWi-Fiやスイッチを埋め込む形でLANを構築していく事が多いのでPoEが重宝されます。RJ45の8ポートが2.5GbEであると同時にPoEによる給電が可能です。かなりの発熱で筐体上部は50℃ほどあり、コンソールからは70℃以上の熱を示しています。この温度であればファンが回っても良さそうな雰囲気ですが、LCDパネル上のファン回転数は80rpmで静かです。普段の運用ではファンが回るイメージがありません。\nSwitch Flex Mini\n\n小型の1G RJ45を5ポート持つ小型スイッチです。4,794円と廉価です（最近の円安で値上がりしました）。UniFiではトランクポートとして設定する場合、複数のVLANを選択しグループ化しますが、トランクポートは全てのVLANが対象となる制約があります。一応L2対応になっています。洗練されたデザインで小型のこのスイッチは発熱が小さく安定しており気に入ってます。しかし、気に入っている割には無造作にマジックテープを裏面にべったり貼り付け、TVの後ろに貼り付けています。PoEの入力が可能なので、PoEスイッチから電源を取っています。最初から小さい電源アダプタも付属していますがケーブルの本数を減らしたい方はPoEは便利です。100Base-TXのLANを持つテレビなどは目立たないこのスイッチに集約させ、多くの長いLANケーブルから解放されるのに便利です。4,794円でUniFiの世界をテストドライブしてみるのも良いかもしれません。\nWi-Fi米国ではUniFiのWi-Fiシステムは非常に多くの製品が発売されていますが、日本で販売されている利用可能な製品はWi-Fi5、Wi-Fi6の有線接続を必須とする数製品に絞られます。日本のメーカーとは異なった魅力のあるアクセスポイント（AP）です。主流の11ax対応製品については、3製品あります。Lite、Pro、LR（ロングレンジ）になります。中継機としてExtender、メッシュ用としてU6 Meshが存在します。\n\n\n基本的に壁に固定し、LANケーブルのPoEから電源を取ります。これまでのWi-Fiルータを棚やテーブルに置くという方法ではなく、電源コンセントの制約が無いため、自由度が高く、壁などに取り付けられます。APの設置は壁にねじ止めするのが本来の姿ですが、小心者の私は100均で売っている壁にメモを留めるようなピンを打ち付けてAPを固定しています。APを取り外した後も壁紙の補修液を塗り込めば壁の穴は目立ちません。\nUniFiのWi-Fi製品は、ネットワークスイッチのPoEまたはPoEインジェクタを別途購入し接続することになります。\n\n\n壁掛けで1本のLANケーブルのみであれば部屋に馴染み、さほど気になるものでもありません。Fast Roaming(802.11r)を前提として、APの切り替えがスムーズに行えます。一般的には端末を持つ人が移動した時のローミングを目的としていますが、家族が普段通りにスマホを使っていながら接続APを切り替えられます。私の場合、自宅の1階にU6-Proを、2階にU6-Liteを設置していますが、どちらのAPからも家じゅう電波は届きます。APの故障対策のためというよりは、私が色々なことをやってAPやスイッチの設定を変更したりリブートしたりするので、自宅内で家族向けに安定的なWi-Fiサービスの提供のためにはとても便利な機能です。AP毎の周波数を設定し、お互いが競合しないようにするなど、より細かい設定ができます。\nハードウェアスペックとしては一般的ですが、端末がどのAPに接続されているか、それぞれの端末の電波状況などがわかります。また時間でSSID単位に停波させることも可能で、私は夜間は11gの最小限の送信出力に絞り11axは止めています。スマホは夜間に勝手に11gに切り替わり最低限の通信は可能になっています。\n日本のWiーFiルーターも多機能で、当たり前のようにあるWPSプッシュボタンによるクライアント登録（認証）や子供の端末を管理するなどの機能はUniFiは持っていません。下手に長いWi-Fiパスワードにしてしまうと、UniFiではIoTに対するパスワード入力が困難です。UniFiと国内のWi-Fiルーターとは目指す方向が違う事になり、基本性能という意味では殆ど変わらないものとお考えください。\nホームゲートウェイやスイッチなどが揃っている環境でUniFiのWi-Fi製品のみを導入できます。\nまとめここではUniFiの製品群を説明しました。製品としては荒削りなところもあり、それなりに不具合や未対応の箇所を抱えながら少しづつ機能強化しているというプロダクトの特徴があります。特に見える化という観点で、ネットワーク環境を変える予定のある方は検討の候補になるかもしれません。私が保有しているスイッチを簡単に紹介しましたがSFP+に偏っており、他にも魅力的なスイッチがありますので、是非Ubiquitオンラインストアにアクセスされてみることをお勧めします。\nこのブログでは仮想環境のESXi上にUbuntuをセットアップし、UniFi Network Applicationを運用する方法を紹介しています。\n\n「Ubuntu22.04LTSをESXiにセットアップする」\n「UniFi Network Applicationのセットアップ」\n「UniFi Network Applicationの運用」\n「UniFiスイッチ」\n「UniFi Wi-Fiシステム」\n\nリソース以下の日本語ヘルプ、コミュニティがUniFiの構築には大いに参考になります。\n\nUbiquiti コミュニティ（日本） https://www.facebook.com/groups/uijapan\n\n\nUI 日本語ヘルプ記事 https://help.jp.ui.com/categories/6583256751383/\n\n\nUbiquiti Community（米国中心） https://community.ui.com/\n\n","categories":["Hardware","Network"],"tags":["SFP+","10GbE","UniFi","Wi-Fi"]},{"title":"Ubuntu22.04LTSをESXiにセットアップする","url":"/new-technology/2022/09/23/ubuntu22-04lts/","content":"\n\nこの記事で実現すること\n\nこの記事では24時間稼働させるサーバーとして、intel&#x2F;AMDのESXi上にUbuntuをセットアップするケースを想定しています。従来のSSHで接続するコマンドラインベースだけではなく、WindowsやmaOSからGUIで接続するUbuntu環境になります。長期サポートの最新バージョンであるUbuntu22.04LTSを仮想環境であるESXi7.0上に導入します。リモートデスクトップに相当するクライアントソフトウェアはESXiに付属するVMware Remote Console(VMRC)を使います。Ubuntu22.04LTSのEOLは2027年4月であり、十分に長い期間のサポートがあります。\n\n\nESXiにおけるUbuntuのセットアップのポイントサーバーとして動作させるUbuntuをESXiおよびVMRCで仮想マシンを操作する事のメリットはトラブルに強いという事でしょうか。直接ハードウェアにインストールする（いわゆるベアメタル）方式ですと、IPアドレス周りの設定変更で失敗するとSSHで繋がらなくなり、ディスプレイに本体を繋いでリカバリするなど面倒です。VMRCはESXi本体に接続し操作するため、仮想マシン上のネットワークがダウンしていても操作可能です。特に複数VLANに跨いだ環境を構築したり、ファイアウォール(ufw)を設定する場合はトラブルになりやすいため、復旧しやすい構成を目指します。\nRequirements:\nUbuntu Desktop Edition2 GHz dual core processor4 GiB RAM (system memory)25 GB (8.6 GB for minimal) of hard-drive space (or USB stick, memory card or external drive but see LiveCD for an alternative approach)VGA capable of 1024x768 screen resolutionEither a CD&#x2F;DVD drive or a USB port for the installer mediaInternet access is helpful\n\nUbuntu documentation https://help.ubuntu.com/community/Installation/SystemRequirements\n\n実際には、動かすアプリケーションを想定し、CPU、メモリ、ストレージを増やしておくことになるでしょう。ここでは、一例として、2vCPU、4GBメモリ、64GBストレージで進めます。\nまた、Ubuntuのパッチ管理のために、Ubuntu Oneアカウントの申請および、ライセンス（個人利用は無償）の取得が必要となります（後述します）。\n環境面の前提としては、仮想マシンからDHCPでIPアドレスおよびDNSが取得でき、インターネットに接続可能な環境とします。\nUbuntu22.04LTSのダウンロード最初にUbuntu22.04LTSのダウンロードを行います。日本語Remix版を利用します。\n\nUbuntu 22.04 LTS 日本語Remix https://www.ubuntulinux.jp/News/ubuntu2204-ja-remix ファイル名は「ubuntu-ja-22.04-desktop-amd64.iso」です。\n\nESXiで仮想マシンを作成するESXiへのisoファイルのアップロードESXiのWebUIにログインします。ESXiの左ペインメニューのストレージからデータストアブラウザを開き、そこにダウンロードしたUbuntuのisoファイル（ubuntu-ja-22.04-desktop-amd64.iso)をアップロードします。\nネットワークポートグループの作成（任意）Ubuntuのネットワークで使うESXiのポートグループを用意します。新しく作成する場合は、左ペインメニューのネットワークからポートグループの追加を選択し、該当するvSwitch上に新しいポートグループを作成します。\n仮想マシンの作成左ペインメニューの仮想マシンから、仮想マシンの作成/登録をクリックし、新規仮想マシンの作成を選択します。ここでは仮想マシンの名前と仮想マシンのバージョンによる互換性とゲストOSの種類を指定します。互換性は特に理由がなければ一番新しいものを選んでください。ゲストOSファミリは”Linux”を、ゲストOSのバージョンは”Ubuntu Linxu(64ビット）”を選択します。\n\n\n続いて仮想マシンを作成するストレージを選択します。\n\n\n\n設定のカスタマイズでは、仮想ハードウェアと仮想マシンオプションがあります。仮想ハードウェアのタブでは、CPU、メモリ、ディスク、ネットワークアダプタ（上記で作成したポートグループ）を指定し、CD/DVDドライブの場所でUbuntuのisoファイルを選択します。ネットワークアダプタが10GbEの場合は、ネットワークアダプタ1のプルダウンをクリックして\"VMXNET3\"が選択されていることを確認してください。\n\n\n仮想マシンオプションの画面に移動し、VMWare Toolsのプルダウンを開き、Toolsのアップグレードのパワーオン前に毎回VMware Toolsをチェックしてアップグレードのチェックボックスをオンにします。また、起動オプションではファームウェアに\"EFI\"を選択し、この仮想マシンに対してUEFIセキュア ブートを有効にするかどうかを指定しますのチェックボックスをオンにします。セキュアブートは必須ではありませんが、セキュリティ向上のためにお勧めします。\n\n\n\n完了させたら、左ペインメニューの仮想マシンから、対象の仮想マシンを起動します。もし、クライアント端末（Windows,macOS）にVMRCをダウンロードしていなければダウンロードし、クライアント上でセットアップしておきます。\n\n\n仮想マシンをパワーオンし、リモートコンソールを起動します。VMRCのセットアップが完了していれば以下のようなウィンドウがブラウザから独立して起動します。\n\n\n\nUbuntuをインストールを選択します。\n\nUbuntuのセットアップ最初は、キーボードレイアウトを選択します。下記の例ではJapanese(Macintosh)が選択されていますが、日本語キーボードのmacOSや一般的なWindowsの日本語キーボードは一番上の”Japanese”が一般的です。キーボード入力をここで試してくださいで実際のキー入力が確認できるのでここで試してから選択しましょう。インストール後にいつでも変更できます。\n\n\nここでは最小インストールを選択します。なお、ESXiの場合、サードパーティのドライバはここでは選択する必要はありません。最初の仮想マシン作成時に、VMware Toolsをインストールするように指示しましたから、”open-vm-tools”が自動的にインストールされます。\n\n\nここではディスクを削除してUbuntuをインストールを選択し”インストール”ボタンをクリックします。仮想マシン作成時に設定した64GBのディスクを初期化します。\n\n\n住んでいる場所を指定します。\n\n\nホスト名、ユーザー名を設定します。ここで設定するホスト名・ユーザー名を使ってSSHで接続します。\n\n\n\nインストールは完了です。再起動後、下記の画面が表示されるので、一旦Enterを押下します。\n\n\n最初の起動画面です。ウェルカム画面というのでしょうか。初期案内のウィンドウが表示されます。\n\nここでは、Ubuntuシングルサインオンを行います。一旦、Ubuntuはこのままにして、クライアントのブラウザからUbuntuのOneアカウントサイトにアクセスします。\n\nOne account for everything on Ubuntu https://login.ubuntu.com\n\nここでは、以下のようにアカウントを作成します。メールアドレス、フルネーム、ユーザー名、パスワードを入力します。このユーザー名はUbuntuへのログインユーザーと同じである必要はありません。\n\n\n“Create account”ボタンをクリックし、アカウントを作成すると、登録したメールにコンファーメーションが行きますのでそこで確認のリンクをクリックしUbuntu Oneアカウントの登録は完了します。\n\n\n続いて、再びUbuntuの画面に戻り、今作成したUbuntu Oneアカウントをここで入力します。\n\n\nアカウントの照合がうまくいくと、キーリングの登録になります。これは第2パスワードというべき位置付けでもあり、Ubuntuにログインしていても重要な操作の前にはこのキーリングを求められます。Ubuntuをサーバーとして使うのであればGUIでログインする場合は設定変更が主な作業でしょうから、それなりの頻度で求められることになるためパスワード管理ソフトありきの長い覚えられないパスワードにすると実際の運用で大変になってしまうので注意してください。\n\n\nさて、続いてUbuntuにパッチを適用する際のライセンスが必要です。Ubuntu22からはLivePatchに制限が付きます。個人アカウントは3台のUbuntuまでLivePatchが適用できます。このLivePatchが有効になっていると、可能な限りリブートなく最新パッチが自動的に更新される素晴らしい仕組みとなっています。UbuntuのFirefoxを起動し、Ubuntu Advantageにアクセスします。\n\nUbuntu Advantage https://ubuntu.com/advantage\n\nUbuntu Oneアカウントでログインします。\n\n\nFree for personal useの\"Register\"をクリックします。\n\n\n\nこれで、パーソナルトークンが作成されました。Tokenに記載のある文字列をマウスで選択し、右クリックからコピーを選びます。\nウェルカム画面でUbuntu Oneのシングルサインオン完了後に次の画面に進むと、LivePatchのセットアップに進みます。別の方法として、”ソフトウェアの更新”アプリケーションから設定をクリックし、LivePatchのタブを選択することでも可能です。\n\n\n\n\nLivePatchは再起動することなく。..の表示とトグルスイッチがありますので、これをオンにします。\n\n\nUbuntu Advantageのトークンを貼り付けします。Ubuntu Advantageの更新は少しタイムラグがあるようで、Tokenの作成直後は登録がうまく行かない場合があるので、その場合は数時間待ってください。\n\n\n\nOpen SSH ServerのインストールUbuntuにSSHするために必ず必要なモジュールです。GUIでコマンドを扱うには端末というアプリケーションを起動します。 そこからopensshをインストールします。\n$ sudo apt update$ sudo apt install openssh-serverパッケージリストを読み込んでいます... 完了依存関係ツリーを作成しています... 完了状態情報を読み取っています... 完了以下の追加パッケージがインストールされます:  ncurses-term openssh-sftp-server ssh-import-id提案パッケージ:  molly-guard monkeysphere ssh-askpass以下のパッケージが新たにインストールされます:  ncurses-term openssh-server openssh-sftp-server ssh-import-idアップグレード: 0 個、新規インストール: 4 個、削除: 0 個、保留: 0 個。751 kB のアーカイブを取得する必要があります。この操作後に追加で 6,046 kB のディスク容量が消費されます。続行しますか? [Y/n] Y\n\nUbuntuで端末アプリケーションを起動する場合、キーボードショートカットによる起動が便利です。セットアップ時のキーボードの選択によって内容は変わりますが、Widnowsは”Ctrl”+”Alt”+”T”で起動します。macOSでは”option”+”control”+”T”で起動します。\n任意設定VMRCとクライアントとのCopy -Paseteを連携するWindowsやmacOSでブラウザで検索した結果をUbuntu上で貼り付けたい場合があります。この場合は仮想マシンをシャットダウンし、仮想マシンのオプションから以下のパラメータを設定します。\nisolation.tools.copy.disable          FALSEisolation.tools.paste.disable         FALSEisolation.tools.setGUIOptions.enable  TRUE\n\n\n\n\nCopy &amp; Pasetを有効にする https://kb.vmware.com/s/article/57122\n\nフォルダのパスを英語に変更する$ LANG=C xdg-user-dirs-gtk-update\n\n\n\nDon't ask me this againをチェックし、\"Update Names\"をクリックします。\n\nVMRCの便利な起動方法ESXiで該当する仮想マシンを開き、URLを確認すると、URLの末尾に仮想マシンNoとも言える2桁の番号が振られています。\n\n\nこの数字を使って以下のURLをブラウザのお気に入りに登録しておくことによって、ESXiの画面にログインしてから仮想マシンにアクセスすることなく、直接VMRCを起動し仮想マシンにアクセスできます。\nvmrc://[ユーザー名]@[ESXiのホスト名]/?moid=[仮想マシンNo]例：vmrc://root@192.168.1.1/?moid=20\nセットアップ完了ESXiにおけるUbuntu22.04LTSのセットアップは完了です。最後に、仮想マシンのバックアップを取得されることをお勧めします。Linuxには個人ユーザー向けの有力なウィルス対策ソフトが存在しないため、色々なサイトをブラウジングするには多少抵抗がありますが、限られたパッケージシステムのみをインストールし、自宅内のサーバーとして利用するにはESXiとの組み合わせは最適です。バックアップやスナップショットを活用し、トラブル時には迅速にロールバックできる環境はとても便利です。\n\nVMware ESXiの仮想マシンをバックアップする\n無償版ESXiの高度なバックアップ\n\n","categories":["Software"],"tags":["ESXi","Ubuntu"]},{"title":"UniFi Network Application 8.3.32","url":"/new-technology/2024/07/21/una8-3-32/","content":"\n\nこの記事で実現すること\n\n米国Ubiquiti（ユビキティ）社のUniFi製品のコントローラーとして利用するUniFi Network Application（以下、UNA）の8.3.32(Official)が提供されています。特にゲートウェイにおけるNAT機能において機能強化が図られています。この記事は本バージョンで強化されたNATのセキュリティ対応を纏めています。\n\n\nUNA8.3以下の機能が追加されています。\n\n柔軟なNAT設定 マスカレード、ソース、およびデスティネーションNATでトラフィックを制御します。さらに、すべてまたは特定のネットワークでNATを無効にできます。\n検査モニタリングの一元化 侵入防止、トラフィックおよびファイアウォールルール、広告ブロッキングなどのセキュリティサービスの詳細なアクティビティログを1つのインターフェースで表示します。\nより詳細なスイッチ分離設定 ACLルールを使用して、同じネットワーク内または異なるネットワーク間の特定のトラフィックをブロックします。\n\nUNA8.3.32でダブルNATを回避できるようになりました。これはホームユーザーにとっても期待されていた機能です。\nNATの種類一般的にNATというと、自宅で利用するIPv4プライベートIPアドレスをグローバルIPアドレスに変換してインターネットに接続する技術ですが、これは厳密にはソースNAT（Source NAT、SNAT）またはIPマスカレードと呼ばれます。単に送信元のIPアドレスをプライベートからパブリックに変換するだけならSNATですが、IPアドレスとTCP Portの組み合わせでセッションを管理（紐付け）されているのがIPマスカレードです。これに対して、宛先を変換する宛先NAT（Destination NAT、DNAT）という機能があります。DNATは宛先のIPアドレスを別のIPアドレスに強制的に変更するものです。\n負荷分散装置で複数あるサーバーに一定ルールで振り分けたり、パブリックIPアドレスを持つサーバーにプライベートネットワークから接続するよう強制的に向き先を変更することなど、DNATは様々な場所で活用されています。\n今回はセキュリティの観点からホームユーザーにも使い道のあるDNATを紹介します。\nクライアントに強制的にUniFi GatewayのDNSを参照させるこの記事の実例は、IoTなど、DHCPでDNSを指定してもそれを無視してクラウドDNS（GoogleDNSなどの8.8.8.8）を参照する機器や行儀の悪いアプリケーションへの対策になります。企業や個人向けのルータでは一般的にHTTPSやDNSが許可されていることを前提に攻撃者はDDos攻撃のシナリオを作成します。また、IoTの許可のない情報収集などは、クラウドのファイルサービスに対して行われるケースもありますが、セキュアなDNSやFirewallで阻止される可能性もあるため、クラウドDNS（Port53）を使って遮断を回避する手口はよく使われます。クラウドDNS（Port53）へのアクセスをFirewallでRejectできますが、IoTのサービスそのものが機能しなくなるのは困ります。そこでクラウドDNSにアクセスしているように騙し、リクエストを横取りするのがこれから説明するDNATによる宛先IPアドレスの変換です。\nつまり、セキュリティを守るために行われる正当かつ原始的な中間者攻撃（Man-in-the-middle Attack）となります。\n\n\nなお、今回はDNSについて書いていますが、UNAのネットワーク-&gt;「コンテンツフィルタリング」やセキュリティ-&gt;広告ブロックを有効にすると自動的にUniFi Gateway自身のDNS参照が強制されます。ですので、IoT向けにこの2つの機能を外してUCG-Ultraで検証します。\nDNATの設定ここではUniFi GatewayのLANを192.168.1.1として設定しています。\n\n\nインタフェースをDefault、Internetに出ていく宛先、つまり0.0.0.0&#x2F;0の宛先、Port53&#x2F;TCP,UDPを対象に変換されたIPアドレスとしてGatewayのIPアドレスを指定することで宛先IPアドレスが変換されます。なお、IPv6のNAT機能はまだ実装されていないようなので、DefaultセグメントのIPv6は無効にしておきます。\n検証\nWindowsPCをIoT機器と見立て、LANに接続の上、WindowsのDNSの設定を8.8.8.8に変更します\nUniFiのDNS設定で、仮のホスト”test.home”のエントリを作成します\n\n \n\nnslookup test.homeを実行します\n\n実行結果\nC:\\Users\\yoshi&gt;nslookup test.homeサーバー:  dns.googleAddress:  8.8.8.8名前:    test.homeAddress:  192.168.100.200\n\nこのようにクライアントはGoogle DNSを参照しているつもりでいますが、DNSからの回答としてプライベートIPアドレスを返します。このDNAT設定をオフにすると以下のようになります。\nC:\\Users\\yoshi&gt;nslookup test.homeサーバー:  dns.googleAddress:  8.8.8.8*** dns.google が test.home を見つけられません: Non-existent domain\n\nこのようにDNSを強制的にUniFi Gatewayに向けることができます。\n応用編UniFi GatewayのDNSを利用せず、独自にLAN内にセキュアなDNSや内部向けDNSを構築されている環境ではどうでしょうか？別のLANセグメントにDNSがある場合はDNATが有効に機能しますが、UniFi GatewayのLANと同じセグメントにDNSがある場合、少し工夫が必要です。\n\n\nIoTからリクエストされたDNSクエリは最初にUniFi Gatewayを経由し、DNATされ、DNSにリクエストされます。但し、返りのパケットは、DNSからの応答が直接IoTに返って来ることになり、（IoTがリクエストしていない機器からの）パケットを受信できません。\nこの対策として、IPマスカレードを追加することになります。\n\n\nこのようにDNSへのリクエストはクライアントからではなく、UniFi GatewayであるようにIPマスカレードすることによって、DNSはクエリの結果をUniFi Gatewayに返し、GatewayはクライアントにDNSクエリの結果を返します。これでエラーが発生せず、クライアントのInternet向けDNSクエリは横取りする事が可能となります。\n設定例です。ここでは、UniFi Gatewayを192.168.2.2、内部DNSを192.168.2.100とします。\n最初にDNATを構成します。\n\n\nここでは、DNATの宛先として、DNSサーバーのIPアドレスを指定します。\n続いてマスカレードの設定です。\n\n\nここで、送信先のIPグループで新しいリンクをクリックし、新しいIPアドレス、つまりDNSサーバーのIPアドレスを登録します。さらに、ポートグループで新しいリンクをクリックし、DNSのPort53を登録します。\n２つの登録を行った結果、DNAT→Masqueradeの順序に並びます。\n\n\nこれでクライアントからInternetに向けたDNSリクエストは全てLAN内のDNSに強制的に参照されることになります。行儀の悪いIoTやアプリケーションからは「卑怯だぞ」という声が聞こえてきそうです&#x1f601;。\nご参考Ubiquiti JapanからのUNA8.3の記事では、NAT機能の概要のみが記載されていましたので具体例を記載してみました。なお、まだ発売されていませんが、Cloud Gateway Maxにも言及されていますね。今度は全て2.5Gbpsポートを持つゲートウェイということに加え、監視カメラ（Protect）に対応することにもなり（動画保存用にNVMe SSDというのが素敵です）、個人向けとして楽しみなプロダクトになりそうです。\n\nUI Japan UniFi Networkの進化: Site Manager | Network Application8.3 | クラウドゲートウェイマックス https://note.com/ui_japan/n/n503fc31a3442\n\n","categories":["Network"],"tags":["UniFi"]},{"title":"UniFi Wi-Fiシステム","url":"/new-technology/2022/12/31/unifi-ap/","content":"\nこの記事で実現すること\n\nこの記事ではホームユーザー向けにUniFi AP(Wi-Fiアクセスポイント）の設定ができるようになることを目的としています。\n\n\n最近のWi-Fi事情2022年9月にWi-Fiで6GHzも利用できるよう法律が変更されました（Wi-Fi6E）。国内のメーカーはこの6GHzとメッシュを謳い文句にWi-Fiルータの販売強化を図っているようです。しかしながら、端末側は今年に発売するiPhoneで6Eの対応が見送られた事であまり盛り上がってはいないようです。\nWi-Fiの難しいところはその住居の形や家の周りの電波状態に大きく左右されてしまう点で、これがベストという構成を見出せません。私の例で言えば、凡庸な建売の木造2階建であり、無線APが1つだけでも、それなりに無難にWi-Fiが使えるという環境です。\n最近販売され始めた無線ルーターは、メッシュ対応のものが多く出てきました。メッシュは複数台のAPと無線でデータをやり取りできる機能です。無線の中継機は常に親機に集約されていましたが、メッシュは複数台のAPと相互に接続します。一般的には中継専用のSSIDを用いお互いにデータを中継します。\n最近のメッシュWi-Fiルーターでは高速ローミング（802.11k、802.11r、802.11v）に対応している製品も出てきており、端末を持ちながら移動した場合に、アクセスポイント（AP）間を高速ローミングすることで切断時間を短くし、近くのAPに接続できます。また、それぞれのAPがメッシュ（無線）ではなく、有線接続して互いの情報を交換できる**イーサネットバックホール（有線バックホール）**という機能に対応している製品を複数の部屋に設置することでずいぶん快適になるでしょう。\nなお、6EはDFSの影響を受けないチャンネルなので、自宅の間取りで6GHzが効率よく使える環境下であれば利便性は増します。私は6GHzの無線APは保有していないので、どのくらい電波が届くものなのかは今後機会があれば評価してみたいと考えています。周波数が上がるにつれて障害物によって遠くに届きづらくなるとは考えられます。各部屋に有線がなく、イーサネットバックホールが使えないケースでは、AP同士を6Eの独立チャンネルで接続する事で中継機能が改善することが期待されます（これまでは親機と中継機が同一のチャンネルを使うことで効率が大幅に落ちるケースがありました）。\nまた、端末側の6E対応状況が進捗するまではしばらくはWi-Fi6（5GHz）のままというのが現状でしょうか。\nUniFi APのスペック日本国内で販売されているUniFi APはルーター機能を持たず、アクセスポイントに特化したハードウェアです。UniFiネットワークアプリケーションまたはUniFiコンソールを介して情報連携が行われます。\n\n\n\n機種\nU6 Pro\nU6 Lite\n\n\n\n有線\nGbE RJ45ポート x1\nGbE RJ45ポート x1\n\n\n給電方法\nPoE\nPoE\n\n\n最大消費電力\n13W\n13.5W\n\n\n最大送信パワー2.4GHz\n22dBm\n23dBm\n\n\n最大送信パワー5GHz\n23dBm※\n23dBm\n\n\nMIMO 2.4GHz\n2x2\n2x2\n\n\nMIMO 5GHz\n4x4\n2x2\n\n\n※U6 Proのスペック上は26dBmが上限ですが、日本国内で利用する場合は上限が23dBmとなります。\nWi-FiのスペックとしてはU6 Proで日本国内のやや高性能モデルに相当するでしょうか。アンテナ数を見ても、国内のWi-Fi機器と比較して特段優れている項目はありません。U6 Liteも一般的なスペックです。\n上記以外にも、11axに対応した中継機である、U6 Extender、メッシュ接続を前提とした、U6 Meshアクセスポイントなどが販売されています。商品の詳細は日本のオンラインストアを参照してください。\n\nUbiquiti オンラインストア https://jp.store.ui.com/collections/unifi-network-wireless\n\nUniFi APの実速度iPhone11を使ってAPに1mの距離まで近づけて、iperf3を実行した時の結果は以下の通りです。\n\nU6 Pro\n \n\nU6 Lite\n \n参考までに、Aterm WX6000HPの場合は以下です。\n\n\nU6 Proの個性として、iperf3の起動直後は少しスロースタートに見えます。省電力の最適化に重きを置いているのでしょうか。\nまた、私の自宅の1階において、macOSのWi-Fi Explorerで電波の強さを計測してみました。1階にはU6 ProとAterm、2階にはU6 Liteが配置されています。\n\n\n電波の強さだけであればAtermのWX6000HPが素晴らしい結果を出しています。しかしiperf3の最高速度という観点についてはU6 Proの方が良いスコアです。\npingのレイテンシも見てみましょう。iPhoneからNASへのping応答速度です。iOSやmacOSはpingのレイテンシ数値が高く出てしまう傾向にあります。実は上記のiperf3を含めてL3スイッチ経由でルーティングしてNASのiperf3サーバーに接続しており、1ホップあります。\n\nAterm pingレイテンシ\n\n \n\n\nU6 Pro pingレイテンシ\n\n \n\n\nPingPlotterによる計測 https://www.pingman.com\n\nU6 Proの方が電波の出力は低いものの、レイテンシは15msあたりで上限が整っています。一方、Atermは時々、20msを超えるスパイクが発生しています。U6 Proの速度が出る理由はレイテンシが低い事と想定されます。スマホやノートPCの一般的な操作では100Mbpsを超えたあたりから殆どその差については分からなくなってきますが、リモートワークのビデオ会議の安定性を考えるとレイテンシは意識したいところです。\nUniFi APはWi-Fi設定が非常に詳細まで行えることがメリットであり、電波が届かないなどの対策としての購入用途には向いていません。\nUniFi APの設置具体的にAPのセットアップの前に一度日本語ガイドのページをご覧になることをお勧めします。これは最近拡充されてきたリソースですが、本来は私がブログで書きたかった、メーカーに依存しない無線LANに必要な知見が整理されており、とても貴重な内容となっています。\n\nUniFi Network - ワイヤレスクライアントの接続性を最適化する https://help.jp.ui.com/articles/221029967/\n\n\nUniFi Network - ワイヤレスネットワーク速度の最適化 https://help.jp.ui.com/articles/360012947634/\n\n\nUniFi Network - 最適なワイヤレスメッシュネットワークにするための検討事項 https://help.jp.ui.com/articles/115002262328/\n\n私もどこかで自分なりの考えをまとめて記事にしたいとは考えています。\nさて、APの設置についてです。\n電源を取るのはPoEアダプタまたはPoEスイッチからというのが独特です。これによってLANケーブルのみでデータ送受信と送電が行え、美観を損ねる事なく、壁の上部にAPを配置し、障害物を避けた効率の良い電波の発信が行えます。Wi-Fiはハードウェアスペックも関係ありますが、こういった物理的な配置も重要です。有線バックホールを使わずにPoEの電力だけを使い、メッシュにすることもできます。この場合、UniFi APは有線接続されている他のUniFi APにメッシュで接続してくれます。\n有線バックホールの一例です。\n（U6 Liteを2階に設置）\n\n\nコアスイッチから2階のこの部屋までは光で通し、SFP+スイッチ（usw-Aggregation)から1GbEでAPに接続しています。このスイッチにはPoE機能はないため、別途PoEアダプタを使ってAPに給電しています。\n\nPoEアダプタを電源に繋ぎ、LANをusw-AggregationにRJ45で接続し、POEをU6 LiteにRJ45で接続します。\n（私の環境の場合）電波の弱い階段のエリアにまで電波を届かせるために出来るだけ障害物を避けるAPの配置の工夫をしました。階を移動した時にスムーズなローミングができ、ビデオ会議で相手の声がなるべく途切れない事を目的としています。\n\n\n2階の各部屋に電波を届けつつ、立体的に見て、壁と2階の床を抜ける箇所を想定し、試行錯誤しながら配置を決めていきます。\nUniFi Wi-Fi設定ここでは、UniFiコンソールやUniFiネットワークアプリケーションが既にセットアップされている事を前提に説明します。UniFiネットワークアプリケーションを最初からセットアップされる方は以下の記事を参照してください。\n\n「Ubiquiti UniFiの世界」\n「Ubuntu22.04LTSをESXiにセットアップする」\n「UniFi Network Applicationのセットアップ」\n「UniFi Network Applicationの運用」\n\nネットワークアプリケーションのSETTINGSからWiFiの画面を開くと以下の表示となります。\n\n\n画面上部のWiFiについては、既存のSSID一覧が表示されます。画面下部のGlobal AP Settingsでは、複数台のAPに共通設定を指定します。\nメインとなる5GHzの無線設定では、DFSのこともあり、一般的には80MHzを指定します。日本の製品ではアンテナ数で上り2、下り2として2x2という表現がされている事が多いでしょうか。スマホなど多くは80MHzになります。高性能なWiFiクライアントをお持ちの場合は160MHzも設定可能です（U6 Liteは80MHzが上限です）。\nTransmit Powerは環境に応じて、Auto、High、Medium、Low、Custom（固定数値指定）と設定できます。\n\n有線バックホール無しでAPを設置する場合は、Wireless ConnectivityのWireless MeshingのチェックボックスをOnにします。私は普段は有線バックホールで運用していますが、U6 Proでは有線LANへ接続せずにメッシュ接続が行えました。\n続いて、SSIDの設定です。\n\n\nSSIDの名前、パスワード、ネットワーク、そのSSIDにどのAPを参加させるかを決めます。ここでは個人向けのWi-Fiとして一般的なWPA2パーソナルまたはWPA3パーソナルを前提としています。\n続いて、マニュアル設定でSSIDの詳細を設定していきます。\n\n\n\n\n\n\n\n項目名\n説明\n\n\n\nWiFi Band\n2.4GHz&#x2F;5GHzを選択します。両方を有効にもできます。\n\n\nWiFi Type\n通常はStandardです。カフェのように外部にWiFiを解放する場合はGuest Hotspotを選択します。\n\n\nBand Steering\nバンドステアリング。Bandで2.4GHz、5GHzを指定した場合に設定でき、電波状態によって自動で切り替わります。\n\n\nBandwidth Profile\n帯域制限を指定します。\n\n\nMulticast Management\n通常必要ありませんので説明は割愛します。\n\n\nClient Device Isolation\nクライアントをお互いに接続できないようにします。Guest扱い。\n\n\nProxy ARP\n混雑している環境ではWiFiデバイスの代わりにAPが代理応答します。\n\n\nBSS Transition\nAP同士でクライアントの状況を共有します。デフォルト有効。\n\n\nUAPSD\n省電力に関するパラメータです。古いデバイスでは問題が出る場合があります。\n\n\nFast Roaming\nFast Roamingに対応している端末であれば有効にすべきです。逆に言えば、Fast Roamingに対応した端末専用のSSIDにすべきです。\n\n\n802.11 DTIM Period\nデフォルト有効。Autoを推奨。説明は割愛します。\n\n\nMinimum Data Rate Control\nデフォルト有効。最低通信量を定め、それを下回る場合クライアントにAP切り替えを促すはずですが、私の環境ではあまり有効に機能しません。\n\n\nSecurity Protocol\nWPA2、WPA3の指定をします。WPA Enterpriseを指定することでRADIUS認証（ユーザー認証）が可能です。子供が友達にWi-Fiパスワード共有することに対策したいというこだわりのある方などチャレンジされてはいかがでしょうか。SynologyのNASなどでRADIUSサーバを稼働させられます\n\n\nPMF\n保護された管理フレーム。WPA3では必須。WPA2では任意にすることも可能。必須にすると古い端末は繋がらない可能性があリます。\n\n\nGroup Rekey Interval\n暗号化キーの交換を定期的に行います。デフォルトは3600秒（＝1時間）です。\n\n\nHide WiFi Name\n使うメリットはありません。説明は割愛します。\n\n\nMAC Address Filter\nMACアドレスのホワイトリスト、ブラックリストを指定します。\n\n\nRADIUS MAC Authentication\n説明は割愛します。\n\n\nWiFi Schedulerは夜間など使わない時の時間を設定できます。私は夜間は弱い2.4GHzのみ利用し、日中使っている5GHzは止めています。\nAP単位の設定UniFiのDevice画面のSettingsから、AP本体の設定を変更します。主にはIPアドレス、無線のチャンネルを指定します。\n\n\n５GHzについては、APを2つ設置するならば、メインはDFSを受けないチャンネル、サブは別のチャンネルにするとお互い競合せずに安定した電波の受信ができます。2.4GHzはChannel幅は20MHzとし、1、6、11という具合に５づつスライドさせてAP毎に電波が重ならないように設定します。AP毎に電波の出力も変更できますし、きめ細かい設定が行えるのもUniFi APの特徴です。\nVLAN\n\nこのAP自体が属するマネジメント用のVLANを指定します。Wi-Fi設定ではSSID毎にVLANを設定できるので、APに接続するスイッチは、マネジメントVLANを含む全てのVLAN IDを含めるようにトランクポートとして設定する必要があります。\nVLANを使った設定の一例です。\nデバイスの管理をデフォルトVLAN（かつネイティブVLAN）、一般端末をVLAN100、会社用・ゲストをVLAN500とした、よくある一般的なシナリオです。\n\n\nUniFIでは複数VLANのペアを作って、そのうちの１つをネイティブVLANとして指定します。この例ではマネジメントVLANをDefault（VLAN ID＝1）、かつ、ネイティブVLAN（タグ無し）としています。会社のPCやゲスト用端末はClient Device IsolationをEnableにして互いの機器の通信を拒否します。スイッチ間のトランクポートは必ず通信するVLAN IDのタグを含めてあげる必要があります。\nAPのファームウェアUniFi APの最新のOfficialのファームウェアは、ローミングの切り替わりが安定しないように見えますが、現在リリース候補となっている、6.5.40は遅延の少ないローミングが成功しているように見えます。また、Wi-Fi6Eに対応したU6 Enterpriseもいよいよ発売されるようです。\n通知機能通知はUniFiコンソールまたはUniFiネットワークアプリケーションの機能ですが、APに関して通知機能は以下の通りです。\n\n\nDFSを受信した時にアラートが受けられるのと、自宅付近に同じSSIDを持つAPを発見した場合通知してくれます。特に後者はセキュリティ上有用です。これは試験的にUniFi以外のAPを同じSSIDで起動して検知させています。\n\n\n通知はメールとスマホアプリと2種類あり、選択できます。Hotspot Client Connection Changeは、端末の接続&#x2F;切断を検知したり、ローミングの切り替わり状況を通知してくれます。家族の自宅への出入りも把握できます。ただし、通知数が多くなるので、メール通知は避け、アプリ通知にした方が良さそうです。本来の趣旨は知らないMACアドレスからの接続があった時に検知するものです。\nこれらの機能はハイブリッドクラウド機能を持つUniFi製品の特徴ですが、これらが無償で利用できるというのは本当にありがたい存在です。\nリソース以下の日本語ヘルプ、コミュニティがUniFiの構築には大いに参考になります。\n\nUbiquiti コミュニティ（日本） https://www.facebook.com/groups/uijapan\n\n\nUI 日本語ヘルプ記事 https://help.jp.ui.com/categories/6583256751383/\n\n\nUbiquiti Community（米国中心） https://community.ui.com/\n\n","categories":["Hardware","Network"],"tags":["UniFi"]},{"title":"UniFi Express","url":"/new-technology/2024/03/06/unifi-express/","content":"\nこの記事で実現すること\n\nこの記事ではUniFiネットワークの導入未経験の方を対象に、UniFiの新しい小型ゲートウェイUniFi Expressの具体的なセットアップおよび性能確認、機能紹介を目的としています。検証のため製品提供を受けていますのでこの記事はPR要素を含みます。\n\n\n経緯普段からUbiquiti製品を使っている私は、いつもUbiquitiの皆さまには製品サポートなどで大変お世話になっています。一方、FacebookのUbiquiti日本公式コミュニティではユーザーの質問などに微力ながらサポートするように心がけています。いつものようにUbiquitiのご担当者さまから製品設定についてアドバイス頂いていた折、新製品「UniFi Express」の検証はいかがですか？と打診があり、快く引き受けさせていただきました。普段はアクセスポイント（AP）、スイッチは使っていますが、他社製セキュリティゲートウェイがお気に入りでなかなかUniFiのゲートウェイを使う機会がありませんでした。\nUniFiは簡単な操作で分かりやすさを目的としている一方で、パワーユーザーの高度な要求に応えていることもあり、一旦ネットワークの世界の深みに入るといきなり難易度が増す事になります。\nExpressは従来の機能豊富なUniFiゲートウェイから負荷が掛かるIPSなどの処理を省き、できるだけシンプルな形でUniFiのゲートウェイをUniFi初心者にも簡単に使えるようにしたゲートウェイです。\n3月となり、新生活が始まる時期でもあります。引っ越しされて新しい住環境にネットワークを敷設される場合は、小型の置き場所に困らないExpressは使い勝手が良いと思われます。\nUniFi Express製品の説明ページは以下になります。\n\n\n\nUniFi Express https://www.ui.com/us/ja/cloud-gateways/wifi-integrated/express\n\nこの記事でのインターネットの構成私はauひかりホーム（10ギガ）を導入しており、貸与されたホームゲートウェイ（HGW）があります。その後ろにExpressを配置する形式となります。\n\n\nセットアップExpressはスマホだけでセットアップ可能です。むしろPCのブラウザを使うよりスマホアプリで行う方が便利です。UniFiの製品は説明書というものがありません。いや、あるにはあるのですが、セットアップ方法＝アプリを使う事となっています。\n\n\nセットアップに関する説明書は注意書きを除けばこれが全て（That’s all!）です。\n製品と付属品です。本体、電源ケーブル、30cmのLANケーブルが付属します。\n\n\n唯一の説明書通りに電源ケーブル、LANポートは2つあります（LAN、WAN）ので、WAN側（地球儀のマークがある方）に接続します。\n\n\n私の環境ではこの壁に接続したLANの接続口の先にHGWがあります。\nさて、説明書のQRコードをiPhoneのカメラで読み込み、アプリをダウンロードしましょう。\n\n\n※上記の写真のiPhoneはWi-Fiに接続されていますがこれは既存環境のWi-Fiに接続されているものです。\n\n\n私の場合、既にUbiquitiのアカウントを保有しアプリにログインできていることや既存のUniFiコンソールに接続されている状態ですが、スマホがBluetooth経由でExpressを見つけると画面にセットアップ開始を促します。\n\n既存環境があるので選択制となっていますが、「新しいシステムを設定」を選びます。Expressが最初の1台の場合、この画面は出てこないと思われます。\nまた、今回の例では既に既存アカウントでアプリにログインしている状態ですが、全く新規の場合は、Ubiquitiのアカウントを新規作成します。\n\n\n今回、唯一セットアップしたと思える場所がここだけです。SSIDは既に”UniFi”となっており（変更可能）、ここでWi-Fiパスワードを指定します。\n\nここからは眺めているだけです。\n\n\n\n\nここで「Wi-Fiネットワークに参加」ボタンをタップします。UniFiアプリはSSID「UniFi」と設定したパスワードをiOSの設定アプリに送り込み自動的にWi-Fi接続が完了します。\nこれだけでもうiPhoneはインターネットにアクセスできるようになっています。顧客体験を重要視するUbiquitiらしい仕掛けです。\nさて、アプリの表記では、HGWのDHCPによって割り当てられた192.168.0.2というExpressのWAN側IPアドレス、および、LAN側のIPアドレス192.168.1.1が振られています。\n\n\nWi-Fiを見てみましょう、ExpressはWi-Fiチャンネルを含めて自動という言葉を多く見かけます。5GHzはデフォルトでは40MHzとなっていますが、80MHzに変更できるのでここで変更しておきましょう（最大160MHzにできます）。これ以外の自動は2つあって、Wi-Fiチャンネルおよび出力が自動となっています。日本のWi-Fiの電波出力の上限はざっくり説明すると200mW（23dBm）であり、その上限を超えないような設定となっています。クライアントの接続状況によって適切に電波の出力が調整され省エネにも有効です。\n\n\n設定からコンソールを見てみましょう。\n\n右下の歯車アイコンをタップ→コンソールをタップします。\nExpressはUniFi OSというOSで動作しており、その中のNetworkApplication（UNA）というアプリが動作しています。基本的にはOSをアップデートすることで内包されているUNAも自動的にアップデートされます。\n\n\n最新のUniFiOSにアップデートします。このExpressは、UniFi OSはv3.2.5(Official)となりました。UNAはv8.0.28です。\n今回は初回操作なので手動でアップデートすることにしましたが、毎日夜中3時に自動でアップデートチェックが行われ、自動でアップデートされます。また、Release Channelについては、”Official”(通常）、”Release Candidate”（リリース候補）、あとはUIアカウントのページから”Early Access”(ベータ版）を有効にすれば、3つのバージョンを選択できます。\n\nUI Account https://account.ui.com/profile\n\n慣れるまではOfficialにしておくのがお勧めです。Early Accessは事前確認する利用条件にある通り、守秘義務が存在します。許可なくその内容を第三者に開示してはいけません。安定しない場合も多く、広くユーザーに互換性を確認してもらうためのものです。\nさて、ここまでで初期セットアップは完了です。\n速度チェック気になるSpeedtestです。まずはiPhoneでWi-Fiのテストです。\n\n\nMTUも何も調整することなく、全くノーマルな状態での実行ですが、十分過ぎる速度です。本体の発熱も少なく、ほんのり暖かい程度です。5GHzで160MHzの帯域を使うのであれば、以下の速度が出ます。\n\n\n有線とWi-Fiとは一般的に速度差があるので、ネットワーク機器はフローコントロールを有効にするのが普通で、遅いWi-Fiに合わせて有線側を”待たせる”仕組みが必要ですが、ここまで有線とWi-Fiとの速度差が無いとフローコントロールを有効にする必要がありません。実際問題、フローコントロール無しでパケットのドロップが少ないのであればそれが一番効率よく通信でき、速度が出ます。上記のSpeedtestはフローコントロール無しでの結果です。\nZero wait DFSという機能があり、DFSを回避できる機能もあるようですが、私の環境でタイミング良くレーダーが発生するわけでもなく、この検証は行えませんでした。\n続いてLANケーブルでPCに繋いでみます。MinisforumのUM790Proは最近人気のミニPCですが、Expressはそれより1回り小さいです。\n\n\n1Gbpsの帯域をしっかりと使えています。小型ながら性能は大したものです。\nセットアップの補足私の環境（auひかり）ではとても簡単にセットアップが完了しました。なお、Expressは現在、Officialリリースにおいてインターネットマルチフィード社が提供するtransix IPv4接続 (DS-Lite) への対応はされていますが、その他のIPv4 over IPv6の対応は現時点でサポート外となっています。\n日本国内の大半がIPv4 over IPv6というわけでもなく、CATVやマンションが提供するLANなども鑑みると、シンプルにExpressを活用できる場所はたくさんあります。\nExpressに関するガイドを以下に記載します。\n\nネットワークが不安定、Lineなどでやり取りができなくなる。 以下のガイドにMSS Clampingの設定で解決するという投稿がありますので確認ください。 Facebook Ubiquiti日本公式コミュニティ\n\n https://www.facebook.com/groups/uijapan/learning_content/?filter=167949146143924&amp;post=3507234616157550 この設定についてはExpressにブラウザでログインし、WANのMSS Clampingの値をCustomの1414等に設定する必要があります。具体的な設定はISPにより異なります。\n\nIPv6 IPoE transix IPv4 (DS-Lite)の設定手順｜Ubiquiti UniFi\n\n https://note.com/ui_japan/n/n3154ff641db5\nインターネットマルチフィードのDS-Liteは以下のISPが対象となります。\n\n株式会社インターネットイニシアティブ IIJ IPv6 FiberAccess&#x2F;Fサービス タイプIPoE\n株式会社インターネットイニシアティブ IIJmioひかり\n株式会社インターネットイニシアティブ IIJmio FiberAccess&#x2F;NF\n株式会社インターリンク ZOOT NATIVE\nエキサイト株式会社 excite MEC光\nエキサイト株式会社 BB.excite光Fit\nエキサイト株式会社 BB.exciteコネクトIPoE接続プラン\nスターティア株式会社 マネージドゲート2\nメディアウェイブシステムズ株式会社 Hybrid64 (ハイブリッド・ろくよん）\nメディアウェイブシステムズ株式会社 メディアひかり\n\n（引用： https://www.mfeed.ad.jp/transix/customers/）\nPPPoEやIPv4 over IPv6など、既存インフラの課題を頑張って解決する接続方式よりも、普通にIPv4、IPv6それぞれデュアルスタックで接続できるISPを選択するのが一番シンプルだと個人的には思います。PPPoEで、MTUからTCPヘッダおよびIPヘッダを除いたMSS1460バイトを1414バイトに詰め直すというのは、CPU負荷を高める原因となります。また、IPv4 over IPv6の接続では、IPアドレスとポートを他のユーザーと共有するため、固定IPアドレスが使用できず、割り当てられたポートしか開放できません。\nauひかりのIPv6HGWの設定さて、いくらExpressが簡単と言っても、Ubiquiti製品を選びたいというユーザーはやはりIPv6は使いたいと思われているでしょう。グローバルの一般的なIPv6の割り当て方法がUniFiにはあります。auひかりのユーザーはとても簡単にIPv6に接続できます。ここは少しだけ設定が必要です。なお、ここでのHGWの設定はあくまで戸建向けの光回線での実例です。\nauひかりのHGWにブラウザでログインしDHCPv6サーバ設定をタップします。\n\n\n続いて、IPv6アドレスの割り当て方法を選択します。\n\n\nExpress向けにはいくつかの組み合わせが可能ですが、設定が3つあるうち設定2または3を選びます。設定2ではIPv6アドレス＋DNSをDHCPv6で、PrefixをRAおよびDHCPv6で配布する方法です。DNS情報はDHCPv6で渡すのでRAオプションのDNSアドレス通知は使いません。設定3はPrefixをDHCPv6で配布します。デフォルトゲートウェイはRAの送信元から導きます。ここでは詳細の説明は割愛します。\n最後に画面上部にある保存ボタンをタップして設定を保存してから、HGWはログアウトします。\nExpress WANの設定スマホアプリの右下の鍵マークアイコンの設定からインターネット→Primary(WAN1)→高度な設定→手動→IPv6接続先のトグルを有効に、DHCPv6を選択し、プレフィックス委任サイズを64にします。\n\n\n\n\nあれ？と思った方、そうなんです。auひかりの委任は64ビット（サブネット1つだけ）なんです（ひかり電話を契約していても）。実はExpress以前に自分の使っている他社製ゲートウェイで確認したところ、&#x2F;64しか委任で貰えないようなんです。その製品のサポート担当者からは64ビットのような特殊な委任はサポート外と一刀両断されました。そりゃそうですよね。委任するというくらいなんだから最低でも60ビット（&#x2F;64を15個）など複数のサブネットがあるのが普通です。auひかりには「複数のIPv6サブネットの委任をできるようにお願いします」とは昨年秋に伝えましたが。。。\nいずれにしても今回はExpressの世界、本格的な複数サブネット（VLAN）はまた今度にするとして、まずはシンプルなネットワークを作ることに専念しましょう。\nちなみに、HGWのLAN側IPv6アドレスは以下が割り当てられていました。\n\n\n240f:xxxx:xxxx:1::/64ではない別のPrefix1つが割り当てられることになります。\nExpress LANの設定ExpressのLANのIPv6設定はブラウザ経由でなくてはなりません。EXpressにブラウザでログインします。https://unifi/ またはhttps://192.168.1.1\n\n\nログイン後、画面右上の歯車アイコンをタップし、LANの設定に入ります。スマホのキャプチャでは視認性が悪いので、ここではPC画面で項目の説明をします。\n\n\nIPv6のタブを選択し、Prefix Delegationを選びます。基本的には上記の画面キャプチャの通り、WAN1インタフェースを選択します。\nClient Address Assignmentは趣味の範疇ですが、Expressが決定するアドレスにするならDHCPv6を、クライアントに任せるならSLAACを選びます。最近はSLAACでもMACアドレスベースに生成するのではなく、一時アドレスとしてクライアント側がIPアドレスを都度生成するので、IPアドレスを追跡できなくなりセキュリティ上は良いと言われています。但し、自身の管理としてログからは端末を判別しづらくなります。\n\nこれで設定はOKです。\n接続テストIPv6確認テストサイトで確認しましょう。\n\n\n問題なくIPv6で到達できているようです。HGWのPrefixは240f:xxx:xxx:1::/64でしたが、今回のPrefixは240f:xxx:xxx:2::/64となっており、パブリックIPv6アドレスがExpressに委任され、Expressからクライアントに配布されています。\n\ntest-ipv6 https://test-ipv6.com\n\nこれで一通りのセットアップは完了しました。UniFiスマホアプリは外出時に公衆回線からUbiquitiのクラウド経由でExpressに接続可能です。HGWのポート開放は必要ありません。後述するTeleportの技術を使っていてUbiquitiクラウドが接続管理、認証、通知などの役割を担ってくれます。これは無償のハイブリッドクラウド環境ですが、これこそがUbiqiutiが好まれる理由の1つです。\nExpressの機能&#x2F;設定必要な機能をPickupして見ていきます（多機能でとても全ては紹介しきれません）。トラフィック識別や、広告ブロックのフィルタリング状況はネットワークの見える化としてUbiquiti製品の特徴です。説明不要でグラフィカルで分かりやすいでしょうから、ここでは説明を割愛します。\n管理画面ログイン後、左上のOSセッティングからConsole Settingsに進みます。\n\n\n詳細の確認やトラブル対応の対策にSSHは事前に有効にしておきましょう。UNAにもSSHの設定がありますが、そちらはExpressが管理する配下のデバイスが対象であり今回は設定しません。\nサポートとのやり取りで「サポートファイルが必要」となれば、画面最下部のDownload Support Fileから詳細ログをダウンロードし、UI Japanに送ることになります。\nプッシュ通知任意設定ですが、アプリの歯車アイコンからプッシュ通知を有効にしておくといくつかの通知を受けられます。\n\n\n障害などの重要なものはデフォルトで含まれています。それ以外にも、VPNの接続があったら通知する、レーダーを受信すると通知するなどいくつかの追加選択が可能です。\n広告ブロックUNAの設定（歯車アイコン）から、セキュリティを選択します。ここでは広告ブロックにチェックしておきます。広告ブロックはExpressにおいては、1つのネットワークのみ選択可能です。IPv6を有効にしていても広告は綺麗に消えますのでかなり有効です。DNSシールドはDNSによる名前解決時にDoH（DNS over HTTPS）を使い、GoogleまたはCloudflareで名前解決するものです。TLS&#x2F;SSLで暗号化されているので、プロバイダや途中の経路において、どこにアクセスしているのか判らないようにする目的があります。日本のISPはDDoS対策のために独自のDNSフィルタを実施していることや、その情報を売却するなどの行為が厳しいために日本においてはDNSシールドの重要性はあまり無いものと考えられます。なお、このDNSフィルタを使っていても、広告ブロックは有効です。Expressは広告ドメインを対象にDNSで排除します。\n通常は、以下のクエリを返します。\n$ nslookup www.googleadservices.comServer:\t\t240f:xxxx:xxxx:2::1Address:\t240f:xxxx:xxxx:2::1#53Non-authoritative answer:Name:\twww.googleadservices.comAddress: 172.217.xxx.xxx\n\nDNSフィルタを有効にすると。。。\n$ nslookup www.googleadservices.com.Server:\t\t240f:xxxx:xxxx:2::1Address:\t240f:xxxx:xxxx:2::1#53Name:\twww.googleadservices.comAddress: 0.0.0.0\n\n0.0.0.0を返すのでアクセスできなくなります。控えめな広告であれば私は許容できるのですが、日本特有というか酷い内容の広告は徹底して除外したいものです。今のところExpressは綺麗に広告をカットしてくれています。\nTeleport(VPN)まず、UniFiアプリでTeleportを有効にします。招待のリンクを生成します。\n\n\nUniFiアプリの設定（歯車アイコン）からWiFimanをインストールし、起動すると右下にTeleportというアイコンがあります。それをタップします。\n\n\n上記画面が表示されたらOnをタップし接続開始するだけです。接続開始するまで10秒強掛かりますが、ポート開放無しにここまで自動でやってくれます。Teleport経由のSpeedtestは40Mbps弱で速いとは言えませんが、とてもお手軽です。\nLocal DNSさて、上記で自宅にVPNで接続できるようになりました。自宅に接続するというのは、そもそもNASやサーバーがある事が前提です。自宅内はローカルのDNS、hosts、NetBIOSでの名前解決を、外からはパブリックのIPをダイナミックDNSで管理し運用されていらっしゃる方も多いでしょう。例えば私はSynologyのDDNSを取り敢えず利用する事にはしていますが、実際に公衆回線からパブリックIPを通して接続はしていません。単純にローカルDNSで、xxxx.synology.meというSynologyから与えられたホスト名＋ドメイン名（FQDN）で自宅ではアクセスしています（Synologyのスマホアプリもその名前（FQDN）を使います）。これはTLS&#x2F;SSL証明書とも関係ありますし、あまり自由な名前にできません。アプリのプッシュ通知による2要素認証もありますし、証明書のエラーになっていては自宅に接続できても使い物になりません。UniFiには、Local DNS機能が存在しており、固定IPと名前とをセットで登録できます。\n\n\n上記の右の赤枠のように、FQDNとプライベートの固定IPアドレスを設定しておきます。NASがDHCPでExpressにIPを要求すると、この固定IPアドレスとローカルDNSへの登録が自動で行われます。\n\n\n自宅、外出時のFQDNを統一できることで2要素認証のプッシュ通知、パスワードマネージャーからのID&#x2F;パスワード入力も極めてスムーズです。Express1台でここまで便利に使えるようになります。\n\n\nUI Japan Store Expresshttps://jp.store.ui.com/collections/unifi-network-unifi-os-consoles/products/ux\n\n価格は26,900円です。\n補足説明私のHGWはBL3000HMという機種です。\n\nauひかり BL3000HM\n\n\nUbiquiti Japan ホームページ https://note.com/ui_japan\n\n\nUbiquiti ヘルプセンター https://help.jp.ui.com/categories/6583256751383/\n\n\nUbiquiti コミュニティ（日本） https://www.facebook.com/groups/uijapan\n\n\nUbiquiti Community（米国中心） https://community.ui.com/\n\n（製品提供：Ubiquiti Japan株式会社）\n","categories":["Hardware","Network"],"tags":["UniFi"]},{"title":"UniFi Network Applicationのセットアップ","url":"/new-technology/2022/09/23/unifi-network-application/","content":"\n\nこの記事で実現すること\n\n米国Ubiquiti（ユビキティ）社のUniFi製品であるネットワークスイッチ、Wi-Fiアクセスポイントを利用するには、管理コンソールとしてUniFi OS ConsoleまたはUniFi Network Applicationが必要となります。UniFi Network ApplicationはUbiquitiより無償提供されており、管理・運用においてはUniFiクラウドサービスと連携します。一般的にはこのようなサービスはサブスクリプション費用が必要ですが、この費用も掛かりません。UniFi製品はネットワークの見える化に特化しているため、管理コンソールの24時間稼働が理想です。最初からハード組み込みのセキュリティ機器（UniFi Security Gateway等）やUniFi Cloud Keyを購入すればすぐにUniFi製品を使い始めることができますが、これらのハードウェアを購入しなくとも、ネットワークやLinuxの知識がある人はUniFi Network Applicationをセットアップし、使い始めることができます。\n\n\nUniFi Network Applicationのセットアップの前提「Ubiquiti UniFiの世界」ではUniFiの機能全般を説明しました。UniFi Network Applicationをセットアップする以前に製品の情報やアップデートの情報は全てUbiquitiの提供するCommunityから入手します。英語のコミュニティサイトではSOHOなどのユーザーはUDM Proなどのセキュリティゲートウェイに、スイッチ、APを組み合わせているケースが多く見られます。スイッチユーザーは、もう少し大きな規模のユーザーがネットワークアプリケーションをLinuxで構築しているユーザーが多いように見えます。実際に顧客にサービスを提供しているSIerやエンジニアの参加もあります。コミュニティの情報・不具合などの割合から見ると、ネットワークアプリケーションの機能とスイッチの情報が圧倒的に多いように見え、セキュリティゲートウェイの質問やセキュリティそのものに関する技術的な内容は少ないように見えます。\n手っ取り早くUniFi機器を稼働させるには、Windows、macOSのUniFi Network Applicationをセットアップし、動作させることです。\n基本的には24時間稼働させ、スイッチ&#x2F;APからリアルタイムで情報を収集したり、スイッチ&#x2F;APに必要な動作を指示するのがConsole&#x2F;Network Applicationの役目です。Linux上（Debian&#x2F;Ubuntu）にセットアップされるケースが多いようです。わざわざLinuxのセットアップをするのは手間だと思えますが、運用を継続することを考えると、Linuxへのセットアップがお勧めです。また、バックアップや設定変更で動作しなくなった時のロールバックを考えると仮想環境（ESXi）にセットアップされることをお勧めします。Ubuntuの最新バージョンであるUbuntu22.04LTSはサポート期間が2027年までと十分長い期間があります。UniFiのためのUbuntuのセットアップ記事は「Ubuntu22.04LTSをESXiにセットアップする」を参照してください。\nローカル環境のみのアクセス（オンプレミス）、リモート（スマホアプリ）から管理可能なハイブリッドクラウド方式がありますが、ここではハイブリッドクラウド方式で進めます。クラウドはUbiquitが提供する無償のサービスです（※有償のUbiquitiクラウド管理の方式もあります）。基本的には機器のCPU、メモリ使用量、温度管理に加え、スマホへの通知やリモートによる機器のリスタート、アップグレード、高い利便性があります。\nUniFiはAppleのiPhoneのように説明書が無くても使えることを目標にしているのでしょうか。難しいスイッチなどのコマンドラインを必要としませんが、マニュアルというものがありません。文末に示すコミュニティなどの情報を参考にしてください。徐々に日本語向けガイドも整備されてきています。\nこの記事ではUbuntuに具体的にネットワークアプリケーションをセットアップする方法を記載していますが、最初に日本語のガイドを参照されることをお勧めします。より詳細の手順としてこの記事を参考にされることをお勧めします。Ubiquitiの公式ではUniFiコンソールを購入してセットアップする事が推奨されています。\n\nUI Japan サポートセンター UniFiの導入 https://help.jp.ui.com/articles/360012192813/\n\n\nUniFi Network - コンソールなしでUniFi Networkをセルフホスティングする（高度） https://help.jp.ui.com/articles/360012282453/\n\nこの記事では、公式で記載されている方法ではなく、有志が作成したスクリプトを用いてセットアップします。\nUniFi NetworkのリモートアクセスRequirementとして以下のドキュメントがあります。\n\nUniFi Network - リモートアクセスの要件 https://help.jp.ui.com/articles/115012240067/\n\n説明は至ってシンプルです。UIシングルサインオンアカウント、インターネットに接続されているネットワークアプリケーションホストが必要とあります。よくあるトラブルとしては、Port解放の問題、DNS、NTPへの接続が必要という項目があります。また、コミュニティのリリースポストを参照してほしいとあります。\nUniFiの環境は慣れるまでは理解するのが大変ですが、その世界観を理解できれば1つ1つは難しくありません。\nUIシングルサインオンアカウントの作成早速、Ubiquitiのシングルサインオンアカウントを作成しましょう。アカウントの作成は無償です。\nhttps://account.ui.com/register\nユーザー名、メールアドレス、パスワードが必要です。ユーザー名は他のユーザーと重複しない名前が必要です。一度決定するとこのユーザー名でローカル環境もログインする事になります。\n\n\n登録が完了すると以下の画面になります。\n\n\n登録したメールアドレスに”Email Verification”が行きますのでVerifyしてください。\nUniFi Consoleの要件\n2 GHz dual core processor(2vCPU)\n4 GiB RAM (system memory)\n64 GB Disk\n\nUniFi Network Applicationに対してはユーザーからのWebサービス、スイッチからネットワークアプリケーションへの接続などがあり、いくつかのサーバーPortをオープンしておく必要があります。Ubuntuと言われるとWindows上のWSL2を思い浮かべますが、WindowsOS上にPort Forwardの設定を行う必要があり、通常のUbuntuより余計な手間が掛かるためWSL2はお勧めしません。\nUniFi Network ApplicationではMongoDB&#x2F;Java11を使います。これらのミドルウェアの利用はアプリケーション内部の組み込み型モジュールとして考えるべきでもあり、セキュリティの観点からは可能な限りUbuntu上の公開ポートを制限すべきです。従い、UbuntuはUniFiネットワークアプリケーション専用として利用し、必要なPort以外は閉じます。\n実際のインストールは有志が作成した素晴らしいシェルスクリプトが公開されており、悩むことなくセットアップは完了します。\nUniFi Network Applicationのバージョンアップはインストール同様にシェルスクリプトを動作させます。また、UniFi Network Applicationはロールバックに対応していないため、何か問題があった場合に旧環境に戻すにはアンインストール、インストールをするかESXiのレベルでスナップショットからの戻し、または仮想マシンごとのバックアップからの戻しをします。ESXiによるOSのロールバックは非常に手軽なため、万が一の際はOSレベルでのレストアが早く確実です。\n\nOracle Java https://www.oracle.com/jp/java/technologies/java-se-support-roadmap.html\n\n\nMongoDB https://www.mongodb.com/support-policy/lifecycles\n\nUbuntuの事前準備ここでは「Ubuntu22.04LTSをESXiにセットアップする」で記載したようにUbuntuがESXi上にセットアップされ、ESXiのUbuntuにVMware Remote Consoleで接続して操作する事を前提としています。ESXiのWebUIにログインし、Ubuntuの仮想マシンに対してVMRCで接続するか、ブラウザから、vmrc://ユーザー名@esxiのホスト名/?moid=[仮想マシンのID]で接続します（VMRCウィンドウが起動します）。クライアントへのVMRCのインストールはESXiのWebUIからダウンロードできます。\nUbuntuの固定IPアドレスの設定UniFiの機器から、或いはWeb Consoleとして常に同一のIPアドレスに接続するために固定IPアドレス、またはDHCPの配布でmacアドレスを元に常に同じIPアドレスを配布するように設定します。Ubuntu上で固定IPにするには、設定画面のネットワークで固定IPを設定します。\n\n\nUniFi Network Applicationでは現時点でIPv4のみを利用しIPv6は未対応と考えてください。個々のスイッチ&#x2F;APはもちろんIPv6通信に対応していますが、機器本体の管理をIPv4で行います。\nufwの設定UniFi Consoleで最低限のPortを開けるため、UbuntuのFirewallであるufwを設定します。Ubuntuの端末を起動します。\n$ sudo ufw status状態: 非アクティブ$\n\nufwを有効にします。\n$ sudo ufw enableファイアウォールはアクティブかつシステムの起動時に有効化されます。\n\n再度状態確認します。\n$ sudo ufw status状態: アクティブ$\n\nESXiやVMRCを使わずSSHで接続しufwを有効にする場合は、SSHポート（22&#x2F;TCP)を許可しておかないと新しいSSHの接続ができません。再起動などのタイミングでSSHできず面倒になるのでご注意ください。なお、UniFi Network Applicationのセットアップ途中でSSHポートを開けます。\n\n\nufwを有効化しただけでは外部へ接続する方向へは制限しませんが、UbuntuのFirefoxでInternetに接続可能な状態である事を確認します。セキュリティ機器やFirewall機器でOutbound通信に厳密な管理をされている方は以下の記事を参考に必要なPortを開けてください。UniFi Network ApplicationのセットアップにはInternetへの接続が必要です。Internetから内部にポート解放する必要はありません。\n\nUniFi - Setting Up a UniFi OS Console https://help.ui.com/hc/en-us/articles/4416276882327-UniFi-Setting-Up-a-UniFi-OS-Console\n\nUniFi Network Applicationのインストールスクリプトの情報は、Ubiquiti本国のコミュニティにあります。https://community.ui.com/questions/UniFi-Installation-Scripts-or-UniFi-Easy-Update-Script-or-UniFi-Lets-Encrypt-or-UniFi-Easy-Encrypt-/ccbc7530-dd61-40a7-82ec-22b17f027776\nセットアップで失敗した際にすぐに戻れるように、このタイミングでESXiのスナップショット、またはバックアップの取得をお勧めします。\n実行は3ステップです。Ubuntuの端末から、以下のコマンドを実行します。\n\n管理者になります\n\n$ sudo -i\n\n\n証明書などのダウンロードをします。\n\n$ apt-get update; apt-get install ca-certificates wget -y\n\n\nネットワークアプリケーションのセットアップを行います。\n\n$ rm unifi-latest.sh &amp;&gt; /dev/null; wget https://get.glennr.nl/unifi/install/install_latest/unifi-latest.sh &amp;&amp; bash unifi-latest.sh\n必要なモジュールをインストールし、最新のUniFi Network Applicationをインストールしていきます。何回かユーザーとコマンド上の対話があります。全て”Y”を回答します。\n# Do you want to keep the script on your system after completion? (Y/n)\n“Y”を入力しEnterを押下します。\n# Do you want to proceed with updating your system? (Y/n)\n“Y”を入力しEnterを押下します。その後いくつかのモジュールがセットアップされていきます。\n# Preparing for MongoDB installation...# Adding key for MongoDB 3.6...# Successfully added key for MongoDB 3.6!# Running apt-get update...# Successfully ran apt-get update!# Installing mongodb-org version 3.6...# Preparing OpenJDK 8 installation...# Installing openjdk-8-jre-headless...# Installing your UniFi Network Application ( 7.2.94 )...# Downloading the UniFi Network Application...# Successfully downloaded application version 7.2.94!# Installing the UniFi Network Application...# Would you like to update the UniFi Network Application via APT?# Do you want the script to add the source list file? (Y/n)\n\n“Y”を入力しEnterを押下します。\n# Is/will your application only be used locally ( regarding device discovery )? (Y/n)\nあなたのアプリケーションはディスカバリにおいてローカル環境だけで使いますか？という質問ですが、これはスクリプトの中身を見る限りは、”Y”を選択しないと、ufwの10001&#x2F;udpを開けないので、”Y”を選択します。10001&#x2F;UDPを開けないとローカル環境のUniFi機器を見つけられません。AWSなどのクラウド上にネットワークアプリケーションをセットアップする場合、ローカルのUniFi機器を直接UniFi Network Applicationに向かわせる方法もあり、その場合はクラウド上のローカルネットワークに不要なポートを公開しないための設定と考えられます。\n# Do you want to add the required ports for your UniFi Network Application? (Y/n)\n“Y”を入力しEnterを押下します。\n# Successfully added port 3478/udp to UFW.# Successfully added port 8080/tcp to UFW.# Successfully added port 8443/tcp to UFW.# Successfully added port 8880/tcp to UFW.# Successfully added port 8843/tcp to UFW.# Successfully added port 6789/tcp to UFW.# Successfully added port 10001/udp to UFW.# Your SSH port ( 22 ) doesn&#x27;t seem to be in your UFW list..# Do you want to add your SSH port to the UFW list? (Y/n)\nUniFiに必要なポートを開け、さらにSSHも開けますか？と聞かれるので”Y”を入力しEnterを押下します。\n最後に以下の表示でスクリプトは終了します。\n# UniFi Network Application 7.2.94 has been installed successfully# Your application address: https://192.168.xxx.222:8443# UniFi is active ( running )# Author   |  Glenn R.# Email    |  glennrietveld8@hotmail.nl# Website  |  https://GlennR.nl\n\nとても素晴らしいシェルスクリプトです。Glenn R氏に深謝です。最後の”Your application address:”にあるように、クライアントのブラウザからhttps://UbuntuのIPアドレス:8443に接続します。\nUniFi ネットワークアプリケーションのセットアップここからはしばらくUbuntuは操作しません。WindowsやmacOS、スマホなどのクライアントからhttps://UbuntuのIPアドレス:8443に接続します。独自証明書のため、ブラウザのエラーが表示されますが、「危険を理解して進む」などをクリックして画面を開きます。UniFi Network ApplicationのSSL対応は別の機会に記事を書きます。\n以下では規約に同意するチェックを入れ、”Next”で進みます。\n\n\nここでは、Switch to Advanced Setupをクリックします。\n\n\nAdvanced remote and local accessでは、以下のようにリモートアクセスとUIシングルサインオンアカウントのトグルスイッチをOnにした状態で\"Next\"で進みます。\n\nUIシングルサインオンアカウントでログインします。\n\n\nここではバックアップを有効にします。\n\n\nデバイスセットアップです。ここで新しいUniFiのハードウェアがネットワークアプリケーションのサブネット内で接続状態であれば、自動的に検出します。ただし、ネットワークアプリケーションで最初にネットワークアドレスを設定する必要があり、ここではデバイスのセットアップをせずに、”Next”で進みます。\n\n\nWiFiセットアップです。UniFiのAPがある場合はここでWiFiセットアップが可能ですが、スキップし”Next”で進みます。\n\n\n確認画面です。所在地である日本を選択し、”Finish”で完了します。\n\n\nここまで完了すると初期画面が表示されます。\n\n\nUniFi ネットワークアプリケーションの初期設定最初にUniFiネットワークアプリケーションのネットワークアドレスと動作モードを設定します。ネットワークアプリケーションの左下の歯車アイコンをクリックし、Networksを選択します。\n\n\n最初のネットワークアドレスは”192.168.1.0&#x2F;24”となっていますのでこれを修正します。\n\n\nAuto Scale Networkのチェックを外し、実際のルーターのLAN側IPアドレスを入力します。\n\n\n続いてAdvanced Configurationでは、今回のようにセキュリティゲートウェイなどのUniFi Consoleがありませんが、デフォルトではセキュリティゲートウェイがDHCPを提供するDHCPサーバーモードとなっています。\n\n\nここでは、DHCPモードを”無し”にし、”Apply Changes”で変更を完了させます。\n\n\n左側の丸い二重丸のアイコン（UniFiAPのシンボルです）からは、新しいUniFi機器のAdoptが可能な状態になっています。\n\n\nUbuntuを再起動後してみてください。再度ブラウザでUniFi管理画面にログインできること、UbuntuにSSH可能である事を確認しましょう。7.4.156からは日本語UIが使えるようになりました。\nこれでUniFiネットワークアプリケーションの設定は一旦完了です。もちろんこの段階で検出したスイッチを採用（Adopt）できますが、管理の主体はスマホアプリで可能なため、スマホアプリをインストールしていきましょう。\nUniFi ネットワーク スマホアプリUniFiの使い勝手の良さはスマホアプリにあります。スマホアプリからUniFiネットワークアプリケーションを制御します。普段はスマホアプリがあれば大抵は事足ります。アプリストアから”UniFi Network&#x2F;Ubiquiti Inc”を見つけスマホにアプリをインストールします。\n\nApple iOS\n\n \n https://apps.apple.com/jp/app/unifi-network/id1057750338\n\nAndroid\n\n \n https://play.google.com/store/apps/details?id=com.ubnt.easyunifi&amp;hl=en_US&amp;gl=US\nここではiPhoneで操作します。”Set up a New Device”をタップします\n\n\nネットワークを検索しに行きます\n\n\nUniFi OS Consoleは存在していないので見つけられません。”Set up a connection by IP address”でUniFi Network ApplicationのIPアドレスを指定します。\n\n\nUniFi Network ApplicationのIPアドレス、UIシングルサインオンアカウントのIDとパスワードを指定します。\n\n\nしばらく経ってから、UniFi Network Applicationを見つけるので、”Proceed”をタップします。\n\n\n無事ログインが完了し、早速Adopt可能なデバイスが表示されます。Adoptしてみます。”Set Up”をタップします。\n\n\n“Next”をタップします。\n\n\nデバイスを採用中です。しばらく待ちます。少し時間が掛かります。ここではデバイスの採用と最新ファームウェアのダウンロード、適用が行われます。\n\n\nデバイスの採用が完了すると、以下の画面になります。”Go to Dashboard”をタップします。\n\n\nTop画面です\n\n\nUniFiデバイスの画面をタップすると、採用されたスイッチが見えます。\n\n\nスイッチのPortの状況です。GbEでアップリンク（上流のネットワーク）に接続されています。\n\n\nアプリの歯車アイコン（System）から”Network Application Configuration”を選択します。以下のHostname&#x2F;IPとなっている場所にネットワークアプリケーションのIPアドレスを設定しておきます。\n\n\nUniFiネットワーク経由のログインUniFiスマホアプリを終了し、Wi-Fiをオフにしてから再びアプリを起動します。今度は”Log in to Your UI Account”をタップし、UIシングルサインオンアカウントでログインします。\n\n\n接続に少し時間が掛かりますが、Ubiquitiのクラウド経由でローカルのUniFiネットワークアプリケーションに接続され、スイッチや接続されたクライアントの状態が把握可能となります。厳密にはUbiquitiクラウドからスマホのパブリックIPアドレスを取得し、UniFi Network Applicationからスマホアプリへの直接接続を行うようです。\n2要素認証ハイブリッドクラウドで外部からログインができるようになったので、2要素認証を設定します。ブラウザで&lt;https://account.ui.com/&gt;に接続します。\n“My Security”をタップします。\n\n\nMulti Factor Authentication(MFA)をEnableにします。\n\n\n”UI Verify”アプリを選択します。\n\n\nUI VerifyアプリをダウンロードしAppを構成します。\n\n\n2要素認証が完了し、アプリが使えない場合のメールアドレスへの通知が2要素認証のバックアップとして利用されます。\n\n\nこれで2要素認証が必須となり、UniFi Networkスマホアプリでは初回の認証時にUI Verifyアプリへのプッシュ通知が行われます。ユーザーが確認の応答を実施しログインが完了します。ローカル環境でブラウザなどからネットワークアプリケーションにログインする際や、UIアカウントサイトにログインする場合も2要素認証が求められ、UI Verifyアプリで応答する必要があります。\n\n\nufwのGUIUbuntuで今回設定したufwの設定を追加する場合、GUIによるツールを導入しておくと便利です。Ubuntu Softwareから”gufw”を探し、インストールします。\n\n\nSSHここではUbuntuにSSHする説明は割愛しますが、Ubiquiti日本語ガイドにSSHについての記載がありますので参照してください。\n\nUniFi - SSHでログイン（高度） https://help.jp.ui.com/articles/204909374/\n\nセットアップの完了ここまででUniFiのセットアップは完了です。ESXiのスナップショットを取得していらした方はスナップショットの管理から「すべて削除」し、一旦、Ubuntu全体のバックアップを取得される事をお勧めします。次の記事「UniFi Network Applicationの運用」で、UniFi Network Applicationの運用全般（設定のバックアップ、アップデート、通知）を紹介します。\nリソース以下の日本語ヘルプ、コミュニティがUniFiの構築には大いに参考になります。\n\nUbiquiti コミュニティ（日本） https://www.facebook.com/groups/uijapan\n\n\nUI 日本語ヘルプ記事 https://help.jp.ui.com/categories/6583256751383/\n\n\nUbiquiti Community（米国中心） https://community.ui.com/\n\n","categories":["Network"],"tags":["UniFi"]},{"title":"UniFi Network Applicationの運用","url":"/new-technology/2022/10/23/unifi-network-application2/","content":"\n\nこの記事で実現すること\n\n前回記事「UniFi Network Applicationのセットアップ」では、UniFi Network ApplicationをUbuntu上にセットアップし、UniFiネットワーク製品の登録（Adoption）までを行いました。この記事ではホームユーザーがUniFi製品を運用していくにあたり、必要な操作ができるようになることを目的としています。\n\n\n日本語ガイドセットアップが完了し、運用開始するにあたり、日本の公式のガイドとして以下のリソースがあります。\n\nUniFi - アップデート https://help.jp.ui.com/articles/7605005245975/\n\n\n接続の課題などのFAQ https://help.jp.ui.com/articles/7258465146519/\n\nUniFiデバイス一覧およびアップデートhttps://UniFi Network Application Host:8443/に接続すると左にカテゴリのアイコンが並びます。以下のように左の赤枠で囲ったUNIFI DEVICES一覧では現在のAdoptされているUniFi機器の一覧が確認できます。\n\n\nバージョンアップの通知があれば、ここでClick to Updateのように表示されますので、これをクリックしてデバイスのアップデートが行えます。リリースの情報については本国のCommunityを参照することになります。\n\nUniFi リリース一覧 https://community.ui.com/releases/\n\n\n\nここでは、OfficialまたはRelease Candidate(リリース候補）と区分されています。Network Applicationの初期設定では、Officialのものが自動的にアップデートされる仕組みになっています。後に説明する設定画面で、Official,Release Candidate,Early Accessと3つの区分を選択可能です。\n実際のリリースのポストを参照すると先頭には簡単なリリースノーツが記述されており、それ以下でユーザーによるレポートが続きます。前回も記載しましたが、マニュアルがないことや製品提供機能やUbiquitiの今後の方向性があまり見えてこないこともあり、他のプロダクトと比較しても、ユーザーからは辛辣な意見が寄せられる事が多いです。単なる不満（ユーザーのスキル不足や、製品への過剰な期待や思い込みが原因である事も多いように感じられます）の投稿によって重要な情報を見失わないようにすることが大事です。詳細な検証結果など貴重な情報を提供してくれるユーザーも存在しています。\nデバイスを選択すると個々のデバイスのトラフィック状況などが確認できます。Settingsに進むとバージョンアップや再起動、ファームウェアのロールバックなどが実行できます。また、デバイスをリセットする場合や他のネットワークに使う場合は、Forgetを選択します。\n\n\nファームウェアをロールバック（ダウングレード）する場合は、該当製品のファームウェアバージョンのURLを指定します。ここで説明している使い方は、Ubiquitiクラウド連携を前提としており、UniFiネットワークアプリケーション、スイッチ共にインターネットへ接続可能である必要があります。リリース一覧は以下のURLから確認します。\n\nUniFi APなどhttps://www.ui.com/download/unifi/\n\n\nUniFi スイッチhttps://www.ui.com/download/unifi-switching-routing\n\n\n\n左メニューのプルダウンから製品を選択すると以下のように最新バージョンが表示されます。ここからPAST FIRMWAREを選択し、具体的なバージョンを指定してから、ダウンロードを選択するとURLが示されるので、そのURLをネットワークアプリケーションのデバイスのURLに貼り付け、Updateを実行します。\n\n\nここまでの作業はスマホアプリ（UniFi Network）でも同様の操作が可能です。\nクライアントデバイス一覧以下のように左の赤枠で囲ったCLIENT DEVICESでは現在のUniFiネットワークに接続されているクライアント一覧が確認できます。\n\n\nここではIPアドレス、クライアントが所属するVLAN、接続しているWi-Fiの情報、トラフィックなどが確認できます。もし、UniFiのL3スイッチがあれば、L3スイッチにDHCP機能があるので、この画面からスタティックIPアドレスを設定可能です。\nこの画面もスマホアプリで同様の操作と確認ができます。\n設定以下のように左の赤枠で囲ったSETTINGSではUniFi製品群の全般的な設定をします。なおこの記事のUniFiの構成では、UDM Proなどのセキュリティゲートウェイを保有していない状態であり、単独のUniFi Network Applicationの設定例となります。以下の左側メニューのInternet、VPN、Traffic Management、Firewall & Securityは対象外です。\n\n\nWiFiWiFi設定では名前、所属するVLAN、チャンネルなど設定します。UniFiは集中型管理であるため、個々のAP毎に設定するよりはネットワーク全体でどのように管理するかを決めるモデルとなります。\n\nGlobal AP Settings この設定で、複数APを立てることを想定し、全般設定を行います。\n\nChannel Width 2.4GHz、5GHzそれぞれでバンド幅を設定します。ここは個人の好みによりますが、一般的なデバイスのために2.4GHzは20MHzを、5GHzでは80MHzを設定することをお勧めします。もちろん、PCなども無線でできるだけ速度を求める方は160MHzの設定が可能です。こういった場合は、AP単位にバンド幅を個別設定し、クライアント単位に接続させるAPを固定させる事ができます。\n\nTransmit Power 無線の送信出力を決めます。Auto&#x2F;High&#x2F;Medium&#x2F;Lowが選択できます。\n\nAP Site Settings Wiress Meshingの項目がありますが、メッシュ製品（無線によるバックホール接続）は現在日本では発売されていません。\n\nNightly Channel Optimization 夜間に外部のWiFiの電波状況を見ながらUniFi側でWiFiチャネルの最適化を行います。比較的近い距離で同一のチャンネルを選択していると競合することになるのでこれは実際にテストしながら選択されることをお勧めします。\n\n\nこれより詳細のWiFi設定についてはまた別の機会があれば書きたいと思います。\nNetworksNetworksでは主にVLANとスイッチの全般設定をします。\n\n\n今回の記事は概要に留めますが、VLANを構成する場合にはスイッチ単位ではなく、ネットワークアプリケーションでネットワーク全体の構成を決めることになります。もし、UniFiのL3スイッチがあり、L3ネットワークにするのであれば、L3のDHCPを有効にします。L3スイッチがない場合で単にL2のVLANを作成する場合は、VLAN Only NetworkとしてVLANを作成し、ルーティングやDHCP機能はFirewallやルータに任せることになります。\n一旦ネットワークアプリケーションでVLANを定義すると、どのスイッチからもそのVLANが利用できるようになります。\n以下はFirewallを利用する場合の一例です。インターネット接続がホームゲートウェイとなる場合、もちろんFirewallとHGWとを直結しても構いませんが、トラフィックを把握するためにVLANを定義し、FirewallのWANとHGWとをスイッチに接続します。こういった場合にはUniFiスイッチではFirewallの外側（ホームゲートウェイ側）と内側（LAN）のネットワークとを分離するため、VLAN OnlyでWANのVLANを作成することになります。\n\n\nUniFiネットワークアプリケーション7.4.156からは、VLANの概念は仮想ネットワークという概念に変わっています。メインのネットワーク（タグ無し）と許可&#x2F;禁止するネットワーク（VLAN）として定義することになり、ネットワーク専門用語ではなく、UniFiの世界の用語へと変わっていくようです。\n\nGlobal Network Settings ネットワーク設定全般を行います。スイッチの共通設定部分になります。\n\nMulticast DNS Apple AirPlayやGoogle Chromecastのためにネットワークセグメントを超えてmDNS(Bonjour)の名前解決およびデータ配信を支援します。\n\nIGMP Snooping 本来は、マルチキャストトラフィックを使っていないクライアントに対してはパケットの転送を抑制するためのものですが、スイッチでPackets Discardedのカウンタが増えるのが気になり私は無効にしています。WiFiネットワークがあるセグメントにひかりTVなど、対象セグメントに一定量のマルチキャストトラフィックを流すのが気になる場合はセグメントをVLANで分離する方がお勧めです。\n\nGlobal Switch Settings 複数スイッチの共通設定を指定します。主には、Flow Control、Jumbo Framesがあります。また固有のスイッチだけフローコントロールを外すとか個別設定が可能なように、Switch Exclusionから該当するスイッチを選択できます。\n\n\nSystemSystemでは主にネットワークアプリケーション全般設定をします。\n\n\nNetwork Notificationで通知設定ができます。これはメール、スマホアプリへの通知、ネットワークアプリケーション画面上での通知が選択できます。ファームウェア通知、APのレーダー受信、クライアントの接続/切断通知など設定項目は多岐にわたります。\n\nその他主要項目を抜粋します。\n\nUpdates ここではデバイスのファームウェア情報についての設定です。ネットワークアプリケーション自身のアップデートがある場合、デバイスのアップデートがある場合は通知できます。ここで接続チャネル（Officail&#x2F;Release Candidate&#x2F;Early Access）が選べます。なお、ネットワークアプリケーションはインストールで実施したようにShellスクリプトで実施することになります（後述します）。\n\nDevice Auto Updates デバイスを自動的にアップデートするか選択します。最新ファームウェアが公開されると時刻に関係なくアップデートされるので、ここはオフに設定し、Schedule Device Updatesで週末などにアップデートする設定を追加することをお勧めします。\n\n\n \n\n\nBackup ネットワークアプリケーションの設定のバックアップです。日次、週次、月次でバックアップ可能です。トラフィックログも併せてバックアップが可能です。\n\nSystem Logging デバイスのログをsyslogに転送できます。syslogサーバのIPアドレスとPort（一般的に514）を設定します。\n\nNetwork Device SSH Authentication スイッチやAPに対しSSH可能です。スイッチの詳細なカウンタを取得するために必要です。カウンタのエラーが無いか、切断回数などを確認するために使います。パスワード認証または公開鍵を設定することでUniFiデバイスへ接続可能になります。\n\n\n \n\n\nOther Configuration NTPの設定、メールサーバーの設定ができます。メールサーバーはCloudを選択するとUbiquitiクラウドからメール通知が行われます。\n\nNetwork ApplicationのバージョンアップNetwork ApplicationはこのGUIから更新することはできず、前回記事「UniFi Network Applicationのセットアップ」で説明したLinuxのシェルからアップデートスクリプトを実行することになります。Windows、macOSでお使いの方は最新モジュールをダウンロードし、セットアップを実行することになります。ここではUbuntuのアップデートの例を記載します。\nスクリプトの情報は、コミュニティにあります。https://community.ui.com/questions/UniFi-Installation-Scripts-or-UniFi-Easy-Update-Script-or-UniFi-Lets-Encrypt-or-UniFi-Easy-Encrypt-/ccbc7530-dd61-40a7-82ec-22b17f027776\nセットアップで失敗した際にすぐに戻れるように、このタイミングでESXiのスナップショット、またはバックアップの取得をお勧めします。\n実行は3ステップです。Ubuntuの端末から、以下のコマンドを実行します。\n\n管理者になります\n\n$ sudo -i\n\n\n証明書などのダウンロードをします。\n\n$ apt-get update; apt-get install ca-certificates wget -y\n\n\nネットワークアプリケーションのアップデートを行います。\n\n$ rm unifi-update.sh &amp;&gt; /dev/null; wget https://get.glennr.nl/unifi/update/unifi-update.sh &amp;&amp; bash unifi-update.sh\n\n上記のCommunityでは、個別のバージョンのスクリプトシェルへのリンクもありますので、unifi-updates.shの代わりに、バージョンを指定したスクリプトでインストールすることもできます。ロールバックは対応していないとの情報があるので、私はESXiでのバックアップを保存するようにしています。\n日本語ガイドにもアップデートに関する言及があります。\n\nUniFi Network - 他社製の非コンソールUniFi Networkアプリケーションをアップデートする（Linux - 高度） https://help.jp.ui.com/articles/220066768/\n\nリソース以下の日本語ヘルプ、コミュニティがUniFiの構築には大いに参考になります。\n\nUbiquiti コミュニティ（日本） https://www.facebook.com/groups/uijapan\n\n\nUI 日本語ヘルプ記事 https://help.jp.ui.com/categories/6583256751383/\n\n\nUbiquiti Community（米国中心） https://community.ui.com/\n\n","categories":["Network"],"tags":["UniFi"]},{"title":"UniFiスイッチ アクセスコントロール","url":"/new-technology/2025/02/11/unifi-sw-l3/","content":"\nこの記事で実現すること\n\nこの記事ではホームユーザー向けにUniFiスイッチのL3レイヤおよびL2レイヤアクセスコントロール（ACL）の機能を紹介します。\n\n\nUniFiスイッチの一般的な使い方UniFiスイッチにはPro AggregationなどのL3スイッチ機能を持つものがあり、異なるサブネットへのルーティングが出来ます。もっとも個人向けのUniFiではDream MachineなどのUniFiゲートウェイを中心として複数のサブネットにルーティングするデザインが一般的です。それに対して、CloudKey+などのゲートウェイ無しのコンソールで配下のスイッチ・AP・監視カメラを管理するスタイルで別途ホームゲートウェイに接続したり、別のセキュリティゲートウェイ（firewall）を用意するケースもあるでしょう。\nUbiqutiがお勧めするのは前者であり、UniFiゲートウェイで配下の端末やアクセスコントロールを集中管理できるのがメリットとしています。管理がとても楽なのは間違いありません。\nL3ネットワーク少し煩雑でもできるだけ用途別のトラフィックを1つのサブネットに留めておきたいというニーズはあると思います。必ずしもインターネットを利用しない端末やサーバーのバックアップなど、仮想マシンから複数の足を出してユーザーが利用するネットワーク、バックアップ専用ネットワークと使い分けたりします。こういった用途はスイッチの単位でトラフィックを閉じ込める事もできますが、ゲストや家族向けなど複数のスイッチに跨ってアクセスコントロールが必要な場合もあります。\n以下は一例（私の自宅の環境）です。\n\n\n\nServerセグメントには仮想サーバー群、NASが設置してあります\nFamilyセグメントはiOS、Windowsを中心に家族が利用する端末があります。\nGuestセグメントはIoT、会社の端末が接続します。\n\nこれらは全てタグ有り（デフォルト1以外のタグ）のネットワークで構成されています。タグ無しのデフォルトネットワークはUniFiのCloudkeyと監視カメラ、メインの仮想マシン（ESXi）が接続されています。こういったセグメント構成は個人向けとしてはよくある形ではないかと思います。それでGuestは当然、ServerやFamilyと繋ぐ必要はない一方で、FamilyからServerへのアクセスは必要となります。セグメントを超える場合（ルーティングする場合）はすべからくゲートウェイ（firewall）を経由するネットワークデザインも有りなんですが、macOSからNASへのバックアップ（TimeMachine）などやはり様々なデータフローがあるので、全てをゲートウェイ経由というのは少しやりすぎではないかと思うのです。そこで私の場合は、L3スイッチを効果的に使うべく、FamilyからServerへのセグメント越えはL3スイッチを使ったルーティングにしています。\nL3ネットワークの作成以下のようにコンソールのネットワークを開きます。\n\n\nすでに構成されたセグメントを見るとわかるように、どのL3スイッチ上にL3ネットワークを作るかを指定します。作り方は簡単で、New Virtual Networkをクリックし、赤枠で囲ったL3スイッチを選択し、新たなセグメントで割り当てるスイッチ自身のIPアドレス、VLAN IDを指定するだけです。\n\n\nAuto-Scale Networkのチェックは外し、Host IP Addressを新しいセグメントのIPアドレスを指定します。一般的な24ビットのネットワークであれば第3オクテットの数字を10などとしてスイッチのIPを決めます。またVLAN IDもそれに合わせておいた方がわかりやすいですね。\nなお、UniFiのL3スイッチはDHCP機能を持ちますので、簡易にIPv4アドレスをホストに割り当てたい場合には利用できます。但し、DHCPオプションの高度な事はできませんし、IPv6の割り当て機能もありません。\nインターネットにルーティングするためのデフォルトゲートウェイの指定以外に、このようにL3スイッチ経由で特定のセグメントにルーティングするならばスタティックルーティングの設定が個々の端末に必要になります。このためにはDCHPサーバーにOption121によるスタティックルーティングの情報を登録する必要があるのですが、今のUniFi Consoleにはそれを設定する機能がありません。そういうわけで私はスイッチのDHCPを使わず、firewallのDHCPを利用してスタティックルーティングの情報を各端末に配布しています。同様にIPv6もfirewall側で配布しています。\nなお、UniFiのL3にはInter-VLANと呼ばれる、UniFi以外のゲートウェイにルーティングするための専用VLAN（4040）が存在します。L3スイッチから直接ゲートウェイの指定IPにルーティングする機能があり、これを併用すれば端末のデフォルトゲートウェイをスイッチにしてさえおけば、個別のスタティックルーティングの設定は不要になります。今回の記事ではこの説明は割愛します。\nL3アクセスコントロールさて、本題です。UniFiではL3レイヤのACLとL2レイヤのACLが可能です。L3レイヤのACLは当然L3スイッチを対象としていますが、L2の方は、USW-Flex-Miniなどの小型スイッチ以外のL2スイッチについて対応しています。\nL3の方は簡単です。L3 Network Isolation (ACL)で、Source Networkから見て、接続できない（Isolate）ネットワークを指定するだけです。\n\n\nここでは、Guestから隣接するL3ネットワーク全てに接続できないという指定をしています。L3 Network IsolationからCreate Entryをクリックして作成します。\n\n\nこれでGuestセグメントから他のセグメントへのルーティングは出来なくなりました。\nL2アクセスコントロール今度はL2、MACアドレスレベルのACLです。今や端末のMACアドレスを指定してアクセス制御するというのは手間が大変なので実施しなくなってきています。唯一使うケースはゲートウェイを除いて他の端末とは相互にアクセスしない(Isolated)、これに尽きるのではないでしょうか。ゲストネットワークではそれを利用するニーズがあるでしょう。\n元々Wi-FiのレベルではIsolationを有効にする機能はありました。たとえば飲食店向けにWi-Fiをゲストに開放し、管理用端末は有線LANとしておくことで目的は達成できます。\n\n\nこれは対象Wi-FiにClient Device Isolationのチェックをするだけでとても簡単に実現できていました。\nしかしながら自宅でゲスト向けの有線端末を使う場合は、無線端末と有線端末とは相互にアクセスできる状況にありました。私の場合、会社の端末やIoTは私の情報資産があるネットワークと分離できていることが必須と考えていましたが、自宅のIoTと会社の端末が同一ネットワークで相互にアクセス可能なのは少し気になるところでした。\nこれは、UniFiゲートウェイを利用されている方はとても簡単で、前述したNetworkの Switch Isolation SettingsのDevice Isolation(ACL)にチェックを入れるだけで実現できます。これでインターネットへの接続は可能な状態で同一セグメントの端末同士のアクセスが行えなくなります。\n独自のfirewallなどのゲートウェイを使っている方は少し工夫が必要です。前述した方法だと、UniFiはどのMacアドレスがゲートウェイなのか理解できないため、ゲートウェイ宛のパケット（およびDHCPなどのIP割り当て）もフィルタされてしまいます。\n私のように独自ゲートウェイ（firewall）を利用している方は、別の方法でACLを実現します。\nUniFiのSecurityメニューからACLを選びます。以下の赤枠で囲ったところが相互にアクセスできないようにするACLのリストです。\n\n\nまず、ここでは、ゲートウェイのMACアドレスは”00:0c:29:02:7c:96”とします（私の仮想環境ESXi上のFirewall兼DNS兼DHCP）。L2 ACLルールの中身は以下の通りです。\n\nSource Any(全ての端末)からDestination”firewall”のアクセスを許可します。\nSource　”firewall”からDestination Anyのアクセスを許可します。\nSource AnyからDestination MACアドレスff:ff:ff:ff:ffのアクセスを許可します。これはarpによるIPアドレスからMACアドレスの解決に必要です。\nSource AnyからDestination Anyを拒否します。\n\nなお、スイッチにSSHして確認すると以下のように定義されています。（GuestのVLAN IDは***としています）\nmac access-list extended global_mac_aclpermit any 00:0c:29:02:7c:96 00:00:00:00:00:00 vlan eq ***permit 00:0c:29:02:7c:96 00:00:00:00:00:00 any vlan eq ***permit any ff:ff:ff:ff:ff:ff 00:00:00:00:00:00 vlan eq ***deny any any vlan eq ***permit any any\n\nこれで対象のネットワークでインターネットだけを許可し、その他無線、有線違いのアクセスはできなくなります（Flex miniを除いては）。この設定は2024年11月7日のUNA8.6.9（Official）から有効になったようです。\n\nUniFi リリース https://community.ui.com/releases/UniFi-Network-Application-8-6-9/e4bd3f71-a2c4-4c98-b12a-a8b0b1c2178e Fixed an issue where MAC ACLs didn’t function correctly when using any as source or destination.\n\n私の自宅にはUniFi Switchが6台とAPが2台ありますが、Flex miniを除き、一括で全てのスイッチにコンフィグを流し込んでくれるのは改めて便利だなと感じるところです。\nなお、ご参考までに、IPv4単位のフィルタも可能です。先ほどのACLに最終2行に記載してあります。\n\n192.168.1.128&#x2F;25から192.168.2.0&#x2F;24を許可\n192.168.1.0&#x2F;24から192.168.2.0&#x2F;24を拒否\n\nこのように、192.168.1.0&#x2F;24の後半128個のサブネットから192.168.2.0&#x2F;24セグメントへのアクセスは許可し、192.168.1.0&#x2F;24の前半のサブネットから192.168.2.0&#x2F;24へのアクセスは拒否するといったACLが実現可能です。\n","categories":["Hardware","Network"],"tags":["UniFi"]},{"title":"UniFiスイッチ","url":"/new-technology/2022/11/23/unifi-switch/","content":"\nこの記事で実現すること\n\nこの記事ではホームユーザー向けにUniFiスイッチの設定ができるようになることを目的としています。\n\n\nUniFiスイッチの特徴UniFiネットワークスイッチの特徴としては、どちらかといえばスモールビジネス向けの製品が中心ではあります。スモールオフィスの基幹ネットワークを構成しながら、監視カメラやWi-Fiシステムを導入し、トータルソリューションが売りになります。ネットワークスイッチ単独の機能として見ると、以下の特徴があります。\n\nWi-FiにRJ45ケーブルで通信と電力出力を兼ねるPoE\nSFP＋などの10GbEネットワーク\nUniFiネットワークアプリケーションによる集中管理\n\nホームユーザー向けとして自宅内のネットワークを10GbEかつSFP+を選択する場合は、いくつかの魅力的なネットワークスイッチが候補に上がります。発熱対策のために各部屋にSFP+でOM3などの光ケーブルを通す場合は、個人向けのネットワークスイッチではPortが不足してしまうのが実態です。機器の価格帯が個人向け、かつ消去法でいくとMikroTikかUniFiが選択肢に上がります。円安で昔ほどは安いと思えなくなりましたが、SFP+スイッチは廉価です。\n基本設定基本設定です。UniFiスイッチを新規導入する際には、ネットワークアプリケーションに登録（採用）する必要があります。初期セットアップについては、以下の記事を参照してください。UniFi製品群の標準の考え方ではセキュリティゲートウェイをインターネットルーターの役割として配置し、そこに各UniFi製品群をぶら下げることになります。私はSophos Firewallを利用しており、UniFiセキュリティゲートウェイは不要としているため、集中管理のためのUniFiネットワークアプリケーションを導入しています。\n\nUbiquiti UniFiの世界\nUniFi Network Applicationのセットアップ\nUniFi Network Applicationの運用\n\nUniFiスイッチが採用（Adoption）されると、ネットワークアプリケーションから管理できるようになります。\nスイッチ毎のSettingsでは、Serviceで基本設定を、NetworkでIPアドレスを設定できます。\n\n\nServiceでは、スイッチ自身がどのネットワーク（VLAN）に属するのかを決め、Flow ControlやJumbo Frameの設定が可能です。デフォルトでFlow ControlはOffです。ネットワーク速度が異なる端末を接続する場合は、Flow ControlはOnの方が良いでしょう。もちろん、送信側端末のネットワークカードがFlow Controlに対応している必要はあります。最近、UniFiネットワークアプリケーションではスイッチのGlobalSettingが可能となり、スイッチ毎にこれらの設定が不要になっています。\n\n\n\nNetworkでは、静的IPアドレスを設定することもできます。\nその他、Settingsからは、スイッチの再起動が可能です。\nスイッチポート確認スイッチ毎のPortsからはPortの稼働状況が確認できます。\n\n\n\n\n\n項目名\n内容\n\n\n\nStatus\n実際に接続されている速度を示します。稀にファームウェアのアップデートのタイミングで誤った認識になる場合があります\n\n\nTx&#x2F;Rx\n送信(Tx)、受信(Rx)量を示します\n\n\nProfile\nUniFiのVLANは複数のネットワークを指定した上で纏めたトランクポートを複数種類作成可能です。ネットワークアプリケーション7.4からは仮想ネットワークバインディングという概念があり、このProfileは使わなくても済むようになりました（もちろん使っても構いません）。\n\n\nUplink\n上流の機器を示します。UniFiがInternetへのルーティングを解析し、Internet接続ルーターを上流として自動的にUplinkポートを判別します\n\n\nその他、SFPモジュールの情報などが出力されています。\nスイッチポート設定スイッチ毎のPortsからさらにPort Managementを選択すると、個々のPortの設定を行えます。\n\n\nこれはPro-Aggregationの例ですが、Portごとに接続されているクライアントが表示されています。ここで個別のPortを選択すると、ポートの速度やVLANを設定できます。\nPortの設定変更Portの物理的な設定変更は以下のPort Profile Overrideから行います。\n\n\n\n\n\n項目名\n内容\n\n\n\nOperation\nSwitching または、Aggregate（複数のPortを束ねて帯域を増やす）、Mirrorを選択します。\n\n\nLink Speed\nオートネゴ、10Gbps、2.5Gbpsなどの速度固定を選択します。なお、2.5Gはオートネゴでは動作しません\n\n\nPort Isolation\nUplinkポートのみトラフィックを転送します\n\n\nStorm Control\nブロードキャスト、マルチキャストなどの飽和を某防止します\n\n\nLLDP\nディスカバリプロトコルを有効にします（デフォルトON）\n\n\nSpanning Tree Protocol\nスパニングツリーを有効にします（デフォルトON）\n\n\nミラーPortはトラブル時の確認のために使います。トラブルのあるPort番号を指定し、ミラーに設定することで同じデータが流れます。ノートPCなどを接続し、WireSharkなどを使いパケット解析します。\nSFP+の製品であっても、USW-AggregationスイッチやUSW-Enterprise-8-PoEのSFP+ポートは2.5GbEに対応していません。過去記事「SFP+の2.5GbE対応」で書いたように、10GbEを2.5GbEとして偽装させる特殊なSFP+モジュールが必要になります（もっとも、USW-Enterprise-8-PoEは2.5GbEのRJ45ポートを備えているので運用上困ることはありませんが）。\nVLANを設定VLANを作成するにはネットワークアプリケーションのSETTINGSからNETWORKSを選択し、Create New Networkをクリックします。\nL3スイッチではなく、単にVLANを作成したい場合は、ここでVLAN-only NetworkのチェックボックスをONにし、VLAN IDを決定します。\n\n\nこういったネットワーク構成全般の変更を行うと、全てのスイッチに対してコンフィグの転送が行われ、スイッチの再構成が実行されます。\nトランクポートとして使う場合は２つの方法があります。\n\n仮想ネットワークバインディングで許可するVLANまたはブロックするVLANを指定します。\n予め作成した複数のネットワークを束ねたProfileを作成した上でそれを指定します。\n\n仮想ネットワークバインディングを使う方法ネットワークアプリケーションv7.4から導入された仮想ネットワークバインディングは、従前のように、トランクポートのネットワークの組み合わせをわざわざProfileで作成しなくて済むというメリットがあります。\n\nタグなしのメインのネットワーク（ネイティブVLAN）を決めた上で、タグ付きのVLANについては、許可する、ブロックするの分類を指定します。ファイアウォールのように許可かブロックかを選択するというものではなく、ネイティブVLAN以外のタグ付きVLANを全て列挙し、許可またはブロックの何れかに分類するという方が近いでしょう。\n仮想ネットワークバインディングで該当なしを選択すると、そのポートには全てのデータが流れることになるようです。Switch Flex MiniのようにProfileを割り当てできない小型スイッチではこの該当なしを選択してアップリンクのスイッチからタグ無し、タグ有りのパケットをそのまま送受信する事になります。\n従来からのProfileを使う方法Profile作成時には指定する複数のネットワークのうちどれか1つをネイティブVLANとしてタグ無しに設定します。昨今、デフォルトVLANを変えることがセキュリティ上優位であるとも思えないので、私は管理用VLANは無条件にデフォルトVLAN（VLAN ID&#x3D;1）で管理するようにしています。\nProfileを使う方式では、このようにネイティブVLANがどのネットワークか定め、タグ付きのVLANを追加で選択していきます。\n\n\nProfileを作成後、スイッチポートの設定にて、イーサネットポートプロファイルのチェックボックスをオンにしてリストボックスからProfileを指定します。\n\n\nこの例では、 UniFi-APはデフォルトVLANで接続し、AP同士の制御用パケットは全てデフォルトVLAN配下に流れます。また、タグ付きネットワークでVLAN-XXX（一般端末向け）とGuestがありますが、UniFi-APは複数のネットワークに属することができますので1つのAPで複数のネットワークに対してWi-Fiサービス提供できるようになります。\nネットワーク機器のLANをデフォルトVLAN、かつ、ネイティブVLAN（タグ無し）としているのは何らかのトラブル時に復旧させやすいという点もあります。\nSSHUniFiスイッチは廉価なSwitch Flex Miniを除き、大半のスイッチはSSH接続が可能です。ネットワークアプリケーションで設定したID&#x2F;パスワードでも接続できますし、公開鍵認証でも接続可能です。スイッチにSSHすると Linuxのインタフェースのように見えます。\n$ ssh xxxBusyBox v1.25.1 () built-in shell (ash)  ___ ___      .__________.__ |   |   |____ |__\\_  ____/__| |   |   /    \\|  ||  __) |  |   (c) 2010-2022 |   |  |   |  \\  ||  \\   |  |   Ubiquiti Inc. |______|___|  /__||__/   |__|            |_/                  https://www.ui.com      Welcome to UniFi USW-Aggregation!********************************* NOTICE *********************************** By logging in to, accessing, or using any Ubiquiti product, you are     ** signifying that you have read our Terms of Service (ToS) and End User   ** License Agreement (EULA), understand their terms, and agree to be       ** fully bound to them. The use of SSH (Secure Shell) can potentially      ** harm Ubiquiti devices and result in lost access to them and their data. ** By proceeding, you acknowledge that the use of SSH to modify device(s)  ** outside of their normal operational scope, or in any manner             ** inconsistent with the ToS or EULA, will permanently and irrevocably     ** void any applicable warranty.                                           ****************************************************************************USW-Aggregation-US.6.3.13# cd /var/logUSW-Aggregation-US.6.3.13# vi messagesUSW-Aggregation-US.6.3.13# ping 192.168.x.100PING 192.168.x.100 (192.168.x.100): 56 data bytes64 bytes from 192.168.x.100: seq=0 ttl=64 time=0.000 ms64 bytes from 192.168.x.100: seq=1 ttl=64 time=10.000 ms64 bytes from 192.168.x.100: seq=2 ttl=64 time=10.001 ms64 bytes from 192.168.x.100: seq=3 ttl=64 time=10.000 ms64 bytes from 192.168.x.100: seq=4 ttl=64 time=10.001 ms\n\n /var/log/messagesにはsyslogがありますので、たまには中身を確認されることをお勧めします（viコマンドなどで開きます）。表向き、SFPモジュールが動作しているように見えても、互換性の問題でエラーを吐いている場合もあります。ダイレクトアタッチケーブルなどを対向の端末を繋がずスイッチに接続している場合など定期的にLinkDownのアラートが出ている場合もあります。RJ45とは動きは異なります。\n上記はUSW-Aggregationに接続した状態ですが、pingも動作しますが、レスポンスは悪いです。LAN内の機器の応答に10ms掛かっていますが驚かないでください。スイッチのデータ転送は専用チップ（ASIC）が行うため、機器のCPUがスイッチの実力にはなりません。OSに割り当てるCPUリソースの関係でしょうか、このpingの応答速度は「ご参考」として割り切った方が良さそうです。\nスイッチの詳細情報についてLinuxのコンソールから、cliコマンドを投入することで、Ciscoライクなスイッチのコマンドモードに入ることができます。コマンド入力途中でタブを押下するとコマンドが補完されます。show  running-configなどそのまま使えます。copy running-config startup-configなども実行できそうですが、UniFiではネットワークアプリケーションから完全同期されていることが大前提であり、コマンドモードで設定しても再起動時にはネットワークアプリケーションから上書きされてしまいます。ややこしいのは、スイッチ毎にコマンドの互換性が殆どないことです。コマンドの途中で&quot;？&quot;を入力すると、実行できるパラメータが列挙されるので推測でコマンドを補完しながら入力することになります。私の知る限り、機種毎のコマンドラインのマニュアルは存在しないようです。\nUSW-Pro-Aggregation(L3スイッチ)このスイッチは比較的コマンドが充実しています。cliでコマンドモードに入り、enで特権モードに入ります。Portの状況を見るには以下のコマンドを使います。\n(UBNT) #show interface ethernet 0/x\nこれだと100行余りの結果が表示されるのでパイプ（｜）で区切り、必要な項目だけフィルタできます。\n(UBNT) #show interface ethernet 0/x | include Error|Collision|DiscardTotal Packets Received Without Errors.......... 43388669Receive Packets Discarded...................... 0Total Packets Received with MAC Errors......... 0Alignment Errors Received...................... 0FCS Errors Received............................ 0URPF Discards.................................. 0Transmit Packets Discarded..................... 0Total Transmit Errors.......................... 0FCS Errors Transmitted......................... 0Total Transmit Packets Discarded............... 0Single Collision Frames........................ 0Multiple Collision Frames...................... 0Excessive Collision Frames..................... 0(UBNT) #\n\nこのようにして重要な情報のみ取得できます。あくまで一般的なパラメータとしていますが、現代の全二重の通信前提であればCollisionまで見る必要はないですね。一般的にはReceiveでエラーがあるときはケーブルを最初に疑ってみること、Transmit Packets Discardedの場合はVLANの設定が間違っている可能性があることでしょうか。\nclear counters all\nカウンタをクリアします。\nshow fiber-ports optics-info all\nモジュールのメーカーやシリアル番号を表示します。\n(UBNT) #show fiber-ports optics all                                                 Output   InputPort    Physical Port/  Temp  Voltage  Current   Power    Power     TX     LOS        Lane Number     [C]   [Volt]     [mA]    [dBm]    [dBm]     Fault------  --------------  ----  -------  -------   -------  -------   -----  ---0/4     0/4-Lane1       34.2    3.328     10.2    -3.370   -2.496   No     No0/5     0/5-Lane1       34.5    3.265     10.4    -2.976   -3.373   No     No0/8     0/8-Lane1       34.0    3.360     10.2    -3.799   -1.643   No     No0/9     0/9-Lane1        N/A      N/A      N/A       N/A      N/A   N/A    N/A0/12    0/12-Lane1       N/A      N/A      N/A       N/A      N/A   N/A    N/A0/15    0/15-Lane1       N/A      N/A      N/A       N/A      N/A   N/A    N/A0/18    0/18-Lane1       N/A      N/A      N/A       N/A      N/A   N/A    N/A0/19    0/19-Lane1       N/A      N/A      N/A       N/A      N/A   N/A    N/A0/22    0/22-Lane1       N/A      N/A      N/A       N/A      N/A   N/A    N/A0/26    0/26-Lane1      33.3    3.235      6.0    -3.002   -3.002   No     No Temp - Internally measured transceiver temperatures. Voltage - Internally measured supply voltage. Current - Measured TX bias current. Output Power - Measured optical output power relative to 1mW. Input Power - Measured optical power received relative to 1mW. TX Fault - Transmitter fault. LOS - Loss of signal.(UBNT) #\nモジュールのDDM（温度、光の強さ）を表示します。\nUSW-Aggregation(SFP+ 8Port)このスイッチはcliでコマンドモードに入ったら、すぐに大半のコマンドが実行できます。代表的なのは以下のものです。\nshow interfaces TenGigabitEthernet x\nPort xのPort状況を表示します。パケットカウントやコリジョンなどの数を示します。\nclear interfaces TenGigabitEthernet  x counters\nPort xのカウンタをクリアします。\nshow fiber-transceiver-info interfaces  TenGigabitEthernet  x\nSFPモジュールの種類やシリアル番号を表示します。\nshow fiber-transceiver interfaces  TenGigabitEthernet x\nSFPモジュールのDDM（信号の強さ、温度）を示します。\nL3スイッチの制約UniFiのL3スイッチはDHCP機能を持ちますが、管理機能やルーティングについてはIPv6には対応していません。スイッチ自身はIPv6アドレスを持てるようですが、現段階でIPv6のL3ルーティングできるようにはなっていません。別のルーターでDHCPv6を割り当て、そちらをゲートウェイにするなどが必要です。L2スイッチを含めてIPv6通信が行えないということではありません。\nSFPモジュールUbiquitiのモジュール群は廉価なため、光モジュールは純正が間違いないでしょう。OM3ケーブルやDACはさまざまなメーカーのものを使いましたが、UniFi製品で問題が発生したことはありません。RJ45モジュールは特に10GbEのものは低電力を踏まえるとSFPメーカーの製品の選定も視野に入ります。\n\n\n1GbE tp-link TL-SM331一般的なMarvell社88E1111などを使ったモジュールが通常使用（Typical）で1.05Wの消費電力なのに対し、その半分以下の0.5Wとなっており、発熱もかなり抑えられています。最近、国内でも発売になったようですが、私は今年の5月に米Amazonで$19.99で購入し、問題なく使えています。\n\ntp-link https://www.tp-link.com/jp/service-provider/switch-accessory/tl-sm331t/\n\n10GbE Fiber mall SFP-10G-T-UB-80m80mまで対応した省電力の10GbEモジュールです。こちらも米Amazonで購入しました。＄68.99でした。BroadcomのBCM84891のチップを採用している80mに対応したモジュールはいくつか存在します。Cisco用のモジュール（SFP-10G-TS80）についてはメーカーの公表ではDDMに対応していないと記載があるものの、UniFiスイッチ上では、モジュールの温度などのパラメータが出力されています。\n\nFiber mall https://www.fibermall.com/ja/news/10g-copper-sfp.htm\n\n英語ですが、ぜひAmazonのカスタマーレビューを見てください。より詳細で素晴らしい知見に基づいたコメントが見られます。\n\n米Amazon Customer Review https://www.amazon.com/gp/customer-reviews/RLHW2OL4I1QZP/ref=cm_cr_dp_d_rvw_ttl?ie=UTF8&amp;ASIN=B0B18BY1XK\n\nPoEスイッチにおけるPoEもネットワークアプリケーションから設定できます。USW-Enterprise-8-PoEの例では、Switch Flex MiniおよびAPのU6 Proに給電している状況が確認できます。\n\n\nPort ManagementからPoEのOn&#x2F;Offが可能となっています。\nまとめこれらのように、ネットワークスイッチをただ単に繋げるための道具ではなく、ITやネットワークを見える化するという目的においては非常に有用な機器になります。セキュリティ観点ではできることは限られていますが、ホームユーザーにとっても有用な機能は活用できると思われます。\nUbiquiti 日本語ガイドのスイッチに関する記事は以下が参考になります。\n\nUniFi Network - 有線ネットワーク速度の最適化 https://help.jp.ui.com/articles/6949005136919/\n\nリソース以下の日本語ヘルプ、コミュニティがUniFiの構築には大いに参考になります。\n\nUbiquiti コミュニティ（日本） https://www.facebook.com/groups/uijapan\n\n\nUI 日本語ヘルプ記事 https://help.jp.ui.com/categories/6583256751383/\n\n\nUbiquiti Community（米国中心） https://community.ui.com/\n\n","categories":["Hardware","Network"],"tags":["SFP+","10GbE","UniFi"]},{"title":"Proxmox 8.2へのアップグレード","url":"/new-technology/2024/05/02/update-ProxmoxTo82/","content":"\n\nこの記事で実現すること\n\n2024-04-24にProxmox VE8.2が発表されています。ここではGUIでアップグレード（中身はapt upgrade）で説明するまでもないのですが、既知の不具合があり、ちょうど私のNIC（X710DA4）ではこの不具合の影響を受けることになったため、対応策についてまとめています。\n\n\n新機能新機能については以下の通りです。\n\nSupport for automated and unattended installation\nImport wizard for VMware ESXi VMs\nModernized Firewall based on nftables\nLXC device passthrough\nAdvanced Backup settings\nSupport for custom ACME-enabled CAs\nUI improvements\nDebian 12.5 (Bookworm), but using a newer Linux kernel 6.8;\nNew versions: QEMU 8.1, Ceph Reef 18.2, LXC 6.0, and Open ZFS 2.2;\n\n積極的にLinux Kernelのアップデートが行われていますね。\n\nProxmox VE 8.2 What’s new https://www.proxmox.com/en/services/videos/proxmox-virtual-environment/whats-new-in-proxmox-ve-8-2\n\n既知の不具合不具合については以下のページでまとめられています。\n\nKnown Issues &amp; Breaking Changes https://pve.proxmox.com/wiki/Roadmap#Proxmox_VE_8.2\n\nIntelのNICでX710シリーズでは以下の影響を受けます。カーネル変更を受けてインタフェース名の末尾にP0という文字列が加わるとのこと。\nKernel: Change in Network Interface NamesUpgrading kernels always carries the risk of network interface names changing, which can lead to invalid network configurations after a reboot. In this case, you must either update the network configuration to reflect the name changes, or pin the network interface to its name beforehand.\nSee the reference documentation on how to pin the interface names based on MAC Addresses.\nCurrently, the following models are known to be affected at higher rates:\nModels using i40e. Their names can get an additional port suffix like p0 added.\nその他は、以下の項目が挙げられています。\n\nKernel: DKMS(it may happen that installed DKMS modules will not build anymore)\nKernel: Split Lock Detection Slowing Down VMs\nOld Ceph Crash Reports\n\nアップグレードここでは8.1から8.2へのアップグレードを想定しています。前述した通り、X710シリーズのNICをお持ちの方は、アップグレード後にネットワークインタフェース名の不一致によってネットワーク経由でProxmoxに到達できなくなります。従い、アップグレード後はモニタを接続し、ローカルのShellでネットワークインタフェース名を変更することになります。GUIからは以下の通り実行します。その後再起動が必要です。\n\n\nProxmoxのノードを選択の上、「アップデート」の項目から再表示し、アップグレードを実行します。\n終了後、再起動させてアップグレード処理を完了させます。\nネットワークインタフェースの変更私の持っているインタフェースは8.1の時は以下の通りでした。\n\n\n8.2では以下になります（修正完了後）\n\n\n４つのインタフェースの末尾にnp0〜np3の文字列が加えられています。\nさて、物理ノードにモニターを接続し、Proxmoxを起動します。\n\nip address showで実際のインタフェース名を調べます。ip a 以下のように新しいカーネルでのインタフェース名を確認します。\n\n 2: enp1s0f0np0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq master vmbr0 state UP group default qlen 1000   link/ether 3c:fd:fe:xx:xx:xx brd ff:ff:ff:ff:ff:ff\n\n&#x2F;etc&#x2F;network&#x2F;interfacesファイルを修正します。ファイルのバックアップ取得をしてから実施をお勧めします。\n\n root@pve1:~# cd /etc/networkroot@pve1:/etc/network# cp interfaces interfaces.bakroot@pve1:/etc/network# vi interfaces\n viなどでinterfacesファイルの以下の項目を見つけインタフェース名をip aで出力されたインタフェース名に合わせます。 ちょうどbridge-portsの行です。これをインタフェースの数だけ修正します（私の場合は4Portなので４つ）。 auto vmbr0iface vmbr0 inet static       address 192.168.2.x/24       gateway 192.168.2.x       bridge-ports enp1s0f0       bridge-stp off       bridge-fd 03. ネットワークをリスタートします。service networking restart\nこれで対応は完了です。\nその他（古いカーネルでの起動）その他の何らかのトラブルでが発生した場合、古いカーネルで起動したい場合は、Bootメニューに古いカーネルが選択できます（UEFIのGRUB）。今回の8.1からのアップグレードでは、古いカーネルは、6.5.13-5、新しいカーネルは、6.8.4-2でした。\nもししばらく古いカーネルで起動したいということであれば、以下のコマンドで古いカーネルにピン留めできます。proxmox-boot-tool kernel pin 6.5.13-5-pve\n新しいカーネルに戻す時は以下のコマンドで元に戻します。proxmox-boot-tool kernel pin 6.8.4-2-pve\n","tags":["proxmox"]},{"title":"macOSのアプリケーションファイアウォール Vallum","url":"/new-technology/2021/09/04/vallum/","content":"\n\nこの記事で実現すること\n\nmacOS(Big Sur)向けアプリケーションファイアウォールのVallumを使い、macOS標準のファイアウォールよりも高度な制御をします。自宅のWi-Fiの接続状態やVPN接続状態に応じたコントロールが可能です。\n\n\nVallumについてVallum4は、macOS Big Sur向けに作成されたアプリケーションファイアウォールです。Catalina以前のmacOSにはVallum3が提供されています。作者はイタリアの方で現在3名程度のチームでエンハンスされているようです。仕組みとしてはアプリケーション毎に外への接続要求、および受信を受け入れる要求とをそれぞれにルールを決めるタイプのものです。Vallumの価格は＄15に日本国内の消費税を加え、1,850円前後でとても安価です。\nファイアウォールは一般的に上位のルールから順に下位に順次チェックを行っていき、ルールが最初に一致したものを選択しアクセス制御をするのが一般的です。しかし、このVallumはファイアウォールルールが特徴的で、複数一致するルールを用意し、最後に一致したものが採用されるという方式です。\nVallum4から実装された機能に接続中のWi-FiのAP名でルールを機動的に変更できます。仕事用のAPと自宅用APとで制御を変えるなど、外出事の運用には非常に有用です。\n\nVallum Firewall https://vallumfirewall.com\n\nアプリケーションファイアーウォールの有用性個人向けのサイバーセキュリティ対策としてのアプリケーションファイアーウォールは難易度が高いことや、アプリケーションの信頼性評価が難しい事によって積極的に厳格な設定を勧める記事はあまり見かけません。しかし、昨今のランサムウェアなどの個人向けサイバー攻撃の脅威を考えると、アプリケーション自身に悪意はなくとも、脆弱性を悪用されるケースが懸念されます。アプリケーションの振る舞いを把握し制約を与える事は個人向けの一歩進んだセキュリティ対策と言えるでしょう。Windowsでは、Windows Defenderのセキュリティが強化されたWindows Defenderファイアウォールの設定で、受信&#x2F;送信それぞれのルール毎にIPアドレスやPortを詳細にフィルタできます。なお、セキュリティ対策ソフトに付属するアプリケーションファイアウォールはレピュテーションチェック[1]がメインであり、アプリケーションの信頼性評価によって通信の可否をコントロールする事を目的としていますので趣旨は異なります。\n一方、macOSのファイアウォールには昔からLittle Snitchという定番のソフトウェアがあります。これは非常にグラフィカルで、世界地図を見せながらどの場所からアクセスしているのか、非常にわかりやすくなっています。こちらはアプリケーションの特性からどの範囲に通信を認めるかをユーザーが厳格に決める事を目的としています。45ユーロなので6,000円弱というコストで非常に長い間多くの方に愛用されているソフトウェアです。\n\nLittle Snitch https://www.obdev.at/products/littlesnitch/index.html\n\nLittle Snitchのおかげか、macOSユーザーがアプリケーションファイアウォールに求めるレベルは高いものがあります。グラフィカルな見せ方や設定よりも、シンプルに細かい制御をしたいという事であればVallum Firewallは廉価でお勧めです。\nこの記事ではVallumを使い、以下のセキュリティ強化策を実現します。\n\nローカルネットワークへのアクセス不要なアプリケーションはアクセス要求を拒否します。\nインターネット接続先が固有ドメインなど決まっている場合はそのドメインのみ許可します。\n受信ルールとして最低限度必要なサービスのみ受信要求を許可します。\n自宅と自宅外で受信ルールを変え、外出先ではさらに受信要求を拒否します。\n\nVallumは、アプリケーションのレピュテーションをチェックする機能はありません。しかし、macOSの場合はフォルダへのアクセス権などセキュリティとプライバシーでアプリケーション毎に明確に設定可能です。またApp StoreやHomebrewを使う事で正当なアプリケーションである事に一定の信頼性が担保されています。\nVallum設定の一例（Outbound）いくつかOutbound（外に出ていく通信）のルールの例を挙げてみます。まずは翻訳ソフトのDeepLです。\n\n\nこれは翻訳するためにDeepLのサイトに接続する事だけを許可するというわかりやすい例です。そして、 Localsというのは私が作成したグループですが、IPv4、IPv6のプライベートネットワークアドレス（リンクローカル、IPv6のULAを含む）です。翻訳ソフトは自宅のネットワークのホストにアクセスする必要は無いので、プライベート宛通信をブロックしています。iOSのローカルネットワークの機能で制限を与えるのと同等の設定になります。\nルールに無いものは自動的にポップアップされ、その動作をユーザーに決めるよう促されます。\n\n\n上記の例、例えばSafariであれば、さまざまなURLへとアクセスするので、個々のサイト、ドメインに対して許可するのではなく、Safariに対してインターネットアクセス全てを認める事になるでしょう。\nVallumのセットアップまずはVallumのWebサイトに DOWNLOAD VALLUM 4という文字を見つけそこからダウンロードします。macOSのCatalina以前はVallumのVersionは3となり、この記事での説明は該当しませんのでご注意ください。Vallum4にはBig Surが必要です。2021-9-4時点の最新バージョンは、4.0.3となります。また、Homebrewでもインストール可能です。\nbrew install vallum --cask\n\n\nまず、アプリケーションのインストールが完了するとOS起動時に自動起動するように構成されます。初期セットアップでは、基本ルールをVallum Assistantによって決定します。\n\n\nルールは、Inbound、Outboundそれぞれ分かれています。\nInbound Policy①\n\n\n項目\n説明\n\n\n\nPass connections from local networks\nプライベートIP（IPv6はリンクローカル）からの接続要求を許可\n\n\nPass mDNS connections\nマルチキャストDNS(Bonjour) による名前解決の要求を受入\n\n\nBlock unsigned apps\n署名されていないアプリケーションをブロック\n\n\nBlock unsigned APPは止めたくなりますが、最初から厳しくするとトラブルの元になるので最初は外しておいた方が無難でしょうか。ファイアウォールでよくある話です。私の場合、プリンタドライバが該当しました。また、mDNSによる名前解決はWindows、Linuxでも使えるのでそれなりに便利ですが、ここは普段の利用状況で判断してください。\n\nOutbound Policy②\n\n\n項目\n説明\n\n\n\nPass root connections\nrootユーザーによる接続を許可\n\n\nPass mDNS connections\nマルチキャストDNS(Bonjour) による名前解決の要求を許可\n\n\nPass connections to local networks\nプライベートIP（IPv6はリンクローカル）への接続要求を許可\n\n\nPass connections to Apple and iCloud\nAppleのパブリックネットワークおよび関連ドメイン、iCloudへの接続要求を許可\n\n\nPass all App Store apps\nAppストアでインストールしたアプリケーションは接続要求を許可\n\n\nPass all macOS preinstall apps\nmacOSのプリインストールされたアプリケーションは接続要求を許可\n\n\nPass trusted system process\nmacOSの信頼されたシステムプロセスは接続要求を許可\n\n\nPass Safari Bookmarks\nブラウザSafariのブックマークされたURLへの接続要求を許可\n\n\nBlock unsigned apps\n署名されていないアプリケーションをブロック\n\n\nルールに該当しない場合の挙動③これらのデフォルトのルールや個別のアプリケーションで明確なルールが見つからなかった場合の挙動を選択します。\n\nRequest user authorizationユーザーに許可するかどうかをポップアップし判断を促します（デフォルト）\nBlock all inbound connections by defaultユーザーに尋ねずInboundの接続要求をブロックします\nAllow all inbound connections by defaultユーザーに尋ねずInboundの接続要求を受け入れます\nAllow all outbound connections by defaultユーザーに尋ねずOutboundの接続要求を許可します。\n\n最初はデフォルト設定で運用し、安定してきたらInboundの接続要求をブロックするなどカスタマイズされる事をお勧めします。最初から厳しくするとトラブルの元なので慣れるまでは割と緩めの設定が良いでしょう。\n初期設定の後は、常駐プロセスがアクセスする都度、しばらくポップアップのラッシュが続きます。落ち着くまではPassボタンをクリックし続けるしかありませんが、ある程度経ってから、アプリケーション毎にアクセスする形態を鑑み、サブドメイン単位の許可、Port単位の許可など調整していくのが良いでしょう。\nOutboundルールについては、数時間ルールと格闘する事にはなりますが、やがて落ち着きポップアップの頻度も減ってくる事でしょう。\nOutboundルールデフォルトのポリシーでセットアップした場合のOutboundルールを見てみましょう。VallumのアイコンからFirewall Configurationを選択し、FIREWALLS RULESのOutboundを選択します。\n\n\nOutboundのルール0にユーザーに尋ねる原則ルール（ASK）があります（これは必ず一致するルールです）。ルール1以降に一致する条件が無ければ、ルール0が選択され、”ユーザーに尋ねる”という事です。\nVallumはASKの選択の仕方にも種類があります。\n\nActionの項目でユーザーに動作を尋ねるASKがありますが、ユーザーが応答しなかった場合、さらにその挙動を明示できます。VallumのConfigurationからPreferenceボタンをクリックし、Alert画面で設定が可能です。上記のキャプチャの右側にNotification expire afterという項目があります。ここではデフォルトの30秒となっていますが、この30秒ユーザーが無応答の場合は2分だけ接続を許可する設定ができます。また、許可する場合も永遠に許可する、今日は許可するなどの設定も可能です。なお、Bg Actionという項目は、Vallumが稼働していない時の挙動を決めるものです。厳密にいえば、OS起動時にネットワーク接続した時点ではVallumはまだ起動していないでしょう。この時にルール0で許可するか拒否するかを決めます。Vallumが起動していなければルール1以降の判断は不可能で通信を許可するかしないかのいずれかです。特にOutboundのBg ActionをBlockにすると、DHCPのIP配布に必要な通信も行えない事で、Wi-Fiが接続完了にならない事、自動起動するアプリが軒並み通信リトライとなり、大幅にOSの起動完了が遅れますのでBlockする事はお勧めしません。\n初期セットアップで自動作成されたルール1は、最初から用意されたグループlocal-nets、これはプライベートIPネットワークアドレスからUDP&#x2F;67のDHCPのリクエストがあります。ここのルールにはquickという記述がされています。このquickはVallum独特の考え方で、これ以降のルールチェックは行わないというものです。Vallumは最後に有効となったルールが選択されるという原則がありますが、quickが付いたルールの場合はそれ以降のチェックは行いません。DHCPのやりとりでIPアドレスの配布が受けられないと何も始められません。\n続いてルール2はUDP&#x2F;53のDNSリクエスト、UDP&#x2F;5353のmDNS(Bonjour)リクエストです。こちらもquick付きで許可されています。\nルール3は信頼されたシステムプロセスが許可されています。これはquickがついていないので、この後ろに拒否ルールを加える事である条件でリクエストを拒否できます。\nサブドメインで許可するここからは、個別のアプリケーションの通信毎にポップアップされる都度、許可する事でルールが追加されていきます。ユーザーにアクションが求められた場合、IPアドレスで許可する、サブドメインで許可する、このアプリケーションは全て許可するなどの設定が行えます。翻訳ソフトや画像編集ソフトなど、インターネット接続先が固定的になるものはできるだけサブドメインで許可するとメンテナンスが簡単になります。\nローカルネットワークへのアクセスを拒否する前述の翻訳ソフトのDeepLなど、ローカルネットへのアクセスが不要な場合は、手動でlocal-netsに対するアクセス拒否を加えます。ちなみに、DeepLに限らず大半のアプリケーションは、ネット接続するためにDNSによる名前解決が必須です。DeepLが自宅内（ローカルネット）のDNSにリクエストする際は、1つ前の章で説明したルール2のDNSリクエストが該当します。ルール2はquickオプションがついているため、どんなアプリケーションもDNSへの名前解決は拒否されない仕組みです。よく考えられているなと感心します。\nOutboundルールの工夫アプリケーションには、写真編集やフローチャート作成などネットアクセスを必要としない種類がありますが、バージョンアップの目的でインターネットにアクセスする場合があります。こういったケースでアクセスするドメインを絞る事ができます。またアプリケーションのバージョンアップはApp StoreまたはHomebrew任せにしているのであればアプリケーション単体のバージョンアップチェックも拒否できます。\nウィルス対策ソフトなどによるURLチェックなど、信頼するしかないという場合などはベンダー指定で許可できますのでルールもシンプルになります。\nInboundのルールInboundルールは、Outboundに比べると多少設定はやや難しいのですが、自宅か外出先で制御を変えられるのが魅力です。Inboundは他の端末からどのようにアクセスされているのかわかりづらいため、ログファイルを活用して検証する必要があります。\nデフォルトのポリシーでセットアップした場合のInboundルールを見てみましょう。VallumのアイコンからファイアウォールConfigurationを選択し、FIREWALLS RULESのInboundを選択します。\n\n\n\nルール0Outbound同様に原則ルール（ASK）があります。\nルール1ダイナミック&#x2F;プライベートPortを許可します。これはIANAによって明示された範囲外のPortでユーザーが自由に使えます。アプリケーションがサーバーPortを任意のタイミングで開く場合があるので明確に不要と判断できるまでは削除しないほうが良いでしょう。ダイナミック&#x2F;プライベートPortに関する説明はJPNICのWebサイトを参照してください。\nルール2 DHCPサーバーからの受信\nルール3 mDNS(Bonjour)の受信（名前解決の要求）\nルール4 IPv6のicmpIPv6のicmpはIPv4とは異なり、通信に必須のものなので止める事はできません。\n\n\nJPNIC -ポート番号とは- https://www.nic.ad.jp/ja/basics/terms/port-number.html\n\nなお、IPv6でDHCPv6を使っていらっしゃる方は、UDP&#x2F;546も手動で加える必要があります。\nmacOSのアプリケーションファイアウォールの設定まずはmacOSのファイアウォールを有効にし、ファイアウォールオプションから必要なアプリケーションを許可します。\n\n\n外部からの接続をすべてブロックのチェックを外します。チェックされていると印刷できない、またはファイル共有できない場合があります。ここでは一般的に良く利用されるAirDropを例に許可していきます。以下のようにsharingdを許可します。内蔵ソフトウェアが外部からの接続を受け入れるのを自動的に許可にチェックしておく事で、macOSのファイアウォールで細かくアプリケーション毎に設定する必要がなくなり、Vallumに集約してコントロールできます。\n\nアクセス要求の受け入れmacOS自身がサーバーPortをクライアントからの接続要求を受け入れる場合、macOS自身のアプリケーションからの接続要求についてはフックできません。アプリケーションがPortをオープンし、そのPortに外部のクライアントが接続しようとしたところでVallumは検出し、許可&#x2F;拒否をユーザーに尋ねます。\n\n\nログの確認外部のクライアントから接続の際、ログを確認しながらルールを検証します。アクセスが来ていないのか、Vallumで拒否されているのか、はたまたmacOSのファイアウォールで拒否されているのかを切り分けします。\nコンソールを開きます。\n\n\n次にVallumのログをフィルタし、フィルタ条件を保存します。\n\n\n\nコンソールの右上の検索窓で”flow”と入力し、Enterキーを押します。\n検索窓のプルダウン”いずれか”をクリックし、”カテゴリ”を選択します。\nこれでVallumのログが絞り込まれます。\n最後に保存ボタンをクリックし、”Vallum log”など名前を付けて条件を保存します。\nログを出力するにはコンソール上で開始ボタンをクリックします。\n\n接続を受け入れる実際にAirDropの例でやってみます。スマホからmacOSにAirDropすると、Vallumはsharingdについてポップアップします。AirDropと表示されており分かりやすいですね。ちなみに、Firewall ConfigurationのServices and PortsでPort名称のカスタマイズができます。NetBIOS(137-139)やSMBの445などは”File Sharing”となっていますので、気になる人は変更してください。\n\n\n許可、Passする際、Logを出力するようにチェックボックスにチェックを入れてください。これでコンソールを起動しログ出力させておけば、AirDropされる度にコンソールへログが出力されます。\n\n\nAirDropは、IPv6のリンクローカルアドレスで通信しているようですね。これだとどの端末からアクセスされたのかはわかりづらいですが。。。\n自宅Wi-Fi&#x2F;有線LAN&#x2F;VPNと外出時の制御いよいよVallumの高度な設定に取り組みます。ここでは、自宅Wi-Fiに接続しているor有線LANに接続しているor自宅へのVPNに接続しているという条件でAirDropを許可し、それ以外の状態、自宅外のAPに接続している場合はAirDropを許可しないというものです。大まかなルールは以下のように記述します。\n\nAirDropなど個々のアプリケーションで受信を許可\n条件として、自宅Wi-FiまたはLANの物理インタフェースがActiveでない場合は、全てのアプリケーションを拒否\nVPNのインタフェースがActiveの場合、AirDropなど個々のアプリケーションで受信を許可\n\n1と3が重複感がありますが、VPNが入った場合の条件が複雑で今のVallumではこのような設定になります。2については、個々のルールで”quick”と指定したDHCPやDNSなどのネットワーク系通信以外は1で許可したものが2の条件（外出中）で全て拒否される事になります。それで3で外出中であってもVPNが有効な場合は再び許可する事になります。\n2の条件はINBOUND RULEの一覧を右クリックしADD New Ruleを選択します。\n\n\nさらに、Advancedをクリックします。\n\n\n\nLogの出力をチェックします。\nConditionのタブをクリックし、Not Connected to hotspotsの項目に自宅のWi-Fiのアクセスポイント名を入力します。\n有線接続時の条件のために、Interfaces are not activeにインタフェース名を入力します。有線接続し、ifconfigで実際にIPが割り当てられているインタフェースの名前を入力します。私の場合はLANはen5でした。\n\nこの設定を加える事で自宅外の接続ではAirDropはできなくなります。\n簡単にテストするために、Wi-Fi接続からiPhoneなどへのテザリングに切り替え、そこでiPhoneからmacOSにAirDropすると以下のログがコンソールに出力されます。\nLog: 🔴 block ⬇️ Rule:18 sharingd PID:445 UID:501 from fe80::xxxx:xxxx:xxxx:xxxx:50392 to fe80::xxxx:xxxx:xxxx:xxxx:8770\n\n一旦は許可したAirDropが再び拒否されるようになりました。テザリングを停止し自宅Wi-Fiに戻した際にはこのログは出力されず、再びAirDropできるはずです。\nさて、最後にVPNです。\n\nAirDropを許可したルールを複製します。\n\n\n\n\n複製したルールを選択、ドラッグし自宅外はDropするルールの下に移動します。\n\n\n\n\nこのルールをVPN接続中のみ有効にします。\n\n\n\nルールのAdvancedを選び、Logの出力をチェック、Interface is activeにVPNのインタフェース名を入力します。これもVPN接続時にifconfigでインタフェース名を確認できます。\nいよいよテストです。macOSをiPhoneへテザリング接続し、さらにVPNに接続します。iPhoneからmacOSにAirDropが行え、ログに以下の通り出力される事が確認できます。\nLog: 🟢 pass ⬇️ Rule:19 sharingd PID:445 UID:501 from fe80::xxxx:xxxx:xxxx:xxxx:60433 to fe80::xxxx:xxxx:xxxx:xxxx:8770\n ログは上記のように最後に選択されたルールのみが出力されます。\nNetBIOSやmDNSの拒否など外出中には基本は拒否設定としつつ、VPN接続中には一部のサービスを生かすという使い方ができます。\n設定ファイルの保存ルールはファイルに保存できます。Firewall ConfigurationからImport / Exportボタンをクリックし、Exportを選んでください。初期設定のRun Assistantを選ぶと既存ルールが全てクリアされます。定期的にバックアップをお勧めします。\nなお、Vallum4に関するオンラインヘルプが用意されています。\n\nVallum 4 Help https://help.vallumfirewall.com/index.php?chapter=introduction\n\nその他機能Flows MonitorFlows Monitorを選択すると、現在通信しているプロセスの一覧が参照できます。\n帯域制限ツール　SnailVallumには、アプリケーション毎に帯域制限できるツール、Snailのライセンスが付属します。Snailは別途インストールする必要があり、Homebrewには登録されていません。詳細は以下を参照してください。\n\nhttps://www.murusfirewall.com/snail/\n\n[1]レピュテーションチェック　アプリケーションの信頼性を第三者となる企業によって評価したもの。セキュリティベンダーなどが独自の尺度でアプリケーションを評価したりアプリケーションの振る舞いによって安全か不審かを評価するもの。\n","categories":["Security"]},{"title":"XG Firewall VPNにスマホから接続する","url":"/new-technology/2020/03/31/vpn-iphone/","content":"この記事で実現すること\nスマホ（iPhone、Android）からXG FirewallのVPNに接続できます。2要素認証の設定も可能です。\n\n\n\n事前準備前回の記事でPC（WindowsおよびmacOS）からXGのVPN（Sophos Connect）に2要素認証で安全に接続できるようになりました。ここでは、スマホからVPNへ接続できるように設定していきます。この記事では、XG側に一通りVPNの設定が終わっている事を前提としています。以下の記事を参考にしてください。\n\nXG Firewall VPNについて\nXG Firewall VPNに2要素認証を設定する\n\n前提条件は以下の通りです。なお、この記事では、ワンタイムパスワードを必ず必須とはしていません。PCとは異なり、移動しながら使うスマホは毎回ワンタイムパスワードを入力するのでは利便性に欠けます。ここは利便性とセキュリティの安全面を比較し判断という事になります。\n\nXGにVPN(Sophos Connect)の設定を終えている\nXGの外側（インターネット側）にホームゲートウェイがあり、ホームゲートウェイからXGに対し必要なVPNのパケットを転送出来ている\n\niOS(iPhone)、AndroidのVPN設定iOSの設定LAN環境にて、XGのユーザーポータルhttps://XGのIPアドレス/に接続します。ユーザーポータルには、前回までに作成したVPNユーザーでログインします。ポータルのログイン後には、以下の画面のように、iPhone（iOS）のIPSec VPNに必要な設定ファイルをダウンロードできるようになっています。\n\n\nダウンロードした設定ファイルは一部修正が必要ですので、PCでダウンロードしファイルを修正の後、iOSにインストールする事をお勧めします。\n\n\nファイルをダウンロードしたらメモ帳やテキストエディットなどで設定ファイルを開きます。以下はファイルの先頭からの抜粋ですが、11行目にXGのWAN側のIPアドレスが記載されている行があります。内容は以下の通りです。\n&lt;plist version=&quot;1.0&quot;&gt;&lt;dict&gt;        &lt;key&gt;PayloadContent&lt;/key&gt;        &lt;array&gt;                &lt;dict&gt;                        &lt;key&gt;IPSec&lt;/key&gt;                        &lt;dict&gt;                                &lt;key&gt;AuthenticationMethod&lt;/key&gt;                                &lt;string&gt;SharedSecret&lt;/string&gt;                                &lt;key&gt;RemoteAddress&lt;/key&gt;                                &lt;string&gt;192.168.x.x&lt;/string&gt;\n\n上記のIPアドレスをXGで設定してあるダイナミックDNSのホスト名に書き換えます（Sophos社が提供しているダイナミックDNSであれば、xxxx.myfirewall.coです）。その後、ファイルを保存し、iCloudまたはメールなどでiPhoneに転送し、iPhoneから設定ファイルをインストールします。macOSだとFinderからファイルを選んでAirDropでiPhoneに送信すると簡単ですね。iPhoneではプロファイルのインストール時には、最初にiPhoneのパスワードを求められますのでiPhoneのパスワードを入力します。次にXGの接続ユーザーのパスワードを求められますが、ここはワンタイムパスワードの有無で設定が異なります。前回の記事ではワンタイムパスワードが必要なユーザーを作成しましたが、ワンタイムパスワードが不要であれば、ワンタイムパスワードを使わないユーザーを改めて作成してください。\n以下の場合は、XGの接続ユーザーのパスワードを入力します。\n\nワンタイムパスワードは利用しない\niPhoneにパスワードを記憶させたい\n\n以下の場合は、パスワードを入力せずプロファイルのインストールを完了させます。\n\nワンタイムパスワードを利用する\niPhoneにパスワードを記憶させたくない\n\n（2021-4-7更新）v18 MR-4での不具合についてv18 MR-4では不具合により、上記設定ファイルがダウンロードできない状況でした。このケースに遭遇した場合はVPNのプロファイルを使わずに手動設定できます。なお、v18 MR-5ではこの不具合は解消されています。\n\niOSの設定からVPNを選択します\nVPN構成を追加...をタップします\n以下のパラメータを入力し、完了をタップします。\n\n\n\n\n説明\n内容\n\n\n\nタイプ\nIPSecを選択します\n\n\nサーバー\nxxx.myfirewall.coなどのダイナミックDNSのホスト名を入力します\n\n\nアカウント\nVPNで接続するユーザーIDを入力します\n\n\nシークレット\nXGで設定した共有鍵を入力します\n\n\niOS(iPhone)からVPNに接続iPhoneの設定アプリからVPNを選択、XGの接続先が選択されている状態で状況のトグルスイッチをオンにします。パスワードが設定済みの方は短い時間でXGへの接続が完了します。ワンタイムパスワードを設定している方、或いはパスワードを記憶させていない方は、パスワード入力のポップアップが表示されます。ワンタイムパスワードは、パスワードのあと続けてワンタイムパスワードの6つの数字を続けて入力します。一旦ポップアップが表示されると他のアプリに切り替えられないので一旦キャンセルします。ワンタイムパスワードアプリで6桁の数字を記憶するかコピーするなどし、最大30秒以内で設定アプリに再度切り替え、VPNのパスワードを完成させ接続する事になります。\nAndroidの設定AndroidからVPNに接続する場合は、以下の設定を行います。今回の実例はAndroidのバージョン9のタブレットで説明します。機種によって操作は異なるかとおもいますが、ご容赦ください。無線とネットワーク→VPN→VPNネットワークの追加をタップします。\n\n\n\n説明\n内容\n\n\n\n名前\n接続名を入力します\n\n\nタイプ\nIPSec Xauth PSKを選択します\n\n\nサーバー\nxxx.myfirewall.coなどのダイナミックDNSのホスト名を入力します\n\n\nIPSec ID\n空白のままで構いません\n\n\nIPSec事前共有鍵\nXGで設定した共有鍵を入力します\n\n\n\n\nAndroidからVPNに接続設定から無線とネットワークに進みVPNを選択し、ユーザーIDとパスワードを入力し接続します。ワンタイムパスワードを利用する場合は、パスワードの後ろにワンタイムパスワード（6桁の数字）を続けて入力します。\n\nAndroidに関しては1点、注意点があります。Androidは、SSLインスペクションについて、Chromeブラウザ以外のアプリからは使えない前提があります。そこで、Android専用のVPNユーザーを作成しSSLインスペクションの対象からAndroidユーザーを除外するなどの設定が必要となります。\n2要素認証の有無による使い分け私はVPN接続ユーザーを2つ有効にしています。2要素認証が必要なユーザーはLANへのアクセスを許可するもの、2要素認証を不要としているユーザーはLANおよびHGWのセグメントへのアクセスを不許可とするルールを作成しています。またVPNからXGの管理画面には接続できないようにもしています。\n","categories":["Security","VPN","ワンタイムパスワード"],"tags":["XG Firewall"]},{"title":"XG Firewall VPNについて","url":"/new-technology/2020/03/28/vpn/","content":"この記事で実現すること\n外出先から、PC（Windows、macOS）を使い、宅内にあるXG FirewallのIPSecを使ったVPNへ接続できます。ウィルス・マルウェア対策、Webフィルタなど安全なネット閲覧や、宅内のLANリソースへリモートアクセスができます。\n\n\n\nXG FirewallのVPNXGのVPNはプロトコルが何種類かあります。一般的なSSL-VPN,L2TP,PPTP、そしてSophosConnectというIPSecベースのものがあります。IPSecは一般的に安全性が高く、安定しているため、ここではIPSecのVPN導入について説明します。なお、この記事ではXG（VPNサーバ）側の設定およびPC（クライアント）に関する設定について記載しますが、最終的にはスマホ対応、2要素認証まで設定する事を目標にします。\nXGにおけるIPSec-VPNはIPv4のみ対応しています。プロバイダとの接続形態がDS-Liteおよびv6プラスの場合、NATまたは利用ポート制限のため、IPSecによるVPNは利用できません。v6プラスの場合、SSL-VPNを利用する事で利用できる見込みがあります。XGにおけるSSL-VPNについては、「XG Firewall SSL-VPN」を参照してください。\n\n\nIPSec VPNについてIPSec VPNの設定にあたり、インターネットに接続されているホームゲートウェイから、VPNのパケットについては内部のXGのWANインターフェースに転送しなくてはなりません。一般的に市販されているルーターにも装備されていますが、この方法には2通りあります。\n\n全ての宅内へのトラフィックは全てXGに転送する ルーターやホームゲートウェイの製品によって呼び方は異なりますが、DMZホスト機能などと呼ばれます。この場合はインターネットから入ってくるデータは全てXGに送られますので、宅内にサーバーを立てる場合、ホームゲートウェイからはXG以外の端末は接続出来なくなります。ただし、設定は単純というメリットがあります。\n\n \n\n\nIPSecに必要なプロトコルおよび通信PortのみXGに転送する こちらは一般的にポートマッピングと呼ばれます。内→外、外→内の方向について細かく設定します。IPSecに必要なプロトコルとPortは外→内で以下の通信になります。\n\n\nESPプロトコル（プロトコル番号：50）\nUDP 500,UDP 4500\n\n \n\nプロバイダが上記ポートを通せること、また、上記の2つのいずれか対応できれば、XGに対するIPSec-VPN接続が行えます。この画面はホームゲートウェイの画面であり、契約しているインターネット回線業者により、提供される機器は異なりますのであくまで設定例は参考となります。\nXG側のVPNユーザー作成最初にユーザーの作成が必要です。VPNの最終接続形態としては、2要素認証対応のセキュアなものを目指します。ただし、いきなり全ての事を実施すると切り分けが難しいのでまずは2要素認証無しでの接続をし、次に2要素認証有りの接続に取り組みます。XGの左ペインメニューから認証を選択、ユーザーのタブから、追加ボタンをクリックします。そして以下のようにユーザー名、パスワードとメールアドレスを入力します。\n\n\n\n他はグループのところで、OPEN Groupを選択するくらいで設定するところはありません。このまま保存をクリックします。VPNは、このユーザー名&#x2F;パスワードで接続する事になります。\nXG側のIPSec-VPNの設定XGの左ペインメニューからVPNを選択、Sophos Connectのタブを選択します。特に拘りがなければ、デジタル証明書ではなく、事前共有鍵を選択する事にしましょう。それなりの鍵の長さを設定しておけば安全です。また最終的にはワンタイムパスワードを設定する事でかなりの安心感が得られます。鍵はパスワードと異なり、一度クライアントに設定すれば接続の都度入力する必要もないため、複雑で長い鍵長の事前共有鍵の設定が好ましいでしょう。設定は以下の通りに行います。\n\nインターフェースはPort2(WAN)を選択します\n認証タイプは事前共有鍵を選択します\n事前共有鍵は文字列を入力、また繰り返し同じ鍵を入力します\n許可されたユーザーには、上記で作成したユーザーを選択します\n\n\n\n\n名前はXGの配置場所として適当な名前を入力します\nXGのVPNの割り当てネットワークは、LANとは別のネットワークアドレスを入力します。例えばLANが192.168.2.0/24のネットワークならば、192.168.20.1〜192.168.20.8などと別のネットワークを入力します\nDNSについては、XG自身のDNS（XGのLAN側のIPアドレス）を入力します\n詳細設定のトンネルがアイドルの時に切断を有効にします\nアイドルセッション時間の間隔は600にします（ご自身で希望の値を設定してください）\n\n\n\n適用ボタンをクリックすると、”これにより、同じローカルピアとリモートピア間で設定したすべての接続の事前共有鍵が更新されます。続行してもよいですか？”と表示されます。OKをクリックすれば、VPNが有効になります。\nXG側のFirewallルールの確認上記で設定したVPNがFirewallのルールに登録されている事を確認します。VPNとWANの接続を優先に考え設定します。「XG Firewall v18のルールを作成する」では、デフォルトのルール”To_Internet”を作成しました。ルールについて、以下の図のように送信元ゾーンが、LANとVPNとなっている事を確認してください。\n\n\n続いて、VPNからLANへのルールを作成します。NATは使わず全てのトラフィックを通過させるものです。以下の通り、送信元ゾーンはVPN、宛先ゾーンはLANのルールを設定します。\n\n\n（2020-06-20更新）このルールでは、リンクNATルールの作成は行いません。NATの動作の確認のために「NATしない事を明示する」設定を行うと挙動がわかりやすいというメリットはありますが、v18では原則リンクNATは使わず運用可能という考え方のようで当初記載していたリンクNATの記述を削除しました。\nさらにルールで保存をクリックしてルールの設定は完成です。念のため現在のルールについて確認しましょう。Traffic to Internalとして、VPNからLANへの接続ルールがあります。もう1つは、Traffice to WANとして、VPNおよびLANからWANへの接続ルールがあります。\n\n\nXG側のDynamic DNSの設定自宅のXGに接続するためには自宅に割り当てられたIPアドレスをあらかじめ知る必要がありますので、ここでダイナミックDNS（DDNS）が必要となります。\n(2021-8-15更新）Sophosが提供するDDNSであるmyfirewall.coについては2022年1月末をもってサービス提供終了となります。またXG v18.5では既にmyfirewall.coを選択できなくなっています。XGが対応しているDDNSは以下の通りです。もちろん、このDDNSでなくとも、NASをお持ちの方であればNASが提供しているDDNSを利用できます。\n\nDynDNS\nZoneEdit\nEasyDNS\nDynAccess\nNo-IP\nDNS-O-Matic\nGoogle DNS\nNamecheap\nFreeDNS\n\nIPv4アドレスの箇所は、NATされたパブリックIPを選んでください。\n\n\n\n登録が終わると、直ちにグローバルIPがダイナミックDNSに登録されます。その後、前回更新したIPにグローバルIPが表示され、前回更新した状態にSuccessと表示されます。\n\n\nXG側のデバイスのアクセス設定XG側はこれが最後の設定です。左ペインの管理から、デバイスのアクセスへと進みます。そこに、LAN、WAN、VPN毎にサービスのアクセス権限が定めている一覧になります。ここでは以下の項目のアクセス権を加えます。\n\n管理サービス　HTTPS&#x2F;SSH XGの管理メニューにVPN経由でアクセスする事を可能とします。\nPing&#x2F;Ping6 こちらの設定は任意です。\nDNS LANおよびVPNからのアクセスはXGのDNSをまず最初に参照します。LANにあるホストを参照する時は、XGのDNSがプライベートIPを返すように、スタティックのプライベートIPをDNSに登録しておきたいためです。これは後々サーバーを宅内に立てる場合、活用する事になります。\n\nクライアントのダウンロードWindowsでVPN接続するためにはVPNクライアントをダウンロードします。上記のXGのVPN設定画面でSophos Connectクライアントのダウンロードというボタンがありました。そちらをクリックし、ソフトウェアをダウンロードします。こちらは、Windows版、macOS版のダウンロードが出来ます。\nXG v18 MR-3以前の設定ファイルこの画面の接続のエクスポートボタンをクリックし、接続設定ファイルをダウンロードしてください（拡張子tgb）。\nXG v18 MR-4以降の設定ファイルXG v18 MR-4以降はIPSecの接続に関する詳細設定がXG本体で行えるようになりました。設定画面は以下の通りです。\n\n\n\nVPNを張る場合、クライアントからの全ての通信を原則XGを経由するため、デフォルトのゲートウェイとして使用を”On”にします。\nユーザー、パスワードの保存を許可をチェックします。\n2要素認証を使う場合は「2FAトークンの入力を求める」にチェックしますが、2要素認証の事前セットアップが必要であるため、この段階では一旦外しておきましょう。\n\n上記設定し、接続のエクスポートボタンをクリックし、接続設定ファイルをダウンロードしてください（拡張子tar.gz）。このなかにさらに拡張子scxというファイルがありそれを使います。\nクライアントのセットアップクライアントへのセットアップは、Windowsの場合は、SophosConnect.msiをインストールします。macOSの場合は、SophosConnect.pkgをインストールします。プログラム実行後、右上のメニューから、Import Connectionをクリックし、先ほどダウンロードした接続設定ファイル（拡張子scx）を読み込んでください。\nもし、DDNSを上記のDDNS提供業者ではなく、別のものを用意するものに変更するのであれば、scxファイルのddns名の箇所を任意のホスト名に修正できます。以下のように、”gateway”で始まる行にホスト名またはIPアドレスが記述されているので、この行を目的のホスト名に変更します。\n&quot;gateway&quot; : &quot;xxxx.myfirewall.co&quot;,\n\n→\n&quot;gateway&quot; : &quot;xxxx.myhost.domain&quot;,\n\n\n\nVPNの接続確認Connectをクリックし、VPN用に設定したユーザー名とパスワードでインターネットから、宅内のXGに接続します。\n\n\n\n\nVPN経由でインターネットに接続し、ブラウザからアクセスできること、IPアドレスがプロバイダから貸与されたアドレスになっているか確認します。また、LANの機器との接続が行える事も確認してください。接続業者によっては、IPSecで利用するESP,UDPプロトコルを通さないところもあります。\nなお、ここまで説明してきた通り、LANとVPNのネットワークセグメントは異なりますので、ブロードキャストで相手を見つけるようなアプリケーションはVPNからLANに対する接続は行えません。\n公衆回線経由でXGにIPSecで接続できたら、続いて2要素認証の設定に続きます。「XG Firewall VPNに2要素認証を設定する」を参照してください。\nSSL&#x2F;TLSインスペクションの設定（任意設定）ここまでの設定でVPNの設定は終了ですが、VPNについてもSSL&#x2F;TLSインスペクションが有効となるように設定をお勧めします。一旦はVPNのネットワークからインターネットにアクセスする場合は、全てがSSL&#x2F;TLSインスペクションの対象とし、ファイアウォールルールを修正します。\n\n最初にVPNのネットワークアドレスを左ペインのホストとサービスからIPホストを登録します。\n\n上記のようにネットワークにIPアドレス（この記事では192.168.20.0&#x2F;24としています）を登録します。VPNのネットワークは、LANのネットワークとは別のネットワークアドレスとする必要があります。\n\n次に、左ペインのルールとポリシーから、SSL/TLSインスペクションを選択します。\n\n事前に作成してあるCatch SSLルールを選択し、ここにVPNのネットワークがSSL&#x2F;TLSインスペクションの対象である事を設定します。\n\n上記の図では送信元ネットワークとデバイスに、CAがインストールされているPCおよびiPhoneを対象とするIPグループをCA_Clinet_IPv4として登録していました。これに今回はVPNのネットワークVPN_Network_IPv4を追加登録します。\n\n\nここまでの設定でIPSec-VPNの設定は一段落です。SSL&#x2F;TLSインスペクションの設定および動作確認については、下記の記事を参照して下さい。\n\nSSLインスペクションについて\nXG Firewall v18のSSL&#x2F;TLSインスペクションの設定\nXG Firewall v18のSSLインスペクションの動作確認と調整\n\n","categories":["Security","VPN"],"tags":["XG Firewall"]},{"title":"XG Firewall VPNに2要素認証を設定する","url":"/new-technology/2020/03/28/vpnotp/","content":"この記事で実現すること\nPC（Windows、macOS）からXG FirewallのIPSec VPNへ接続しているユーザーに、ワンタイムパスワードによる2要素認証機能を追加し、セキュリティを高められます。\n\n\n\nXGが提供するVPNの2要素認証XGのVPNにおいて、SSL-VPNとIPSecはワンタイムパスワードが設定できます。サイバー攻撃の脅威がますます大きくなる今日においては、VPNの多要素認証は必須条件ではないでしょうか。\nワンタイムパスワードアプリワンタイムパスワードについては、定番のGoogleのオーセンティケーターが有名です。GoogleのオーセンティケーターはXGが表示するワンタイムパスワードのQRコードが読み込めません。Sophosからは、以下のスマホアプリが提供されています。\n\nSophos Intercept X for Mobile(iOS) https://apps.apple.com/jp/app/sophos-intercept-x-for-mobile/id1086924662Sophos Intercept X for Mobile(Android) https://play.google.com/store/apps/details?id=com.sophos.smsec\n\nなお、私は複数の端末でワンタイムパスワードの同期ができるAuthyを利用しています。\n\nAuthy https://apps.apple.com/jp/app/authy/id494168017\n\nワンタイムパスワードの基本設定XGにおけるワンタイムパスワードの設定は、左ペインの認証からワンタイムパスワードへと進んでください。設定ボタンをクリックし、以下の項目を設定します。\n\n\n\nワンタイムパスワードのトグルをオンにします\n全ユーザーのOTPのトグルはオフにします\nユーザーのOTPトークンを自動生成のトグルはオンにします\n以下のユーザーとグループにOTPが必要のリストボックスからは、Open Groupを選択します\n以下について、OTPを有効化は、ユーザーポータル、IPSecリモートアクセスにチェックします\n最後に適用ボタンをクリックします\n\nワンタイムパスワードの自動生成続いて、ユーザーポータルという画面にログインします。これは管理者向けではなく、ユーザー向けに提供されているものです。XGの管理者メニューは、デフォルトでは、https://XGのIPアドレス:4444/になっていますが、https://XGのIPアドレス/に接続するとユーザーポータル画面が開きます。XGの管理画面の管理メニュー→管理者とユーザーの設定メニューでユーザーポータルのHTTPSポートが確認できます。\nユーザーポータル画面では、VPN向けに作成したユーザーとパスワードでログインします。すると、次にワンタイムパスワードのトークンが自動生成され、QRコードが表示されます。\n\n\nここで、ワンタイムパスワードのアプリでQRコードを読み込み、アプリにトークンを取り込んでください。完了後、XGのメニューでログインに進むをクリックすると、再びログイン画面になります。ここではユーザーはそのまま入力、パスワードの部分は、パスワード＋ワンタイムパスワードの数字6桁を続けて入力します。ユーザーポータルにログインできれば、ワンタイムパスワードは正しくアプリに取り込まれています。\n再び、XGの管理画面にadminでログインします。左ペインの認証からワンタイムパスワードに進むと、シークレットが生成されている事がわかります。\n\n\nこれで、IPsecVPNにはワンタイムパスワードが必須となりました。以前作成したSophosConnectクライアントの接続設定ファイルについて、再設定が必要になります。「XG Firewall VPNについて」ではVPNのセットアップを行い、クライアントソフトウェアをダウンロードしましたが、2要素認証の設定を加える必要があります。\nXG v18 MR-3以前の設定ファイルscadminツールで設定ファイルを作成こちらは少し古い方法です。v18MR-3以前の場合は、SophosConnectクライアントではなく、もう1つの設定ファイル作成ツールである、scadminツールをWindowsにインストールします。このアプリケーションはmacOS版がありませんので、Windowsで設定ファイルを作成する事になります。出力された設定ファイルは、Windows、mac共に共通で利用出来ますので、それをSophosConnectクライアントに取り込みます。scadmin.msiをインストールし起動します。OPENボタンを押して、以前に生成された接続設定ファイル（拡張子tgb）ファイルを開きます。\n\n\n設定はAllow Password Savingと、Prompt for 2FAのトグルスイッチをOnにするのみです。そして、右下のSaveで保存してください。今回はファイルの拡張子は、scxとなっています。最後に、Sophos Connect Clientより、再度作成した設定ファイル（scx）を読み込み完了です。IDとパスワードに加え、ワンタイムパスワードをセットし接続できる事を確認してください。\nXG v18 MR-4以降の設定ファイルMR-4以降の場合は、XG管理画面のVPN→IPSecで詳細設定が可能ですので、ユーザーに2FAトークンの入力を求める をチェックし、2要素認証を有効に設定します。その後、設定ファイル（tar.gz）をダウンロード、その中にある拡張子scxの設定ファイルをSophosConnectクライアントに取り込みます。\n\n\n接続SophosConnectクライアントから接続します。ユーザー、パスワードを保存しておくと、次回からはワンタイムパスワードのみを入力すれば接続可能となります。\n\n\nこれまでの設定で、外出先から2要素認証による堅牢な環境でLANの機器にアクセスしたり、安全なWebブラウジングができるようになりました。\n","categories":["Security","VPN","ワンタイムパスワード"],"tags":["XG Firewall"]},{"title":"XG FirewallのWebとアプリケーションフィルタについて","url":"/new-technology/2020/05/06/web-application-filter/","content":"この記事で実現すること\nXG FirewallのWebフィルタ・アプリケーションフィルタについて、活用方法を説明します。\n\n\n\nWebフィルタについてXGの左ペインメニューでは、Web、アプリケーションとそれぞれ分かれています。Webではサイトのカテゴリが分かれていて、そのサイトのカテゴリによっては閲覧を制限する事が一般的な使い方です。これらのポリシーは、「Sophos XG Firewall: Web カテゴリ」の記事にも日本語の解説があります。サイトのカテゴリについては、ビジネス、ギャンブル、ゲーム、アダルト、ファイナンス等多岐に渡ります。ホームユーザーとしてはいわゆる怪しいサイトや過度な広告をフィルタする事が主目的になります。しかし、上記サイトのポリシーを眺めていると疑問に感じるところがあります。”ActiveX”、”Applets”、”SpamURLs”です。ActiveXやAppletは単純にサーバー名とも関係ありません。サイトのカテゴリに加え、URLまでを対象としているようです。Web カテゴリについては、以下のの記事を参照してください。\n\nhttps://community.sophos.com/kb/ja-jp/134155\n\n上記のWebカテゴリには記載がないものの、XGの左ペインメニューのWebのファイルタイプの内容には、ファイル拡張子やMIMEヘッダーの情報が並びます。そしてここにはZIPファイルなどの”Compressed Files”、Windowsの実行ファイルである”Executable File”などの項目が並んでいます。\nホームユーザーとしては、ZIPファイルやEXEファイルが使えないと不便なのでフィルタする事は考えにくいですが、何らかのMIMEタイプを拒否するポリシーを作成する場合は有効に機能しそうです。最終的には、Webフィルタは以下の種類の分類となります。\n\nWebカテゴリ\nURLグループ（自身で作成したURLの集まり）、280blockerなどのURLデータベースもこのグループ\nファイルタイプ\nダイナミックカテゴリ（ActiveX・Applets・Cookies・HTTP Upload）\n\nこれらの事から、Webフィルタはカテゴリの分類という主目的はあるものの、ブラウザを対象としたフィルタの機能である事がわかります。\nSNIとフィルタとの関係SNIとは、Server Name Indicationの略です。SSL&#x2F;TLS通信において、クライアントからサーバ証明書を要求する時にサーバ名（SNI）を暗号化せずサーバーに渡します。XGはこのSNIを見てWebフィルタを行っていますので、接続しようとしているドメインやサーバー単位にアクセス許可・不許可の判断が可能になります。しかしフォルダ構成やMIMEタイプ、引数やダウンロードするデータを検査するには、SSLインスペクションが必要です。もちろん、ドメイン単位の制御でIoT機器はある程度の防御が可能と言えますが、防御を最大限に高めるにはSSLインスペクションが必要です。「XG Firewall v18のSSLインスペクションの動作確認と調整 」で記載した通り、ZIP化されたマルウェアはSSLインスペクションが行えなければ検知は出来ません。\nアプリケーションフィルタについてXGのアプリケーションフィルタは、XGの左ペインメニューのアプリケーションから確認できます。ブラウザーではないインターネットに接続するアプリケーションを対象にしています。ここの挙動の確認は非常に難しいものがあります。例えば、MicrosoftのOneDriveを題材にテストしてみましょう。SSLインスペクションが行えるWindows端末とSSLインスペクションが行えないAndroid端末を用いて検証します。\nOneDriveのURLは、現時点で、https://onedrive.live.com/です。Webフィルタで当該ドメインのフィルタを行うと、想定通りブラウザーからOneDriveにはアクセス出来ません。これはSNIで判断できるため、SSLインスペクションの有無に関わらずアクセス不可が実現できます。\n\n\nしかし、Android端末のOneDriveアプリ経由では制御が効かずファイルをアップロードできてしまいます。また、WindowsPCのエクスプローラーのOneDriveフォルダからもファイルが削除出来、クラウド上のファイルは削除されます。これはアプリが使うWebAPIのURLとブラウザが使うURLとは異なるためにこういった事象（Webフィルタでは制御できないこと）が発生すると考えられます。\nさらに検証を続けます。一旦Webフィルタを削除し、アプリケーションフィルタにOneDriveの項目があるので、そちらをフィルタしてみます。\nXGの左ペインメニューのアプリケーションからファイアウォールルールで選択されているポリシーの先頭で追加ボタンをクリックし、スマートフィルタにonedriveと入力し、Enterキーを押します。\n\n\nOneDriveのルールがいくつか表示されます。”OneDrive Application”,”OneDrive Base”,”OneDrive File Download”,”OneDrive File Upload”です。アクションを”拒否”して最後に”保存”をクリックします。この作業の結果は以下の通りの挙動でした。\n\n\n\nOS\nテスト内容\n結果\n\n\n\nWindows\nブラウザからOneDriveにアクセス\n接続不可\n\n\n\nWindowsエクスプローラーからOneDriveにファイル追加\n不可\n\n\n\nWindowsエクスプローラーからOneDriveのファイル削除\n不可\n\n\nAndroid\nブラウザからOneDriveにアクセス\n接続不可\n\n\n\nOneDriveアプリからファイル追加\n不可\n\n\n\nOneDriveアプリからファイル削除\n可能\n\n\n上記のOneDriveに関するテスト結果では、ファイル削除について、SSLインスペクションの有無で動作に違いが表れました。AndroidはSSLインスペクションが行えないため、URL（SNI）の検証は行えますが、データの中身はhttpsで暗号化されておりファイル削除については制御出来ませんでした。また、OneDriveはファイルのアップロード・ダウンロードと分かれていましたが、他のアプリケーションであるAppleのiCloudDriveに関してはアプリケーションフィルタは1種類だけです。このようにアプリケーションフィルタは、アプリの作り方にも左右されるものとなります。\nなお、アプリケーションフィルタの中には、”EXE File Download”というフィルタも存在しますが、あくまで汎用的なものです。全てのいかなるアプリケーションからのEXEファイルのダウンロードを禁止できるものではありません。\nWebフィルタ・アプリケーションフィルタを完全に動作させるには、SSLインスペクションが必要です。\n\n\nこのアプリケーションは止めておきたいというニーズに対して、都度メンテナンスしていくのはとても大変です。従い、高リスクのアプリケーションは拒否する設定をします。具体的な設定については、「XG Firewall v18の設定におけるベストプラクティス」を参照してください。\nXGを運営しているプロダクトチームは、こういったトラフィックの中身を見ながら制御するポリシーを作るのですから、極めて大変な作業です。特にクラウドアプリケーションは予告なくURLやAPIが変更されるでしょうから、そのメンテナンスコストは計り知れません。\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"XCP-ngのVM新規作成","url":"/new-technology/2024/04/07/xcpng-newvm/","content":"\n\nこの記事で実現すること\nESXi代替としての仮想環境ソフトウェアのXCP-ng、またそのオペレーションをGUIで支援するXen Orchestraを利用して新規のVMを作成します。\n\n\n\nVMにおけるネットワークの考え方前回の記事「XCP-ngとXen Orchestra」では、PIFs（物理ネットワーク）とPrivate Networkを学びました。基本的にVLANを使わないのであれば、新規VMを構築する場合に物理ネットワークのPortに仮想MACアドレスが自動的に割り当てられます。ユーザーはどのPort（どのネットワーク）を使うか指定するだけです。複数のPortを持つNICがある場合は、VMの作成時にどのPortを使うのか（または複数選択）指定します。\nセットアップの前提条件今回ここで新規VMを作成するのはXCP-ng8.3Betaであり、サーバーはRyzen9 7900となります。この操作に関しては8.2.1と違い殆どありません。今回インストールするRocky Linux 9のテンプレートも変わらず使えます。\nISOsフォルダにisoファイルをアップロード前回の記事では”ISOs”というISO専用フォルダをXCP-ng用に作成しました。このフォルダにインストールするISOを入れてみます。左ペインのImport→Diskと進みます。\n\n\nSelect SRとあるので、対象のXCP-ngのノードに属する\"ISOs\"フォルダを選択します。そしてそこにISOファイルをDrag&Dropします。ここではRocky Linux（Rocky-9-Workstation...iso）をアップロードしてみます。Rocky LinuxはEnterprise向けであり長期サポートを謳っているプロダクトです。\n\nVMの新規構築左ペインのNew→VMと進みます。VMの新規作成画面になります。\n\n先頭のプルダウンでVMを導入するXCP-ngサーバーを選択します。2台以上のXCP-ngでPoolの設定が行われている場合はPool単位に指定します。\nInfo：VMのOSテンプレートを選択します。ここでは”Rocky Linux 9”を選択します。\nPerformance: vCPUとメモリの量を決めます。\nInstall Settings: アップロードしたISOファイルを選択します。\n\n\n\n\nInterfaces: 利用するネットワークに応じて”Pool-wide Network associate with ethx” を選択します。”Host Internel…”は選択しません。もし、2つ以上の論理NICを加える場合は、+ Add interfaceボタンをクリックします。\nDisks: 論理Diskの容量を設定します。\nShow advanced settingsボタンをクリックします。\n\n\n\n\n上記のように”Auto power on”（XCP-ngがBoot時にVM起動）、OSがUEFI対応の場合は、”UEFI”のトグルをONにします。なお、Max vCPUsにデフォルトで1という値が入っているので削除しています。\n\nさて、準備ができたので、画面右下の”Create”ボタンをクリックしてVMの作成、起動を行います。\nVMの起動（Rocky Linuxのインストール）自動起動後、XOの当該VMのConsoleのタブでは実際のRocky Linuxのインストール画面が見られます。\n\n\nGNOMEなので、UbuntuもRocky Linuxも大きくは変わりませんが、Installしていきます。\n\n\nUbuntuライクに管理者は作成せず、新規ユーザーを管理者として設定します。インストール終了後は自身で再起動を選択します。その後、Rocky Linuxが起動してきます。\nVMToolsのインストールさて、Rocky Linuxが起動してきた後に、インストールで利用したマウントを解除し、代わりにVMToolsのSRをマウントします。\n\n\nプルダウンから”guest-tools.iso”を選択します。その後Rocky Linuxを再起動します。\n端末を起動し、Shellから、以下のコマンドを順に投入します。マウント、Toolsのインストール、アンマウントです。\nsudo mount /dev/cdrom /mntsudo /mnt/Linux/install.shsudo umount /dev/cdrom\nこれが終われば、特にリブートは不要でVMToolsのインストールが完了します。XCP-ngからリブート、シャットダウンが行え、またNetworkのタブではL3の情報（IPアドレス）が表示出来るようになります。\n\n\nMACアドレスはVMを作成する時に自動で作成されています。ここでは”3e:2a:a8:24:12:c8”となっています。基本的にこのMACアドレスは不変ですが、バックアップから戻すときなどはまたMACアドレスが生成される事になるので、XCP-ngの管理上はクローンなのかVMの移動なのかを明確にオペレーションすることが求められます。こういう仕組みはESXiでもそうですし常識的な範囲の話ですね。\nこれでVMの導入については完了です。\nVMの設定変更VMの構築後、Advancedのタブを見てみます。\n\n\nUbuntu22、Debian12のデスクトップ環境がある場合は、Video RAMの8MiBを16MiBに変更しておいた方が良いです。デフォルト値では画面操作がとても遅い状況になります。\nNIC typeがRealtek...となっていますが、これは気にしなくて良いそうです。基本的にはOS起動時に必要なドライバが組み込まれるので問題ありません。\n\nCPU limitsとMemory limitsは、減らす方向であればOSを稼働させたままで変更可能です。起動時の最大値に戻すこともできます。なお、起動時の初期値は動作中には行えず、一度VMを停止する必要があります。\n\nモジュールのインストールDebian系と異なり、Rocky Linuxでモジュールをインストールする際はsudo dnf -y install module-nameを使います。SSHとiperf3はまず基本セットでしょうか。SSHはConfigの設定でPort22を空けるなど多少追加設定が必要です。また、iperf3で待ち受けする場合は、Firewallの設定も必要になってきます。セキュアなOSだけに少し手間が掛かりますね。\n$ sudo dnf -y install openssh-server$ sudo dnf -y install iperf3\n\nRyzen9でのパフォーマンス前回記事で記載したように、XCP-ngをRyzenで構築した場合、Ubuntuではiperf3のネットワークパフォーマンス（送信）が2Gbps程度と厳しい状況でした。しかし、Rocky Linux9に関しては、iperf3の上り&#x2F;下り共に9.0Gbps&#x2F;9.3Gbpsであり、Retryは、145&#x2F;0と素晴らしい内容でした。今回は、XCP-ng8.3BetaをRyzen9 7900で、XCP-ng8.2.1に関してはintel CPUでそれぞれセットアップの確認をしており、どちらとも問題はありません。\n個人的にはあと3年半稼働できるESXi8を中心に使いつつ、少しづつProxmoxとXCP-ngも検証を続けていければと考えています。ProxmoxにおけるRocky Linuxのiperf3は上り下り共に9.3Gbps前後出ていますが、送信時のRetryが13,000程度と異常値が出ています。ESXiでは当たり前のように使えていたものがいざ他のものに移ろうとすると、なかなか大変である事を実感しています。\n","tags":["XCP-ng"]},{"title":"XCP-ngとXen Orchestra","url":"/new-technology/2024/04/07/xcpng/","content":"\n\nこの記事で実現すること\nESXi代替としての仮想環境ソフトウェアのXCP-ng、またそのオペレーションをGUIで支援するXen Orchestraの概要およびセットアップを行います。Xen Orchestraは有償ソフトウェアですが、オープンシステムとして提供されており、コンパイル、ビルドすることで無償で利用できます。\n\n\n\nESXi代替としてのXCP-ng無償版ESXiが新規で利用できなくなった現在、個人向けの仮想化基盤としての代替ソフトウェアはProxmoxが有力です。インストールも簡単でVMの作成までに迷うことが殆どありません。私個人としては、ProxmoxはあくまでPCという領域の範囲で便利なソフトウェアという認識を持っています。モジュールの更新がapt updateであったり、バックアップ一覧がファイル名を意識させるものであったり、どこかでLinuxの延長として見てしまうところにあるのでしょうか。個人向けであっても、仮想環境は、運用面における信頼性、保守性は重要と考えるユーザーには、もう1つの選択としてXCP-ngが候補となります。\nXCP-ngはフランスのVatesという会社が提供しているプロダクトで、Citrix社のXenを引き継いで（技術提供を受けて）仮想環境の運用面と安定性を重要視して構築されているオープンシステムです。ESXiやProxmoxと比較し、CPU、メモリなどの基本的なスループットは劣ります。しかし、VM同士が互いに確実に分離され安定性が高いという意味においてはESXi同等です。KVMやProxmoxはメモリアクセスの観点では明確な分離が行われていないのでスループットは高くなります。\nつまりXCP-ng、Proxmoxはそれぞれの良さがあり、選択するのはユーザー次第です。1台のみでお手軽な仮想環境を作るのであれば、Proxmox一択となるでしょう。一方で2台以上、障害時のフェールオーバーを想定したり、バックアップなどの運用を重視するのであればXCP-ngのメリットが出てきます。XCP-ngは単純に仮想マシンが動作するリソースとなるサーバーであり、それを操作するのは別途XenOrchestraというGUIツールが必要でこれは別ノードのLinux上に構築します。従い3台構成が1つの目安となります。1台はProxmoxまたはベアメタルでXenOrchestraをセットアップし、別のノードにXCP-ngをセットアップすることになります。最低構成は2台です。もちろん最終的にXenOrchestraのLinux-VMをXCP-ngにインポートすれば1台でXCP-ng+XenOrchestraを運用可能です（障害発生時はその回復に手間が掛かりますが）。\nホームユーザーとして本格的な連続稼働を前提として仮想環境を利用される場合に検討対象となります。\n\n\n現時点で未解決の事項Ryzen CPUと主要Linuxディストリビューションなお、1か月ほどRyzen環境でXCP-ngを試行錯誤しましたが、主要なLinux distribution（Ubuntu,Debian,Mint）のiperf3のスループットが不十分な状況であり、解決できませんでした。インターネットに対する接続のspeedtestは4Gbps-5Gbps程度出ている状況でこちらは全く問題がなく、原因がよく分かっていません。Ryzen5 5600G、Ryzen9 7900と2種類のPCを用意して最新のバージョン8.2.1および8.3ベータで検証しましたがいずれもiperf3では送信ネットワークスループットが2Gbps程度でした。RyzenでもCPUの種類によっては高速に動作するようですが、巷に事例としてあるのは限られたCPUとマザーボードとの組み合わせのみになるようです。例外的に、Rocky LinuxだけはRyzenでも全く問題はなくiperf3でワイヤレートの速度が出ます。Windowsに関しては検証できていません。\n結局、5年ほど前に稼働していたIntel(R) Core(TM) i7-8700 CPU @ 3.20GHz（6Core 12Thread）に加え、新規に12th Gen Intel(R) Core(TM) i5-12400（6Core 12Thread）を購入して主、従の関係を構築しました。なお、XCP-ngではintelのE Coreについて強くお勧めしないとのことです。こういった情報は原則、コミュニティから収集することになります。Vates社は有償サポートで収益を上げるモデルを選択していますが、コミュニティ上での無償サポートも積極的です。\nVMのUEFIXCP-ngの検証を始めた時にはVMのセキュアブートは設定できたと記憶しているのですが、現時点で設定可能であるものの、VMの情報からはUEFIに対応していないという表記が出ます。確かにUEFIモードで起動しているようなのですが、現時点でその影響は判明していません。特に運用上実害は出ていません。\nXCP-ngのモジュールや関連プロダクト最新モジュールは、8.2.1です。ベータバージョンは8.3となります。8.3ベータはAMD CPU向けに色々追加されているのとIPv6の強化などが含まれています。バージョンの更新は非常にゆっくりと進んでいくので8.3ベータはこれで1年以上検証中の状態が続いています。今後構成されるプロダクトとしてXCP-ngを簡易なGUIで操作するXO Liteというプロダクトがありますが、これはまだ機能的に不足していて使えません。また、過去利用されていたものにXCP-ng Centerというプロダクトがありますが、これも非推奨となっています。\n\nXCP-ng ドキュメント https://docs.xcp-ng.org\n\n\nXCP-ng フォーラム https://xcp-ng.org/forum/\n\nXen OrchestraXen Orchestra(XOA)もVates社が製造しています。\n\n\nXOAはターンキーアプライアンスという名目ですぐに使えると表現されています（車のキーを回してすぐに動く）。これは有償のソフトウェアであり、CitrixのXen Server、XCP-ngを操作するためのGUIクライアントです。セットアップも簡単でXCP-ngに対してコマンド1つでモジュールを送り込み内部でビルドされます。\nこれに対してホームユーザーが利用するものは同じXen Orchestraではありますが、ソースコードからコンパイルすることで無償で利用できます。これは一手間掛かりますが、公式に認められた方法であり、オープンソースという建て付けで無償で提供されているものです。同じ、Xen Orchestraであっても、こちらはXOという表記がなされ、有償版と無償版はそれぞれ、XOA、XOと区別されます。\nここではXOの導入について説明をしていきます。XOはVMの構築、操作、バックアップ、スナップショット、マイグレーション（ノード間のVMの移動）を行います。\n\nXen Orchestra ドキュメント https://xen-orchestra.com/docs/\n\nなお、フォーラムはXCP-ngと共通です。\nXOの操作イメージここで説明する環境は以下の通りです。\n\n\nVMに対する操作はWebで行います。\n\n\nこれはUbuntuを動作させているところです。ネットワーク、ディスクの基本構成があります。ここでSSH　as userを選ぶとローカル端末のSSHで接続できます。スナップショットやバックアップはすぐに取得できます。ESXi同様にXCP-ng向けのVMToolを導入することで、IPアドレスの把握やXOからvmのシャットダウン、リブートが可能になります（ESXiとは異なり手動でインストールが必要です）。Advancedタグでは、メモリやCPUの上限などを可変できます。バックアップは自動的にスナップショットを取得します。ログも確認が容易ですし、Google等を経由したメール通知もできます。\n\n\n私の環境では10GbbpsのネットワークでXCP-ngからXOがデータを吸い上げ、それをNASにNFSで書き込んでいます。106MiB&#x2F;sなのでお世辞にもバックアップが早いとは言えませんが、圧縮しながらなのでこんなところなのでしょうか。基本は日時指定でバックアップを取得することになるのであまり気になるような状況でもないでしょう。複数ノードを1つのジョブでバックアップできるため、ノードが多くあればその分利便性を感じられます。\nXCP-ngは2種類のスナップショットの取得方法があります。通常のスナップショットはメモリの情報を保存しません。バックアップなどはこの方式が選択されます。もう一方はメモリの情報を含んだスナップショットであり、こちらは少しの間VMの応答ができません。セットアップ作業の合間にチェックポイントとして状態を保存したい場合は、後者を選択すると良いでしょう。\n同じCPU（intel）同士であれば、ダウンタイムを最小にするライブマイグレーションが可能です。\n\n\n表示が見切れているのでわかりづらいですが、ここでは同一のリソースプール（Pool1）における、1号機（XCP-ng1）から2号機（XCP-ng2）に対するマイグレーションを実施します。\nこの処理は最初に1号機から2号機への、ノード間でそれぞれのストレージ同士でコピー、その後動作したメモリの差分をコピーして完了させます。\nWi-Fiに接続されたMacbookから、XCP-ng上のUbuntuにiperf3を実行し、ほぼ同時にマイグレーションを開始してみます。\n[  5] 138.01-139.00 sec   174 MBytes  1.47 Gbits/sec[  5] 139.00-140.00 sec   178 MBytes  1.49 Gbits/sec[  5] 140.00-141.00 sec   174 MBytes  1.47 Gbits/sec[  5] 141.00-142.01 sec   179 MBytes  1.50 Gbits/sec[  5] 142.01-143.01 sec  78.4 MBytes   657 Mbits/sec[  5] 143.01-144.00 sec  0.00 Bytes  0.00 bits/sec[  5] 144.00-145.01 sec  0.00 Bytes  0.00 bits/sec[  5] 145.01-146.01 sec  40.4 MBytes   339 Mbits/sec[  5] 146.01-147.00 sec  73.2 MBytes   617 Mbits/sec[  5] 147.00-148.00 sec  97.8 MBytes   818 Mbits/sec[  5] 148.00-149.01 sec   112 MBytes   938 Mbits/sec[  5] 149.01-150.00 sec   125 MBytes  1.05 Gbits/sec[  5] 150.00-151.00 sec   130 MBytes  1.09 Gbits/sec[  5] 151.00-152.00 sec   136 MBytes  1.14 Gbits/sec\n\n2分20秒程度で1号機のノードとの応答が途絶え、それから約3秒後に2号機からiperf3の応答が再開されています。TCPセッションは切断されません。もちろん共有Diskがあればもっとマイグレーションは高速になりますが、個人向けの安価なハードウェアでも、ここまで出来るのは素晴らしいことです。\nXCP-ngのインストール8.2のインストールイメージは以下からダウンロードします。https://xcp-ng.org/#easy-to-install\n8.3ベータは以下からダウンロードします。https://xcp-ng.org/blog/2024/02/15/xcp-ng-8-3-beta-2/\n導入にあたっては、ハードウェアサポートのページをまず参照されることをお勧めします。https://docs.xcp-ng.org/installation/hardware/\nここでは、問題が少ないと思われるintelマシンに対して8.2.1をインストールすることにします。ISOファイルをダウンロードし、RufusなどでUSBメモリにブートイメージを書き込みます。Rufus上でも特殊な設定は不要でデフォルト設定のまま書き込みます。XCP-ngはUEFIブートに対応していませんのでサーバーとなるPCのセキュアブートは無効にします。なお、稼働するVMはUEFIのセキュアブートにできます。\n\n\nハードウェアによって異なりますが、最初にGRUBの画面が表示され、以下の選択になります。\n*install install with alterate kernel(kernel-alt) no-serial safe multipath shell\n\n基本は最初のinstalで構いませんが、セットアップ時にストレージ（NVMe）が見えずセットアップ出来ない場合は、Alt Kernel（代替カーネル）を選択してみてください。\nセットアップは以下の手順で進めます。\n\n最初にキーボードを選択します。\n\nセットアップの注意書き（お決まり）です。基本的にはこのままOKで進めていきます。\n\nEULAに同意します。\n\n\nストレージを選択します（ここではキャプチャ確保のためにProxmox上で動作させているのでQEMUと表示されています）。8.2のストレージはブロックベース（LVM）がデフォルトです。8.3以降はファイルベースになるようです。\n\n\nインストール元としてlocal media(USB)を選択します。\n\n\nインストールメディアの検証の確認です。どちらでも構いません。\n\n\nメディア検証で問題なしというダイアログです。次に進みます。\n\n\nパスワードを決めます。\n\n\nIPアドレスを決めます。サーバーになるので、DHCPではなくStaticで固定IPアドレスにします。\n\n\nXCP-ng自身のhostnameを決めます。hostnameの一部はランダムに命名されていますが、わかりやすいものに変えた方が良いです。DNSサーバーはご自身のDNS（ルーターまたはゲートウェイ）を指定します。\n\n\nタイムゾーンは、Asia、Tokyoと指定します。\n\n\n\nNTPを指定します。ご自身の環境から近く、安定しているNTPサーバーを指定します。上記は指定の一例です。\n\n\n最後にInstall XCP-ngのボタンを押下します。\n\n\nセットアップの進捗を示すダイアログが表示されています。\n\n\nサプリメントパックをインストールするか聞かれますので、ここはNoを答えます。その後インストールが継続します。\n\n\nセットアップ完了です。USBメディアを取り外し、OKボタンを押下します。\nセットアップ完了後再起動して以下の画面が表示されます。もしここまで上手く表示されない場合は、マザーボードのBIOSのアップデートをお勧めします。\n\n\nXCP-ngにはインストール時に設定したマネジメントネットワークが1つ必要です。このマネジメントネットワークに対してXen Orchestraから接続され制御されることになります。この状態でXCP-ngにはSSHできる状態になっています。または、このメニューのLocal Command Shellを起動します。\nVMがUEFIブートを可能とするため、以下のコマンドを入力します。$ secureboot-certs install\n[11:31 xcp-ng3 ~]# secureboot-certs installDownloading https://www.microsoft.com/pkiops/certs/MicCorKEKCA2011_2011-06-24.crt...Downloading https://www.microsoft.com/pkiops/certs/MicCorUEFCA2011_2011-06-27.crt...Downloading https://www.microsoft.com/pkiops/certs/MicWinProPCA2011_2011-10-19.crt...Downloading https://uefi.org/sites/default/files/resources/dbxupdate_x64.bin...Successfully installed certificates to the XAPI DB for pool.[11:37 xcp-ng3 ~]#\n\nここまででXCP-ngのセットアップは一旦完了です。NICを取り外して別のNICを取り付ける場合には、デバイス論理名（ex:eth0）とデバイスとの関連付けがずれてしまう場合があります。この際は以下のページを参考にしてください。\nhttps://docs.xcp-ng.org/networking/\n同じリソースプールでスムーズにVMの移動（ライブマイグレーション）を行う際は、同一の物理インタフェースが必要となります。もちろん同一製品である必要はありませんが、どのセグメントに属するか、速度タイプなどは同一にする必要があります。\nXen OrchestraのインストールXOのセットアップにはインターネットに接続されたLinuxが必要です。ここではXCP-ngとは別にUbuntu22を使ってXOのコンパイル、デプロイを実行していきます。まず、ベアメタルかVMとしてのGUIのあるUbuntu Desktopを用意してください。私の例ではマネジメントネットワークに加え、バックアップのセグメント（SynologyへのNFS接続）とのvNICを2つ用意しています。1つのNICのみであってもXOのセットアップは可能です。ここではProxmox上のUbuntuにXOをセットアップします。Proxmox上でのUbuntuのセットアップは「ProxmoxVEのVM新規作成（Ubuntu24.04LTS）」の記事を参考にしてください（XOをセットアップする想定でUbuntuを構築しています）。\nクライアントからXOにブラウザで接続して使うことになるので、最初にubuntuのIPアドレスは固定IPアドレスにします。設定ーネットワークから有線設定を変更しておきます。また、XOのセットアップ開始にあたり、最初にLinuxそのもののスナップショットを取得しておくとよいでしょう。\nXOのセットアップには有志であるronivay氏が作成したXenOrchestraInstallerUpdaterを利用します。https://github.com/ronivay/XenOrchestraInstallerUpdater\n事前準備Ubuntuのソフトウェアとアップデートを起動し、Ubuntuのソフトウェアでソースコードのチェックをオンにします。\n\n\nまた、他のソフトウェアの一覧でソースコードと記載されているものにチェックをオンにします。\n\n\nこれ以降はShellでの操作となるので、SSHでクライアントから接続してコマンドを投入していった方が簡単です（コマンドのコピペが出来るので）。SSH ServerがUbuntuに入っていない場合は、以下のコマンドでインストールします。$ sudo apt install openssh-server\nUbuntu DesktopでのShell操作、或いはクライアントからsshして以降の作業を行います（ssh username@your-host)。UbuntuのGUIで実施する場合は、端末を起動します。\nrootになる$ sudo -i\ngitのインストールリポジトリを追加し、gitをインストールします。\n$ add-apt-repository ppa:git-core/ppa$ apt update; apt install git\n\nXenOrchestraInstallerUpdaterのダウンロード、XOのインストールGitHubからスクリプトをダウンロードし、cfgファイルのサンプルのコピーを作成します。\n$ git clone https://github.com/ronivay/XenOrchestraInstallerUpdater.git$ cd XenOrchestraInstallerUpdater~/XenOrchestraInstallerUpdater$ cp sample.xo-install.cfg xo-install.cfg\n\nxo-install.cfgファイルをviで開き、インストールパス、XOが待ち受けるPort、SSL自己証明書を指定します。Ubuntuでは、インストールパスは/usr/lib/配下とします（お好みで変えてください）。\n~/XenOrchestraInstallerUpdater$ vi xo-install.cfg\n\n3箇所の修正ポイントです。以下の行を見つけます。\n# Port number where xen-orchestra service is bound# no effect to Xen Orchestra proxyPORT=&quot;80&quot;\n\nPORT&#x3D;”80”をPORT&#x3D;”443”に変更します。\n# Port number where xen-orchestra service is bound# no effect to Xen Orchestra proxyPORT=&quot;443&quot;\n\n次に以下の行を見つけます。\n# Base dir for installation and future updatesINSTALLDIR=&quot;/opt/xo&quot;\n\nINSTALLDIR&#x3D;”&#x2F;opt&#x2F;xo”をINSTALLDIR&#x3D;”&#x2F;usr&#x2F;lib&#x2F;xo”に変更します。\n# Base dir for installation and future updatesINSTALLDIR=&quot;/usr/lib/xo&quot;\n\n次に以下の行を見つけます。\n# Location of pem certificate/key files. Installation will automatically configure HTTPS if these are defined. Remember to change PORT variable as well.#PATH_TO_HTTPS_CERT=$INSTALLDIR/xo.crt#PATH_TO_HTTPS_KEY=$INSTALLDIR/xo.key\n\n証明書のパスについて2箇所コメントを外します。\n# Location of pem certificate/key files. Installation will automatically configure HTTPS if these are defined. Remember to change PORT variable as well.PATH_TO_HTTPS_CERT=$INSTALLDIR/xo.crtPATH_TO_HTTPS_KEY=$INSTALLDIR/xo.key\n\n以上でファイルの修正は終了ですので、保存しviを終了します。\nOpen SSLをインストールします。\n$ apt-get install openssl\n\n自己証明書を生成します。\n$ openssl req -newkey rsa:4096 \\            -x509 \\            -sha256 \\            -days 3650 \\            -nodes \\            -out /usr/lib/xo/xo.crt  \\            -keyout /usr/lib/xo/xo.key\n\n証明書の設定では以下、適当なものを入力しておきます。\nCountry Name (2 letter code) [AU]:JPState or Province Name (full name) [Some-State]:anywhereLocality Name (eg, city) []:anywhereOrganization Name (eg, company) [Internet Widgits Pty Ltd]:yoshiOrganizational Unit Name (eg, section) []:noneCommon Name (e.g. server FQDN or YOUR name) []:yoshiEmail Address []:yoshi0808.blog@gmail\n\nスクリプトを起動します。$ ./xo-install.sh\nXen Orchestra configuration will be stored to /root/.config/xo-server/config.toml, if you don&#x27;t want it to be replaced with every update, set CONFIGUPDATE to false in xo-install.cfgXen Orchestra Proxy configuration will be stored to /root/.config/xo-proxy/config.toml. Config won&#x27;t be overwritten during update, ever-----------------------------------------1. Install2. Update3. Rollback4. Install proxy5. Update proxy6. Exit：\n\nInstallの1を入力してEnterを押下します。必要なモジュール、ソースコードをダウンロードし、コンパイルに入ります。\n[info] xo-server and xo-web build takes quite a while. Grab a cup of coffee and lay back\n\nということで、コーヒーを淹れに行き、3分程度待ちます😊。以下の表示が出たところで、rebootします。事後にはLinixのアプリケーションファイアウォールであるufwを有効にして443のみを開けると良いでしょう（GUIもあります）。\n[info] Starting xo-server... waiting for port to be open       WebUI started in port 443. Make sure you have firewall rules in place to allow access.       Default username: admin@admin.net password: admin[info] Installation successful. Enabling xo-server service to start on rebootroot@xo:~/XenOrchestraInstallerUpdater# reboot\n\n再起動してインストールは終了です。上記のコメントにある通り、XOの画面からはユーザー:admin@admin.net、パスワード：adminでログインします。\nXOの初期設定Ubuntuが再起動してきたら、ブラウザからhttps://XOのIPアドレス/としてXOのGUIに接続します。ブラウザからは自己証明書の警告が表示されますが気にせず継続します。無事、以下のログイン画面が表示されればインストールは成功です。\n\n\nデフォルトアカウントでログインします。\n\n\nソースコードから作成されたものというダイアログが表示されます。OKをクリックして閉じます。また、画面上部には、”This version is not bundled with any support nor updates. Use it with caution. Why do I see this message?”と表示されていますが、これもサポートなしと理解して使っているので閉じます。そして、左ペインにXOA❓マークがありますが、これをクリックすると、Update❓という表示がされています。この？アイコンは削除できません。XOAはここからアップデートなどの処理が行えますが、これはXOAではなく、XOなのでこのサブメニューは使いません。無視して大丈夫です。\nユーザーの作成とデフォルトアカウントの削除左ペインのSettingsから、Usersを選択します。\n\n\n上記画面から、ユーザー名、ユーザーの権限は”Admin”を選択、パスワードを入力してCreateボタンをクリックして管理者を作成します。\n無事作成できたら、左ペインの一番下にあるサインアウトをクリックして、新しい管理者アカウントで入りなおします。ログインできたら、デフォルトのアカウントを右側のゴミ箱アイコンをクリックして削除します。\n任意の作業ですが、最初に仮想環境でスナップショットを取得していれば、ここまでは1つの区切りです。もう一度Linux全体のスナップショットを撮り直す、またはスナップショットは削除して再作成するなどしても良いでしょう。\nXen OrchestraからXCP-ngへの接続左ペインのSettingsからServersを選択します。\n\n\nここでXCP-ngのインストール時に決めたユーザー：root、パスワードをセットします。トグルスイッチのUnauthorized Certificateは今回作成した自己証明書なのでオンにします。先頭のLabelは自分のメモとしてサーバー名を入力しておきます。\nConnectボタンをクリックして接続します。うまくXCP-ngに接続できるとStatusがEnableの表示となります。\n\nさて、この状態になると、恐らく左ペインのHomeには、！マークが付いていると思われます。\n Home→Hostsと進むとサーバー名が表示されているのでこれをクリックします。\n\n\n\n Patchesの部分に恐らく数十の数字が書かれていることと思われます。これはXCP-ngでまだ適用されていないパッチの数を示します。 Patchesの項目をクリックして、 Install all patchesボタンをクリックしてパッチを適用します。適用後は、リブートが必要となります。画面右上のリサイクルマークのようなアイコンが再起動となるのでそれをクリックしてパッチの適用を完了させます。\n\n\n\n今はXCP-ngが1台だけですが、複数台を運用することになり、1つのリソースプールに存在する複数台のサーバーに順にパッチを適用する事になります。その際は、常にMasterとなっているサーバーを先にパッチ適用する必要があります。XCP-ngの再起動が完了するとXOは自動的にXCP-ngに接続します。\nXCP-ngネットワークの確認XCP-ngへの接続が完了したら、まずHome→Hostsと進みます。XCP-ngサーバーをクリックし、CPU&#x2F;メモリ&#x2F;ネットワークを確認しましょう。\n\n\nここで、PIFsというのはPhysical Interfaces（物理インタフェース）の意味です。Private Networkを作成すると、物理Portを指定してそこにVLANを定義するなどできます。そのようにすることで物理インタフェースにVLANタグの付いたパケットが流れます。XCP-ngがスイッチからタグ付きパケットを受け取り、VMにはPrivate Network（論理Port）経由でタグを剥がしてパケットをVMに渡します。またその逆でVMからタグなしのPrivate Network経由でパケットを受け取り、XCP-ngは該当の物理Portにタグ付きでパケットをスイッチに向けて送信します。\nISOファイルを配置するSRの設定VMを作成する前に、OSのISOファイルをアップロードするフォルダが必要です。これはXCP-ng上に作成します。つまりサーバー毎に必要です。大量に利用するなら、NASなどのNFSを用意してそこにマウントできます。ここではとりあえずXCP-ngのローカル上にSR(Storage Repository)を作成します。\n以下のVates社のブログを元に構成します。https://xcp-ng.org/blog/2022/05/05/how-to-create-a-local-iso-repository-in-xcp-ng/\nちょうどこの記事を見ていただくと、このブログの最後に記事を書いた方の情報があります。Olivier Lambert氏、Vates社の起業者でありCEOです。Forumにも頻繁にコメントされています。\n\nこのようにStorage TypeはISO SRのlocalとして作成します。パスは&#x2F;media固定です。\n次に左ペインのImport→Diskをクリック、対象のXCP-ngサーバーの指定フォルダ（上記では”ISOs”）を選びます。その画面上でクライアント端末からISOファイルをDrag&amp;Dropできます。\nお疲れ様でした！これでXCP-ngとXEN Orchestraの基本設定は完了です。次の記事で、New VMでVMの新規作成を行います。\nこの段階でXOがインストールされたUbuntuのOS毎のスナップショットは削除し、一度UbuntuのOSそのもののバックアップを取得されることをお勧めします。\nXOのアップデート左ペインのAboutからXOのモジュールについてアップデート状況が確認できます。現時点ではコンパイルしたばかりなので、”Your Xen Orchestra is up to date ”という表示になっているはずです。しばらく時間が経過するとこの表記はGitのMasterブランチに対して遅れを取っていきます。”You are not up to date with master. xx commits behind “という表記に変わります。かなり細かい単位でコミットされていきますが、Communityの情報を見ながら適宜アップデートする事になります。この際もコンパイルが必要です。最初にXenOrchestraInstallerUpdaterでInstallを選びましたが、再びスクリプトからUpdateを実行することで常にXOは最新モジュールとなります。\n$ sudo -i$ cd XenOrchestraInstallerUpdater$ git pull origin master$ ./xo-install.sh\n\nここで2.Updateを選択して更新します。\n GitHub上のXenOrchestraInstallerUpdaterを見る限りは数ヶ月に1度くらいの頻度で更新されているので、毎回git pull 〜は必要ありません。これはGitHubのページなどで情報を確認しながら、適宜アップデートしてください。\nXCP-ngの独自用語 XCP-ngのホストそのものはXenの世界でdom0と呼ばれます。色々コミュニティを見ていてdom0は何ぞや？と思われる方もいらっしゃると思うので補足です。dom0には色々なツールなどをインストールすることは避けた方が良さそうです(iperf3など)。\n","tags":["XCP-ng"]},{"title":"XG FirewallでIPv6の設定を行う（前半）","url":"/new-technology/2020/04/25/xg-ipv6-1/","content":"この記事で実現すること\nXG FirewallからホームゲートウェイとをIPv6で接続し、IPv6ホストの名前解決をテストします。\n\n\n\nIPv6を取り巻く環境いつかは枯渇すると言われているIPv4アドレスですが、欧州を管轄するRIPE NCCから、2019年11月25日に欧州のIPv4アドレスが枯渇したと発表されました。インターネットにいきなり大きく影響が出てくる事はありませんが、これからは徐々にIPv4だけでは接続出来ないサイトが出てくるものと思われます。IPv6の接続方式は、PPPoEの接続方法とIPoEの2通りの接続方法があります。プロトコル自体に優劣はさほどありません。いろいろな記事ではPPPoEが劣っているという書き振りを見かける事が多いのですが、これは大手回線業者の固有事情によるものです。実態としては単にIPv6のユーザーが少なく、途中のネットワークが空いている事が多いだけで、プロトコルとして高速なわけではありません。ただ現状の環境からすると、IPv6ネットワークはまだ将来を見据えて余裕がある状態である事は間違いなく、混雑しづらい状況にあります。\nIPv6は実質無限といっていいほどのアドレス空間を持ちます。IPアドレスは例を挙げると、2001:0db8:0000:0000:3456:0000:0000:0001のように表記が長く、管理する側もIPv4に比べて大変です。ホームユーザーとしては、宅内のIPアドレス管理の主体はIPv4としつつ、IPv6のサイトへのアクセスも可能というくらいに考えておく事が必要です。インターネットの接続業者によってはネット契約とは別にIPv6を改めて申し込む必要があります。大半の接続業者ではIPv6の利用は無料です。\nIPv6の設定にあたってXG FirewallはIPv6に対応しています。回線業者およびプロバイダがIPv6のサポートをしている前提で、ホームゲートウェイ（HGW）に接続する形態を想定しています。XGからHGWには普通にIPv6としてのネットワーク通信を行います。そういう意味ではIPoEとも言えます。貸与されているHGWとXGとのIPv6接続が正しく行えるかが最初のハードルとなります。この記事では、ホームゲートウェイからXGにてIPv6アドレスを割り当てられ、XGからIPv6でインターネットへのアクセスが可能か確認します。また、制約としてAndoroidはXGの構成によってはIPv6を使えない可能性があります。\nHGWからIPv6の配布を受けるホームゲートウェイから配布されるIPアドレスは、従来のIPv4であればDHCPの機能となりますが、IPv6の場合は以下の2通りがあります。\n\nDHCPv6\nRouter Advertisement\n\n最近の機械だとHGWに設定する箇所もなく、IPv6の契約があれば、プロバイダからIPoEでIPv6の接続が可能になっている状況もあるようです。XGは、上記いずれの方法でもHGWからのパブリックIPアドレスを受け取れるようです。\nWANインタフェースでIPv6を構成するXGのPort2（WAN側）でIPv6の設定を行います。XGの左ペインメニューから、ネットワークのインターフェースを選び、Port2をクリックします。\n\n\n\nIPv6設定のチェックボックスをOnにします\nIPの割り当てはDHCPを選びます\nモードは手動、ステートレス、DHCPから他の設定を承認を選択します\nゲートウェイ名はIPv6_GWなど、自由に命名してください\n\n保存をクリックすると下記の確認画面が表示されます\n\nインターフェースを更新をクリックすると、以下の通り、パブリックIPv6アドレスがHGWより割り当てられます\n \n\nDNSv6を設定するXGの左ペインメニューからネットワークを選び、DNSをクリックします。IPv6の項目があり、初期設定ではスタティックの設定となっています。HGWのfe80:からはじまるリンクローカルアドレス、またはホームゲートウェイのパブリックIPアドレスが指定されているはずです。HGWのDNS改ざん攻撃などもあるようですし、私はプロバイダのDNSのIPアドレスを調べ、それを手動でXGに設定しています。なお、DNSv4もプロバイダのDNSを指定される事をお勧めします。実運用としてプロバイダのDNSのIPアドレスは殆ど変更される事がありません。\n\n\n設定が環境と合っているか診断を行います。XGの左ペインメニューから診断を選んでください。名前参照から、DNSサーバーIPをすべての設定済みサーバーを使用して参照を選択し、名前参照をクリックしてください。\n \n\n正常な場合は以下の通り、設定したIPv4とIPv6のDNSでipv6.google.comの名前解決をした結果と計測時間を表示します。\n \n\n診断結果がうまくいかない場合は、先のDNS設定と、HGWからのIP配布方法などの設定をいくつか試してみてください。\n","categories":["Security"],"tags":["XG Firewall","IPv6"]},{"title":"XG Firewall v18 MR3の更新","url":"/new-technology/2020/10/25/xg-v18-mr3/","content":"\n\nXG Firewall v18 MR-3XG Firewall v18のMR-3が2020年10月12日に発表されました。変更点について記載します。なお、XG Firewallの最新パッチについては、「VMware ESXiの仮想マシンをバックアップする」の関連リンクを参照してください。\n\n\n主なエンハンスの内容\nセキュリティ強化機密情報の暗号化が行われました。これに伴い、新たにセキュア・ストレージ・マスターキーというものを作成する必要があります。また次回のアップデートでも暗号化される項目は追加されるとの事です。\nSSL VPNの強化。トラフィック転送量が増加し、WindowsクライアントにSSL VPNが対応しました。\nその他の不具合の修正\n\nXGのアップデートXGのv17からのアップデートは、 v17.5 MR13&#x2F; MR14&#x2F; MR14-1が対象となっています。XGのv18であればMR-3へのアップデートは可能です。XGの管理画面にログイン後、左ペインメニューのバックアップ＆ファームウェアのファームウェアの確認ではただちに全てのユーザーにアップデートの案内が来るわけでは無いようなので、アップデートにはMySophosにログインし、バージョンアップの差分モジュールをダウンロードします。\n(2020-12-22 追記)XG v18 MR-3はMR-4の発表によりダウンロードできなくなりました。最新パッチについては、「XG Firewall v18 MR4の更新」を参照してください。MR-3で導入されたセキュア・ストレージ・マスターキーはMR-4でも引き続き設定が必要なものですので、この記事については残しておきます。\n\nSophosのサイトの右上のメニューから、マイアカウントをクリックします。\nSophos IDをお持ちでなければIDを作成します。\nログイン後、My Sophosのリンクをクリックし、さらに画面左側のNetwork Protectionをクリックします。\nファームウェアの更新をクリックします。\n「製品名&#x2F;OSを使った検索」で”ファイアーウォール”を選択し、その後現れるプルダウンは”ソフトウェア”を選択します。\n選択可能なダウンロードを表示ボタンをクリックします。\n\n\n\n\n上記画面で”SW-18.0.3_MR-3.SFW-457.sig”というアップデータが表示されますのでダウンロードします。\nMY Sophosはここで終了し、XGの管理画面にログインし、左ペインメニューのバックアップ＆ファームウェアのファームウェアのタブメニューから、以下の画面に赤丸で囲った矢印のアイコンをクリックし、ダウンロードしたモジュールをアップロードします。\n\n\n\nアップロード＆再起動ボタンをクリックし、MR-3へのアップグレードを完了させます。\n仮想環境（ESXi）上にXGをインストールされている方はアップグレードの前に、「VMware ESXiの仮想マシンをバックアップする」を参考に、XGのバックアップを確保される事をお勧めします。\n\n\nセキュア・ストレージ・マスターキーXGが再起動し、ログイン後、新たに追加されたセキュア・ストレージ・マスターキーの作成を求められます。\n\n\n以下の通り、最低12文字で、大文字・小文字・記号を含める必要があります。\n\n\n登録を終えると、マスターキーがセットされたとのメッセージが表示されて対応は完了です。\n\n\nマスターキーの情報は「パスワード管理ソフトのbitwardenを活用する」を参考に、暗号化された安全な場所へ保管されることをお勧めします。\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"Sophos FirewallでIPv6の設定を行う（後半）","url":"/new-technology/2020/04/29/xg-ipv6-2/","content":"この記事で実現すること\nSophos Firewall配下のクライアントにIPv6アドレスを配布し、IPv6インターネットに接続します。また、SSL/TLSインスペクションを設定します。\n\n\n\nXGのIPv6IPv6は一般的に内部のホストに対してもパブリックIPアドレスを割り当てます。IPv6独自の工夫として、端末を特定されないために一時アドレスを割り当てます。一時アドレスは端末再起動時に変更され、外部からホストの特定を防ぐ目的があります。IPv4の枯渇が課題だったがために、到達性と安全面を考慮した設計と推察されます。\n一方、Sophos FirewallのIPv6の考え方としてはNATを前提にします。内部ホストから外部に出ていくものはSNAT（Source NAT）、公開するホストはDNAT（Destination NAT）で外部から内部ホストに転送するという原則があります。LAN側のIPv6にはプライベートIPの考え方に近い、ユニークローカルアドレス（ULA）を用います。\nULAは、プライベート環境で自由に割り当てして良いというわけではなく、なるべく世界の中で一意にすべきという考え方です。企業向けとしては合併などがあった場合に重複しない事を前提としています。192.168.1.0/24のように、誰でも使って良いアドレスとは異なるのがIPv6のULAです。このULAは一定のルールに従い機械的に生成する必要があります。\nXGのIPv6を構成するまで以下の流れでXGのIPv6をセットアップします。\n\nULAを生成\nXGのLAN側のIPアドレスにULAを設定\nLAN側ホストにIPv6を割り当てるためのDHCPv6、ルーターアドバタイズメント（RA）の設定\nFirewallルールの設定\n固定IPv6アドレスの登録\nSSL&#x2F;TLSインスペクションの設定\n\nULAを生成するULAの生成にはネットワークカードのMACアドレスが必要です。仮想環境で構築している方は仮想MACアドレスではなく、可能な限り衝突を避けるべく、物理マシンのMACアドレスを使ってください。\n物理マシンに直接Firewallをインストールしている方は、Sophos Firewallの左ペインメニューのネットワークからインターフェースの”Port1(LAN)”を選択し、詳細設定をクリックするとMACアドレスが確認出来ます。\n\n\n仮想環境の場合、ESXiを例に挙げると、以下のようにLAN側物理MACアドレス（当方の環境では、vmnic1）にMACアドレスがあります。\n\n\nULAの生成は以下の通り過去記事にありますので、上記MACアドレスをコピーし、過去記事「IPv6のUnique Local Addressを生成する」を参考にULAを求めて下さい。結果として、以下のような情報が得られるので、First IPv6 Addressのfdから始まるULAを控えてください。\nFirst IPv6 Address-&gt; fd00:beef:cafe::1/64\n\nLAN側にULAを設定XGの左ペインメニューのネットワークのインターフェースにある、IPv6設定のチェックボックスをチェックします。次に、IPv6　プレフィックスの項目に生成したULAを貼り付け、/64の部分を削除してください。画面を見てもらえると解りますが、IPv6のサブネット/64は画面上で固定表示されています。\n\n\nこのアドレス体系は以下の通りです。\n\nIPv6の体系は128ビットで、ユニキャストアドレスは1つのセグメントが64ビットとなります。XGでも64ビットで扱います。\n48ビットのULAに16ビットの内部サブネット0000を加え、64ビットプレフィックスを定義しています。別のサブネットにするのであれば、ここを0001などとしていきます[1]。\nIPv6における、デフォルトルーターは、リンクローカルアドレスの1とするのが一般的です（fe00::1）。これに倣い、XG自身のIPv6アドレスの後半64ビットのインターフェース識別子は0000:0000:0000:0001としています。\n::は、IPv6アドレスの0000が続く部分を省略できるものです。（例）fd00:beef:cafe:0000:0000:0000:0000:0001/64の連続する0部分を省略し、fd00:beef:cafe::1/64としています。\n\n保存ボタンをクリックし、LAN側のインタフェースにIPv6を割り当てます。\nRAおよびDHCPv6の設定DHCPv6の設定クライアントにIPv6のアドレスを配布します。SSL&#x2F;TLSインスペクションが行えるクライアントは固定IP範囲を明示的に割り当てます。XGの左ペインメニューからネットワーク、DHCPと進み、サーバーの”追加”ボタンをクリックします。次にIPv6のタブをクリックし、以下の画面の通り入力していきます。\n\n\n\nDHCPの名前は、IPv6のDHCPと分かるよう命名してください。\nインターフェースは\"Port1\"を選択してください。すでに割り当てられているFirewallのIPv6アドレスが表示されます。\nダイナミックIPリースは、自動割り当てするIPv6アドレスの範囲を入力します。IPv4は10進数で表示する事が多いですが、IPv6は16進で表示する事になるので、ログを見た時に解りやすいIPアドレス体系となるような構成にされる事をお勧めします。\nスタティックIPのDUIDマッピングは後ほど入力します。一旦は空のままにしておいてください。\nDNSサーバーは、FirewallのLAN側IPv6アドレスを指定して下さい。内部ホストの名前解決のために必要です。\n\nRAの設定 クライアントにデフォルトゲートウェイの通知を行うため、RAの設定を行います。DHCPで明示的にIPv6アドレスを指定しないクライアントはRAにより自身のIPv6アドレスを自動生成しつつ、ゲートウェイの情報を受け取ります。RAでは、マネージドフラグ（Mフラグ）、アザーフラグ（Oフラグ）という言葉が登場します。\n\nMフラグ　DHCPv6によって明示的に割り当てたステートフルなIPv6アドレス（ON）にする（※IPv4のDHCPと同じ）か、RAによってPrefixが通知され、クライアントは自分のMACアドレスから生成するステートレスIPアドレスにする（OFF）かを決めます\nOフラグ　IPアドレス以外の情報をDHCPv6サーバやRAから取得する（ON）、取得しない（OFF）\n\nIPv6において最近のトレンドとしては、IPv6の取得にDHCPv6を使わずRAから構成する（Mフラグ＝OFF、Oフラグ＝ON）が定番です。長いIPv6アドレスの管理は大変なので、この設定が一番楽な管理方法です。しかし、私のXGに関する記事ではSSL&#x2F;TLSインスペクションを最も重要視しています。クライアントでIPv6アドレスが生成されると、FirewallでCA証明書が登録されている端末か否かの判断が行えません。よってMフラグ＝ONとし、FirewallがIPv6アドレスを管理する、ステートフルなIPv6アドレスとする必要があります。OフラグがOFFの場合はDNSの情報は手動設定であり（但しサーバー、クライアント共にRDNSSに対応していれば可能）、DHCPv6は無用という解釈です。\nSophos Firewallでの結論としては、ステートフルなDHCPv6で全てを管理するため、Mフラグ＝ON、Oフラグ＝ONとなります。やや管理者寄りの理論です[2]。また、IPv6では上述した通り、一時IPv6アドレスというものが存在します（XG上では自律）。これを認めると、クライアントが再起動の度にIPアドレスが変わり、SSL&#x2F;TLSインスペクションを迂回されてしまいますからこの一時アドレスの設定もOFFにします。XGの左ペインメニューのネットワークから、IPv6ルーターアドバタイズを選択し、”追加”ボタンをクリックし、以下の図のように登録していきます。\n\n\n\nインターフェースは、\"Port1\"を選択します\nマネージドフラグにチェックします\nアザーフラグにチェックします\nデフォルトゲートウェイにチェックします\nアドバタイズ設定のプレフィックスのプレフィックスには、今回作成した、ULA（例）`fd00.beef.cafe::`を入力します。また、一時アドレスは使わないので自律のチェックを外します\n保存をクリックし、設定を完了させます\n\nこの段階でクライアントのIPを取り直すと、IPv6に関してはULAが１つだけ割り振られているはずです。\nファイアウォールルール設定ここまでの設定で、クライアントはIPv6アドレスが割り振られています。インターネットにIPv6で接続するためには、Firewallルールの設定が必要となります。XGの左ペインメニューのルールとポリシーで”IPv6”をクリックします。\n\n\nファイアウォールルールの追加ファイアウォールルールの追加から新しいファイアウォールルールをクリックします。\nここでの設定内容は、「XG Firewall v18のルールを作成する」でIPv4について設定した内容と変わりません。”To Internet”というルールを作りましたが、同じ内容になります。\n\nルール名はここでは”To_Internet_IPv6”とします。\n送信元ゾーンには、”LAN”を設定します。VPNを使う方は”VPN”も加えてください。宛先ゾーンは”WAN”を指定します。\nIPv4でもリンクNATは使いませんでしたが、IPv6においても利用しません。\n\nセキュリティの”Webフィルタリング”をクリックし、詳細メニューをオープンします。\n\nWebポリシーは”Default Policy”を選択します（任意）\n“HTTPおよび復号化したHTTPSをスキャン”をチェックします\n“FTPのマルウェアをスキャン”をチェックします\nQUICプロトコルのブロックは任意選択です  Googleのサービスで利用されています。私はチェックしています。Google自体は問題ないですがそのプロトコルを利用した悪質なサイトがFirewallを回避するリスクを減らすという意味で選択しています\nその他のセキュリティ機能でアプリケーションコントロールを選択します  私は”Block very high risk(Risk Level 5) apps”を選択しています\nIPSは”lantowan_general”を選択します\n保存ボタンをクリックします\n\nNATルールの設定ルールとポリシーのNATルールから\"IPv6\"をクリックします。ここでは、既にIPv6の自動設定された情報が\"Default SNAT IPv6\"という名前で登録されています。ルールを開いて、ルールのステータスのトグルスイッチをOnにしてください。最後に\"保存\"をクリックしてください。この段階ではSSL/TLSインスペクションの設定は出来ていませんが、IPv6で接続可能な状態になっています。\n\nテストのために、ipv6.google.comが正しく表示出来るか確認してください。\n固定IPアドレスの登録端末にルート証明書を導入できる端末（Windows、macOS、Linux、iOS）に対してSSL&#x2F;TLSインスペクションを行いますので、DHCPv6では、該当端末が常に固定のIPv6アドレスを持つための設定を行います。XGの左ペインのネットワークのDHCPから、”IPv6リース”の状況をみると、実際にIPv6のアドレスが割り当てられている一覧が確認できます。ここの”DUID”が端末固有情報であるため、この値を控えて、DHCPv6の設定にIPv6とDUIDのペアを登録していく事になります。ここでは、DUIDの値をメモしてください。残念ながら以下の通りDUIDの文字列が長すぎて、表記が見切れます。マウスをポイントしてポップアップされたDUIDをメモする必要があります。\n\n\n再び、DHCPの設定画面で、IPv6 DHCP Serverを選択します。以下のように、スタティックIPのDUIDマッピングの項目にDUIDとIPv6のセットを登録してください。\n\n\nSSLインスペクションでは、IPアドレスの範囲を明確に設定し、IoTなどSSL&#x2F;TLSインスペクション対象外の端末が含まれないように注意してください。\n\n\nSSL&#x2F;TLSインスペクションの設定IPv6のSSL&#x2F;TLSインスペクションの設定を行います。まずは、IPv4で対応した時と同じように、SSL&#x2F;TLSインスペクションの対象範囲のIPホストを登録します。XGの左ペインメニューのホストとサービスから、IPホストのタブで、追加ボタンをクリックします。\n\n\n上記の通り、SSL&#x2F;TLSインスペクションのためのIPv6の範囲を”CA_Client_IPv6”として登録します。16進数のアドレス表記ですが、ここでもIPv4のアドレス体系に合わせておくと、ログを確認した時の視認性が上がります。続いて、XGの左ペインメニューのルールとポリシーからSSL/TLSインスペクションルールに進み、”IPv6”をクリックします。「XG Firewall v18のSSL&#x2F;TLSインスペクションの設定」で、このSSL&#x2F;TLSインスペクションルールを一度作成しています。ここにIPv6の設定を加える事になります。\n\n\n上記のように、送信元ネットワークとデバイスに、今回作成した、IPv6のホスト群である、”CA_Client_IPv6”を選択して追加します。\nこれでIPv6に関する設定は完了です。IPv6についても、SSL&#x2F;TLSインスペクションの対象となり、IPSなど多くのコンテンツフィルタが可能となりました。一度IPv4でXGのルート証明書を端末にインストールしてあれば、再度インストールする必要はありません。SSL&#x2F;TLSインスペクションのための端末へのインストールについては、「XG Firewall v18のSSL&#x2F;TLSインスペクションの設定」を参照してください。\n動作確認IPv6サイトをブラウザ等で閲覧後、XGのログのログビューアを開き、プルダウンから、SSL/TLSインスペクションを選択します。\n\n\n上記の通り、同じホストでもIPv4とIPv6の通信が混在している事、またSSL&#x2F;TLSインスペクションの対象&#x2F;対象外についてもログの内容を見て確認できます。\n[1]ULAの48ビットに対するネットワークアドレスとして（例）fd00:beef:cafe:0000を使うため、業務上実際に使う64ビットプリフィックスは（例）fd00:beef:cafe:0001::/64から開始するのが一般的です。今回はホームユーザー向けの一例として出来るだけ簡素化する事を目的とし、短い文字列で済むようにサブネットに0000を設定にしています。そういう私も自分の環境では、Prefixの後半16ビットは0001以降の数字を使っています。\n[2]DHCPv6とRAの戦いというものがあって、RA派は合理化を目指す方向です。ネットワーク管理者がIPアドレスの管理をすべきでサーバー管理者がやるべきでないという論調です。DHCPv6派はクライアントが勝手にアドレスを決めるのは困るという理論です。Sophosには頑張ってもらって、もう少し簡単に証明書が入っている端末を区別できるように期待したいところです。\n","categories":["Security"],"tags":["XG Firewall","IPv6"]},{"title":"XG Firewall v18 MR4の更新","url":"/new-technology/2020/12/17/xg-v18-mr4/","content":"\n\nXG Firewall v18 MR-4XG Firewall v18のMR-4が2020年12月15日に発表されました。なお、XG Firewallの最新パッチについては、「VMware ESXiの仮想マシンをバックアップする」の関連リンクを参照してください。\n\n\n主なエンハンスの内容\nセキュリティ強化\nIPSecリモートアクセス用の新しい高度なオプション（scadminの代用）。Sophos Connect VPNクライアントのダウンロードがユーザーポータルから可能に\nより強力なパスワードハッシュ - この重要な機能をフルに活用するため、アップグレードするときにパスワードを変更するように促されます\nウェブフィルタリング - インターネット・ウォッチ・ファウンデーション（IWF)によって児童の性的虐待コンテンツを含むと特定されたウェブサイトは、ウェブフィルタリングが有効になっている場合、自動的にブロックされます。\n\n\nUpgrade as soon as possible\nWhile we always encourage you to keep your firewalls up to date with the latest firmware, over the next few months we are recommending you rapidly apply maintenance releases to ensure you have all the important security, performance, and feature enhancements applied as soon as possible.\nファイアウォールを最新のファームウェアで最新の状態に保つことを常に推奨していますが、今後数ヶ月間は、重要なセキュリティ、パフォーマンス、機能強化のすべてを可能な限り早く適用できるように、メンテナンスリリースを迅速に適用することをお勧めします。\n\n\n\nXGのアップデートXGのv17からのアップデートは、 v17.5 MR6以降から可能です。XGのv18であればMR-4へのアップデートは可能です。XGの管理画面にログイン後、左ペインメニューのバックアップ＆ファームウェアのファームウェアの確認ではただちに全てのユーザーにアップデートの案内が来るわけでは無いようなので、アップデートにはMySophosにログインし、バージョンアップの差分モジュールをダウンロードします。\n\nSophosのサイトの右上のプルダウンメニューから、ライセンスポータルをクリックします。\nSophos IDをお持ちでなければIDを作成します。\nログイン後、Network Protectionをクリックします。\nファームウェアの更新をクリックします。\n「製品名&#x2F;OSを使った検索」で”ファイアーウォール”を選択し、その後現れるプルダウンは”ソフトウェア”を選択します。\n選択可能なダウンロードを表示ボタンをクリックします。\n\n\n\n\n上記画面で”SW-18.0.4_MR-4.SFW-506.sig”というアップデータが表示されますのでダウンロードします。\nMY Sophosはここで終了してXGの管理画面にログインし、左ペインメニューのバックアップ＆ファームウェアのファームウェアのタブメニューから以下の画面に赤丸で囲った矢印のアイコンをクリックし、ダウンロードしたモジュールをアップロードします。\n\n\n\nアップロード＆再起動ボタンをクリックし、MR-4へのアップグレードを完了させます。\nMR-4で注意する点XGv18のいつのバージョンからか気付きませんでしたが、IPSec VPNのiOSの構成ファイルのダウンロード（ユーザーポータル画面からダウンロード）ができなくなっていました。今回のバージョンではVPNについて、scadmin（IPSec構成ファイル作成ツール）を使わず構成ファイルが作成できるような感じでしたので早速検証したところ、「Install」ボタンをクリックすると再びユーザーポータルのログインページに飛ばされてしまいファイルをダウンロードする事すらできなくなっていました（MR-5では修正されています）。\n幸いにも、iOSからIPSec VPNでXG Firewallに接続する方法は、代替策があるのでVPN構成ファイルをダウンロードせずとも対応は可能です。「XG Firewall VPNにスマホから接続する」の記事については代替策について追記しておきました。\n（2021-1-2追記）v18 MR4にアップデートしてからXGのアラート通知が来ていない事に気がつきました。MR4では、左ペインメニューの管理の通知の設定画面で「証明書」という項目が追加されており、プルダウンから証明書を選択するようになっています。gmailのような外部メールを利用して通知するケースでは、証明書に”Application Certificate”を選択してください。「XG Firewallの通知設定を行う」にも追記しています。\n仮想環境（ESXi）上にXGをインストールされている方はアップグレードの前に、「VMware ESXiの仮想マシンをバックアップする」を参考に、XGのバックアップを確保される事をお勧めします。\n\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"XG Firewall v18 MR5の更新","url":"/new-technology/2021/04/07/xg-v18-mr5/","content":"\n\nXG Firewall v18 MR-52021年4月28日に、v18-MR5のbuild586が発表されています。なお、XG Firewallの最新パッチについては、「VMware ESXiの仮想マシンをバックアップする」の関連リンクを参照してください。\n\n\n主なエンハンスの内容VPNの新機能\n同時IPSecVPNトンネル容量の大幅な50%の増加\nソフォス接続v2.1経由のリモートアクセスのためのIPSecプロビジョニングファイルのサポート（Windows）\n\n証明書の管理とセキュリティ\n秘密キーのセキュリティ強化\nPEM形式証明書のアップロード&#x2F;ダウンロードのサポート\n\nその他、Sophos Central Firewallレポーティングの強化、50項目以上の不具合修正があります。また、build586では、SNMPとIPSecVPNに関する細かな不具合が修正されています。\n\nhttps://community.sophos.com/sophos-xg-firewall/b/blog/posts/sophos-xg-firewall-v18-mr5--build-586-is-now-available\n\n\nUpgrade as soon as possible\n\n\nWhile we always encourage you to keep your firewalls up to date with the latest firmware, over the next few months we are recommending you rapidly apply maintenance releases to ensure you have all the important security, performance, and feature enhancements applied as soon as possible.\n\n\nファイアウォールを最新のファームウェアで最新の状態に保つことを常に推奨していますが、今後数ヶ月間は、重要なセキュリティ、パフォーマンス、機能強化のすべてを可能な限り早く適用できるように、メンテナンスリリースを迅速に適用することをお勧めします。\n\nXGのアップデートXGのv17からのアップデートは、 v17.5 MR6以降から可能です。XGのv18であればMR-5へのアップデートは可能です。XGの管理画面にログイン後、左ペインメニューのバックアップ＆ファームウェアのファームウェアの確認ではただちに全てのユーザーにアップデートの案内が来るわけでは無いようなので、アップデートにはMySophosにログインし、バージョンアップの差分モジュールをダウンロードします。\n\nSophosのサイトの右上のプルダウンメニューから、ライセンスポータルをクリックします。\nSophos IDをお持ちでなければIDを作成します。\nログイン後、Network Protectionをクリックします。\nファームウェアの更新をクリックします。\n「製品名&#x2F;OSを使った検索」で”ファイアーウォール”を選択し、その後現れるプルダウンは”ソフトウェア”を選択します。\n選択可能なダウンロードを表示ボタンをクリックします。\n\n\n\n\n上記画面で”SW-18.0.5_MR-5.SFW-586.sig”というアップデータが表示されますのでダウンロードします。\nMY Sophosはここで終了してXGの管理画面にログインし、左ペインメニューのバックアップ＆ファームウェアのファームウェアのタブメニューから以下の画面に赤丸で囲った矢印のアイコンをクリックし、ダウンロードしたモジュールをアップロードします。\n\n\n\nアップロード＆再起動ボタンをクリックし、MR-5へのアップグレードを完了させます。\n仮想環境（ESXi）上にXGをインストールされている方はアップグレードの前に、「VMware ESXiの仮想マシンをバックアップする」を参考に、XGのバックアップを確保される事をお勧めします。\n\n\nIPSec VPNのiOSの構成ファイルv18のMR4で気づいた、IPSec VPNのiOSの構成ファイルのダウンロード（ユーザーポータル画面からダウンロード）ができなくなっていた件は、今回のバージョンで修正された事を確認しました。サポートから連絡のあった、NC-64758という不具合番号も今回の解消リストに含まれています。修正されたissueは以下を参照してください。\n\nhttps://docs.sophos.com/releasenotes/index.html?productGroupID=nsg&amp;productID=xg&amp;versionID=18.0\n\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"XG Firewall v18.5 MR1の更新","url":"/new-technology/2021/08/15/xg-v185-mr1/","content":"\n\nXG Firewall v18.5 MR-1XG Firewall v18.5 MR1が2021年8月9日に発表されました。主としてTLSインスペクションの高速化が行われています。これまでv18を利用してきたユーザーは今後発表されるであろうv18 MR-6以降へのアップデート、或いは、今回のv18.5へのアップデートとを選択する事になるようです。なお、XG Firewallの最新パッチについては、「VMware ESXiの仮想マシンをバックアップする」の関連リンクを参照してください。\n\n\n主なエンハンスの内容\nDPI モードでの TLS トラフィックのネットワーク パフォーマンスの向上など、v18.5 GA に含まれるパフォーマンスの向上の恩恵を受けることができます。\nソフォス DDNS (myfirewall.com) は廃止され、新しい登録はサポートされなくなります。2022年1月31日から予定されています。詳細については、KBA-41764を参照してください。\nhttps://support.sophos.com/support/s/article/KB-000041764?language=en_US&amp;c__displayLanguage=ja\n\n\n\nなお、XGのメニューには ゼロデイ対策という項目が加えられていますが、個別のサブスクリプションライセンスが必要です。\nv18.5 MR-1の詳細な説明はSophos Communityを参照してください。可能な限り迅速にアップグレードするように推奨されています。\n\nhttps://community.sophos.com/sophos-xg-firewall/b/blog/posts/sophos-firewall-v18-5-mr1-is-now-available\n\n\nUpgrade as soon as possible\n\n\nWhile we always encourage you to keep your firewalls up to date with the latest firmware, over the next few months we are recommending you rapidly apply maintenance releases to ensure you have all the important security, performance, and feature enhancements applied as soon as possible.\n\n\nファイアウォールを最新のファームウェアで最新の状態に保つことを常に推奨していますが、今後数ヶ月間は、重要なセキュリティ、パフォーマンス、機能強化のすべてを可能な限り早く適用できるように、メンテナンスリリースを迅速に適用することをお勧めします。\n\nXGのアップデートXGのv17からのアップデートは、 v17.5 MR14以降から可能です。XGv18はMR-3以降から可能です。XGの管理画面にログイン後、左ペインメニューのバックアップ＆ファームウェアのファームウェアの確認ではただちに全てのユーザーにアップデートの案内が来るわけでは無いようなので、アップデートにはMySophosにログインし、バージョンアップの差分モジュールをダウンロードします。\n\nSophosのサイトの右上のプルダウンメニューから、ライセンスとアカウントをクリックします。\nhttps://www.sophos.com/ja-jp.aspx\n\n\nSophos IDをお持ちでなければIDを作成します。\nログイン後、Network Protectionをクリックします。\nファームウェアの更新をクリックします。\n「製品名&#x2F;OSを使った検索」で”ファイアーウォール”を選択し、その後現れるプルダウンは”ソフトウェア”を選択します。\n選択可能なダウンロードを表示ボタンをクリックします。\n\n\n\n\n上記画面で”SFOS 18.5.1 MR1-Build326”というアップデータが表示されますのでダウンロードします。\nMY Sophosはここで終了してXGの管理画面にログインし、左ペインメニューのバックアップ＆ファームウェアのファームウェアのタブメニューから以下の画面に赤丸で囲った矢印のアイコンをクリックし、ダウンロードしたモジュールをアップロードします。\n\n\n\nアップロード＆再起動ボタンをクリックし、v18.5へのアップグレードを完了させます。\n\n\nSophosダイナミックDNSの提供終了残念ながらmyfirewall.coのDDNSは2022年1月末をもってサービス提供終了となります。また、このv18.5から新たに”myfirewall.co”でDDNSを新規登録できないようになっています。一旦myfirewall.coのDDNSを削除してしまうと追加できない事になります。代替のDDNSは以下の通りです。\n\nDynDNS\nZoneEdit\nEasyDNS\nDynAccess\nNo-IP\nDNS-O-Matic\nGoogle DNS\nNamecheap\nFreeDNS\n\n\n\nNo-IPの無償ユーザーで確認してみましたが定期的にDNSの更新が行われています。No-IPの無償ユーザーは毎月ユーザーが実際にNo-IPのサイトにログインして利用継続を確認する必要があります。XGのVPN(IP-Sec,SSL-VPN)については設定ファイルのホスト名を修正できます。例えばNASをお持ちの方であればDDNSが提供されているケースもあり、NASのメーカーが提供するDDNS名に置き換え、XG上のDDNSは使わないという方法もあります。\nTLS&#x2F;SSLインスペクションのパフォーマンス体感的には通販サイトなど細かな画像ファイルが多く読み込まれるケースで高速化したかな？と感じてはいます。SSLインスペクション、IPS、アプリケーションフィルタ、Webフィルタを有効にした状態で下記のスループットとなっており、十分高速ではあります。\nネット回線： auひかり5Gbps\n\nXGのマシンスペック： Core i7メモリ16Gbyte\n仮想環境： ESXi6.7\nネットワークカード： intel X550-T2\nクライアントPC： CeleronG3900という5年前の一般的なクライアントに5GbpsのNIC(Aquantia AQtion 5G Network Adapter)を組み込んだもの\n\n\n\n\niPhone11(iOS14.7.1)、Wi-Fi6(11ax)\n\n\n\n\n仮想環境（ESXi）上にXGをインストールされている方はアップグレードの前に、「VMware ESXiの仮想マシンをバックアップする」を参考に、XGのバックアップを確保される事をお勧めします。\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"Sophos Firewall v18.5 MR-2","url":"/new-technology/2021/12/11/xg-v185-mr2/","content":"\n\nSophos Firewall v18.5 MR-2Sophos Firewall v18.5 MR2が2021年11月29日に発表されました。主としては不具合の解消がメインです。adminユーザーは2要素認証の設定が可能になりました。なお、XG Firewallの最新パッチについては、「VMware ESXiの仮想マシンをバックアップする」の関連リンクを参照してください。\n\n\n主なエンハンスの内容\nIPSec VPNの高速化\nSophos Assistant ファイアウォール設定支援ガイドの提供\nadminユーザーの2要素認証\nDDNSでCloudflareのサポート\n画面応答の高速化（JQueryのバージョンを3.5にアップデート）\n100以上の問題の解決\n\nv18.5 MR-2の詳細な説明はSophos Communityを参照してください。可能な限り迅速にアップグレードするように推奨されています。\n\nhttps://community.sophos.com/sophos-xg-firewall/b/blog/posts/sophos-firewall-v18-5-mr2-is-now-available\n\n\nWe encourage all customers to update their firewall to the latest firmware release to take advantage of these new features, ensure their firewall is performing optimally, and is best protected with the latest security enhancements.\n\n\nこれらの新機能を利用し、ファイアウォールが最適なパフォーマンスを発揮し、最新のセキュリティ強化で最善の保護を受けられるよう、すべてのお客様に最新のファームウェアリリースに更新することをお勧めします。\n\nSophos FirewallのアップデートXGの管理画面にログイン後、左ペインメニューのバックアップ＆ファームウェアのファームウェアの確認ではただちに全てのユーザーにアップデートの案内が来るわけでは無いようなので、アップデートにはMySophosにログインし、バージョンアップの差分モジュールをダウンロードします。\n\nSophosのサイトの右上のプルダウンメニューから、ライセンスとアカウントをクリックします。\nhttps://www.sophos.com/ja-jp.aspx\n\n\nSophos IDをお持ちでなければIDを作成します。\nログイン後、Network Protectionをクリックします。\nファームウェアの更新をクリックします。\n「製品名&#x2F;OSを使った検索」で”ファイアーウォール”を選択し、その後現れるプルダウンは”ソフトウェア”を選択します。\n選択可能なダウンロードを表示ボタンをクリックします。\n\n\n\n\n上記画面で”SFOS 18.5.2 MR2-Build380”というアップデータが表示されますのでダウンロードします。\nMY Sophosはここで終了してXGの管理画面にログインし、左ペインメニューのバックアップ＆ファームウェアのファームウェアのタブメニューから以下の画面に赤丸で囲った矢印のアイコンをクリックし、ダウンロードしたモジュールをアップロードします。\n\n\n\nアップロード＆再起動ボタンをクリックし、MR2へのアップグレードを完了させます。\n\n\n仮想環境（ESXi）上にFirewallをインストールされている方はアップグレードの前に、「VMware ESXiの仮想マシンをバックアップする」を参考に、バックアップを確保される事をお勧めします。\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"Sophos Firewall v18.5 MR-3","url":"/new-technology/2022/03/25/xg-v185-mr3/","content":"\n\nSophos Firewall v18.5 MR-3Sophos Firewall v18.5 MR3が2022年3月24日に発表されました。主としては不具合の解消がメインです。また、v18.5を含みSophos Firewallの脆弱性の情報が提供されています。なお、XG Firewallの最新パッチについては、「VMware ESXiの仮想マシンをバックアップする」の関連リンクを参照してください。\n\n\n主なエンハンスの内容\nOpenSSL(CVE-2022-0778)のサービス拒否の脆弱性を修正\nいくつかの重要なセキュリティ、パフォーマンス、信頼性の向上\nSophosアンチスパムインターフェースに更新された電子メール保護アンチスパムエンジン\n\nv18.5 MR-3の詳細な説明はSophos Communityを参照してください。出来るだけ早く適用するように推奨されています。\n\nhttps://community.sophos.com/sophos-xg-firewall/b/blog/posts/sophos-firewall-v18-5-mr3-is-now-available\n\nSophos FirewallのアップデートXGの管理画面にログイン後、左ペインメニューのバックアップ＆ファームウェアのファームウェアの確認ではただちに全てのユーザーにアップデートの案内が来るわけでは無いようなので、アップデートにはMySophosにログインし、バージョンアップの差分モジュールをダウンロードします。\n\nSophosのサイトの右上のプルダウンメニューから、ライセンスとアカウントをクリックします。\nhttps://www.sophos.com/ja-jp.aspx\n\n\nSophos IDをお持ちでなければIDを作成します。\nログイン後、Network Protectionをクリックします。\nファームウェアの更新をクリックします。\n「製品名&#x2F;OSを使った検索」で”ファイアーウォール”を選択し、その後現れるプルダウンは”ソフトウェア”を選択します。\n選択可能なダウンロードを表示ボタンをクリックします。\n\n\n\n\n上記画面で”SW-18.5.3_MR3-SFW-408”というアップデータが表示されますのでダウンロードします。\nMY Sophosはここで終了してXGの管理画面にログインし、左ペインメニューのバックアップ＆ファームウェアのファームウェアのタブメニューから以下の画面に赤丸で囲った矢印のアイコンをクリックし、ダウンロードしたモジュールをアップロードします。\n\n\n\nアップロード＆再起動ボタンをクリックし、MR3へのアップグレードを完了させます。\n\n\n仮想環境（ESXi）上にFirewallをインストールされている方はアップグレードの前に、「VMware ESXiの仮想マシンをバックアップする」を参考に、バックアップを確保される事をお勧めします。\n\n\nSophos FirewallのCVE-2022-1040Sophosからは、Resolved RCE in Sophos Firewallという記事で2022-03-25に発表されています。これは、リモートコード実行を可能にする認証バイパスの脆弱性であり、SophosファイアウォールのユーザーポータルとWebadminで影響を受けます。\n\nSophos Resolved RCE in Sophos Firewall (CVE-2022-1040) https://www.sophos.com/en-us/security-advisories/sophos-sa-20220325-sfos-rce\n\nただし、このブログで掲載している過去記事、「XG Firewall自身を防御する」で記載の通り、ローカルサービスACLにてWANからのWebadminおよびユーザーポータルからのアクセスが行えない状況にしてあれば、まず安全と言えます。Sophosではこういった脆弱性対策のためにHotFix機能を持っていて、速やかにパッチが自動更新されます。\n\n※SSL-VPNを利用されている方はWANの項目にチェックが入る事は問題ありません。\n\n\nHotFixの確認Firewall本体のコマンドコンソールにアクセスします。XG本体のコンソールまたは、ESXi上にインストールされている方はESXiのコンソールからFirewallのAdminのパスワードを入力し、ログインします。コマンドコンソールからは、5.Device Managementを選択、さらに、3.Advanced Shellを選択します。そして以下のコマンドを実行します。\nSFVH_SO01_SFOS 18.5.3 MR-3-Build408#SFVUNL_SO01_SFOS 18.5.2 MR-2-Build380# test -f /static/up_mode_json_stamp &amp;&amp; echo &quot;Hotfix is applied&quot; || echo &quot;Hotfix isn&#x27;t applied&quot;Hotfix is applied\n\n上記のように”Hotfix is applied”と表示されればHotFixは適用済みです。isn’t appliedとでた場合はしばらく待つかSophosへのインターネットの接続性の確認が必要です。\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"Sophos Firewall v19 MR-1","url":"/new-technology/2022/07/30/xg-v19-mr1/","content":"\n\nSophos Firewall v19 MR-1Sophos Firewall v19 MR-1が2022年7月25日に発表されました。ほとんと微修正で大きなエンハンスではなさそうです。\n\n\n主なエンハンスの内容（8&#x2F;16更新）V19 MR-1の再リリースということで、2022年8月15日に「Sophos Firewall OS v19 MR1 re-release (Build 365) is Now Available」の案内がありました。不具合の緊急対応も含まれるようです。\n\nマルウェアエンジンの64ビット対応\nSophos Assistantオプトアウト機能\n\nv19の詳細な説明はRelease Note（英語）を参照してください。\n\nhttps://docs.sophos.com/releasenotes/index.html?productGroupID=nsg&amp;productID=xg&amp;versionID=19.0\n\nSophos FirewallのアップデートXGの管理画面にログイン後、左ペインメニューのバックアップ＆ファームウェアのファームウェアの確認ではただちに全てのユーザーにアップデートの案内が来るわけでは無いので、アップデートにはMySophosにログインし、バージョンアップの差分モジュールをダウンロードします。\n\nSophosのサイトの右上のプルダウンメニューから、ライセンスとアカウントをクリックします。\nhttps://www.sophos.com/ja-jp.aspx\n\n\nSophos IDをお持ちでなければIDを作成します。\nログイン後、Network Protectionをクリックします。\nファームウェアの更新をクリックします。\n「製品名&#x2F;OSを使った検索」で”ファイアーウォール”を選択し、その後現れるプルダウンは”ソフトウェア”を選択します。\n選択可能なダウンロードを表示ボタンをクリックします。\n\n\n\n\n上記画面で”SW-19.0.1_MR-1.SFW-365.sig”というアップデータが表示されますのでダウンロードします。\nMY Sophosはここで終了してXGの管理画面にログインし、左ペインメニューのバックアップ＆ファームウェアのファームウェアのタブメニューから以下の画面に赤丸で囲った矢印のアイコンをクリックし、ダウンロードしたモジュールをアップロードします。\n\n\n\nアップロード＆再起動ボタンをクリックし、v19 MR-1へのアップグレードを完了させます。\n\n\n仮想環境（ESXi）上にFirewallをインストールされている方はアップグレードの前に、「VMware ESXiの仮想マシンをバックアップする」を参考に、バックアップを確保される事をお勧めします。\n\n"},{"title":"Sophos Firewall v19","url":"/new-technology/2022/04/29/xg-v19/","content":"\n\nSophos Firewall v19Sophos Firewall v19が2022年4月21日に発表されました。\n\n\n主なエンハンスの内容\nSD-WAN（Software Defined-Wide Area Network）の強化\nIPSecに関する高速化（Xstream FastPath acceleration）\nSSLーVPNを含むVPNのエンハンス\nSophos Assistant機能の追加\n\nv19の詳細な説明はSophos Communityを参照してください。\n\nhttps://community.sophos.com/sophos-xg-firewall/b/blog/posts/sophos-firewall-os-v19-is-now-available\n\nSophos FirewallのアップデートXGの管理画面にログイン後、左ペインメニューのバックアップ＆ファームウェアのファームウェアの確認ではただちに全てのユーザーにアップデートの案内が来るわけでは無いので、アップデートにはMySophosにログインし、バージョンアップの差分モジュールをダウンロードします。\n\nSophosのサイトの右上のプルダウンメニューから、ライセンスとアカウントをクリックします。\nhttps://www.sophos.com/ja-jp.aspx\n\n\nSophos IDをお持ちでなければIDを作成します。\nログイン後、Network Protectionをクリックします。\nファームウェアの更新をクリックします。\n「製品名&#x2F;OSを使った検索」で”ファイアーウォール”を選択し、その後現れるプルダウンは”ソフトウェア”を選択します。\n選択可能なダウンロードを表示ボタンをクリックします。\n\n\n\n\n上記画面で”SW-19.0.0_GA.SFW-317.sig”というアップデータが表示されますのでダウンロードします。\nMY Sophosはここで終了してXGの管理画面にログインし、左ペインメニューのバックアップ＆ファームウェアのファームウェアのタブメニューから以下の画面に赤丸で囲った矢印のアイコンをクリックし、ダウンロードしたモジュールをアップロードします。\n\n\n\nアップロード＆再起動ボタンをクリックし、v19へのアップグレードを完了させます。\n\n\n仮想環境（ESXi）上にFirewallをインストールされている方はアップグレードの前に、「VMware ESXiの仮想マシンをバックアップする」を参考に、バックアップを確保される事をお勧めします。\n\n\nVPNの設定VPNも内部的にはバージョンアップはされていますが、ホームユーザーが利用するIPSec VPNやSSLーVPNについて設定ファイルの変更はなく、過去からの物がそのまま利用できます。どちらかといえば、企業向けのサービスとして、サイト間VPNの機能強化を主眼に置いたものになります。管理画面のメニューにおいても、リモートアクセスVPNとサイト間VPNとメニューが分かれるようになりました。\nSophos AssistantSophos Assistantという管理画面操作のアシスタント機能が追加になりました。例えば、サーバーとしてインターネット側からの接続を受け入れる場合は、DNATという機能を使うことになりますが、以下のように「Full configuration: Create DNAT and firewall rules for web servers」という項目を選択すると、まず最初にWebサーバーのIPを定義するところから始めるように促してくれます。\n\n\n\nある程度わかっている人が久々に操作する時には役に立つ機能と思われます。時間があるときに色々調べてみると知らなかった機能など気づきがあるかもしれません。\nAmazon Virtual Private Cloud (Amazon VPC) の対応v19より、AWSのプライベートクラウドに接続する機能が加わっています。自宅オンプレとAWSクラウドとをシームレスにネットワークを接続するハイブリッドクラウドに興味のある方はウォッチしてみてください。\n\nAmazon Web Services VPC support in SFOS v19 https://news.sophos.com/en-us/2022/04/07/amazon-web-services-vpc-support-in-sfos-v19/\n\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"Sophos Firewall v19.5","url":"/new-technology/2022/12/03/xg-v195/","content":"\n\nSophos Firewall v19.5Sophos Firewall v19.5が2022年11月16日に発表されました。\n\n\n主なエンハンスの内容\nSD-WAN Load Balancingの強化\nOSPFv3 (IPv6)の対応\n\nホームユーザーにはあまり関係しない機能でしょうか。\nv19.5の詳細な説明はSophos Communityを参照してください。\n\nhttps://community.sophos.com/sophos-xg-firewall/b/blog/posts/sophos-firewall-v195-is-now-available\n\nSophos FirewallのアップデートXGの管理画面にログイン後、左ペインメニューのバックアップ＆ファームウェアのファームウェアの確認ではただちに全てのユーザーにアップデートの案内が来るわけでは無いので、アップデートにはMySophosにログインし、バージョンアップの差分モジュールをダウンロードします。\n\nSophosのサイトの右上のプルダウンメニューから、ライセンスとアカウントをクリックします。\nhttps://www.sophos.com/ja-jp.aspx\n\n\nSophos IDをお持ちでなければIDを作成します。\nログイン後、Network Protectionをクリックします。\nファームウェアの更新をクリックします。\n「製品名&#x2F;OSを使った検索」で”ファイアーウォール”を選択し、その後現れるプルダウンは”ソフトウェア”を選択します。\n選択可能なダウンロードを表示ボタンをクリックします。\n\n\n\n\n上記画面で”SW-19.5.0_GA.SFW-197.sig”というアップデータが表示されますのでダウンロードします。\nMY Sophosはここで終了してXGの管理画面にログインし、左ペインメニューのバックアップ＆ファームウェアのファームウェアのタブメニューから以下の画面に赤丸で囲った矢印のアイコンをクリックし、ダウンロードしたモジュールをアップロードします。\n\n\n\nアップロード＆再起動ボタンをクリックし、v19.5へのアップグレードを完了させます。\n\n\n仮想環境（ESXi）上にFirewallをインストールされている方はアップグレードの前に、「VMware ESXiの仮想マシンをバックアップする」を参考に、バックアップを確保される事をお勧めします。\n\n\nRelase Notesを見るとセキュリティ観点ではOpenSSL (CVE-2022-1292)の脆弱性対応が行われています。他にもかなりの数の不具合が修正されていますが、コメントがサラッとしており、どういう事象なのかまでは判明しないものが多いようです。\nIPSec-VPN、SSL&#x2F;TLSインスペクション、マルウェアチェック（EICAR Testファイル）などを検証し、2週間程度運用していますが、スループット含めて特段の問題は見つかっていません。\n（2022-12-11追記）SophosからSophos Firewallのv19以前の脆弱性について12-06にレポートが公開されています。以下の脆弱性に対応したものであり、v19以前のユーザーはv19.5にアップグレードが必要との事です。CVE-2022-3236CVE-2022-3226CVE-2022-3713CVE-2022-3696CVE-2022-3709CVE-2022-3711CVE-2022-3710\n\nSophos Firewall v19.5 GA Resolves Security Vulnerabilities https://www.sophos.com/en-us/security-advisories/sophos-sa-20221201-sfos-19-5-0\n\n大幅に機能が更新されていないにも関わらず、v19からv19.5となり、リリースノートでの表現も控え目で何が変わったのか良くわかりませんでしたが結局のところ脆弱性の対応が中心ということですね。\n私は「XG Firewall自身を防御する」の記事で、そもそもFirewall自身を守るためのセキュアな設定が必要と記載しており、パッチやバージョンアップを速やかに実施することも必要ですが、セキュアな環境のために追加の設定をお勧めしています。\n過去からの経緯を見ていると、v18で大きくアーキテクチャが変更になったものの、管理画面を中心とした機能は大きな変更が行われていません。過去からの脆弱性、特にUI周りのクロスサイトスクリプティング、およびDBアクセス機能におけるSQLインジェクションのサニタイズが不十分であり、指摘されては都度修正しているという活動を繰り返しているように見えます。ユーザー側の自主的な防御として、余計な機能はインターネット向けには提供しない事をお勧めします。つまりSophos Firewallの管理画面や入力項目を持つユーザーポータルはLANからのアクセスのみに限定すべきで、WAN、DMZはもちろん、可能であればVPNからもアクセス不可にしておく事をお勧めします。今回のエンハンスでSQLインジェクションなどが全て撲滅されたかどうかは不明です。\n\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"Sophos Firewall v19.5 MR-1","url":"/new-technology/2023/02/23/xg-v195mr1/","content":"\n\nSophos Firewall v19.5 MR1Sophos Firewall v19.5 MR1が2023年2月15日に発表されました。\n\n\n主なエンハンスの内容Home Editionとしてはバグフィックスのみで機能向上はなさそうです。新機能が無いのは少し寂しいですが、安定性はv19以降でかなり向上したと感じます。\nv19.5 MR1の詳細な説明はRelease Notesを参照してください。\n\nhttps://docs.sophos.com/releasenotes/index.html?productGroupID=nsg&amp;productID=xg&amp;versionID=19.5\n\nSophos FirewallのアップデートXGの管理画面にログイン後、左ペインメニューのバックアップ＆ファームウェアのファームウェアの確認ではただちに全てのユーザーにアップデートの案内が来るわけでは無いので、アップデートにはMySophosにログインし、バージョンアップの差分モジュールをダウンロードします。\n\nSophosのサイトの右上のプルダウンメニューから、ライセンスとアカウントをクリックします。\nhttps://www.sophos.com/ja-jp.aspx\n\n\nSophos IDをお持ちでなければIDを作成します。\nログイン後、Network Protectionをクリックします。\nファームウェアの更新をクリックします。\n「製品名&#x2F;OSを使った検索」で”ファイアーウォール”を選択し、その後現れるプルダウンは”ソフトウェア”を選択します。\n選択可能なダウンロードを表示ボタンをクリックします。\n\n\n\n\n上記画面で”SW-19.5.1_MR-1.SFW-278.sig”というアップデータが表示されますのでダウンロードします。\nMY Sophosはここで終了してXGの管理画面にログインし、左ペインメニューのバックアップ＆ファームウェアのファームウェアのタブメニューから以下の画面に赤丸で囲った矢印のアイコンをクリックし、ダウンロードしたモジュールをアップロードします。\n\n\n\nアップロード＆再起動ボタンをクリックし、v19.5へのアップグレードを完了させます。\n\n\n仮想環境（ESXi）上にFirewallをインストールされている方はアップグレードの前に、「VMware ESXiの仮想マシンをバックアップする」を参考に、バックアップを確保される事をお勧めします。\n\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"Sophos Firewall v19.5 MR-3","url":"/new-technology/2023/08/20/xg-v195mr3/","content":"\n\nSophos Firewall v19.5 MR3Sophos Firewall v19.5 MR3が2023年8月2日に発表されました。\n\n\n主なエンハンスの内容MR3では65以上のパフォーマンスおよび安定化・セキュリティ向上に対応しています。また、今後、リモートアクセス製品であるZTNAのセキュアアクセスに対応させる予定とのこと。私の所感としては、これまでのSophos FirewallのVPNではそれなりに便利に活用していますが、ZTNAで透過的にリモートアプリケーションが利用できるようになるとの事であれば期待が持てます。但し、ZTNAの導入にはSophos Centralが必要であること（無料）、ZTNAの価格についてホームユーザーの扱いがどうなるかはまだ判明しないように見えます。システム構成としてはActive Directoryとの統合連携など法人向けには必須の要件が含まれているので、ホームユーザーからは少し遠い存在になってしまうかもしれません。\nv19.5 MR3の詳細な説明はRelease Notesを参照してください。\n\nhttps://docs.sophos.com/releasenotes/index.html?productGroupID=nsg&amp;productID=xg&amp;versionID=19.5\n\nIpsec-VPNでSSL&#x2F;TLSインスペクションが動作しないという不具合の改善も含まれています。\nSophos FirewallのアップデートXGの管理画面にログイン後、左ペインメニューのバックアップ＆ファームウェアのファームウェアの確認に通知が来る場合があります(以下はMR-2の画面です)。\n\n\nまた、アップデートの案内が来ていなくても、MySophosにログインし、バージョンアップの差分モジュールをダウンロードします。\n\nSophosのサイトの上部の「ソフォスについて」のプルダウンメニューから、ライセンスとアカウントをクリックします。\nhttps://www.sophos.com/ja-jp.aspx\n\n\nSophos IDをお持ちでなければIDを作成します。\nログイン後、Network Protectionをクリックします。\nFirmware Updatesをクリックします。\n「製品名&#x2F;OSを使った検索」で”Firewall”を選択し、その後現れるプルダウンは”Software”を選択します。\nShow Available Downloadsボタンをクリックします。\n\n\n\n\n上記画面で”SW-19.5.3_MR-3.SFW-652.sig”というアップデータが表示されますのでダウンロードします。\nMY Sophosはここで終了してXGの管理画面にログインし、左ペインメニューのバックアップ＆ファームウェアのファームウェアのタブメニューから以下の画面に赤丸で囲った矢印のアイコンをクリックし、ダウンロードしたモジュールをアップロードします。\n\n\n\nアップロード＆再起動ボタンをクリックし、v19.5 MR3へのアップグレードを完了させます。\n\n\n仮想環境（ESXi）上にFirewallをインストールされている方はアップグレードの前に、「VMware ESXiの仮想マシンをバックアップする」を参考に、バックアップを確保される事をお勧めします。\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"Sophos Firewall v20","url":"/new-technology/2023/11/12/xg-v20/","content":"\n\nSophos Firewall v20Sophos Firewall v20が2023年11月06日に発表されました。個人向けとしては、IPv6 DHCP Prefix Delegationのサポートがなされています。\n\n\n主なエンハンスの内容\nIPv6 DHCP Prefix Delegation\nIPv6 BGPv6\nSynchronized Securityの強化\nVPN管理の強化\n\nv20の詳細な説明はSophos Communityを参照してください。\n\nhttps://community.sophos.com/sophos-xg-firewall/b/blog/posts/sophos-firewall-v20-is-now-available\n\nリリースノートはこちらです\n\nhttps://docs.sophos.com/releasenotes/index.html?productGroupID=nsg&amp;productID=xg&amp;versionID=20.0\n\nSophos FirewallのアップデートXGの管理画面にログイン後、左ペインメニューのバックアップ＆ファームウェアのファームウェアの確認でアップデートの案内が順次来ます。個別にバージョンアップのファイルを入手するには、以下のURLからダウンロードします。\nhttps://support.sophos.com/support/s/article/KB-000043162?language=ja\n\n上記画面でファームウェアのソフトウェアのLinkをクリックします。\n“SW-20.0.0_GA.SFW-222.sig”をダウンロードします。\nSophos Firewallの管理画面にログインし、左ペインメニューのバックアップ＆ファームウェアのファームウェアのタブメニューから以下の画面に赤丸で囲った矢印のアイコンをクリックし、ダウンロードしたモジュールをアップロードします。\n\n\n\nダウンロードしたファームウェアを指定します。\n\n\nアップロード＆再起動ボタンをクリックし、v20へのアップグレードを完了させます。\nauひかりのIPv6 DHCP Prefix　DelegationようやくIPv6のPrefix委任が使えるようになりました。これは日本だけではなく、世界のホームユーザーからしても待ち望んでいた対応です。これでSophos FirewallのIPv6での苦肉の策である、ULAからIPv6NATという方式から解放されます。ただ個人的には、私の利用しているauひかりの場合残念ながらPrefix Delegationが使えません。いや、正確には64ビットのサブネットが1つだけ割り振られるようではあるのですが、本来、Prefix Delegationは60ビットや56ビットなどの複数のサブネットを受け取り、個々のネットワークに割り当てることになりますから、1つだけあるというのは正規のDelegationという意味合いも少し違います。\nとはいえ、auひかり以外のユーザーのために中身を確認していきます。\nネットワークの設定からWANを選び、モードは手動にしてDHCPプレフィックスの委任を選択します。\n\n\n優先する委任プレフィックスはホームユーザーは固定IPで予め指定されたPrefixがあるわけでは無いので設定せずOFFのままで構いません。法人の場合など、固定IPv6を保有する場合、Prefixと委任されるレングスとを入力しますが、デフォルトでは空です。私の場合、4バイト目でauひかりから1を貰っていたので、16ビット分のサブネットが使えるかもしれないと試行錯誤で設定しましたが、その情報が消せずに残っています。\n\n続いて、LANの設定です。\n\n\nここでは、IPの割り当てに委任を選びます。続いて、アップストリームのインターフェースとして、WANであるPort2を選びます。auひかりでは、ISP は、IPv6 プレフィックスを委任していませんと警告メッセージが表示されてしまいますが、NTT系などでは56ビットのPrefix委任が行われ設定が可能となるはずです。この中でLANに任意の64ビットのネットワークを割り当てることになります。\n余談ですが、Sophos Firewallv20のEarly Accessプログラムで私は事前検証していたのですが、Sophos Firewallでは&#x2F;48, &#x2F;52, &#x2F;56, そして &#x2F;60がサポートされ、それ以外はサポートされないというSophos側からの回答でした。\n実はEarly Accessのv20ではもう少し挙動が異なり、64ビットは受け取れていました。Sophosの話ではありませんが、Ubiquiti関係のコミュニティでもauひかりからIPv6のDHCPv6-PDは出来ない事もないという情報共有もあり64ビット１つは割り当て可能という事実は認識していました。\n\n\nauひかりのWANのPrefixの4バイト目は”1”であり、LANのDelegationで確認したPrefix4バイト目は”2”でした。せめてサブネット１つだけでもIPv6 Delegationが出来ればと思いましたが、残念ながら製品版では、エラーチェックが強化された上で&#x2F;64は排除されてしまいました。\nいっそのこと気前よく&#x2F;48くらい割り当てて貰えないかなと思いつつ、一応auひかりのサポート窓口にDHCPv6 Delegationに対応してほしいという要望は出しておきました。\nアクティブな脅威対応Firewallの左ペインメニューではアクティブな脅威対応というメニューがあります。ここでは2種類の脅威対応があります。１つは名称変更でATP (Advanced Threat Protection) という旧機能がSophos X-Ops 脅威フィードに名称が変更されています。過去、ログを見ても殆どこのATPに関するログは見ることはありませんでした。\nもう1つは、MDR脅威フィードという機能です。外部の MDR アナリストがネットワークの脅威フィードを特定し、自動的にファイアウォールにプッシュし、複数のファイアウォールモジュールが、これらのフィードに基づいてトラフィックをブロックするとのことです。\nこの２つの機能はログでもアクティブな脅威対応という項目で確認できます。\n仮想環境（ESXi）上にFirewallをインストールされている方はアップグレードの前に、「VMware ESXiの仮想マシンをバックアップする」を参考に、バックアップを確保される事をお勧めします。\n\n\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"Sophos Firewall v19.5 MR-2","url":"/new-technology/2023/05/16/xg-v195mr2/","content":"\n\nSophos Firewall v19.5 MR2Sophos Firewall v19.5 MR2が2023年5月8日に発表されました。\n\n\n主なエンハンスの内容MR2ではセキュリティ向上と4,000のマルチキャストグループのルーティングに対応しています。ホームユーザーにとって新機能が無いのは少し寂しいですが、安定性はv19以降でかなり向上しています。WANセグメントに管理画面を開放している場合、ACLで厳格にアクセスリストを求められるようになります。部門のFirewallを想定しているのかもしれませんね。個人ではWANに管理画面を開放するようなことはありませんが。。。\nv19.5 MR2の詳細な説明はRelease Notesを参照してください。\n\nhttps://docs.sophos.com/releasenotes/index.html?productGroupID=nsg&amp;productID=xg&amp;versionID=19.5\n\nSophos FirewallのアップデートXGの管理画面にログイン後、左ペインメニューのバックアップ＆ファームウェアのファームウェアの確認に通知が来る場合があります。\n\n\nまた、アップデートの案内が来ていなくても、MySophosにログインし、バージョンアップの差分モジュールをダウンロードします。\n\nSophosのサイトの上部の「ソフォスについて」のプルダウンメニューから、ライセンスとアカウントをクリックします。\nhttps://www.sophos.com/ja-jp.aspx\n\n\nSophos IDをお持ちでなければIDを作成します。\nログイン後、Network Protectionをクリックします。\nFirmware Updatesをクリックします。\n「製品名&#x2F;OSを使った検索」で”Firewall”を選択し、その後現れるプルダウンは”Software”を選択します。\nShow Available Downloadsボタンをクリックします。\n\n\n\n\n上記画面で”SW-19.5.2_MR-3.SFW-624.sig”というアップデータが表示されますのでダウンロードします。\nMY Sophosはここで終了してXGの管理画面にログインし、左ペインメニューのバックアップ＆ファームウェアのファームウェアのタブメニューから以下の画面に赤丸で囲った矢印のアイコンをクリックし、ダウンロードしたモジュールをアップロードします。\n\n\n\nアップロード＆再起動ボタンをクリックし、v19.5 MR2へのアップグレードを完了させます。\n\n\n仮想環境（ESXi）上にFirewallをインストールされている方はアップグレードの前に、「VMware ESXiの仮想マシンをバックアップする」を参考に、バックアップを確保される事をお勧めします。\n\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"Sophos Firewall v20 MR1","url":"/new-technology/2024/06/08/xg-v20mr1/","content":"\n\nSophos Firewall v20Sophos Firewall v20 MR1が2024年05月15日に発表されました。デバイスからのアクセス制御でAD SSO, Captive Portal, RADIUS SSO, Client Authentication, Chromebookなどの認証制御が細かく設定できること、VPNのエンハンスが挙げられます。 \n\n\nv20　MR1の詳細な説明はSophos Communityを参照してください。\n\nhttps://community.sophos.com/sophos-xg-firewall/b/blog/posts/sophos-firewall-os-v20-mr1-is-now-available\n\nリリースノートはこちらです\n\nhttps://docs.sophos.com/releasenotes/index.html?productGroupID=nsg&amp;productID=xg&amp;versionID=20.0\n\nSophos Firewallのアップデート管理画面にログイン後、左ペインメニューのバックアップ＆ファームウェアのファームウェアの確認でアップデートの案内が順次来ます。\n\n\n個別にバージョンアップのファイルを入手するには、以下のURLからダウンロードします。\nhttps://support.sophos.com/support/s/article/KB-000043162?language=en_US\n\n上記画面でSophos FirewallのファームウェアのソフトウェアのLinkをクリックします。\n“SW-20.0.1_MR-1.SFW-342.sig”をダウンロードします。\nSophos Firewallの管理画面にログインし、左ペインメニューのバックアップ＆ファームウェアのファームウェアのタブメニューから以下の画面に赤丸で囲った矢印のアイコンをクリックし、ダウンロードしたモジュールをアップロードします。\n\n\n\nアップロード＆再起動ボタンをクリックし、v20 MR1へのアップグレードを完了させます。\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"Sophos Firewall v20 MR2","url":"/new-technology/2024/08/25/xg-v20mr2/","content":"\n\nSophos Firewall v20Sophos Firewall v20 MR2が2024年07月23日に発表されました。異なるFirewallへの移行を意図したバックアップ、レストアの機能が実装されています。\n\n\nv20　MR2の詳細な説明はSophos Communityを参照してください。\n\nhttps://community.sophos.com/sophos-xg-firewall/b/blog/posts/sophos-firewall-os-v20-mr2-is-now-available\n\nリリースノートはこちらです\n\nhttps://docs.sophos.com/releasenotes/index.html?productGroupID=nsg&amp;productID=xg&amp;versionID=20.0\n\n\nSafeSearch、YouTubeの制限、Google Appのログインドメインの制限、およびAzure ADテナントの制限を強制する際に、システム負荷を軽減してWeb保護のパフォーマンスを強化しました。\n45以上の重要なパフォーマンス、信頼性、安定性、セキュリティの修正を解決します。\n\nSophos Firewallのアップデート管理画面にログイン後、左ペインメニューのバックアップ＆ファームウェアのファームウェアの確認でアップデートの案内が順次来ます。以下はv20 MR1のものですが、ここでMR2の表示がなされます。\n\n\n個別にバージョンアップのファイルを入手するには、以下のURLからダウンロードします。\nhttps://support.sophos.com/support/s/article/KBA-000007972?language=ja\n\n上記画面でSophos FirewallのファームウェアのソフトウェアのLinkをクリックします。\n“SW-20.0.2_MR-2.SFW-378.sig”をダウンロードします。\nSophos Firewallの管理画面にログインし、左ペインメニューのバックアップ＆ファームウェアのファームウェアのタブメニューから以下の画面に赤丸で囲った矢印のアイコンをクリックし、ダウンロードしたモジュールをアップロードします。\n\n\n\nアップロード＆再起動ボタンをクリックし、v20 MR2へのアップグレードを完了させます。\n数年間利用しているSophos Firewallですが、特段の問題なく、仮想環境（ESXi8）配下で安定して稼働しています。そういえば、Sophos Firewallのセットアップに関する私の記事はESXi前提で、現時点でのホームユーザー向けにはProxmox向けの手順を改めて記載すべきと認識しています。但し、Proxmox上のSophos Firewallのセットアップは特段苦労することもありませんので、興味のある方はチャレンジしてみてください。\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"Sophos Firewall v21でLet's Encrypt™️と3rdパーティ脅威情報を使う","url":"/new-technology/2024/10/27/xg-v21/","content":"\n\nSophos Firewall v21Sophos Firewall v21が2024年10月17日に発表されました。今回はビジネスユーザーはもちろん、ホームユーザーにとっても大きな進化がありました。Let’s Encryptの自動更新を含む対応と3rdパーティの脅威情報（こちらも自動更新）を取り込め、積極的な通信遮断を行えるようになっています。\n\n\nv21の詳細な説明はSophos Communityを参照してください。\n\nhttps://community.sophos.com/sophos-xg-firewall/b/blog/posts/sophos-firewall-v21-is-now-available\n\nリリースノートはこちらです\n\nhttps://docs.sophos.com/releasenotes/index.html?productGroupID=nsg&amp;productID=xg&amp;versionID=21.0\n\nSophos Firewallのアップデートさて、最初にSophos Firewallのアップデート方法について記載します。\n管理画面にログイン後、左ペインメニューのバックアップ＆ファームウェアのファームウェアの確認でアップデートの案内が順次来ます。直ちにファームウェアのアップグレードの案内が来るわけでは無さそうです。ファームウェア公開後すぐの場合は個別にバージョンアップのファイルを入手します。\n個別にバージョンアップのファイルを入手するには、以下のURLからダウンロードします。\nhttps://support.sophos.com/support/s/article/KBA-000007972?language=ja\n\n上記画面でSophos FirewallのファームウェアのソフトウェアのLinkをクリックします。\n“SW-21.0.0_GA.SFW-169.sig”をダウンロードします。\nSophos Firewallの管理画面にログインし、左ペインメニューのバックアップ＆ファームウェアのファームウェアのタブメニューから以下の画面に赤丸で囲った矢印のアイコンをクリックし、ダウンロードしたモジュールをアップロードします。\n\n\n\nアップロード＆再起動ボタンをクリックし、v21へのアップグレードを完了させます。\nLet’s EncryptLet’s Encrypt は、非営利団体のInternet Security Research Group(ISRG)が提供する認証局でTLS暗号用の証明書を無償で提供しています。ただし、有効期限が90日と短めで頻繁に証明書の再生成が必要です。\nSophos Firewallの画面上にアクセスする際に独自ホスト名やそもそもIPアドレスでのアクセスをしているとユーザーに対する警告メッセージを表示する際に証明書エラーと表示されてしまいます。自分だけが利用するなら無視もできますが、家族で使ってもらっていてエラーの度に証明書エラーで不安にさせては本末転倒です。\nSophos Firewallの広告ブロック時のお馴染みの画面です。既にLet’s Encryptの証明書が有効になっていますが、この一手間を掛けないとコンテンツブロック時にブラウザに証明書エラーの表示がされてしまいます。\n\n\n生成にはLet’s Encrypt独自のお作法があり、正当なネームサーバーの管理下にサーバーが実在していることが求められます。そこにISRGからインターネットで接続可能な状態になければなりません。これはいくつかの方法がありますが、よく利用されるケースでは、 ISRGから提供される証明書生成ツールを使い、そのサーバー上にWebサーバープロセスを立ち上げ、ISRGからのリクエストに応答するというものです。ISRGがWebサーバーに到達できることが確認できたら証明書を生成してくれます。\n結局、ホームユーザーはこれをするために、ダイナミックDNS（DDNS）の契約や個別ドメインを契約したり、Let’s Encryptが面倒ということで有償の独自SSL&#x2F;TLSを取得したりして手間とコストが掛かっていました。私の場合は、NO-IPで無償DDNSを利用し、Sophos FirewallでパブリックIPアドレスの自動更新をさせていました。そして90日に一度、手作業でLet’s Encryptのスクリプトを起動させて証明書を更新していました。\nその際の手順としては、UbuntuでLet’s Encryptスクリプトを起動し、Sophos FirewallではDNAT（Destination NAT）を手動設定し、 InternetからFirewallのPort80に着信したら、Ubuntuに振り向けるようにしていました。さらにUbuntuで証明書が出来たら一旦、クライアントに証明書セットをダウンロードし、それをFirewallにアップロードしていました。生産性としては今ひとつです。SynologyのNASなどは全自動でやってくれますね。\nこれがv21からは最初に設定さえしておけば、Let’s Encryptの期限が来ると自動更新までやってくれ、とても便利です。Webサーバーを立ち上げていらっしゃる方はIDS&#x2F;IPS代わりにSophos Firewall上でTLS暗号化されたPort443として受信し、リクエストを内部のWebサーバー(http)に転送することで、WebサーバーのTLS&#x2F;SSL証明書の取得の手間を省くことも容易です。\nFirewall上でのLet’s Encryptの設定まず管理者画面にログイン後、左ペインの証明書のメニューに入ります。新しく「Let’s Encrypt™️」のタブが新たに登場していますのでそのタブを選択します。\n\n\nアカウントの登録ボタンをクリックし、登録が完了します。\n\n続いて証明書のタブに戻ります。\n以下のようにアクションではLet's Encrypt証明書のリクエストを選択し、ドメインの箇所にはDDNSまたはDNSのAレコードとして登録されたホスト名＋ドメイン名（いわゆるFQDN）を登録し、ホスト型アドレスの場所はWANのPortを指定します。\n\n\nこれで保存すると、証明書の生成が行われます。\n登録が終わったら左ペインの管理のメニューから管理者とユーザーの設定の管理コンソールとエンドユーザー間の操作の証明書にLet’s Encryptの証明書を指定します。\n\n\n別のホスト名を指定するの場所で生成した今回のサーバー名（FQDN）を指定します。\n\nなお、Firewallのコンソール（Advanced Shell）から、/log/letsencrypt.log、/log/applog.logでログを確認できます。以下は、letsencrypt.logの結果です。\n\n\nとっても簡単ですね。Firewallの上位にホームゲートウェイ（HGW）がある方は、HGWがInternetからPort80の着信の際にはSophos FirewallのWAN側IPアドレスに転送することを忘れないでください。\nSophosから、これらを動画にしたものが提供されています。\n\nSophos Firewall v21:Let’s Encrypt™️ https://techvids.sophos.com/watch/guYyvqKk6ciCkG1A2eHXoR\n\n3rdパーティの脅威情報を活用するこれまでもSophos Firewallには2種類の脅威フィードが実装されていました。無償のSophos X-Ops脅威フィードと有償のMDR脅威フィードです。セキュリティベンダーはここの情報の鮮度が売りであり、セキュリティビジネスとしてはここの情報がまさに「金の成る木」でしょうか。MDRを契約されている法人ユーザーであれば十分なのかもしれませんが、業界の情報共有などがあるケースもあり、3rdパーティの情報を取り込め、更新される都度、自動で定期的に取り込める機能が付いたのは価値が大きいです。\nSophos Firewallではマルウェアとして定義された情報がWebポリシーで防御出来たり、ProxyやVPNなどはアプリケーションフィルタでそれなりに未然防御は出来ます。\n個人が無償で高度なセキュリティ情報が得られるほど甘くはありませんが、それでもリスクを減らすことはできるので前向きに考えたいところです。\nSophos Firewallに取り込める3rdパーティの脅威情報をここでいくつか紹介していきます。\nGreyNoiseGreyNoiseはインターネット上で悪意あるスキャンや攻撃を行っているIPアドレスを特定し、その活動に関する情報を収集・分析することを支援する脅威インテリジェンスを提供するプラットフォームです。\n\n\nGreyNoiseはWebUIとAPIで使う方法があります。WebUIは以下のURLです。\n\nGrey Noise Web UI https://viz.greynoise.io/\n\n本日の情報を見てみると国別で多い順にブラジル、中国、インド、アメリカ、ロシアと続きますね。\n\n\nブラジルはオリンピックでサイバー攻撃が増えてしまったようですね。ホームユーザーにとってはロシアと中国は殆どアクセス不要だと考えればFirewallの国別フィルタでガッサリとブロックしてしまうのもアリだと思います。左下を見ていくと、最も活動が多いのはクローラー（巡回）で脆弱性を探すタイプですね。ホームユーザーは無闇にポートを解放せず、脆弱性の無いVPNで守っておけば特にクローラー系は怖くはありません。\nホームユーザーからしてもクローラーやIoTを狙うボットなど、きちんとパッチを当てることに加え、VLANを切ってIoTは別セグメントにしておけば、個人の情報資産が脅かされるリスクは低いですが、取り敢えずこの画面の左下で目につくMiraiについては有名どころですし、クライアントがアクセスした際に感染するリスクがありますからこれは防御しておいても損はありません。Miraiはマルウェアとして活動していて、毎時6,000件の活動が見られるようです。\n\nMiraiについて IoT機器に感染した機器同士を連携させて１つの攻撃対象に一斉攻撃を仕掛ける体制（ボットネット）を作成します。攻撃者は外部のC&amp;Cサーバーから、そのボットネットに指示を出すことでDDoS（Distributed Denial of Service attack）攻撃を行います。\n\nIoTの攻撃よりもランサムウェアの方が個人にとっては脅威です。今回はMiraiを対象にしましたが、今後定期的に見直しをしていくつもりです。\n\n\nGreyNoiseはサインアップすると、1つのタグだけは無償でFirewallに取り込むことができます。BLOCKLIST URLの右側のコピーアイコンをクリックするとAPIのパスが取得できます。\nサインアップhttps://viz.greynoise.io/signup\nCrowdSecCrowdSecも同様にセキュリティベンダーです。コミュニティにも理解があり、無償のセキュリティエンジンなどを提供しています。しかしこちらもやはり価値のあるブロックリストは有償が基本であってコミュニティベースで寄せられた情報のみがコミュニティに無償で提供されます。\n\n\nアカウントを作成、ログインしてから左上のBlockListsを選択すると、BlockListのカタログを選択することになります。Freeで絞り込むとTorのBlockListカタログなどを見つけられます（Proxyといっても差し支えありませんが、Torが頻繁に更新されることを考えると価値はあるでしょう）。タイミングによってでしょうけれども、CrowdSecが提供しているPHPの脆弱性（CVE-2024-4577）に対応したカタログなどがFreeとして公開されていますね。これは最近、日本国内の某フードデリバリーの企業でも問題になったマイニングマルウェアのRedTailが該当しますね。\n\n\n\nTorについて 通信の秘匿性を担保するために作られた技術ですが、現在はサイバー攻撃などを中心にダークウェブへのアクセス手段として利用されています。善良な民間人は興味本位で近づかないことをお勧めします。\n\n サインアップ https://app.crowdsec.net/signup\nブロックリストの購読ブロックリストの購読をした後（最大３つ）、インテグレーションを行い、Sophos Firewallに取り込み準備をします。\n\n\nBlocklists→Integrations→Add Integrationと進みます。\n\nWhere do you want to use blocklists?と聞かれますので、Sophosを選択します。続いてCreateボタンをクリックして生成します。\n以下のようにダイアログが表示されますのでこれを後述するSophos Firewallの設定でコピーペーストして設定を完了させることになります。\n\n\nその他その他はURLhausやDigitalSide Threat-Intelといったコミュニティベースの情報をFirewallに取り込めます。\n\nURLhaus https://urlhaus.abuse.ch\n\n\nDigitalSide Threat-Intel https://osint.digitalside.it/ \n\nここでは詳細説明を割愛します。これら２つはサインアップ不要で脅威フィードを公開しています。そのレベルとしては、MicrosoftのEdgeブラウザで提供されているスマートスクリーン相当とお考えください。それでもSophos Firewall単体で取りこぼすケースもカバーしています（無論、古すぎる情報で無視して良いものもたくさんあります）。\nFirewallに3rdパーティの脅威情報を取り込むFirewallの左ペインメニューからアクティブな脅威対応を選択します。\n\n\nサードパーティの脅威フィードは、ブロックと監視対象との2種類があります。前述したOSINTなどは数も多いので一旦は監視対象にしていきなりブロックはせずに様子を見る事もできます。\nここで追加ボタンをクリックして前述した3rdパーティの脅威情報を取り込みます。\n\n\nアクションは前述したブロックかモニタを選択します。\n\nインジケータの種類は、Grey NoiseやCrowdSecはIPv4アドレスを指定します。その他の脅威フィードではドメインやURLを指定する場合もあります（私は、URL_HausとOSINTではURLを指定しています）。\n\n外部URLは、Grey Noise、CrowdSecで指定されたURL（APIのパス）を指定します。\n\n承認は認証の有無です。GreyNoiseは認証無し、CrowdSecは前述したようにインテグレーションしたIDとパスワードを指定します。\n\nポーリング間隔は、GreyNoiseは1時間を、CrowdSecはCommunityユーザーは2時間に1度のフェッチが（今の所）認められているので、6時間を指定します。\n\n私の場合、これら４つの脅威情報を取り込み、現時点では11,362IPアドレス、46722URLが登録されています。\n脅威情報の留意点前述したようにSophos FirewallでIPアドレスは取り込めますが、現時点ではIPアドレスはIPv4のものだけであることに注意が必要です。\nまた、URLで取り込む場合、これはURLhaus、OSINTなどがURLで提供してくれていますが、サイトがhttps（SSL&#x2F;TLS）の場合はURLも暗号化されていますからSSL&#x2F;TLSインスペクションの機能が必要になります。すなわち、SSL&#x2F;TLSインスペクションの対応クライアント（Fierwallの自己証明書をクライアントに取り込めている場合）のみがURLのブロックが行えることに注意する必要があります。私の環境では、Apple製品（iOS,iPad,macbook）、Windows、Linux（Ubuntu）で動作確認しています。Android、ChromeBook、IoTはSSL&#x2F;TLSインスペクションは利用できません。\nSSL&#x2F;TLSインスペクションについては、以下の記事で解説、またSophos Firewallでの具体的な設定についてまとめています。それなりに手間が掛かることになりますから、面倒な方はURLではなく、IPアドレスで取り込む方法でも代替にはなります（IPv6は対象となりませんが）。\n\nSSLインスペクションについて\nXG Firewall v18のSSL&#x2F;TLSインスペクションの設定\nXG Firewall v18のSSLインスペクションの動作確認と調整\n\nログ出力Firewallのログにもアクティブな脅威対応のフィルタが追加されています。\n\n\nこれらのように、httpsであっても検出できていることやDrop、Alertという区別がついています。OSINT、URL_Hausともに重複して検知しているケースも確認できます。\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"Sophos Firewall v21.5","url":"/new-technology/2025/05/31/xg-v215/","content":"\n\nSophos Firewall v21.5Sophos Firewall v21.5が2025年5月29日に発表されました。VPNのスケーラビリティの向上、その他の機能向上として、ホームエディションのRAM制限の撤廃、DHCPプレフィックス委任緩和（&#x2F;48〜&#x2F;64のプレフィックスに対応）が挙げられます。無償のホームユーザーに対しても積極的な機能提供が行われています。\n\n\nv21.5の説明と新機能v21.5の詳細な説明はSophos Communityを参照してください。\n\nhttps://community.sophos.com/sophos-xg-firewall/b/blog/posts/sophos-firewall-v21-5-is-now-available\n\nリリースノートはこちらです\n\nhttps://docs.sophos.com/releasenotes/index.html?productGroupID=nsg&amp;productID=xg&amp;versionID=21.5\n\nNDR EssentialsというSSL&#x2F;TLSインスペクション無しにリスクを判定する新機能が加えられていますが、ホームエディションでは今の所使えません。DNS Protectionという機能も追加されていますが、ホームユーザーは使えるようにはなっていないようです。また、Sophos Communityによれば、VPNの新しいWindows向けクライアントが6月初旬に発表されるようです。\nRAM制限の撤廃これまでCPU4コア、メモリ6GBの制限がありましたが、メモリの制限が撤廃となりました。これはv21の状態においても再起動するだけでロックが解除されるようになっています。CPUの上限は4つのまま、変わらずです。\nDHCPプレフィックス委任IPv6は2023年11月のv20より、Prefix Delegationに対応しています。私のISPはauひかりですが、これは&#x2F;64のPrefix Delegationとなっており、Sophos Firewallはこの&#x2F;64には対応していませんでした。よって、私はIPv4同等にIPv6サイトにアクセスするために、NAT6での対応を行なっていました。私が使っているネットワーク機器のUbiquiti製品のゲートウェイは&#x2F;64のPrefix Delegationに対応できていますが、やはり私が求めているのはビジネスグレードのセキュリティゲートウェイなので、Sophos Firewallは外せません。auホームゲートウェイ（HGW）→UniFiゲートウェイ→Sophos Firewallというのはちょっとやりすぎですね。Linux、FreeBSDでルーターを作る上級者の方はもちろん、NAT6で稼働しているケースは少なくないと思います。内部はユニークローカルアドレス（ULA）を割り当て、InternetへのアクセスはNAT6の構成で運用上の不都合は全くありません。また、LANの内部のIPv6アドレスが変わるというのは思いの外、管理が大変です。DHCPを使いIPv4とIPv6とでアドレスの末尾の数字を合わせておけば、ULAは例えば、fd12:3456:x::1/128と記述でき、Prefixで途中の0が省略できますから、IPv6アドレス自体も短く、Firewallログを見た際にもどのクライアントか特定しやすいというメリットがあります。240f:103:xxxx:2:ed68:b033:e59b:3f1bなどのパブリックなIPv6アドレスで、後半64ビットがランダムに割り振られ、端末の再起動毎にインターフェースIDが変わるのはやっぱりログを見ていくのが大変です※。\nそれでもIPv6が作られた背景を考えると、その広大なアドレス空間からもNATは不要という考え方があります。折角の機能ですからIPv6アドレスの追跡が困難になることをメリットと考え設定するのも良いのかもしれません。\n※最近のクライアントではIPv6アドレスは２つ割り当てられ、インタフェースIDが変わらないものと、端末の再起動時に変わるものと２つあり、クライアントとしてInternetにアクセスしに行くのは後者の方で、Firewallのログでは毎回インターフェースIDが変わります。\nSophos DNS ProtectionSophosが提供するDNS Protectionです。Sophos Centralと呼ばれる集中型管理コンソールの機能があり、DNSはそこで提供されるサービスです。Sophos Firewallから一般的にはISPが提供するDNSに名前解決を要請しますが、この機能ではCentralのDNSにリレーすることになります。私は既にCentralにFirewallを登録していますが、DNS Protectionの機能は出てこないので、別途ライセンスが必要なのでしょうか。いずれは個人向けにも提供されるような気がしますが、もう少し状況をウォッチしていきたいと考えています。\nSophos Firewallのアップデートここでは、アップデート方法について記載します。\n管理画面にログイン後、左ペインメニューのバックアップ＆ファームウェアのファームウェアの確認でアップデートの案内が順次来ます。直ちにファームウェアのアップグレードの案内が来るわけでは無さそうです。ファームウェア公開後すぐの場合は個別にバージョンアップのファイルを入手します。\n個別にバージョンアップのファイルを入手するには、以下のURLからダウンロードします。\nhttps://support.sophos.com/support/s/article/KBA-000007972?language=ja\n\n上記画面でSophos FirewallのファームウェアのソフトウェアのLinkをクリックします。\n“SW-21.5.0_GA.SFW-171.sig”をダウンロードします。\nSophos Firewallの管理画面にログインし、左ペインメニューのバックアップ＆ファームウェアのファームウェアのタブメニューから以下の画面に赤丸で囲った矢印のアイコンをクリックし、ダウンロードしたモジュールをアップロードします。\n\n\n\nアップロード＆再起動ボタンをクリックし、v21.5へのアップグレードを完了させます。\nPrefix Delegationの設定具体的な設定方法です。WAN側ではHGWやISPからIPv6アドレスを割り当てられますが、この際以下の赤枠で囲った分のトグルスイッチをOnにします。\n\n\nこの状態で、IPv6のWAN側に割り当てられたIPv6アドレスが表示されます（アドレスを取得するまで少し時間が掛かります）。\n続いてLAN側です。こちらは、委任を選び、WANのインターフェースを指定します。\n\n\nそうすると委任されたサブネットが表示されます。私の環境では64ビット委任となっています。前半64ビットのPrefixが自動で表示されていますが、一般的に&#x2F;56や&#x2F;60などの多くのサブネットがある場合は、ここで当該LANのサブネットを何にするかプルダウンから選ぶことになるようですね。そして、後半64ビットのインターフェースIDについては1などの具体的なアドレスを設定して、FirewallのIPv6アドレスを確定させます。WAN側のIPアドレスに変更があった場合は、Prefix部分も自動で更新されます。\nさて、これでDHCPv6もIPv6ルーターアドバタイズも自動で構成されます。DHCPv6は以下の構成になっています。\n\n\n自動的にデバイスのDNS設定を使用にチェックが入り、ISP（私の場合はHGW）からのDNS IPv6アドレスが割り当てられます。私の場合は自宅内にESXiやNASなどのホストがあり、その名前解決にIPv4ローカルIPアドレスを使っている関係で、別のサブネットにIPv6ULAを割り当て、そのDNSを参照するようにしています。私のクライアントはAppleデバイス、Windowsが中心ですが、IPv6&#x2F;IPv4のデュアルスタックであり、クライアントがIPv6で直接外部のDNSにIPv4アドレスの名前解決もしようとするため、プライベートIPv4アドレスが返ってきませんので、少し工夫をしています。本来は、委任によって割り当てたLAN側のIPv6アドレスをDNSとするのでしょうが、Prefix Delegationのデザインからすれば、WAN側アドレスは変更される事を想定しておかないといけませんから、パブリックのIPv6アドレスをDNSとしてクライアントに固定で配布することは難しいのです。\n本来のIPv6デザインとしては、パブリックのIPアドレスとULAとが1つのインタフェース上に同居でき、内部通信はULAを使い、Internetへルーティングする際は、パブリックなIPアドレスを使うというのが一般的な考え方です。しかしあまりデザインにこだわりすぎて、端末1台づつスタティックにULAを割り当てるのも面倒すぎますので、こういった方法を取っています。\nRAも同様に自動生成され、特に設定することはありません。\n\n\nさて、次はFirewallルールの見直しです。従来のULAからはNAT前提だったので、MASQの指定によってv6NATしていましたが、IPv6 DelegationではNATが不要です。ですので該当のSNATは削除します。\n\n\n私の環境ではパブリックのIPv6サブネットをFamily用として割り当てています。そして会社端末やIoTなどのGuestネットワークについてはULAとしてMASQのNATを残してあります。\n余談ですが、こちらが指定したDNSを無視して直接InternetにDNS参照するようなケースは一般的にはそのDNSをブロック（Drop）する事も考えられますが、それだとサービス自体が動かなくなってしまう事もありえます。上記では、”Redirect DNS”とありますが、NATを使い、Firewallの内部インタフェースのDNSに変換して結果としてFirewall上のDNSを強制的に使っています。\nなお、基本的なFirewallのIPv6で通信を許可する基本設定も必要です。\n\n\n赤枠で囲った全てを通すルールがあればInernetへの疎通は行えますが、クライアントによって制御したいルールなどもあるでしょう。その際は、クライアントのMACアドレスをホストとサービスメニューからIPホストとして MACアドレスで判別できるように登録しておき、子供のネットに制限を掛けたり、SSL&#x2F;TLSインスペクションの有無などを切り替えると良いでしょう。そうしておけば、IPv6アドレスが変わったとしてもFirewallルールの影響を受けません。\nさて、IPv6の割り当て確認のため、テストしましょう。\n\ntest-ipv6 https://www.test-ipv6.com/index.html.ja_JP\n\n \n\n ULAの詳細は別ページで説明しているので興味のある方は参照してください。\n\nIPv6のUnique Local Addressを生成する\nIPv6のULAをIPv4より優先する\nXG FirewallでIPv6の設定を行う（前半）\nSophos FirewallでIPv6の設定を行う（後半）\n\nフィッシングやマルウェア対策さて、私はDNSについては、DoHとしてNextDNSを使っており、危険なサイトおよび広告についてカットしています。また、自宅のサーバー群はQuad9を参照するようにSophos Firewallに設定しています。NextDNSのGoogleセーフサーチや新しいドメインに接続しないという設定は最近流行りのフィッシングサイト対策としては有用です。Sophos Firewallでも使われていないドメイン”ParkedDomain”や”Newly Registerd Websites”をWEBフィルタで止めることで抑止力にはなります。但しフィッシングサイトはそれはもうタケノコのように次から次へと新しいURLが出てきます。フィッシングサイトが発生してから速やかに、当該企業から委託されたセキュリティベンダー等が対処し、無効化されることになりますが、その情報が伝搬されて主要なセキュリティベンダーが共有するにはそれなりの時間が掛かります。そういう意味ではFirewallのWebフィルタではテイクダウンまでの情報収集速度に限界もあるので、Sophos社はDNSサービスを提供し始めたのでしょう。\nキヤノンITソリューションズと合弁した日本法人「イーセットジャパン株式会社」が提供するESET製品はTLS&#x2F;SSLインスペクションを搭載しており、Windows環境では有用です。日本で発生するフィッシングサイトもかなりの精度で止められています。但し、Mac版のESETでは同じ製品か？と思うくらい止められていません（ネットワークフィルタの機能が入っていますが、HTTPSはチェックしません）。なので、私はmacOSについては、セキュリティソフトはBitdefenderを使っています。\nNextDNSはデバイス共通のDNSとして自宅、自宅外でも利用できますし、新しいドメインを止めたり、Googleセーフサーチを活用できたりするので、こちらもほぼフィッシングは止められます。Xなどでポストされてから6時間以降経過したものはほぼ止められているという感覚があります。海外サービスでありながら、日本のフィッシングサイトに対するその精度の高さには驚きます。\n私の場合、NextDNS、Quad9、Sophos Firewallの併用でかなり精度が高いブロックが実現しています。是非この機会にパブリックDNSにも目を向けていただき、信頼できるか否かを見極め、活用されることをお勧めいたします。\n\nNextDNS https://nextdns.io\n\n\nQuad9 https://quad9.net\n\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"Sophos Firewall v21 MR1","url":"/new-technology/2025/03/16/xg-v21mr1/","content":"\n\nSophos Firewall v21 MR1Sophos Firewall v21 MR1が2025年03月13日に発表されました。VPNのエンハンス、DHCPのエラーからの回復機能追加などが挙げられます。IPv6のみのクライアント（IPv4を持たない）に対しIPv6からのNAT機能でIPv4サイトを閲覧できるProxy機能が加えられました。また、 2025年3月31日にバグフィックスされたMR1-Build277が発表されています。\n\n\nv21 MR1の詳細な説明はSophos Communityを参照してください。\n\nhttps://community.sophos.com/sophos-xg-firewall/b/blog/posts/sophos-firewall-os-v21-mr1-rerelease-build-272-is-now-available\n\nリリースノートはこちらです。\n\nhttps://docs.sophos.com/releasenotes/index.html?productGroupID=nsg&amp;productID=xg&amp;versionID=21.0\n\nMR1-Build277では、PPPoEユーザー名（NC-153892）に特殊文字「#」がある場合、PPPoEインターフェイスが接続されないという孤立した問題が見られたためそれの解決策が適用されています。\nSophos Firewallのアップデート管理画面にログイン後、左ペインメニューのバックアップ＆ファームウェアのファームウェアの確認でアップデートの案内が順次来ます。ただし、これはかなり時間が経過してから通知が行われるのが通常のようです。\n\n\n※上記はv21 MR1のファームウェアが通知されたところです。\n個別にバージョンアップのファイルを入手するには、以下のURLからダウンロードします。\nhttps://support.sophos.com/support/s/article/KB-000043162?language=en_US\n\n上記画面でSophos FirewallのファームウェアのソフトウェアのLinkをクリックします。\n“SW-21.0.1_MR-1.SFW-277.sig”をダウンロードします。\nSophos Firewallの管理画面にログインし、左ペインメニューのバックアップ＆ファームウェアのファームウェアのタブメニューから以下の画面に赤丸で囲った矢印のアイコンをクリックし、ダウンロードしたモジュールをアップロードします。\n\n\n\nアップロード＆再起動ボタンをクリックし、v21 MR1へのアップグレードを完了させます。\n補足実は、v21 MR1は2025-02-18に一度リリースされましたが、Let’s Encryptで証明書の生成に関する問題が発生していました。ホームユーザーにとってはLet’s Encryptの再登録はそれなりに手間で大変助かる機能ですので、これの適用は一旦見送っていました。今回無事に改修された新たなv21 MR1が提供されました。\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"GPG ToolsでYubiKeyを使う","url":"/new-technology/2021/02/13/yubikey_gpg/","content":"この記事で実現すること\nmacOS環境下でGPG Tools(GPG Suite)の鍵管理（署名、暗号化、SSH認証）にYubiKeyを使います。\n\n\nGPG(GnuPG)についてGPGは昔からあるオープンソースの暗号・署名の主要なコンポーネントのひとつです。日本ではパスワード付きZIPファイルのやり取り、いわゆるPPAPを無くしていく流れでもあるので、これを機会にGPGが見直されればいいなと思いこの記事を書く事にしました。特にmacOS版は複数プロダクトまたは複数バージョンに対する設定が混在していて（既に廃止された機能の説明を含む）、余計に分かりづらくなっています。\n昔のPGPでの主眼であった友達の輪を広げていくという考え方は現代ではもはや少なくなってしまいました。むしろそういった信用の輪がサイバー攻撃で狙われてしまう時代です。GPGでの署名やITベンダーへのサポートのためにダンプファイルを相手の公開鍵で暗号化して送付する、ダウンロードしたファイルの署名を確認するという使われ方がメインです。\nソフトウェア構成GPGは基本的にはコマンドラインベースのプロダクトですが、macOSユーザーであれば、GPG Tools(GPG Suite)をお勧めします。GUIで暗号化・復号化できるのは便利です。但し、Appleメールの拡張機能でGPGを使う場合、3,000円程度の有償となります。Homebrewであれば、gpg-suite、gpg-suite-no-mail（有償のメール機能が無いもの）が該当します。GPG Suiteを直接ダウンロードする方法もあります。\n\nGPG Suite https://gpgtools.org/\n\nこれ以外には、YubicoのykmanというYubiKey Managerのコマンドインタフェースツールが必要です。これはHomebrewでykmanをインストールするか、Yubicoのサイトからダウンロードし、インストールしてください。\n\nYubico ykman CLI https://developers.yubico.com/yubikey-manager/\n\nGPG Tools(GPG Suite)の主な使い方GUIでのファイルの暗号化・復号化・署名マウスの右クリック（タッチパッドは2本指のタップ）で以下のメニューが選択できます。\n\n\nGUIでの選択部分の暗号化・復号化・署名文字列部分を選択し、マウスの右クリック（タッチパッドは2本指のタップ）で以下のメニューが選択できます。\n\n\n長い文字列でなければ、パスワード管理ソフトに入れておくほうが現実的でしょうか。\nGitHubでのVerifyGitHubでコミット時に本人が署名すると、以下の”Verified”マークが付きます。\n\n\nMailでの署名と暗号化メールの受取側がGPGを持っており、相手の公開鍵を自分のGPGに取り込んであれば、暗号化と署名を付けてメールを送れます。\n\n\nGPGを使ったSSHYubiKeyで設定したPINを入力して公開鍵認証でSSH接続します。\n\n\nYubiKeyを使ったGPGの鍵管理YubiKeyを使うGPGでは主鍵(MainKey)となる認定鍵(Certify)に加え、署名(Sign)、暗号(Encrypt)、認証(Authenticate)という副鍵(SubKey)を持たせます。YubiKeyの構成上、ひとつの機能にひとつの副鍵を割り当てる事が大前提です。そしてYubiKeyを紛失した場合を考慮し、主鍵はYubiKeyには置きません。主鍵は変えず、副鍵は任意に削除、追加する事を想定しています。Yubicoでは、この副鍵を端末側で生成し、それをYubiKeyに取り込む形を推奨しています。RSA暗号2048ビットのPIVとは異なり、GPGにおけるYubiKey 4&#x2F;5はRSA暗号4096ビットまで対応できます。RSA暗号は2048ビットあれば十分と考えていますが、GitHubの推奨としては「キーは少なくとも4096ビットである必要があります」との事。GitHubさん、そこまで必要ですか&#x1f623;\n\nGitHub -新しいGPGキーを生成する- https://docs.github.com/ja/github/authenticating-to-github/generating-a-new-gpg-key\n\n\n\ngraph TD\nB[MainKey-Certify] --&gt; C{SubKey}\nC --&gt;D[Sign]\nC --&gt;E[Encrypt]\nC --&gt;F[Authenticate]\n\n\n\n主鍵は万が一YubiKeyをなくした場合などの鍵の抹消や新しい副鍵を作る以外は使いません。USBなどに複写し安全な場所で保管する事になります。主鍵が無いと友達の輪を広げられない（相手の公開鍵に署名できない）のですが、YubiKeyを使ったGPGの使い方としては、そこに重きを置いていません。YubiKeyとGPGのセットアップはお手本となる説明があります。\n\n\ndrduh/YubiKey-Guide(https://github.com/drduh/YubiKey-Guide) This is a guide to using YubiKey as a SmartCard for storing GPG encryption, signing and authentication keys, which can also be used for SSH.\n\n\n\nhttps://github.com/drduh/YubiKey-Guide\n\nただし、このガイドは秘密鍵を漏洩させないためにクリーンなLinux上で作業し、暗号化USBを作りセットアップするという超優等生な手順になっています。この記事では可能な限りシンプルな手順の作成を目的とし一部の手順を割愛しています。\nGPGをセットアップするための手順大まかな手順は以下の通りです。\n\n上述した必須ソフトウェアのセットアップ、秘密鍵のバックアップのためのUSBメディア[1]を準備します\nGPGでの鍵の作成からYubiKeyへの鍵を取り込みます\nGPG環境を設定します\nSSHに必要なSSH公開鍵をエクスポートします\nGitHub署名のためのGPG公開鍵と上記SSHの鍵をGitHubにログインして登録します\nGitHubのSSH接続および署名のためgitを設定します\n\nGPGの鍵作成からYubiKeyへの鍵の取り込み前提必要なソフトウェア（GPG Suite・ykman）がインストールされている事、秘密鍵のバックアップのため、macOSで認識可能となるようフォーマット済みのUSBが用意できている前提としています。鍵の生成は出来るだけ安全な環境下で実施するために、ネットワークから切り離し、ウィルス対策ソフト以外のソフトウェアを可能な限り終了させてから作業します。また鍵の作成時にはYubiKeyの接続は必要ありません。\n私は古くはmacOSのCatalina(10.15.7)、Sonoma(14.2.1)で動作確認しています。また、コマンドラインエディタはvim(vi)を利用していますが、他のエディタでも構いません。GPGのコマンドインタフェースがかなり特殊な事もあって、まずはアドリブ無しにこの手順をなぞっていただく事をお勧めします。変更可能な部分は主鍵および副鍵の有効期限および鍵の種類です。鍵の種類としては特に拘りがなければRSAをお勧めします。\n以下の手順では、＃から始まるコメント部分に要点を記載しています。\n\n\n初期設定ターミナルを起動します。認定（Certify）鍵を無期限で作成します。\n# 一時フォルダを作成し、そこに鍵をセットアップしていきます$ export GNUPGHOME=$(mktemp -d)\n\n主鍵の生成# 主鍵は期限無し、RSA 4096Bitで生成します$ gpg --expert --full-gen-keygpg (GnuPG/MacGPG2) 2.2.27; Copyright (C) 2021 Free Software Foundation, Inc.This is free software: you are free to change and redistribute it.There is NO WARRANTY, to the extent permitted by law.ご希望の鍵の種類を選択してください:   (1) RSA と RSA (デフォルト)   (2) DSA と Elgamal   (3) DSA (署名のみ)   (4) RSA (署名のみ)   (7) DSA (機能をあなた自身で設定)   (8) RSA (機能をあなた自身で設定)   (9) ECC と ECC  (10) ECC (署名のみ)  (11) ECC (機能をあなた自身で設定)  (13) 既存の鍵  (14) カードに存在する鍵あなたの選択は? 8# 機能毎にフラグという概念を持ちます。これの有効、無効の切り替えに反転という表現が使われています鍵RSAに認められた操作: Sign Certify Encrypt Authenticate現在の認められた操作: Sign Certify Encrypt   (S) 署名機能を反転する   (E) 暗号機能を反転する   (A) 認証機能を反転する   (Q) 完了あなたの選択は? E鍵RSAに認められた操作: Sign Certify Encrypt Authenticate現在の認められた操作: Sign Certify   (S) 署名機能を反転する   (E) 暗号機能を反転する   (A) 認証機能を反転する   (Q) 完了あなたの選択は? S鍵RSAに認められた操作: Sign Certify Encrypt Authenticate現在の認められた操作: Certify   (S) 署名機能を反転する   (E) 暗号機能を反転する   (A) 認証機能を反転する   (Q) 完了あなたの選択は? QRSA 鍵は 1024 から 4096 ビットの長さで可能です。鍵長は? (3072) 4096要求された鍵長は4096ビット鍵の有効期限を指定してください。         0 = 鍵は無期限      &lt;n&gt;  = 鍵は n 日間で期限切れ      &lt;n&gt;w = 鍵は n 週間で期限切れ      &lt;n&gt;m = 鍵は n か月間で期限切れ      &lt;n&gt;y = 鍵は n 年間で期限切れ鍵の有効期間は? (0)0鍵は無期限ですこれで正しいですか? (y/N) yGnuPGはあなたの鍵を識別するためにユーザIDを構成する必要があります。本名: Your Name電子メール・アドレス: your@mail.comコメント:次のユーザIDを選択しました:    &quot;Your Name &lt;your@mail.com&gt;&quot;名前(N)、コメント(C)、電子メール(E)の変更、またはOK(O)か終了(Q)? Oたくさんのランダム・バイトの生成が必要です。キーボードを打つ、マウスを動かす、ディスクにアクセスするなどの他の操作を素数生成の間に行うことで、乱数生成器に十分なエントロピーを供給する機会を与えることができます。たくさんのランダム・バイトの生成が必要です。キーボードを打つ、マウスを動かす、ディスクにアクセスするなどの他の操作を素数生成の間に行うことで、乱数生成器に十分なエントロピーを供給する機会を与えることができます。gpg: 鍵1234567890123456を究極的に信用するよう記録しましたgpg: 失効証明書を &#x27;/tmp/xxx/openpgp-revocs.d/XXXXED7DE0C6BC105798E304D4B75A4941146XXXX.rev&#x27; に保管しました。公開鍵と秘密鍵を作成し、署名しました。# 上記の「鍵1234567890123456を究極的に信用するよう記録しました」のKEY番号をを環境変数KEYIDに登録します# セットアップの間、KEYIDを何度も使うためです$ export KEYID=1234567890123456$ gpg --expert --edit-key $KEYIDgpg (GnuPG/MacGPG2) 2.2.27; Copyright (C) 2020 Free Software Foundation, Inc.This is free software: you are free to change and redistribute it.There is NO WARRANTY, to the extent permitted by law.秘密鍵が利用できます。sec  rsa4096/1234567890123456     作成: 2021-01-31  有効期限: 無期限  利用法: C[  究極  ] (1). Your Name &lt;your@mail.com&gt;\n\n以降は副鍵を作成していきます。一般的な考えでは、有効期限は定めるべきものとされています。\n署名副鍵の作成# 副鍵は期限5年、RSA4096bitで構成しますgpg&gt; addkeyご希望の鍵の種類を選択してください:   (3) DSA (署名のみ)   (4) RSA (署名のみ)   (5) Elgamal (暗号化のみ)   (6) RSA (暗号化のみ)   (7) DSA (機能をあなた自身で設定)   (8) RSA (機能をあなた自身で設定)  (10) ECC (署名のみ)  (11) ECC (機能をあなた自身で設定)  (12) ECC (暗号化のみ)  (13) 既存の鍵  (14) カードに存在する鍵あなたの選択は? 4RSA 鍵は 1024 から 4096 ビットの長さで可能です。鍵長は? (3072) 4096要求された鍵長は4096ビット鍵の有効期限を指定してください。         0 = 鍵は無期限      &lt;n&gt;  = 鍵は n 日間で期限切れ      &lt;n&gt;w = 鍵は n 週間で期限切れ      &lt;n&gt;m = 鍵は n か月間で期限切れ      &lt;n&gt;y = 鍵は n 年間で期限切れ鍵の有効期間は? (0)5y鍵は金  1/30 11:25:03 2026 JSTで期限切れとなりますこれで正しいですか? (y/N) y本当に作成しますか? (y/N) yたくさんのランダム・バイトの生成が必要です。キーボードを打つ、マウスを動かす、ディスクにアクセスするなどの他の操作を素数生成の間に行うことで、乱数生成器に十分なエントロピーを供給する機会を与えることができます。sec  rsa4096/1234567890123456     作成: 2021-01-31  有効期限: 無期限  利用法: C     信用: 究極        有効性: 究極ssb  rsa4096/A234567890123456     作成: 2021-01-31  有効期限: 2026-01-30  利用法: S[  究極  ] (1). Your Name &lt;your@mail.com&gt;\n\n暗号化副鍵の作成# 副鍵は期限5年、RSA4096bitで構成しますgpg&gt; addkeyご希望の鍵の種類を選択してください:   (3) DSA (署名のみ)   (4) RSA (署名のみ)   (5) Elgamal (暗号化のみ)   (6) RSA (暗号化のみ)   (7) DSA (機能をあなた自身で設定)   (8) RSA (機能をあなた自身で設定)  (10) ECC (署名のみ)  (11) ECC (機能をあなた自身で設定)  (12) ECC (暗号化のみ)  (13) 既存の鍵  (14) カードに存在する鍵あなたの選択は? 6RSA 鍵は 1024 から 4096 ビットの長さで可能です。鍵長は? (3072) 4096要求された鍵長は4096ビット鍵の有効期限を指定してください。         0 = 鍵は無期限      &lt;n&gt;  = 鍵は n 日間で期限切れ      &lt;n&gt;w = 鍵は n 週間で期限切れ      &lt;n&gt;m = 鍵は n か月間で期限切れ      &lt;n&gt;y = 鍵は n 年間で期限切れ鍵の有効期間は? (0)5y鍵は金  1/30 11:25:03 2026 JSTで期限切れとなりますこれで正しいですか? (y/N) y本当に作成しますか? (y/N) yたくさんのランダム・バイトの生成が必要です。キーボードを打つ、マウスを動かす、ディスクにアクセスするなどの他の操作を素数生成の間に行うことで、乱数生成器に十分なエントロピーを供給する機会を与えることができます。sec  rsa4096/1234567890123456     作成: 2021-01-31  有効期限: 無期限  利用法: C     信用: 究極        有効性: 究極ssb  rsa4096/A234567890123456     作成: 2021-01-31  有効期限: 2026-01-30  利用法: Sssb  rsa4096/B234567890123456     作成: 2021-01-31  有効期限: 2026-01-30  利用法: E[  究極  ] (1). Your Name &lt;your@mail.com&gt;\n\n認証副鍵の作成# 副鍵は期限5年、RSA4096bitで構成しますgpg&gt; addkeyご希望の鍵の種類を選択してください:   (3) DSA (署名のみ)   (4) RSA (署名のみ)   (5) Elgamal (暗号化のみ)   (6) RSA (暗号化のみ)   (7) DSA (機能をあなた自身で設定)   (8) RSA (機能をあなた自身で設定)  (10) ECC (署名のみ)  (11) ECC (機能をあなた自身で設定)  (12) ECC (暗号化のみ)  (13) 既存の鍵  (14) カードに存在する鍵あなたの選択は? 8鍵RSAに認められた操作: Sign Encrypt Authenticate現在の認められた操作: Sign Encrypt   (S) 署名機能を反転する   (E) 暗号機能を反転する   (A) 認証機能を反転する   (Q) 完了あなたの選択は? S鍵RSAに認められた操作: Sign Encrypt Authenticate現在の認められた操作: Encrypt   (S) 署名機能を反転する   (E) 暗号機能を反転する   (A) 認証機能を反転する   (Q) 完了あなたの選択は? E鍵RSAに認められた操作: Sign Encrypt Authenticate現在の認められた操作:   (S) 署名機能を反転する   (E) 暗号機能を反転する   (A) 認証機能を反転する   (Q) 完了あなたの選択は? A鍵RSAに認められた操作: Sign Encrypt Authenticate現在の認められた操作: Authenticate   (S) 署名機能を反転する   (E) 暗号機能を反転する   (A) 認証機能を反転する   (Q) 完了あなたの選択は? QRSA 鍵は 1024 から 4096 ビットの長さで可能です。鍵長は? (3072) 4096要求された鍵長は4096ビット鍵の有効期限を指定してください。         0 = 鍵は無期限      &lt;n&gt;  = 鍵は n 日間で期限切れ      &lt;n&gt;w = 鍵は n 週間で期限切れ      &lt;n&gt;m = 鍵は n か月間で期限切れ      &lt;n&gt;y = 鍵は n 年間で期限切れ鍵の有効期間は? (0)5y鍵は金  1/30 11:25:03 2026 JSTで期限切れとなりますこれで正しいですか? (y/N) y本当に作成しますか? (y/N) yたくさんのランダム・バイトの生成が必要です。キーボードを打つ、マウスを動かす、ディスクにアクセスするなどの他の操作を素数生成の間に行うことで、乱数生成器に十分なエントロピーを供給する機会を与えることができます。sec  rsa4096/1234567890123456     作成: 2021-01-31  有効期限: 無期限  利用法: C     信用: 究極        有効性: 究極ssb  rsa4096/A234567890123456     作成: 2021-01-31  有効期限: 2026-01-30  利用法: Sssb  rsa4096/B234567890123456     作成: 2021-01-31  有効期限: 2026-01-30  利用法: Essb  rsa4096/C234567890123456     作成: 2021-01-31  有効期限: 2026-01-30  利用法: A[  究極  ] (1). Your Name &lt;your@mail.com&gt;gpg&gt; savegpg&gt; quit\n\n作成した鍵の確認$ gpg -K/tmp/.xxx/pubring.kbx------------------------------sec   rsa4096 2021-01-31 [C]      7890123456789012345678901234567890123456uid           [  究極  ] Your Name &lt;your@mail.com&gt;ssb  rsa4096/A234567890123456 2021-01-31 [S] [有効期限: 2026-01-30]ssb  rsa4096/B234567890123456 2021-01-31 [E] [有効期限: 2026-01-30]ssb  rsa4096/C234567890123456 2021-01-31 [A] [有効期限: 2026-01-30]\n\n秘密鍵のエクスポート#バックアップ用途に秘密鍵をエクスポートします$ gpg --armor --export-secret-keys $KEYID &gt; $GNUPGHOME/mastersub.key$ gpg --armor --export-secret-subkeys $KEYID &gt; $GNUPGHOME/sub.key\n\n失効証明書の作成$ gpg --output $GNUPGHOME/revoke.asc --gen-revoke $KEYID\n\nUSBメディアを挿入し、$GNUHOMEフォルダをバックアップ# ご自身の環境に応じてUSBへのパスは変更してください。Finderでコピーしても構いません$ sudo cp -avi $GNUPGHOME /volumes/your USB path/\n\nUSBはアンマウントします（しばらく使わないので保存）\n公開鍵をホームディクレトリのpublic_key.pgpとしてエクスポートこの公開鍵はGPGの実運用で使うものになります。後でホームディレクトリの公開鍵を再度GPGに取り込み、鍵の管理をすることになります。\n$ gpg --armor --output ~/public_key.pgp --export $KEYID\n\nYubiKeyの確認YubiKeyを接続します。\n$ gpg --card-editReader ...........: Yubico YubiKey OTP FIDO CCIDApplication ID ...: 12345678901234567890123456789012Application type .: OpenPGPVersion ..........: 3.4Manufacturer .....: YubicoSerial number ....: 12345678Name of cardholder: [未設定]Language prefs ...: [未設定]Salutation .......:URL of public key : [未設定]Login data .......: [未設定]Signature PIN ....: 強制なしKey attributes ...: rsa4096 rsa4096 rsa4096Max. PIN lengths .: 127 127 127PIN retry counter : 3 0 3Signature counter : 0KDF setting ......: offSignature key ....: [未設定]Encryption key....: [未設定]Authentication key: [未設定]General key info..: [未設定]\n\nPINの変更これは、前回の記事「YubiKeyとSSHとGitHub」のYubiKey ManagerでみたPIVのPIN、PUKとは異なります。YubikeyはGPG向けに別のPIN（デフォルト123456）、AdminPIN（デフォルト12345678）があるので、紛失時のためにも設定変更される事をお勧めします。\ngpg/card&gt; admin管理者コマンドが許可されていますgpg/card&gt; passwdgpg: OpenPGPカードno. 12345678901234567890123456789012を検出1 - change PIN2 - unblock PIN3 - change Admin PIN4 - set the Reset CodeQ - quitあなたの選択は? 11 - change PIN2 - unblock PIN3 - change Admin PIN4 - set the Reset CodeQ - quitあなたの選択は? 31 - change PIN2 - unblock PIN3 - change Admin PIN4 - set the Reset CodeQ - quitあなたの選択は? Q\n\n3つの副鍵をYubiKeyに転送YubiKeyに転送された秘密鍵は端末からは全て中身が抹消され、YubiKeyに情報がある事を示すポインタにしかなりません。もし、やりなおしが必要になった場合は、秘密鍵をバックアップから復活させてから行う必要があります。\n$ gpg --edit-key $KEYID秘密鍵が利用できます。sec  rsa4096/1234567890123456     作成: 2021-01-31  有効期限: 無期限  利用法: C     カード番号: 0006 12345678     信用: 究極        有効性: 究極ssb  rsa4096/A234567890123456 2021-01-31 [S] [有効期限: 2026-01-30]ssb  rsa4096/B234567890123456 2021-01-31 [E] [有効期限: 2026-01-30]ssb  rsa4096/C234567890123456 2021-01-31 [A] [有効期限: 2026-01-30]\n\n署名鍵の転送# 3つのキー毎にYubikeyに転送します。# key 1 と入力する事で最初の副鍵が選択され、＊マークが付きますgpg&gt; key 1sec  rsa4096/1234567890123456     作成: 2021-01-31  有効期限: 無期限  利用法: C     カード番号: 0006 12345678     信用: 究極        有効性: 究極ssb*  rsa4096/A234567890123456 2021-01-31 [S] [有効期限: 2026-01-30]ssb  rsa4096/B234567890123456 2021-01-31 [E] [有効期限: 2026-01-30]ssb  rsa4096/C234567890123456 2021-01-31 [A] [有効期限: 2026-01-30]# ssb＊の&quot;＊&quot;マークは選択されている事を示しますgpg&gt; keytocard鍵を保管する場所を選択してください:   (1) 署名鍵   (3) 認証鍵あなたの選択は? 1# PinEntryにYubiKeyのAdminPINを入力し移動を完了させます\n\n暗号化鍵の転送# 署名の選択を&quot;key 1&quot;を入力して外し、&quot;key 2&quot;を入力して暗号化を選択しますgpg&gt; key 1gpg&gt; key 2sec  rsa4096/1234567890123456     作成: 2021-01-31  有効期限: 無期限  利用法: C     カード番号: 0006 12345678     信用: 究極        有効性: 究極ssb  rsa4096/A234567890123456 2021-01-31 [S] [有効期限: 2026-01-30]ssb*  rsa4096/B234567890123456 2021-01-31 [E] [有効期限: 2026-01-30]ssb  rsa4096/C234567890123456 2021-01-31 [A] [有効期限: 2026-01-30]gpg&gt; keytocard鍵を保管する場所を選択してください:   (2) 暗号鍵あなたの選択は? 2# PinEntryにYubiKeyのAdminPINを入力し移動を完了させます\n\n認証鍵の転送# 暗号化の選択を&quot;key 2&quot;を入力して外し、&quot;key 3&quot;を入力して認証を選択しますgpg&gt; key 2gpg&gt; key 3sec  rsa4096/1234567890123456     作成: 2021-01-31  有効期限: 無期限  利用法: C     カード番号: 0006 12345678     信用: 究極        有効性: 究極ssb  rsa4096/A234567890123456 2021-01-31 [S] [有効期限: 2026-01-30]ssb  rsa4096/B234567890123456 2021-01-31 [E] [有効期限: 2026-01-30]ssb*  rsa4096/C234567890123456 2021-01-31 [A] [有効期限: 2026-01-30]gpg&gt; keytocard鍵を保管する場所を選択してください:   (3) 認証鍵あなたの選択は? 3# PinEntryにYubiKeyのAdminPINを入力し移動を完了させますgpg&gt; save\n\nYubiKeyへの移動を確認$ gpg -K/tmp/.xxx/pubring.kbx------------------------------sec   rsa4096 2021-01-31 [C]      7890123456789012345678901234567890123456uid           [  究極  ] Your Name &lt;your@mail.com&gt;ssb&gt;  rsa4096/A234567890123456 2021-01-31 [S] [有効期限: 2026-01-30]ssb&gt;  rsa4096/B234567890123456 2021-01-31 [E] [有効期限: 2026-01-30]ssb&gt;  rsa4096/C234567890123456 2021-01-31 [A] [有効期限: 2026-01-30]\n\n最終確認のチェックリスト\nデフォルトから変更したYubiKeyのPINおよび管理PINを記録しました\nGPGの主鍵のパスワードを記録しました\nUSBに主鍵、副鍵、および失効証明書のコピーを保管し、オフラインで保管する準備をしました\nホームディレクトリに公開鍵のコピーを保存しました\n鍵の生成で使った＄KEYIDの値を記録しました\n\nクリーンアップ上記のバックアップが確保されている事を前提に、作業してきた一時フォルダを削除します。\n$ sudo rm -rf $GNUPGHOME$ gpg --delete-secret-key $KEYID$ unset GNUPGHOME\n\nクリーンアップが終了したらネットワークに接続できます。秘密鍵はもうmacOSの中に残っていません。秘密鍵は取り外したUSBと接続されているYubiKeyの中にあります。\n公開鍵のGPGへのインポートと信頼$ gpg --import ~/public_key.pgpgpg: keybox&#x27;/Users/yoshi/.gnupg/pubring.kbx&#x27;が作成されましたgpg: 鍵1234567890123456: 公開鍵&quot;XXXXXX&quot;をインポートしましたgpg:           処理数の合計: 1gpg:             インポート: 1gpg: marginals needed: 3  completes needed: 1  trust model: pgpgpg: 深さ: 0  有効性:   1  署名:   0  信用: 0-, 0q, 0n, 0m, 0f, 1u\n以下の鍵1234567890123456は実際に上記で生成された鍵（キー）を指定します。\n$ gpg --edit-key 鍵1234567890123456gpg&gt; trustpub  rsa4096/1234567890123456     作成: 2021-01-31  有効期限: 無期限      利用法: C     信用: 不明        有効性: 不明ssb  rsa4096/A234567890123456     作成: 2021-01-31  有効期限: 2026-01-30  利用法: S     カード番号: 0006 12345678ssb  rsa4096/B234567890123456     作成: 2021-01-31  有効期限: 2026-01-30  利用法: E     カード番号: 0006 12345678ssb  rsa4096/C234567890123456     作成: 2021-01-31  有効期限: 2026-01-30  利用法: A     カード番号: 0006 12345678[  究極  ] (1). Your Name &lt;your@mail.com&gt;他のユーザの鍵を正しく検証するために、このユーザの信用度を決めてください(パスポートを見せてもらったり、他から得たフィンガープリントを検査したり、などなど)  1 = 知らない、または何とも言えない  2 = 信用しない  3 = まぁまぁ信用する  4 = 充分に信用する  5 = 究極的に信用する  m = メーン・メニューに戻るあなたの決定は? 5本当にこの鍵を究極的に信用しますか? (y/N)pub  rsa4096/1234567890123456     作成: 2021-01-31  有効期限: 無期限      利用法: C     信用: 究極        有効性: 不明ssb  rsa4096/A234567890123456     作成: 2021-01-31  有効期限: 2026-01-30  利用法: S     カード番号: 0006 12345678ssb  rsa4096/B234567890123456     作成: 2021-01-31  有効期限: 2026-01-30  利用法: E     カード番号: 0006 12345678ssb  rsa4096/C234567890123456     作成: 2021-01-31  有効期限: 2026-01-30  利用法: A     カード番号: 0006 12345678[  究極  ] (1). Your Name &lt;your@mail.com&gt;gpg&gt; quit\n\nGPG環境の設定gpg-agent.confの設定gpg-agent.confに以下の内容から不足があれば追加します。3-4行目のキャッシュ時間は環境に応じて自由に変更してください。\n$ vi ~/.gnupg/gpg-agent.confenable-ssh-supportdefault-cache-ttl 600max-cache-ttl 7200\n\nGPG Agentの自動起動についてGPGをインストールすると、OS起動時に起動するアプリケーションがLaunchAgentに登録されます。\n$ ls /Library/LaunchAgents | grep gpgorg.gpgtools.Libmacgpg.xpc.plistorg.gpgtools.macgpg2.fix.plistorg.gpgtools.macgpg2.shutdown-gpg-agent.plistorg.gpgtools.updater.plist\n\nこれらに加え、ユーザー毎のログイン時のスタートアップにGPG Agentの起動を登録します。ユーザーのLaunchAgentsに2つのファイルを作成します。作成先は/Librarlyではなく、＄HOME/Libraryです。\n$ vi ~/Library/LaunchAgents/gnupg.gpg-agent.plist\n\n &lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;!DOCTYPE plist PUBLIC &quot;-//Apple//DTD PLIST 1.0//EN&quot; &quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;&gt;&lt;plist version=&quot;1.0&quot;&gt;    &lt;dict&gt;        &lt;key&gt;Label&lt;/key&gt;        &lt;string&gt;gnupg.gpg-agent&lt;/string&gt;        &lt;key&gt;RunAtLoad&lt;/key&gt;        &lt;true/&gt;        &lt;key&gt;KeepAlive&lt;/key&gt;        &lt;false/&gt;        &lt;key&gt;ProgramArguments&lt;/key&gt;        &lt;array&gt;            &lt;string&gt;/usr/local/MacGPG2/bin/gpg-connect-agent&lt;/string&gt;            &lt;string&gt;/bye&lt;/string&gt;        &lt;/array&gt;    &lt;/dict&gt;&lt;/plist&gt;\n\n$ vi ~/Library/LaunchAgents/gnupg.gpg-agent-symlink.plist\n\n&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;&lt;!DOCTYPE plist PUBLIC &quot;-//Apple//DTD PLIST 1.0//EN&quot; &quot;http://www.apple.com/DTDs/ProperyList-1.0/dtd&quot;&gt;&lt;plist version=&quot;1.0&quot;&gt;    &lt;dict&gt;        &lt;key&gt;Label&lt;/key&gt;        &lt;string&gt;gnupg.gpg-agent-symlink&lt;/string&gt;        &lt;key&gt;ProgramArguments&lt;/key&gt;        &lt;array&gt;            &lt;string&gt;/bin/sh&lt;/string&gt;            &lt;string&gt;-c&lt;/string&gt;            &lt;string&gt;/bin/ln -sf $HOME/.gnupg/S.gpg-agent.ssh $SSH_AUTH_SOCK&lt;/string&gt;        &lt;/array&gt;        &lt;key&gt;RunAtLoad&lt;/key&gt;        &lt;true/&gt;    &lt;/dict&gt;&lt;/plist&gt;\n\nここまで作成したら一度macOSをログアウト、ログインします。ターミナルから以下のコマンドでGPG Agentを含めて6つのプロセスが起動している事を確認します。\n$ launchctl list | grep gpg646\t0\torg.gpgtools.macgpg2.shutdown-gpg-agent-\t0\tgnupg.gpg-agent-\t0\tgnupg.gpg-agent-symlink-\t0\torg.gpgtools.updater-\t0\torg.gpgtools.macgpg2.fix511\t0\torg.gpgtools.Libmacgpg.xpc\n\nここまでの作業で一旦はGPGの基本機能が使える状態になりました。文字列を選択してファイルの右クリックメニューから暗号化したりメモの文字列を署名、暗号、復号機能を確認します。\nSSH公開鍵のエクスポートここからはYubikey+GPGのSSH接続設定です。\nssh-add -L で公開鍵を取得します。\n$ ssh-add -Lssh-rsa AAAAB4NzaC1yc2EAAAADAQABAAACAz[...]zreOKM+HwpkHzcy9DQcVG2Nw== cardno:000612345678\n\nYubikeyの公開鍵の末尾にはカード番号の記載があります。SSH公開鍵を接続先のサーバーのauthorized_keysに登録します。また、macOS側の~/.ssh/configにはGPGのための追加設定が不要です。\nターミナルから接続テストしてみましょう。PinEntryダイアログが表示され、PIN入力後、公開鍵認証で接続されます。\nGPGの公開鍵とSSH公開鍵とをGitHubに登録ホームディレクトリに作成したPGP公開鍵とSSH公開鍵との2つをGitHubに登録します。GitHubサイトにログイン後、Accountの”Settings”を選び、左メニューのSSH and GPG keysをクリックします。New SSH keyとNew GPG keyというボタンをクリックしそれぞれを登録します。\nまずは、SSHが行える事を確認しましょう。\n$ ssh -T git@github.comHi yoshi0808! You&#x27;ve successfully authenticated, but GitHub does not provide shell access.\n\nGitHubへの接続、署名のためのgitの設定gitのSSH接続設定gitコマンドでSSH接続を有効にするには以下を実行します$ git remote set-url origin git@github.com:[ユーザID]/[リポジトリ].git\n設定確認は以下の通りです$ git remote -v\nHTTPS接続に戻す場合は、リモートの URL の変更を参照してください。\n\nGitHub -リモートの URL の変更- https://docs.github.com/ja/github/using-git/changing-a-remotes-url\n\ngit署名の設定# ここでは主鍵を指定します$ git config --global user.signingkey 1234567890123456\n\nデフォルトですべてのコミットに署名するには、以下を実行します。\n$ git config --global commit.gpgsign true\nVisual Studio Codeをお使いの方であれば、&quot;git.enableCommitSigning&quot;: trueを確認します。\nこれまでの設定でGPG Toolsを使ったSSH接続と署名の対応は完了です&#x1f44d;。PIV方式とは異なりGUI方式によりPINの入力も行える事、また一定時間PINはキャッシュしますので、セキュアである事と利便性を両立させています。\n（任意）YubiKeyタッチ認証GPGで認証、署名、暗号化を行おうとしている時に、YubiKeyへのタッチを必要とさせる設定ができます。GPGのPIN入力はキャッシュしている時間がありますが、これを設定すると、GPGのアクションの前には必ずYubiKeyにタッチする必要があります。より慎重さを求める方に向いています。デフォルトではOffになっていますが、これをOnにする場合は以下のコマンドを投入します。YubiKeyがタッチを待っている間はランプが点滅します（12秒程度応答しないとギブアップします）。これはNeoなどYubiKeyの種類によっては設定できません。認証　$ ykman openpgp keys set-touch aut on署名　$ ykman openpgp keys set-touch sig on暗号化　$ ykman openpgp keys set-touch enc onOffにする場合は以下のコマンドになります。認証　$ ykman openpgp keys set-touch aut off署名　$ ykman openpgp keys set-touch sig off暗号化　$ ykman openpgp keys set-touch enc off\nOnの代わりに15秒キャッシュする”CACHED”という項目も設定できます。詳しくはykman openpgp keys set-touch -hを参照します。\n継続的インテグレーション（CI)など、署名、デプロイと連続動作させる時にこのCACHED設定は便利です。\n\n\nGPGとPIVとの切り替え前回の記事「YubiKeyとSSHとGitHub」ではPIVカードとしての扱いについて説明しました。GPGは排他でカードを占有してしまう仕様のため、GPGを使っている時はPIVを使うYubico-Authenticatorは動きません。コマンド$ ykaman piv infoを実行する事でGPGから切り離されPIVのインタフェースが使えるようになります。GPG Toolsサポートでの議論もありましたが、明確な解決が難しいまま今に至っています。実運用としては、macOS純正アプリのAutomatorを使ってPIVに切り替えてからYubico Authenticatorを起動する方法が簡単でしょうか。以下に画面キャプチャを記載しておきます。\n\n\n\n[GPG Tools -GPGMail: Fails to sign after switch from S&#x2F;MIME- https://gpgtools.tenderapp.com/discussions/nightly/110-gpgmail-fails-to-sign-after-switch-from-smime\n\n副鍵の有効期限到来による再作成ここでは主鍵の有効期限を無制限、副鍵は有効期限ありで作成しました。副鍵の有効期限が2週間程度に近づいた場合、GPGから警告の通知ダイアログが表示される場合があります。この場合はUSBにバックアップした秘密鍵など一式を再び一時フォルダに戻した上で、既存の副鍵期限延長、または新たな副鍵を新たな期限で作成し、一度初期化したYubiKeyに再度上記の手順で再登録する事になります。SSHの公開鍵は変わりますので、再度サーバーへの配布が必要となります。\n[1]もし暗号化USBを導入するのであれば、Finderで暗号化する方法、VeraCryptを使う方法があります\n","categories":["Security"],"tags":["yubikey"]},{"title":"YubiKeyとSSHとGitHub","url":"/new-technology/2021/02/06/yubikey_ssh_github/","content":"\nこの記事で実現すること\n\nYubiKeyと関係するソフトウェアの概要説明、そして公開鍵認証でリモートホストにSSHを行えるようにします。またGitHubにコマンドラインからSSH接続できるようにします。\n\nYubico社のYubiKeyYubico社のYubiKeyはなんとなくご存知の方も多いかもしれません。指紋認証ではなく、秘密鍵をこの小さなハードウェアに埋め込み、公開鍵認証、Yubico独自のワンタイムパスワード、FIDO2、そしてGitHubやGoogleなどはWebAuthn（ウェブオースン）でYubiKeyにタッチするだけで簡単に2要素認証が可能になります。6桁のワンタイムパスワードをいちいち入力しなくて済むのは魅力的です。ただ法人向けの要素が強く、実際の使い方については情報が少ないのが現状です。しかし、Amazonなどの商品の評価では非常にユーザー満足度が高いのが見て取れます。\n\n\n私はUSB-Cの最も小さい”YubiKey 5C Nano”をmacOSで使っています。2要素認証が必要な時にこの小さいデバイスに”Touch to Sign”で認証できます。\nmacOSでは、GitHubへの2要素認証はTouch IDによるWebAuthnが使えます。このブログを書いている時点でChrome、Edgeは対応しています。以下の通り、組み込みセンサーという表示がTouchIDに相当します。Safariのタッチ認証はYubikeyが必要です。\n\n\n細かいことを言えば、WebAuthnはパスワードを必要としない認証のはずで、GitHubのような2要素認証は定義からすると少し違うような気がします。Microsoftアカウントは、YubiKeyを事前登録する事で、アカウントやパスワードを一切入力せず、YubiKeyのタッチだけでログインできます。公開鍵認証のお手本ですね。他には、パスワード管理ソフトのbitwardenのプレミアムアカウント（年$10と格安です）では、2要素目の認証にWebAuthnを使えます。\n\n\nbitwardenに関する詳細は、「パスワード管理ソフトのbitwardenを活用する」の記事を参照してください。\nYubikeyの小さいパッケージには”Get started yubico.com&#x2F;start”と清々しいシンプルな記載があります。そして、このURLにアクセスすると、使えるWebサイト、サービスの一覧が表示されます。そして、そのサイトでの使い方が説明されているだけです。\nGoogle、Facebookなどのサイトで”Touch to Sign”の2要素認証を楽しんでみてください。一度認証してしまえば、Cookieに認証情報を保存してしまうため、次からは認証不要で使うという方が大半でしょうから、楽しいのは最初だけかもしれません&#x1f601;\nまた、YubiKeyが本物かどうかのテストができます。\n\nhttps://www.yubico.com/genuine/\n\nYubikey AuthenticatorPCのアプリケーションを使っている時には、ワンタイムパスワード（OTP）の入力のためにスマホを取り出すのが少々面倒に感じます。PCにYubico Authenticatorをインストールすればいつもの6桁の数字をコピペで入力できるようになります。当然ですが、YubiKeyが接続されている事が前提（NFCモデルはタッチが前提）になります。スキャナ機能があってデスクトップ上に表示しているOTPのバーコードを読み取る機能もありこれも便利です。\n（左：YubiKey未接続、右：YubiKey接続済）\n\n\nYubiKeyの少し高度な使い方これまで説明してきただけでもYubiKeyは便利で満足度は高く感じるところですが、せっかくなのでもう少し高度な使い方について見ていきましょう。私が使っているmacOSを例にして説明しますが、あまり固有OSに偏らない形で説明していきます。YubiKeyの使い方について、私なりの解釈で難易度として3段階あります。\n\n\n\n段階\n難易度\n実現可能になるもの\n\n\n\n1\n易しい\nFIDO、2要素認証など\n\n\n2\n普通\n秘密鍵＋PINによるSSH公開鍵認証\n\n\n3\n高\nGnuPGによるGitHubリポジトリへのコミット時の署名およびSSH\n\n\n3番目のGnuPGを使ったGitHubの署名、SSH接続は難易度が高く、別記事にします。\nGitHub開発者でなくとも、YubiKeyを使いこなすために、2段階目のSSH公開鍵認証まではやってみたいものです。SSHによる公開鍵認証、かつパスフレーズを簡素なものにするという目的で必要なソフトウェアの一覧を以下に記載します。\n\n\n\nYubicoソフトウェア\n説明\n\n\n\nYubiKey ManagerGUI)\n最初に使う管理ツール（GUI）\n\n\nYubico PIV Tool\nSSHを行う際にPIVカード認証（公開鍵認証）方式で接続する（CLI）\n\n\nYubikey PIV Manager\nSSHを行う際にPIVカード認証（公開鍵認証）方式で接続する（GUI）\n\n\n\nhttps://www.yubico.com/products/services-software/download/smart-card-drivers-tools/https://developers.yubico.com/yubikey-piv-manager/Releases/\n\n上記以外には、PKCS#11と呼ばれるスマートカードやUSBトークンを対象とした認証ライブラリが存在しますのでそれをダウンロードする必要があります（後述します）。\n過去から様々な変遷があって、Yubicoでは正直ソフトウェアが乱立しています。もう使わなくなったソフトウェアや、新しいソフトウェアだけどまだ機能が移行されていないなど少しわかりづらいものがあります。\nYubiKey ManagerとYubiKeyの機能YubiKey Manager(GUI)はYubiKeyの全体管理に使うソフトウェアです。セットアップは全く難しくありません。\n\n\nApplicationsから、OTPを選択すると以下の画面になります。\n\nOTPにはSlot1,2の2つのスロットがあります。Slot1のショートタッチにはOTPが割り当てられています。さらにConfigureに進みます。\n\nここでは、Slot1に対してYubico OTP（Yubico独自のワンタイムパスワード）、チャレンジレスポンス、スタティックパスワード、OATH-HOTPが選択できます。このスロットはショートタッチ、一瞬YubiKeyに触れると、キーが入力されます。つまりキーボードのように振舞います。なお、Slot2のロングタッチに重要なアプリケーションの長めのパスワードを割り当てておくと便利です。2秒程度YubiKeyに触れているとSlot2のスタティックパスワードが入力されます。パスワード管理ソフトなどのログインには便利に使えます。\nこの他、FIDO2、PIVと並んでいますが、SSHで利用する場合はこのPIVが重要になります。PIVは米国の連邦政府における政府職員の身分証明用のICカードの規格になります。\nPIN ManagementについてApplicationsからPIVを選択すると、\"PIN Management\"、\"Certificates\"、\"Reset\"と並びます。\nPIVは、ICカード向けの規格に基づくものです。4つのSlotがあります。\n\n\n\nSlot\n説明\n\n\n\n9a\nAuthentication SSHでPIN入力と共に利用します\n\n\n9c\nDigital Signature\n\n\n9d\nKey Management\n\n\n9e\nCard Authentication\n\n\nSSHでは、Slot9aのAuthenticationを使うことになります。\n\n\nそして、このSlot9aを用いて接続する際は、PINの認証が必要です。まず最初にPINの設定を変更しましょう。PINは日本のマイナンバーカードとほぼ扱いは同じで多少緊張感が必要です。3回入力ミスするとPUK（PIN Unlock Key）によるリセットが必要になります。PINの初期設定は”123456”となります。\nSSH（PIV Authentication）の設定さて、実際のSSHの設定ですが、実は以前に自分が設定したものよりもわかりやすい方法が掲載されていたのでそちらをまず紹介させていただきます。\n\nペンティオ Engineer’s Blog https://techblog.pentio.com/entry/ssh-using-yubikey\n\nこのページで紹介している方法はWindowsもmacOSも考慮されているので多くの方の参考になるでしょう。\nここではYubikey ManagerとYubikey PIV Managerを用いてGUIで構成されています。また、PKCS#11のために、OpenSCライブラリをダウンロードし構成する方法が紹介されています。実際のダウンロードリンクは以下を参照してください。\n\nhttps://www.pentio.com/yubikey/support/smartcard/\n\nmacOS向け私は色々なライブラリがさまざまな場所にインストールされ、またバージョン管理が煩雑になるのを好まないため、Homebrewを使っています。Macユーザーにとっては一般的なものですが、こちらを使ったインストールをお勧めします。私はYubiKey Managerは単独でインストールし、残りのYubikey関連はbrew install opensc yubico-piv-toolとしてインストールしました。openscは大型ライブラリのため、依存関係で様々なパッケージが自動インストールされます。私はopenscのインストールが終わった後に気づいたのですが、yubico-piv-toolのなかに、SSHに必要なライブラリがあるようです。私のセットアップ（macOS）は、Yubicoのサイトを参考にコマンドラインベースで行いました。\n\nHomebrew https://brew.sh/index_jaYubico -Using PIV for SSH through PKCS #11- https://developers.yubico.com/PIV/Guides/SSH_with_PIV_and_PKCS11.html\n\n上記の説明のなかに”Find out where ykcs11 has been installed. For a Debian-based system, the ykcs11 module ends up in &#x2F;usr&#x2F;local&#x2F;lib&#x2F;libykcs11. On MacOS, it is in &#x2F;usr&#x2F;local&#x2F;lib&#x2F;libykcs11.dylib.”と説明があります。実際に/usr/local/libを確認しましたが、libykcs11.dylib -&gt; ../Cellar/yubico-piv-tool/2.2.0/lib/libykcs11.dylibとインストール済みのyubico-piv-toolのライブラリにシンボリックリンクが張られていました。\nSSH接続テストさて、YubiKeyで秘密鍵を生成し終わったところで、公開鍵を生成します。(Pathは環境によって異なります）\nssh-keygen -D /usr/local/opt/opensc/lib/opensc-pkcs11.so -e\nまた、Yubicoのライブラリを利用するのであれば、以下の通りです。\nssh-keygen -D /usr/local/lib/libykcs11.dylib -e\n\n出力された公開鍵を接続先のサーバーのauthorized_keysに配置します（一般的な方法であり手順は省略します）。\n相手先サーバに接続してみます。\n$ ssh -I /usr/local/lib/libykcs11.dylib usr1@192.168.x.xEnter PIN for &#x27;YubiKey PIV #XXXXXXXX&#x27;:Welcome to Ubuntu 20.04.2 LTS (GNU/Linux 5.8.0-41-generic x86_64)Your Hardware Enablement Stack (HWE) is supported until April 2025.Last login: Fri Feb  5 20:59:22 2021 from 192.168.x.xusr1@ubuntu:~$\nPINを入力して公開鍵認証で接続できました。秘密鍵はYubiKey内部で生成されているため、漏洩する事はありません。\n簡単にYubiKeyを利用してSSHに接続するためには、~/.ssh/configに設定を加えます。接続先ホストに対してライブラリを明示します。\nHost ubuntu HostName 192.168.x.x User usr1 #PKCS11Provider /usr/local/opt/opensc/lib/opensc-pkcs11.so PKCS11Provider /usr/local/lib/libykcs11.dylib IdentitiesOnly yesHost github.com #PKCS11Provider /usr/local/opt/opensc/lib/opensc-pkcs11.so PKCS11Provider /usr/local/lib/libykcs11.dylib IdentitiesOnly yes\n「ESXi(無償版)のセキュリティを高める」の記事で触れましたが、これらの設定を行う事で、ESXiへのSSHでYubiKeyを使った公開鍵認証が可能になります。\nGitHubへのSSH接続開発者の方であればGitHubへの接続もYubiKeyで行いたいかもしれません。私はGitHub上にブログを構築しており、普段はTerminalのコマンドラインでデプロイしています。これは2要素認証は行えませんからGitHub上でパーソナルアクセストークンを発行し、それを利用します。パーソナルアクセストークンはアプリケーション専用パスワードという事になります。それなりの文字長なので安全性は高いですが、2要素認証よりは劣ります。もしあなたが趣味としてのホームユーザーではなく開発者であり、さらに安全性を高める必要があれば、パーソナルアクセストークンをやめて、SSH接続を検討してみてください。なお、この設定には制限事項があるので後述します。\nGitHubのSSH接続に関するリソースを掲載します。以下でGitHubにログインし、公開鍵を登録します。\n\nGitHub アカウントへの新しい SSH キーの追加 https://docs.github.com/ja/github/authenticating-to-github/adding-a-new-ssh-key-to-your-github-account\n\nこれでPIN入力とともに、GitHubにはSSHで接続できるようになりました。\n$ ssh -T git@github.comEnter PIN for &#x27;YubiKey PIV #XXXXXXXX&#x27;:Hi yoshi0808! You&#x27;ve successfully authenticated, but GitHub does not provide shell access.\n\nまた、gitコマンドでSSH接続を有効にするには以下のコマンドを実行します。$ git remote set-url origin git@github.com:[ユーザID]/[リポジトリ].git\n設定確認は以下の通りです$ git remote -v\nHTTPS接続に戻す場合は、リモートの URL の変更を参照してください。\n\nhttps://docs.github.com/ja/github/using-git/changing-a-remotes-url\n\nSSH接続の制限事項コマンドライン中心にgitを使われている方は問題ありませんが、YubiKeyのPIVによるPIN入力はTerminalにおける標準入出力を使用しています。従って、GUIアプリケーションを利用した時に標準入出力を使えませんから、SSH認証が失敗します。例えば、GitHub Desktopなどは以下のエラーが発生します。\n\n\nこれが困るという事であれば一旦GUIはHTTPS接続とし、パーソナルアクセストークンを必要としたアプリケーション専用にSSH接続とする使い分けが必要となります。\nmacOSにおけるyubico-piv-toolでの秘密鍵作成ログ以下は私が過去に実行したSSHの秘密鍵作成からSSHの実行までの作業ログです。openscはYubico提供のライブラリを利用しています。\n[xxxx@MB-Air:~]$ yubico-piv-tool -s 9a -a generate -o public.pem -kEnter management key:Successfully generated a new private key.[xxxx@MB-Air:~]$ yubico-piv-tool -a verify-pin -a selfsign-certificate -s 9a -S &quot;/CN=SSH key/&quot; -i public.pem -o cert.pemEnter PIN:Successfully verified PIN.Successfully generated a new self signed certificate.[xxxx@MB-Air:~]$ yubico-piv-tool -a import-certificate -s 9a -i cert.pem -kEnter management key:Successfully imported a new certificate.$ ssh-keygen -D /usr/local/lib/libykcs11.dylib -e &gt; id_rsa.pub$ ssh -I /usr/local/lib/libykcs11.dylib usr1@192.168.x.xEnter PIN for &#x27;YubiKey PIV #XXXXXXXX&#x27;:\n\n上記では公開鍵id_rsa.pubをサーバー側に配置している手順は省略しています。\nYubikeyでSSH設定してみた感想WebAuthnや2要素認証以上にYubiKeyを使いこなそうとすると、プロダクトが新旧あり混乱しやすく難易度も上がります。一番便利だなと感じているのはbitwardenへのローカルのログインで使うスタティックパスワードだったりします。さらにGnuPGを使ったGitHubへのコミット時の署名をYubiKeyで行う事もできますが、GnuPGの理解も必要となりもっと複雑です。今回制約となったGitHub DesktopなどのSSH認証時の課題はGnuPGを使う事で完全に解決します。続きは「GPG ToolsでYubiKeyを使う」にその方法を記載しています。\n","categories":["Security"],"tags":["yubikey"]},{"title":"はじめに","url":"/new-technology/2020/02/22/%E3%81%AF%E3%81%97%E3%82%99%E3%82%81%E3%81%AB/","content":"ホームユーザーのITを中心にポストしていきたいと考えてます。これまでの自身の仕事はプログラミング・ネットワーク・サーバ構築・セキュリティと、広く浅くITに関わってきました。ITの実務は最近遠ざかってますが、自分なりに新しい技術の習得も兼ねて、ブログ形式で掲載していきます。\n\n\n単純にインストールして「できました」ではなく、導入目的を考え、導入後のITの使い方こそが重要です。最近は個人利用に限り利用無償のソフトウェアが増えてきました。また、商用利用であっても無償となるオープンソースソフトウェアの活用も見逃せません。これは大変ありがたい話で、座学ではなかなか理解が進まない固有技術であっても、こういった無料のプロダクトを通じて知見を高める事が可能となっています。もちろん有償の価値あるソフトウェアについても、自己啓発と家庭向けのIT活用として紹介していきたいと考えてます。\n"}]