[{"title":"Plugable 2.5GbE USB アダプター","url":"/new-technology/2021/10/03/2500MbE/","content":"<img src=\"/new-technology/2021/10/03/2500MbE/title.png\" class=\"\" title=\"alt\">\n\n<p>自宅のLANにつながるIT機器は増える一方、2.5GbEのUSBアダプターが値段もこなれてきています。2.5G〜10Gのネットワークスイッチも廉価、小型化してきているので導入するいいタイミングです。2.5Gbps、5GbpsのUSBアダプター、イーサネットカードの実力はどの程度のレベルでしょうか。</p>\n<span id=\"more\"></span>\n\n<h2 id=\"3-000円台で購入できる2-5GbEアダプター\"><a href=\"#3-000円台で購入できる2-5GbEアダプター\" class=\"headerlink\" title=\"3,000円台で購入できる2.5GbEアダプター\"></a>3,000円台で購入できる2.5GbEアダプター</h2><p>最近、米国のPlugable社から3,680円で、2.5GbpsのUSB(USB3.2&#x2F;USB2.0&#x2F;Thunderbolt)接続ができる有線イーサネットアダプターが発売されています。Plugableは私が好きなメーカーで認証済みのThunderbolt3ケーブルを安価に提供しています。</p>\n<blockquote>\n<p>Plugable有線イーサネットアダプター<br> <a href=\"https://ja.plugable.com/products/usbc-e2500\">https://ja.plugable.com/products/usbc-e2500</a></p>\n</blockquote>\n<p>また、デスクトップPCにおいても、PCI Express×1のスロットは空きがある状態ではないでしょうか。ここ最近2.5GのPCI Express×1カードは、実売価格で4,000円を切ってきています。値段で躊躇してしまうレベルではありません。</p>\n<h2 id=\"ネットワークの理論値と現実\"><a href=\"#ネットワークの理論値と現実\" class=\"headerlink\" title=\"ネットワークの理論値と現実\"></a>ネットワークの理論値と現実</h2><p>1GbEのNICがあれば無理に2.5GbEを使う必要はないように感じます。ネットワークは難しいもので必ず遅延（レイテンシ）が存在しますので、比較高速な自宅内のLANであれば1GbEのNICで上限ぎりぎりまで速度は出ますが、インターネット向けだとそこまでスピードは出ません。私のデスクトップPCで利用しているAquantiaのカードは5Gbpsのチップが載ったPCI Express×1のカードですが、実力としては3Gbps程度です（自宅内のNASに対してiperf3で確認）。これがインターネット宛の通信で<strong>スピードテスト</strong>では1.4Gbps程度になります。このPCの接続を1GbpsのNICに変更すると700Mbps程度までに落ち込みます（この落ち込みはサーバー・PCの能力、回線の太さ、PCとサーバーとの物理的な距離によって変わります）。遅延要素としてはアプリケーションファイアウォールやウィルス対策ソフト、色々なものが入ります。Wi-Fiを使っているならば11acの高速なWi-Fiでも実測500Mbps〜600Mbps程度でしょうか。LAN内は限りなく1Gbpsで通信できていても実際のネットを使う場合は意外と低速な状態になっています。</p>\n<blockquote>\n<p>Speedtest by Ookla<br> <a href=\"https://www.speedtest.net/\">https://www.speedtest.net</a></p>\n</blockquote>\n<p>ジャンボフレームで速度を引き上げる手法もありますが見た目に分かりづらいトラブルを起こしやすく、私は最新テクノロジーによる能力増でセキュリティ対策などのパフォーマンス劣化をカバーする方法が好きです。</p>\n<h2 id=\"Plugable-2-5GbE-USBアダプター\"><a href=\"#Plugable-2-5GbE-USBアダプター\" class=\"headerlink\" title=\"Plugable 2.5GbE USBアダプター\"></a>Plugable 2.5GbE USBアダプター</h2><p>このPlugable 2.5GbE USBアダプターを利用したWindows10のiperf3（ネットワーク速度測定ツール）の結果です（ウィルス対策ソフトとWindowsDefender Firewallが有効）。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">C:\\iperf3 -c 192.168.x.b</span><br><span class=\"line\">Connecting to host 192.168.x.b, port 5201</span><br><span class=\"line\">[  4] <span class=\"built_in\">local</span> 192.168.x.c port 57672 connected to 192.168.x.b port 5201</span><br><span class=\"line\">[ ID] Interval           Transfer     Bandwidth</span><br><span class=\"line\">[  4]   0.00-1.00   sec   278 MBytes  2.33 Gbits/sec</span><br><span class=\"line\">[  4]   1.00-2.00   sec   275 MBytes  2.31 Gbits/sec</span><br><span class=\"line\">[  4]   2.00-3.00   sec   276 MBytes  2.31 Gbits/sec</span><br><span class=\"line\">[  4]   3.00-4.00   sec   277 MBytes  2.32 Gbits/sec</span><br><span class=\"line\">[  4]   4.00-5.00   sec   278 MBytes  2.34 Gbits/sec</span><br><span class=\"line\">[  4]   5.00-6.00   sec   280 MBytes  2.35 Gbits/sec</span><br><span class=\"line\">[  4]   6.00-7.00   sec   280 MBytes  2.35 Gbits/sec</span><br><span class=\"line\">[  4]   7.00-8.00   sec   280 MBytes  2.35 Gbits/sec</span><br><span class=\"line\">[  4]   8.00-9.00   sec   280 MBytes  2.35 Gbits/sec</span><br><span class=\"line\">[  4]   9.00-10.00  sec   278 MBytes  2.33 Gbits/sec</span><br><span class=\"line\">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class=\"line\">[ ID] Interval           Transfer     Bandwidth</span><br><span class=\"line\">[  4]   0.00-10.00  sec  2.72 GBytes  2.33 Gbits/sec                  sender</span><br><span class=\"line\">[  4]   0.00-10.00  sec  2.72 GBytes  2.33 Gbits/sec                  receiver</span><br><span class=\"line\"></span><br><span class=\"line\">iperf Done.</span><br></pre></td></tr></table></figure>\n\n<p>結果はとても安定しています。私の自宅の環境では家の中を大きく経由（1階→2階→1階）して2つの10Gbpsスイッチを経由していますが、十分な速度です。</p>\n<p>何よりも発熱が非常に抑えられ、熱いという感じはありません。これは採用されているチップが進歩したためです。Plugable社の説明によれば、RTL8156Bというチップが採用されているとの事です。</p>\n<blockquote>\n<p>このイーサネット・アダプターは Realtek 社製 RTL8156B チップセットを使用しており、10&#x2F;100&#x2F;1000&#x2F;2500 Mbit ネットワーク・スピードに対応しています。USB 2.0、3.0、3.1、3.2、または Thunderbolt 3、Thunderbolt 4、USB 3.2&#x2F;3.１&#x2F;3.0&#x2F;2.0 プロトコルに対応したホストシステムで使用できます。（USB 2.0 ポートに接続した場合には転送速度が制限されます。）</p>\n</blockquote>\n<p>このアダプターはUSB-CとUSB-Aが使える事、Windows・macOSのどちらも使えます。1Gbps&#x2F;100Mbpsも認識できますので1つ持っておくとさまざまなデバイスに支えて便利ではないでしょうか。なお、USB-C→USB-Aの変換コネクタは事故の恐れがあるので他のケーブルには使えません。そういう意味で変換コネクタはこのアダプターにくくりつけられています。</p>\n<p>普段はWi-Fiを使っていても、何か大きなファイルを操作するとか大量のバックアップを取るなどする場合にはノートPCでも活躍しそうです。2.5Gbのスイッチも1万円切るくらいから発売されているので、少しの投資で速度アップが期待できます。</p>\n<p>macOSでのiperf3の結果も安定しています。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ iperf3 -c 192.168.x.b</span><br><span class=\"line\">Connecting to host 192.168.x.b, port 5201</span><br><span class=\"line\">[  5] <span class=\"built_in\">local</span> 192.168.x.a port 50420 connected to 192.168.x.b port 5201</span><br><span class=\"line\">[ ID] Interval           Transfer     Bitrate</span><br><span class=\"line\">[  5]   0.00-1.00   sec   280 MBytes  2.35 Gbits/sec</span><br><span class=\"line\">[  5]   1.00-2.00   sec   280 MBytes  2.35 Gbits/sec</span><br><span class=\"line\">[  5]   2.00-3.00   sec   278 MBytes  2.33 Gbits/sec</span><br><span class=\"line\">[  5]   3.00-4.00   sec   278 MBytes  2.33 Gbits/sec</span><br><span class=\"line\">[  5]   4.00-5.00   sec   277 MBytes  2.32 Gbits/sec</span><br><span class=\"line\">[  5]   5.00-6.00   sec   266 MBytes  2.23 Gbits/sec</span><br><span class=\"line\">[  5]   6.00-7.00   sec   278 MBytes  2.33 Gbits/sec</span><br><span class=\"line\">[  5]   7.00-8.00   sec   268 MBytes  2.25 Gbits/sec</span><br><span class=\"line\">[  5]   8.00-9.00   sec   277 MBytes  2.32 Gbits/sec</span><br><span class=\"line\">[  5]   9.00-10.00  sec   281 MBytes  2.35 Gbits/sec</span><br><span class=\"line\">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class=\"line\">[ ID] Interval           Transfer     Bitrate</span><br><span class=\"line\">[  5]   0.00-10.00  sec  2.70 GBytes  2.32 Gbits/sec                  sender</span><br><span class=\"line\">[  5]   0.00-10.00  sec  2.70 GBytes  2.32 Gbits/sec                  receiver</span><br><span class=\"line\"></span><br><span class=\"line\">iperf Done.</span><br></pre></td></tr></table></figure>\n\n<p>上記はMacBook-Air 2019(intel)のBig Surにおいて、macOSのFirewall・アプリケーションFirewall(Vallum)・ウィルス対策ソフト（BitDefender）をオフにした状態での検証です。通常利用しているセキュリティを全てオンにすると、CPUパワーが足りないようで、1.6Gbps程度までに落ち込みます。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ iperf3 -c 192.168.x.b</span><br><span class=\"line\">Connecting to host 192.168.x.b, port 5201</span><br><span class=\"line\">[  5] <span class=\"built_in\">local</span> 192.168.x.a port 51620 connected to 192.168.x.b port 5201</span><br><span class=\"line\">[ ID] Interval           Transfer     Bitrate</span><br><span class=\"line\">[  5]   0.00-1.00   sec   205 MBytes  1.72 Gbits/sec</span><br><span class=\"line\">[  5]   1.00-2.00   sec   205 MBytes  1.72 Gbits/sec</span><br><span class=\"line\">[  5]   2.00-3.00   sec   193 MBytes  1.62 Gbits/sec</span><br><span class=\"line\">[  5]   3.00-4.00   sec   202 MBytes  1.69 Gbits/sec</span><br><span class=\"line\">[  5]   4.00-5.00   sec   198 MBytes  1.66 Gbits/sec</span><br><span class=\"line\">[  5]   5.00-6.00   sec   191 MBytes  1.61 Gbits/sec</span><br><span class=\"line\">[  5]   6.00-7.00   sec   199 MBytes  1.67 Gbits/sec</span><br><span class=\"line\">[  5]   7.00-8.00   sec   199 MBytes  1.67 Gbits/sec</span><br><span class=\"line\">[  5]   8.00-9.00   sec   181 MBytes  1.52 Gbits/sec</span><br><span class=\"line\">[  5]   9.00-10.00  sec   196 MBytes  1.65 Gbits/sec</span><br><span class=\"line\">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class=\"line\">[ ID] Interval           Transfer     Bitrate</span><br><span class=\"line\">[  5]   0.00-10.00  sec  1.92 GBytes  1.65 Gbits/sec                  sender</span><br><span class=\"line\">[  5]   0.00-10.00  sec  1.92 GBytes  1.65 Gbits/sec                  receiver</span><br><span class=\"line\"></span><br><span class=\"line\">iperf Done.</span><br></pre></td></tr></table></figure>\n\n<p>Planex社からも2.5GbEのUSBアダプターが今年の7月に発売されています。</p>\n<blockquote>\n<p><a href=\"https://www.planex.co.jp/products/usbc-lan2500r/\">https://www.planex.co.jp/products/usbc-lan2500r/</a></p>\n</blockquote>\n<p>2.5Gbpsも要らない、そんなサイズの大きなファイルを移動したり使う事もないというのは普通の感覚ですが、Webブラウザのようにマルチスレッドを用いた通信と画面描画とが完全に最適化されている場合は、それこそ100Mbpsでも十分に機能します。しかし使いたいアプリケーションは必ずしも最適化されているわけでもなく、4K動画を変換しながら再生するなどの処理はとても重いためネットワーク速度もより高速なものが好ましいです。数Mバイト単位のデータを極めて短時間に頻繁に読み込むまたは書き出すアプリケーションがあれば、通信とストレージのデータ処理の遅延が都度発生します。それぞれがシーケンシャルに処理されるアプリケーションは高速化しづらい面があります。例えばmacOSのバックアップソフトであるTimeMachineは、読み取り・差分確認・圧縮・暗号化・書き込みと1つ1つのシーケンシャルの処理の遅延が最終的に数時間にわたり動作し続けるする事になります。これらの1つのオーバーヘッドの要素である通信部分を比較的廉価な投資で速度面の解決ができる点はメリットがあります。</p>\n<p>もちろん、5Gbps、10Gbpsのチップを乗せたUSBアダプターでも良いのですが、5Gbpsは速度・発熱において効率の良いチップが見当たりません。QNAPが出している5GbEのUSBアダプター”QNAP QNA-UC5G1T USB 5GbE Adapter Review”によるとiperf3のテストでは3.4Gbps程度の能力のようです。私の持っているAquantiaのAQC108チップとほぼ変わりません。10Gbpsのチップはたくさんありますが、発熱・ファンが必要で大型となり、気軽にUSBアダプターとして持ちはこべるものではありません。</p>\n<blockquote>\n<p>QNAP QNA-UC5G1T USB 5GbE Adapter Review<br> <a href=\"https://www.servethehome.com/qnap-qna-uc5g1t-usb-5gbe-adapter-review/\">https://www.servethehome.com/qnap-qna-uc5g1t-usb-5gbe-adapter-review/</a></p>\n</blockquote>\n<p>やはりキーポイントとしては、Realtek社のRTL8156Bチップセットなんでしょうか。末尾に”B”がないチップは発熱量が大きいのでご注意ください。</p>\n<div class=\"note warning\"><p>2Gbps〜10Gbpsのインターネットサービスが提供されている場合で、回線会社から提供されているホームゲートウェイは必ずしも2.5GbE、5GbEと直接接続できるとは限りません。この場合は10GbEの口を持つPCかスイッチを用意する必要があります。</p>\n</div>\n\n<h2 id=\"macOSの有線LANにお勧めします\"><a href=\"#macOSの有線LANにお勧めします\" class=\"headerlink\" title=\"macOSの有線LANにお勧めします\"></a>macOSの有線LANにお勧めします</h2><p>MacBook(Big Sur)で1GbpsのUSBアダプターをお使いの方で速度が出ない方であれば<strong>Plugable 2.5GbE USBアダプター</strong>を検討してみてください。</p>\n<p>実は、intel版のMacBook-AirをCatalinaからBig Surに変えてからTimeMachineのバックアップが非常に遅く感じるようになりました。フルバックアップの時は時間が掛かる事を見越して1Gbpsの有線アダプターを使っていましたが、それが10時間ほど掛かってしまい、これは明らかにおかしいと思い調べ始めました。</p>\n<p>いろいろ調べるなかで、Plugableのサイトであるきっかけが見つかりました。</p>\n<blockquote>\n<p>macOS（10.13.6 ~ 10.15）：基本的には内蔵ドライバーによりサポートされていますが、当アダプターの完全なパフォーマンスを得るためには、こちらのドライバーページから最新のドライバーをダウンロードし更新してください。<br>macOS（11.x） ：ドライバの導入は必要ありません。ただし、 macOS 11.x では、リンクレートの報告とパケット数が正しくないという既知の問題がわかっています。オートネゴシエーションによってアダプターは 2.5 Gbps の接続を取得し、デバイスは正常に動作しているのにもかかわらず、macOS 上でリンクレートが 1000Mbps しかないように表示されるというものです。またジャンボフレームは現在、macOS 11.x ではサポートされていません。 これらの問題を解決するために、Realtek 社は macOS 11.ｘ 用修正ドライバの開発に取り組んでいます。</p>\n</blockquote>\n<p>PlagableのサイトではApple純正のドライバの問題点とされるものもきちんとした説明がされていて安心できます。今時日本語のWebサイトも用意してくれているのも好感が持てます。またmacOSの投稿者からは、Plagableコミュニティで以下の書き込みがあったのでドライバについてとても参考になりました。</p>\n<blockquote>\n<p>Excellent Big Sur compatibility, but concerned about future support<br> <a href=\"https://support.plugable.com/t/excellent-big-sur-compatibility-but-concerned-about-future-support/20802\">https://support.plugable.com/t/excellent-big-sur-compatibility-but-concerned-about-future-support/20802</a></p>\n</blockquote>\n<p>この記事の一部を抜粋します。</p>\n<blockquote class=\"blockquote-center\">\n<p>macOS Big Sur appears to be using a Driver Extensions (DEXTs) to provide support to most USB network adapters built with Realtek chipsets. This allows for simple plug-and-play compatibility. But my testing has shown than CPU usage is excessive with the Apple provided DEXT. It interferes with normal system operation. For example, it causes stutters in system audio. Furthermore, on gigabit or faster connections, the DEXT is unable to reach actual gigabit speeds, instead reaching actual performance that typically tops out between 600 and 700 Mbps.</p>\n<p>macOS Big Surは、DEXTs（Driver Extensions）を使用して、Realtekチップセットを搭載したほとんどのUSBネットワークアダプターに対応しているようです。これにより、シンプルなプラグアンドプレイの互換性を実現しています。しかし、私のテストによると、Appleが提供するDEXTでは、CPU使用率が過剰になります。これは、システムの正常な動作を妨げるものです。例えば、システムオーディオが途切れたりします。さらに、ギガビット以上の接続では、DEXTは実際のギガビットの速度に到達できず、600〜700Mbps程度のパフォーマンスとなります。</p>\n\n</blockquote>\n\n<p>この投稿者の指摘通り、私のmacOSのアクティビティモニタでiperf3の実行中のパフォーマンスを確認すると、アイドル状態が数％まで落ち込みます。つまり通信部分で多くのリソースを使い果たしているのです。</p>\n<p>Wi-Fiでiperf3実行時</p>\n<img src=\"/new-technology/2021/10/03/2500MbE/wifi.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p>1GbEでiperf3実行時</p>\n<img src=\"/new-technology/2021/10/03/2500MbE/1gbe.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p>システムがCPUを74.1％使用し、アイドルが1.35％しかありません。その時のiperf3実行結果はWi-Fi以下の速度でした。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ iperf3 -c 192.168.x.b</span><br><span class=\"line\">Connecting to host 192.168.x.b, port 5201</span><br><span class=\"line\">[  5] <span class=\"built_in\">local</span> 192.168.x.a port 59287 connected to 192.168.x.b port 5201</span><br><span class=\"line\">[ ID] Interval           Transfer     Bitrate</span><br><span class=\"line\">[  5]   0.00-1.00   sec  40.9 MBytes   342 Mbits/sec</span><br><span class=\"line\">[  5]   1.00-2.00   sec  38.5 MBytes   324 Mbits/sec</span><br><span class=\"line\">[  5]   2.00-3.00   sec  54.6 MBytes   458 Mbits/sec</span><br><span class=\"line\">[  5]   3.00-4.00   sec  56.3 MBytes   472 Mbits/sec</span><br><span class=\"line\">[  5]   4.00-5.00   sec  49.5 MBytes   415 Mbits/sec</span><br><span class=\"line\">[  5]   5.00-6.00   sec  53.4 MBytes   448 Mbits/sec</span><br><span class=\"line\">[  5]   6.00-7.00   sec  41.0 MBytes   344 Mbits/sec</span><br><span class=\"line\">[  5]   7.00-8.00   sec  52.7 MBytes   443 Mbits/sec</span><br><span class=\"line\">[  5]   8.00-9.00   sec  50.2 MBytes   420 Mbits/sec</span><br><span class=\"line\">[  5]   9.00-10.00  sec  49.4 MBytes   416 Mbits/sec</span><br><span class=\"line\">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class=\"line\">[ ID] Interval           Transfer     Bitrate</span><br><span class=\"line\">[  5]   0.00-10.00  sec   487 MBytes   408 Mbits/sec                  sender</span><br><span class=\"line\">[  5]   0.00-10.01  sec   485 MBytes   407 Mbits/sec                  receiver</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>このPlugable 2.5GbE USBアダプターでは、ドライバの拡張子が”kext”となっており十分なパフォーマンスです。<br>※Firewallやウィルス対策ソフトを利用しているとCPUは100％近くにはなります。</p>\n<img src=\"/new-technology/2021/10/03/2500MbE/systemrepo.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p>Plugableの製品そのものの魅力ももちろんですが、ナレッジベースやコミュニティなどがきちんと運営されています。いずれ提供されるであろうRealtekのドライバ開発についても、先の投稿者は以下のように述べています。素晴らしい会社には素晴らしいユーザーが集まるものですね。</p>\n<blockquote>\n<p>ありがとうございます。これこそが、私がPlugable社のアダプターを選んだ理由です。数年前にもPlugable社のデバイスを購入したことがあり、その時のサポートレベルの高さに感銘を受けました。Big Surに搭載されているASIXのネットワーク・チップセット・ドライバについて御社が行った非常に詳細な分析を読んで、Big Sur専用に推奨されているUSBC-E2500も十分にサポートされているだろうと思いました。これまでのところ、素晴らしい経験をしています。</p>\n</blockquote>\n","categories":["Network","Hardware"]},{"title":"Sophos Firewall のインストール（事前準備）","url":"/new-technology/2020/03/06/InstallXG/","content":"<p class=\"onepoint\">この記事で実現すること</p>\nSophos FirewallをESXiで稼働させるためのインストールイメージ（isoファイル）をダウンロードし、ESXi上で、Sophos Firewallのための仮想マシンを構築できるようになります。\n\n<span id=\"more\"></span>\n<h2 id=\"Sophos-Firewallのダウンロード\"><a href=\"#Sophos-Firewallのダウンロード\" class=\"headerlink\" title=\"Sophos Firewallのダウンロード\"></a>Sophos Firewallのダウンロード</h2><p>Sophosのサイトより、”Sophos Firewall Home Edition”モジュールをダウンロードします。</p>\n<p><a href=\"https://www.sophos.com/ja-jp/products/free-tools.aspx\">https://www.sophos.com/ja-jp/products/free-tools.aspx</a></p>\n<div class=\"link-grid\"><div class=\"link-grid-container\">\n<object class=\"link-grid-image\" data=\"product-firewall.png\"></object>\n<p>Sophos無償ツール</p><p>(https://www.sophos.com/ja-jp/products/free-tools.aspx)お客様がご家庭でも常に安全に PCを利用できるようソフォスでは無償ツールを提供しています。</p>\n<a href=\"https://www.sophos.com/ja-jp/products/free-tools.aspx\"></a>\n</div></div>\n\n<!-- more -->\n<p>Sophos Firewallは、V18まではXG Firewallと呼ばれていました。v18.5よりSophos Firewallに名前が変更になっています。</p>\n<p>ダウンロードサイトでは氏名、勤務先メールアドレスとありますが、ホームユースなので、遠慮なくGmailなどのアドレスを登録します。あっさりとISOファイルのダウンロードボタンが表示されると共に、メール宛にライセンス番号が送られてきます。利用条件としては、あくまで家庭での個人的な使用に限って無料です。<br>ダウンロードはISOイメージです。2023年2月23日時点では、最新のバージョンはv19であり、”SW-19.0.1_MR-1-365.iso”となっています。</p>\n<p>クライアントPC（Windowsなど）から、ESXi管理画面にログインします。ESXiの管理画面の左ペインのストレージからデフォルトのストレージである、datastore1を選択し、データストアブラウザをクリックして下さい。次にアップロードボタンをクリックし、ダウンロードされた”SW-18.5.2_MR-2-380.iso”ファイルをアップロードして下さい。</p>\n<img src=\"/new-technology/2020/03/06/InstallXG/datastore.png\" class=\"\" title=\"alt\">\n\n<h2 id=\"仮想マシンの作成\"><a href=\"#仮想マシンの作成\" class=\"headerlink\" title=\"仮想マシンの作成\"></a>仮想マシンの作成</h2><p>ここから仮想マシンの初期設定です。</p>\n<ol>\n<li>ESXiの管理画面の仮想マシンから新規仮想マシンを選択します。</li>\n<li>仮想マシンの作成を選択し、次へのボタンを押します。</li>\n<li>仮想マシンの名前を決め、ゲストOSを選択します。OSファミリはLinuxで、OSバージョンはその他のLinux4.x（64ビット）を選択します。</li>\n</ol>\n<img src=\"/new-technology/2020/03/06/InstallXG/vm2.png\" class=\"\" title=\"alt\">\n\n<ol>\n<li>ストレージを確認し、次へのボタンを押します。</li>\n</ol>\n<img src=\"/new-technology/2020/03/06/InstallXG/vm3.png\" class=\"\" title=\"alt\">\n\n<ol start=\"2\">\n<li>ここでは、ネットワークカードの追加をし、WAN側のNICを追加します。ネットワークアダプタの詳細（▶︎マークをクリック）でドライバがE1000など選択されている事を確認して下さい。</li>\n</ol>\n<img src=\"/new-technology/2020/03/06/InstallXG/vm4.png\" class=\"\" title=\"alt\">\n\n<ol start=\"3\">\n<li>また、仮想CD-ROMにFirewallのインストールイメージ（isoファイル）をマウントします。</li>\n</ol>\n<img src=\"/new-technology/2020/03/06/InstallXG/vm4-1.png\" class=\"\" title=\"alt\">\n\n<ol start=\"4\">\n<li>起動オプションのファームウェアは<strong>EFIからBIOSに変更</strong>して下さい。</li>\n</ol>\n<img src=\"/new-technology/2020/03/06/InstallXG/vm5.png\" class=\"\" title=\"alt\">\n\n<ol start=\"5\">\n<li>さて、最終確認です。今回のプロビジョニングはシック（Lazy Zeroed）となっています。</li>\n</ol>\n<img src=\"/new-technology/2020/03/06/InstallXG/vm6.png\" class=\"\" title=\"alt\">\n\n<ol start=\"6\">\n<li>最後に完了ボタンを押します。これで仮想マシンが作成されます。</li>\n</ol>\n<img src=\"/new-technology/2020/03/06/InstallXG/vm7.png\" class=\"\" title=\"alt\">\n\n<p>いったんここまでで仮想マシンの作成は終了となります。なお、仮想マシンを選択した状態で「アクション」という歯車マークがあります。これをクリックして、コンソール→VMRCのダウンロードを選択し、”VMware Remote Console”をインストールして下さい。これがあるとブラウザから仮想マシンの画面がポップアップし、仮想マシンを操作出来るようになります。もし物理マシンに直接USBメモリ等でXGをインストールする場合は、対象マシンのBIOS設定でUEFIのチェックを外して下さい。</p>\n<p>(2023-2-23追記）<br>現時点でダウンロードされるモジュールは、Sophos Firewall v19.0がベースとなります。このブログではv18からの記事を掲載しております。</p>\n<div class=\"note warning\"><p>ファイアウォールとしては、UEFIによるセキュアブートが期待されますが、現時点では対応していないようです（Sophosコミュニティでも明確な情報はありませんでした）</p>\n</div>\n\n<div class=\"note info\"><p>Intelの10GbpsのNICをお使いの方は、速度の面で有利なVMXNET3ドライバを選択可能です。ただし、VMXNET3を使う場合は、MTUは1500のまま変更しないことをお勧めします。MTU9000でXGが再起動を繰り返す事象を確認しています</p>\n</div>\n\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"Sophos FirewallをESXi仮想マシンにインストールする","url":"/new-technology/2020/03/06/InstallXG2/","content":"<p class=\"onepoint\">この記事で実現すること</p>\nESXiに環境構築済みの仮想マシンに対し、Sophos Firewallのインストールを行います。ESXiを使わない場合、PC（物理マシン）にフラッシュメモリを接続し直接インストールする事になりますが、この場合も手順自体はほとんど変わりません。\n\n<span id=\"more\"></span>\n\n<h2 id=\"Sophos-Firewallのインストール概要\"><a href=\"#Sophos-Firewallのインストール概要\" class=\"headerlink\" title=\"Sophos Firewallのインストール概要\"></a>Sophos Firewallのインストール概要</h2><p>「<a href=\"/new-technology/2020/03/01/esxi-conf/\" title=\"VMware vSphere Hypervisor（ESXi）の設定\">VMware vSphere Hypervisor（ESXi）の設定</a>」、「<a href=\"/new-technology/2020/03/06/InstallXG/\" title=\"Sophos Firewall のインストール（事前準備）\">Sophos Firewall のインストール（事前準備）</a>」で、ネットワークアドレスを決めました。Firewallのインストール概要は以下の通りです。</p>\n<ul>\n<li>Sophos Firewall(FW)のLAN側ネットワークアドレスは製品のデフォルトである<code>172.16.16.0/24</code>を使うか、自身で決めたESXiが属するネットワークアドレス<code>192.168.1.0/24</code>（例）を使う事になります。ここではFWのWAN側を<code>192.168.0.0/24</code>のネットワーク、FWのLAN側を<code>192.168.1.0/24</code>として説明します。</li>\n<li>ESXiの導入設定では、デフォルトのvSwitch0をLANとし、vSwitch1を追加しWANとしました。</li>\n<li>インターネットに繋がるホームゲートウェイ(HGW)のLAN側IPアドレスはここでは<code>192.168.0.1</code>とします。FWのWAN側IPアドレスはHGWのDHCPによってプライベートIPが割り当てられます。ここでは<code>192.168.0.2</code>とします。</li>\n<li>クライアントPCとESXiのLAN側ネットワークとを接続します。ESXiのLAN側IPアドレスは<code>192.168.1.1</code>とし、ESXiの管理コンソールに接続するクライアントPCは手動でLANのIPアドレスを割り当てます。ここでは<code>192.168.1.101</code>とします。</li>\n<li>仮想マシンは事前に設定されたFWのインストールイメージ（ISOファイル）からブートさせるので、PCのブラウザでESXiホストにログインし、仮想マシンを起動してインストールを行います。ESXiをセットアップした機器にモニタを接続する必要はありません。</li>\n<li>これからインストールするFWはLAN側の管理画面に対し操作することになります。ここではLAN側IPを<code>192.168.1.2</code>とします。</li>\n</ul>\n<p>上記で説明したものをネットワーク構成図にすると以下のようになります。</p>\n<img src=\"/new-technology/2020/03/06/InstallXG2/nw.svg\" class=\"\" width=\"640\" title=\"alt\">\n\n<h3 id=\"仮想マシンを起動する\"><a href=\"#仮想マシンを起動する\" class=\"headerlink\" title=\"仮想マシンを起動する\"></a>仮想マシンを起動する</h3><ul>\n<li>ESXiの管理コンソールからFWの仮想マシンを選んでパワーオンをクリックします。</li>\n<li>Sophos FIRMWARE INSTALLERが起動します。</li>\n<li>インストールを開始すると（仮想マシンに割り当てた）ディスクが全てフォーマットされ、ファームウェアがインストールされていきます。</li>\n<li>press y to rebootでリブートします。</li>\n<li>再起動後、さらにdefault conifgをインストールするとの表示がされ、やがてパスワード入力画面になります。最初のパスワードはadminです。まずライセンスを受け入れる画面となります。続いて、ネットワークの設定を変更します。</li>\n</ul>\n<img src=\"/new-technology/2020/03/06/InstallXG2/conf.png\" class=\"\" title=\"alt\">\n\n<p>1.”Network Configuration”を選び、次の画面で、”1.Interface Configuration”を選びます。以下の表示がEnterを押下する毎に変わります。</p>\n<ul>\n<li>LAN側のIP</li>\n<li>WAN側のIP（ホームゲートウェイからのプライベートIPが割り当てられています）。</li>\n<li>“Set IPv4 Address(y&#x2F;n)”と出るので、変更する場合は、y＋Enterします。</li>\n<li>IPv6は後で設定するので空Enterで構いません。</li>\n</ul>\n<p>この状態で一旦IPの設定を終えたら、クライアントPCのブラウザからFWに対して接続し、セットアップを続けていきます。ここではFWのIPアドレスを<code>192.168.1.2</code>にしたと仮定して進めます。</p>\n<div class=\"note warning\"><p>WANのIPが割り振られていない場合は、後続のセットアップでライセンスの確認ができません。事後にもライセンス登録は可能ですが、初期のうちに課題を解決しておきましょう。</p>\n</div>\n\n<h3 id=\"Firewallの初期設定\"><a href=\"#Firewallの初期設定\" class=\"headerlink\" title=\"Firewallの初期設定\"></a>Firewallの初期設定</h3><p>ブラウザで、<code>&lt;https://192.168.1.2:4444&gt;</code>を開き初期設定を行っていきます。自己証明書でもあり、ブラウザのワーニングが表示されますが、了解のうえ進んでください。</p>\n<img src=\"/new-technology/2020/03/06/InstallXG2/setup1.png\" class=\"\" title=\"alt\">\n\n<p>ここでは、右上のプルダウンで日本語に変更しておくと良いでしょう。続いて、以下の項目を設定していきます。</p>\n<ul>\n<li>管理者パスワード</li>\n<li>タイムゾーン</li>\n<li>登録メールで届いたシリアル番号を入力します</li>\n</ul>\n<img src=\"/new-technology/2020/03/06/InstallXG2/setup2.png\" class=\"\" title=\"alt\">\n\n<ul>\n<li>ゲートウェイとしてルーターモードを選択します</li>\n<li>LAN側に割り振るDHCPのIP範囲を設定します</li>\n</ul>\n<img src=\"/new-technology/2020/03/06/InstallXG2/setup3.png\" class=\"\" title=\"alt\">\n\n<ul>\n<li>ネットワークプロテクションは<strong>SandStormを除き</strong>選択します。仮に選択してもホームユースでは解除されます。</li>\n</ul>\n<img src=\"/new-technology/2020/03/06/InstallXG2/setup4.png\" class=\"\" title=\"alt\">\n\n<p>続いての画面のメールセットアップですが、登録しないと先に進めないので、一旦メールアドレスを登録します。Gmailをお持ちであれば、Gmailをメールの送信者にしておくと比較的簡単に送信できます。メールの受信者は、色々なイベント通知が発生した時に確認するアドレスですので、携帯などのアドレスが候補に挙げられます。</p>\n<img src=\"/new-technology/2020/03/06/InstallXG2/setup5.png\" class=\"\" title=\"alt\">\n\n<p> セットアップも最後の仕上げです。5分程度と言いつつもう少し掛かる場合がありますので、ブラウザのリロードをせずそのまま待ちます。その後管理画面のリロードが入りますが、FWの管理サイトは自己証明書のためにブラウザのワーニングが出た画面で止まっている場合があります。</p>\n<img src=\"/new-technology/2020/03/06/InstallXG2/setup6.png\" class=\"\" title=\"alt\">\n\n<p> ログイン画面です。固定IPにして設定してきたPCも、FWのDHCP機能によって、IPアドレスが割り当て可能となっています。PCの設定をDHCPにして確認して下さい。そして、インターネットにも接続出来ている事を確認して下さい。現段階では、基本はインターネットへの通信は全て通す設定になっているので疎通確認が出来たら、ホームゲートウェイに接続されている他の機器などをFWのLAN側に繋いで下さい。</p>\n<h2 id=\"セキュア・ストレージ・マスターキー\"><a href=\"#セキュア・ストレージ・マスターキー\" class=\"headerlink\" title=\"セキュア・ストレージ・マスターキー\"></a>セキュア・ストレージ・マスターキー</h2><p>FWが再起動し、ログイン後、新たに追加されたセキュア・ストレージ・マスターキーの作成を求められます。</p>\n\n\n<p>以下の通り、最低12文字で、大文字・小文字・記号を含める必要があります。</p>\n\n\n<p>登録を終えると、マスターキーがセットされたとのメッセージが表示されて対応は完了です。</p>\n\n\n<p>マスターキーの情報は暗号化された安全な場所へ保管されることをお勧めします。参考までに「<a href=\"/new-technology/2020/08/30/bitwarden/\" title=\"パスワード管理ソフトのbitwardenを活用する\">パスワード管理ソフトのbitwardenを活用する</a>」を参照してください。</p>\n<h2 id=\"パッチ適用\"><a href=\"#パッチ適用\" class=\"headerlink\" title=\"パッチ適用\"></a>パッチ適用</h2><p>インストール完了後、パッチがある場合は速やかにパッチ提供されることをお勧めします。v18.5をインストールされた場合、2022-03-26時点において最新版はMR3となります。「<a href=\"/new-technology/2022/03/25/xg-v185-mr3/\" title=\"Sophos Firewall v18.5 MR-3\">Sophos Firewall v18.5 MR-3</a>」の記事を参照してください。</p>\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"XG Firewall v18で正しいDNS利用を強制する","url":"/new-technology/2020/05/16/Intercept-DNS/","content":"<p class=\"onepoint\">この記事で実現すること</p>\nユーザーが指定したDNS（多くはプロバイダDNS）に反し、行儀の悪いクライアントや悪意のあるプログラムはそれに従わず、別のDNSを参照する可能性があります。XG Firewall v18の機能を活用してDNSの安全性を確保します。\n\n<span id=\"more\"></span>\n\n<h2 id=\"DNSとプライバシー\"><a href=\"#DNSとプライバシー\" class=\"headerlink\" title=\"DNSとプライバシー\"></a>DNSとプライバシー</h2><p>Sophos CommunityでもDNSの扱いについてはいろいろ議論されていますが、ベストプラクティスとしては<strong>DNS Best Practices for XG</strong>の記事にいくつかのアドバイスがあります。（※過去記事についてすでに削除されてしまいました）</p>\n<blockquote class=\"blockquote-center\">\n<p>The best protection is to use XG as dns server, configure dns request routing and nothing else. Avoid to open udp port 53.<br>最良の防御策はXGをDNSサーバとして使用し、DNSリクエストのルーティングを設定すること。それ以外は何も行わないことです。udpポート53を開かないようにしてください。</p>\n\n</blockquote>\n\n<p>この一言で既にDNSの使い方については答えが出てしまいましたが、記事が2017年とやや古い事もあり、v18の機能を生かしたDNSの設定例を書きます。</p>\n<p>DNSとプライバシーは国によって扱いが変わるかも知れません。国が人々のネットのアクセス状況を把握している事が問題とされている場所では、パブリックDNSが好まれます。また海外ではプロバイダーがDNSを改ざんするといったニュースも見かけます。日本国内においては、プロバイダのDNSの応答速度が遅い事から利用されるケースが増えてきているようです。</p>\n<p>ブラウザのFireFoxでは、プライバシー保護を目的として、DNSについてHTTPSを利用したDNS over HTTPSに対応しています。この機能は日本ではデフォルトでオフになっていますが、HTTPSで暗号化されているため管理者側からは一般的なネットブラウジングと区別がつかず、トラフィックが見えづらくなります。</p>\n<p>私個人としてはDNSを含めたプライバシーの情報を無闇に拡散させない事が重要と考えています。また、Communityで言及されている通り、防御のためにDNSのPortは空けない事が重要と考えます。パブリックDNSの利用はユーザーそれぞれにとっては考え方は異なるかとおもいますので、これ以降は悪意をもったクライアントが本来のDNS設定を迂回する事の対策として読んでいただければとおもいます。</p>\n<h2 id=\"XG-v18で指定DNSを強制する\"><a href=\"#XG-v18で指定DNSを強制する\" class=\"headerlink\" title=\"XG v18で指定DNSを強制する\"></a>XG v18で指定DNSを強制する</h2><p>ここではDNS情報はDHCPで配布されている前提とします。このブログでは、クライアントが参照するDNSは、全てXGのDNSを指定するように設定しています。この前提で、これを回避しようとするクライアントに対して以下の対策を取ります。</p>\n<ul>\n<li>DNS over TLS(DoT)は拒否<br> Port853の拒否</li>\n<li>DNS over HTTPS(DoH)は拒否<br> RFC8484に基づき、MIMEヘッダーの”application&#x2F;dns-message”を見つけて、その通信を拒否</li>\n<li>Public DNSへのアクセス（Port53）は、強制的にXGのDNS経由で本来のDNSにアクセス<br> XGのDNATの機能を使い、WANインターフェースに対するPort53の通信だった場合、宛先IPをXGのLANのIPアドレスに変換</li>\n</ul>\n<img src=\"/new-technology/2020/05/16/Intercept-DNS/xg-dns.png\" class=\"\" title=\"alt\">\n\n<p>アプリケーションは、DoTやDoHを止められると（一般的には）通常のDNS(Port53)にフォールバックします。そしてXGは強制的にDNSの向き先を変えますが、クライアントはパブリックDNSにアクセスしたと思い込んだまま、返されたIPに対しアクセスする事になります。</p>\n<h3 id=\"DoHの拒否\"><a href=\"#DoHの拒否\" class=\"headerlink\" title=\"DoHの拒否\"></a>DoHの拒否</h3><p>DoHの定義についてサービスの登録を行います。</p>\n<p>XGの左ペインメニュー<mark class=\"label primary\">Web</mark>の<mark class=\"label primary\">ファイルタイプ</mark>から追加ボタンをクリックします。<mark class=\"label primary\">名前</mark>は”DoH”、<mark class=\"label primary\">テンプレート</mark>を空白とし、<mark class=\"label primary\">MIMEヘッダー</mark>に<code>application/dns-message</code>と入力し、保存します。</p>\n<img src=\"/new-technology/2020/05/16/Intercept-DNS/mimetype.png\" class=\"\" title=\"alt\">\n\n<p>左ペインメニュー<mark class=\"label primary\">Web</mark>の<mark class=\"label primary\">ユーザーアクティビティ</mark>から”追加”ボタンをクリックし、DoHとして登録したカテゴリを加え、<code>DNS over HTTPS</code>と名前を付けて保存します。</p>\n<img src=\"/new-technology/2020/05/16/Intercept-DNS/mimetype2.png\" class=\"\" title=\"alt\">\n\n<p>続いて、具体的な拒否設定です。</p>\n<p>左ペインメニュー<mark class=\"label primary\">Web</mark>の<mark class=\"label primary\">ポリシー</mark>からご自身がFirewallルールで利用しているポリシー（ここでは”Home Policy”を仮定しています）に、上記で登録してきた”DNS over HTTPS”を拒否する設定を加えます。</p>\n<img src=\"/new-technology/2020/05/16/Intercept-DNS/policy.png\" class=\"\" title=\"alt\">\n\n<h3 id=\"DoTの拒否\"><a href=\"#DoTの拒否\" class=\"headerlink\" title=\"DoTの拒否\"></a>DoTの拒否</h3><p>XGの左ペインメニュー<mark class=\"label primary\">ホストとサービス</mark>の<mark class=\"label primary\">サービス</mark>から、”追加”ボタンをクリックし、”送信元ポート”1〜65535、”宛先ポート”853を指定し、”DoT”と名前を付け保存します。</p>\n<img src=\"/new-technology/2020/05/16/Intercept-DNS/service.png\" class=\"\" title=\"alt\">\n\n<p>XGの左ペインメニュー<mark class=\"label primary\">ルールとポリシー</mark>から新しいファイアウォールルールを追加し、以下のようにDoTを”拒否”するルールを作成します。</p>\n<img src=\"/new-technology/2020/05/16/Intercept-DNS/rule1.png\" class=\"\" title=\"alt\">\n\n<h3 id=\"DNSに関するDNAT\"><a href=\"#DNSに関するDNAT\" class=\"headerlink\" title=\"DNSに関するDNAT\"></a>DNSに関するDNAT</h3><p>最初にDNATで必要なホストの定義を行います。LANで使っているネットワークアドレスの登録とXG自身のIPアドレスの登録が必要です。ネットワークアドレスについてIPv4は例えば、<code>192.168.1.0/24</code>、IPv6は例えば<code>fd00:beef:cafe::/64</code>などの登録を行います。XG自身のIPアドレスも登録が必要です。</p>\n<img src=\"/new-technology/2020/05/16/Intercept-DNS/host.png\" class=\"\" title=\"alt\">\n\n<p>XGの左ペインメニュー<mark class=\"label primary\">ルールとポリシー</mark>から、<mark class=\"label primary\">NATルール</mark>を選択、”NATルールの追加”ボタンをクリックし、DNATを設定します。</p>\n<ol>\n<li>“変換前の送信元”は、使っているネットワークのオブジェクトを登録します</li>\n<li>“変換前のサービス”は、”DNS”を選択します</li>\n<li>“返還後の宛先（DNAT）”は、XG自身のIPを指定します</li>\n<li>“アウトバウンドインターフェース”には、WANである、”Port2”を選択します</li>\n<li>最後に追加ボタンをクリックして登録を完了します</li>\n</ol>\n<img src=\"/new-technology/2020/05/16/Intercept-DNS/rule2.png\" class=\"\" title=\"alt\">\n\n<p>上記はIPv4の例ですが、IPv6を利用されている方は、同様にIPv6のDNATも設定してください。</p>\n<h3 id=\"動作確認\"><a href=\"#動作確認\" class=\"headerlink\" title=\"動作確認\"></a>動作確認</h3><p>上記DNATによるDNSのインターセプトが有効になると、<mark class=\"label primary\">ルールとポリシー</mark>の<mark class=\"label primary\">NATルール</mark>画面で実際に変換された数が確認できるので、これで挙動を確認してください。</p>\n<img src=\"/new-technology/2020/05/16/Intercept-DNS/rule3.png\" class=\"\" title=\"alt\">\n\n<p>以上がプライバシーと安全性を重視したv18ならではのDNSのベストプラクティスです。</p>\n<h2 id=\"DNSに関しての補足\"><a href=\"#DNSに関しての補足\" class=\"headerlink\" title=\"DNSに関しての補足\"></a>DNSに関しての補足</h2><p>GoogleDNSのDoHはRFC8484に従っていない独自プロトコルを使えるという事実があります。世界中のパブリックDNSを全て把握するのは困難ですが、Sophosのコミュニティの記事を参考にWebフィルタのURLグループにパブリックDNSのドメインを登録し、拒否する設定を加えても良いでしょう。詳細は、以下の記事を参照してください。</p>\n<blockquote>\n<p>Sophos Community -DNS over HTTPS (DoH) for web security-<br> <a href=\"https://community.sophos.com/kb/en-us/134644\">https://community.sophos.com/kb/en-us/134644</a></p>\n</blockquote>\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"Mellanox Connect XとWindows11","url":"/new-technology/2023/03/25/Mellanox-ConnectXandWindows11/","content":"<img src=\"/new-technology/2023/03/25/Mellanox-ConnectXandWindows11/title.png\" class=\"\" width=\"1024\" title=\"alt\">\n<p class=\"onepoint\">この記事で実現すること</p>\n\n<p>この記事ではSFP+のネットワークカードである、Mellanox Connect XについてWindows11の対応状況やWindowsでのファームウェアアップデートなどを記します。</p>\n<span id=\"more\"></span>\n\n<h2 id=\"安価なMellanox-Connect-Xカード\"><a href=\"#安価なMellanox-Connect-Xカード\" class=\"headerlink\" title=\"安価なMellanox Connect-Xカード\"></a>安価なMellanox Connect-Xカード</h2><p>すでに販売終了となったConnect X-3はeBayで5,000円弱で売られています。MellanoxのConnect Xシリーズは脆弱性の指摘も見かけず、安定しているNICでしょうか。intelに比べればマイナーですが、SFP＋で安価に入手可能となっており、ホームユーザーにとっても大変ありがたい存在です。<br>Connect X-3はWindows10までのドライバはNvidiaのサイトに掲載されていますがWindows11ではドライバの存在はありません。</p>\n<p>しかしながら、Windows11ではConnect Xを認識してWindowsとして用意されたドライバのインストールが行われ、すぐに使えます。いわゆる、Windows11に標準で付属しているinboxドライバになります。逆にNVidiaサイトにあるWindows10用のドライバはWindows11ではエラーが発生し動きません。後述のNVidiaフォーラムの投稿をご確認ください。</p>\n<p>最近、2PortのMellanox Connect X-4 LxをeBayでちらほら見かけるようになってきました。販売終了した製品ですが、サポートはされています。</p>\n<p><strong>MCX4121A-ACAT</strong>という型番は、<strong>Mellanox ConnectX-4 LX 25GBE SFP28 2ポートPCIeイーサネット アダプター</strong>となっており、eBayで15,000円ほどで購入できます。SFP28はSFP+とモジュール接続口の互換性があります。SFP＋のダイレクトアタッチケーブル（DAC）やOM3ケーブルと共に使うSFP+短距離マルチモードファイバ（MM SR）モジュール等の10GbE SFP+で問題なく10Gbps通信できます。もちろん25GbEとしても使えますが、PCなどホスト端末に挿して使うには他の機器との速度差が大きすぎて使いにくいものです。intel製のNICは在庫不足から回復傾向にあるようですが、まだまだ高額です。</p>\n<p>詳しいスペックは以下のリンクを参照してください。PCIe3 x8となっています。</p>\n<blockquote>\n<p>Mellanox Connect X-4<br> <a href=\"https://network.nvidia.com/files/doc-2020/pb-connectx-4-lx-en-card.pdf\">https://network.nvidia.com/files/doc-2020/pb-connectx-4-lx-en-card.pdf</a></p>\n</blockquote>\n<p>Connect X-3はやや個人向けの色合いが強かったですが、Connect X-4あたりからはサーバー製品としての要素が強くなっていきます。OEM版（HPE、DELL向け等）は避けることをお勧めします。これはベンダーロックインが掛かっている可能性が高く、ファームウェアの強制書き込みなどが必要になります。また、それでうまくいく保証もありません。また、Connect X-4はいろいろなホストインタフェースがありますので、Ethernet、PCIeというところに気をつけてください。PCIeスロットに挿すだけですぐにWindows11で使えるMCX4121A-ACATはお勧めです。</p>\n<p>2Portも要らないといっても、eBayでは意外と1Portものが出ていません。また、他カードとの兼ね合い（x16が埋まっている）でPCIe x4までという方は一般論としてConnect X-3（MCX311A-XCAT）が向いています。</p>\n<blockquote>\n<p>Nvidia ConnectX-4 Lx 製品概要<br> <a href=\"https://www.nvidia.com/ja-jp/networking/ethernet/connectx-4-lx/\">https://www.nvidia.com/ja-jp/networking/ethernet/connectx-4-lx/</a></p>\n</blockquote>\n<blockquote>\n<p>NVidiaフォーラムでConnect X-3のWin11のドライバが無いことをNVidiaのテクニカルサポートが示唆<br> <a href=\"https://forums.developer.nvidia.com/t/connectx-3-cx311a-xcat-for-win11-crashed/205962\">https://forums.developer.nvidia.com/t/connectx-3-cx311a-xcat-for-win11-crashed/205962</a></p>\n</blockquote>\n<h2 id=\"Windows11でのデバイスドライバ\"><a href=\"#Windows11でのデバイスドライバ\" class=\"headerlink\" title=\"Windows11でのデバイスドライバ\"></a>Windows11でのデバイスドライバ</h2><h3 id=\"Connect-X-3\"><a href=\"#Connect-X-3\" class=\"headerlink\" title=\"Connect X-3\"></a>Connect X-3</h3><p>Connect X-3をPCIeにセットしてWin11を起動します。デバイスドライバを見てみます。</p>\n<img src=\"/new-technology/2023/03/25/Mellanox-ConnectXandWindows11/x3.png\" class=\"\" width=\"480\" title=\"alt\">\n\n<p>2019年のinboxドライバが自動的に取り込まれます。このドライバに脆弱性が出てしまえば、リスクがあり別の製品に買い替えが必要となりますが、脆弱性データベースでもなかなかMellanoxの名前を見ることはありません。</p>\n<p>お約束ですが、ESXi上のUbuntuとのiperf3を実行してみます。MTUは1,500のデフォルト、スイッチはフローコントロールをオンにしています。<br>多重度3でUbuntuからダウンロードする方向（-Rオプション）に実行して以下の通りです。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">[ ID] Interval           Transfer     Bitrate         Retr</span><br><span class=\"line\">[  5]   0.00-10.05  sec  3.81 GBytes  3.26 Gbits/sec  615             sender</span><br><span class=\"line\">[  5]   0.00-10.00  sec  3.81 GBytes  3.27 Gbits/sec                  receiver</span><br><span class=\"line\">[  7]   0.00-10.05  sec  3.46 GBytes  2.96 Gbits/sec  423             sender</span><br><span class=\"line\">[  7]   0.00-10.00  sec  3.46 GBytes  2.97 Gbits/sec                  receiver</span><br><span class=\"line\">[  9]   0.00-10.05  sec  3.79 GBytes  3.24 Gbits/sec  623             sender</span><br><span class=\"line\">[  9]   0.00-10.00  sec  3.78 GBytes  3.25 Gbits/sec                  receiver</span><br><span class=\"line\">[SUM]   0.00-10.05  sec  11.1 GBytes  9.45 Gbits/sec  1661             sender</span><br><span class=\"line\">[SUM]   0.00-10.00  sec  11.1 GBytes  9.49 Gbits/sec                  receiver</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>(Ryzen 7 5700G、メモリDDR4-3200 DIMM (PC4-25600)32GByte)<br>このPCにはPCIe×16のスロットにConnect X-4を、PCIe x4のスロットにConnect X-3を挿しています。</p>\n<p>少しリトライが多いようですが、9.49Gbpsです。<code>-R -P3</code>オプションとして逆方向の送信（ダウンロード）、多重度3のみ、それ以外のオプションは指定していません。Windows10時代でも多重度は4程度から9.3Gbpsをマークしていたと記憶しているので、まずまずでしょうか。Windows11側がダウンロード側ですのでUbuntu側の送信速度に少し追いついていないようです。これはドライバが最適化されていない可能性もあります。しかし、実運用として使うのであれば十分でしょう。</p>\n<h3 id=\"Connect-X-4\"><a href=\"#Connect-X-4\" class=\"headerlink\" title=\"Connect X-4\"></a>Connect X-4</h3><p>Connect X-4はWindows11で自動導入されるドライバは2020年のものですが、新しいドライバをNvidiaからダウンロードできます。</p>\n<img src=\"/new-technology/2023/03/25/Mellanox-ConnectXandWindows11/x4.png\" class=\"\" width=\"480\" title=\"alt\">\n\n<p>NVidiaではSoftwareのEthernetの分類でドライバを検索することになります。<br><a href=\"https://developer.nvidia.com/networking/ethernet-software\">https://developer.nvidia.com/networking/ethernet-software</a></p>\n<p>具体的には、以下のWinOF-2がWin10以降のドライバとなります。</p>\n<blockquote>\n<p>MLNX_OFED for Windows - WinOF &#x2F; WinOF-2<br> <a href=\"https://network.nvidia.com/products/adapter-software/ethernet/windows/winof-2/\">https://network.nvidia.com/products/adapter-software/ethernet/windows/winof-2/</a></p>\n</blockquote>\n<p>Connect X-4は2023年2月2日に発表されたRevision3.20.50010が最新のようですが、実際のドライバは上記のキャプチャの通り、3.2.25がインストールされます。</p>\n<p>セットアップはただインストーラの指示に従い、進めていくだけなので何も難しいものはありません。</p>\n<img src=\"/new-technology/2023/03/25/Mellanox-ConnectXandWindows11/setup.png\" class=\"\" width=\"480\" title=\"alt\">\n\n<h2 id=\"Connect-X-4のスループット\"><a href=\"#Connect-X-4のスループット\" class=\"headerlink\" title=\"Connect X-4のスループット\"></a>Connect X-4のスループット</h2><p>PCのConnect X-4（SFP28スロット）にSFP＋モジュールを挿入し、対向もスイッチに挿します。</p>\n<p>Connect X-3もConnect X-4も同じ10GbEとして使うなら変わらないように思えますが、ドライバの違いもさることながら能力は結構違います。<br>多重度1でUbuntuに対して実行した結果です。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">Connect X-4 flow control send</span><br><span class=\"line\"></span><br><span class=\"line\">[ ID] Interval           Transfer     Bitrate</span><br><span class=\"line\">[  5]   0.00-1.00   sec  1.11 GBytes  9.51 Gbits/sec</span><br><span class=\"line\">[  5]   1.00-2.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class=\"line\">[  5]   2.00-3.00   sec  1.10 GBytes  9.49 Gbits/sec</span><br><span class=\"line\">[  5]   3.00-4.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class=\"line\">[  5]   4.00-5.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class=\"line\">[  5]   5.00-6.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class=\"line\">[  5]   6.00-7.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class=\"line\">[  5]   7.00-8.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class=\"line\">[  5]   8.00-9.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class=\"line\">[  5]   9.00-10.00  sec  1.10 GBytes  9.49 Gbits/sec</span><br><span class=\"line\">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class=\"line\">[ ID] Interval           Transfer     Bitrate</span><br><span class=\"line\">[  5]   0.00-10.00  sec  11.1 GBytes  9.49 Gbits/sec                  sender</span><br><span class=\"line\">[  5]   0.00-10.04  sec  11.0 GBytes  9.45 Gbits/sec                  receiver</span><br><span class=\"line\"></span><br><span class=\"line\">Connect X-4 flow control recv</span><br><span class=\"line\"></span><br><span class=\"line\">[ ID] Interval           Transfer     Bitrate</span><br><span class=\"line\">[  5]   0.00-1.00   sec  1.11 GBytes  9.51 Gbits/sec</span><br><span class=\"line\">[  5]   1.00-2.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class=\"line\">[  5]   2.00-3.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class=\"line\">[  5]   3.00-4.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class=\"line\">[  5]   4.00-5.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class=\"line\">[  5]   5.00-6.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class=\"line\">[  5]   6.00-7.00   sec  1.10 GBytes  9.49 Gbits/sec</span><br><span class=\"line\">[  5]   7.00-8.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class=\"line\">[  5]   8.00-9.00   sec  1.10 GBytes  9.48 Gbits/sec</span><br><span class=\"line\">[  5]   9.00-10.00  sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class=\"line\">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class=\"line\">[ ID] Interval           Transfer     Bitrate         Retr</span><br><span class=\"line\">[  5]   0.00-10.05  sec  11.1 GBytes  9.45 Gbits/sec    0             sender</span><br><span class=\"line\">[  5]   0.00-10.00  sec  11.1 GBytes  9.49 Gbits/sec                  receiver</span><br></pre></td></tr></table></figure>\n\n<p>非常に安定していますね。Windowsのiperf3のシングルプロセスでRetryが0です。<br>ちなみにこれだけ安定しているならということでスイッチのフローコントロールを外してみます。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">Connect X-4 no flow control send</span><br><span class=\"line\"></span><br><span class=\"line\">[ ID] Interval           Transfer     Bitrate</span><br><span class=\"line\">[  5]   0.00-1.00   sec  1.11 GBytes  9.52 Gbits/sec</span><br><span class=\"line\">[  5]   1.00-2.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class=\"line\">[  5]   2.00-3.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class=\"line\">[  5]   3.00-4.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class=\"line\">[  5]   4.00-5.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class=\"line\">[  5]   5.00-6.00   sec  1.10 GBytes  9.49 Gbits/sec</span><br><span class=\"line\">[  5]   6.00-7.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class=\"line\">[  5]   7.00-8.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class=\"line\">[  5]   8.00-9.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class=\"line\">[  5]   9.00-10.00  sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class=\"line\">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class=\"line\">[ ID] Interval           Transfer     Bitrate</span><br><span class=\"line\">[  5]   0.00-10.00  sec  11.1 GBytes  9.50 Gbits/sec                  sender</span><br><span class=\"line\">[  5]   0.00-10.04  sec  11.1 GBytes  9.45 Gbits/sec                  receiver</span><br><span class=\"line\"></span><br><span class=\"line\">Connect X-4 no flow control recv</span><br><span class=\"line\"></span><br><span class=\"line\">[ ID] Interval           Transfer     Bitrate</span><br><span class=\"line\">[  5]   0.00-1.00   sec  1.11 GBytes  9.49 Gbits/sec</span><br><span class=\"line\">[  5]   1.00-2.00   sec  1.10 GBytes  9.47 Gbits/sec</span><br><span class=\"line\">[  5]   2.00-3.00   sec  1.10 GBytes  9.47 Gbits/sec</span><br><span class=\"line\">[  5]   3.00-4.00   sec  1.10 GBytes  9.47 Gbits/sec</span><br><span class=\"line\">[  5]   4.00-5.00   sec  1.10 GBytes  9.47 Gbits/sec</span><br><span class=\"line\">[  5]   5.00-6.00   sec  1.10 GBytes  9.47 Gbits/sec</span><br><span class=\"line\">[  5]   6.00-7.00   sec  1.10 GBytes  9.47 Gbits/sec</span><br><span class=\"line\">[  5]   7.00-8.00   sec  1.10 GBytes  9.47 Gbits/sec</span><br><span class=\"line\">[  5]   8.00-9.00   sec  1.10 GBytes  9.47 Gbits/sec</span><br><span class=\"line\">[  5]   9.00-10.00  sec  1.10 GBytes  9.45 Gbits/sec</span><br><span class=\"line\">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class=\"line\">[ ID] Interval           Transfer     Bitrate         Retr</span><br><span class=\"line\">[  5]   0.00-10.05  sec  11.0 GBytes  9.42 Gbits/sec    0             sender</span><br><span class=\"line\">[  5]   0.00-10.00  sec  11.0 GBytes  9.47 Gbits/sec                  receiver</span><br></pre></td></tr></table></figure>\n\n<p>フローコントロール無しでこれは良い結果です。もっとも、アプリケーション（iperf3）が再送を必要としていないだけであって、NIC同士がオフロードして送受信管理するのでOSまでその情報は見えていないと考えられます。昔はとても高価かつ使いこなすのが難しいNICでしたが、シンプルに使うだけであれば、容易にその高い性能がホームユーザーにも享受できるようになってきました。</p>\n<h2 id=\"Connect-Xのファームウェア更新（Windows版）\"><a href=\"#Connect-Xのファームウェア更新（Windows版）\" class=\"headerlink\" title=\"Connect Xのファームウェア更新（Windows版）\"></a>Connect Xのファームウェア更新（Windows版）</h2><p>特にMellanoxのNICで脆弱性という話を聞いたことはなく、頻繁にパッチが出ないので本当に運用が楽ではありますが購入時にファームウェアを更新しておきましょう。「<a href=\"/new-technology/2022/04/02/nic-firmware/\" title=\"ESXiでネットワークカードのファームウェアを更新する\">ESXiでネットワークカードのファームウェアを更新する</a>」ではネットに接続されていない前提としてパッチを個別にダウンロードしましたが、Windowsの場合はネットに接続されている事が前提でしょうから、もう少し手間は省けます（ESXiホスト自身はNTPなど限定されたサービスを除きインターネットアクセスしないのが一般的です）。</p>\n<p>WindowsにおいてMellanoxカードのファームウェアの更新にはMFTとmlxupの2つのツールが必要です。<br>まずMFTのインストールになります。以下のURLからMFTをダウンロードします。</p>\n<blockquote>\n<p>NVIDIA Firmware Tools (MFT)<br> <a href=\"https://network.nvidia.com/products/adapter-software/firmware-tools/\">https://network.nvidia.com/products/adapter-software/firmware-tools/</a></p>\n</blockquote>\n<p>2023-3-25時点では、2023-1-31リリースの4.23.0が最新のようです。<br>MFTもインストーラーで特に悩むこともなくセットアップを完了させます。OSを再起動するとMFTツールは自動起動されますが、再起動しなくともコマンドプロンプトから<code>mst server start</code>でサービスが起動します。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">C:\\Users\\yoshi&gt;mst server start</span><br><span class=\"line\"></span><br><span class=\"line\">C:\\Users\\yoshi&gt;Waiting for connection on port 23108</span><br></pre></td></tr></table></figure>\n<p>引き続き、管理者権限のコマンドプロンプトを開き、<code>mst status</code>を実行するとNICの情報が得られます。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">C:\\Windows\\System32&gt;mst status</span><br><span class=\"line\">MST devices:</span><br><span class=\"line\">------------</span><br><span class=\"line\"></span><br><span class=\"line\">  mt4117_pciconf0</span><br><span class=\"line\"></span><br><span class=\"line\">C:\\Windows\\System32&gt;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>続いてmlxupのダウンロードです。これはexeファイルそのものなので、ブラウザからのダウンロード時に警告が出るかもしれません。</p>\n<blockquote>\n<p>mlxup - Update and Query Utility<br> <a href=\"https://network.nvidia.com/support/firmware/mlxup-mft/\">https://network.nvidia.com/support/firmware/mlxup-mft/</a></p>\n</blockquote>\n<p>ダウンロードしたら、コマンドプロンプトにて<code>mlxup.exe --query</code>を実行します。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">mlxup --query</span><br><span class=\"line\"></span><br><span class=\"line\">Querying Mellanox devices firmware ...</span><br><span class=\"line\"></span><br><span class=\"line\">Device #1:</span><br><span class=\"line\">----------</span><br><span class=\"line\"></span><br><span class=\"line\">  Device Type:      ConnectX4LX</span><br><span class=\"line\">  Part Number:      MCX4121A-ACA_Ax</span><br><span class=\"line\">  Description:      ConnectX-4 Lx EN network interface card; 25GbE dual-port SFP28; PCIe3.0 x8; ROHS R6</span><br><span class=\"line\">  PSID:             MT_2420110034</span><br><span class=\"line\">  PCI Device Name:  mt4117_pciconf0</span><br><span class=\"line\">  Base MAC:         0c42a1000000</span><br><span class=\"line\">  Versions:         Current        Available</span><br><span class=\"line\">     FW             14.25.1020     14.32.1010</span><br><span class=\"line\">     PXE            3.5.0701       3.6.0502</span><br><span class=\"line\">     UEFI           14.18.0019     14.25.0017</span><br><span class=\"line\"></span><br><span class=\"line\">  Status:           Update required</span><br></pre></td></tr></table></figure>\n\n<p>するとこのようにファームウェアの情報とアップデート可能か否かの情報が得られます。<br>実際のファームウェアの更新は<code>mlxup --online</code>です。これで適切なファームウェアがダウンロードされ適用されます。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">C:\\Users\\yoshi\\Downloads&gt;mlxup --online</span><br><span class=\"line\">Querying Mellanox devices firmware ...</span><br><span class=\"line\"></span><br><span class=\"line\">Device #1:</span><br><span class=\"line\">----------</span><br><span class=\"line\"></span><br><span class=\"line\">  Device Type:      ConnectX4LX</span><br><span class=\"line\">  Part Number:      MCX4121A-ACA_Ax</span><br><span class=\"line\">  Description:      ConnectX-4 Lx EN network interface card; 25GbE dual-port SFP28; PCIe3.0 x8; ROHS R6</span><br><span class=\"line\">  PSID:             MT_2420110034</span><br><span class=\"line\">  PCI Device Name:  mt4117_pciconf0</span><br><span class=\"line\">  Base MAC:         0c42a1000000</span><br><span class=\"line\">  Versions:         Current        Available</span><br><span class=\"line\">     FW             14.25.1020     14.32.1010</span><br><span class=\"line\">     PXE            3.5.0701       3.6.0502</span><br><span class=\"line\">     UEFI           14.18.0019     14.25.0017</span><br><span class=\"line\"></span><br><span class=\"line\">  Status:           Update required</span><br><span class=\"line\"></span><br><span class=\"line\">Release notes for the available Firmware:</span><br><span class=\"line\">-----------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\">  For more details, please refer to the following FW release notes:</span><br><span class=\"line\">    1- ConnectX3 (2.42.5000):    http://www.mellanox.com/pdf/firmware/ConnectX3-FW-2_42_5000-release_notes.pdf</span><br><span class=\"line\">    2- ConnectX3Pro (2.42.5000): http://www.mellanox.com/pdf/firmware/ConnectX3Pro-FW-2_42_5000-release_notes.pdf</span><br><span class=\"line\">    3- Connect-IB (10.16.1200):  http://www.mellanox.com/pdf/firmware/ConnectIB-FW-10_16_1200-release_notes.pdf</span><br><span class=\"line\">    4- ConnectX4 (12.28.2006):   http://docs.mellanox.com/display/ConnectX4Firmwarev12282006</span><br><span class=\"line\">    5- ConnectX4Lx (14.32.1010): http://docs.mellanox.com/display/ConnectX4LxFirmwarev14321010</span><br><span class=\"line\">    6- ConnectX5 (16.35.2000):   http://docs.mellanox.com/display/ConnectX5Firmwarev16352000</span><br><span class=\"line\">    7- ConnectX6 (20.36.1010):   http://docs.mellanox.com/display/ConnectX6Firmwarev20361010</span><br><span class=\"line\">    8- ConnectX6Dx (22.36.1010):   http://docs.mellanox.com/display/ConnectX6DxFirmwarev22361010</span><br><span class=\"line\">    9- ConnectX6Lx (26.36.1010):   http://docs.mellanox.com/display/ConnectX6LxFirmwarev26361010</span><br><span class=\"line\">    10- BlueField2 (24.35.2000):   http://docs.mellanox.com/display/BlueField2Firmwarev24352000</span><br><span class=\"line\">    11- ConnectX7 (28.36.1010):   http://docs.mellanox.com/display/ConnectX7Firmwarev28361010</span><br><span class=\"line\"></span><br><span class=\"line\">---------</span><br><span class=\"line\">Found 1 device(s) requiring firmware update...</span><br><span class=\"line\"></span><br><span class=\"line\">Perform FW update? [y/N]: y</span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">CMD: mlxup -u --log-on-update --ssl-certificate C:\\Users\\yoshi\\AppData\\Local\\Temp\\sfxter_yoshi_3512\\mlxup-dir\\ca-bundle.crt --current-dir C:\\Users\\yoshi\\Downloads\\  --online</span><br><span class=\"line\">Querying Mellanox devices firmware ...</span><br><span class=\"line\"></span><br><span class=\"line\">Device #1:</span><br><span class=\"line\">----------</span><br><span class=\"line\"></span><br><span class=\"line\">  Device Type:      ConnectX4LX</span><br><span class=\"line\">  Part Number:      MCX4121A-ACA_Ax</span><br><span class=\"line\">  Description:      ConnectX-4 Lx EN network interface card; 25GbE dual-port SFP28; PCIe3.0 x8; ROHS R6</span><br><span class=\"line\">  PSID:             MT_2420110034</span><br><span class=\"line\">  PCI Device Name:  mt4117_pciconf0</span><br><span class=\"line\">  Base MAC:         0c42a1000000</span><br><span class=\"line\">  Versions:         Current        Available</span><br><span class=\"line\">     FW             14.25.1020     14.32.1010</span><br><span class=\"line\">     PXE            3.5.0701       3.6.0502</span><br><span class=\"line\">     UEFI           14.18.0019     14.25.0017</span><br><span class=\"line\"></span><br><span class=\"line\">  Status:           Update required</span><br><span class=\"line\"></span><br><span class=\"line\">Release notes for the available Firmware:</span><br><span class=\"line\">-----------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\">  For more details, please refer to the following FW release notes:</span><br><span class=\"line\">    1- ConnectX3 (2.42.5000):    http://www.mellanox.com/pdf/firmware/ConnectX3-FW-2_42_5000-release_notes.pdf</span><br><span class=\"line\">    2- ConnectX3Pro (2.42.5000): http://www.mellanox.com/pdf/firmware/ConnectX3Pro-FW-2_42_5000-release_notes.pdf</span><br><span class=\"line\">    3- Connect-IB (10.16.1200):  http://www.mellanox.com/pdf/firmware/ConnectIB-FW-10_16_1200-release_notes.pdf</span><br><span class=\"line\">    4- ConnectX4 (12.28.2006):   http://docs.mellanox.com/display/ConnectX4Firmwarev12282006</span><br><span class=\"line\">    5- ConnectX4Lx (14.32.1010): http://docs.mellanox.com/display/ConnectX4LxFirmwarev14321010</span><br><span class=\"line\">    6- ConnectX5 (16.35.2000):   http://docs.mellanox.com/display/ConnectX5Firmwarev16352000</span><br><span class=\"line\">    7- ConnectX6 (20.36.1010):   http://docs.mellanox.com/display/ConnectX6Firmwarev20361010</span><br><span class=\"line\">    8- ConnectX6Dx (22.36.1010):   http://docs.mellanox.com/display/ConnectX6DxFirmwarev22361010</span><br><span class=\"line\">    9- ConnectX6Lx (26.36.1010):   http://docs.mellanox.com/display/ConnectX6LxFirmwarev26361010</span><br><span class=\"line\">    10- BlueField2 (24.35.2000):   http://docs.mellanox.com/display/BlueField2Firmwarev24352000</span><br><span class=\"line\">    11- ConnectX7 (28.36.1010):   http://docs.mellanox.com/display/ConnectX7Firmwarev28361010</span><br><span class=\"line\"></span><br><span class=\"line\">---------</span><br><span class=\"line\">Found 1 device(s) requiring firmware update...</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Please wait while downloading MFA(s) ...</span><br><span class=\"line\">Device #1: Updating FW ...</span><br><span class=\"line\"></span><br><span class=\"line\">FSMST_INITIALIZE -   OK</span><br><span class=\"line\"></span><br><span class=\"line\">Writing Boot image component -   0%</span><br><span class=\"line\">Writing Boot image component -   1%</span><br><span class=\"line\">Writing Boot image component -   2%</span><br><span class=\"line\">(省略)</span><br><span class=\"line\">Writing Boot image component - 100%</span><br><span class=\"line\">Writing Boot image component -   OK</span><br><span class=\"line\">\b\b\b\bDone</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Restart needed for updates to take effect.</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>最後にOSをリブートして完了です。ESXiよりはずいぶん簡単ですね。</p>\n<p>個別のファームウェアを適用したい場合は、mlxupのダウンロードページにUser Manualのリンクがありますので参照してください。</p>\n<h2 id=\"PCIe-x4スロット\"><a href=\"#PCIe-x4スロット\" class=\"headerlink\" title=\"PCIe x4スロット\"></a>PCIe x4スロット</h2><p>さて、エイプリールフールも近いのでネタを1つご紹介します。<br>今回紹介したMellanox Connect X-4の必要レーン数は、PCIe x8です。グラフィックカードをPCIe x16に挿していらっしゃる方は残りのPCIe x4のスロットしか使えず、最初からPCIe x8のネットワークカードは候補に上がらないと思います。</p>\n<p>私のもう1台のPC（Ryzen5 5600G）のPCIe x4のスロットです（PCIe3 x4で動作）。物理的なスロットは長いですが、接続端子がx4の部分までしかありません（画像をクリックして拡大できます）。</p>\n<img src=\"/new-technology/2023/03/25/Mellanox-ConnectXandWindows11/pci1.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p>Connect X-4を挿すところです。どう見てもレーン数が不足しています。</p>\n<img src=\"/new-technology/2023/03/25/Mellanox-ConnectXandWindows11/pci2.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p>とりあえずはスロットにConnect X-4を差し込み、Windows11を起動すると無事にカードは認識されています。<strong>SFP28モジュール</strong>とOM3ケーブルとを使ってスイッチに繋いでみます。</p>\n<img src=\"/new-technology/2023/03/25/Mellanox-ConnectXandWindows11/unifi1.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p>（UbiquitiのSwitch Pro Aggregationスイッチは4つのSFP28ポートを持っています。見た目はSFP+と区別がつきませんが、右側の4PortがSFP28です）</p>\n<p>iperf3のテストです。Windows11同士、それぞれがConnectx-4で片方がPCIe x4です。多重度は2です。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">iperf3 PCIe x4 Ryzen5(SFP28) &lt;- Ryzen7(SFP28)</span><br><span class=\"line\"></span><br><span class=\"line\">C:\\Users\\yoshi&gt;iperf3 -c 192.168.x.165 -R -P2</span><br><span class=\"line\">Connecting to host 192.168.x.165, port 5201</span><br><span class=\"line\">Reverse mode, remote host 192.168.x.165 is sending</span><br><span class=\"line\">[  5] <span class=\"built_in\">local</span> 192.168.x.112 port 49813 connected to 192.168.x.165 port 5201</span><br><span class=\"line\">[  7] <span class=\"built_in\">local</span> 192.168.x.112 port 49814 connected to 192.168.x.165 port 5201</span><br><span class=\"line\">[ ID] Interval           Transfer     Bitrate</span><br><span class=\"line\">[  5]   0.00-1.00   sec  1.37 GBytes  11.8 Gbits/sec</span><br><span class=\"line\">[  7]   0.00-1.00   sec  1.35 GBytes  11.6 Gbits/sec</span><br><span class=\"line\">[SUM]   0.00-1.00   sec  2.72 GBytes  23.3 Gbits/sec</span><br><span class=\"line\">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class=\"line\">[  5]   1.00-2.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class=\"line\">[  7]   1.00-2.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class=\"line\">[SUM]   1.00-2.00   sec  2.76 GBytes  23.7 Gbits/sec</span><br><span class=\"line\">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class=\"line\">[  5]   2.00-3.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class=\"line\">[  7]   2.00-3.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class=\"line\">[SUM]   2.00-3.00   sec  2.76 GBytes  23.7 Gbits/sec</span><br><span class=\"line\">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class=\"line\">[  5]   3.00-4.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class=\"line\">[  7]   3.00-4.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class=\"line\">[SUM]   3.00-4.00   sec  2.76 GBytes  23.7 Gbits/sec</span><br><span class=\"line\">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class=\"line\">[  5]   4.00-5.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class=\"line\">[  7]   4.00-5.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class=\"line\">[SUM]   4.00-5.00   sec  2.76 GBytes  23.7 Gbits/sec</span><br><span class=\"line\">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class=\"line\">[  5]   5.00-6.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class=\"line\">[  7]   5.00-6.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class=\"line\">[SUM]   5.00-6.00   sec  2.76 GBytes  23.7 Gbits/sec</span><br><span class=\"line\">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class=\"line\">[  5]   6.00-7.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class=\"line\">[  7]   6.00-7.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class=\"line\">[SUM]   6.00-7.00   sec  2.76 GBytes  23.7 Gbits/sec</span><br><span class=\"line\">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class=\"line\">[  5]   7.00-8.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class=\"line\">[  7]   7.00-8.00   sec  1.38 GBytes  11.9 Gbits/sec</span><br><span class=\"line\">[SUM]   7.00-8.00   sec  2.76 GBytes  23.7 Gbits/sec</span><br><span class=\"line\">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class=\"line\">[  5]   8.00-9.00   sec  1.35 GBytes  11.6 Gbits/sec</span><br><span class=\"line\">[  7]   8.00-9.00   sec  1.39 GBytes  11.9 Gbits/sec</span><br><span class=\"line\">[SUM]   8.00-9.00   sec  2.74 GBytes  23.5 Gbits/sec</span><br><span class=\"line\">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class=\"line\">[  5]   9.00-10.00  sec  1.39 GBytes  11.9 Gbits/sec</span><br><span class=\"line\">[  7]   9.00-10.00  sec  1.35 GBytes  11.6 Gbits/sec</span><br><span class=\"line\">[SUM]   9.00-10.00  sec  2.73 GBytes  23.5 Gbits/sec</span><br><span class=\"line\">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class=\"line\">[ ID] Interval           Transfer     Bitrate</span><br><span class=\"line\">[  5]   0.00-10.00  sec  13.8 GBytes  11.8 Gbits/sec                  sender</span><br><span class=\"line\">[  5]   0.00-10.00  sec  13.8 GBytes  11.8 Gbits/sec                  receiver</span><br><span class=\"line\">[  7]   0.00-10.00  sec  13.8 GBytes  11.8 Gbits/sec                  sender</span><br><span class=\"line\">[  7]   0.00-10.00  sec  13.8 GBytes  11.8 Gbits/sec                  receiver</span><br><span class=\"line\">[SUM]   0.00-10.00  sec  27.5 GBytes  23.6 Gbits/sec                  sender</span><br><span class=\"line\">[SUM]   0.00-10.00  sec  27.5 GBytes  23.6 Gbits/sec                  receiver</span><br><span class=\"line\"></span><br><span class=\"line\">iperf Done.</span><br></pre></td></tr></table></figure>\n\n<p>中途半端な繋ぎ方ですが、25GbEワイヤレートの速度がしっかり出ています。25GbEの全二重通信の検証まではやっていませんが、そもそもPCIe x8で25GbEが2Portならば、PCIe x4で25GbEの1Portはいけるでしょうし、10GbEなら2Portともに大丈夫でしょう。</p>\n<p>まるでギャンブルですが、エイプリールフールでした、、、ということではありません。Mellanox Connect X-4はこういった接続方法に対応しています。</p>\n<img src=\"/new-technology/2023/03/25/Mellanox-ConnectXandWindows11/mellanox.png\" class=\"\" width=\"480\" title=\"alt\">\n\n<p>冒頭で紹介した製品スペックのPDFでは、赤枠で囲ったところに、オートネゴシエートとあります。理論上、PCIe3 x4では帯域が32Gbpsですから25Gbpsの通信は可能ということになります。</p>\n<p>どうしても先入観があって、x4のスロットにx8のカードを挿そうと思いませんよね。</p>\n<p>PCIeのレーン数はご利用のマザーボードによって様々な仕様がありますので事前のご確認をお勧めします。</p>\n","categories":["Network","Hardware"],"tags":["SFP+","10GbE"]},{"title":"XG Firewallの通知設定を行う","url":"/new-technology/2020/04/03/Notifications/","content":"<p class=\"onepoint\">この記事で実現すること</p>\nXG Firewallで重要なエラーが発生した場合、VPNの接続通知、バージョンアップの通知をメールで受けとれます。\n\n<span id=\"more\"></span>\n<h2 id=\"Gmailからメールを通知する設定\"><a href=\"#Gmailからメールを通知する設定\" class=\"headerlink\" title=\"Gmailからメールを通知する設定\"></a>Gmailからメールを通知する設定</h2><p>XG Firewallのセットアップ時に通知用のメールアドレスを設定しても、メール通知がされません。プロバイダをはじめどこのサービスでも、SPAM対策がなされており、簡単にメールを送信する事は出来なくなっています。これは、<mark class=\"label primary\">Outbound Port 25 Blocking</mark>と呼ばれています。この回避策として、Googleアカウントを使う事で、メール通知が可能となります。</p>\n<ol>\n<li><p>Googleアカウントをお持ちでない方はアカウントを作成し、あらかじめ2段階認証の設定を行ってください。次に<strong>Googleアカウント</strong>のページに行き、左ペインの<mark class=\"label primary\">セキュリティ</mark>をクリックしてください。</p>\n<blockquote>\n<p>Googleアカウントのページ<br> <a href=\"https://myaccount.google.com/?tab=kk\">https://myaccount.google.com/?tab=kk</a></p>\n</blockquote>\n</li>\n<li><p>アプリパスワードをクリックします。</p>\n</li>\n</ol>\n<img src=\"/new-technology/2020/04/03/Notifications/googleacount.png\" class=\"\" title=\"alt\">\n\n<ol start=\"3\">\n<li>Googleアカウントのパスワードで認証します</li>\n<li><mark class=\"label primary\">アプリ パスワードを生成するアプリとデバイスを選択してください。</mark>という説明があるので、そこでXG用のパスワードと分かるように以下を入力してください</li>\n<li>アプリを選択　→　メールを選択します</li>\n<li>デバイスを選択　→　その他（名前を選択）を選択します</li>\n</ol>\n<img src=\"/new-technology/2020/04/03/Notifications/googleacount1.png\" class=\"\" title=\"alt\">\n\n<ol start=\"7\">\n<li>名前をXG Firewallのものと分かるように入力します</li>\n<li>生成ボタンをクリックします</li>\n<li>生成されたアプリパスワードが表示されます</li>\n<li>パスワードを控えておきます</li>\n<li>完了ボタンをクリックし、Googleでの設定を終了します</li>\n</ol>\n<img src=\"/new-technology/2020/04/03/Notifications/googleacount2.png\" class=\"\" title=\"alt\">\n\n<p>続いて、XG側の設定となります。左ペインの<mark class=\"label primary\">管理</mark>から、<mark class=\"label primary\">通知の設定</mark>をクリックします。以下の通り、<mark class=\"label primary\">外部メールサーバー</mark>を選択し、先ほどのGmailアカウントに関する情報を入力していきます。</p>\n<img src=\"/new-technology/2020/04/03/Notifications/googleacount3.png\" class=\"\" title=\"alt\">\n\n<table>\n<thead>\n<tr>\n<th>説明</th>\n<th>内容</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>メールサーバーアドレス</td>\n<td><code>smtp.gmail.com</code></td>\n</tr>\n<tr>\n<td>ポート</td>\n<td>587</td>\n</tr>\n<tr>\n<td>ユーザ名</td>\n<td><code>your_account@gmail.com</code></td>\n</tr>\n<tr>\n<td>パスワード</td>\n<td>Googleで取得した16桁のアプリパスワード</td>\n</tr>\n<tr>\n<td>接続のセキュリティ</td>\n<td>STARTTLS</td>\n</tr>\n<tr>\n<td>送信元メールアドレス</td>\n<td><code>your_account@gmail.com</code></td>\n</tr>\n<tr>\n<td>メールアドレスに通知を送信</td>\n<td>通知を受け取りたいメールアドレス</td>\n</tr>\n<tr>\n<td>管理インターフェースのIPアドレス</td>\n<td>WANのIPアドレスを選択</td>\n</tr>\n</tbody></table>\n<p>最後に適用をクリックします。その後通知ボタンをクリックしテスト通知で正しく受信できる事を確認してください。それなりに重要度が高いものを対象とし、スマホで通知を受けると良いでしょう。</p>\n<h3 id=\"v18-MR4での追加事項\"><a href=\"#v18-MR4での追加事項\" class=\"headerlink\" title=\"v18-MR4での追加事項\"></a>v18-MR4での追加事項</h3><p>（2021-1-2追記）v18 MR4にアップデートしてから通知が来ていない事に気がつきました。MR4では、上記の画面に「証明書」という項目が追加されており、プルダウンから証明書を選択するようになっています。今回のように外部メールを利用するケースでは、”Application Certificate”を選択してください。</p>\n<h2 id=\"メール通知するイベントを選択\"><a href=\"#メール通知するイベントを選択\" class=\"headerlink\" title=\"メール通知するイベントを選択\"></a>メール通知するイベントを選択</h2><p>XGの左ペインから<mark class=\"label primary\">システムサービス</mark>→<mark class=\"label primary\">通知リスト</mark>と進みます。以下の通り、イベント毎に通知が設定可能となっているので、<mark class=\"label primary\">メール通知</mark>のトグルスイッチをオンにして、好みの通知について選択してください。</p>\n<img src=\"/new-technology/2020/04/03/Notifications/notify.png\" class=\"\" title=\"alt\">\n\n<p>リスク観点で考えると、以下の内容をオンにしておくのがお勧めです。</p>\n<ul>\n<li>ユーザーのサインイン失敗</li>\n<li>新しいファームウェアの通知</li>\n<li>システム関連（起動、CPU高、シグネチャ更新失敗）</li>\n<li>VPNの接続</li>\n<li>IPSの攻撃検知（サーバー公開している場合）</li>\n</ul>\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"10GbEスイッチ QSW-M408-4C","url":"/new-technology/2021/10/31/QSW-M408-4C/","content":"<img src=\"/new-technology/2021/10/31/QSW-M408-4C/QSW-M408-4C.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<h2 id=\"QNAPの10GbE-x2F-SFP-x2F-RJ45スイッチ\"><a href=\"#QNAPの10GbE-x2F-SFP-x2F-RJ45スイッチ\" class=\"headerlink\" title=\"QNAPの10GbE&#x2F;SFP+&#x2F;RJ45スイッチ\"></a>QNAPの10GbE&#x2F;SFP+&#x2F;RJ45スイッチ</h2><p>1年ほど前にQNAPのQSW-M408-4Cというスイッチを購入しました。10GbpsのLAN（RJ45モジュラージャック）がNASや無線LANと増えてきたのもあり、家庭向けのデザインで小型化され、実売価格5万円程度でマネージドというのが珍しいなと思い購入に至りました。発売当初は管理画面が未熟で、アクセスコントロールなどが殆ど設定できませんでしたが、2回ほどファームウェアアップデートを経て1年越しで使える状態（お勧めできるレベルの製品）になってきました。</p>\n<p>個人向けとして関係しそうな内容に絞って記載します。</p>\n<blockquote>\n<p>QNAP QSW-M408-4C<br> <a href=\"https://www.qnap.com/ja-jp/product/qsw-m408-4c/specs/hardware\">https://www.qnap.com/ja-jp/product/qsw-m408-4c/specs/hardware</a></p>\n</blockquote>\n<span id=\"more\"></span>\n\n<h3 id=\"ハードウェアの特徴\"><a href=\"#ハードウェアの特徴\" class=\"headerlink\" title=\"ハードウェアの特徴\"></a>ハードウェアの特徴</h3><ol>\n<li>10GbE SFP+&#x2F;RJ45コンボポート  4つ</li>\n<li>1GbE (RJ45)  8つ　※NBASE-T（100M、1G、2.5G、5G、および10Gps）に対応</li>\n<li>寸法高さ：42.5mm　幅：290mm　奥行：127mm</li>\n<li>最大消費電力31.46W</li>\n<li>ジャンボフレーム9K</li>\n<li>スイッチングファブリック96Gbps</li>\n</ol>\n<p>ファンは1つありますが、自宅用として殆ど気になる音量ではありません。枕元に置くのでなければファンの音が気になる事は無いでしょう。<br>この製品のベンチマークとなるのがNETGEARの<strong>XS708T</strong>でしょうか。ただ、XS708Tはホームユーザー向けという感じではなく、サイズも大きく消費電力も49.5Wという事でもう少し小さいサイズのものが無いかと思っていたところでした。そういう意味ではサイズがコンパクトになったためリビングでも目立たず取り扱いやすいデザインでもあります。<br>筐体は下面が金属ですが、その他はプラスチックとなっています。下面部分はそれなりに熱を持ちます。</p>\n<blockquote>\n<p>NETGEAR XS708T<br> <a href=\"https://store.netgear.jp/products/detail/130\">https://store.netgear.jp/products/detail/130</a></p>\n</blockquote>\n<h3 id=\"ソフトウェアの特徴\"><a href=\"#ソフトウェアの特徴\" class=\"headerlink\" title=\"ソフトウェアの特徴\"></a>ソフトウェアの特徴</h3><ol>\n<li>QoS</li>\n<li>VLAN</li>\n<li>Portトランキング</li>\n<li>アクセスコントロール（ACL）IPアドレス、MACアドレス</li>\n<li>Portマネジメント</li>\n</ol>\n<p>まず、ホームユーザーでネットワークに拘る方向けには簡易的なQoSやACLがある事、そしてモニタリングできる事が求められます。VLANなども最低限度の機能は持っています。この製品はL3スイッチではありませんので、VLANのセグメント間をルーティングする機能は持っていません。恐らくパワーユーザーの方がLinuxベースのルーターやFirewallから複数の足を出してVLANのセグメントの接続するなどがよくある構成でしょうか。セキュリティ観点では無線ルーターがゲスト用のAPを持て、ネットワーク分離が簡単にでき、昔ほどVLANの必要性も少なくなっているように感じます。</p>\n<p>MACアドレスのACLもなりすましが可能という事で抑止力が極めて強い機能ではありませんが、内部ネットワークの悪意のあるソフトウェアやウィルスに感染したIoTから、重要な情報資産へのアクセスを防ぎます。</p>\n<h2 id=\"Web管理画面\"><a href=\"#Web管理画面\" class=\"headerlink\" title=\"Web管理画面\"></a>Web管理画面</h2><p>スイッチはDHCPからIPアドレスが割り振られます。管理画面はブラウザから<code>https://ipアドレス</code>で接続します。</p>\n<img src=\"/new-technology/2021/10/31/QSW-M408-4C/login.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p>ユーザーは今のところadmin固定のようです。</p>\n<h3 id=\"概要\"><a href=\"#概要\" class=\"headerlink\" title=\"概要\"></a>概要</h3><p>サブメニューの <mark class=\"label primary\">概要</mark>では各Portのモニタリングができます。</p>\n<img src=\"/new-technology/2021/10/31/QSW-M408-4C/main.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p>Portにマウスカーソルを合わせる事でPortの状況（接続スピード）が表示されます。但し、リアルタイムの状況がわかるだけで過去24時間の統計などは把握できません。上記画面下の<strong>ポートのトラフィック</strong>、<strong>10GbEポートのトラフィック</strong>は便利で、バックアップを取ったり何か作業をしている中、端末同士の実際のトラフィックがどれだけ流れているのか確認できます。</p>\n<h3 id=\"Port管理\"><a href=\"#Port管理\" class=\"headerlink\" title=\"Port管理\"></a>Port管理</h3><p>サブメニューの <mark class=\"label primary\">Port管理</mark>では各Portの詳細モニタリングができます。</p>\n<img src=\"/new-technology/2021/10/31/QSW-M408-4C/port.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<p>過去3分間の履歴と記載があります。なぜ3分固定なんでしょうか<span class=\"github-emoji\" alias=\"unamused\" style=\"\" fallback-src=\"https://github.githubassets.com/images/icons/emoji/unicode/1f612.png?v8\">&#x1f612;</span>。また、この画面を開いてからの履歴が画面上で記録されていくだけであり、スイッチ本体に記録されているものではなさそうです。元々スイッチ製品では長期的にデータを保存しておく機能は持っていないのが普通なのであまり多くは望めないと思います。</p>\n<h3 id=\"VLAN\"><a href=\"#VLAN\" class=\"headerlink\" title=\"VLAN\"></a>VLAN</h3><p>サブメニューの <mark class=\"label primary\">VLAN</mark>ではVLANの管理ができます。</p>\n<p>個人向け環境でVLANを設定する方は、ネットワークの仕事に従事されている方が過半数だとは思います。Ciscoで慣れている方が多いと思われますが、個人向けのスイッチのVLANは各社ごとに機能の名称が異なり、かえって理解するのが難しいです。以下は私がVLANを切ってみた構成のキャプチャです。このスイッチは私のリビングにあり、Port12から光回線のそばに設置してあるコアスイッチに繋がっています。</p>\n<img src=\"/new-technology/2021/10/31/QSW-M408-4C/vlan.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<p>Ciscoで慣れている方のための補足説明です。</p>\n<ul>\n<li>QSW-M408-4CでのネイティブVLANは1固定となっており変更できません。</li>\n<li>QSW-M408-4Cではアクセスポートとトランクポートの設定項目がありません。</li>\n<li>デフォルトでは1のネイティブVLANで全てのPortがタグ無しとなっています。私はここでVLAN100を加えています。</li>\n</ul>\n<p>VLAN100の説明</p>\n<ol>\n<li>Port3-6までVLAN100を<strong>タグ無し</strong>として登録しています。これはCiscoのアクセスポートと同義です。</li>\n</ol>\n<ul>\n<li>アクセスポートに設定することで設定されたVLANのタグは外され、端末側ではVLAN100に属しながらタグ無しのパケットを受信できます。</li>\n<li>アクセスポートには一つのVLANしか属する事はできません。</li>\n</ul>\n<ol start=\"2\">\n<li>Port12は上位のスイッチに接続されていますが、VLAN1を<strong>タグ無し</strong>、VLAN100は<strong>タグあり</strong>と設定しています。これはCiscoのトランクポートと同義です。</li>\n</ol>\n<ul>\n<li>上位のスイッチもVLAN1がネイティブVLANとなっておりタグ無しです。</li>\n<li>上位のスイッチとQSW-M408-4Cとの間はVLAN1はタグ無し、VLAN100は100のタグが付きやりとりされます。</li>\n</ul>\n<p>このような仕組みでQSW-M408-4CはVLANに対応し、異なるメーカーのスイッチともVLANで接続できます。もし、PC側のNICでVLANID100を受けられるように設定するのであればスイッチ側で敢えてタグを付けるように設定します（この設定を敢えてやる事に意味はありませんが）。</p>\n<p>もし、ESXiをこのハブに繋ぎ、vSwitchの複数のネットワークポートでVLANを切っていらっしゃるのであれば、タグ無しではなく、トランクポートの設定で ESXiのvSwitchに繋ぎ、タグ有りでESXiのvSwitchに流れるようにします。</p>\n<h3 id=\"IGMP\"><a href=\"#IGMP\" class=\"headerlink\" title=\"IGMP\"></a>IGMP</h3><p>サブメニューの <mark class=\"label primary\">IGMP</mark>ではマルチキャストパケットを効率化する管理ができます。</p>\n\n\n<p>PanasonicのプライベートVIERAなどマルチキャストを使う機器やアプリケーションがある場合、ネットワーク全体に負荷がかかるため、このIGMPスヌーピングを設定しておくと要求していないPortにはマルチキャストパケットを流しません<sup><strong><a href=\"#note1\">[1]</a></strong></sup>。マルチキャスト通信が無駄に多くの端末に流れないようにする事もネットワークの品質向上に役立つと考えています。</p>\n<blockquote>\n<p>Panasonic プライベートVIERA<br> <a href=\"https://panasonic.jp/privateviera/\">https://panasonic.jp/privateviera/</a></p>\n</blockquote>\n<h3 id=\"QoS\"><a href=\"#QoS\" class=\"headerlink\" title=\"QoS\"></a>QoS</h3><p>サブメニューの <mark class=\"label primary\">QoS</mark>ではPort毎のトラフィックの優先度設定が可能です。</p>\n<img src=\"/new-technology/2021/10/31/QSW-M408-4C/qos.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p>リアルタイムでやりとりを行うアプリケーション、前述したプライベートVIERAやTV会議などのPortを優先し、裏で流れる大量・高速のバックアップなどから影響を受けないようにします。NASで10Gbpsを束ねるようなパワーユーザーであれば必要になってくる機能です。</p>\n<h3 id=\"ACL\"><a href=\"#ACL\" class=\"headerlink\" title=\"ACL\"></a>ACL</h3><p>サブメニューの <mark class=\"label primary\">ACL</mark>ではIPv4によるアクセス制御、およびMACアドレスによるアクセス制御が可能です。</p>\n<img src=\"/new-technology/2021/10/31/QSW-M408-4C/acl.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<p>このスイッチのIPアドレスによるACLはIPv4のみ対応しています。ここでは、Port9にアクセス制限するサーバー（例えばNAS）が接続されており、接続を許可しているクライアントをMACアドレスベースのACLで制御する例です。ここでの設定のポイントは、以下の通りです。</p>\n<ol>\n<li>Port9を通過するMACアドレスを全て列挙しています。</li>\n<li>サーバーからインターネットへのアクセスを許可する場合は、インターネットに接続するルーターのLAN側MACアドレスも登録します。</li>\n<li>最後の行で該当しないMACアドレスからの送信は拒否しています。</li>\n</ol>\n<p>この設定によって、TCPは元よりUDPやICMPも不許可のクライアントからはサーバーに送信できません。また、サーバーから不許可のクライアントに対するTCP接続も返りのパケットが受け取れないため、3Wayハンドシェークが失敗して接続できないようになります。</p>\n<p>中継機をお使いの方への注意事項としては、アクセスする際は送信元のMACアドレスは端末のものではなく、中継機のMACアドレスになることが殆どです。ここは運用上少し工夫が必要です。これが面倒な場合はIPアドレスによるACLを利用される事をお勧めします。中継機にもいくつか方式があり、端末のMACアドレスでDHCPのIP割り当てをするものや、そもそも中継機のMACアドレスを元にDHCPのIP割り当てを要求するものもあるようです。</p>\n<p>私が使っているNECのAtermの<strong>W1200EX</strong>という中継機は、DHCPでMACアドレスによる固定割り当てした端末について本来のIPアドレスが割り当てられますが、実際にアクセスする時はW1200EXのMACアドレスが送信元MACアドレスとなります。他社製でも、その方式はまちまちであるようです。PCなどでIPアドレスとMACアドレスとの関係を確認するには、<code>arp -a</code>で確認できます。</p>\n<blockquote>\n<p>NEC Aterm W1200EX<br> <a href=\"https://www.aterm.jp/product/atermstation/product/warpstar/w1200ex/\">https://www.aterm.jp/product/atermstation/product/warpstar/w1200ex/</a></p>\n</blockquote>\n<blockquote>\n<p>バッファロー：中継機能を利用したときのMACアドレス制限の設定方法について<br> <a href=\"https://www.buffalo.jp/support/faq/detail/15113.html\">https://www.buffalo.jp/support/faq/detail/15113.html</a><br>NETGEAR:How to setup devices on EX7000 when MAC address filter is enabled on the router<br> <a href=\"https://kb.netgear.com/26262/How-to-setup-devices-on-EX7000-when-MAC-address-filter-is-enabled-on-the-router\">https://kb.netgear.com/26262/How-to-setup-devices-on-EX7000-when-MAC-address-filter-is-enabled-on-the-router</a></p>\n</blockquote>\n<h2 id=\"ファームウェア更新\"><a href=\"#ファームウェア更新\" class=\"headerlink\" title=\"ファームウェア更新\"></a>ファームウェア更新</h2><p>このスイッチのファームウェア更新は手動で更新有無をチェックする必要があります。今年の5月にファームをあげてから全く障害もなく100日以上正常稼働を続けておりホームユーザー向けのスイッチの安定度としては今のところ十分ではないかと思われます。</p>\n<img src=\"/new-technology/2021/10/31/QSW-M408-4C/firmware.png\" class=\"\" width=\"320\" title=\"alt\">\n\n<h2 id=\"iperf3のテスト\"><a href=\"#iperf3のテスト\" class=\"headerlink\" title=\"iperf3のテスト\"></a>iperf3のテスト</h2><p>ESXiの仮想マシンであるubuntu20.04(10GbE)からQNAPのNAS(10GbE)へiperf3コマンドを実施したところ以下の結果でした。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ iperf3 -c 192.168.x.x</span><br><span class=\"line\">Connecting to host 192.168.x.x, port 5201</span><br><span class=\"line\">[  5] <span class=\"built_in\">local</span> 192.168.x.x port 56490 connected to 192.168.x.x port 5201</span><br><span class=\"line\">[ ID] Interval           Transfer     Bitrate         Retr  Cwnd</span><br><span class=\"line\">[  5]   0.00-1.00   sec  1.09 GBytes  9.35 Gbits/sec    0   1.87 MBytes</span><br><span class=\"line\">[  5]   1.00-2.00   sec  1.09 GBytes  9.37 Gbits/sec    0   1.87 MBytes</span><br><span class=\"line\">[  5]   2.00-3.00   sec  1.07 GBytes  9.19 Gbits/sec    0   1.87 MBytes</span><br><span class=\"line\">[  5]   3.00-4.00   sec  1.08 GBytes  9.29 Gbits/sec    0   1.87 MBytes</span><br><span class=\"line\">[  5]   4.00-5.00   sec  1.10 GBytes  9.42 Gbits/sec    0   2.06 MBytes</span><br><span class=\"line\">[  5]   5.00-6.00   sec  1.09 GBytes  9.41 Gbits/sec    0   2.06 MBytes</span><br><span class=\"line\">[  5]   6.00-7.00   sec  1.10 GBytes  9.42 Gbits/sec    0   2.21 MBytes</span><br><span class=\"line\">[  5]   7.00-8.00   sec  1.10 GBytes  9.42 Gbits/sec    0   2.21 MBytes</span><br><span class=\"line\">[  5]   8.00-9.00   sec  1.09 GBytes  9.37 Gbits/sec    0   2.32 MBytes</span><br><span class=\"line\">[  5]   9.00-10.00  sec  1.09 GBytes  9.41 Gbits/sec    0   2.32 MBytes</span><br><span class=\"line\">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class=\"line\">[ ID] Interval           Transfer     Bitrate         Retr</span><br><span class=\"line\">[  5]   0.00-10.00  sec  10.9 GBytes  9.36 Gbits/sec    0             sender</span><br><span class=\"line\">[  5]   0.00-10.00  sec  10.9 GBytes  9.35 Gbits/sec                  receiver</span><br><span class=\"line\"></span><br><span class=\"line\">iperf Done.</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>仮想マシンを使った測定ではオーバーヘッドがあるので参考程度にはなりますが、十分なパフォーマンスが出ています。</p>\n<h2 id=\"できるだけ有線LANの敷設を\"><a href=\"#できるだけ有線LANの敷設を\" class=\"headerlink\" title=\"できるだけ有線LANの敷設を\"></a>できるだけ有線LANの敷設を</h2><p>LANの口がある機器は可能な限り有線接続することがベストです。ついつい手軽さから無線LANの接続を選びがちですが、特にリアルタイムのアプリケーションは転送量の問題でなくレイテンシ（遅延）に品質が左右されます。前出のプライベートVIERAは2秒程度、TV会議や動画チャットも0.5秒〜1秒程度の遅延が入り、その遅延の間にデータをバッファリングし安定的に動画と音声を届けるような仕組みです。</p>\n<p>映画や音楽などのストリーミングはデータが固定ですから事前にかなりのデータを読み込んでおけますのでさほどシビアにはなりません。家電のネットワークPortは100Mbpsなどのものも多いですが、今の時代の無線が数100Mbpsではるかに早いという事にはならず、安定性のために有線LANをお勧めします。</p>\n<p>家庭に10GbpsのLANが必須だとは思いませんが、最近のデバイスを快適に利用するためには10Gbpsでなくとも基幹LANが大切になります。無線（802.11）は半2重、有線は全2重の通信ですから、レイテンシという意味では有線の安定度が絶対的に勝ります。また、安定運用にはスペック上の余裕を持たせる事が大事と考えています。このスイッチに限らず、2.5Gbpsの製品はいくつか発売されています。クライアント側の2.5GbE対応については「<a href=\"/new-technology/2021/10/03/2500MbE/\" title=\"Plugable 2.5GbE USB アダプター\">Plugable 2.5GbE USB アダプター</a>」を参考にしてください。</p>\n<p>無線ルーターには数PortのLANの口も備えていますが、無線ルーターは何かと保守が必要であり、メンテナンスの都度ネットワークが切断されてしまいます。安定した基幹のスイッチを導入することをお勧めします。</p>\n<p>スイッチであっても10Gbpsのチップはまだ発熱量が大きいのが現状です。もし、このスイッチをお使いになる場合は、筐体下面についている短いゴム足をもう少し長いものに変えたり、縦置きにするなど少し工夫が必要と思います。それでもこの製品はそれなりの小型化と静粛さと高速化を両立したバランスの良いスイッチであると思えます。</p>\n<p>もし、10GbE対応のNASやPCがこのスイッチの近くに設置してある、またはこれから10GbEのNICを購入されるのであれば、是非SFP+ポートの接続を検討してみてください。DAC（ダイレクトアタッチケーブル）での接続は低レイテンシで発熱量がとても少ないです。RJ45ポートも100Mbps、1Gbps、2.5Gbps、5Gbps、10Gbpsと様々な速度でも繋がり、難しい設定は不要なので多くの方にお勧めできるスイッチです。</p>\n<p>あとはネットワーク統計やエラーパケットなどを把握するための機能搭載を期待するところです。</p>\n<p><small id=\"note1\"><strong>[1]</strong><br>これはプライベートVIERAが大きな負荷を掛けるという話ではありません。接続の最初にはマルチキャストが使われますが通信が確立した後はユニキャスト中心ですので、トラフィック量としては殆ど気にする必要はありません。<br></small></p>\n","categories":["Network","Hardware"],"tags":["SFP+","10GbE","QNAP"]},{"title":"XG Firewall Sophos Communityについて","url":"/new-technology/2020/03/26/SophosCommunity/","content":"<h2 id=\"Sophos-Communityを活用する\"><a href=\"#Sophos-Communityを活用する\" class=\"headerlink\" title=\"Sophos Communityを活用する\"></a>Sophos Communityを活用する</h2><p>XG Firewall Home EditionはSophosによるサポートがなく、ユーザコミュニティの相互サポートによって成り立っています。サポートサイトは英語が中心ですが、セキュリティに関するビジネスをしている方も積極的に参加しています。</p>\n<span id=\"more\"></span>\n\n<blockquote>\n<p>Sophos community<br> <a href=\"https://community.sophos.com/xg-firewall\">https://community.sophos.com/xg-firewall</a></p>\n</blockquote>\n<p>さて、直接XGの話ではありませんが、ここ数日話題になっているドイツ製翻訳ソフトの<strong>DeepL</strong>が素晴らしいです。私はGoogle翻訳をずっと使っていましたが、こちらも使い勝手が良く便利です。<br>Windows、macOSのアプリケーションとしてインストールする事が出来ます。利用は無償（高機能な有償のpro版もあります）で、例えばブラウザで翻訳箇所を選択しCtrl+c(macはcommand+c)を2回押下するとDeepLが起動し、英訳と日本語が併記されます。</p>\n<blockquote>\n<p>DeepL翻訳<br> <a href=\"https://www.deepl.com/app\">https://www.deepl.com/app</a></p>\n</blockquote>\n<p>これまで私がブログで書いてきたv18のSSL&#x2F;TLSインスペクションですが、情報がたくさんあります。このブログで全てを説明するのは到底無理があります。Communityの素晴らしい知見を活用すべく、活用してみてください。</p>\n<blockquote>\n<p>Sophos XG Firewall v18: DPI エンジンのトラブルシューティング<br> <a href=\"https://community.sophos.com/products/xg-firewall/f/recommended-reads/118753/sophos-xg-firewall-v18-troubleshooting-problems-with-the-dpi-engine\">https://community.sophos.com/products/xg-firewall/f/recommended-reads/118753/sophos-xg-firewall-v18-troubleshooting-problems-with-the-dpi-engine</a></p>\n</blockquote>\n<p>アプリでCtrl+cを2回押下して先頭部分の抜粋を抜粋します。</p>\n<img src=\"/new-technology/2020/03/26/SophosCommunity/community.png\" class=\"\" title=\"alt\">\n\n<p>ぜひ、翻訳ソフトのDeepLを活用しながら、XGやSSLインスペクションの理解を深めてください。</p>\n","categories":["Security"],"tags":["XG Firewall","DeepL"]},{"title":"Sophos Firewallの導入","url":"/new-technology/2020/02/23/XG-Firewall/","content":"<img src=\"/new-technology/2020/02/23/XG-Firewall/xg.png\" class=\"\">\n\n<h2 id=\"導入の背景\"><a href=\"#導入の背景\" class=\"headerlink\" title=\"導入の背景\"></a>導入の背景</h2><p>元々、家庭用の無線ルータだけではセキュリティが不足していると考えていました。数年前よりランサムウェア等の脅威が出てきた事で、それなりの対策が必要と感じていました。街のWIFIからも自宅のリソースに安全に接続したり、家のサーバーを踏み台にしてネットに繋げたいというニーズもあり、VPNも必要でした。</p>\n<span id=\"more\"></span>\n<p>そもそも、iCloudかOneDriveあたりにファイルを置いておけばいいんですが、漏洩よりも万が一のロストが不安です。クラウドの特徴として、提供サービスと費用が一方的に変更されやすい傾向にあるようです。オンプレミスの場合は盗難や火事というリスクもあり、人によって優先するものは異なりますが、利便性と安全性のバランスを取る事を目指すのでしょうか。個人のセキュリティは、ビジネスにおけるリスクを極限まで抑制するという考えではなく、最低限必要な対策をもれなく行うものと考えています。特に最近進歩が著しいIoT機器は追加の防御策が必要です。Sophos社が提供する<strong>Sophos Firewall</strong>は、業務用ながらホームユーザーには無料という事もあって、最良のセキュリティ防御の手段と考えています。かれこれ1年半くらいでしょうか。ずっと使わせてもらってます。</p>\n<blockquote>\n<p>Sophos Firewall<br> <a href=\"https://www.sophos.com/ja-jp/products/next-gen-firewall.aspx\">https://www.sophos.com/ja-jp/products/next-gen-firewall.aspx</a></p>\n</blockquote>\n<h2 id=\"主な機能\"><a href=\"#主な機能\" class=\"headerlink\" title=\"主な機能\"></a>主な機能</h2><ul>\n<li>Firewall機能（IPフィルター、Portフィルター）</li>\n<li>IPS&#x2F;WAF</li>\n<li>コンテンツフィルター（Webフィルター、アプリケーションフィルター）</li>\n<li>DDoS対策機能</li>\n<li>国別フィルター（IPv4のみ）</li>\n<li>VPN（2要素認証対応）</li>\n<li>サーバ公開</li>\n<li>DNS&#x2F;DHCP(IPv4,IPv6)</li>\n</ul>\n<h2 id=\"Sophos-Firewall導入メリット\"><a href=\"#Sophos-Firewall導入メリット\" class=\"headerlink\" title=\"Sophos Firewall導入メリット\"></a>Sophos Firewall導入メリット</h2><ol>\n<li>レイヤ7Firewall（次世代Firewall）により、アプリケーション単位、ギャンブルやゲーム、アダルトなどのカテゴリで禁止ルールを設定可能</li>\n<li>接続したくない国に対してアクセス制限ができる。Webブラウジングはもちろん、自宅にサーバーを建てた場合の接続元を日本からのみに絞る事も可能（IPv4のみ）</li>\n<li>SSL&#x2F;TLSインスペクションによりSSL&#x2F;TLS通信の中身を検査し、さまざまな脅威からの保護</li>\n<li>ログ機能が充実している</li>\n<li>VPNが提供可能。ダイナミックDNSによる接続容易性に加え、ワンタイムパスワードによる2要素認証が可能（Windows、Mac、iOS、Android）</li>\n<li>エラーをフックし、メールでの通知が行える</li>\n</ol>\n<h2 id=\"Sophos-Firewall導入の留意点\"><a href=\"#Sophos-Firewall導入の留意点\" class=\"headerlink\" title=\"Sophos Firewall導入の留意点\"></a>Sophos Firewall導入の留意点</h2><ol>\n<li>新しいPCが必要（新品である必要はありません）。2枚のネットワークインタフェースが必要</li>\n<li>ネットのパフォーマンスが犠牲になる。回線帯域よりもレイテンシ（遅延）が大きくなる</li>\n<li>XG Firewallによる保護はエンドポイントの保護を完全に不要にするものではないため、従来通りウィルス対策ソフト（Windows Defenderを含む）は必要</li>\n</ol>\n<p>システム要件は以下の通りとなっています。</p>\n<blockquote>\n<p><a href=\"https://www.sophos.com/ja-jp/products/free-tools/sophos-xg-firewall-home-edition.aspx\">https://www.sophos.com/ja-jp/products/free-tools/sophos-xg-firewall-home-edition.aspx</a><br>2つのネットワークインターフェースのあるIntel互換コンピュータ。（XG Firewall Home Editionをインストールすると、コンピュータにある既存のOSやファイルは上書きされます）<br>Home Editionは、4コア、および6GBのRAMまでの環境に対応しています。この条件を超えるコンピュータも使用可能ですが、XG Firewall Home Editionは、上限を超える容量を活用できません。</p>\n</blockquote>\n<p>ホームユーザーには技術面でハードルは高いです。しかしながら業務用ファイアウォールが家庭で使えるというのは非常に魅力です。興味のある方はお付き合いください。</p>\n<h2 id=\"Sophos-Firewallの記事一覧\"><a href=\"#Sophos-Firewallの記事一覧\" class=\"headerlink\" title=\"Sophos Firewallの記事一覧\"></a>Sophos Firewallの記事一覧</h2><ul>\n<li><a href=\"/new-technology/2020/02/25/provision/\" title=\"PC（ハードウェア）の準備\">PC（ハードウェア）の準備</a></li>\n<li><a href=\"/new-technology/2020/02/29/esxi/\" title=\"VMware vSphere Hypervisor（ESXi）のインストール\">VMware vSphere Hypervisor（ESXi）のインストール</a></li>\n<li><a href=\"/new-technology/2020/03/01/esxi-conf/\" title=\"VMware vSphere Hypervisor（ESXi）の設定\">VMware vSphere Hypervisor（ESXi）の設定</a></li>\n<li><a href=\"/new-technology/2020/03/06/InstallXG/\" title=\"Sophos Firewall のインストール（事前準備）\">Sophos Firewall のインストール（事前準備）</a></li>\n<li><a href=\"/new-technology/2020/03/06/InstallXG2/\" title=\"Sophos FirewallをESXi仮想マシンにインストールする\">Sophos FirewallをESXi仮想マシンにインストールする</a></li>\n<li><a href=\"/new-technology/2020/03/08/XG-MainPage/\" title=\"Sophos Firewallのメイン画面と特徴について\">Sophos Firewallのメイン画面と特徴について</a></li>\n<li><a href=\"/new-technology/2020/03/14/rule-policy1/\" title=\"XG Firewall v18のルールとポリシーについて\">XG Firewall v18のルールとポリシーについて</a></li>\n<li><a href=\"/new-technology/2020/03/14/rule-policy2/\" title=\"XG Firewall v18のルールを作成する\">XG Firewall v18のルールを作成する</a></li>\n<li><a href=\"/new-technology/2020/03/14/customize-policy/\" title=\"XG Firewall v18のポリシーをカスタマイズする\">XG Firewall v18のポリシーをカスタマイズする</a></li>\n<li><a href=\"/new-technology/2020/03/20/ssl-inspection/\" title=\"SSLインスペクションについて\">SSLインスペクションについて</a></li>\n<li><a href=\"/new-technology/2020/03/20/ssl-inspection1/\" title=\"XG Firewall v18のSSL&#x2F;TLSインスペクションの設定\">XG Firewall v18のSSL&#x2F;TLSインスペクションの設定</a></li>\n<li><a href=\"/new-technology/2020/03/21/ssl-inspection2/\" title=\"XG Firewall v18のSSLインスペクションの動作確認と調整\">XG Firewall v18のSSLインスペクションの動作確認と調整</a></li>\n<li><a href=\"/new-technology/2020/03/26/SophosCommunity/\" title=\"XG Firewall Sophos Communityについて\">XG Firewall Sophos Communityについて</a></li>\n<li><a href=\"/new-technology/2020/03/28/vpn/\" title=\"XG Firewall VPNについて\">XG Firewall VPNについて</a></li>\n<li><a href=\"/new-technology/2020/03/28/vpnotp/\" title=\"XG Firewall VPNに2要素認証を設定する\">XG Firewall VPNに2要素認証を設定する</a></li>\n<li><a href=\"/new-technology/2021/05/30/ssl-vpn/\" title=\"XG Firewall SSL-VPN\">XG Firewall SSL-VPN</a></li>\n<li><a href=\"/new-technology/2020/03/31/vpn-iphone/\" title=\"XG Firewall VPNにスマホから接続する\">XG Firewall VPNにスマホから接続する</a></li>\n<li><a href=\"/new-technology/2020/04/03/Notifications/\" title=\"XG Firewallの通知設定を行う\">XG Firewallの通知設定を行う</a></li>\n<li><a href=\"/new-technology/2020/04/11/dnat/\" title=\"XG Firewall v18でLAN内のホストをインターネットに公開する\">XG Firewall v18でLAN内のホストをインターネットに公開する</a></li>\n<li><a href=\"/new-technology/2020/04/18/ipv6/\" title=\"IPv6のUnique Local Addressを生成する\">IPv6のUnique Local Addressを生成する</a></li>\n<li><a href=\"/new-technology/2020/04/25/xg-ipv6-1/\" title=\"XG FirewallでIPv6の設定を行う（前半）\">XG FirewallでIPv6の設定を行う（前半）</a></li>\n<li><a href=\"/new-technology/2020/04/29/xg-ipv6-2/\" title=\"Sophos FirewallでIPv6の設定を行う（後半）\">Sophos FirewallでIPv6の設定を行う（後半）</a></li>\n<li><a href=\"/new-technology/2020/05/04/ips-policy/\" title=\"XG FirewallでIPSのポリシーを確認する\">XG FirewallでIPSのポリシーを確認する</a></li>\n<li><a href=\"/new-technology/2020/05/06/web-application-filter/\" title=\"XG FirewallのWebとアプリケーションフィルタについて\">XG FirewallのWebとアプリケーションフィルタについて</a></li>\n<li><a href=\"/new-technology/2020/05/09/best-practice/\" title=\"XG Firewall v18の設定におけるベストプラクティス\">XG Firewall v18の設定におけるベストプラクティス</a></li>\n<li><a href=\"/new-technology/2020/05/16/Intercept-DNS/\" title=\"XG Firewall v18で正しいDNS利用を強制する\">XG Firewall v18で正しいDNS利用を強制する</a></li>\n<li><a href=\"/new-technology/2020/06/24/protect-xg/\" title=\"XG Firewall自身を防御する\">XG Firewall自身を防御する</a></li>\n<li><a href=\"/new-technology/2020/10/25/xg-v18-mr3/\" title=\"XG Firewall v18 MR3の更新\">XG Firewall v18 MR3の更新</a></li>\n<li><a href=\"/new-technology/2020/12/17/xg-v18-mr4/\" title=\"XG Firewall v18 MR4の更新\">XG Firewall v18 MR4の更新</a></li>\n<li><a href=\"/new-technology/2021/04/07/xg-v18-mr5/\" title=\"XG Firewall v18 MR5の更新\">XG Firewall v18 MR5の更新</a></li>\n<li><a href=\"/new-technology/2021/08/15/xg-v185-mr1/\" title=\"XG Firewall v18.5 MR1の更新\">XG Firewall v18.5 MR1の更新</a></li>\n<li><a href=\"/new-technology/2021/12/11/xg-v185-mr2/\" title=\"Sophos Firewall v18.5 MR-2\">Sophos Firewall v18.5 MR-2</a></li>\n<li><a href=\"/new-technology/2022/03/25/xg-v185-mr3/\" title=\"Sophos Firewall v18.5 MR-3\">Sophos Firewall v18.5 MR-3</a></li>\n<li><a href=\"/new-technology/2022/04/29/xg-v19/\" title=\"Sophos Firewall v19\">Sophos Firewall v19</a></li>\n<li><a href=\"/new-technology/2022/07/30/xg-v19-mr1/\" title=\"Sophos Firewall v19 MR-1\">Sophos Firewall v19 MR-1</a></li>\n<li><a href=\"/new-technology/2022/12/03/xg-v195/\" title=\"Sophos Firewall v19.5\">Sophos Firewall v19.5</a></li>\n<li><a href=\"/new-technology/2023/02/23/xg-v195mr1/\" title=\"Sophos Firewall v19.5 MR-1\">Sophos Firewall v19.5 MR-1</a></li>\n</ul>\n<p>このブログを書き始めた時はv18でしたが、2023年2月23日時点では、v19.5が最新バージョンとなっています。</p>\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"フィッシング対策ツールの実力","url":"/new-technology/2021/05/05/avoid-phishing/","content":"<img src=\"/new-technology/2021/05/05/avoid-phishing/phishing.png\" class=\"\" title=\"alt\">\n\n<p class=\"onepoint\">この記事で実現すること</p>\n\n<p>フィッシングサイトから身を守るためには、自身が騙されないために日頃から意識する事が最も重要ですが、フェールセーフで各種セキュリティサービスに助けられるケースもあるはずです。それぞれのサービスがどの程度の実力を持つのか検証してみます。</p>\n<span id=\"more\"></span>\n\n<h2 id=\"フィッシング対策について\"><a href=\"#フィッシング対策について\" class=\"headerlink\" title=\"フィッシング対策について\"></a>フィッシング対策について</h2><p>巷で記載されているフィッシング対策は、「本人が気を付ける」という観点で書かれている記事が大半です。ITに詳しくなくてもきちんとニュースやサイトの案内を理解され、慎重な方であれば滅多に引っかからないものですが、家族を含めて考えると無視できないテーマです。ウィルス対策ソフトなどはフィッシング対策も含めてアピールしている製品もありますが、実力はどの程度のものでしょうか。今回は、このサイトでお勧めしているXG Firewallを含め、代表的なウィルス対策ソフトの実力について調べてみました。</p>\n<h2 id=\"フィッシングサイトと、対象ソフトウェアについて\"><a href=\"#フィッシングサイトと、対象ソフトウェアについて\" class=\"headerlink\" title=\"フィッシングサイトと、対象ソフトウェアについて\"></a>フィッシングサイトと、対象ソフトウェアについて</h2><h3 id=\"フィッシングサイトの選定\"><a href=\"#フィッシングサイトの選定\" class=\"headerlink\" title=\"フィッシングサイトの選定\"></a>フィッシングサイトの選定</h3><p>フィッシングサイトは日本国内で有名になったものをTwitterなどからPickupしてみました。</p>\n<ul>\n<li>銀行・カード</li>\n<li>宅急便</li>\n<li>通販会社</li>\n<li>カード</li>\n<li>通販会社（別サイト）</li>\n</ul>\n<h3 id=\"対象ソフトウェア\"><a href=\"#対象ソフトウェア\" class=\"headerlink\" title=\"対象ソフトウェア\"></a>対象ソフトウェア</h3><p>Googleはセーフブラウジングという機能を持っています。ChromeやFireFoxではこの機能が採用されています。これと同じ仕組みでMicrosoftのEdgeは”Smart Screen”という機能が提供されています。双方ともブラウザ画面いっぱいに赤色で警告を表示しますのでかなり驚きます。いずれもユーザーが報告を行える仕組みをとっています。</p>\n<p>ウィルス対策ソフトは海外製品がどこまで日本の事情を理解できているかがポイントになるでしょうか。ある意味日本語という言葉の壁がフィッシングから身を守っていると言っても過言ではありません。従い、日本国内のサービスを対象とするフィッシング詐欺は日本の事に精通している必要があります。対策ソフトを作る側も同じ事が求められます。<br>ウィルス対策ソフトについては、Norton360、Bitdefender、トレンドマイクロ（ウィルスバスター）を選定してみました。XG Firewallについても検証対象に加えてみます。</p>\n<h3 id=\"検証方法\"><a href=\"#検証方法\" class=\"headerlink\" title=\"検証方法\"></a>検証方法</h3><p>PC、モバイルにおいて、セーフブラウジング、Smart Screenの実力を検証します。また、ウィルス対策ソフトを提供するベンダーは、簡易VPNとしてデバイス上で宛先（ドメインまたはURL）チェックを行う機能を持っていますので、これでフィッシングが認識できるか検証します。</p>\n<h2 id=\"検証結果\"><a href=\"#検証結果\" class=\"headerlink\" title=\"検証結果\"></a>検証結果</h2><p>まずは検証結果の一覧です。URLの一部は伏せてあります。</p>\n<table>\n<thead>\n<tr>\n<th></th>\n<th>銀行direct5-xxxx[.]xxx</th>\n<th>宅急便znwjwvfgna[.]xx[.]xx</th>\n<th>通販会社1 www[.]xxx-amazon[.]xxx&#x2F;[.]</th>\n<th>カードxxx[.]epos-card[.]xxx&#x2F;</th>\n<th>通販会社2 amazon[.]co[.]jp[.]xxx[.]xx</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>iPhone Safari</td>\n<td>○</td>\n<td>✖️</td>\n<td>○</td>\n<td>✖️</td>\n<td>✖️</td>\n</tr>\n<tr>\n<td>iPhone Chrome</td>\n<td>○</td>\n<td>✖️</td>\n<td>○</td>\n<td>✖️</td>\n<td>✖️</td>\n</tr>\n<tr>\n<td>iPhone Edge</td>\n<td>○</td>\n<td>✖️</td>\n<td>○</td>\n<td>✖️</td>\n<td>✖️</td>\n</tr>\n<tr>\n<td>iPhone Firefox</td>\n<td>○</td>\n<td>✖️</td>\n<td>○</td>\n<td>✖️</td>\n<td>✖️</td>\n</tr>\n<tr>\n<td>Android Chrome</td>\n<td>○</td>\n<td>✖️</td>\n<td>○</td>\n<td>○</td>\n<td>○</td>\n</tr>\n<tr>\n<td>Android Edge</td>\n<td>✖️</td>\n<td>✖️</td>\n<td>✖️</td>\n<td>✖️</td>\n<td>✖️</td>\n</tr>\n<tr>\n<td>Android Firefox</td>\n<td>○</td>\n<td>✖️</td>\n<td>○</td>\n<td>○</td>\n<td>○</td>\n</tr>\n<tr>\n<td>PC Edge</td>\n<td>○</td>\n<td>✖️</td>\n<td>○</td>\n<td>○</td>\n<td>○</td>\n</tr>\n<tr>\n<td>PC Firefox</td>\n<td>○</td>\n<td>✖️</td>\n<td>○</td>\n<td>○</td>\n<td>○</td>\n</tr>\n<tr>\n<td>Mac Safari</td>\n<td>○</td>\n<td>✖️</td>\n<td>○</td>\n<td>✖️</td>\n<td>✖️</td>\n</tr>\n<tr>\n<td>Mac Edge</td>\n<td>○</td>\n<td>✖️</td>\n<td>✖️</td>\n<td>✖️</td>\n<td>○</td>\n</tr>\n<tr>\n<td>Mac Firefox</td>\n<td>○</td>\n<td>✖️</td>\n<td>○</td>\n<td>○</td>\n<td>○</td>\n</tr>\n<tr>\n<td>Linux(ubuntu) Firefox</td>\n<td>○</td>\n<td>✖️</td>\n<td>○</td>\n<td>○</td>\n<td>○</td>\n</tr>\n<tr>\n<td>Bitdefender</td>\n<td>○</td>\n<td>✖️</td>\n<td>○</td>\n<td>○</td>\n<td>✖️</td>\n</tr>\n<tr>\n<td>XG Firewall</td>\n<td>○</td>\n<td>✖️</td>\n<td>○</td>\n<td>✖️</td>\n<td>✖️</td>\n</tr>\n<tr>\n<td>Norton360</td>\n<td>✖️</td>\n<td>✖️</td>\n<td>✖️</td>\n<td>✖️</td>\n<td>✖️</td>\n</tr>\n<tr>\n<td>ウィルスバスターモバイル</td>\n<td>○</td>\n<td>○</td>\n<td>○</td>\n<td>○</td>\n<td>○</td>\n</tr>\n</tbody></table>\n<p>（※上記の表は閲覧するデバイスによって見切れる場合がありますが、←→のスワイプで確認できます）</p>\n<h3 id=\"Windows、Linux\"><a href=\"#Windows、Linux\" class=\"headerlink\" title=\"Windows、Linux\"></a>Windows、Linux</h3><h4 id=\"Chrome、Firefox\"><a href=\"#Chrome、Firefox\" class=\"headerlink\" title=\"Chrome、Firefox\"></a>Chrome、Firefox</h4><p>これはGoogleセーフブラウジングを使う事になりますが、良い結果です。かなりの精度でフィッシングサイトを認識できています。✖️は1つですが、フィッシングサイトは次から次へと作られますからある意味いたちごっこではあります。ユーザーからの報告を受け、防御していくPDCAがうまく活用できているのでしょうね。</p>\n<h4 id=\"Edge（Windowsのみ）\"><a href=\"#Edge（Windowsのみ）\" class=\"headerlink\" title=\"Edge（Windowsのみ）\"></a>Edge（Windowsのみ）</h4><p>MicrosoftのSmart Screenも良い結果でした。✖️は1つです。</p>\n<h3 id=\"macOS\"><a href=\"#macOS\" class=\"headerlink\" title=\"macOS\"></a>macOS</h3><h4 id=\"Safari\"><a href=\"#Safari\" class=\"headerlink\" title=\"Safari\"></a>Safari</h4><p>SafariはGoogleセーフブラウジングの情報を活用しています。しかしWindowsとバージョンが異なるのか、不芳で✖️は3つです。</p>\n<h4 id=\"Chrome、Firefox-1\"><a href=\"#Chrome、Firefox-1\" class=\"headerlink\" title=\"Chrome、Firefox\"></a>Chrome、Firefox</h4><p>Windows版と同様で良い結果でした。✖️は1つです。</p>\n<h4 id=\"Edge\"><a href=\"#Edge\" class=\"headerlink\" title=\"Edge\"></a>Edge</h4><p>これも意外です。Windows版と結果が異なります。不芳で✖️は3つです。</p>\n<h3 id=\"PCにおけるフィッシングサイトの検出能力\"><a href=\"#PCにおけるフィッシングサイトの検出能力\" class=\"headerlink\" title=\"PCにおけるフィッシングサイトの検出能力\"></a>PCにおけるフィッシングサイトの検出能力</h3><p>Chrome、Firefoxを使う事で一定の防御が可能という事がわかりました。macOSでのみ、Edge、Safariの防御力が劣ります。</p>\n<h3 id=\"Android\"><a href=\"#Android\" class=\"headerlink\" title=\"Android\"></a>Android</h3><h4 id=\"Chrome、Firefox-2\"><a href=\"#Chrome、Firefox-2\" class=\"headerlink\" title=\"Chrome、Firefox\"></a>Chrome、Firefox</h4><p>PCと共通で良い結果でした。✖️は1つです。</p>\n<h4 id=\"Edge-1\"><a href=\"#Edge-1\" class=\"headerlink\" title=\"Edge\"></a>Edge</h4><p>意外です。Android版Edgeはフィッシングサイトを全く検知できていません。仕組みが異なるのでしょうか。まだ発展途中のプロダクトという事でしょうか。</p>\n<h4 id=\"Androidにおけるフィッシングサイトの検出能力\"><a href=\"#Androidにおけるフィッシングサイトの検出能力\" class=\"headerlink\" title=\"Androidにおけるフィッシングサイトの検出能力\"></a>Androidにおけるフィッシングサイトの検出能力</h4><p>デフォルトのChromeを使う事で一定の防御が可能です。しかし、Edgeはフィッシングという観点では現段階で支援してくれない事を留意して使用すべきでしょうか。今後のアップデートで強化されていくものと考えられます。</p>\n<h3 id=\"iOS\"><a href=\"#iOS\" class=\"headerlink\" title=\"iOS\"></a>iOS</h3><h4 id=\"Safari-1\"><a href=\"#Safari-1\" class=\"headerlink\" title=\"Safari\"></a>Safari</h4><p>iOSもmacOSと同じでGoogleのセーフブラウジングを使っています。不芳で✖️は3つです。</p>\n<h4 id=\"Edge-2\"><a href=\"#Edge-2\" class=\"headerlink\" title=\"Edge\"></a>Edge</h4><p>意外な事にGoogleセーフブラウジングを使っているようです。これは何らかの制約があるのでしょうか。不芳で✖️は3つです。</p>\n<h4 id=\"Chrome、Firefox-3\"><a href=\"#Chrome、Firefox-3\" class=\"headerlink\" title=\"Chrome、Firefox\"></a>Chrome、Firefox</h4><p>想定通り、Googleセーフブラウジングを使っていますが、PC版のGoogleセーフブラウジングとは結果が異なります。不芳で✖️は3つです。</p>\n<h4 id=\"iOSにおけるフィッシングサイトの検出能力\"><a href=\"#iOSにおけるフィッシングサイトの検出能力\" class=\"headerlink\" title=\"iOSにおけるフィッシングサイトの検出能力\"></a>iOSにおけるフィッシングサイトの検出能力</h4><p>iOSは全てのブラウザで同じ結果、Googleセーフブラウジングを使っています。そして検出能力は高くありません。何らかの事情があるのでしょうか。また、Safariでは設定で、他社の<mark class=\"label primary\">コンテンツブロッカー</mark>を設定可能としています。そのせいなのか今1つiOS単体としての防御力を高める事は目指していないように見えます。</p>\n<h3 id=\"ウィルス対策ソフト等\"><a href=\"#ウィルス対策ソフト等\" class=\"headerlink\" title=\"ウィルス対策ソフト等\"></a>ウィルス対策ソフト等</h3><h4 id=\"bitdefender\"><a href=\"#bitdefender\" class=\"headerlink\" title=\"bitdefender\"></a>bitdefender</h4><p>海外のベンダーですが、どれだけ日本のものを検出可能でしょうか。✖️は2つと及第点です。ウィルス対策ソフトとしては信頼できるベンダーではありますが、日本からのタイムリーな情報入手は難しいものがあるのでしょうか。</p>\n<h4 id=\"XG-Firewall\"><a href=\"#XG-Firewall\" class=\"headerlink\" title=\"XG Firewall\"></a>XG Firewall</h4><p>こちらも期待には応えられず、不芳で✖️は3つです。やはり海外製品はフィッシングについては苦手分野なようです。自宅におけるIoTからマルウェアなどを防御できる事をメリットに考えるべきでしょうか。</p>\n<h4 id=\"Norton360\"><a href=\"#Norton360\" class=\"headerlink\" title=\"Norton360\"></a>Norton360</h4><p>iPhone上でVPNとして設定してみましたが全くフィッシングサイトを検知できませんでした。フィッシングとは関係のないサイトで警告を出すなど出来ていたので、Norton360のVPNの仕組みを使った保護というのはフィッシングを対象としていないのかもしれません。</p>\n<h4 id=\"ウィルスバスターモバイル\"><a href=\"#ウィルスバスターモバイル\" class=\"headerlink\" title=\"ウィルスバスターモバイル\"></a>ウィルスバスターモバイル</h4><p>この製品は唯一全てのフィッシングサイトを検出できました。優秀です。トレンドマイクロは日本国内のオフィスもあり、日本の事情に精通している事も一因としてあるのでしょうか。前述したiPhoneのSafariのコンテンツブロッカーとして設定できます。また、SMSもフィルタする機能を持っています。</p>\n<h2 id=\"検証結果を踏まえて\"><a href=\"#検証結果を踏まえて\" class=\"headerlink\" title=\"検証結果を踏まえて\"></a>検証結果を踏まえて</h2><p>フィッシングサイトから防御するため、様々な環境でテストしました。OSやソフトウェアによって特徴がありますので参考にしてください。多くのプログラムをインストールしたり開発する方であればフィッシングへの耐性は強いと思われるので、ウィルス・マルウェア対策に重点を置いて対策すべきでしょうか。一方、スマホアプリ、SNS、ブラウザ程度の使い方でITにあまり詳しくない方なのであればフィッシング対策に重きを置くという考えもあります。</p>\n<p>今回紹介には含められませんでしたが、携帯キャリアが提供しているフィッシング対策もあります。<br>ご家族やご年配の方など心配であればフィッシングについての啓蒙、こういったツールの導入などを検討されてはいかがでしょうか。</p>\n","categories":["Security"]},{"title":"XG Firewall v18の設定におけるベストプラクティス","url":"/new-technology/2020/05/09/best-practice/","content":"<p class=\"onepoint\">この記事で実現すること</p>\nXG Firewall v18を利用するホームユーザー向けに、ベストプラクティスとなる設定をします。\n\n<span id=\"more\"></span>\n\n<h2 id=\"XG-v18のベストプラクティス\"><a href=\"#XG-v18のベストプラクティス\" class=\"headerlink\" title=\"XG v18のベストプラクティス\"></a>XG v18のベストプラクティス</h2><p>XG v18のレイヤ7ファイアウォールは、SSL&#x2F;TLS通信をPort443に限定していません。これまでの一連の設定で実施してきましたが、そもそもファイアウォールのルール自体は非常にシンプルです。https通信を通すのは原則であり、URL・アプリケーション・データの中身をどうチェックするかがレイヤ7ファイアウォールの肝となります。Sophos Communityにおいては、過去発生したランサムウェアや情報漏洩に繋がるProxyやVPN等、様々な検討、議論が重ねられ、ベストプラクティスといえるお勧めの設定が存在します。以下の記事を参考にします。</p>\n<blockquote>\n<p>Sophos XG Firewall &#x2F; Cyberoam: Application filter recommended settings for better application detection<br> <a href=\"https://community.sophos.com/products/xg-firewall/f/recommended-reads/119051/sophos-xg-firewall-cyberoam-application-filter-recommended-settings-for-better-application-detection\">https://community.sophos.com/products/xg-firewall/f/recommended-reads/119051/sophos-xg-firewall-cyberoam-application-filter-recommended-settings-for-better-application-detection</a><br>ランサムウェア: ソフォス製品による回避策のアドバイス<br> <a href=\"https://community.sophos.com/kb/ja-jp/124744\">https://community.sophos.com/kb/ja-jp/124744</a><br>Sophos XG Firewall: 高リスクのアプリケーションをブロックする手順<br> <a href=\"https://community.sophos.com/kb/ja-jp/123102\">https://community.sophos.com/kb/ja-jp/123102</a>　<sup><strong><a href=\"#note1\">[1]</a></strong></sup><br>Best Practice Guide.pdf（2020-06-24追加）<br> <a href=\"https://community.sophos.com/cfs-file/__key/communityserver-discussions-components-files/258/Securing-your-Sophos-XG-Firewall-_2D00_-Best-Practice-Guide.pdf\">https://community.sophos.com/cfs-file/__key/communityserver-discussions-components-files/258/Securing-your-Sophos-XG-Firewall-_2D00_-Best-Practice-Guide.pdf</a></p>\n</blockquote>\n<p>最初の記事がベストプラクティスとも言える内容になっており、この記事を中心に、関連する記事も参考にしながら設定します。</p>\n<h2 id=\"設定内容\"><a href=\"#設定内容\" class=\"headerlink\" title=\"設定内容\"></a>設定内容</h2><h4 id=\"設定の概要\"><a href=\"#設定の概要\" class=\"headerlink\" title=\"設定の概要\"></a>設定の概要</h4><ol>\n<li>XGのコマンドラインでIPSの設定を変更します。初期設定から変更するのはmaxpktsの値です。これは、データの先頭からアプリケーションの判定に8パケットを渡すというもので、この値はパフォーマンスや検出精度に影響するようです。100〜300パケットを設定するのがお勧めとされています。</li>\n<li>アプリケーションフィルタでは、P2P&#x2F;Proxy and Tunnel&#x2F;DNS Multiple QNAME（DNS経由の情報漏洩）&#x2F;OpenVPNを止めるべきと記載があります。また、ハイリスクアプリケーションのカテゴリ（Risk&#x3D;4、High Risk&#x3D;5）も止める事が推奨されるようにカテゴライズされています。</li>\n<li>Webフィルタでは、以下の項目が拒否対象です。</li>\n</ol>\n<ul>\n<li>IPAddress</li>\n<li>None</li>\n<li>Parked Domains</li>\n<li>Spam URLs</li>\n<li>Anonymizers</li>\n<li>Command &amp; Control</li>\n<li>Phishing &amp; Fraud</li>\n<li>Spyware &amp; Malware</li>\n<li>Uncategorized</li>\n</ul>\n<ol start=\"4\">\n<li>個別のファイアウォールのルールでUDP443のQUICを認めない設定、不正なSSL証明書を許可しない等の設定が必要です。</li>\n</ol>\n<h3 id=\"IPSの設定\"><a href=\"#IPSの設定\" class=\"headerlink\" title=\"IPSの設定\"></a>IPSの設定</h3><p>XGの画面右上にある、<mark class=\"label primary\">admin▼</mark>から<mark class=\"label primary\">コンソール</mark>を選択し起動します。パスワードを入力し、<mark class=\"label primary\">4.Device Console</mark>に入ります。そして、以下のコマンドを入力し、期待する設定値を合っているか確認します。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">console&gt; show advanced-firewall</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>Midstream Connection Pickup Off</li>\n</ul>\n<p>ここはXGのv18であれば基本変更する必要はありません。次にIPSの設定です。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">console&gt; show ips-settings</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>maxsesbytes 0</li>\n<li>stream on</li>\n<li>maxpkts 200（推奨値100〜300）</li>\n</ul>\n<p>デフォルトでは、maxpktsが8となっているので、以下のコマンドで200に変更します。ここはマシンスペックにもよるので、100から300の間で設定をチューニングしながらスループットを確認してください。これまでのCommunityでは、この値は80が推奨されていましたが、2020-06-24にSophosより公開された<strong>Best Practice Guide</strong>ではスループットを確認しながら100〜300の間で設定する事が推奨されています。ここでは中央値の200を設定しています。</p>\n<blockquote>\n<p>Best Practice Guide<br> <a href=\"https://community.sophos.com/cfs-file/__key/communityserver-discussions-components-files/258/Securing-your-Sophos-XG-Firewall-_2D00_-Best-Practice-Guide.pdf\">https://community.sophos.com/cfs-file/__key/communityserver-discussions-components-files/258/Securing-your-Sophos-XG-Firewall-_2D00_-Best-Practice-Guide.pdf</a></p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">console&gt; <span class=\"built_in\">set</span> ips maxpkts 200</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"アプリケーションフィルタの設定\"><a href=\"#アプリケーションフィルタの設定\" class=\"headerlink\" title=\"アプリケーションフィルタの設定\"></a>アプリケーションフィルタの設定</h3><p>とにかくアプリケーションの数が多い事と、今後もメンテナンスしていく事を留意して設定します。高リスクというカテゴリであっても、ホームユーザーが利用するアプリケーションもそれなりにあります。ここでは、リコメンドされた拒否アプリの拒否設定をしつつ、ユーザー側で許可する設定を加えていく事になります。ただし下手にアプリを個別選択するようなフィルタにしてしまうと、新しいアプリケーションが追加される都度、メンテナンスが必要となってしまいます。従い<strong>リスクの高いアプリケーションは停止を原則とし、自分が許可するアプリの設定を加え</strong>、以後はなるべくメンテナンスが不要となるように設定します。</p>\n<p>XGの左メニューの<mark class=\"label primary\">アプリケーション</mark>の<mark class=\"label primary\">アプリケーションリスト</mark>の右上に”分類”というフィルタがあります。このフィルタをクリックし展開すると、新規&#x2F;認証済み&#x2F;許容&#x2F;未認証とあります。これはクラウドアプリケーションとして登録されているものが対象となります。左ペインメニューの<mark class=\"label primary\">アプリケーション</mark>から<mark class=\"label primary\">クラウドアプリケーション</mark>で内容が確認できます。</p>\n<img src=\"/new-technology/2020/05/09/best-practice/filter.png\" class=\"\" title=\"alt\">\n\n<p>“未認証”というのは不許可の意味です。デフォルトで、”新規”か”設定なし（空白）”となっています。リスクの高低によらず、自身で”認証済み”または”許容”としたものは許可する事になります。またリスクが低くとも明らかに使わないものは”未認証”を設定すると、そのアプリケーションは直ちに拒否されるようになります。</p>\n<p>具体的にリコメンドされた高リスクアプリケーションを止める設定をしていきます。以下の数字の順番に設定を行ってください。最後に設定したものがルールとして一番上（優先）に位置します。</p>\n<table>\n<thead>\n<tr>\n<th>項番</th>\n<th>対象</th>\n<th>内容</th>\n<th>推奨</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>1</td>\n<td>Risk4,5のアプリ</td>\n<td>ハイリスクアプリケーションは拒否する</td>\n<td>Sophos</td>\n</tr>\n<tr>\n<td>2</td>\n<td>P2P Proxy</td>\n<td>Firewallで電文が解読できない宛先は拒否する</td>\n<td>Sophos</td>\n</tr>\n<tr>\n<td>3</td>\n<td>DNS QNAME,OpenVPN</td>\n<td>アプリケーション個別指定で拒否設する</td>\n<td>Sophos</td>\n</tr>\n<tr>\n<td>4</td>\n<td>自身で許容</td>\n<td>上記で拒否するアプリケーションであっても自身で許容して利用するアプリケーションを列挙する。ホームユーザー向けには、EXEファイル・ZIPファイルなど</td>\n<td>筆者</td>\n</tr>\n<tr>\n<td>5</td>\n<td>未認証</td>\n<td>クラウドアプリケーションで通したくないものについて拒否する</td>\n<td>-</td>\n</tr>\n<tr>\n<td>6</td>\n<td>許容、認証済み</td>\n<td>クラウドアプリケーションで許容する或いは様子をみるものは許可する</td>\n<td>-</td>\n</tr>\n</tbody></table>\n<h4 id=\"アプリケーションフィルタの設定方法\"><a href=\"#アプリケーションフィルタの設定方法\" class=\"headerlink\" title=\"アプリケーションフィルタの設定方法\"></a>アプリケーションフィルタの設定方法</h4><ol>\n<li><p>XGの左メニューの<mark class=\"label primary\">アプリケーション</mark>の<mark class=\"label primary\">アプリケーションフィルタ</mark>から、”追加”ボタンをクリックしてください。フィルタの名前を決めます。テンプレートは”Allow ALL”のままで構いません。ここでは、”Block High Risk Apps”と命名します。</p>\n<img src=\"/new-technology/2020/05/09/best-practice/application1.png\" class=\"\" title=\"alt\">\n</li>\n<li><p>以下のようにカテゴリで<mark class=\"label primary\">リスク</mark>のプルダウンからHigh、Very Highのものを選択し、アクションは”拒否”を選び保存してください。</p>\n<img src=\"/new-technology/2020/05/09/best-practice/application2.png\" class=\"\" title=\"alt\">登録が完了するとリスクの高いアプリケーションが並びます。\n<img src=\"/new-technology/2020/05/09/best-practice/application3.png\" class=\"\" title=\"alt\">\n</li>\n<li><p>アプリケーションフィルタの<mark class=\"label primary\">追加</mark>ボタンをクリックし、フィルタを追加します。今度はカテゴリから、P2PとProxyを選び、<mark class=\"label primary\">アクション</mark>は”拒否”を選び保存します。</p>\n</li>\n<li><p>“DNS QNAME”と”OpenVPN”とをフィルタします。一番右側のプルダウンのスマートフィルタに<code>qname</code>と入力し、Enterキーを押下してください。一旦”DNS Multiple QNAME”が絞り込まれスマートフィルタの欄が空白になりますので、引き続き<code>openvpn</code>と入力し、Enterキーを押下してください。これで2つのフィルタが絞り込まれているので、”拒否”を選択し、”保存”をクリックしてください。</p>\n</li>\n<li><p>ご自身で利用しているアプリが高リスクまたはP2PとProxyに含まれる場合の除外設定です。ログビューアでアプリケーションフィルタログを見ながら拒否されてしまった対象を除外する設定が必要です。ホームユーザーには最低限度EXEファイルおよびZIPファイルは必要でしょうから、スマートフィルタを活用し<code>exe file</code>、<code>zip file</code>と入力し、許可と設定します。</p>\n</li>\n<li><p>フィルタの<mark class=\"label primary\">分類</mark>から”未認証”を選ぶと、自動で”Cloud Application”が選択されます。これを”拒否”として保存します。</p>\n</li>\n<li><p>フィルタの<mark class=\"label primary\">分類</mark>から”許容”と”認証済み”を選択し、<mark class=\"label primary\">アクション</mark>は”許可”として登録します。</p>\n</li>\n</ol>\n<p>クラウドアプリケーションの画面では、以下の通り、過去に通信のあったアプリケーション一覧が表示されます。既に安全と分かっているものについては、<mark class=\"label primary\">classify</mark>から分類を”認証済み”にマークできます。未認証と設定した場合は、アプリケーションフィルタで即座に通信が停止されます。</p>\n<p>これでアプリケーションフィルタの設定は終了です。今後Sophosによりフィルタが定期的に追加されていきますが、リスクの高いアプリケーションは自動的にフィルタされる事になります。また、クラウドアプリケーションはリスクが高でも即座に拒否とはなりませんので、上記の記載のとおり、定期的にクラウドアプリケーションの利用状況を確認してください。</p>\n<h3 id=\"Webフィルタの設定\"><a href=\"#Webフィルタの設定\" class=\"headerlink\" title=\"Webフィルタの設定\"></a>Webフィルタの設定</h3><p>続いてWebフィルタの設定を行います。フィルタとその内容は以下の通りです。</p>\n<table>\n<thead>\n<tr>\n<th>対象</th>\n<th>内容</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>IPAddress</td>\n<td>IPアドレスでアクセスするサイト</td>\n</tr>\n<tr>\n<td>None</td>\n<td>カテゴリに該当しない通信</td>\n</tr>\n<tr>\n<td>Parked Domains</td>\n<td>ドメイン取得後放置されているドメイン</td>\n</tr>\n<tr>\n<td>Spam URLs</td>\n<td>スパムメールに含まれるURL</td>\n</tr>\n<tr>\n<td>Anonymizers</td>\n<td>セキュリティと制御を回避する目的をもって運用されるProxyなど</td>\n</tr>\n<tr>\n<td>Command &amp; Control</td>\n<td>感染したマシン上の悪意のあるソフトウェアからのC2C通信</td>\n</tr>\n<tr>\n<td>Phishing &amp; Fraud</td>\n<td>フィッシングサイト</td>\n</tr>\n<tr>\n<td>Spyware &amp; Malware</td>\n<td>スパイウェア、マルウェア</td>\n</tr>\n<tr>\n<td>Uncategorized</td>\n<td>分類不能なサイト</td>\n</tr>\n</tbody></table>\n<h4 id=\"Webフィルタの設定方法\"><a href=\"#Webフィルタの設定方法\" class=\"headerlink\" title=\"Webフィルタの設定方法\"></a>Webフィルタの設定方法</h4><ol>\n<li><p>XGの左ペインメニューの、<mark class=\"label primary\">Web</mark>、<mark class=\"label primary\">ポリシー</mark>から、”追加”ボタンをクリックします。</p>\n<img src=\"/new-technology/2020/05/09/best-practice/webfilter1.png\" class=\"\" title=\"alt\">\n</li>\n<li><p>上記の図のとおり名前を入力します。ここでは、”Home Policy”とします。デフォルトは許可で、その上に拒否するルールを追加していきます。</p>\n</li>\n<li><p>以下の図のとおり拒否する対象を選択する時には”すべて表示”とし、全てのカテゴリを表示させ、選択してください。<img src=\"/new-technology/2020/05/09/best-practice/webfilter2.png\" class=\"\" title=\"alt\"></p>\n</li>\n<li><p>登録が終わったら、画面の最下部にある、<mark class=\"label primary\">変更を適用</mark>をクリックしてください。</p>\n</li>\n<li><p>最後にWebの<mark class=\"label primary\">全般設定</mark>をクリックします。</p>\n</li>\n</ol>\n<ul>\n<li><mark class=\"label primary\">認識されていないSSLプロトコルをブロック</mark>にチェックします</li>\n<li><mark class=\"label primary\">無効な証明書をブロック</mark>にチェックします</li>\n<li><mark class=\"label primary\">スキャンエンジンの選択</mark>は\"デュアルエンジン\"を選択します<img src=\"/new-technology/2020/05/09/best-practice/webfilter3.png\" class=\"\" title=\"alt\"></li>\n</ul>\n<h3 id=\"ルールとポリシーの設定\"><a href=\"#ルールとポリシーの設定\" class=\"headerlink\" title=\"ルールとポリシーの設定\"></a>ルールとポリシーの設定</h3><p>XGの左ペインの<mark class=\"label primary\">ルールとポリシー</mark>で設定を見直します。デフォルトポリシーとしているルールを選択します。</p>\n<img src=\"/new-technology/2020/05/09/best-practice/rule1.png\" class=\"\" title=\"alt\">\n\n<p>これまでの記事では”To Internet”というデフォルトのルールを作ってきましたので、そのルールを修正します。</p>\n<ul>\n<li><mark class=\"label primary\">Webポリシー</mark>に、\"Home Policy\"を設定します。</li>\n<li><mark class=\"label primary\">アプリケーションコントロール</mark>に、\"Block High Risk Apps\"を設定します。</li>\n<li>Sophos推奨の<mark class=\"label primary\">QUICプロトコルのブロック</mark>にチェックします。</li>\n</ul>\n<p>IPv6を有効にされている方は、IPv4と同様にIPv6のポリシーを設定してください。</p>\n<h3 id=\"SSL-x2F-TLSインスペクションルールの確認\"><a href=\"#SSL-x2F-TLSインスペクションルールの確認\" class=\"headerlink\" title=\"SSL&#x2F;TLSインスペクションルールの確認\"></a>SSL&#x2F;TLSインスペクションルールの確認</h3><p>いよいよ設定も最後です。XGの左ペインメニューの<mark class=\"label primary\">ルールとポリシー</mark>から<mark class=\"label primary\">SSL/TLSインスペクションルール</mark>に進み、右上の<mark class=\"label primary\">SSL/TLSインスペクションの設定</mark>をクリックします。特に設定変更は不要ですが、以下の通りである事を確認してください。</p>\n<img src=\"/new-technology/2020/05/09/best-practice/ssl-inspection.png\" class=\"\" title=\"alt\">\n\n<h2 id=\"除外した設定\"><a href=\"#除外した設定\" class=\"headerlink\" title=\"除外した設定\"></a>除外した設定</h2><p>ベストプラクティスとして記事に記載のある中で今回設定していないものがあります。以下の記載の部分です。</p>\n<blockquote>\n<p>Allow only HTTPS, HTTP, DNS, ICMP, SMPT. Services on LAN→WAN</p>\n</blockquote>\n<p>これはPsiphonおよびTor（トーア）Proxyの対策で、ビジネスの現場においては、恣意的にFirewallを回避させるケースを想定しています。端的に言えば、HTTPS、DNS、メール等の通信許可するポートを最低限にせよというものです。<strong>これを制限すると個人で利用する音楽のストリーミングやSNSなど多くのアプリケーションが動作しなくなる可能性があります</strong>。アプリケーションを全て特定し、宛先サーバーと利用ポートを全て管理するのは個人向けとしては現実的ではありません。願わくば、Torの個人利用はお控えいただいて、この設定を不要とすることをお勧めします。そのうち、XGのアプリケーションフィルタで対応出来るようになる事を期待しましょう。</p>\n<h2 id=\"動作確認\"><a href=\"#動作確認\" class=\"headerlink\" title=\"動作確認\"></a>動作確認</h2><p>ログビューアを開き、”ファイアウォール”、”アプリケーションフィルタ”、”Webフィルタ”を確認します。IPアドレスで接続するもの・カテゴリ無し・分類不能とされたWebフィルタは拒否されるケースが多くあります。ここは状況に応じて除外設定が必要です。</p>\n<p><small id=\"note1\"><strong>[1]</strong><br>　アプリケーションフィルタの説明で、”新しく起動またはアップグレードされたアプリケーションを自動的に次のグループに分類するアプリケーションフィルタ機能が含まれています”と記載されています。クラウドアプリケーションについてはその通りの解釈ですが、アプリケーションフィルタについては起動された場合ではなく、”Sophos社がアプリケーションフィルタを追加した場合”と解釈してください。<br></small></p>\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"パスワード管理ソフトのbitwardenを活用する","url":"/new-technology/2020/08/30/bitwarden/","content":"<img src=\"/new-technology/2020/08/30/bitwarden/password.png\" class=\"\" title=\"alt\">\n\n<h2 id=\"パスワード管理はソフトウェアに任せる\"><a href=\"#パスワード管理はソフトウェアに任せる\" class=\"headerlink\" title=\"パスワード管理はソフトウェアに任せる\"></a>パスワード管理はソフトウェアに任せる</h2><p>「<a href=\"/new-technology/2020/08/14/remote-work/\" title=\"安全快適にリモートワークを行う\">安全快適にリモートワークを行う</a>」で記載したように、リモートワークの活用機会が高まり、ますます各自のパスワード管理が重要になってきています。頭ではパスワードの使い回しは良く無いと理解していながら、結局は文字列＋数字で似たようなパスワードをいくつも作ってしまい、脆弱な状態にあるケースは多いように感じます。パスワード管理ソフトの導入はITリテラシが高く無いとなかなか取り組む機会はありませんが、個人のパスワードと会社のアカウントに利用しているパスワードが類似しているのは問題です。同僚とパスワードを共有してしまうという問題も多くあります。先日のニュースでは国内企業のVPNの脆弱性からパスワードが漏洩し、2要素認証を設定していた企業は救われたと記事になっていました。ここで紹介するパスワード管理ソフトですが、パスワードを管理する事と、ランダムな文字列でのパスワード生成機能の2つの機能を持ちます。また、このbitwardenは、パスワードが登録されたサイトに遷移すると指紋認証や顔認証等でパスワードが入力されます。当然ながら、URLが異なればパスワードを自動入力しないため、フィッシング対策にもなります。このプロダクトは無償、有償と選択が可能ですが、無償でも十分な機能を保持しています。</p>\n<span id=\"more\"></span>\n<h2 id=\"パスワード管理の目指す姿\"><a href=\"#パスワード管理の目指す姿\" class=\"headerlink\" title=\"パスワード管理の目指す姿\"></a>パスワード管理の目指す姿</h2><ul>\n<li>信頼できるソフトウェアを活用する（bitwarden社について）</li>\n<li>クロスプラットフォームで複数のチャネル、有名なブラウザーに対応し利便性が高いこと</li>\n<li>パスワード生成機能は所定の文字数で任意に数字や記号を含められること</li>\n<li>ネットに繋がらなくてもパスワード管理ソフトを利用できること</li>\n<li>可能な限り2要素認証を組み合わせること</li>\n<li>容易にバックアップが取得できること</li>\n<li>本当に重要なIDこそ自分で記憶する。金融に関わるパスワード管理</li>\n<li>クラウド管理かオンプレミス（ローカル環境）か</li>\n</ul>\n<ol>\n<li><p>信頼できるソフトウェアを活用する（bitwarden社について）<br> プロダクトを提供している企業のプライバシーポリシーがしっかり記載され、どの国に属するかが記載され、本人の同意なく情報を開示しないという基本事項がプライバシーポリシーに記載されている事は重要です。曖昧に記載している企業のソフトウェアはお勧めしません。最終的に企業が属する国の命令には逆らえませんが、明瞭である事は重要です。オープンソースである事などは、さらに企業のスタンスが明確です。</p>\n</li>\n<li><p>クロスプラットフォームで複数のチャネル、有名なブラウザーに対応し利便性が高いこと<br> クロスプラットフォームである事は利便性が高くなります。Windowsだけで使えても、スマホでは別管理というのではじきに使わなくなってしまいます。Windows、macOS、iOS、Androidに対応している事は必須条件でしょう。スマホやタブレットなどでは指紋認証や顔認証でスムーズにパスワードを利用できる事が前提です。</p>\n</li>\n<li><p>パスワード生成機能は所定の文字数で任意に数字や記号を含められること<br> サイトによっては文字列数の下限、上限が異なります。また記号の一部が含められないなどサイトによってルールは異なります。パスワード管理ソフトでは、サイトによって任意にルールを定めたうえで生成できる事が求められます。</p>\n</li>\n<li><p>ネットに繋がらなくてもパスワード管理ソフトを利用できること<br> ネットに繋げるためのパスワードや、ブラウザから利用するものがパスワード管理の全てではありません。クローズネットワークやスマホの機内モードであったとしても重要なデータにアクセスする機会はあり得ます。これはソフトウェアのデザインですが、bitwardenはそのシチュエーションを踏まえたソフトウェアのデザインがなされています。</p>\n</li>\n<li><p>可能な限り2要素認証を組み合わせること<br> これはユーザー側に求める要件です。パスワードが漏洩する可能性を踏まえ、利用するサイトやサービスでは2要素認証を設定しておくべきです。パスワード自体を第三者に預けられる前提が2要素認証です。もちろん、bitwardenからパスワード全体が漏洩する事は企業の存続に関わるわけですし、その可能性は低いと考えられますが完璧と考えるべきではありません。今や2要素認証はサービス提供業者の基本提供機能ですからパスワードが万が一漏洩しても水際で防ぐ事ができます。なお、使い方の注意として2要素認証のキーとなる要素をbitwardenに保存するべきではありません。2要素認証で有名なAuthyはバックアップパスワードなどの存在がありますが、これは主に利用するパスワード管理ソフトとは別に管理すべきです。</p>\n</li>\n<li><p>容易にバックアップが取得できること<br> パスワードは漏洩する事が最悪の事象ですが、ロストすると回復に時間を要し、大幅な時間をロスします。各個人の責任でバックアップは取得しておくべきです。bitwardenは、csvまたはjson形式で簡単にエクスポートできます。これを暗号化されたUSBメディアなどにバックアップし、ネットとは繋がらない場所に保管しておく事が求められます。</p>\n</li>\n<li><p>本当に重要なIDこそ自分で記憶する。金融に関わるパスワード管理<br> オンラインバンキングなど、漏洩した時には直接金銭的、かつ高額となり得るものはパスワード管理システムから除外される事をお勧めします。2要素認証があるのは当然としても、です。もちろん上述した暗号化されたUSBメディアに保存しておく事でも構いません。ネットで到達できる場所に保存されるべきではありません。クレジットカードの盗難とは異なり、オンラインバンキングではユーザー側の重過失によって補償減額、または補償せずという取り扱いになりえます。これはパスワードを記載した手帳を盗まれた、パスワードをスマホに保存してあったものが盗難されるなどした場合もユーザー側の重過失にあたる可能性があります。そのアカウントの利用でどういったリスクがあるのかを考えIDとパスワードを管理していく必要があります。●●payのQR決済もオンラインバンキング程は高額にならないものの、金銭流出のリスクがあります。主要なQR決済事業者は不正利用に対して補償するというスタンスが主流ではあるものの、パスワード管理におけるユーザー側の過失があれば補償されない可能性があります。各企業の約款、補償の事項に必ず目を通す必要があります。全ては個別事案での判断という事なのでしょうが、そもそもパスワードの使い回しは過失と言われても仕方がないのではないでしょうか。金融分野は極めてリスクが高いという事になります。QR決済は少額決済ですが、2要素認証は必須といえるでしょう。英単語と数字の単純な組み合わせではない複雑さを持ったパスワードを設定される事をお勧めします。</p>\n</li>\n<li><p>クラウドかオンプレミス（ローカル環境）か<br> 自宅のPCでパスワード管理する事とbitwardenのようにクラウドで管理する事のどちらが安全かと言われれば判断は難しいところです。ちなみに、bitwardenはオンプレミスで構築できます。実際に過去、ubuntu18.04LTSにdocker、docker composeを導入し、bitwardenをセットアップし利用していた事があります。ダイナミックDNSはno-ipを使い、SSLは無償のLet’s Encryptにbitwarden自身が登録すれば完了です。3カ月ごとにスクリプトを走らせればSSL証明書を自動更新し、dockerから最新イメージを自動ダウンロードしてシステムを最新に保ちます。Linux上でMS SQLServerが動作し、bitwardenはコンパクトながらとても技術の高さを感じました。しかし、個人でWAF導入やアクセスログのチェックなどセキュリティ対策を実施する事の難易度の高さも感じ、再びクラウド管理に戻しました。ビジネス目的にて、インターネットに接続されない企業内でbitwardenを活用するのは非常に良い方法です。個人のサイバーセキュリティ対策で実現可能な事は資金面やスキル面でも限界があります。隙を見せず、目立たず狙われにくい事が大切です。</p>\n</li>\n</ol>\n<h2 id=\"bitwardenの利用方法\"><a href=\"#bitwardenの利用方法\" class=\"headerlink\" title=\"bitwardenの利用方法\"></a>bitwardenの利用方法</h2><p><strong>bitwarden</strong>のWebサイトで最初にアカウントを作成します。</p>\n<blockquote>\n<p><a href=\"https://bitwarden.com/\">https://bitwarden.com</a></p>\n</blockquote>\n<img src=\"/new-technology/2020/08/30/bitwarden/bitwarden.png\" class=\"\" title=\"alt\">\n\n<p>アカウント作成の最初の画面こそ英語ですが、実際のアカウント作成画面は日本語となります。利用するアプリも日本語ですので扱いはとても簡単に感じます。</p>\n<img src=\"/new-technology/2020/08/30/bitwarden/account.png\" class=\"\" title=\"alt\">\n\n<p>アカウントの作成が終了したらWebにログインし、もし現在利用されているパスワードマネージャがあるのであればインポートできます。ChromeやFirefoxのパスワードをcsvに一旦出力し、インポートもできます。bitwardenではこのパスワードの集合体を保管庫と呼んでいます。</p>\n<img src=\"/new-technology/2020/08/30/bitwarden/bitwarden1.png\" class=\"\" title=\"alt\">\n\n<p>続いて<mark class=\"label primary\">設定タブ</mark>から2要素認証を設定します。おなじみのAuthyやメール通知を選択できます。</p>\n<img src=\"/new-technology/2020/08/30/bitwarden/bitwarden2.png\" class=\"\" title=\"alt\">\n\n<p>次に、PCであれば、端末毎にbitwardenのクライアントアプリケーションおよび利用するブラウザの拡張機能としてbitwardenをインストールしてください。上記の画面ではYubikey、Duo、FIDOがプレミアム版としての表記がありますが、無償版のbitwardenであっても、生体認証に対応しています。プレミアム版に登録しDuoを選択した場合は、2要素認証の6桁の数字を入力する事なく、シングルサインオンでスマホに通知がきますので以下のように”Approve”をタップするだけでログインが完了します。これはあくまでbitwardenのログインの話であって、各サイトのログイン時にシングルサインオンが可能になるわけではありません。</p>\n<img src=\"/new-technology/2020/08/30/bitwarden/duo1.png\" class=\"\" width=\"400\" title=\"alt\">\n\n<p><strong>Duo Security</strong>は2018年にCisco社が買収しています。CiscoのAnyConnectを使う場合の2要素認証に使われるもので、どちらかといえば法人がターゲットです。最近だとMicrosoft365でも使えるようになりました。個人利用は無償です。</p>\n<blockquote>\n<p>Duo Security<br> <a href=\"https://duo.com/\">https://duo.com</a></p>\n</blockquote>\n<img src=\"/new-technology/2020/08/30/bitwarden/duo2.png\" class=\"\" title=\"alt\">\n\n<p>“Free Trial”と言われると基本は有償サービスのように感じますが、”Free Trial”からアカウントを作成し、速やかに無料アカウント（Duo Free）に切り替え可能です。<br>bitwardenとの連携は以下のようにDuoの画面からbitwardenの情報を元にID、秘密鍵、APIサーバーを設定します。そしてスマホアプリの”Duo Mobile”をセットアップし利用します。</p>\n<img src=\"/new-technology/2020/08/30/bitwarden/duo3.png\" class=\"\" title=\"alt\">\n\n<p>そもそもコストの低いbitwardenでDuoのPushサービスが利用できるという事は、Duoは法人向けの利用料も廉価なのでしょうか。今後色々なサービスでもDuoを利用する機会が増えてくる事が期待されます。</p>\n<h3 id=\"bitwardenの設定\"><a href=\"#bitwardenの設定\" class=\"headerlink\" title=\"bitwardenの設定\"></a>bitwardenの設定</h3><p>bitwardenに対しパスワードの入力の都度、毎回マスターパスワードを入力するのは大変な作業で現実的ではありません。2要素認証を設定していれば、初回こそマスターパスワードと2要素認証が必要ですが、2回目以降のログインでは同一クライアントまたは同一ブラウザであれば2要素認証は不要です。bitwardenはさらにpinによる簡易な対話型認証をし、保管庫にアクセスする事が可能となります。</p>\n<img src=\"/new-technology/2020/08/30/bitwarden/bitwarden3.png\" class=\"\" title=\"alt\">\n\n<h3 id=\"PINによるロック解除\"><a href=\"#PINによるロック解除\" class=\"headerlink\" title=\"PINによるロック解除\"></a>PINによるロック解除</h3><p>ブラウザの拡張機能からbitwardenを呼び出し、”設定”から保管庫のタイムアウトはブラウザ再起動時とし、PINでロック解除にチェックします。すると右側の画面がポップアップするので、簡易なPINコードを決めたら入力し、”ブラウザー再起動時にマスターパスワードでロック”のチェックボックスは外します。最後に”送信”ボタンをクリックし確定します。</p>\n<p>これでブラウザーを再起動しても、再びマスターパスワードは不要でPINコードで保管庫にアクセスできます。</p>\n<h3 id=\"生体認証によるロック解除（スマホ）\"><a href=\"#生体認証によるロック解除（スマホ）\" class=\"headerlink\" title=\"生体認証によるロック解除（スマホ）\"></a>生体認証によるロック解除（スマホ）</h3><p>スマホの場合は最近では生体認証がほぼ使える状態でしょう。iOSであればbitwardenの”設定”から”Face IDでロック解除”をチェックします。Androidの場合も同様にbitwardenの”設定”から”生体認証でロック解除”を設定します。</p>\n<h3 id=\"生体認証によるロック解除（PC）\"><a href=\"#生体認証によるロック解除（PC）\" class=\"headerlink\" title=\"生体認証によるロック解除（PC）\"></a>生体認証によるロック解除（PC）</h3><p>スマホと同様ですが、bitwardenの仕組みはブラウザから生体認証するときにデスクトップアプリのbitwardenとやりとりして認証します。ブラウザ起動後、最初にbitwardenを使う場合はロック解除が必要ですが、この時にデスクトップ版のbitwardenをあらかじめ起動しておくことが必須です。</p>\n<p>Windowsのbitwardenでは、Windows Helloに対応しています。生体認証が付いていないPCであっても、Amazonなどで安価に（2,000円強）で指紋認証のUSBドングルが販売されているのでこちらを利用可能です。Windows Helloのセットアップも難しくはありません。USBに挿せばドライバを自動セットアップしてくれます。Windowsのログイン、bitwarden共に指紋認証が行え便利です。</p>\n<blockquote>\n<p>Amazon 【Amazon.co.jp 限定】SEKC USB指紋認証キー Windows Hello機能対応 0.05秒 指紋認証でセキュリティ対策 SFSD-01<br> <a href=\"https://www.amazon.co.jp/gp/product/B07GLRQPHP/\">https://www.amazon.co.jp/gp/product/B07GLRQPHP/</a></p>\n</blockquote>\n<p>OSのWindows Helloの設定が無事完了すると、bitwardenアプリでも生体認証が行えるようになります。設定から”生体認証でロック解除”をチェックします。また、ブラウザの拡張機能としてbitwardenをインストールし、拡張機能版のbitwardenでも同様に生体認証を設定します。</p>\n<p>macOSでも設定内容はWindowsと同じです。macbookであればTouch IDが使えるので、Touch IDでアプリ、ブラウザ共にロック解除が可能です。私が知る限りでは、SafariとMicrosoft EdgeではTouch IDで解除できますが、mac版Firefoxでは生体認証によるロック解除は使えませんでした。</p>\n<p>なお、生体認証といえばYubikeyが挙げられますが、これはWindows Helloに対応させた運用をするのは難しく、Windows Hello対応の指紋認証デバイスを購入されることをお勧めします。（なんだかややこしい書き方をしていますが、YubikeyではWindowsローカルアカウント前提とか色々運用上の制約があります）。</p>\n<p>その他カスタマイズする箇所としては<mark class=\"label primary\">クリップボードの消去</mark>で、他のアプリケーションからクリップボードの中身を読み取られる可能性を考え、速やかに消去する設定がお勧めです。</p>\n<p>（2020-09-30追記）<br>iOS14から、クリップボードを読み取ったアプリケーションについて画面上部に表示される機能が加わりました。これまでこっそりクリップボードの内容を読み取っていたアプリ提供者も釈明に追われる事でしょう。そのようなアプリは多くないようですが、パスワードや他の重要な情報を読み取られてしまうリスクを念頭に対処してください。</p>\n<h2 id=\"アカウント作成時の実例\"><a href=\"#アカウント作成時の実例\" class=\"headerlink\" title=\"アカウント作成時の実例\"></a>アカウント作成時の実例</h2><p>アカウント作成時に、どのようにパスワードを自動生成し登録していくのかを動画にしてありますので参考にしてください。</p>\n<video src=\"add-account.mp4\" preload=\"metadata\" controlslist=\"nodownload\" controls playsinline poster=\"\"></video>\n\n<p>実例として価格comのサイトへのアカウント作成の挙動です。価格comは半角英数の8〜12文字という制約があります。記号は使えません。パスワードの規則に添うようにパスワードを生成します。</p>\n<p>一度登録してしまえば、ブラウザからのログインはとても簡単です。</p>\n<video src=\"login.mp4\" preload=\"metadata\" controlslist=\"nodownload\" controls playsinline poster=\"\"></video>\n\n<p>サイトによって挙動は異なるのですが、価格comの場合、ログインボタンをクリックするだけで、あとは勝手にbitwardenがIDとパスワードをセットしてくれます。</p>\n<p>これで、たくさんのパスワードに悩まされる事なく、パスワードの使い回しによる、”利用者の過失”というリスクから解放されます。私は、個人向けのセキュリティ対策はまず最初に認証管理が重要と考えています。なかなか興味が向かない分野ですが、参考にしていただければ幸いです。</p>\n<h2 id=\"（補足）bitwardenの脆弱性について\"><a href=\"#（補足）bitwardenの脆弱性について\" class=\"headerlink\" title=\"（補足）bitwardenの脆弱性について\"></a>（補足）bitwardenの脆弱性について</h2><p>bitwardenはオープンソースであるが故に、いろいろな脆弱性を見つけられ、指摘を受ける可能性があります。実際に<strong>JPCERT&#x2F;CC</strong>と<strong>IPA</strong>との共同で提供されている、脆弱性対策情報データベースである<strong>JVN IPedia</strong>から、bitwardenの脆弱性を検索できます。</p>\n<blockquote>\n<p>JPCERT&#x2F;CC<br> <a href=\"https://www.jpcert.or.jp/\">https://www.jpcert.or.jp</a><br>IPA<br> <a href=\"https://www.ipa.go.jp/\">https://www.ipa.go.jp</a><br>JVN IPedia<br> <a href=\"https://jvndb.jvn.jp/index.html\">https://jvndb.jvn.jp/index.html</a></p>\n</blockquote>\n<p>JPN IPediaでbitwardenについて検索すると、2件該当し、直近では2020年7月18日に公開された「JVNDB-2020-008246 Bitwarden Server におけるサーバサイドのリクエストフォージェリの脆弱性」が見つかります。セキュリティの専門家は、このサーバーサイドリクエストフォージェリはかなりリスクが高い内容と認識しています。端的に言えば、bitwarden Serverを踏み台にし、そこからネットワーク内の別のサーバーの情報を抜き取る事が可能（かもしれない）という脆弱性です。またCVSSv3の値が7.5と定量的にもリスクが高い事を示しています。JVN IPediaは速やかに情報共有を行うのが目的であって、ユーザーがどう対応するか、または修正が完全であるかどうかの評価を行いません。<br>この修正に関しては、JPN IPediaから辿ると、bitwardenのGitHub上の<strong>プルリクエスト</strong>が行われており、内容は<strong>hackerOne</strong>から7月16日に指摘されたものでIPv6が混在した場合の脆弱性とわかります。このやりとりを見れば7月18日には修正が行われマージコミットされています。そして7月29日にはVersion1.36.0の提供が行われ、対応完了という流れになります。Version1.36.0については以下を参照してください。</p>\n<blockquote>\n<p>bitwardenのGitHub上のプルリクエスト<br> <a href=\"https://github.com/bitwarden/server/pull/827\">https://github.com/bitwarden/server/pull/827</a><br>hackerOne<br> <a href=\"https://www.hackerone.com/\">https://www.hackerone.com</a><br>Version 1.36.0(GitHub)<br> <a href=\"https://github.com/bitwarden/server/releases/tag/v1.36.0\">https://github.com/bitwarden/server/releases/tag/v1.36.0</a></p>\n</blockquote>\n<p>実際に、クラウド上でbitwarden社がどのように運用しているかまでは公開されていません。一般的には多重化されたサイバーセキュリティ製品で守られており、そう簡単に攻撃が成功するケースは無いものと考えられますが、ユーザーがオンプレミスで運用している場合で、インターネットにbitwarden Serverを公開している場合は高いリスクといえます。そのような理由で私も一時はインターネット接続を認めない形でLAN内のみでオンプレでbitwarden Serverを運用していたものの、こういった情報を頻繁に追っていくのがあまりに大変であるため、再びクラウドの利用に切り替えたという次第です。</p>\n<p>hackeroneに対しては、あくまで企業の意思で登録するもので、bitwarden社はhackeroneへの登録を行っています。hackeroneに登録されたハッカーは脆弱性を見つけた場合には報奨金を得る仕組みとなっています。ハッカーの中には報奨金を寄付に回す人達もいます。bitwarden社のモデルはかなり勇気のある行動で自分たちの技術力に自信が無いとなかなかこういった行動は取れないでしょう。</p>\n<p>サーバーセキュリティ製品なのでサーバーサイドからクライアントに対し緊急パッチを当てる機能は必須です。しかし、「開発者がOSの特権を用いてやりたい放題の脆弱性」だと指摘されるケースもあります。それが脆弱性だとしたらアプリケーションを何もインストールできなくなってしまいます。そういったケースも含めてオープンに説明責任を果たし、ユーザーに考える機会を与える事、信頼を蓄積していく事がプロの仕事でありプロダクトの信頼性に繋がると私は考えています。</p>\n","categories":["Security"],"tags":["bitwarden"]},{"title":"Sophos Firewallのメイン画面と特徴について","url":"/new-technology/2020/03/08/XG-MainPage/","content":"<p class=\"onepoint\">この記事で実現すること</p>\nSophos Firewallの管理画面とメニューから、製品の持つ機能を説明します。\n\n<span id=\"more\"></span>\n<h2 id=\"XGのメインページ\"><a href=\"#XGのメインページ\" class=\"headerlink\" title=\"XGのメインページ\"></a>XGのメインページ</h2><p> XGの管理画面にログインすると、Controle Centerが表示されます。ここでは今の全体のFirewallの状況が示されます。ホームユーザーには相当なボリュームの内容で圧巻です。ホームユーザー向けに一部機能は制限されているので、不要な項目もたくさんありますが、Home Editionとして必要なものを見ていく事にしましょう。</p>\n<img src=\"/new-technology/2020/03/08/XG-MainPage/main1.png\" class=\"\" title=\"alt\">\n\n<ul>\n<li>左上のシステムのアイコンは通常緑色です。</li>\n<li>ネットワーク攻撃やブロックされたアプリなどが画面中央に赤色で表示されます。</li>\n</ul>\n<p>左ペインを見ていきます。</p>\n<table>\n<thead>\n<tr>\n<th>項目</th>\n<th>内容</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>ルールとポリシー</td>\n<td>Firewallのルールを決める一番重要なメニューです</td>\n</tr>\n<tr>\n<td>web</td>\n<td>コンテンツの種類によってアクセス制御を行うメニューです</td>\n</tr>\n<tr>\n<td>ネットワーク</td>\n<td>インストール後、ネットワークの変更を行う時に、それなりに頻度の高いメニューになります</td>\n</tr>\n<tr>\n<td>認証</td>\n<td>VPNを使う時にワンタイムパスワードを併用する際利用します</td>\n</tr>\n<tr>\n<td>ホストとサービス</td>\n<td>自分のFW配下にあるクライアントを登録する時に使用します</td>\n</tr>\n<tr>\n<td>管理</td>\n<td>このFirewallのデバイスの管理を行います</td>\n</tr>\n</tbody></table>\n<p>右上のログビューアをクリックすると別画面でFirewallのログがポップアップします。</p>\n<h2 id=\"Sophos-Firewallのアーキテクチャ\"><a href=\"#Sophos-Firewallのアーキテクチャ\" class=\"headerlink\" title=\"Sophos Firewallのアーキテクチャ\"></a>Sophos Firewallのアーキテクチャ</h2><p>Sophos Firewallの最も重要な機能はv18から採用されている<mark class=\"label primary\">XStreamアーキテクチャ</mark>です。暗号化されたhttpsプロトコルの様々なアプリケーションやコンテンツの中身を高速かつ適切に精査し、脅威から保護、かつ高速に動作する仕組みとなっています。</p>\n<p>以下、Sophosのサイトから引用します。</p>\n<blockquote class=\"blockquote-center\">\n<p>XG Firewallの全く新しいXstreamアーキテクチャは、きわめて高いレベルの可視性、保護、およびパフォーマンスを提供します</p>\n\n</blockquote>\n\n<blockquote>\n<p><strong>TLS インスペクション</strong><br>TLS 1.3 をサポートするネットワーク上の全ての暗号化されたトラフィックに業界をリードするパフォーマンスと可視性を提供</p>\n</blockquote>\n<blockquote>\n<p><strong>Xstream  DPI エンジン</strong><br>単一のストリーミングエンジンで高性能なディープパケット保護を実現し、既知および未知の脅威をすべて阻止</p>\n</blockquote>\n<blockquote>\n<p><strong>Xstream  Network Flow FastPath</strong><br>信頼性が高く重要なクラウド、SaaS、VoIP アプリケーショントラフィックを高速化して、最適なパフォーマンスを実現</p>\n</blockquote>\n<p>今回の構築する環境で実際に計測したSpeedtest.netの速度チェックのキャプチャ画像です。</p>\n<img src=\"/new-technology/2020/03/08/XG-MainPage/speedtest.png\" class=\"\" title=\"alt\">\n\n<p>環境は以下の通りです。</p>\n<ul>\n<li>ネット回線： auひかり5Gbps</li>\n<li>XGのマシンスペック： Core i7メモリ16Gbyte</li>\n<li>仮想環境： ESXi6.7</li>\n<li>ネットワークカード： intel X550-T2</li>\n<li>クライアントPC： CeleronG3900という3年前の一般的なクライアントに5GbpsのNIC(Aquantia AQtion 5G Network Adapter)を組み込んだもの</li>\n</ul>\n<div class=\"note warning\"><p>XG Home Editionは6Gbyteメモリ上限となる制約があります</p>\n</div>\n\n<p>クライアント側のCPUで頭打ちになっており、XGは素晴らしい性能を持っています（もちろん業務向けとしては単一のセッションだけで評価は出来ませんが）。v17まではほぼProxyサーバとしての動作でしたが、v18はPort443に限らず、httpsの流れるデータをリアルタイムで精査します。私は製品のベータ版である、アーリーアクセスプログラムに参加していましたが、テストの最終局面でスピードが劇的に改善した時は感動しました。ホームユーザーが業務向けの製品を使えるのは本当に素晴らしい事です。</p>\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"XG Firewall v18のポリシーをカスタマイズする","url":"/new-technology/2020/03/14/customize-policy/","content":"<p class=\"onepoint\">この記事で実現すること</p>\n\n<p>XG FirewallのWebポリシーをカスタマイズし、コンテンツのカテゴリ（ギャンブル、アダルト、Webメール）毎にアクセス可否を設定します。また閲覧を拒否する情報をインターネット上にあるデータベース等から入手し、XGに取り込めます。</p>\n<span id=\"more\"></span>\n\n<h2 id=\"ポリシーのカスタマイズ\"><a href=\"#ポリシーのカスタマイズ\" class=\"headerlink\" title=\"ポリシーのカスタマイズ\"></a>ポリシーのカスタマイズ</h2><p>XGにおけるWebのポリシーというのはコンテンツのカテゴリを意味し、カテゴリによってアクセスを認めない制御が可能です。ギャンブル、アダルトからネットショッピングやチャットやWebメールまで多岐に渡ります。設定するには左ペインメニューの<mark class=\"label primary\">Web</mark>をクリックします。</p>\n<img src=\"/new-technology/2020/03/14/customize-policy/web1.png\" class=\"\" title=\"alt\">\n\n<p>”Default Policy”の内容がまず最初に表示されているはずです。初期値では、”Blocked URLs for Default Policy”と2番目の行に”Risky Downloads”および”Suspicious（※怪しいもの）”が選択されています。”Risky Downloads”、”Suspicious”が含まれていると、Google検索で”広告”という表示のあるページを正しく表示出来ない場合があります。レイヤ7Firewallルールのポリシーはこういった箇所のカスタマイズが重要となります。これらのポリシーは、Sophosの<strong>Webカテゴリの記事</strong>にも日本語の解説があります。この内容を見ながらWebポリシーのカスタマイズを行ってください。この部分は防御というよりは倫理の概念です。膨大なサイトの分類が既に登録されている事は素晴らしい事ですが、さらに自分で分類を追加できます。</p>\n<blockquote>\n<p>Sophos XG Firewall: Web カテゴリ<br> <a href=\"https://community.sophos.com/kb/ja-jp/134155\">https://community.sophos.com/kb/ja-jp/134155</a></p>\n</blockquote>\n<h2 id=\"外部データベースを取り込む\"><a href=\"#外部データベースを取り込む\" class=\"headerlink\" title=\"外部データベースを取り込む\"></a>外部データベースを取り込む</h2><div class=\"note info\"><p>（2021-10-16更新）<br>この章で説明しているモバイル広告ブロッカーは作者様の都合によって国内の企業に譲渡されました。長い間、一般ユーザーに貴重な情報をご提供いただいた事に感謝いたします。また、新しい引き継ぎ先でも当面ファイルの提供は継続されるとの事です。詳細は以下を参照してください。</p>\n<blockquote>\n<p>280blocker -280blockerの今後の運営について-<br> <a href=\"https://280blocker.net/blog/20210921/3055/\">https://280blocker.net/blog/20210921/3055/</a></p>\n</blockquote>\n</div>\n\n<p>XGは外部のデータベース（ドメインのリスト形式）を取り込む事が可能です。ここでは「280blocker | モバイル広告ブロッカー」のデータ（ドメインテキスト形式）を取り込んでみます。名称の通り、スマホでの広告をカットするために利用されるデータベースです。利用については、ダウンロードのページの注意事項の確認をいただき、ご自身で利用の判断をお願いします。</p>\n<blockquote>\n<p>280blocker ダウンロードページ<br> <a href=\"https://280blocker.net/download/\">https://280blocker.net/download/</a></p>\n</blockquote>\n<div class=\"note warning\"><p>　280blockerのページでは、ファイルのダウンロードLinkをクリックしてもダウンロードできません。”URL中の6桁のｘを現在の年・月の6桁の数字へ変更してください。”と記載されている通り、URLの修正が必要です。</p>\n</div>\n\n<ol>\n<li>ダウンロードするデータとして”ドメインテキスト形式”をダウンロードします</li>\n<li>XGの左ペインメニューの<mark class=\"label primary\">Web</mark>を選択し、”カテゴリ”のタブをクリックします</li>\n<li>名前は”280blocker”とします</li>\n<li>分類は”Objectionable”とします</li>\n<li>設定のカテゴリはローカルのラジオボタンを選択します</li>\n<li>domainのインポートから、先ほどダウンロードしたファイルを選択し取り込みます</li>\n<li>“保存”ボタンをクリックします</li>\n</ol>\n<img src=\"/new-technology/2020/03/14/customize-policy/web2.png\" class=\"\" title=\"alt\">\n\n\n<p>引き続き、<mark class=\"label primary\">Web</mark>の<mark class=\"label primary\">ユーザーアクティビティ</mark>をクリックします。</p>\n<ol>\n<li>画面右上の<mark class=\"label primary\">追加</mark>ボタンをクリックします</li>\n<li>名前は”280blocker”とします</li>\n<li>先ほど”カテゴリ”で作成した”280blocker”を選択し適用します</li>\n<li>最後に”保存”ボタンを押します</li>\n</ol>\n<p>再びWebのポリシータブをクリックし、”Default Policy”の内容を表示します。ここで右側の編集（ペンのアイコン）を選択します。</p>\n<ol>\n<li>ルールの追加ボタンを押すと、先頭にルールが作成されます</li>\n</ol>\n<img src=\"/new-technology/2020/03/14/customize-policy/web3.png\" class=\"\" title=\"alt\">\n\n<ol start=\"2\">\n<li>先頭ルールのアクティビティを選択し”すべてのWebトラフィック”を削除し、”280blocker”を追加します</li>\n<li>“アクション”は”HTTPをブロックする”という赤い盾のバツ印が表示されていますが、そのままにします</li>\n<li>ステータスのトグルをOnにしてください</li>\n<li>最後に画面を下にスクロールし、保存ボタンをクリックします</li>\n</ol>\n<p>これでブラウザやスマホなどで広告のあるサイトを閲覧すると広告が消えている事がわかります。また、ログビューアからWebフィルタを選択すると、”カテゴリ”に280blockerとURLが表示され赤字で拒否されています。スマホに広告ブロッカーを導入する事と結果は同じですが、XGで一括管理できるのとクライアントOSの種類に限らずIoTにも有効ですので導入する価値はあります。</p>\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"ESXI7.0をRyzen7 5700Gで構築","url":"/new-technology/2022/02/27/building-setup-esxi7/","content":"<p class=\"onepoint\">この記事で実現すること</p>\n\n<p>最近、改めて無償版ESXi7.0向けのハードウェアをRyzen CPUをベースにセットアップし直したので参考までに掲載します。vmの動作などは全く問題ありませんが、ESXi自身のセキュアブートだけはうまくいきませんでした。参考になればと思い記録を残します。</p>\n<span id=\"more\"></span>\n\n<h2 id=\"ESXi7のためのハードウェア選定検討\"><a href=\"#ESXi7のためのハードウェア選定検討\" class=\"headerlink\" title=\"ESXi7のためのハードウェア選定検討\"></a>ESXi7のためのハードウェア選定検討</h2><p>ハードウェア選定については以下のポリシーとしました。私はパワーユーザーではなく、1つの仮想マシン（vm)に大きな能力を求めていませんが、LinuxやFirewallなどを中心にvmの数だけは増えていきそうな気がします。これまで使っていたハードウェアは10GBase-TのNICも含めてかなり熱を出していたのでもう少し省電力を求めて探しました。</p>\n<ul>\n<li>CPUは多くのvmを動かすことが想定されるが省電力を意識したい</li>\n<li>筐体はスリムタイプ（Micro-ATX）でグラフィックカードは積まず貴重なPCIeスロットはネットワークカードに使う</li>\n<li>ネットワークカードはintelかMellanoxが候補。熱対策が必要なので10Gbase-Tではなく、SFP+を中心に検討</li>\n<li>ストレージは高速化のためNVMeにしたい</li>\n</ul>\n<h2 id=\"ハードウェア構成\"><a href=\"#ハードウェア構成\" class=\"headerlink\" title=\"ハードウェア構成\"></a>ハードウェア構成</h2><p>以下のハードウェア構成となりました。</p>\n<table>\n<thead>\n<tr>\n<th>パーツ</th>\n<th>製品名</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>CPU</td>\n<td>Ryzen7 5700G 3.8GHz(Radeon Graphics)</td>\n</tr>\n<tr>\n<td>マザーボード</td>\n<td>GIGABYTE B550M S2H Micro-ATX</td>\n</tr>\n<tr>\n<td>メモリ</td>\n<td>SanMax DDR4-3200 1.2Volt Skhynix(88H) 32GB x 2</td>\n</tr>\n<tr>\n<td>NVMe</td>\n<td>Samsung 970EVO Plus PCIE x Gen3 x 4 1TB</td>\n</tr>\n<tr>\n<td>SSD</td>\n<td>WesternDigital Blue 500GB</td>\n</tr>\n<tr>\n<td>NIC</td>\n<td>ipolex OEM (intel X710 chipset) 10GbE SFP＋ 4Port</td>\n</tr>\n<tr>\n<td>電源</td>\n<td>スリムタイプ 300W電源</td>\n</tr>\n</tbody></table>\n<p>キーボード・マウス・NICを除き163,480円でした。NICはダイレクトアタッチケーブル2本を含め$531でした（送料と関税入れると＄580程度）。</p>\n<h3 id=\"CPU\"><a href=\"#CPU\" class=\"headerlink\" title=\"CPU\"></a>CPU</h3><p>毎回の説明ですが、ESXiにおいてはリテール向けのCPUは公式にサポートされていません。intelのCore iシリーズは鉄板ですが、AMD Ryzenでも動くようだという記事もちらほら見かけるようになりました。ESXi7.0になって、AMDのZEN3アーキテクチャをサポートするという内容（具体的にはEPYCに対応する）についてVMWareの方が説明しているビデオを見た事があり、ZEN3アーキテクチャのRyzenなら安定動作が見込めるのではないかと考えました。 私の場合省電力のPCを必要としていました。省電力ながらCPU8コア16スレッドは魅力です。Ryzen7 5700GはTDP65Wなので、全体で100W程度の省電力マシンを構築することを目標としました。ヘッドレスシステム、いわゆるキーボードもマウスもディスプレイ（グラフィックカード）も持たないESXiでのGPUレスのセットアップもあるようですが、トラブル時の緊急対応や後々のクライアントPCとしての再利用も視野に入れ、GPU付きのCPU(APU)を選択しました。</p>\n<h3 id=\"マザーボード\"><a href=\"#マザーボード\" class=\"headerlink\" title=\"マザーボード\"></a>マザーボード</h3><p>秋葉原のパソコンSHOPアーク（Ark)にカスタマイズモデルがあり、それをベースに選択しました。無線LANや2.5GbEなども使う必要がないのでシンプルなマザーボードのGIGABYTE B550M S2H Micro-ATXを選定しました。</p>\n<img src=\"/new-technology/2022/02/27/building-setup-esxi7/B550SH2.png\" class=\"\" width=\"1000\" title=\"alt\">\n\n<h3 id=\"メモリ\"><a href=\"#メモリ\" class=\"headerlink\" title=\"メモリ\"></a>メモリ</h3><p>安定していると評判の国内メーカーのものを選定しました。</p>\n<h3 id=\"ストレージ\"><a href=\"#ストレージ\" class=\"headerlink\" title=\"ストレージ\"></a>ストレージ</h3><p>VMware Commmunityで970EVO Plusが動作するという情報が数件あったのでそれを参考に選定しました。980 Proなどそれ以上の魅力的な製品もありますが、Ryzen7 5700Gを選定しているため、PCIe x 3の制約があり、その上限に合わせた製品にしました。</p>\n<img src=\"/new-technology/2022/02/27/building-setup-esxi7/970evo.png\" class=\"\" width=\"1000\" title=\"alt\">\n\n<h3 id=\"ネットワークカード\"><a href=\"#ネットワークカード\" class=\"headerlink\" title=\"ネットワークカード\"></a>ネットワークカード</h3><p>それなりの数のvmを動作させるとなると必然的にNICは10Gbpsを用意したくなります。過去からintel X550-T2を使ってきてそのまま使い続けるのでも良かったのですが、私の場合、クローゼットに光回線とモデム、CD管が集約されてしまっていることから、そこにあまり熱の出すハードウェアを置けません。次回はSFP&#x2F;SFP+にしようと決めていました。が、NICについては昨今の半導体不足で、欲しいカードは殆ど品切れの状態です。それでAmazon.comでipolexというSFPメーカーがOEM提供しているintel X710のチップが乗った4Portの10GbEカードを購入しました。intel純正のX710のSFP+4Portはフルハイトのカードですが、このipolex社のNICはロープロファイルでしたので私にとっては都合が良いものでした。</p>\n<img src=\"/new-technology/2022/02/27/building-setup-esxi7/ipolex.png\" class=\"\" width=\"640\" title=\"alt\">\n\n<p>なお、2023-2-8時点でamazon.comでもintel純正のSFP+モデルは完売、X710チップが乗った2Portの3rdベンダー製品で$270です。</p>\n<h2 id=\"ESXi7-0u3cのインストール\"><a href=\"#ESXi7-0u3cのインストール\" class=\"headerlink\" title=\"ESXi7.0u3cのインストール\"></a>ESXi7.0u3cのインストール</h2><h3 id=\"UEFIの設定\"><a href=\"#UEFIの設定\" class=\"headerlink\" title=\"UEFIの設定\"></a>UEFIの設定</h3><p>UEFIについては、以下の項目を設定しました。</p>\n<table>\n<thead>\n<tr>\n<th>項目名</th>\n<th>設定値</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>SVM mode</td>\n<td>Enable</td>\n</tr>\n<tr>\n<td>Fast Boot</td>\n<td>Disable</td>\n</tr>\n<tr>\n<td>CSM Support</td>\n<td>Disable</td>\n</tr>\n<tr>\n<td>Secure Boot</td>\n<td>Advanced</td>\n</tr>\n</tbody></table>\n<p>しかし、最終的にはセキュアブートでインストールされませんでした。</p>\n<p>ESXiは事後にもセキュアブートに変更できるのですが、うまくいきません。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@esxi:~] /usr/lib/vmware/secureboot/bin/secureBoot.py -c</span><br><span class=\"line\">Secure boot can be enabled: All vib signatures verified. All tardisks validated. All acceptance levels validated</span><br><span class=\"line\">[root@esxi:~]</span><br><span class=\"line\"></span><br><span class=\"line\">[root@esxi:~] esxcli system settings encryption set --require-secure-boot=T</span><br><span class=\"line\">Unable to change the encryption mode and policy. Verify that the current host configuration can satisfy the new requirement.</span><br><span class=\"line\">[root@esxi:~]</span><br></pre></td></tr></table></figure>\n\n<p>コマンドの前半では、セキュアブートに移行できるかのチェックではOKということですが、実際のセキュアブートへの変更ではエラーとなってしまいます。VMware Communityでも見かける内容ですが明確な答えは無いようです。これはマザーボードとESXiとの相性と考えられますが、今後もウォッチしていきたいと思います。</p>\n<blockquote>\n<p><a href=\"https://communities.vmware.com/t5/ESXi-Discussions/Enabling-Secure-Boot-not-possible/m-p/2864968\">https://communities.vmware.com/t5/ESXi-Discussions/Enabling-Secure-Boot-not-possible/m-p/2864968</a></p>\n</blockquote>\n<h3 id=\"インストール\"><a href=\"#インストール\" class=\"headerlink\" title=\"インストール\"></a>インストール</h3><p>これまで同様、Rufusで32GBのUSBメモリにISOファイルを登録しUSBブートからセットアップしています。64Gbyteのメモリを認識し、NICも4つ認識されました。</p>\n<img src=\"/new-technology/2022/02/27/building-setup-esxi7/esxi1.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<p>NICの情報はこちらです。</p>\n<img src=\"/new-technology/2022/02/27/building-setup-esxi7/esxi2.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<p>ipolexはさらに製造をアウトソースしているのでしょうか、単に販売代理店でしょうか。MACアドレスを見る限りでは、「Beijing Sinead Technology」が製造しているようです。購入にあたってはipolexのサポートの方と色々やりとりができましたので安心して購入できました。</p>\n<p>ストレージコントローラは以下の通りです。NVMe 1GBに加え、バックアップ用途で500GBのSSDを加えています。</p>\n<img src=\"/new-technology/2022/02/27/building-setup-esxi7/esxi3.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<h3 id=\"旧マシンからvmの移行\"><a href=\"#旧マシンからvmの移行\" class=\"headerlink\" title=\"旧マシンからvmの移行\"></a>旧マシンからvmの移行</h3><p>環境が異なるため、vSwitchやポートグループの設定はやり直しになりました。NASに対するNFSのマウントなど、いくつかの作業はありますが、そう重い作業ではありません。旧マシンでghettoVCBのバックアップから新環境にレストア、こちらも特段問題がなく3つのvmはあっさり30分程度で終了です。セキュアブートにしていたubuntuやWin10などは問題なく起動しています。</p>\n<h2 id=\"ストレージのパフォーマンス\"><a href=\"#ストレージのパフォーマンス\" class=\"headerlink\" title=\"ストレージのパフォーマンス\"></a>ストレージのパフォーマンス</h2><p>vmのWindows10で実行したCrystal Disk Markの結果です。</p>\n<img src=\"/new-technology/2022/02/27/building-setup-esxi7/DiskMark.png\" class=\"\" width=\"480\" title=\"alt\">\n\n<h2 id=\"ネットワークのパフォーマンス\"><a href=\"#ネットワークのパフォーマンス\" class=\"headerlink\" title=\"ネットワークのパフォーマンス\"></a>ネットワークのパフォーマンス</h2><p>こちらはWindows10Proのvmから10GbEのNASに対するiperf3の結果です。シングルスレッドだと7Gbps程度が限界のようです。元々、Windows版のiperf3はUNIXからの移植のためのヘルパー機能であるランタイムライブラリ「Cygwin1.dll」を使っておりパフォーマンスが出づらい状況にあります。さらに対向する端末の能力が高くないとこのような結果になりやすいです。10並列でようやく期待値となりました。</p>\n<ul>\n<li>シングルスレッド</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">C:\\Users&gt;iperf3 -c 192.168.x.x</span><br><span class=\"line\">[ ID] Interval           Transfer     Bandwidth</span><br><span class=\"line\">[  4]   0.00-10.00  sec  8.48 GBytes  7.29 Gbits/sec                  sender</span><br><span class=\"line\">[  4]   0.00-10.00  sec  8.48 GBytes  7.29 Gbits/sec                  receiver</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li>10スレッド</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">C:\\Users&gt;iperf3 -c 192.168.x.x -P10</span><br><span class=\"line\">[ ID] Interval           Transfer     Bandwidth</span><br><span class=\"line\">(省略)</span><br><span class=\"line\">[SUM]   0.00-10.00  sec  10.9 GBytes  9.33 Gbits/sec                  sender</span><br><span class=\"line\">[SUM]   0.00-10.00  sec  10.8 GBytes  9.28 Gbits/sec                  receiver</span><br></pre></td></tr></table></figure>\n\n<p>ubuntu20は問題なしです。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">user@ubuntu1:~$ iperf3 -c 192.168.x.x</span><br><span class=\"line\"></span><br><span class=\"line\">Connecting to host 192.168.x.x, port 5201</span><br><span class=\"line\">[  5] local 192.168.x.x port 55808 connected to 192.168.x.x port 5201</span><br><span class=\"line\">[ ID] Interval           Transfer     Bitrate         Retr  Cwnd</span><br><span class=\"line\">[  5]   0.00-1.00   sec  1.09 GBytes  9.39 Gbits/sec    0   1.69 MBytes</span><br><span class=\"line\">[  5]   1.00-2.00   sec  1.07 GBytes  9.20 Gbits/sec    0   1.69 MBytes</span><br><span class=\"line\">[  5]   2.00-3.00   sec  1.10 GBytes  9.42 Gbits/sec    0   1.69 MBytes</span><br><span class=\"line\">[  5]   3.00-4.00   sec  1.09 GBytes  9.40 Gbits/sec    0   2.10 MBytes</span><br><span class=\"line\">[  5]   4.00-5.00   sec  1.10 GBytes  9.42 Gbits/sec    0   2.21 MBytes</span><br><span class=\"line\">[  5]   5.00-6.00   sec  1.09 GBytes  9.40 Gbits/sec  696   1.75 MBytes</span><br><span class=\"line\">[  5]   6.00-7.00   sec  1.09 GBytes  9.41 Gbits/sec    0   1.75 MBytes</span><br><span class=\"line\">[  5]   7.00-8.00   sec  1.10 GBytes  9.42 Gbits/sec    0   1.75 MBytes</span><br><span class=\"line\">[  5]   8.00-9.00   sec  1.10 GBytes  9.42 Gbits/sec    0   1.75 MBytes</span><br><span class=\"line\">[  5]   9.00-10.00  sec  1.06 GBytes  9.10 Gbits/sec    0   2.22 MBytes</span><br><span class=\"line\">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class=\"line\">[ ID] Interval           Transfer     Bitrate         Retr</span><br><span class=\"line\">[  5]   0.00-10.00  sec  10.9 GBytes  9.36 Gbits/sec  696             sender</span><br><span class=\"line\">[  5]   0.00-10.00  sec  10.9 GBytes  9.34 Gbits/sec                  receiver</span><br><span class=\"line\"></span><br><span class=\"line\">iperf Done.</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>速度としては問題ありませんが、ubuntu側にRetrの数字が出ており、対向側端末の能力不足で送信側のTCPの再送が稀に入っています。</p>\n<h2 id=\"電力チェック\"><a href=\"#電力チェック\" class=\"headerlink\" title=\"電力チェック\"></a>電力チェック</h2><p>簡単な負荷テストを実施してみました。このESXi上にある仮想マシン2つを使ったテストです。ubuntu(2vCPU)からfast.comへの速度テストとSophos Firewall(4vCPU)でIPSによるSSL&#x2F;TLSインスペクションの負荷試験です。回線契約はauひかりの5Gbpsですが、FirewallのSSL&#x2F;TLSインスペクションが入るのでスループットは落ちます。CPUリソースおよび電力の記録は以下の通りです。</p>\n<img src=\"/new-technology/2022/02/27/building-setup-esxi7/fastcom.png\" class=\"\" width=\"400\" title=\"alt\">\n\n<img src=\"/new-technology/2022/02/27/building-setup-esxi7/esxi4.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<img src=\"/new-technology/2022/02/27/building-setup-esxi7/wchecker.png\" class=\"\" width=\"400\" title=\"alt\">\n\n<p>CPU使用率は綺麗に分散していますしまだ半分ほど余力があります。Sophos FirewallのIPSは4つのスレッドで動作すると聞いていたことがあったので、1つのスレッド（vCPU）に偏るか最大4つのスレッドに偏るかと思いましたが、良い意味で予想は外れました。電力については、何もしていない時で35W、速度テスト実施中でも100Wに到達しない程度です。</p>\n<p>ちなみに、数分速度テストを実施した後のダイレクトアタッチケーブルのSFP+モジュール部分は冷たく感じる程度で全く熱を持っていませんでした。</p>\n<h2 id=\"SFP-について\"><a href=\"#SFP-について\" class=\"headerlink\" title=\"SFP+について\"></a>SFP+について</h2><p>今回、SFP+の4PortのNICを選択しましたが、インターネット接続側のホームゲートウェイ（HGW)は従来のRJ-45の端子であることが殆どです。この場合は以下の選択肢があります。</p>\n<ol>\n<li>拡張性のあるマザーボードを選定し、2つのPCIeスロットに2枚のネットワークカードを挿す（1つはRJ45、1つはSFP＋）</li>\n<li>RJ45ポートとSFP＋ポートを持つスイッチングハブを経由し、ESXiからスイッチにはSFP＋で接続、スイッチからHGWにはRJ45で接続する。この場合はスイッチにおけるLAN側、WAN側とをVLANでネットワークセグメントを分離する必要があります（私はこの方法を選択）。</li>\n<li>SFP＋からRJ45への変換専用の小さなスイッチを用意する（CRS305-1G-4S+IN)。但し、この場合もRJ45変換のSFP＋トランシーバーは必要です。HGWが2.5GbpsのRJ45タイプであればQNAPの小さいスイッチも合うでしょうか。</li>\n</ol>\n<ul>\n<li>MikroTik<br> <a href=\"https://mikrotik.com/product/crs305_1g_4s_in\">https://mikrotik.com/product/crs305_1g_4s_in</a></li>\n<li>QNAP<br> <a href=\"https://www.qnap.com/ja-jp/product/qsw-2104-2s\">https://www.qnap.com/ja-jp/product/qsw-2104-2s</a></li>\n</ul>\n<p>お勧めしないのは、NICのSFP＋ポートにRJ45変換のための10Gトランシーバーを接続することです。10GのRJ45トランシーバーは最大3W程度の消費電力ではありますが、触れなくなるほど高熱（70℃）になり、NICに接続するのはNIC破損の危険が高いです。またPCIからSFP+ポートへの電力供給不足でリンクアップしなかったり、2.5Gでリンクアップする場合があります。<br>スイッチに10Gトランシーバーを接続する場合、ネットワーク機器を販売しているMikroTikでは以下のガイダンスを提示しています。</p>\n<blockquote>\n<p>MikroTik S+RJ10 general guidance<br> 前述の通り、S+RJ10(10Gbps RJ45トランシーバー)は通常のトランシーバーよりも発熱が大きく、特にリニアSFPケージを4つ持つデバイスでは、並べて置くとオーバーヒートにつながる可能性があります。S+RJ10は2個おきに配置し、その間に光トランシーバーか空きポートを確保することをお勧めします。</p>\n</blockquote>\n<p> <a href=\"https://wiki.mikrotik.com/wiki/S%2BRJ10_general_guidance\">https://wiki.mikrotik.com/wiki/S%2BRJ10_general_guidance</a></p>\n<p>MikroTikのS+RJ10は高発熱で有名なモジュールですが、他の10GBase-T SFP+モジュールも相当な温度になります。トランシーバーの作りに問題があるわけではなく、そもそも10GBase-T（RJ-45）はかなりの発熱になってしまい、スイッチングハブであっても内部は相当な熱を持ちます。</p>\n<p>SFP+の詳細な情報については「 <a href=\"/new-technology/2022/05/28/sfp-plus/\" title=\"10GネットワークとSFP+\">10GネットワークとSFP+</a> 」にまとめてあります。</p>\n<p>Mellanoxの現行モデルはやはり在庫を殆ど見かけない状況ですが、古いMellanoxのConnect X-3(MCX311A-XCAT)は安価で手に入ります（ebayなどでは5,000円程度です）。私はMellanoxのConnect X-3(PCIe3 x 4)を保有しており、Windows10とQNAPのNAS（TVS-473e）で動いています。Connect X-3は2019年10月に既に販売終了しています。5年後のサービス終了までは保守されるようですが、最近のドライバなどは見かけません。また新しいOSでは対応が見送られる可能性があります。ただ、半導体不足の今の時期のつなぎとして割り切る考え方もありだと思います。Nvidia（Mellanox）のサイトではESXi7.0のドライバはConnect X-4を対象にしているようですが、セキュアブートのESXi 7.0U3cではインストール時にドライバ追加無しでNICのリンクアップ、疎通確認はできています。動作確認についてはESXiにログインしたまでで、仮想マシンを作成して動作まではさせていません。あくまでご参考です。</p>\n<img src=\"/new-technology/2022/02/27/building-setup-esxi7/mellanox.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<blockquote>\n<p>Mellanox End of Life Notification Procedure<br> <a href=\"https://network.nvidia.com/related-docs/eol/LCR-000532.pdf\">https://network.nvidia.com/related-docs/eol/LCR-000532.pdf</a></p>\n</blockquote>\n<h2 id=\"intel-X710の注意点について\"><a href=\"#intel-X710の注意点について\" class=\"headerlink\" title=\"intel X710の注意点について\"></a>intel X710の注意点について</h2><p>X710は省電力で安定した動作をしますが、過去に何度もファームウェアの脆弱性が指摘されています。今の半導体不足の外部環境下において、もはやintel純正を購入することは困難ですが、サードパーティ製のNICでX710のチップが乗ったものを購入する場合であっても、ファームウェアの更新が必要になってきます。ESXiにおけるネットワークカードのファームウェアの更新方法も整理していますので、以下の記事を参照してください。</p>\n<ul>\n<li><a href=\"/new-technology/2022/04/02/nic-firmware/\" title=\"ESXiでネットワークカードのファームウェアを更新する\">ESXiでネットワークカードのファームウェアを更新する</a></li>\n</ul>\n","categories":["Hardware"],"tags":["ESXi","10GbE"]},{"title":"auひかり BL3000HM","url":"/new-technology/2023/01/28/bl3000hm/","content":"<img src=\"/new-technology/2023/01/28/bl3000hm/bl3000hm.png\" class=\"\" width=\"240\" title=\"alt\">\n<p class=\"onepoint\">この記事で実現すること</p>\n\n<p>auひかりの新しいホームゲートウェイ（HGW)に交換してみたのでレポートします。ONUと一体型となったモデルです。Wi-Fi6Eにも対応しています。私はauひかりのWi-Fiは契約していないため、Wi-Fi以外の基本性能・機能について紹介します。</p>\n<span id=\"more\"></span>\n\n<h2 id=\"auひかりホームユーザー向け、HGW交換の案内\"><a href=\"#auひかりホームユーザー向け、HGW交換の案内\" class=\"headerlink\" title=\"auひかりホームユーザー向け、HGW交換の案内\"></a>auひかりホームユーザー向け、HGW交換の案内</h2><p>auひかりではこれまでもユーザーの希望によるホームゲートウェイの交換について、半導体不足により一時的に交換を停止していましたが、昨年末に再開するという案内がありました。</p>\n<blockquote>\n<p>2022&#x2F;12&#x2F;22 auひかり ホームゲートウェイ：お客さまのご要望による交換（希望交換）の再開について<br> <a href=\"https://www.au.com/information/notice_internet/service/20221220-01/\">https://www.au.com/information/notice_internet/service/20221220-01/</a></p>\n</blockquote>\n<p>私はこれまでホーム5ギガユーザーとしてBL1000HW（HGW）と10G-PON（ONU）をレンタルで利用していましたが、ONU一体型のHGWになるということで多少のレイテンシと消費電力の改善期待があり早速交換のお願いをしました。交換には3,300円掛かるとの記載があります。電話回線が2回線ある場合はBL3000HMには交換できないようです。<br>インターネット回線によるスピードテストでも3ギガ程度は出ており全く不満はありませんが、5ギガと10ギガの差額が月額780円なので、10ギガの契約に併せて変更もしました。</p>\n<h2 id=\"auひかりホーム10ギガ・5ギガについて\"><a href=\"#auひかりホーム10ギガ・5ギガについて\" class=\"headerlink\" title=\"auひかりホーム10ギガ・5ギガについて\"></a>auひかりホーム10ギガ・5ギガについて</h2><p>auひかりのホーム10ギガ・5ギガサービスは関東圏の一部エリアのみ提供となっています。IPv4&#x2F;IPv6デュアルスタックで複雑な設定が不要で高速インターネットが利用できます。<br>ホーム10ギガ・5ギガのサービス説明は以下を参照してください。</p>\n<blockquote>\n<p>auひかり ホーム10ギガ・5ギガ<br> <a href=\"https://www.au.com/internet/auhikari_10-5g/\">https://www.au.com/internet/auhikari_10-5g/</a></p>\n</blockquote>\n<p>基本情報、マニュアルは以下を参照してください。</p>\n<blockquote>\n<p>auひかり ホームゲートウェイ Aterm BL3000HM<br> <a href=\"https://www.au.com/support/service/internet/guide/modem/bl3000hm/\">https://www.au.com/support/service/internet/guide/modem/bl3000hm/</a></p>\n</blockquote>\n<h2 id=\"BL3000HM\"><a href=\"#BL3000HM\" class=\"headerlink\" title=\"BL3000HM\"></a>BL3000HM</h2><p>年末に申し込んで年明け早々にBL3000HM（BL3000：右側）が届きました。BL1000（左側）も大きかったですがBL3000はかなり大きいと感じます。交換は自分で行います。</p>\n<img src=\"/new-technology/2023/01/28/bl3000hm/bl3000-1.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p>横幅28cm程度もありますね。私の場合はクローゼットの中に収まるので大きさは特に気になりませんが、リビングに配置するとなると少し目立つサイズです。</p>\n<p>BL3000には、上記写真にある通り、ひかり回線と接続するコネクタ付きのシングルモードファイバケーブル（約3m）が既に取り付けられています。説明書には約3mと書いてありますが、これ3mもあるかな。。。その他付属品として電源ケーブル（アース無し）とLANケーブル（1.5m）があります。</p>\n<table>\n<thead>\n<tr>\n<th>機種</th>\n<th>消費電力</th>\n<th>アース</th>\n<th>LANケーブル</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>BL3000HM</td>\n<td>45W（最大）</td>\n<td>無し</td>\n<td>Cat6A STP</td>\n</tr>\n<tr>\n<td>BL1000HW</td>\n<td>34W(最大)</td>\n<td>無し</td>\n<td>Cat6A STP</td>\n</tr>\n<tr>\n<td>10G-EPON</td>\n<td>14.3W以下</td>\n<td>無し</td>\n<td>Cat6A STP</td>\n</tr>\n</tbody></table>\n<p>最大消費電力だけで見るとBL1000とONUとを合計したものとBL3000と比較した場合は大して変わりません。BL1000、BL3000共にWi-Fi機能を持ちますから、Wi-Fiを使わない場合はそれなりに電力が抑えられているものと思います。付属のケーブルは前回も今回も変わらず、Cat6Aのシールドツイストペア（STP）です。STPを使う場合には正しいアースが云々というご意見もあるようですが、短いケーブルについて気にすることは無いということでしょう。LAN4というRJ45の口が10GbEですが、5G&#x2F;2.5G&#x2F;1G&#x2F;100Base-TXにも対応しています。</p>\n<p>早速、BL3000のファイバケーブルを光回線に接続し直し、LANケーブルを10GbEポートに接続し、電源を入れてみます。</p>\n<img src=\"/new-technology/2023/01/28/bl3000hm/wchecker.png\" class=\"\" width=\"360\" title=\"alt\">\n\n<p>普段のアイドル状態で16.35w、2.5Gbps程度のアップロード時で16.5Wです。やはりネットワーク機器なのでNATやフィルタ処理などを除いたルーティングは通信専用のチップ（ASIC）が対応するため通信量と電力とは殆ど関係ありません。</p>\n<h2 id=\"回線速度\"><a href=\"#回線速度\" class=\"headerlink\" title=\"回線速度\"></a>回線速度</h2><p>さて、いつものSpeedtestです。HGWとスイッチとをRJ45で接続し、スイッチとMacBook-AirとをSFP+で接続して計測してみます。平日の夕方に計測しました。</p>\n<p>HGWのLANに接続</p>\n<img src=\"/new-technology/2023/01/28/bl3000hm/speedtest1.png\" class=\"\" width=\"360\" title=\"alt\">\n\n<p>Sophos Firewall（TLS／SSLインスペクション有り）を通した速度</p>\n<img src=\"/new-technology/2023/01/28/bl3000hm/speedtest2.png\" class=\"\" width=\"360\" title=\"alt\">\n\n<p>HGWのLANに接続した場合は5Gbps以上の速度が出ています。一方、FirewallのTLS&#x2F;SSLインスペクションを通しても下りはさほど落ちていません。上りは流石にデータ漏洩の観点から厳しくチェックするのでこれくらいには落ちてしまうのは仕方がないところでしょうか。自宅内のFirewallを通してもレイテンシ（Ping）が3ミリ秒という表示になっており、かなりの低遅延のネットワークになっていると言えそうです。これまでは4ミリ秒でした。</p>\n<p>朝方の計測はHGW直結で5Gbps〜6Gbps程度の速度です。</p>\n<h2 id=\"ログ機能\"><a href=\"#ログ機能\" class=\"headerlink\" title=\"ログ機能\"></a>ログ機能</h2><p>今回のHGWは簡単なログ機能が付いています。HGWのデフォルトのLANのIPアドレスは<code>192.168.0.1/24</code>です。</p>\n<img src=\"/new-technology/2023/01/28/bl3000hm/log.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<h2 id=\"スイッチ部分\"><a href=\"#スイッチ部分\" class=\"headerlink\" title=\"スイッチ部分\"></a>スイッチ部分</h2><p>BL1000HWと同様、BL3000HMも10GbEが1Port、1GbEが3Portとなります。</p>\n<img src=\"/new-technology/2023/01/28/bl3000hm/sw.png\" class=\"\" width=\"360\" title=\"alt\">\n\n<p>一般的に、スイッチ機能を持つ1Gのチップ（PHY）は4Port単位で組まれることが多いです。10GbEと1GbEと合わせて4Portというのは、実際に10GbEに対応した4PortのPHYに1GbEの3Portが接続されているのでは？と妄想してしまいます。</p>\n<p>10Gポートと1Gポートとのスループットはどうでしょうか。10Gポートには、Mellanox Connect-X3(10G SFP+)を挿したUbuntu22をSFP+スイッチ経由で接続し、1GポートにはMacBook-AirにPlaggableのUSBアダプタを挿してiperf3を実行してみます。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">yoshi@ub22:~$ iperf3 -c 192.168.0.3</span><br><span class=\"line\">Connecting to host 192.168.0.3, port 5201</span><br><span class=\"line\">[  5] <span class=\"built_in\">local</span> 192.168.0.4 port 48032 connected to 192.168.0.3 port 5201</span><br><span class=\"line\">[ ID] Interval           Transfer     Bitrate         Retr  Cwnd</span><br><span class=\"line\">[  5]   0.00-1.00   sec   115 MBytes   963 Mbits/sec    0   3.77 MBytes</span><br><span class=\"line\">[  5]   1.00-2.00   sec   112 MBytes   944 Mbits/sec    0   3.77 MBytes</span><br><span class=\"line\">[  5]   2.00-3.00   sec   112 MBytes   944 Mbits/sec    0   3.96 MBytes</span><br><span class=\"line\">[  5]   3.00-4.00   sec   111 MBytes   933 Mbits/sec    0   3.96 MBytes</span><br><span class=\"line\">[  5]   4.00-5.00   sec   112 MBytes   944 Mbits/sec    0   3.96 MBytes</span><br><span class=\"line\">[  5]   5.00-6.00   sec   112 MBytes   944 Mbits/sec    0   3.96 MBytes</span><br><span class=\"line\">[  5]   6.00-7.00   sec   112 MBytes   944 Mbits/sec    0   3.96 MBytes</span><br><span class=\"line\">[  5]   7.00-8.00   sec   112 MBytes   944 Mbits/sec    0   3.96 MBytes</span><br><span class=\"line\">[  5]   8.00-9.00   sec   111 MBytes   933 Mbits/sec    0   3.96 MBytes</span><br><span class=\"line\">[  5]   9.00-10.00  sec   112 MBytes   944 Mbits/sec    0   3.96 MBytes</span><br><span class=\"line\">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class=\"line\">[ ID] Interval           Transfer     Bitrate         Retr</span><br><span class=\"line\">[  5]   0.00-10.00  sec  1.10 GBytes   944 Mbits/sec    0             sender</span><br><span class=\"line\">[  5]   0.00-10.03  sec  1.10 GBytes   941 Mbits/sec                  receiver</span><br></pre></td></tr></table></figure>\n\n<p>文句なしのパフォーマンスです。このタイミングでワットチェッカーを確認してみました。</p>\n<img src=\"/new-technology/2023/01/28/bl3000hm/wchecker2.png\" class=\"\" width=\"360\" title=\"alt\">\n\n<p>10GbEに加え、1GbEのRJ45をBL3000HMに接続しているため、ベースの消費電力は16.787Wとなっています。10GbEのみと比べ、0.43W消費電力が増えています。<br>これにiperf3を実行したタイミングでは、16.84Wとなり、僅か0.07W弱の消費電力が上昇しています。非常に誠実な作りであると思われます。</p>\n<p>10GのPHYは単体であったり、2Port、4Portと様々な種類がありますが、他の製品のHGWやWi-Fiルーターで1GbEが4Port、10GbEが1Portある製品を見た時には、それらを繋ぐのはどうやっているのかな？と気になります。ASICではなくCPU（ソフトウェア）で相互にパケットをやり取りしている製品もあるらしく、10GbEと1GbEの通信のパフォーマンスが出ないそうです。</p>\n<h2 id=\"レイテンシとアプリケーション\"><a href=\"#レイテンシとアプリケーション\" class=\"headerlink\" title=\"レイテンシとアプリケーション\"></a>レイテンシとアプリケーション</h2><p>私は10Gbpsのトラフィックを必要としていませんが、こういった多段のセグメントを介するネットワーク構成(VLAN)&#x2F;仮想環境&#x2F;Firewall&#x2F;アンチウィルス&#x2F;アプリケーションFirewallを組み合わせているため、少しでもレイテンシが大きくなるのを防ぎたいという狙いがあります。こうやって全体を俯瞰して見ると、セキュリティのためとはいえ、レイテンシが大きくなるような事ばかりしているわけです。</p>\n<p>私の使っているアンチウィルスソフトのBitDefenderはそれ単体でTLS&#x2F;SSLインスペクションを実行するため、なおさら遅くなります。</p>\n<p>最近のファイル転送プロトコルであればファイルのやり取りに高度な並列処理を実施することでトータルのデータ転送量を稼ぎますが、アプリケーションによっては単一のTCPセッションによるやり取りとなります。そのようなアプリケーションはいくら回線が太くても、到底大きな転送量はこなせません。数10Mbps程度の速度でもレイテンシが大きく関係するようになります。</p>\n<p>高速回線と聞けば、ストリーミングビデオを思いつく方が多いでしょうか。4Kの映画や音楽配信サービスなどは負担が大きそうに思えるかもしれません。しかしこのようなサービスはデータの先読みができて、いくらでもバッファに積めます。1秒後どころか1分後に再生すべきであろうデータは全て読み込んでおけるので回線が多少不安定でも並列度を高めてデータ受信することで全く問題ありません。<br>しかし、電話であればそうはいきません。データの安定度を高めるために0.2秒程度のバッファは持ちますが、それ以上のバッファを持ち、遅延させると電話による会話が噛み合わなくなります。現代のリモートワークでも同時に発言してお互い譲り合うというのは見慣れた光景かもしれません。ホームユーザーであれば、リモートワークはもちろん、オンライン授業・コミュニティや友人・家族・親戚とのビデオ通話などが該当するでしょう。こういったビデオ通話ではデータの先読みが殆ど出来ないため、ネットワークの品質とレイテンシが大きく影響します。</p>\n<p>私はオンラインゲームはしませんが、これもビデオ会議と同様でしょう。TCP通信では遅すぎるのでUDP通信でアプリケーション固有のプロトコルでやりとりすることになるでしょうか。私は自宅の環境でパケットロスを認識できるほどの経験はありませんが、回線の太さ以前に、パケット損失が大きく出てしまうプロバイダや回線業者もあるようです。私が10ギガネットワークを使いたいというのは光回線で、通信業者自体が持つバックボーンに（レイテンシが極めて小さい）大型ネットワーク機器が収容されていることを期待しています。さらに言えば、Apple、Googleなどの主要IT、CloudflareやAkamaiなどのCDN（コンテンツ・デリバリ・ネットワーク）、AWSやAzureなどのクラウドサービスにネットワーク的に近い環境が好ましいとも言えます。</p>\n<p>私が利用しているSophos Firewallではレポート機能でビデオ会議のトラフィックを確認できます。</p>\n<img src=\"/new-technology/2023/01/28/bl3000hm/sophos.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<mark class=\"label primary\">Conferencing</mark> でフィルタすると、Teams会議、Zoom会議がクラウドアプリケーションとして判定され、サーバーIPアドレスも列挙されます。\n\n<p>実例として、Microsoft365のTeamsのサーバーにpingでレイテンシを計測してみます。</p>\n<img src=\"/new-technology/2023/01/28/bl3000hm/ping.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p>10分程度、pingの往復レイテンシを計測しています。平均4.6msであり、非常に低レイテンシでスパイクもせいぜい20ms以下ですから安定していると言えます。サーバーIPアドレスをGeo Locationで見ると場所は米国のマイクロソフト社になりますが、レイテンシから鑑みると関東近辺のデータセンターになると思われます。私の感覚的なものですが、米国の西海岸までは純粋なネットワークだけで往復100msのレイテンシ、東海岸までは往復150ms程度はあるはずです。実際のサーバーとの往復だと数百msにはなるようです。</p>\n<p>なお、PCをWi-Fi6接続に変更すると、6.8msとなり、2.2ms遅延が追加されます。</p>\n<h2 id=\"auひかりのホーム5ギガ、ホーム10ギガの違い\"><a href=\"#auひかりのホーム5ギガ、ホーム10ギガの違い\" class=\"headerlink\" title=\"auひかりのホーム5ギガ、ホーム10ギガの違い\"></a>auひかりのホーム5ギガ、ホーム10ギガの違い</h2><p>今回、HGWの交換によって若干のレイテンシ改善は確認できましたが、スループットとして大きく変わるような結果はありません。恐らく地域によって結果は大きく異なると思われます。なお、auひかりの場合は増速の際には事前の調査が必要なようで、混雑している地域だと10ギガへの変更が行えないとの事。ここ2、3年で1ギガを超える光回線の提供も随分浸透してきたと思われるので、時間帯によって帯域制限が加わっているような感覚をお持ちの方は一度確認されてはいかがでしょうか。</p>\n<h2 id=\"契約変更\"><a href=\"#契約変更\" class=\"headerlink\" title=\"契約変更\"></a>契約変更</h2><p>機器交換には3,300円必要とauのホームページには記載がありましたが、以下の案内が事後に郵送されてきました。3,300円の交換に加えて2,000円の交換手数料が掛かるがそれは無料ということなのか、そもそも3,300円ではなく2,000円になるのか、或いは都合良く解釈すれば機器交換は無料なのか。。。また、プロバイダがau one netで10ギガに増速した場合、12ヶ月の間、780円（税込858円）を割り引くとの事です。こちらも次月の請求がわかったところでアップデートしたいと思いますが、そもそもの最初の契約の仕方によって人それぞれで割引プランが異なるのかもしれませんね。<br>（私はプロバイダはau one netでどこのアフェリエイトも通さず、直接auひかりに申し込みしています）</p>\n<img src=\"/new-technology/2023/01/28/bl3000hm/au.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p>(2023-2-23更新）<br>1月の請求を確認しました。キャンペーンの月額割引は日割りもあり、ピッタリ一致していませんが、計算上は780円の割引になっていました。また、機器交換の請求は現時点でありませんでした。</p>\n<h2 id=\"補足\"><a href=\"#補足\" class=\"headerlink\" title=\"補足\"></a>補足</h2><p>新しいHGWを接続してから、しばらくしてIPv6アドレスが割り当てられていない事に気づきました。結局は翌日の昼頃に特にHGWを再起動したわけでもないですが、IPv6が割り当てられていました。環境変更後、少し時間が掛かるようです。</p>\n","categories":["Network","Hardware"],"tags":["10GbE"]},{"title":"XG Firewall v18でLAN内のホストをインターネットに公開する","url":"/new-technology/2020/04/11/dnat/","content":"<p class=\"onepoint\">この記事で実現すること</p>\nXG Firewall v18において、LAN内のホストをインターネットへ公開できます。また日本国内からのアクセスに限るなど、防御を高めます。\n\n<span id=\"more\"></span>\n\n<h2 id=\"今回の説明の環境について\"><a href=\"#今回の説明の環境について\" class=\"headerlink\" title=\"今回の説明の環境について\"></a>今回の説明の環境について</h2><p>インターネットから宅内の環境に対し、VPNを使わず直接アクセスするケースを説明します。ネットワークストレージ（NAS）へのアクセスやWebサーバーのコンテンツ公開を対象としています。この記事ではインターネット側にホームゲートウェイ、その内側にXG Firewallがあり、さらに内側にLANがある事を前提とします。XG Firewallでは、一般的なルーターと同じように内部のホストをインターネットに公開するためには設定が必要となります。一般的な用語でもありますが、Sophosでは、このような外から内へのパブリックIPとプライベートIPとの変換を伴う接続形態をDNAT（Destination NAT）と呼んでいます。</p>\n<img src=\"/new-technology/2020/04/11/dnat/XG.drawio.png\" class=\"\" title=\"alt\">\n\n<p>設定においては、上記の2つのサブネット（XGのWAN側、LAN側）があり、ホームゲートウェイ側からXGのWANインタフェースに対するポートフォワード、そしてXGからLAN内にあるホストへのポートフォワードとの2段階のポート転送が必要です。</p>\n<div class=\"note danger\"><p><span class=\"github-emoji\" alias=\"heavy_exclamation_mark\" style=\"\" fallback-src=\"https://github.githubassets.com/images/icons/emoji/unicode/2757.png?v8\">&amp;#x2757;</span>ご注意<span class=\"github-emoji\" alias=\"heavy_exclamation_mark\" style=\"\" fallback-src=\"https://github.githubassets.com/images/icons/emoji/unicode/2757.png?v8\">&amp;#x2757;</span></p>\n<p>この記事はあくまで技術的にホストを公開する方法について記述していますが、昨今のサイバー攻撃はランサムウェアが猛威を奮っています。個人が行うサイバー攻撃対策ではとうてい太刀打ちできませんので、リスクを認識の上で設定してください。なお、インターネットから自宅のリソースへのアクセスは2要素認証付きのVPNによる接続をお勧めします。「<a href=\"/new-technology/2020/03/28/vpn/\" title=\"XG Firewall VPNについて\">XG Firewall VPNについて</a>」の記事を参照してください。</p>\n</div>\n\n\n<h3 id=\"サーバーアクセスアシスタント\"><a href=\"#サーバーアクセスアシスタント\" class=\"headerlink\" title=\"サーバーアクセスアシスタント\"></a>サーバーアクセスアシスタント</h3><p>v18では、<mark class=\"label primary\">サーバーアクセスアシスタント</mark>というウィザード形式で設定できる仕組みが導入されています。もちろん、このウィザードを使わなくてもDNATの設定は可能ですが、今回はウィザードを利用し設定します。</p>\n<h2 id=\"ホスト公開設定\"><a href=\"#ホスト公開設定\" class=\"headerlink\" title=\"ホスト公開設定\"></a>ホスト公開設定</h2><p>一般的な設定例として、内部にあるWebサーバーのhttpsアクセス（Port443）をインターネットから接続するケースで説明します。<mark class=\"label primary\">パブリックIPのPort443</mark>→<mark class=\"label primary\">プライベートIPのPort443</mark>に着信させる実例です。</p>\n<h3 id=\"ホームゲートウェイの事前設定\"><a href=\"#ホームゲートウェイの事前設定\" class=\"headerlink\" title=\"ホームゲートウェイの事前設定\"></a>ホームゲートウェイの事前設定</h3><p>VPNの導入の記事でも書きましたが、まずはインターネットから内部のホストにデータを届けるためには、ホームゲートウェイとXGそれぞれに設定する必要があります。以下のように、ホームゲートウェイでPort443のトラフィックをXGのWAN側IPアドレスに転送します。</p>\n<img src=\"/new-technology/2020/04/11/dnat/rule6.png\" class=\"\" title=\"alt\">\n\n<p>この画面はホームゲートウェイの画面であり、契約しているインターネット回線業者により、提供される機器は異なりますのであくまで設定例という事で参考までに掲載しています。</p>\n<h3 id=\"サーバーアクセスアシスタントの設定\"><a href=\"#サーバーアクセスアシスタントの設定\" class=\"headerlink\" title=\"サーバーアクセスアシスタントの設定\"></a>サーバーアクセスアシスタントの設定</h3><p>サーバーアクセスアシスタントを使ったDNATを設定します。まずXGの左ペインメニューから、ルールとポリシーを選択します。ルールの上にある<mark class=\"label primary\">ファイアウォールルールの追加</mark>をクリックし、<mark class=\"label primary\">サーバーアクセスアシスタントDNAT</mark>をクリックします。そうすると以下のウィザード画面が表示されます。</p>\n<img src=\"/new-technology/2020/04/11/dnat/rule1.png\" class=\"\" title=\"alt\">\n\n<p>ここでは、LANに設置してある、公開したいサーバーのIPとそのホストの名前を入力します。ここで入力したホストの名前とIPアドレスの組みは自動的にXGのIPホストとして登録されます。今回のケースではWebサーバーとそのIPアドレスを入力しています。入力後、<mark class=\"label primary\">次へ</mark>をクリックします。</p>\n<p>2画面目では、以下のように公開したいパブリックIPアドレスを入力する画面となります。</p>\n<img src=\"/new-technology/2020/04/11/dnat/rule2.png\" class=\"\" title=\"alt\">\n<p>これはパブリックIPアドレスからプライベートIPへ変換するためのマッピング情報の元となるものです。但し、注意点として、ここでの構成はあくまでホームゲートウェイによってプライベートIPに変換された後のXGのWAN側IPアドレス（つまりプライベートIPアドレス）を入力する事になります。XGのWAN側インターフェースのIPアドレスである、<mark class=\"label primary\">#Port2</mark>を選択し、<mark class=\"label primary\">次へ</mark>をクリックします。</p>\n<p>3画面目では、内部に転送するサービスを選択します。Port443のHTTPSを選択しています。</p>\n<img src=\"/new-technology/2020/04/11/dnat/rule3.png\" class=\"\" title=\"alt\">\n\n<p>選択後、<mark class=\"label primary\">次へ</mark>をクリックします。<br>4画面目では、<mark class=\"label primary\">外部の送信元ネットワークとデバイス</mark>を選択します。</p>\n<img src=\"/new-technology/2020/04/11/dnat/rule4.png\" class=\"\" title=\"alt\">\n\n<p>表現が難しいのですが、WAN側のネットワークに制約を加える場合はここにネットワークの追加を行い、<mark class=\"label primary\">任意</mark>の設定を外す事になります。今回は、一旦はこのまま<mark class=\"label primary\">次へ</mark>をクリックします。</p>\n<p>5画面目では、これまで設定してきた内容の確認画面となります。画面の後半に<mark class=\"label primary\">NATルールを3つ作成します</mark>という記述があります。DNAT以外の2つは不要なので後から削除する事になりますが、これは後ほど説明します。</p>\n<img src=\"/new-technology/2020/04/11/dnat/rule5.png\" class=\"\" title=\"alt\">\n\n<mark class=\"label primary\">保存して完了する</mark>をクリックしてください。これで、DNATの設定が完了しました。<mark class=\"label primary\">ルールとポリシー</mark>では、作成されたルールは以下のようになっています。\n\n<img src=\"/new-technology/2020/04/11/dnat/rule7.png\" class=\"\" title=\"alt\">\n\n<mark class=\"label primary\">ファイアウォールルール</mark>の一番上に新しいルール<mark class=\"label primary\">DNAT to QNAPxxxx</mark>が追加されています。引き続き、<mark class=\"label primary\">NATルール</mark>を見てみます。以下のように3つのルールが作成され、1番上にDNATルールが表示されています。\n\n<img src=\"/new-technology/2020/04/11/dnat/rule8.png\" class=\"\" title=\"alt\">\n\n<p>これでひとまず設定は完了しています。これでインターネットから内部ホストへアクセス出来るようになりました。</p>\n<h2 id=\"DNSにプライベートIPを登録\"><a href=\"#DNSにプライベートIPを登録\" class=\"headerlink\" title=\"DNSにプライベートIPを登録\"></a>DNSにプライベートIPを登録</h2><p>さて、インターネットからパブリックIPを使って内部ホストへアクセス出来るようになりました。一般的にはダイナミックDNSなどを用いてURLでアクセスする事になります。しかし宅内のLAN環境に入り当該サーバーへ同じURLを使って接続する場合は、わざわざパブリックIPにする事はなく、直接LANのプライベートIPに対してアクセスする事になります。この場合は、XGのDNSでスタティックとしてプライベートIPを登録します。左ペインの<mark class=\"label primary\">ネットワーク</mark>から<mark class=\"label primary\">DNS</mark>を選び、<mark class=\"label primary\">DNSホストエントリ</mark>で、サーバーのURLとプライベートIPの組み合わせを登録してください。クライアントはXGのDHCPによってDNSがXG自身である事を指定されているため、当該ホストについてはプライベートIPでアクセス可能となります。</p>\n<h2 id=\"DNATのウィザードで作成されるルールの詳細\"><a href=\"#DNATのウィザードで作成されるルールの詳細\" class=\"headerlink\" title=\"DNATのウィザードで作成されるルールの詳細\"></a>DNATのウィザードで作成されるルールの詳細</h2><p>ウィザードでは、シンプルにまずは繋がる事を優先に最低限度の設定を行いました。まずDNATの理解を深めるために、ウィザードで作成されたファイアウォールルールのDNATについて見てみましょう。</p>\n<img src=\"/new-technology/2020/04/11/dnat/rule9.png\" class=\"\" title=\"alt\">\n\n<ul>\n<li><mark class=\"label primary\">送信元とゾーン</mark>は、WAN</li>\n<li><mark class=\"label primary\">宛先ゾーン</mark>は、LAN</li>\n<li><mark class=\"label primary\">サービス</mark>は、HTTPS</li>\n</ul>\n<p>以上のように、それなりに理解出来るものが記載されています。しかし理解が進まないのは、<mark class=\"label primary\">宛先ネットワーク</mark>の<mark class=\"label primary\">#Port2</mark>、つまりXGのWAN側IPアドレスが記述されている点です。宛先として直感ではLAN側のインタフェースである、<mark class=\"label primary\">#Port1</mark>のように感じます。まして、転送したいWebサーバーのホスト名が記載されている項目はここにはありません。実際のHTTPSのアクセスである、Webサーバーに転送するという項目は<mark class=\"label primary\">NATルール</mark>で記載されています。XG Firewll v18におけるDNATはポリシールールとNAT変換ルールはそれぞれ独立しているのです。</p>\n<ul>\n<li>Loopback NAT（不要）<br> これはヘアピンNATとも呼ばれますが、内部ネットワークからパブリックIPアドレスを用いて再び内部ネットワークにある公開サーバーへアクセスしたい場合に使います。XGがWANの外に出ていこうとするトラフィックを無理やり内部の公開サーバーに振り向ける動作です。前述したとおり内部のホストには、DNSに登録したプライベートIPでアクセスするので不要です。</li>\n<li>Reflexiv NAT（不要）<br> これは普通に内部ホストからWAN向けのNATを伴う変換ルールです。インストール直後のSNAT（ソースNAT　※送信元アドレスを書き換える一般的なNAT）のルールが最初から存在している事、「<a href=\"/new-technology/2020/03/14/rule-policy2/\" title=\"XG Firewall v18のルールを作成する\">XG Firewall v18のルールを作成する</a>」において、<mark class=\"label primary\">To Internet</mark>というSNATのルールを作成しているので改めての作成は不要です。</li>\n</ul>\n<h2 id=\"インターネットの接続可能な範囲を絞る\"><a href=\"#インターネットの接続可能な範囲を絞る\" class=\"headerlink\" title=\"インターネットの接続可能な範囲を絞る\"></a>インターネットの接続可能な範囲を絞る</h2><p>公開するホストが国内からのアクセス用途に限定できるならば、少しFirewallらしい設定を加えてみましょう。ウィザードの4画面目で、任意とした外部の送信元ネットワークを活用します。もし、このWebサーバに対して日本国内からのアクセスに限れば、海外からの攻撃を防ぐ事ができます。この場合は、作成済みのDNATルールの<mark class=\"label primary\">送信元ネットワークとデバイス</mark>の<mark class=\"label primary\">任意</mark>を外し、<mark class=\"label primary\">Japan</mark>を加えてください。</p>\n<h2 id=\"ご注意（2021-4-29追記）\"><a href=\"#ご注意（2021-4-29追記）\" class=\"headerlink\" title=\"ご注意（2021-4-29追記）\"></a>ご注意（2021-4-29追記）</h2><p>2021年4月22日より、NASのQNAPを対象としたランサムウェアによる被害が大きくなっています。アプリケーションの脆弱性を突かれ、ファイルがパスワード付き7z圧縮処理をされてしまい、暗号化解除にはbitcoinを要求されるというものです。特にNASはランサムウェアのターゲットになりやすい事、脆弱性を狙うため、2要素認証やFirewallなど一般的な管理策がいくらしっかりとしていても、それら管理策が回避されて被害を受けます。<br>NASに限らず、LAN内のホストをInternetに公開する事は現代においてはかなりリスクが大きい事ですので、情報資産の重要度などを鑑み、理解の上設定される事をお勧めします。</p>\n<p>特に有志がメンテナンスしているオープンソースをベースにプロダクトが構築されているものは悪意を持った人間がコントリビューター（貢献者）としてマルウェアを仕込むなど、人の善意を悪用するケースがあります。例えばPHPなどは多くの脆弱性が発見されており、メーカー側がその修正を取り込むまでの間に攻撃されるケースが多いように感じています。</p>\n<p>私も以前はいくつかのサービスを公開していましたが、昨今のサイバー攻撃の状況を鑑み、オンプレミスでのポート解放は一切行わず、外出先からは全てVPN（＋2要素認証）からのアクセスに変更しています。</p>\n<p>そういう意味ではこのブログもそうですが、読み手の安全性確保のため、GitHubに静的コンテンツとして提供しており、サイバー攻撃のリスクを可能な限り排除しています。情報資産の管理はクラウドかオンプレかは意見が別れるところでしょうが、個人における情報公開はクラウドが中心になりつつあると感じています。</p>\n","categories":["Security","ホスト公開"],"tags":["XG Firewall"]},{"title":"VMware vSphere Hypervisor（ESXi）の設定","url":"/new-technology/2020/03/01/esxi-conf/","content":"<p class=\"onepoint\">この記事で実現すること</p>\nXG Firewall v18をESXi 6.7上で稼働させるために、ホームゲートウェイの後ろに、XGを挟み込んだネットワーク構成を説明します。また、ESXi上で2枚のNICを利用し仮想スイッチの設定を行い、2枚のNICを持った仮想マシンを作成します。\n\n<span id=\"more\"></span>\n\n<h2 id=\"ネットワークの確認\"><a href=\"#ネットワークの確認\" class=\"headerlink\" title=\"ネットワークの確認\"></a>ネットワークの確認</h2><p>ESXiのWeb管理画面にログイン後、左ペインの”ネットワーク”をクリックし、”物理NIC”のタブをクリックすると、ESXiに認識されているNICの一覧がリストされます。</p>\n<img src=\"/new-technology/2020/03/01/esxi-conf/conf_esxi.png\" class=\"\" title=\"alt\">\n\n<p>1GbpsのNICであれば、ドライバーはne1000として認識されています。（環境にもより異なりますが）vmnic0、vmnic1という物理NICが2つ表示されている事を確認してください。</p>\n <div class=\"note danger\"><p> 　物理NICが1つしかない場合は、XG Firewallのセットアップはできません。</p>\n</div>\n\n<h2 id=\"仮想環境上のFirewall向け構成\"><a href=\"#仮想環境上のFirewall向け構成\" class=\"headerlink\" title=\"仮想環境上のFirewall向け構成\"></a>仮想環境上のFirewall向け構成</h2><p>ESXiにおけるネットワークの構成は、物理NICと仮想スイッチとの関係が重要です。以下の図のように、ESXiにおける物理NICはケーブルとして見立て、実際に仮想マシンが複数台存在する事を鑑み、ESXiの中にスイッチングハブが存在していると考えてください。</p>\n<img src=\"/new-technology/2020/03/01/esxi-conf/vswitch.drawio.png\" class=\"\" title=\"alt\">\n\n<p>※便宜上、一般的なホームユーザーの構成図としてLinuxの仮想マシンやWi-Fiアクセスポイント等を記載していますが、これまでのセットアップでは存在していません。また、XG Firewallのインストールに、LinuxやWi-Fiアクセスポイントは必要ありません。</p>\n<h3 id=\"セットアップ状況の確認\"><a href=\"#セットアップ状況の確認\" class=\"headerlink\" title=\"セットアップ状況の確認\"></a>セットアップ状況の確認</h3><p>ここまでのセットアップで、以下の構成になっています。</p>\n<ul>\n<li>物理NICであるvmnic0、vmnic1</li>\n<li>バーチャルスイッチのvSwitch0</li>\n<li>ネットワークポート（仮想IP）として、LAN側の管理用のManagement Networkおよびデフォルトで仮想マシンのために作成されているVM Network</li>\n</ul>\n<h3 id=\"WANの仮想スイッチの作成\"><a href=\"#WANの仮想スイッチの作成\" class=\"headerlink\" title=\"WANの仮想スイッチの作成\"></a>WANの仮想スイッチの作成</h3><img src=\"/new-technology/2020/03/01/esxi-conf/vswitch1.drawio.png\" class=\"\" title=\"alt\">\n\n<p>XGのWAN側インタフェースを担う仮想スイッチを追加します（赤字の部分）。</p>\n<ol>\n<li>ESXiの管理画面の左ペイン、ネットワークをクリック、続いて仮想スイッチのタブをクリックします。</li>\n<li>標準仮想スイッチの追加をクリックします。</li>\n<li>WAN側の仮想スイッチを作成するため、ここでは、vSwitch1と命名します。MTUは1500のままで構いません。</li>\n<li>“アップリンク1”は物理NICとの関連付けです。vmnic1などWAN側に使う予定の物理NICを選択してください。</li>\n</ol>\n<p>以下の通り、仮想スイッチの作成は完了です。</p>\n<img src=\"/new-technology/2020/03/01/esxi-conf/vswitch2.png\" class=\"\" title=\"alt\">\n\n<h3 id=\"ネットワークポートの作成\"><a href=\"#ネットワークポートの作成\" class=\"headerlink\" title=\"ネットワークポートの作成\"></a>ネットワークポートの作成</h3><ol>\n<li>vSwitch1をクリックし、物理NICのWAN向けである、vmnic1と関連付けられている事を確認してください。</li>\n<li>XGのLANとWANのネットワークポートを作成します。左ペインのネットワークからポートグループのタブをクリックし、ポートグループの追加を選択します。</li>\n<li>新規ポートグループとして、LANはここではXG-LANと命名し作成します。LANなので、vSwitch0を関連づけます。</li>\n<li>続いてWANのために、XG-WANと命名し、vSwitch1と関連づけます。</li>\n</ol>\n<p>これらの設定が終わり、LAN側のネットワーク構成は以下の通りとなります。</p>\n<img src=\"/new-technology/2020/03/01/esxi-conf/vswitch3.png\" class=\"\" title=\"alt\">\n\n<p>WAN側のネットワーク構成は以下の通りです。</p>\n<img src=\"/new-technology/2020/03/01/esxi-conf/vswitch4.png\" class=\"\" title=\"alt\">\n\n<p>これで、ESXiのネットワーク設定は完了となります。一旦PCのネットワークをホームゲートウェイに接続し、XG Firewallのモジュールをダウンロードしてください。</p>\n","categories":["Software"],"tags":["ESXi","XG Firewall"]},{"title":"VMware ESXiの仮想マシンをバックアップする","url":"/new-technology/2020/10/11/esxi-backup/","content":"<img src=\"/new-technology/2020/10/11/esxi-backup/backup.png\" class=\"\" title=\"alt\">\n\n<p class=\"onepoint\">この記事で実現すること</p>\n\n<p>無償版ESXi6.7（VMware vSphere Hypervisor6.7）にセットアップしたXG Firewallなどの仮想マシンをバックアップ、レストアします。</p>\n<span id=\"more\"></span>\n\n<h2 id=\"ESXiのバックアップソフトウェア\"><a href=\"#ESXiのバックアップソフトウェア\" class=\"headerlink\" title=\"ESXiのバックアップソフトウェア\"></a>ESXiのバックアップソフトウェア</h2><p>無償版ESXiの仮想マシン（VM)をバックアップするには以下の3つの選択肢があります。</p>\n<ol>\n<li>ghettoVCBバックアップスクリプト（この記事で説明しています）</li>\n<li>Nakivo Backup Free Edition<br> 「<a href=\"/new-technology/2021/03/06/esxi-nakivo/\" title=\"無償版ESXiの高度なバックアップ\">無償版ESXiの高度なバックアップ</a>」を参照してください。</li>\n<li>NASのアプリケーションによるバックアップ<br> このブログではQNAPのNASについて説明しています。「<a href=\"/new-technology/2021/12/04/qnap-hdp/\" title=\"無償版ESXiのVMをQNAP NASにバックアップ\">無償版ESXiのVMをQNAP NASにバックアップ</a>」を参照してください。</li>\n</ol>\n<h2 id=\"ghettoVCBでバックアップする\"><a href=\"#ghettoVCBでバックアップする\" class=\"headerlink\" title=\"ghettoVCBでバックアップする\"></a>ghettoVCBでバックアップする</h2><p>このブログで紹介している<strong>Sophos Firewall</strong>は、ESXi上にセットアップする事をお勧めしています。その理由としては仮想マシンは比較的バックアップが取得しやすく、万が一のトラブル発生時に速やかに復元（レストア）しやすい事が理由でもあります。もちろん、Sophos Firewallには設定ファイルをバックアップする機能が存在しますが、バージョンアップやデバイスの入れ替え等何らかのきっかけでうまく稼働しなくなるリスクがあります。Firewall自体がOSとして起動するため、バックアップソフトウェアをインストールできません。このghettoVCBはESXi上で動作させるコマンドラインのスクリプトですが、利用は難しくありません。</p>\n<h2 id=\"ESXiのスナップショット\"><a href=\"#ESXiのスナップショット\" class=\"headerlink\" title=\"ESXiのスナップショット\"></a>ESXiのスナップショット</h2><p>ESXiはスナップショットという機能を持っており、その時点の稼働状態について保存可能です。動画の一瞬を絵として切り取るという表現が適切でしょうか、これは一瞬で完了し、いつでもロールバックが可能です。複数の世代を持て使い勝手はとても良好です。ビジネスの世界では本番環境にパッチを当てる際などの最終確認フェーズで活用されます。つまり、万が一の時にはロールバックする事で速やかに以前の状態に戻す事が可能です。但し、このスナップショットを取ったまま長時間運用する事をVMWareは推奨していません。スナップショットを取得した後のメモリを含む稼働状況の差分をDiskに記録していく必要があり、これがパフォーマンスに悪影響を及ぼすためです。従い、スナップショットは恒久的なバックアップの役割にはなりません。</p>\n<h2 id=\"ghettoVCBについて\"><a href=\"#ghettoVCBについて\" class=\"headerlink\" title=\"ghettoVCBについて\"></a>ghettoVCBについて</h2><p>このghettoVCBはWilliam Lam氏が作成したMITライセンス（フリーソフト）のソフトウェアで、VMWareの正式な製品ではありません。但し、フリーのESXi向けにはデファクトスタンダードとも言えるスクリプトです。ソフトウェアはGitHub上にあります。以下のGitHubから<mark class=\"label primary\">Codeボタン</mark>→<mark class=\"label primary\">Download ZIP</mark>と進み、<mark class=\"label primary\">ghettoVCB-master.zip</mark>をダウンロードしてください。私はESXi6.7の環境で動作検証していますが、このブログを記載している途中の2020-10-10に”Adding support for ESXi 7.0 update 1”と更新が入りましたので、新しいESXiのバージョンにも積極的に対応されているようです。</p>\n<div class=\"link-grid\"><div class=\"link-grid-container\">\n<object class=\"link-grid-image\" data=\"602199.jpeg\"></object>\n<p>ghettoVCB</p><p>(https://github.com/lamw/ghettoVCB )The ghettoVCB script performs backups of virtual machines residing on ESX(i) 3.x, 4.x, 5.x & 6.x servers</p>\n<a href=\"https://github.com/lamw/ghettoVCB\"></a>\n</div></div>\n\n<blockquote>\n<p><a href=\"https://github.com/lamw/ghettoVCB\">https://github.com/lamw/ghettoVCB</a></p>\n</blockquote>\n<p>このghettoVCBは前述したスナップショットを活用し、システムを止める事なくスナップショットを取り、バックアップを行ってくれるため非常に便利です。またバックアップを複数世代持つ事が可能です。単一のファイルとしてバックアップされるため、非常に取り扱いがしやすいのも特徴です。</p>\n<p>ESXiをバックアップする製品はたくさん存在するのですが、基本はESXiの有償版が前提です。バックアップに使用されるvStorage APIは無償のESXi向けにはロックが掛かっており使えません。GUIによる製品も全く無いわけではありませんが、イチオシはghettoVCBになります。William Lam氏のホームページは以下を参照してください。</p>\n<blockquote>\n<p><a href=\"https://www.virtuallyghetto.com/\">https://www.virtuallyghetto.com</a></p>\n</blockquote>\n<h2 id=\"バックアップ先の準備\"><a href=\"#バックアップ先の準備\" class=\"headerlink\" title=\"バックアップ先の準備\"></a>バックアップ先の準備</h2><p>ESXi上のディスクにバックアップを取得し、作成されたファイルをESXiのデータストアブラウザからダウンロードしたり、SCPを使いPCなどにファイルコピーする事は最もシンプルな方法です。しかし、NASがあると非常に便利です。最近のNASはNFSによるファイル共有が使えるので、予めNASに設定したNFSドライブをESXiからマウントし、その領域にghettoVCBでバックアップを取得するのがお勧めです。QNAP・SynologyというNASの2大メーカーは、NFSおよびブロックベースのiSCSIにも対応しています。速度的にはNFSよりブロックベースのiSCSIの方が若干早いのとNAS上のVMFSフォーマットされたディスク上では複製した仮想マシンを立ち上げられます（ネットワーク越しとなるため遅いですが）。万が一のサルベージ（復旧作業）はNFSやファイルベースのiSCSIの方がNASからファイルを確認できる事、NFSは特に扱いがシンプルなため、まずはNFSのファイル共有がお勧めです。なお、ESXiに別のディスクを接続しバックアップを取得する場合は以下のNFSの設定については不要です。</p>\n<h3 id=\"NAS上でのNFSの設定\"><a href=\"#NAS上でのNFSの設定\" class=\"headerlink\" title=\"NAS上でのNFSの設定\"></a>NAS上でのNFSの設定</h3><p>まず、ESXiでサポートされるNFSのバージョンは3および4となります。v3はシンプルにクライアントのIPアドレスで認証し、v4はIPアドレスに加えユーザー単位の認証が可能です。</p>\n<p>ここではQNAPを実例に設定を記載します。</p>\n<ol>\n<li><mark class=\"label primary\">コントロールパネル</mark>から、<mark class=\"label primary\">ネットワークサービスとファイルサービス</mark>を選択し、NFSv3またはNFSv4を有効にします。\n<img src=\"/new-technology/2020/10/11/esxi-backup/qnap1.png\" class=\"\" title=\"alt\"></li>\n</ol>\n<h4 id=\"NFSv3の場合\"><a href=\"#NFSv3の場合\" class=\"headerlink\" title=\"NFSv3の場合\"></a>NFSv3の場合</h4><ol>\n<li>バックアップを取得する共有フォルダを作成します。<mark class=\"label primary\">コントロールパネル</mark>の、<mark class=\"label primary\">権限設定</mark>でバックアップを取得する共有フォルダを選択し、共有フォルダの権限画面を設定します<img src=\"/new-technology/2020/10/11/esxi-backup/qnap2.png\" class=\"\" title=\"alt\"></li>\n<li>NFSについて設定します。ユーザーはguest扱いで接続します。<img src=\"/new-technology/2020/10/11/esxi-backup/qnap3.png\" class=\"\" title=\"alt\"></li>\n</ol>\n<h4 id=\"NFSv4の場合\"><a href=\"#NFSv4の場合\" class=\"headerlink\" title=\"NFSv4の場合\"></a>NFSv4の場合</h4><ol>\n<li>認証するバックアップ専用のユーザー（一般ユーザー）を作成します。</li>\n<li>バックアップを取得する共有フォルダを作成し、管理者とバックアップ専用ユーザーにアクセス権を付与します。<mark class=\"label primary\">コントロールパネル</mark>の、<mark class=\"label primary\">権限設定</mark>でバックアップを取得する共有フォルダを選択し、共有フォルダの権限を設定します。<img src=\"/new-technology/2020/10/11/esxi-backup/qnap2.png\" class=\"\" title=\"alt\"></li>\n</ol>\n<p> ここでは、bkupという一般ユーザーでbackupという共有フォルダのアクセス権を設定しています。bkupユーザーはこのbackupフォルダのみにアクセス権を与えており、他のフォルダにはアクセスしない設定にします。</p>\n<ol start=\"3\">\n<li>NFSv4ではESXiのrootで接続された場合を含め、権限を一般ユーザーに格下げする、Squashオプションに”ALL_SQUASH”を設定します。<img src=\"/new-technology/2020/10/11/esxi-backup/qnap4.png\" class=\"\" title=\"alt\"></li>\n</ol>\n<p> QNAP以外のNASでも若干設定内容は異なりますが、大きく違いはありません。</p>\n<div class=\"note info\"><p>NASのセキュリティ強化のため、NFSv4で新規作成したユーザーに対し、NFS以外のNASアクセス権の解除およびWebサービスのログイン時に2要素認証を必須（通常Webサービスにログインしないので実質無効化）とする設定をお勧めします。</p>\n</div>\n\n<h2 id=\"ESXiからNFSサーバーに接続する\"><a href=\"#ESXiからNFSサーバーに接続する\" class=\"headerlink\" title=\"ESXiからNFSサーバーに接続する\"></a>ESXiからNFSサーバーに接続する</h2><p>ESXi側からNFSでファイルをマウントするのは簡単です。ESXiの左ペインメニューの<mark class=\"label primary\">ストレージ</mark>から、<mark class=\"label primary\">新しいデータストア</mark>を選択します。次に<mark class=\"label primary\">NFSデータストアのマウント</mark>を選びます。以下のダイアログが表示されますので、ESXiで使うボリューム名を決め、NFSサーバーのIPアドレス、マウント名、NFSv4であればユーザーIDとパスワードを入力します。NFSv3の場合は、ユーザーIDとパスワードを入力する場所はありません。</p>\n<img src=\"/new-technology/2020/10/11/esxi-backup/esxi1.png\" class=\"\" title=\"alt\">\n\n<p>これで、ESXiでは、”&#x2F;vmfs&#x2F;volumes&#x2F;NFSデータストア名”としてnfsサーバーのフォルダがマウントされます。nfsサーバーを”¥¥YourNAS”、ESXiのデータストア名を”your-nfs”とするならば、¥¥YourNAS¥backup¥の中身が&#x2F;vmfs&#x2F;volumes&#x2F;your-nfs&#x2F;に対応します。</p>\n<h2 id=\"ESXiでの事前準備\"><a href=\"#ESXiでの事前準備\" class=\"headerlink\" title=\"ESXiでの事前準備\"></a>ESXiでの事前準備</h2><ol>\n<li>ESXiにSSHで接続する必要があるため、ESXiの左ペインメニューの<mark class=\"label primary\">ホスト→管理</mark>から<mark class=\"label primary\">サービス</mark>タブをクリックし、<mark class=\"label primary\">TSM</mark>および<mark class=\"label primary\">TSM-SSH</mark>を起動します。</li>\n<li>ESXiのストレージ、nfsボリュームを選択し、データストアブラウザを開きます。アップロードボタンをクリックし、ダウンロード済みの<mark class=\"label primary\">ghettoVCB-master.zip</mark>をアップロードします。</li>\n</ol>\n<h3 id=\"ghettoVCBの展開\"><a href=\"#ghettoVCBの展開\" class=\"headerlink\" title=\"ghettoVCBの展開\"></a>ghettoVCBの展開</h3><p>sshクライアントから、rootユーザーでESXiに接続し、ghettoVCBのzipを展開します。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">The ESXi Shell can be disabled by an administrative user. See the</span><br><span class=\"line\">vSphere Security documentation <span class=\"keyword\">for</span> more information.</span><br><span class=\"line\">[root@esxi:~] <span class=\"built_in\">cd</span> /vmfs/volumes/your-nfs/</span><br><span class=\"line\">[root@esxi:/vmfs/volumes/your-nfs] <span class=\"built_in\">ls</span></span><br><span class=\"line\">ghettoVCB-master.zip</span><br><span class=\"line\">[root@esxi:/vmfs/volumes/your-nfs] unzip ghettoVCB-master.zip</span><br><span class=\"line\">Archive:  ghettoVCB-master.zip</span><br><span class=\"line\">   creating: ghettoVCB-master/</span><br><span class=\"line\">  inflating: ghettoVCB-master/README.md</span><br><span class=\"line\">  inflating: ghettoVCB-master/ghettoVCB-restore.sh</span><br><span class=\"line\">  inflating: ghettoVCB-master/ghettoVCB-restore_vm_restore_configuration_template</span><br><span class=\"line\">  inflating: ghettoVCB-master/ghettoVCB-vm_backup_configuration_template</span><br><span class=\"line\">  inflating: ghettoVCB-master/ghettoVCB.conf</span><br><span class=\"line\">  inflating: ghettoVCB-master/ghettoVCB.sh</span><br><span class=\"line\">  inflating: ghettoVCB-master/vghetto-ghettoVCB-offline-bundle.zip</span><br><span class=\"line\">  inflating: ghettoVCB-master/vghetto-ghettoVCB.vib</span><br><span class=\"line\">[root@esxi:/vmfs/volumes/your-nfs]</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"バックアップする\"><a href=\"#バックアップする\" class=\"headerlink\" title=\"バックアップする\"></a>バックアップする</h2><h3 id=\"バックアップの設定\"><a href=\"#バックアップの設定\" class=\"headerlink\" title=\"バックアップの設定\"></a>バックアップの設定</h3><p>バックアップを行う本体は、<mark class=\"label primary\">ghettoVCB.sh</mark>です。新しく作成されたghettoVCB-masterフォルダに移動し、ghettoVCB.shをviで開きます。このスクリプトで変更すべき箇所は最低1箇所で、15行目の<code>VM_BACKUP_VOLUME</code>でバックアップを保存するパスを指定します。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Author: William Lam</span></span><br><span class=\"line\"><span class=\"comment\"># Created Date: 11/17/2008</span></span><br><span class=\"line\"><span class=\"comment\"># http://www.virtuallyghetto.com/</span></span><br><span class=\"line\"><span class=\"comment\"># https://github.com/lamw/ghettoVCB</span></span><br><span class=\"line\"><span class=\"comment\"># http://communities.vmware.com/docs/DOC-8760</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">##################################################################</span></span><br><span class=\"line\"><span class=\"comment\">#                   User Definable Parameters</span></span><br><span class=\"line\"><span class=\"comment\">##################################################################</span></span><br><span class=\"line\"></span><br><span class=\"line\">LAST_MODIFIED_DATE=2020_10_10</span><br><span class=\"line\">VERSION=4</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># directory that all VM backups should go (e.g. /vmfs/volumes/SAN_LUN1/mybackupdir)</span></span><br><span class=\"line\">VM_BACKUP_VOLUME=/vmfs/volumes/your-nfs/backups</span><br></pre></td></tr></table></figure>\n\n<p>上記で指定した”backups”フォルダを作成します。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@esxi:/vmfs/volumes/your-nfs] <span class=\"built_in\">mkdir</span> backups</span><br><span class=\"line\">[root@esxi:/vmfs/volumes/your-nfs]</span><br></pre></td></tr></table></figure>\n\n<p>さらに、バックアップ対象となるvmのListを作成します。1行1ホストとなります。XGFirewall、Win10という仮想マシンが2つ存在しそれをバックアップするのであれば、以下のようにghettoVCB-masterフォルダでvmlist.txtなどの名前で仮想マシンの一覧を作成します。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@esxi:/vmfs/volumes/your-nfs/ghettoVCB-master] vi vmlist.txt</span><br><span class=\"line\"></span><br><span class=\"line\">XGFirewall</span><br><span class=\"line\">Win10</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"バックアップの実行\"><a href=\"#バックアップの実行\" class=\"headerlink\" title=\"バックアップの実行\"></a>バックアップの実行</h3><p>ghettoVCB-masterフォルダから以下のコマンドでバックアップが取得できます。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@esxi:/vmfs/volumes/your-nfs/ghettoVCB-master] /bin/sh ./ghettoVCB.sh -f ./vmlist.txt</span><br></pre></td></tr></table></figure>\n\n<p>私の環境での実行結果（一部ホスト名などは書き換えています）は以下の通りです。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">2020-10-10 13:29:17 -- info: Initiate backup <span class=\"keyword\">for</span> XGFirewall</span><br><span class=\"line\">2020-10-10 13:29:17 -- info: Creating Snapshot <span class=\"string\">&quot;ghettoVCB-snapshot-2020-10-10&quot;</span> <span class=\"keyword\">for</span> XGFirewall</span><br><span class=\"line\">Option --adaptertype is deprecated and hence will be ignored</span><br><span class=\"line\">Destination disk format: VMFS thin-provisioned</span><br><span class=\"line\">Cloning disk <span class=\"string\">&#x27;/vmfs/volumes/datastore1/XGFirewall/XGFirewall/XGFirewall-0.vmdk&#x27;</span>...</span><br><span class=\"line\">Clone: 100% <span class=\"keyword\">done</span>.</span><br><span class=\"line\">2020-10-10 13:30:59 -- info: Removing snapshot from XGFirewall ...</span><br><span class=\"line\">2020-10-10 13:31:00 -- info: Slept 1 seconds to work around NFS I/O error</span><br><span class=\"line\">2020-10-10 13:31:00 -- info: Backup Duration: 1.72 Minutes</span><br><span class=\"line\">2020-10-10 13:31:00 -- info: Successfully completed backup <span class=\"keyword\">for</span> XGFirewall!</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"バックアップ結果の確認\"><a href=\"#バックアップ結果の確認\" class=\"headerlink\" title=\"バックアップ結果の確認\"></a>バックアップ結果の確認</h3><p>実際にバックアップが作成されたフォルダを確認すると以下のようになっています。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@esxi:/vmfs/volumes/your-nfs/backups/XGFirewall/XGFirewall-2020-10-10_13-29-16] <span class=\"built_in\">ls</span> -al</span><br><span class=\"line\">total 29407336</span><br><span class=\"line\">drwxr-xr-x    2 root     root          4096 Oct 10 13:30 .</span><br><span class=\"line\">drwxr-xr-x    5 root     root          4096 Oct 10 13:30 ..</span><br><span class=\"line\">-rw-r--r--    1 root     root            30 Oct 10 13:30 STATUS.ok</span><br><span class=\"line\">-rw-------    1 root     root       2621952 Oct 10 13:30 XGFirewall-0-ctk.vmdk</span><br><span class=\"line\">-rw-------    1 root     root     42949672960 Oct 10 13:30 XGFirewall-0-flat.vmdk</span><br><span class=\"line\">-rw-------    1 root     root           612 Oct 10 13:30 XGFirewall-0.vmdk</span><br><span class=\"line\">-rwxr-xr-x    1 root     root          3712 Oct 10 13:29 XGFirewall.vmx</span><br></pre></td></tr></table></figure>\n\n<p>環境によってファイル名は少し異なります。仮想マシンは、-flat.vmdkが本体です。私の場合は、別のバックアップソフトで差分バックアップを有効にしているため別にファイル名が”-ctk.vmdk”というものもあります。これはvSphereの機能であるCBT（Changed Block Tracking）を用いて更新のあったブロックのみを差分バックアップする機能で、これを使うとvmdkが2つ作成されます。このCBTはghettoVCBには無関係ですが混乱を避けるために参考までに記載しました。</p>\n<p>ファイルのサイズを確認すると、<code>XGFirewall-0-flat.vmdk</code>は40GByteとなっています。これはそもそもの仮想マシンを作成した時に設定したサイズが示されています。ghettoVCBはデフォルトのthinモードでバックアップするため、thickで構成された仮想マシンよりは実際の消費されているディスク量は小さく済みます。実際に消費されたディスクは以下の通り確認できます。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@esxi:/vmfs/volumes/your-nfs/backups/XGFirewall/XGFirewall-2020-10-10_13-29-16] <span class=\"built_in\">du</span> -h</span><br><span class=\"line\">28.0G\t.</span><br></pre></td></tr></table></figure>\n\n<p>つまり、シンプロビジョニング（通称シンプロ）はこうやってディスク領域を節約する仕組みになっているわけです。</p>\n<p>私の環境ではNFSサーバーはQNAPのTVS473eというモデルでウェスタンデジタル社のHDDを4台RAID10で使っており、NICはAquantia AQC107です。ESXi側のNICはintel X550T2で、共に10GbpsのNICです。XGの仮想マシン（28GByte）をバックアップするのに1分40秒ですのでまずまずの速度でしょうか。参考までに、殆どアプリの入っていないWin10だと、4分20秒程度でした。<br>デフォルトでは3世代バックアップを取得するようになっていますが、その他カスタマイズする箇所については、英語版の<strong>公式マニュアル</strong>を参照してください。</p>\n<blockquote>\n<p>vmware -ghettoVCB.sh - Free alternative for backing up VM’s for ESX(i) 3.5, 4.x, 5.x, 6.x &amp; 7.x-<br> <a href=\"https://communities.vmware.com/docs/DOC-8760\">https://communities.vmware.com/docs/DOC-8760</a></p>\n</blockquote>\n<h2 id=\"ESXiのちょっと特殊な点\"><a href=\"#ESXiのちょっと特殊な点\" class=\"headerlink\" title=\"ESXiのちょっと特殊な点\"></a>ESXiのちょっと特殊な点</h2><p>このシェルを実行する時に、頭に<code>/bin/sh</code>を加えました。単体でghettoVCB.shを実行すると<code>-sh: ./ghettoVCB.sh: Operation not permitted</code>と実行できません。ghettoVCB.shには、実行権も最初から付与されています。スクリプトの先頭にShebang（#!&#x2F;bin&#x2F;sh）が無いのでそれが原因かと思い加えても動作しません。これは、ESXiがUEFIのセキュアブートだとこのような挙動になるようです。スクリプトでバックアップができるようになると、Cronに登録して定期的に実行したくなりますが、改ざん防止のためそれも不可能なようです。ESXiのセキュアブートをしないように変更すれば可能ですが、XGを載せたFirewallの役割から考えると非常に悩ましいところです。冒頭に前述した無償ソフトウェアについての記事「<a href=\"/new-technology/2021/03/06/esxi-nakivo/\" title=\"無償版ESXiの高度なバックアップ\">無償版ESXiの高度なバックアップ</a>」や「<a href=\"/new-technology/2021/12/04/qnap-hdp/\" title=\"無償版ESXiのVMをQNAP NASにバックアップ\">無償版ESXiのVMをQNAP NASにバックアップ</a>」を参照してください。</p>\n<h2 id=\"レストアする\"><a href=\"#レストアする\" class=\"headerlink\" title=\"レストアする\"></a>レストアする</h2><p>さて、バックアップから戻す場合です。ESXiのハードウェア毎故障してしまってもバックアップがあれば安全です。戻し方には2つあります。</p>\n<ol>\n<li>バックアップを取得した仮想マシンと同じ場所に戻す</li>\n<li>バックアップを取得した仮想マシンの情報で、新しい仮想マシンを作成する</li>\n</ol>\n<p>1の方法は元の仮想マシンを一旦ESXiメニューから削除してから同じフォルダを再作成して復旧するので比較的単純です。2の方法は重複して作成する事になるため、そのままだとネットワーク周りの環境が重複し、MACアドレスなど別の構成にしてレストアする事になります。より慎重な人は別の仮想マシンとして起動する事を確認してから元の仮想環境を削除する方法を選びたいのではないでしょうか。今回は少し手間が掛かりますが、上記でバックアップされたXGFirewallを新しい仮想マシンとして復元する方法について記載します。</p>\n<h3 id=\"レストアの設定\"><a href=\"#レストアの設定\" class=\"headerlink\" title=\"レストアの設定\"></a>レストアの設定</h3><p>通常仮想マシンが稼働しているvmfsフォーマットのフォルダを確認します。通常は<code>/vmfs/volumes/datastore1</code>ですが、ここでは、｀&#x2F;vmfs&#x2F;volumes&#x2F;your-datastore&#x2F;&#96;とします。</p>\n<p>バックアップしたXGFirewallを新しい仮想マシンをレストアする場所として、datastore配下に”XGFW18”フォルダを作成します。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@esxi:/vmfs/volumes/your-datastore] <span class=\"built_in\">mkdir</span> XGFW18</span><br><span class=\"line\">[root@esxi:/vmfs/volumes/your-datastore]</span><br></pre></td></tr></table></figure>\n\n<p>次に、ghettoVCBフォルダに移動し、レストア設定ファイルを新規作成します。以下の通り、バックアップしたファイル、戻し先と仮想マシンのディスクフォーマット（ここではデフォルトのzeroedthick”1”を指定）、仮想マシンの名称を記述します。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@esxi:/vmfs/volumes/your-nfs/ghettoVCB-master] vi vm_restore_list.txt</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># DISK_FORMATS</span></span><br><span class=\"line\"><span class=\"comment\"># 1 = zeroedthick</span></span><br><span class=\"line\"><span class=\"comment\"># 2 = 2gbsparse</span></span><br><span class=\"line\"><span class=\"comment\"># 3 = thin</span></span><br><span class=\"line\"><span class=\"comment\"># 4 = eagerzeroedthick</span></span><br><span class=\"line\"><span class=\"comment\"># e.g.</span></span><br><span class=\"line\"><span class=\"string\">&quot;/vmfs/volumes/your-nfs/backups/XGFirewll/XGFirewall-2020-10-10_13-29-16;/vmfs/volumes/your-datastore/XGFW18;1;XGFW18&quot;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"レストアの実行\"><a href=\"#レストアの実行\" class=\"headerlink\" title=\"レストアの実行\"></a>レストアの実行</h3><p>ghettoVCB-masterフォルダから以下のコマンドでレストアを実行します。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@esxi:/vmfs/volumes/your-nfs/ghettoVCB-master] /bin/sh ./ghettoVCB-restore.sh -c ./vm_restore_list.txt</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"レストア結果の確認\"><a href=\"#レストア結果の確認\" class=\"headerlink\" title=\"レストア結果の確認\"></a>レストア結果の確認</h3><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">################## Restoring VM: XGFW18  #####################</span></span><br><span class=\"line\">Start time: Sun Oct 11 04:14:58 UTC 2020</span><br><span class=\"line\">Restoring VM from: <span class=\"string\">&quot;/vmfs/volumes/your-nfs/backups/XGFirewall/XGFirewall-2020-10-10_13-29-16&quot;</span></span><br><span class=\"line\">Restoring VM to Datastore: <span class=\"string\">&quot;/vmfs/volumes/your-datastore/XGFW18&quot;</span> using Disk Format: <span class=\"string\">&quot;zeroedthick&quot;</span></span><br><span class=\"line\">Creating VM directory: <span class=\"string\">&quot;/vmfs/volumes/your-datastore/XGFW18/XGFW18&quot;</span> ...</span><br><span class=\"line\">Copying <span class=\"string\">&quot;XGFW.vmx&quot;</span> file ...</span><br><span class=\"line\">Restoring VM<span class=\"string\">&#x27;s VMDK(s) ...</span></span><br><span class=\"line\"><span class=\"string\">Updating VMDK entry in &quot;XGFW18.vmx&quot; file ...</span></span><br><span class=\"line\"><span class=\"string\">Option --adaptertype is deprecated and hence will be ignored</span></span><br><span class=\"line\"><span class=\"string\">Destination disk format: VMFS zeroedthick</span></span><br><span class=\"line\"><span class=\"string\">Cloning disk &#x27;</span>/vmfs/volumes/your-nfs/backups/XGFirewall/XGFW-2020-10-10_13-29-16/XGFirewall-0.vmdk<span class=\"string\">&#x27;...</span></span><br><span class=\"line\"><span class=\"string\">Clone: 100% done.</span></span><br><span class=\"line\"><span class=\"string\">Registering XGFW18 ...</span></span><br><span class=\"line\"><span class=\"string\">10</span></span><br><span class=\"line\"><span class=\"string\">End time: Sun Oct 11 04:26:17 UTC 2020</span></span><br><span class=\"line\"><span class=\"string\">################## Completed restore for XGFW18! #####################</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">Start time: Sun Oct 11 04:14:58 UTC 2020</span></span><br><span class=\"line\"><span class=\"string\">End   time: Sun Oct 11 04:26:17 UTC 2020</span></span><br><span class=\"line\"><span class=\"string\">Duration  : 11.32 Minutes</span></span><br></pre></td></tr></table></figure>\n\n<p>これでESXiのメニューを確認すると既に左ペインの仮想マシンに新しくレストアした”XGFW18”がインベントリ登録まで完了し停止状態となっています。すぐに起動といきたいところですが、今稼働中のXGとIPアドレスなど全てが重複しますので、事前に修正する箇所があります。</p>\n<img src=\"/new-technology/2020/10/11/esxi-backup/esxi2.png\" class=\"\" title=\"alt\">\n\n<ol>\n<li>ネットワーク部分ですが、ESXiの左ペインのネットワークから新しいポートグループをLANとWANとの2つ作成し、それぞれ物理NICのvmnicと関連付けます。</li>\n<li>ネットワークアダプタ1（LAN）、2（WAN）とも新しいポートグループに置き換えます。</li>\n<li>既存のXGが起動中の場合は、IPアドレスが重複する事、そもそも1つのライセンスで複数起動は認められていませんので、停止します。</li>\n<li>既存のXGが停止してから、新しいXGFW18を起動します。初回起動時には以下のダイアログが表示されますので、<mark class=\"label primary\">コピーしました</mark>を選択し<mark class=\"label primary\">回答</mark>します。バックアップした仮想マシンを既に削除している場合は、<mark class=\"label primary\">移動しました</mark>を選択します。</li>\n</ol>\n<img src=\"/new-technology/2020/10/11/esxi-backup/esxi3.png\" class=\"\" title=\"alt\">\n\n<p>これでバックアップされたXGが復元されました。ただし前述した通り、MACアドレスが初期化されていますので、ホームゲートウェイから割り当てられたIPアドレスが変わっています。また、LANで利用しているL2スイッチでMACアドレスフィルタなどACLを使っている場合も通信できなくなりますので、ご注意ください。<br>レストアの処理時間は11分20秒と少し時間が掛かるようですが、頻繁に行う作業ではないため、許容範囲ではないでしょうか。</p>\n<div class=\"note warning\"><p>復元された新しいXGをメインとして利用していく場合は、古い仮想マシンについて自動起動をオフにし、同時起動しないようにご注意ください。</p>\n</div>\n\n<p>レストアに関する詳細は、<strong>公式マニュアル</strong>を参照してください。</p>\n<blockquote>\n<p>vmware -Ghetto Tech Preview - ghettoVCB-restore.sh - Restoring VM’s backed up from ghettoVCB to ESX(i) 3.5, 4.x &amp; 5.x-<br> <a href=\"https://communities.vmware.com/docs/DOC-10595\">https://communities.vmware.com/docs/DOC-10595</a></p>\n</blockquote>\n","categories":["Software"],"tags":["ESXi","XG Firewall"]},{"title":"ESXi(無償版)のセキュリティを高める","url":"/new-technology/2021/01/23/esxi-security/","content":"<img src=\"/new-technology/2021/01/23/esxi-security/vmware.png\" class=\"\" title=\"alt\">\n\n<p class=\"onepoint\">この記事で実現すること</p>\n\n<p>VMwareから、”vSphereのセキュリティ”として、<strong>ESXi7版</strong>のドキュメンテーションがあります。350ページと膨大な量になります。この情報のうち大半はビジネスで利用するvCenter Serverを中心としたセキュリティ維持のための記載になりますが、個人向けESXiにポイントを絞り、どのようにセキュリティを高めるか確認していきます。</p>\n<blockquote>\n<p>vSphereのセキュリティ ESXi7.0<br> <a href=\"https://docs.vmware.com/jp/VMware-vSphere/7.0/vsphere-esxi-vcenter-server-70-security-guide.pdf\">https://docs.vmware.com/jp/VMware-vSphere/7.0/vsphere-esxi-vcenter-server-70-security-guide.pdf</a></p>\n</blockquote>\n<span id=\"more\"></span>\n\n<h2 id=\"ホームユーザーとしての無償版ESXiのセキュリティ\"><a href=\"#ホームユーザーとしての無償版ESXiのセキュリティ\" class=\"headerlink\" title=\"ホームユーザーとしての無償版ESXiのセキュリティ\"></a>ホームユーザーとしての無償版ESXiのセキュリティ</h2><p>まずは情報セキュリティのポイントである機密性、完全性、可用性について確認していきます。可用性についてはバックアップとして「<a href=\"/new-technology/2020/10/11/esxi-backup/\" title=\"VMware ESXiの仮想マシンをバックアップする\">VMware ESXiの仮想マシンをバックアップする</a>」の記事を紹介しています。完全性として不具合に対応するパッチの適用については「<a href=\"/new-technology/2020/06/14/esxi67-patch/\" title=\"VMware ESXiにパッチを適用する\">VMware ESXiにパッチを適用する</a>」で記載しています。残るは機密性です。物理的セキュリティ（つまり盗難対策など）はここでは割愛し、ESXiにおける機密性の設定内容について記載します。</p>\n<p>前述したドキュメントを眺めると正直ビジネス向けプロダクトと個人向けとの説明が混在していて理解が難しいです。個人向けESXiでは以下は使えません。</p>\n<ul>\n<li>vCenter Server</li>\n<li>vShpere Client(Windowsで稼働させるクライアント。6.5から使えません）</li>\n<li>Host Client</li>\n<li>vShpere Client(HTML5)</li>\n</ul>\n<p>クライアント周りが非常にややこしい事になっていますが、無償版ESXiではvSphere Web ClientおよびESXi Shell（SSH）のみ利用可能です。実はこれだけに機能を絞るとあまり与えられた選択肢はありません。</p>\n<h2 id=\"無償版ESXiで設定可能な項目\"><a href=\"#無償版ESXiで設定可能な項目\" class=\"headerlink\" title=\"無償版ESXiで設定可能な項目\"></a>無償版ESXiで設定可能な項目</h2><p>上記ドキュメント全体を通して、設定可能な機密性に関する項目は以下の通りです。</p>\n<ul>\n<li>ESXiに接続可能なIPを絞る</li>\n<li>SSHの起動、停止の実行</li>\n<li>SSHでログインし各種アクセスログの確認をする</li>\n<li>syslogで外部syslogサーバーにログを転送する</li>\n<li>SSHで公開鍵認証を行う（必要であれば）</li>\n</ul>\n<p>ここではv6.7のドキュメントを引用しながら設定方法について説明していきます。</p>\n<h2 id=\"全般的な説明\"><a href=\"#全般的な説明\" class=\"headerlink\" title=\"全般的な説明\"></a>全般的な説明</h2><p>個々の設定に入る前に全体的な考え方について説明します。P41からの「ESXiのセキュリティに関する一般的推奨事項」を引用します。</p>\n<ul>\n<li>ESXi ShellおよびSSHはデフォルトで無効になっています。<br>デフォルトでは、限られた数のファイアウォール ポートのみが開いています。特定のサービスに関連付けられている追加のファイアウォール ポートを明示的に開くことができます。</li>\n<li>ESXiは、その機能の管理に不可欠なサービスのみを実行します。ESXiの実行に必要な機能しか配布できません。</li>\n<li>デフォルトでは、ホストを管理するために必要でないポートは、すべて閉じられています。追加のサービスが必要な場合は、ポートを開きます。</li>\n<li>デフォルトでは、強度の低い暗号は無効になっており、クライアントからの通信はSSLで保護されます。チャネルの保護に使用するアルゴリズムは、SSLハンドシェイクによって異なります。ESXiで作成されたデフォルトの証明書は、署名アルゴリズムとして、RSA暗号化のPKCS#1 SHA-256を使用します。</li>\n<li>Webクライアントによるアクセスをサポートするため、内部ではESXiによってTomcat Webサービスが使用されています。このサービスは、管理と監視のためにWebクライアントで必要な機能のみを実行するように修正されています。そのため、ESXiは、さまざまな使用環境で報告されているTomcatのセキュリティ問題による脆弱性に対応できます。</li>\n<li>VMwareは、ESXiのセキュリティに影響する恐れのあるすべてのセキュリティ警告を監視し、必要に応じてセキュリティパッチを発行します。<br>FTPやTelnetなどのセキュリティ保護されていないサービスはインストールされません。これらのサービス用のポートはデフォルトで閉じられています。SSHやSFTPなど、よりセキュアなサービスを容易に使用できるため、これらの安全性の高いサービスを選択し、セキュリティ保護されていないサービスの使用は避けるようにしてください。たとえば、SSHを使用できずTelnetを使用する必要がある場合、SSLを使用したTelnetを使用し て仮想シリアル ポートにアクセスします。</li>\n<li>セキュリティ保護されていないサービスを使用する必要があり、ホストに十分な保護を実装している場合は、明示的にポートを開くことで対応できます。</li>\n<li>ESXiシステムでUEFIセキュア ブートを使用することを検討します。「ESXiホストのUEFIセキュア ブート」を参照してください。</li>\n</ul>\n<h3 id=\"ESXiに接続可能なIPを絞る\"><a href=\"#ESXiに接続可能なIPを絞る\" class=\"headerlink\" title=\"ESXiに接続可能なIPを絞る\"></a>ESXiに接続可能なIPを絞る</h3><p>この機能はESXiではFirewallと呼ばれ、Linuxのiptablesやufwと同様にシンプルなものです。ホームユーザーはシンプルなLANで閉じられたアクセスですが、安全のために設定を検討すべきです。<br>P72に「ESXiファイアウォール設定の管理」があります。”「構成」をクリックし”と解説がありますが、いきなり見つけられません。実際にはWeb管理画面の左ペインメニューの <mark class=\"label primary\">ネットワーク</mark>を選択し、<mark class=\"label primary\">ファイアウォール</mark>タブをクリックして見つける事ができます。デフォルトではESXiの管理インタフェースにアクセス可能であれば一切の制約なく接続可能になっていますので、ここではSSHとWeb Clientに接続可能なIPを絞る事にしましょう。ご自身が使われているプライベートネットワークアドレスや端末のIPアドレスでも構いませんが設定も簡単ですしお勧めします。</p>\n<img src=\"/new-technology/2021/01/23/esxi-security/esxi1.png\" class=\"\" title=\"alt\">\n\n<p>SSHで接続してバックアップを取得する場合の「SSHサーバ」、Web管理画面の「vSphere Web Client」について接続IPアドレスまたはネットワークアドレスを指定します。</p>\n<h3 id=\"SSHの起動、停止\"><a href=\"#SSHの起動、停止\" class=\"headerlink\" title=\"SSHの起動、停止\"></a>SSHの起動、停止</h3><p>これは、管理メニューの左ペイン<mark class=\"label primary\">ホスト</mark>ー<mark class=\"label primary\">管理</mark>から<mark class=\"label primary\">TSM</mark>および<mark class=\"label primary\">TSM-SSH</mark>の起動・停止を行います。SSHは起動したままの状況は推奨されておらず、このドキュメントでも必要な時のみ起動するように記載されています。心配な方はSSHは起動したままにしないのが無難です。利便性のためにSSHは普段から起動したまま運用するならば接続IPを絞るなど何らかの工夫は加えたいところです。ここは個人の考え方で大きく運用は異なりますから、ベストプラクティスを定めるのは難しいのが実態です。</p>\n<h3 id=\"SSHのログ\"><a href=\"#SSHのログ\" class=\"headerlink\" title=\"SSHのログ\"></a>SSHのログ</h3><p>P113に「ESXiログ ファイルの場所」という章があります。ここでログインした際のログが確認できます。場所は<mark class=\"label primary\">/var/log/auth.log</mark>です。わざわざSSHでログインしなくとも、Web管理画面の<mark class=\"label primary\">ホスト</mark>ー<mark class=\"label primary\">監視</mark>からログを閲覧できます。</p>\n<h3 id=\"syslogでログを転送する\"><a href=\"#syslogでログを転送する\" class=\"headerlink\" title=\"syslogでログを転送する\"></a>syslogでログを転送する</h3><p>syslogサーバをお持ちの方はログを転送して確認できます。NASなどは簡易なsyslogサービスを持っている場合があるので活用を検討してみてください。P112には以下の通り記載があります。</p>\n<blockquote>\n<p>vSphere Client または esxcli system syslog vCLI コマンドを使用して syslog サービスを構成できます</p>\n</blockquote>\n<p>これも難しい記載になってますが、Web管理画面から設定できます。以下のように管理メニューの左ペイン<mark class=\"label primary\">ホスト</mark>ー<mark class=\"label primary\">管理</mark>から<mark class=\"label primary\">システム</mark>、<mark class=\"label primary\">詳細設定</mark>と進み、右上のフィルタリストに”Syslog.global.logHost”と入力すると設定対象の項目が表示されます。</p>\n<img src=\"/new-technology/2021/01/23/esxi-security/esxi2.png\" class=\"\" title=\"alt\">\n\n<p>“Syslog.global.logHost”の行でマウスを右クリックし、<mark class=\"label primary\">オプションの編集</mark>を選択します。ここではプロトコル、対象ホスト、ポート番号を指定します。受ける側のsyslogサーバに合わせUDPまたはTCPを選択し、<code>udp://192.168.x.xxx:514</code>のように指定します、<br>また、syslogサーバでSSL対応がなされていない場合は、”Syslog.global.logCheckSSLCerts”の値を<code>True</code>から<code>False</code>に変更します。</p>\n<p>syslogではひたすらログが流れてきます。SSHにおけるログイン失敗については、ファシリティ＝auth、重要度&#x3D;Errorの扱いです。また、Web Clientについては、重大度はInfoで”Invalid Login”というログが書かれるようですので、これらだけをフィルタしても良いでしょう。</p>\n<h3 id=\"SSHで公開鍵認証を行う（必要であれば）\"><a href=\"#SSHで公開鍵認証を行う（必要であれば）\" class=\"headerlink\" title=\"SSHで公開鍵認証を行う（必要であれば）\"></a>SSHで公開鍵認証を行う（必要であれば）</h3><p>P48から公開鍵認証について記載があります。これも記載が専用コマンドでわかりづらい記載になっており、実際には無償版ESXIの説明にはなっていません。ESXiはOpenSSHを使っていますので、そちらの設定で動作します。また、公開鍵のみでログインする場合<code>/etc/ssh/sshd_config</code>を修正したくなりますが、これは修正しないようにと説明されています。また同じP48で紹介している公開鍵認証に関する<strong>VMwareの説明ページ</strong>があります。OpenSSHの秘密鍵と公開鍵の作成についてはネットの様々な場所で説明されているのでここでは割愛しますが、以下の場所に公開鍵を配置するように説明があります。</p>\n<blockquote>\n<p>For ESXi 5.x, 6.0, 6.5 and 6.7, the authorized_keys is located at: &#x2F;etc&#x2F;ssh&#x2F;keys-＜username＞&#x2F;authorized_keys</p>\n</blockquote>\n<p>つまり、rootユーザーですと、<code>/etc/ssh</code>配下に<code>keys-root</code>フォルダを作り、<code>authorized_keys</code>に公開鍵を記述せよという事です。</p>\n<div class=\"note info\"><p>ESXi7では、”keys-root”フォルダおよびauthorized_keysファイルは最初から存在します（ESXi6.7では作成する必要がありました）。</p>\n</div>\n\n<blockquote>\n<p>vmware -Allowing SSH access to ESXi&#x2F;ESX hosts with public&#x2F;private key authentication (<code>1002866</code>)-<br> <a href=\"https://kb.vmware.com/s/article/1002866\">https://kb.vmware.com/s/article/1002866</a></p>\n</blockquote>\n<p>ちなみに、ESXi側でもssh-keygenを実行すると、<code>/etc/ssh</code>の配下に、公開鍵<code>ssh_host_rsa_key.pub</code>と秘密鍵<code>ssh_host_rsa_key</code>が作成されます。それと同時に<code>/etc/ssh/sshd_config</code>にも公開鍵認証である、<code>HostKey /etc/ssh/ssh_host_rsa_key</code>が挿入されるようです。これがあるとrootユーザーは公開鍵認証が必須という事になりますから、秘密鍵をダウンロードせずにそのままsshを閉じるとパスワードで接続できなくなるため注意が必要です。</p>\n<p>また、このVMwareのKBによれば、以下の通りsshd_configを修正せよとあります。</p>\n<blockquote>\n<p>To disable password login, ensure that the ChallengeResponseAuthentication and PasswordAuthentication are set to no.</p>\n</blockquote>\n<p>いったいどちらを信用すべきなんだろうと悩んでしまいますが、やるなと言われている事は敢えてやらずにsshd_configの書き換えはしない方向で進めます。一般的な方法でクライアントで秘密鍵、公開鍵のペアを作成し、ESXiの<code>/etc/ssh</code>配下に<code>keys-root</code>フォルダを作り、<code>authorized_keys</code>に公開鍵をコピーします。</p>\n<ol>\n<li>PCからESXi(192.168.x.x)の&#x2F;tmpに公開鍵をコピーします。ここではsshする前提なのでscpを使います。もちろん他の方法でも構いません。<br><code>scp id_rsa.pub root@192.168.x.x:/tmp</code></li>\n<li>ESXiにて&#x2F;tmpからAuthorized_keysに鍵をコピー（追記）します。<br> <code>cat /tmp/id_rsa.pub &gt;&gt; /etc/ssh/keys-root/authorized_keys </code></li>\n</ol>\n<p>有効にするためにはTSM-SSHを再起動します。TSM-SSHを再起動してもSSHセッションは切断しないようですがこれらの作業はリスクが高いものですので、他の端末から既に接続した状態にする、或いは他のユーザー（管理者権限）をESXiに作成し接続できている状態で作業される事をお勧めします。</p>\n<p>結局のところ、<code>sshd_config</code>を修正できないのであればパスワード認証を禁止するなどの対応はできません。しかし、普段からrootのパスワードは利用せず、公開鍵認証を利用することでパスワードの漏洩は防ぐことができます。</p>\n<h2 id=\"ESXiに別の管理者ユーザーを作成する\"><a href=\"#ESXiに別の管理者ユーザーを作成する\" class=\"headerlink\" title=\"ESXiに別の管理者ユーザーを作成する\"></a>ESXiに別の管理者ユーザーを作成する</h2><p>”vSphereのセキュリティ”についてはこれまで説明したものが全てですが、root以外のユーザーを作成し、rootはできるだけ使わない事をお勧めします。これは一般論でありrootがよく知られたユーザー名だからです。「<a href=\"/new-technology/2020/10/11/esxi-backup/\" title=\"VMware ESXiの仮想マシンをバックアップする\">VMware ESXiの仮想マシンをバックアップする</a>」で説明したバックアップスクリプトのghettoVCBはrootユーザーを必須としているので、運用上、どうしてもrootユーザーでのログインは必要になってきます。しかし仮想マシンなどの操作がメインとなるWebクライアントについては別の管理者アカウントで操作すべきで、可能な限りrootユーザーの情報が漏洩しないようにrootを使う機会を減らすべきです。以下の手順で管理者アカウントを作成します。</p>\n<ol>\n<li>管理メニューの左ペイン<mark class=\"label primary\">ホスト</mark>ー<mark class=\"label primary\">管理</mark>から<mark class=\"label primary\">セキュリティとユーザー</mark>に進み、<mark class=\"label primary\">ユーザー</mark>から<mark class=\"label primary\">ユーザーの追加</mark>をクリックします。<img src=\"/new-technology/2021/01/23/esxi-security/esxi3.png\" class=\"\" width=\"800\" title=\"alt\"></li>\n<li>ユーザー名とパスワードを登録してユーザーの作成を終えます。</li>\n<li>管理メニューの左ペイン<mark class=\"label primary\">ホスト</mark>から<mark class=\"label primary\">アクション</mark>を選択し、プルダウンの<mark class=\"label primary\">権限</mark>をクリックします。</li>\n<li>さらに<mark class=\"label primary\">ユーザーの追加</mark>を選択します。実際には上記で作成したユーザーと同一名のユーザー名を入力します。ロールについては”システム管理者”を選択します。<img src=\"/new-technology/2021/01/23/esxi-security/esxi4.png\" class=\"\" width=\"800\" title=\"alt\"></li>\n</ol>\n<p>これで新しいユーザーが作成できたので、Web管理画面からログイン可能か確認してください。rootユーザーは長めのパスワードを再設定し、パスワード管理ソフトに登録し普段は使わないようにします。普段から使わずにパスワードを封印しておけばより安全になります。</p>\n<h2 id=\"パスワード認証と公開鍵認証について\"><a href=\"#パスワード認証と公開鍵認証について\" class=\"headerlink\" title=\"パスワード認証と公開鍵認証について\"></a>パスワード認証と公開鍵認証について</h2><p>ここからはESXiの話からは少し脱線します。一般的にパスワードより公開鍵認証の方が安全という記事をよく見かけます。それはその通りですが補足します。</p>\n<p>パスワードは確かにインターネット上にデータとして流れますから漏洩リスクはあります。「<a href=\"/new-technology/2020/03/20/ssl-inspection/\" title=\"SSLインスペクションについて\">SSLインスペクションについて</a>」でSSLのシーケンスを記載しましたが、経路の途中で悪意あるネットワーク機器によって改竄されてユーザーがそれに気づかず情報が漏洩する可能性はあります。それに比べれば、公開鍵認証は秘密鍵で署名した情報をサーバー側に配置してある公開鍵で検証するので鍵の情報が都度流れるわけではありません。オフィスでシステムを使う場合も、公開鍵認証＋パスフレーズで運用していれば、仮にパスフレーズだけが見られたとしても鍵が漏洩しなければパスワードよりは安全です。</p>\n<p>さらにパスワードはクリップボードからの読み取りやブラウザからの画面上の情報読み取りの機能があります。ブラウザの拡張機能は殆どがページの内容を読み取る事ができます。SSLでは全く保護できません。ブラウザの上で起きている話ですから。興味のある方はブラウザの拡張機能の権限で調べてみてください。拡張機能を使わないでという事ではなくて、信頼できる拡張機能を選んでください。</p>\n<p>しかし、こういった漏洩はあくまでオープンなネットワークに対して発生するものです。自宅でクローズなネットワークを利用してESXiを運用している場合は、パスワード認証と公開鍵認証とであまり違いはありません。</p>\n<p>一方、公開鍵認証は確かにパスワードの流出はありませんが、鍵は~&#x2F;.ssh&#x2F;id_rsaというファイルで保存されている方も多いでしょう。これは昔からの伝統ですが、現在では少し無防備ではないでしょうか。ウィルスに感染したり、ファイル共有から流出する可能性を考えるとパスワード、公開鍵認証どちらが安全という断定はできません。秘密鍵のパスフレーズを難解なものにするという方法もありますが、秘密鍵をダウンロードしじっくり解読すれば解読は十分に可能なものであり、パスワードと同様の複雑さの議論になってしまいます。結局いずれの方法を選択するにしても、対策は必要です。LAN内のログインで悩むくらいならパスワード管理ソフトからパスワードをコピー、貼り付けしてから速やかにクリップボードの内容を消す方がよほど安全ではないでしょうか。</p>\n<p>クライアントPCの秘密鍵を盗まれた上に自宅のローカル環境のESXiにログインされるというのは非常に稀な事です。しかし公開鍵認証を使うと決めたのであれば、秘密鍵はパスワード以上に取り扱いを厳重にしたいものです。</p>\n<p>公開鍵認証に関しては、一番先行しているのがビットコインなどの暗号資産であり、コールドウォレット（秘密鍵）の管理方法から学ぶ事は多いです。PCの管理とは全く次元の違う緊張感のあるなかで秘密鍵の保管はオフラインが大前提です。ハードウェアウォレットが推奨されており、これは一般的なITの世界では<strong>yubico</strong>のYubikeyによる物理セキュリティキーが相当します。取り扱う情報資産や金融資産の重要度に応じて、セキュリティに対する取り組み方が変わってきます。</p>\n<blockquote>\n<p>yubico<br> <a href=\"https://www.yubico.com/\">https://www.yubico.com</a></p>\n</blockquote>\n<h2 id=\"VMware-Security-Advisory\"><a href=\"#VMware-Security-Advisory\" class=\"headerlink\" title=\"VMware Security Advisory\"></a>VMware Security Advisory</h2><p>VMwareに関する脆弱性情報は以下にあります。このページから <mark class=\"label primary\">Sign up for Security Advisories</mark>をクリックし、メールアドレスを登録することでVMware製品の脆弱性情報を入手できます。</p>\n<blockquote>\n<p>VMware Security Advisories<br> <a href=\"https://www.vmware.com/security/advisories.html\">https://www.vmware.com/security/advisories.html</a></p>\n</blockquote>\n","categories":["Security"],"tags":["ESXi"]},{"title":"VMware vSphere Hypervisor（ESXi）のインストール","url":"/new-technology/2020/02/29/esxi/","content":"<p class=\"onepoint\">この記事で実現すること</p>\n\n<p>Sophos Firewall（旧名称はXG Firewall）を仮想環境で稼働させるために、VMware ESXiをインストールします。</p>\n<span id=\"more\"></span>\n\n<h2 id=\"ESXiについて\"><a href=\"#ESXiについて\" class=\"headerlink\" title=\"ESXiについて\"></a>ESXiについて</h2><p> 無償版の仮想環境ESXiは<mark class=\"label primary\">vSphere Hypervisor</mark>という名前が付けられています。Sophos Firewallの導入に必須ではありませんが、XG自体をバックアップすることやバージョンアップの際にその状態を一時保存するスナップショットなどとても便利なので、仮想環境を構築しその上に仮想ホストとしてXGをインストールします。vSphereという製品群、その中の1つの無償版バージョンとして、”vSphere Hypervisor”があります。ESXiは製品名というよりは直接ハードウェアを制御するVMWareの仮想化ソフトウェア、これに対する一般用語としては”ハイパーバイザー”です。そして、ESXi（ハイパーバイザー）上で稼働する実際のOSをVirtual Machine（VM:仮想マシン）と呼びます。</p>\n<p>（2022-11-23追記）<br>ESXiの最新Versionは2022-10-11に発表された8.0となっています。まだ無償版としてのライセンスが提供されていないようです。もう少し成熟してから無償版のライセンスが提供開始になるのでしょうか。まだ状況は不明瞭であり、この記事ではESXi7を対象にしています。新しいバージョンでは新しいハードウェアに適合する一方、古いCPUやネットワークカードなどは切り捨てられる傾向があります。</p>\n<p>このホームユーザー向け（無償版）ESXi（vSphere Hypervisor）に関するドキュメントは、<strong>VMWareのサイト</strong>を参照してください。</p>\n<blockquote>\n<p>VMware vSphere Hypervisor<br> <a href=\"https://www.vmware.com/jp/products/vsphere-hypervisor.html\">https://www.vmware.com/jp/products/vsphere-hypervisor.html</a></p>\n</blockquote>\n<h2 id=\"ハードウェア互換リスト\"><a href=\"#ハードウェア互換リスト\" class=\"headerlink\" title=\"ハードウェア互換リスト\"></a>ハードウェア互換リスト</h2><p>事前にハードウェア互換リストを参照し、用意したハードウェアに互換性があるかチェックしたいところですが、実際に個人向けのハードウェアは殆ど列挙されていません。</p>\n<blockquote>\n<p>VMware Compatibility Guide<br> <a href=\"https://www.vmware.com/resources/compatibility/search.php\">https://www.vmware.com/resources/compatibility/search.php</a></p>\n</blockquote>\n<p>CPU、ネットワークカード、ストレージに至るまでintel製の互換性が高いというより他はなく、明確な機器をリストアップすることが困難です。<br>CPUとネットワークカードはintel製を選択されるのが無難です。ストレージに関しては、SATAのSSDであれば大半のメーカーのものは認識するようですが、NVMeについては過渡期で多くのトラブルの声がブログや掲示板等で確認できます。</p>\n<h2 id=\"インストールメディアの準備\"><a href=\"#インストールメディアの準備\" class=\"headerlink\" title=\"インストールメディアの準備\"></a>インストールメディアの準備</h2><ol>\n<li>ESXiをインストールする予定の2つのNICを持ったPC1台と、ISOファイルをインストールするための最低8GB、推奨32GB以上のUSBメディアを用意してください。</li>\n<li>ESXiのダウンロードにはVMwareのアカウント（無償）が必要です。VMWareのサイトでアカウント作成、製品（vSphere Hypervisor）をダウンロードします。</li>\n</ol>\n<blockquote>\n<p>vSphere Hypervisor 7.0<br>  <a href=\"https://my.vmware.com/jp/web/vmware/evalcenter?p=free-esxi7\">https://my.vmware.com/jp/web/vmware/evalcenter?p=free-esxi7</a></p>\n</blockquote>\n<div class=\"link-grid\"><div class=\"link-grid-container\">\n<object class=\"link-grid-image\" data=\"vSphere-Client.png\"></object>\n<p>vSphere Hypervisor 7.0</p><p>(https://my.vmware.com/jp/web/vmware/evalcenter?p=free-esxi7)このダウンロード センターには、技術資料、インストール デモ、および vSphere Hypervisor のトレーニングが用意されています。</p>\n<a href=\"https://my.vmware.com/jp/web/vmware/evalcenter?p=free-esxi7\"></a>\n</div></div>\n\n<ol>\n<li>以下のYouTube動画を参考にメディアを作成します。USBメディア作成に用いるRufusは64bit版のWindows OSが必要です。<blockquote>\n<p><a href=\"https://www.youtube.com/watch?v=7gYnyIaQH9A\">https://www.youtube.com/watch?v=7gYnyIaQH9A</a></p>\n <img src=\"/new-technology/2020/02/29/esxi/rufus.png\" class=\"\" width=\"800\" title=\"alt\"></blockquote>\n</li>\n</ol>\n<blockquote>\n<p>Rufus<br> <a href=\"https://rufus.ie/ja/\">https://rufus.ie/ja/</a></p>\n</blockquote>\n <img src=\"/new-technology/2020/02/29/esxi/rufus1.png\" class=\"\" width=\"480\" title=\"alt\">\n<p> ESXiのインストール対象マシンがUEFIのセキュアブートに対応しているのであればこのようにGPTとUEFIを選択してください。</p>\n<h2 id=\"ESXiのインストール\"><a href=\"#ESXiのインストール\" class=\"headerlink\" title=\"ESXiのインストール\"></a>ESXiのインストール</h2><h3 id=\"ネットワーク構成\"><a href=\"#ネットワーク構成\" class=\"headerlink\" title=\"ネットワーク構成\"></a>ネットワーク構成</h3><p>普段利用しているネットワークとは別のネットワークのIPアドレスを振ってセットアップします。いつもが<code>192.168.0.0/24</code>なら、今回は仮に<code>192.168.1.0/24</code>のネットワークに配置する予定としてESXiをセットアップする事にしましょう。これまでのネットワークにXG Firewallを挟み込む事になり、従来のネットワークはXGのWAN側とホームゲートウェイに利用され、XGのLAN側は新しいネットワークになるためです。新たにXGのLAN側と同じネットワークにESXiの管理ネットワークを構築する必要があります。なお、XGのLAN側のデフォルトIPアドレスは、<code>172.16.16.16</code>となっています。ここではXGのIPもセットアップ時に<code>192.168.1.0/24</code>のネットワークに変更する事とします。XGのセットアップが完了し、<code>192.168.1.0/24</code>のネットワークからXGを介してインターネットに接続できたら、今の<code>192.168.0.0/24</code>にある機器をXGのLANを経由するように移設していきます。</p>\n<img src=\"/new-technology/2020/02/29/esxi/setup_esxi.drawio.png\" class=\"\" title=\"alt\">\n\n<p>上記の図のように、1台のハードウェアにESXiをインストールし、ESXiのインストール終了後はブラウザでESXiを制御するための別のPCが必要となります。</p>\n<h3 id=\"USBメディアからインストール\"><a href=\"#USBメディアからインストール\" class=\"headerlink\" title=\"USBメディアからインストール\"></a>USBメディアからインストール</h3><p>インストールについては、以下のYouTube動画を参考にRufusでセットアップしたUSBメディアからブートしてください。インストール対象のハードウェアがUEFIブート可能である場合は、BIOSの設定でセキュアブートを有効にし、UEFI(GPT)としてESXiをセットアップされる事をお勧めします。セキュアブートによってマルウェア等からの改ざん防止としての効果が期待できます。一方、勝手にユーザー作成モジュールをインストールできないという制約も加わります。</p>\n<blockquote>\n<p><a href=\"https://www.youtube.com/watch?v=eiZn54GPfzI\">https://www.youtube.com/watch?v=eiZn54GPfzI</a></p>\n</blockquote>\n<img src=\"/new-technology/2020/02/29/esxi/install.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<ul>\n<li>vCenterはホームユーザー向けには使いませんので無視してください。</li>\n<li>NICが2枚ある事を前提にすると、ESXiの管理画面はLAN側のNICを対象とするように設定してください。今の時点では、WANは使いません。新しく振ったIP（<code>192.168.1.1/24</code>）をESXiの管理用IPとして、セットアップします。</li>\n<li>上記のビデオ（2:35前後の説明）では「冗長性のためにnicを2枚以上選択することが推奨されます」と説明がありますが、今回は冗長化を使いません。先頭のvmnic0をLAN側のNIC（管理用）としてセットアップしてください。また、ここではVLANも使いません。</li>\n<li>ESXiでは、vSphere Clientは使いません。インストールしたESXiのLAN側のIPアドレスに対してブラウザで接続し、ESXiのWeb管理画面を利用します。</li>\n</ul>\n<p>セットアップ終了後、USBメディアを抜いて再起動後、ESXiの画面にIPアドレスが表示されます。ESXiのLAN側のNICと操作用のPCとを繋ぎます。PCのIPを設定（例えば、<code>192.168.1.101/24</code>）し、ESXiのIPアドレスにブラウザで接続してください。ログインは、ユーザー名がroot、パスワードはセットアップで指定したものになります。</p>\n","categories":["Security"],"tags":["ESXi","XG Firewall"]},{"title":"VMware ESXiを6.7から7.0にアップグレードする","url":"/new-technology/2021/12/25/esxi-upgrade/","content":"<img src=\"/new-technology/2021/12/25/esxi-upgrade/title.png\" class=\"\" width=\"1024\" title=\"alt\">\n<p class=\"onepoint\">この記事で実現すること</p>\n\n<p>無償版ESXi（VMware vSphere Hypervisor）について、ESXi6.7からESXi7.0にアップグレードします。ここではUEFI（セキュアブート）で構成されているESXiを対象とし、できるだけ安全にアップグレードを行います。2023年2月8日時点では、ESXi8.0が発表されているものの、無償版としてのライセンスが公開されていないようです。</p>\n<span id=\"more\"></span>\n\n<h2 id=\"ESXiの脆弱性を狙ったランサムウェアについて\"><a href=\"#ESXiの脆弱性を狙ったランサムウェアについて\" class=\"headerlink\" title=\"ESXiの脆弱性を狙ったランサムウェアについて\"></a>ESXiの脆弱性を狙ったランサムウェアについて</h2><p>JPCERT&#x2F;CCより、2023-02-07にESXiのランサムウェア攻撃についての情報が提供されています。</p>\n<blockquote>\n<p>VMware ESXiを標的としたランサムウェア攻撃について<br> <a href=\"https://www.jpcert.or.jp/newsflash/2023020601.html\">https://www.jpcert.or.jp/newsflash/2023020601.html</a></p>\n</blockquote>\n<p>既知のOpenSLPのヒープオーバーフローの脆弱性（CVE-2021-21974）を悪用した攻撃とみられ、攻撃を受けるとファイルが暗号化され身代金の支払いを求めるメッセージが残されます。</p>\n<p>VMware ESXi 7.0系 Update 1cより前のバージョン（ESXi70U1c-17325551パッチ未適用）<br>VMware ESXi 6.7系 ESXi670-202102001より前のバージョン（ESXi670-202102401-SGパッチ未適用）<br>VMware ESXi 6.5系 ESXi650-202102001より前のバージョン（ESXi650-202102101-SGパッチ未適用）<br>VMware Cloud Foundation 4系 4.2より前のバージョンに含まれるESXi<br>VMware Cloud Foundation 3系 KB82705未適用のバージョンに含まれるESXi</p>\n<p>ESXi7.0未満は既にEOSLを迎えていますので、早急にアップグレードをお勧めします。</p>\n<h2 id=\"ESXiのアップグレード\"><a href=\"#ESXiのアップグレード\" class=\"headerlink\" title=\"ESXiのアップグレード\"></a>ESXiのアップグレード</h2><p>まず正式なアップグレードに関するドキュメントがVMwareより提供されており、こちらでポイントを確認します。アップデートとアップグレードとは異なります。<br>ESXiのバージョン体系は、”x”.”y” update “z” ビルド番号 という並びで表現されます。</p>\n<ul>\n<li>アップグレードは、前2桁（x,y）を上げることを指します。</li>\n<li>アップデートは、前2桁が変わりません。それ以降の数字があるケース、またはUpdate”z”などの形式があります。Update2を省略してU2、さらにU2a、U2cなど英数字が上がっていきます。</li>\n</ul>\n<p>アップデートによってこれまで動いていたハードウェアが動かなくなるという事は大々的にはおきません（ドライバーの更新によって認識しなくなったりうまく動作しないという一般的な理由はあります）。アップグレードではハードウェアのサポート対象の見直しが入ります。</p>\n<blockquote>\n<p>ESXiのアップグレード<br> <a href=\"https://docs.vmware.com/jp/VMware-vSphere/7.0/vsphere-esxi-70-upgrade-guide.pdf\">https://docs.vmware.com/jp/VMware-vSphere/7.0/vsphere-esxi-70-upgrade-guide.pdf</a></p>\n</blockquote>\n<p>例によってVMwareのマニュアルは法人向けにvCenter Serverを中心に記載されているのでポイントを無償版ESXiに絞ります。</p>\n<ul>\n<li>VMWare互換性ガイドでアップグレードが可能か確認する（P8）</li>\n<li>バージョン6.5または6.7から7.0にバージョンアップ可能（P9）</li>\n<li>ESXi7.0にアップグレードするとダウングレードできない（P15）</li>\n<li>esxcliコマンドまたはISOブートからのアップグレードの2種類がある（P38,P64）</li>\n<li>アップグレードには新たにESXi7.0向けの（無償版ESXiの）ライセンスを登録する（P80）</li>\n<li>仮想マシンとVMware Toolsのアップグレード（P12）</li>\n</ul>\n<p>注意点は以下の通りです。</p>\n<blockquote>\n<p>esxcliコマンドを使用してアップグレードすると、古いバージョンのESXiは新しいVIBのインストールを実行するため、署名が保存されずセキュアブートは実行できません。ISOを使用してアップグレードすると、新しいVIBは署名を保存できます。（P80）</p>\n</blockquote>\n<p>上記の注意点の通り、UEFIのセキュアブートで稼働しているESXiのバージョンアップにはISOを使用してアップグレードすべきと読めます。一方、セキュアブートでなければ、<code>esxcli software profile update --depot=&lt;depot_location&gt; --profile=&lt;profile_name&gt; </code>のコマンドでアップグレード可能です。詳細は、「<a href=\"/new-technology/2020/06/14/esxi67-patch/\" title=\"VMware ESXiにパッチを適用する\">VMware ESXiにパッチを適用する</a>」の記事を参照してください。但し、ESXi7.0におけるハードウェア互換性が維持できるか慎重に確認するためには、ISOでのアップグレードを検討してください。</p>\n<p>VMware互換性ガイドは個人向けのハードウェアが殆ど列挙されておらずチェックが困難なのが実態です。ハードウェアが準拠しているかどうかのチェックについては後述します。</p>\n<p>また、上記マニュアルには注意点としての記載がありませんが、スナップショットを取得していない状態でアップグレードされる事をお勧めします。</p>\n<p>この記事はESXi6.7からESXi7.0にアップグレードする例を記載しています。厳密なアップグレードパスについては以下を確認してください。</p>\n<img src=\"/new-technology/2021/12/25/esxi-upgrade/upgradepath.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<blockquote>\n<p>VMware Product Interoperability Matrix<br> <a href=\"https://interopmatrix.vmware.com/Upgrade?productId=1&amp;isHidePatch=true\">https://interopmatrix.vmware.com/Upgrade?productId=1&amp;isHidePatch=true</a></p>\n</blockquote>\n<h2 id=\"仮想マシンのバックアップ（任意）\"><a href=\"#仮想マシンのバックアップ（任意）\" class=\"headerlink\" title=\"仮想マシンのバックアップ（任意）\"></a>仮想マシンのバックアップ（任意）</h2><p>バージョンアップの前には仮想マシンのバックアップを別の筐体またはメディアに取得される事をお勧めします。「<a href=\"/new-technology/2020/10/11/esxi-backup/\" title=\"VMware ESXiの仮想マシンをバックアップする\">VMware ESXiの仮想マシンをバックアップする</a>」の記事を参照してください。ghettoVCBを使ったバックアップでは、ESXiにsshした上で、次のコマンドで全ての仮想マシンのバックアップ取得が可能です。<code>/bin/sh ./ghettoVCB.sh -a</code></p>\n<h2 id=\"アップグレード対象のESXi7-0を確認する\"><a href=\"#アップグレード対象のESXi7-0を確認する\" class=\"headerlink\" title=\"アップグレード対象のESXi7.0を確認する\"></a>アップグレード対象のESXi7.0を確認する</h2><p>ESXiのISOインストーラのダウンロードは、2023年2月8日時点ではESXi7.0 Update3gとなっています。</p>\n<blockquote>\n<p>VMware vSphere Hypervisor 7.0 Update3g ダウンロード センター(※VMware Customer Connectへログインが必要です)<br> <a href=\"https://customerconnect.vmware.com/jp/web/vmware/evalcenter?p=free-esxi7\">https://customerconnect.vmware.com/jp/web/vmware/evalcenter?p=free-esxi7</a></p>\n</blockquote>\n<h2 id=\"ESXi7-0インストールメディア（USB）の作成\"><a href=\"#ESXi7-0インストールメディア（USB）の作成\" class=\"headerlink\" title=\"ESXi7.0インストールメディア（USB）の作成\"></a>ESXi7.0インストールメディア（USB）の作成</h2><p>ここではUSBメモリを用意し、ESXi7.0のインストーラーをセットアップします。<br>事前にハードウェア互換リストを元に互換性があるかチェックしたいところですが、実際に個人向けのハードウェアは殆ど列挙されていません。</p>\n<blockquote>\n<p>VMware Compatibility Guide<br> <a href=\"https://www.vmware.com/resources/compatibility/search.php\">https://www.vmware.com/resources/compatibility/search.php</a></p>\n</blockquote>\n<p>運まかせでアップグレードを実行するのは勇気が要ります。また、ESXi7.0にアップグレードした後はダウングレードできません。そこで、<strong>32GBのUSBインストールメディア自身にESXi7.0をクリーンインストールし、検証する方法をお勧めします。</strong><br>つまり、USBメディアにインストールするISOイメージをセットアップし、マシンブートしセットアップを開始しますが、実際のセットアップはそのUSBをフォーマットしてUSB上にESXi7.0を新規でセットアップするというものです。フォーマットしてしまったらセットアップが動かなくなりそうですが、インストーラは最初にモジュールを全て読み込むのでこの方法が可能になります。これで既存の環境を壊さず、そのハードウェアにESXi7.0が導入できるかテストできます。もちろん、正式なセットアップをするためには再度ISOのインストーラーをUSBにコピーする必要があります。</p>\n<h3 id=\"ESXi7-0-インストーラーのダウンロード\"><a href=\"#ESXi7-0-インストーラーのダウンロード\" class=\"headerlink\" title=\"ESXi7.0 インストーラーのダウンロード\"></a>ESXi7.0 インストーラーのダウンロード</h3><p>以下からISOをダウンロードします。</p>\n<p><a href=\"https://customerconnect.vmware.com/jp/web/vmware/evalcenter?p=free-esxi7\">https://customerconnect.vmware.com/jp/web/vmware/evalcenter?p=free-esxi7</a></p>\n<p>ダウンロードは、”VMware vSphere Hypervisor (ESXi ISO) image”をダウンロードします。</p>\n<p>また、製品のライセンスキーが表示されていますので、メモを取っておいてください。</p>\n<h3 id=\"Rufusによるisoメディアの作成\"><a href=\"#Rufusによるisoメディアの作成\" class=\"headerlink\" title=\"Rufusによるisoメディアの作成\"></a>Rufusによるisoメディアの作成</h3><p>以下のサイトからRufusをWindowsでダウンロードし実行します。</p>\n<blockquote>\n<p>Rufus<br> <a href=\"https://rufus.ie/ja/\">https://rufus.ie/ja/</a></p>\n</blockquote>\n<p> 以下のオプションでUSBメディアにESXi7.0のインストーラーを書き込みます。</p>\n <img src=\"/new-technology/2021/12/25/esxi-upgrade/rufus1.png\" class=\"\" width=\"480\" title=\"alt\">\n<p> UEFIのセキュアブートに対応させるためにはGPTとUEFIを選択してください。</p>\n<h2 id=\"ESXi7-0のテストインストール\"><a href=\"#ESXi7-0のテストインストール\" class=\"headerlink\" title=\"ESXi7.0のテストインストール\"></a>ESXi7.0のテストインストール</h2><p>ESXi6.7がインストールされているハードウェアにUSBを挿しUSBブートします。</p>\n<blockquote>\n<p><a href=\"https://www.youtube.com/watch?v=eiZn54GPfzI\">https://www.youtube.com/watch?v=eiZn54GPfzI</a></p>\n</blockquote>\n<img src=\"/new-technology/2021/12/25/esxi-upgrade/install.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p>ビデオの45秒あたりのところで、どのディスクにインストールするか選択しますが、ここではUSBメモリを選択します。ここは少し緊張感が必要です。テストインストールですのでパスワードも簡単なものに、といきたいところですが、パスワード要件として小文字、大文字、数字、および特殊文字を含める必要があります。よってキーボードも日本語キーボードであればきちんとキーボードの種類も選択する必要があります。</p>\n<div class=\"note danger\"><p>誤って既存のESXi6.7がインストールされているドライブに新規インストールを選択してしまうと、既存の環境が全てフォーマットされてしまいます。</p>\n</div>\n\n<p>セットアップ終了後、再びUSBメモリからブートします。今度はセットアップではなく、ESXi7.0が起動します。ブートシーケンスが既存のSSD等から起動した場合はESXi6.7が起動してしまいます。一旦この状態で、PCをESXiに接続し、ブラウザからESXiにログインし、ストレージやネットワークが使えるか確認できます。当然ながらここには既存の仮想マシンは存在しません。</p>\n<h2 id=\"ESXi7-0へのアップグレード\"><a href=\"#ESXi7-0へのアップグレード\" class=\"headerlink\" title=\"ESXi7.0へのアップグレード\"></a>ESXi7.0へのアップグレード</h2><p>再び、Rufusを使い、USBメディアにISOイメージを作成します。そして前述したビデオを参考に今度は既存のESXi6.7がインストールされているSSDに対してアップグレードを選択します。</p>\n<blockquote>\n<p><a href=\"https://www.youtube.com/watch?v=eiZn54GPfzI\">https://www.youtube.com/watch?v=eiZn54GPfzI</a></p>\n</blockquote>\n<img src=\"/new-technology/2021/12/25/esxi-upgrade/install.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p>今回はアップグレードが終了し、再起動する際にはUSBメディアは外してください。</p>\n<p>無事再起動したら管理画面にログインします。<br>ESXi7.0はWebUIではビルド番号までは判明しません。sshでESXiに接続し、<code>esxcli system version get</code>を実行し確認します。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@esxi:~] esxcli system version get</span><br><span class=\"line\">Product: VMware ESXi</span><br><span class=\"line\">Version: 7.0.2</span><br><span class=\"line\">Build: Releasebuild-20328353</span><br></pre></td></tr></table></figure>\n\n<p>コマンドで確認する際は、Versionとビルド番号で見るのが確実です。VMwareのサイトではパッチは7.0を対象に検索し、あとはビルド番号で照会します。</p>\n<h2 id=\"後処理\"><a href=\"#後処理\" class=\"headerlink\" title=\"後処理\"></a>後処理</h2><p>無事アップグレードが成功したら、以下の作業を行います。</p>\n<ol>\n<li>ESXi7.0のライセンス登録<br> ESXiにログイン後、左ペインメニューの<mark class=\"label primary\">ホスト</mark>-<mark class=\"label primary\">管理</mark>から<mark class=\"label primary\">ライセンスタブ</mark>を選択し、<mark class=\"label primary\">ライセンスの割り当て</mark>でダウンロード時に控えたライセンスキーを登録します。</li>\n<li>ESXi7.0の最新パッチ適用<br> ESXiのパッチ適用については、「<a href=\"/new-technology/2020/06/14/esxi67-patch/\" title=\"VMware ESXiにパッチを適用する\">VMware ESXiにパッチを適用する</a>」を参照してください。</li>\n<li>ESXi7.0の構成情報のバックアップ（任意）</li>\n</ol>\n<h2 id=\"仮想マシンのアップグレード（任意）\"><a href=\"#仮想マシンのアップグレード（任意）\" class=\"headerlink\" title=\"仮想マシンのアップグレード（任意）\"></a>仮想マシンのアップグレード（任意）</h2><p>ESXiのバージョンアップ後、仮想マシンのバージョンをアップグレードできます。</p>\n<p>VMware ToolsのアップグレードはESXiをアップグレード後、仮想マシンを起動させた時にアップグレードが可能な場合、WebUIの当該仮想マシンの項目にメッセージが表示されます。</p>\n<img src=\"/new-technology/2021/12/25/esxi-upgrade/vmwaretools.png\" class=\"\" width=\"640\" title=\"alt\">\n<p>アップグレードしたESXi7.0VMware Toolsよりも新しいバージョンがある場合は以下のように表示されます。</p>\n<img src=\"/new-technology/2021/12/25/esxi-upgrade/vmwaretools2.png\" class=\"\" width=\"640\" title=\"alt\">\n<p>この場合はWebUIで左ペインの<mark class=\"label primary\">仮想マシン</mark>で対象仮想マシンを選択し、<mark class=\"label primary\">アクション</mark>メニュー→<mark class=\"label primary\">ゲストOS</mark>から<mark class=\"label primary\">VMware Toolsのアップグレード</mark>を実行します。</p>\n<p>詳細は以下の内容を参照してください。</p>\n<blockquote>\n<p>VMware Tools のアップグレード<br> <a href=\"https://docs.vmware.com/jp/VMware-Tools/11.3.0/com.vmware.vsphere.vmwaretools.doc/GUID-A2491004-1C67-4E14-B47B-807E20C19108.html\">https://docs.vmware.com/jp/VMware-Tools/11.3.0/com.vmware.vsphere.vmwaretools.doc/GUID-A2491004-1C67-4E14-B47B-807E20C19108.html</a></p>\n</blockquote>\n<p>VMware Toolsを最新にした後、仮想マシンハードウェアをアップグレードすることができます。ただし、下記のドキュメントに注意書きがある通り、新しいハードウェアバージョンの付属機能が必要な場合のみ実行することとあり、これはESXiのアップグレードに対して必須事項ではありません。</p>\n<blockquote>\n<p>仮想マシンの互換性の手動アップグレード<br> <a href=\"https://docs.vmware.com/jp/VMware-vSphere/7.0/com.vmware.vsphere.vm_admin.doc/GUID-60768C2F-72E1-42E0-8A17-CA76849F2950.html\">https://docs.vmware.com/jp/VMware-vSphere/7.0/com.vmware.vsphere.vm_admin.doc/GUID-60768C2F-72E1-42E0-8A17-CA76849F2950.html</a></p>\n</blockquote>\n<div class=\"note warning\"><ul>\n<li>仮想マシン ハードウェアをアップグレードすると、一部のアプリケーションまたはオペレーティング システムが適切に動作しなくなることがあります。ハードウェア バージョンのアップグレードは、新しいハードウェア バージョンの付属機能が必要な場合のみ実行します。</li>\n<li>Microsoft Windows 仮想マシンで VMware Tools をアップグレードする前に互換性をアップグレードすると、仮想マシンのネットワーク設定が失われることがあります。</li>\n</ul>\n</div>\n\n<p>この操作は以下の通りWebUIで左ペインの<mark class=\"label primary\">仮想マシン</mark>で対象仮想マシンを選択し、<mark class=\"label primary\">アクション</mark>メニューから<mark class=\"label primary\">仮想マシンの互換性のアップグレード</mark>を実行します。</p>\n<img src=\"/new-technology/2021/12/25/esxi-upgrade/upgrade-vm.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<h2 id=\"ESXi6-7のダウングレード（ご参考）\"><a href=\"#ESXi6-7のダウングレード（ご参考）\" class=\"headerlink\" title=\"ESXi6.7のダウングレード（ご参考）\"></a>ESXi6.7のダウングレード（ご参考）</h2><p>（この章は、ESXi6.7からESXi7.0Update2aへのアップグレード時にエラーが発生するケースがあり記載しています）</p>\n<p>ESXi6.7のパッチバージョンがESXi670-202111001の場合、ESXi7.0Update2aへのアップグレードが行えません。</p>\n<img src=\"/new-technology/2021/12/25/esxi-upgrade/err.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p><code>VMW_bootbank_vmkusb_0.1-4vmw.670.3.159.18828794</code>と依存関係の問題があるとのことです。</p>\n<p>対策としてESXi6.7のひとつ前のパッチリリースに戻すことを検討します。ESXiホストを再起動し、起動中にShift+’R’キーを押すことによって1つ前のバージョンに戻せます。</p>\n<blockquote>\n<p>VMware ESXi を前のバージョンに戻す (1033604)<br> <a href=\"https://kb.vmware.com/s/article/1033604?lang=ja\">https://kb.vmware.com/s/article/1033604?lang=ja</a></p>\n</blockquote>\n<blockquote>\n<p>Hypervisor のプログレス バーの読み込みが開始されたら、Shift+R を押します。(これはバーが表示されたロード後ではなく、ロード中に実行する必要があります。コマンドを実行するタイミングを逃さないよう、”system is preparing to boot” 表示中に Shift+R を繰り返し押すことをお勧めいたします)。</p>\n</blockquote>\n<p> 私の環境では以下のように表示されました。</p>\n<img src=\"/new-technology/2021/12/25/esxi-upgrade/rollback.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p>戻す対象のビルド番号は17700523と表示されています。これは、Patch Release ESXi670-202103001であり、2021年3月18日にリリースされているESXi6.7の一つ前のパッチリリースです。これはリリース日付が逆転しておらず、うまくいきそうです。ここでロールバックを実行します。</p>\n","categories":["Software"],"tags":["ESXi"]},{"title":"無償版ESXiの高度なバックアップ","url":"/new-technology/2021/03/06/esxi-nakivo/","content":"<img src=\"/new-technology/2021/03/06/esxi-nakivo/Monitor2.png\" class=\"\" title=\"alt\">\n\n<p class=\"onepoint\">この記事で実現すること</p>\n\n<p>無償版ESXi6.7（VMware vSphere Hypervisor6.7）はvStorage APIが使えないため、有名なESXiのバックアップ製品は大半が利用できません。vStorage APIを使わないGUI製品であるNakivo Backup Free Editionを用いてXG Firewallなどの仮想マシンがバックアップできます。GUIによる設定、定期的なバックアップ、差分バックアップをサポートします。</p>\n<span id=\"more\"></span>\n\n<h2 id=\"無償版ESXiのバックアップ環境\"><a href=\"#無償版ESXiのバックアップ環境\" class=\"headerlink\" title=\"無償版ESXiのバックアップ環境\"></a>無償版ESXiのバックアップ環境</h2><p>「<a href=\"/new-technology/2020/10/11/esxi-backup/\" title=\"VMware ESXiの仮想マシンをバックアップする\">VMware ESXiの仮想マシンをバックアップする</a>」の記事では、無償版ESXiのバックアップについて説明していますが、コマンドラインベースであることやUEFIシステムによってCronで定期的なバックアップが行えない制約がありました。一方、GUIによるバックアップ製品は多くの製品があります。「ずっと無償」などの言葉が並んでいますが、無償というのはバックアップ製品が無償という事であり、無償ESXiのバックアップは取れず、色々捜しつつもGUI製品には殆どめぐり合えないというのが実態です。昨年夏に私が利用しているNASのQNAPでも無償のESXiバックアップ製品が発表という事で少しときめいたのですが、Inventoryには仮想マシンが表示されるものの結局はvStorage APIが必要であり、バックアップは行えませんでした。</p>\n<h2 id=\"Nakivo-Backupの無償の意味\"><a href=\"#Nakivo-Backupの無償の意味\" class=\"headerlink\" title=\"Nakivo Backupの無償の意味\"></a>Nakivo Backupの無償の意味</h2><p><strong>Nakivo backup Free Edition</strong>は無償のオープンシステムではなく、あくまでビジネス向けに収益をあげるモデルです。無償ライセンスは1年単位となっています。10以下の仮想マシンのバックアップなど制約はありますが、個人向けには十分な内容です。しかし、あくまで無償版はお試しという位置付けであり実際は個人向けでも正式なライセンスを購入してほしいようです。製品をダウンロードすると、米国の営業担当から電話がかかってきました<span class=\"github-emoji\" alias=\"frowning\" style=\"\" fallback-src=\"https://github.githubassets.com/images/icons/emoji/unicode/1f626.png?v8\">&#x1f626;</span>。私はメールでやりとりし、とりあえず1年間はこの無償版を使いますよという事になりましたが<sup><a href=\"#note1\"><strong>[1]</strong></a></sup>、次回は有償版のライセンスにて更新するかどうするかは少し値段の面で悩んでいるところです。ライセンス費用も公開されていますが、マザーボードに物理接続されたCPUあたり＄99&#x2F;年という事です。ビジネス用途であれば極めて安価ですが、個人向けとしては悩みどころの価格帯です。また、ghettoVCBで事足りているというのもあります。</p>\n<p>他の無償製品に目を向けてみると、<strong>Unitrends Free</strong>で無償版ESXiの仮想マシンがバックアップ可能ですが、これはエージェントモデルで、仮想マシンそのものにエージェントをインストールし、エージェントが自分自身のOSのバックアップを取得する事になります。これはLinuxやWindowsの仮想マシンには使えますが、XG Firewallなど他のモジュールインストールを認めていない仮想マシンはバックアップする事はできません。</p>\n<blockquote>\n<p>Nakivo backup Free Edition<br> <a href=\"https://www.nakivo.com/resources/download/free-edition/\">https://www.nakivo.com/resources/download/free-edition/</a><br>Unitrends Free<br> <a href=\"https://www.unitrends.com/landing/free-backup-vmware-hyper-v-software\">https://www.unitrends.com/landing/free-backup-vmware-hyper-v-software</a></p>\n</blockquote>\n<h2 id=\"Nakivo-Backupの必要環境\"><a href=\"#Nakivo-Backupの必要環境\" class=\"headerlink\" title=\"Nakivo Backupの必要環境\"></a>Nakivo Backupの必要環境</h2><p>ESXiの仮想マシンをバックアップするにあたり、スケジューリングによるバックアップがまずは期待されるところです。常時起動したままのOS、またはNASなどが適任です。対象OSは以下の通りです。なお、私のブログのテーマと関連するためESXiを前提として記事を書いていますが、Hyper-Vのバックアップも可能です。</p>\n<ul>\n<li>Windows</li>\n<li>Linux</li>\n<li>Esxiの仮想マシンとして</li>\n<li>NAS(ASUSTOR,NETGEAR,QNAP,Synology,WesternDigital)</li>\n</ul>\n<p>私はQNAP上にインストールしています。ESXiの仮想マシン自体にインストールする事も可能ですが、バックアップデータ自体はNASをはじめとする別筐体のストレージにバックアップされる事をお勧めします。</p>\n<h2 id=\"ダウンロードおよびインストール\"><a href=\"#ダウンロードおよびインストール\" class=\"headerlink\" title=\"ダウンロードおよびインストール\"></a>ダウンロードおよびインストール</h2><p>上記のNakivoサイトからダウンロードしてください。</p>\n<img src=\"/new-technology/2021/03/06/esxi-nakivo/nakivo1.png\" class=\"\" title=\"alt\">\n<p>ダウンロードにはビジネスで利用しているメールアドレスが必要になります。昔はgmailやicloudメールが使えましたが、現在は認められないようで会社勤めの方であれば会社のメールアカウントを入力必要です。私は会社のメアドを登録するのは躊躇して登録していませんが、エンジニアの方であれば、一般的には自己啓発という名目もあり構わないと考えられるでしょうか。<br>インストール自体は難しいものではありません。以下のURLから各環境に応じた手順でセットアップを行います。</p>\n<blockquote>\n<p>Nakivo User Guide<br> <a href=\"https://helpcenter.nakivo.com/display/NH/Installing+NAKIVO+Backup+and+Replication\">https://helpcenter.nakivo.com/display/NH/Installing+NAKIVO+Backup+and+Replication</a></p>\n</blockquote>\n<p>ポイントは以下の2点です。</p>\n<ol>\n<li>ユーザー名、メールアドレスの登録を行います。ここのメアドはバックアップ結果などの通知のために使うものでダウンロード時に用いたビジネスアカウントメールとは異なります。</li>\n</ol>\n<img src=\"/new-technology/2021/03/06/esxi-nakivo/account.png\" class=\"\" title=\"alt\">\n\n<ol start=\"2\">\n<li>Transportarという複数のチャネルでバックアップを吸い上げる機能がありますが、この選択がある場合は、”Transportar only”で構いません</li>\n</ol>\n<img src=\"/new-technology/2021/03/06/esxi-nakivo/transporter.png\" class=\"\" width=\"480\" title=\"alt\">\n\n<p>セットアップ完了後、Nakivo BackupをインストールしたマシンのTCP4443ポートにブラウザから接続します。</p>\n<h2 id=\"Nakivo-BackupからESXiのインベントリ確認\"><a href=\"#Nakivo-BackupからESXiのインベントリ確認\" class=\"headerlink\" title=\"Nakivo BackupからESXiのインベントリ確認\"></a>Nakivo BackupからESXiのインベントリ確認</h2><p>Nakivo BackupからFree版のESXiに接続するにはESXiのHTTPS(Port443)、SSH(Port22)に接続できる必要があります。ESXiのSSHの有効化については「<a href=\"/new-technology/2020/10/11/esxi-backup/\" title=\"VMware ESXiの仮想マシンをバックアップする\">VMware ESXiの仮想マシンをバックアップする</a>」の記事を参照してください。また、SSHの認証はパスワード認証となり、公開鍵認証は使えません。</p>\n<p><code>https:nakivo-host:4443</code>に接続しログインします</p>\n<img src=\"/new-technology/2021/03/06/esxi-nakivo/nakivo2.png\" class=\"\" title=\"alt\">\n\n<p>ログイン後の全体像は以下のようになっています。</p>\n<img src=\"/new-technology/2021/03/06/esxi-nakivo/nakivo3.png\" class=\"\" title=\"alt\">\n\n<p>初期セットアップとして、左ペインメニューの<mark class=\"label primary\">Settings</mark>からESXiに接続し仮想マシンの一覧を取得します</p>\n<img src=\"/new-technology/2021/03/06/esxi-nakivo/nakivo4.png\" class=\"\" width=\"640\" title=\"alt\">\n\n<p>テストドライブとしてはrootで接続確認を行うでしょうけれども、恒久的にこのプロダクトを利用される場合は、「<a href=\"/new-technology/2021/01/23/esxi-security/\" title=\"ESXi(無償版)のセキュリティを高める\">ESXi(無償版)のセキュリティを高める</a>」の記事で示したように、SSHを開けたままにする事になるので、ESXiへのSSH接続可能なIPアドレスを制限する事、nakivo用の専用ユーザーアカウントをESXiに作成する事をお勧めします。接続が無事行えるとInventoryに仮想マシンの一覧が表示されます。</p>\n<h2 id=\"Backup実行とスケジューリング\"><a href=\"#Backup実行とスケジューリング\" class=\"headerlink\" title=\"Backup実行とスケジューリング\"></a>Backup実行とスケジューリング</h2><p>ダッシュボードからジョブの設定を行います。左ペインの<mark class=\"label primary\">Dashboard</mark>から<mark class=\"label primary\">VMWare backup job</mark>ー<mark class=\"label primary\">Create</mark>ー<mark class=\"label primary\">VMWare vSphere backup job</mark>をクリックします。</p>\n<img src=\"/new-technology/2021/03/06/esxi-nakivo/nakivo5.png\" class=\"\" title=\"alt\">\n\n<p>設定の流れとしては以下の通りです。</p>\n<table>\n<thead>\n<tr>\n<th>項目</th>\n<th>設定内容</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>1.Source</td>\n<td>接続先のESXiから仮想マシンを選択します</td>\n</tr>\n<tr>\n<td>2.Destination</td>\n<td>バックアップするリポジトリとしての場所を指定します（任意）</td>\n</tr>\n<tr>\n<td>3.Schedule</td>\n<td>定期的なバックアップの指定をします</td>\n</tr>\n<tr>\n<td>4.Retention</td>\n<td>バックアップの世代管理をします</td>\n</tr>\n<tr>\n<td>5.Options</td>\n<td>ジョブ通知のメールやバックアップ形式を指定します</td>\n</tr>\n</tbody></table>\n<p>設定のポイントは以下の通りです。特に設定が難しいものはないでしょう。</p>\n<p>“Schedule” この例では月曜日の朝6時にバックアップを開始します</p>\n<img src=\"/new-technology/2021/03/06/esxi-nakivo/nakivo6.png\" class=\"\" width=\"480\" title=\"alt\">\n\n<p>“Retention” この例では過去5世代のバックアップを確保し、月次バックアップを過去2か月確保します</p>\n<img src=\"/new-technology/2021/03/06/esxi-nakivo/nakivo7.png\" class=\"\" width=\"480\" title=\"alt\">\n\n<p>“Options” この例では差分バックアップの指定とジョブの通知メールを指定しています</p>\n<img src=\"/new-technology/2021/03/06/esxi-nakivo/nakivo8.png\" class=\"\" width=\"480\" title=\"alt\">\n\n<p>差分バックアップについてはESXiの機能であるCBT(Changed Block Tracking)の機能を使えます。バックアップのストレージと時間の圧縮効果があるので設定をお勧めします。これは次の章で説明します。</p>\n<p>Nakivo Backupのユーザーマニュアルの詳細は以下を参照してください。</p>\n<blockquote>\n<p>NAKIVO Backup &amp; Replication USER GUIDE<br> <a href=\"https://helpcenter.nakivo.com/display/NH/User+Guide\">https://helpcenter.nakivo.com/display/NH/User+Guide</a></p>\n</blockquote>\n<h2 id=\"ESXiのChanged-Block-Tracking\"><a href=\"#ESXiのChanged-Block-Tracking\" class=\"headerlink\" title=\"ESXiのChanged Block Tracking\"></a>ESXiのChanged Block Tracking</h2><p>ESXiの機能であるChanged Block Trackingは仮想マシンが稼働していて前回バックアップしたものから未更新のディスクブロックをスキップして差分のみバックアップする機能です。途中で別のバックアップ製品によるバックアップ、例えばghettoVCBなどでバックアップされると、次回のNakivo BackupによるCBTはフルバックアップを行います。</p>\n<p>最初に仮想マシンがインストールされているディスクを調べ、そのSCSI-IDを確認します。<br>ESXi管理画面の仮想マシンを選択し右クリックして<mark class=\"label primary\">設定の編集</mark>をクリックします。</p>\n<img src=\"/new-technology/2021/03/06/esxi-nakivo/esxi.png\" class=\"\" width=\"640\" title=\"alt\">\n\n\n<mark class=\"label primary\">ハードディスク</mark>の詳細を開き、<mark class=\"label primary\">コントローラの場所</mark>でSCSI-IDを確認します（SCSI(0:0)など）。\n\n<ol>\n<li>仮想マシンを停止します。</li>\n<li>ESXi管理画面の仮想マシンを右クリックして、<mark class=\"label primary\">設定の編集</mark>をクリックします。</li>\n<li><mark class=\"label primary\">仮想マシンオプション</mark>タブをクリックします。</li>\n<li><mark class=\"label primary\">詳細</mark>セクションを開き <mark class=\"label primary\">設定パラメータ</mark>の<mark class=\"label primary\">設定の編集</mark>をクリックします。<mark class=\"label primary\">設定パラメータ</mark>ダイアログが開きます。</li>\n<li><mark class=\"label primary\">パラメータの追加</mark>をクリックします。</li>\n<li>ctkEnabledパラメータを追加して、その値をtrueに設定します。</li>\n<li><mark class=\"label primary\">パラメータの追加</mark>をクリックし、scsi0:0.ctkEnabledを追加して、その値をtrueに設定します（環境に合わせてscsi0:0の内容は変更してください）。</li>\n<li>OKボタンをクリックし設定を完了させます。</li>\n<li>仮想マシンを起動します。</li>\n<li>SSHでESXiに入り、仮想マシンが配置されているディレクトリで、<code>&quot;vm-name&quot;-ctk.vmdk</code>ファイルがあることを確認します。</li>\n</ol>\n<p>CBTを無効にする場合はこの逆の手順、ctkEnabledの値をfalseに設定します。<br>手順の詳細についてはVMWareのガイドを参照してください。</p>\n<blockquote>\n<p>VMware 仮想マシン上の変更ブロックのトラッキング（CBT） (1020128)<br> <a href=\"https://kb.vmware.com/s/article/1031873?lang=ja&amp;queryTerm=changed+block+tracking\">https://kb.vmware.com/s/article/1031873?lang=ja&amp;queryTerm=changed+block+tracking</a></p>\n</blockquote>\n<h2 id=\"定期的なバックアップをお勧めします\"><a href=\"#定期的なバックアップをお勧めします\" class=\"headerlink\" title=\"定期的なバックアップをお勧めします\"></a>定期的なバックアップをお勧めします</h2><p>この製品もghettoVCBと同様にスナップショットをとってからバックアップに入りますので、制約はほとんど感じる事がありません。せいぜい数ヶ月に1度のESXiパッチ適用の前に手動でバックアップを取る事くらいでしょうか。不慮の事故に備えて定期的なバックアップを取得される事をお勧めします。最近はOSもIoTもパッチの自動更新機能が充実してきました。多少意識する事としてはパッチ適用による自動リブートなどと、このバックアップとの時間帯が重ならないように留意する事くらいでしょうか。それでもジョブ通知があるのでバックアップ失敗が放置される懸念もありません。</p>\n<p><small id=\"note1\"><strong>[1]</strong><br>営業担当曰く、「気に入ったら買って欲しい」との事でした。こちらはそこまでパワーユーザーじゃないからというやりとりのあと、こちらから「目的から外れるのならソフトウェアを削除するけど、そうした方が良い？」という質問には明確な回答がありませんでした。もちろん、ソフトウェアで収益を上げている事はビジネスとして当然の行為で、良いソフトウェアには適切な値段があるべきですが、できればそのあたりをWebサイトに明記されると良いのになと感じたところです。しかしホームユーザーとして悩む絶妙な価格設定<span class=\"github-emoji\" alias=\"sweat_smile\" style=\"\" fallback-src=\"https://github.githubassets.com/images/icons/emoji/unicode/1f605.png?v8\">&#x1f605;</span><br></small></p>\n","categories":["Software"],"tags":["ESXi","XG Firewall"]},{"title":"XG FirewallでIPSのポリシーを確認する","url":"/new-technology/2020/05/04/ips-policy/","content":"<p class=\"onepoint\">この記事で実現すること</p>\nXG FirewallのIPSポリシーは複数存在しますが、それぞれの内容について説明します。\n\n<span id=\"more\"></span>\n\n<h2 id=\"XGのIPSポリシーについて\"><a href=\"#XGのIPSポリシーについて\" class=\"headerlink\" title=\"XGのIPSポリシーについて\"></a>XGのIPSポリシーについて</h2><p>Intrusion Prevension System(IPS)は侵入防御を意味し、サイバー攻撃から内部のホストを防御します。「<a href=\"/new-technology/2020/03/14/rule-policy2/\" title=\"XG Firewall v18のルールを作成する\">XG Firewall v18のルールを作成する</a>」では、IPS Policyの選択として、”lantowan_general”を設定しました。初期セットアップではあまり十分な説明をしていませんでしたので、改めて中身を説明します。XGのIPSポリシーは、左ペインメニューの<mark class=\"label primary\">侵入防御</mark>の<mark class=\"label primary\">IPSポリシー</mark>から確認できます。デフォルトで登録されているものには、以下の内容があります。</p>\n<ul>\n<li>DMZ TO LAN</li>\n<li>DMZ TO WAN</li>\n<li>LAN TO DMZ</li>\n<li>LAN TO WAN</li>\n<li>WAN TO DMZ</li>\n<li>WAN TO LAN</li>\n<li>dmzpolicy</li>\n<li>generalpolicy</li>\n<li>lantowan general</li>\n<li>lantowan strict</li>\n</ul>\n<p>前半の6つはそれぞれの接続形態に合わせたポリシーです。LAN TO WANでは、ブラウザやアプリからインターネットに接続する場合の攻撃を想定した防御ポリシーとなっています。XGの左ペインメニューの<mark class=\"label primary\">侵入防御</mark>から<mark class=\"label primary\">IPSポリシー</mark>を選択し、さらに”LAN TO WAN”を選択すると、以下の画面が表示されます。</p>\n<img src=\"/new-technology/2020/05/04/ips-policy/lanwan.png\" class=\"\" title=\"alt\">\n\n<p>このポリシーは、<mark class=\"label primary\">カテゴリ</mark>、<mark class=\"label primary\">重要度</mark>、<mark class=\"label primary\">プラットフォーム</mark>、<mark class=\"label primary\">対象</mark>というそれぞれのメニューに分かれています。これはブラウザなどのクライアントを対象として、WindowsやLinuxのクライアントOSが確認できます。macOSはありませんが、実際に”All Client”として組み込まれているようです。このポリシーはどのような意図で作成されたのかは不明です。なぜWindowsとLinuxだけを切り出しているのでしょうか。さらに、前半6つの”DMZ TO LAN”〜”WAN TO LAN”ポリシーはカスタマイズ出来ません。”dmzpolicy”〜”lantowan strict”の4つのポリシーの中身はフィルタの種類の名前が異なっていますが、7126個あるXGのIPSポリシーが全て選択されており、4つのポリシーの中身は全く同じで何を選んでも変わりません。昔からカスタマイズ前提で用意されており、明確な違いは無いというのが実態のようです。</p>\n<p>明らかに不要なポリシーを外せばパフォーマンスアップするという期待がありますが、XGでは既にパフォーマンス上工夫されていて、ポリシーを絞ったとしても殆ど効果はありません。XG v18の”Xstream Network Flow Fast Path”というトラフィック検査の高速化が功を奏しているのかもしれません。</p>\n<p>XGのIPSはオープンソースのセキュリティソフトであるSnortを使っているようです。私の検証では、下手にポリシーを絞り込むとかえってパフォーマンスが出なくなるように見えます（何10回も繰り返し統計をとったわけではありません）。”lantowan general”などの絞り込まないポリシーで全く不都合がないため、このままフィルターせずに利用しています。</p>\n<h2 id=\"脆弱性をXGで防御すること\"><a href=\"#脆弱性をXGで防御すること\" class=\"headerlink\" title=\"脆弱性をXGで防御すること\"></a>脆弱性をXGで防御すること</h2><p>話は変わりますが、Webサーバーのシェアは2017年に過半数を占めていたApacheは2021年10月には31.0％までシェアを落としています。代わりに高速性が売りのnginxが、足元33.9%でシェア1位を獲得しています。</p>\n<blockquote>\n<p>Historical quarterly trends in the usage statistics of web servers<br> <a href=\"https://w3techs.com/technologies/history_overview/web_server/ms/q\">https://w3techs.com/technologies/history_overview/web_server/ms/q</a></p>\n</blockquote>\n<p>「パッチが多いのでアパッチ」と揶揄される事もありますが、XGのIPSにも253個のアパッチ用ポリシーがあります。一方、nginxは、まだ歴史が浅いという事もありますが、XGのポリシーを検索してみると2つしか見つかりません。全ての製品の脆弱性をXGがカバー出来るかといえば難しく、やはり利用しているプロダクトの製品パッチを適用するのが本筋です。</p>\n<p>再びホームユーザーとしての話に戻すと、原則、Windows10やmacOS、スマホは脆弱性に対するパッチとして自動更新の機能があるので、それを行うのが確実です。むしろ危ないのは自動更新にしていないOSや、IoT機器・無線ルーター・NAS・家電などです。昨今、数多くの脆弱性が発見され、パッチが出ている現況においては、IPSに全ての製品の脆弱性の保護を頼るのは厳しいと考えます。きちんとベンダーからの通知システムを活用し、適切なパッチを適用する事が何よりも重要です。私はIT機器やソフトウェアを導入する場合には、こういったパッチが迅速に提供されるもの、また自動更新や通知の仕組みがあるものを選定するようにしています。そういう意味では、XGのIPSはあくまで補助的に使い、日常ログの確認も併せて行いたいところです。</p>\n<p>XGのIPSはこれだけにの機能に限らず、レイヤ7のファイアウォール機能として立派に役目を果たしてくれます。怪しいサイトに接続しない事は本人の心がけも重要ですが、XGである程度そういったサイトを遠ざける事も出来ます。2要素認証のように、面倒ではありますが複数の管理策を重ねる事と、日頃のログの確認や情報をウォッチする事が防御を高める事になります。</p>\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"IPv6のULAをIPv4より優先する","url":"/new-technology/2021/06/26/ipv6-first/","content":"\n<p class=\"onepoint\">この記事で実現すること</p>\n\n<p>Firewallなどルーターの内側（LAN）がユニークローカルアドレス（ULA）となるネットワーク構成、かつ、NATでインターネットに接続しているIPv4、IPv6のデュアルスタック環境では通常IPv4が優先されます。クライアント側のWindowsおよびLinuxではシステム設定変更を行う事でULA環境下でもIPv6を優先させる事ができます。</p>\n<span id=\"more\"></span>\n\n<h2 id=\"IPv4を優先するULA\"><a href=\"#IPv4を優先するULA\" class=\"headerlink\" title=\"IPv4を優先するULA\"></a>IPv4を優先するULA</h2><p>現時点でIPv6&#x2F;IPv4の優先度を確認する方法の1つは、<strong>The KAME project</strong>にブラウザでアクセスし、亀が踊っていればIPv6接続、動かなければIPv4接続という事になります。プロバイダのWebサイトの右上に「IPv6（IPv4）で接続しています」との記載も見かけます。</p>\n<blockquote>\n<p>The KAME project<br> <a href=\"http://www.kame.net/\">http://www.kame.net</a></p>\n</blockquote>\n<p>ブラウザやOSがIPv6優先であっても、ULAそのものはインターネットにルーティングしないという大前提があります。IPv6において、NATは一般的に推奨されない構成でもあります。</p>\n<p>OSの設定を変更することで、ULAを使いながらIPv6優先に変更できます。</p>\n<h2 id=\"IPv6優先設定\"><a href=\"#IPv6優先設定\" class=\"headerlink\" title=\"IPv6優先設定\"></a>IPv6優先設定</h2><p>IPv6やIPv4の通信優先度を決定するPrefixポリシーというものがあり、これをIPv6優先にします。ネットワークのグループ（Prefix）毎に優先度を決めます。Windows、Linuxで設定は異なりますが、概念は同じです。残念ながらmacOS（Catalina）やスマホについては、この設定を見つける事ができませんでした。</p>\n<h3 id=\"Prefixポリシーの説明\"><a href=\"#Prefixポリシーの説明\" class=\"headerlink\" title=\"Prefixポリシーの説明\"></a>Prefixポリシーの説明</h3><p>Windowsの場合、このPrefixポリシーを表示させると以下の表示がされます。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">C:\\&gt; netsh interface ipv6 show prefixpolicies</span><br><span class=\"line\"></span><br><span class=\"line\">優先順位   ラベル  プレフィックス</span><br><span class=\"line\">----------  -----  --------------------------------</span><br><span class=\"line\">        50      0  ::ffff:0:0/96</span><br><span class=\"line\">        40      1  ::1/128</span><br><span class=\"line\">        30      2  ::/0</span><br><span class=\"line\">        20      3  2002::/16</span><br><span class=\"line\">         5      5  2001::/32</span><br><span class=\"line\">         3     13  fc00::/7</span><br><span class=\"line\">         1     11  fec0::/10</span><br><span class=\"line\">         1     12  3ffe::/16</span><br><span class=\"line\">         1      4  ::/96</span><br></pre></td></tr></table></figure>\n\n<p>各プレフィックスの説明は以下の通りです。</p>\n<blockquote>\n<table>\n<thead>\n<tr>\n<th><strong>Prefix</strong></th>\n<th><strong>説明</strong></th>\n</tr>\n</thead>\n<tbody><tr>\n<td>::1&#x2F;128</td>\n<td>Loopback</td>\n</tr>\n<tr>\n<td>::&#x2F;0</td>\n<td>グローバルスコープ</td>\n</tr>\n<tr>\n<td>2002::&#x2F;16</td>\n<td>6to4</td>\n</tr>\n<tr>\n<td>::&#x2F;96</td>\n<td>IPv4互換アドレス（廃止）</td>\n</tr>\n<tr>\n<td>::ffff:0:0&#x2F;96</td>\n<td>IPv4マップドアドレス</td>\n</tr>\n<tr>\n<td>fec0::&#x2F;10</td>\n<td>サイトローカルアドレス（廃止）</td>\n</tr>\n<tr>\n<td>fc00::&#x2F;7</td>\n<td>ユニークローカルアドレス</td>\n</tr>\n<tr>\n<td>2001:0::&#x2F;32</td>\n<td>Teredo</td>\n</tr>\n</tbody></table>\n</blockquote>\n<p>IPv4マップドアドレスは、IPv6の世界でIPv4を表現したものです。具体的には、<code>::ffff:192.168.0.1</code>という形となり、IPv6アドレスの前半64ビットは0、65〜96ビットの32ビットが<code>ffff</code>、97ビット〜128ビットの32ビットがIPv4アドレスとなります。<br>“グローバルスコープ”は、0ビットのマスクなので全てのアドレスにマッチします。インターネットのIPv6アドレスであるグローバルユニキャストアドレス（GUA）は<code>2000::/3</code>ですが、このPrefixポリシー上ではグローバルスコープが該当します。<br><code>fc00::/7</code>はおなじみULAです。</p>\n<p>設定のポイントは2箇所です。</p>\n<ul>\n<li>優先度は数字が大きいものほど優先度が高く、IPv6 Loopback → ULA → グローバルスコープ → IPv4マップドアドレスの順に並べます</li>\n<li>ULAからインターネット宛（GUA）にルーティングを認めるために、ネットワーク単位に割り振られているラベルについてULAとグローバルスコープのラベルを同じ数字にします</li>\n</ul>\n<h3 id=\"Windows10\"><a href=\"#Windows10\" class=\"headerlink\" title=\"Windows10\"></a>Windows10</h3><ol>\n<li>コマンドプロンプトを<strong>管理者権限</strong>で実行します。</li>\n<li>出力結果は環境によって異なりますが、概ね以下のように出力されます。</li>\n</ol>\n <figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">C:\\&gt;netsh interface ipv6 show prefixpolicies</span><br><span class=\"line\">アクティブ状態を照会しています...</span><br><span class=\"line\"></span><br><span class=\"line\">優先順位   ラベル  プレフィックス</span><br><span class=\"line\">----------  -----  --------------------------------</span><br><span class=\"line\">        50      0  ::ffff:0:0/96</span><br><span class=\"line\">        40      1  ::1/128</span><br><span class=\"line\">        30      2  ::/0</span><br><span class=\"line\">        20      3  2002::/16</span><br><span class=\"line\">         5      5  2001::/32</span><br><span class=\"line\">         3     13  fc00::/7</span><br><span class=\"line\">         1     11  fec0::/10</span><br><span class=\"line\">         1     12  3ffe::/16</span><br><span class=\"line\">         1      4  ::/96</span><br></pre></td></tr></table></figure>\n\n<ol start=\"3\">\n<li><p>IPv6(::&#x2F;0、fc00::&#x2F;7) &gt; IPv4(::ffff:0:0&#x2F;96)となるよう、管理者権限で以下のコマンドを1行づつ投入します。</p>\n <figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">netsh interface ipv6 set prefixpolicy ::ffff:0:0/96 25 0</span><br><span class=\"line\">netsh interface ipv6 set prefixpolicy ::1/128 40 1</span><br><span class=\"line\">netsh interface ipv6 set prefixpolicy ::/0 30 2</span><br><span class=\"line\">netsh interface ipv6 set prefixpolicy 2002::/16 20 3</span><br><span class=\"line\">netsh interface ipv6 set prefixpolicy 2001::/32 5 5</span><br><span class=\"line\">netsh interface ipv6 set prefixpolicy fc00::/7 35 2</span><br><span class=\"line\">netsh interface ipv6 set prefixpolicy fec0::/10 1 11</span><br><span class=\"line\">netsh interface ipv6 set prefixpolicy 3ffe::/16 1 12</span><br><span class=\"line\">netsh interface ipv6 set prefixpolicy ::/96 1 4</span><br></pre></td></tr></table></figure>\n <div class=\"note info\"><p>表示されるラベルおよび優先度は環境によって異なる場合があります。</p>\n</div>\n</li>\n<li><p>設定内容を改めて確認します。</p>\n<img src=\"/new-technology/2021/06/26/ipv6-first/prefix.png\" class=\"\" width=\"480\" title=\"alt\"></li>\n</ol>\n<p>これで設定完了です。OSを再起動して設定が変わっていない事、IPv6が優先されている事を確認してください。設定をやり直す場合は、PrefixPolicyをリセットしてからOSを再起動します。</p>\n<p><code>netsh interface ipv6 reset</code></p>\n<h3 id=\"Linux-ubuntu\"><a href=\"#Linux-ubuntu\" class=\"headerlink\" title=\"Linux(ubuntu)\"></a>Linux(ubuntu)</h3><p>Linux（ubuntu）の場合は、<code>/etc/gai.conf</code>に設定ファイルがあります。</p>\n<ol>\n<li><p>viなどでファイルを開きます。<code>sudo vi /etc/gai.con</code></p>\n</li>\n<li><p>ファイルの中身は全てコメントアウトされています。plefixpolicyは以下の通りです。</p>\n <figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">label   &lt;mask&gt;   &lt;value&gt;</span><br><span class=\"line\"><span class=\"comment\">#    Add another rule to the RFC 3484 label table.  See section 2.1 in</span></span><br><span class=\"line\"><span class=\"comment\">#    RFC 3484.  The default is:</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\">#label ::1/128       0</span></span><br><span class=\"line\"><span class=\"comment\">#label ::/0          1</span></span><br><span class=\"line\"><span class=\"comment\">#label 2002::/16     2</span></span><br><span class=\"line\"><span class=\"comment\">#label ::/96         3</span></span><br><span class=\"line\"><span class=\"comment\">#label ::ffff:0:0/96 4</span></span><br><span class=\"line\"><span class=\"comment\">#label fec0::/10     5</span></span><br><span class=\"line\"><span class=\"comment\">#label fc00::/7      6</span></span><br><span class=\"line\"><span class=\"comment\">#label 2001:0::/32   7</span></span><br></pre></td></tr></table></figure>\n<p> つまり、コメントされた状態がデフォルト設定であり、カスタマイズが必要な場合はコメントを外して対応できるようになっています。</p>\n</li>\n<li><p>上記の8行あるplefixpolicyについて<strong>すべてのコメントを外し</strong>、ULA<code>fc00::/7</code>のラベル6を<code>::/0</code>のラベルである1に修正します。</p>\n</li>\n<li><p>続いて、このファイルのさらに下を見ていくと優先度の項目が並びます。</p>\n <figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#precedence  ::1/128       50</span></span><br><span class=\"line\"><span class=\"comment\">#precedence  ::/0          40</span></span><br><span class=\"line\"><span class=\"comment\">#precedence  2002::/16     30</span></span><br><span class=\"line\"><span class=\"comment\">#precedence ::/96          20</span></span><br><span class=\"line\"><span class=\"comment\">#precedence ::ffff:0:0/96  10</span></span><br></pre></td></tr></table></figure>\n<p> ネットワーク（Prefix）毎に優先度を決めています。Windowsと設定する項目の意味は同じです。</p>\n</li>\n<li><p>上記5行のprecedendeのコメントを外し、ULAのリストを加えます。Loopback→→ULA→<code>::/0</code>→IPv4の並びにします。修正後は以下になります。</p>\n <figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">label ::1/128       0</span><br><span class=\"line\">label ::/0          1</span><br><span class=\"line\">label fc00::/7      1</span><br><span class=\"line\">label 2002::/16     2</span><br><span class=\"line\">label ::/96         3</span><br><span class=\"line\">label ::ffff:0:0/96 4</span><br><span class=\"line\">label fec0::/10     5</span><br><span class=\"line\">label 2001:0::/32   7</span><br><span class=\"line\"></span><br><span class=\"line\">precedence  ::1/128       50</span><br><span class=\"line\">precedence  fc00::/7      45</span><br><span class=\"line\">precedence  ::/0          40</span><br><span class=\"line\">precedence  2002::/16     30</span><br><span class=\"line\">precedence ::/96          20</span><br><span class=\"line\">precedence ::ffff:0:0/96  10</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>ファイルを保存し、OSを再起動します。</p>\n</li>\n</ol>\n<p>以上でIPv6が優先となります <span class=\"github-emoji\" alias=\"turtle\" style=\"\" fallback-src=\"https://github.githubassets.com/images/icons/emoji/unicode/1f422.png?v8\">&#x1f422;</span></p>\n<p>なお、LinuxでmDNS（Bonjour）が使える環境にあり、LANにおける名前解決がIPv4指定となっている場合は、<code>/etc/nsswitch.conf</code>を修正する事でIPv6対応に変更可能です。LAN内の端末をIPv6で明示的に指定することはあまりないのでここは参考程度に留めておいてください。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 以下の行をコメントアウトします</span></span><br><span class=\"line\"><span class=\"comment\">#hosts:          files mdns4_minimal [NOTFOUND=return] dns</span></span><br><span class=\"line\"><span class=\"comment\"># 代わりに以下の行を追加します</span></span><br><span class=\"line\">hosts:          files mdns_minimal [NOTFOUND=<span class=\"built_in\">return</span>] dns</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"getaddrinfo\"><a href=\"#getaddrinfo\" class=\"headerlink\" title=\"getaddrinfo()\"></a>getaddrinfo()</h2><p>送信元IPアドレスと送信先アドレスでPolicyによってどのネットワークを使うかは、<strong>RFC6724</strong>で詳細が記載されています。</p>\n<blockquote>\n<p><a href=\"https://datatracker.ietf.org/doc/html/rfc6724\">https://datatracker.ietf.org/doc/html/rfc6724</a></p>\n</blockquote>\n<p>多くのアプリケーションは、getaddrinfo()という関数を使い、URLから名前解決されるとともに、プレフィックスポリシーを踏まえてIPv4またはIPv6の優先度が決定されます。<br>nslookupで<code>google.com</code>を見てみます。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ nslookup google.com.</span><br><span class=\"line\">Server:\t\t127.0.0.53</span><br><span class=\"line\">Address:\t127.0.0.53#53</span><br><span class=\"line\"></span><br><span class=\"line\">Non-authoritative answer:</span><br><span class=\"line\">Name:\tgoogle.com</span><br><span class=\"line\">Address: 172.217.xxx.110</span><br><span class=\"line\">Name:\tgoogle.com</span><br><span class=\"line\">Address: 2404:6800:4004:xxxx::200e</span><br></pre></td></tr></table></figure>\n\n<p>上記のようにIPv4とIPv6のアドレスが両方定義されています。<br>getaddrinfo()はpythonのインタラクティブシェルで確認できます。以下はIPv6が優先のケースです。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&gt;&gt;&gt; </span><span class=\"keyword\">import</span> socket</span><br><span class=\"line\"><span class=\"meta\">&gt;&gt;&gt; </span>socket.getaddrinfo(<span class=\"string\">&quot;google.com&quot;</span>, <span class=\"number\">80</span>, proto=socket.IPPROTO_TCP)</span><br><span class=\"line\">[(&lt;AddressFamily.AF_INET6: <span class=\"number\">10</span>&gt;, &lt;SocketKind.SOCK_STREAM: <span class=\"number\">1</span>&gt;, <span class=\"number\">6</span>, <span class=\"string\">&#x27;&#x27;</span>, (<span class=\"string\">&#x27;2404:6800:4004:xxxx::200e&#x27;</span>, <span class=\"number\">80</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>)), (&lt;AddressFamily.AF_INET: <span class=\"number\">2</span>&gt;, &lt;SocketKind.SOCK_STREAM: <span class=\"number\">1</span>&gt;, <span class=\"number\">6</span>, <span class=\"string\">&#x27;&#x27;</span>, (<span class=\"string\">&#x27;172.217.xxx.110&#x27;</span>, <span class=\"number\">80</span>))]</span><br></pre></td></tr></table></figure>\n<p>1-2行目で関数を呼び出し、3行目の関数の出力はタプル（List形式）で2要素あります。0番目の要素にIPv6アドレスが入り、1番目の要素にIPv4アドレスがあります。PrefixPolicyをIPv4優先に変更した場合は、このレスポンスの順番が入れ替わります。<br>macOSでは0番目の要素にIPv4アドレスを返します。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&gt;&gt;&gt; </span><span class=\"keyword\">import</span> socket</span><br><span class=\"line\"><span class=\"meta\">&gt;&gt;&gt; </span>socket.getaddrinfo(<span class=\"string\">&quot;google.com&quot;</span>, <span class=\"number\">80</span>, proto=socket.IPPROTO_TCP)</span><br><span class=\"line\">[(&lt;AddressFamily.AF_INET: <span class=\"number\">2</span>&gt;, &lt;SocketKind.SOCK_STREAM: <span class=\"number\">1</span>&gt;, <span class=\"number\">6</span>, <span class=\"string\">&#x27;&#x27;</span>, (<span class=\"string\">&#x27;172.217.xxx.238&#x27;</span>, <span class=\"number\">80</span>)), (&lt;AddressFamily.AF_INET6: <span class=\"number\">30</span>&gt;, &lt;SocketKind.SOCK_STREAM: <span class=\"number\">1</span>&gt;, <span class=\"number\">6</span>, <span class=\"string\">&#x27;&#x27;</span>, (<span class=\"string\">&#x27;2404:6800:4004:XXXX::200e&#x27;</span>, <span class=\"number\">80</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>))]</span><br></pre></td></tr></table></figure>\n<p><strong>RFC6724</strong>を読んでいると色々な設定が見られます。例えば以下のようにIPv6のリンクローカルアドレスの優先度をグローバルよりも下げてしまうなどです。</p>\n<blockquote>\n<p>10.4.  Configuring Preference for Link-Local Addresses<br>The destination address selection rules give preference to destinations of smaller scope.For example,a link-local destination will be sorted before a global scope destination when the two are otherwise equally suitable.An administrator can change the policy table to reverse this preference and sort global destinations before link-local destinations:</p>\n</blockquote>\n<blockquote>\n<p>宛先アドレス選択ルールは、<strong>スコープの小さい宛先が優先されます</strong>。 例えば、リンクローカルな宛先は、グローバルな宛先と同等に適している場合にグローバルな宛先よりも優先されます。管理者はポリシーテーブルの優先順位を逆転させることで、リンクローカルな宛先よりもグローバルな宛先を優先するように変更できます。</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">Prefix        Precedence Label</span><br><span class=\"line\">::1/128               50     0</span><br><span class=\"line\">::/0                  40     1</span><br><span class=\"line\">::ffff:0:0/96         35     4</span><br><span class=\"line\">fe80::/10             33     1</span><br><span class=\"line\">2002::/16             30     2</span><br><span class=\"line\">2001::/32              5     5</span><br><span class=\"line\">fc00::/7               3    13</span><br><span class=\"line\">::/96                  1     3</span><br><span class=\"line\">fec0::/10              1    11</span><br><span class=\"line\">3ffe::/16              1    12</span><br></pre></td></tr></table></figure>\n\n<p>※（補足）スコープの小さい宛先が優先されるというのは、送信先アドレスと送信元アドレスの上位ビットからの一致ビット数によって決定されることでロンゲストマッチアルゴリズムと呼ばれます。<code>fdxx〜</code>のULAアドレスは<code>::/0</code>と<code>fc00::/7</code>とにマッチしますが、優先度が高い<code>::/0</code>にマッチするのではなくて、一致ビット数が多いもの、つまり<code>fc00::/7</code>にマッチします。その上で、getaddrinfo()で有効なネットワークが複数あればそこで初めて優先度について評価されます。</p>\n<p>上記の例は自身のホストにグローバルなIPv6アドレスが振られている事を想定しているはずで、今回のようなULAを使うケースとはまた違うシチュエーションですので、あくまで参考となります。</p>\n<h2 id=\"Happy-Eyeballs\"><a href=\"#Happy-Eyeballs\" class=\"headerlink\" title=\"Happy Eyeballs\"></a>Happy Eyeballs</h2><p>Happy Eyeballsは、ブラウザに実装されている機能で、IPv6を優先しつつも、IPv4と応答の早い結果を採用するという合理的な仕組みです。Happy Eyeballsは<strong>RFC6555</strong>、Happy Eyeballs ver2については、<strong>RFC8305</strong>で定義されています。Eyeballsというのはユーザーを意味します。ユーザーにとってハッピーな仕組みという事でしょうか。</p>\n<blockquote>\n<p>RFC6555<br> <a href=\"https://datatracker.ietf.org/doc/html/rfc6555\">https://datatracker.ietf.org/doc/html/rfc6555</a><br>RFC8305<br> <a href=\"https://datatracker.ietf.org/doc/html/rfc8305\">https://datatracker.ietf.org/doc/html/rfc8305</a><br>用語解説<br> <a href=\"https://dictionary.cambridge.org/dictionary/english/eyeballs\">https://dictionary.cambridge.org/dictionary/english/eyeballs</a></p>\n</blockquote>\n<p>LANから挙動を見る限り、IPv6を優先としたOSでの挙動はブラウザからもIPv6が優先されているように見えます。macOSやiPhoneで見る限りは応答の早い方に接続するようです。<strong>Test your Happy Eyeballs</strong>では、その挙動を確認できます。</p>\n<blockquote>\n<p><a href=\"http://he.test-ipv6.com/\">http://he.test-ipv6.com</a></p>\n</blockquote>\n<img src=\"/new-technology/2021/06/26/ipv6-first/he.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<p>私の環境ではmacOSが6:4、iOSが7:3でそれぞれIPv4が多く選択されました。このサイトではランダムなホスト名を生成し、そこに毎秒接続確認をする手法を取っているようです。ただし、このサイトに限らずULA環境におけるmacOSでは一度接続した情報がOS上のキャッシュに残ると次からはIPv4に接続します。ネットワークのキャプチャを見ると、名前解決ではAAAAレコードとAレコードとを同時にクエリ要求しますが、キャッシュされた接続先がある場合はIPv6には接続せずIPv4のみ接続開始しています。OS内部ではLinux同様にPrefix管理テーブルがあるものと考えられます。</p>\n<p>”test-ipv6.com”についてIPv4のFirewallルールで拒否する設定をするとエラー無くIPv6で接続されます（macOSのSafariの場合）。</p>\n<img src=\"/new-technology/2021/06/26/ipv6-first/he2.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<p>可用性としては優れた仕組みですが、IPv4の国別フィルタで意図的に宛先国をブロックする運用をしている場合、IPv6の国別フィルタの機能がFirewallに無ければセキュリティリスクに見えます。ホームユーザーにとってリスク対策のためにIPv6を無効にするまでは無いと考えていますが、こういったブラウザの挙動も頭の片隅に置いておく必要がありそうです。</p>\n","categories":["Network"],"tags":["XG Firewall","IPv6"]},{"title":"VMware ESXiにパッチを適用する","url":"/new-technology/2020/06/14/esxi67-patch/","content":"<img src=\"/new-technology/2020/06/14/esxi67-patch/title.png\" class=\"\" title=\"alt\">\n<p class=\"onepoint\">この記事で実現すること</p>\n\n<p>無償版ESXi（VMware vSphere Hypervisor）について、VMwareのサイトから製品パッチに関する情報を入手し、ESXi上でパッチを適用します。この記事ではESXi7.0を対象にしています。2022年12月現在、ESXi8.0は発表されていますが、私は当面安定しているESXi7.0を稼働させる予定で、ESXi7.0のパッチ情報を記載していきます。</p>\n<span id=\"more\"></span>\n\n<h2 id=\"パッチ適用に必要なもの\"><a href=\"#パッチ適用に必要なもの\" class=\"headerlink\" title=\"パッチ適用に必要なもの\"></a>パッチ適用に必要なもの</h2><p>SSHでESXiに接続し、コマンドラインでパッチを適用します。Windows10ではOpenSSHがサポートされていますので、<mark class=\"label primary\">オプション機能を追加する</mark>から<mark class=\"label primary\">OpenSSHクライアント</mark>を有効にし、コマンドラインから<code>ssh  root@ESXiのIPアドレス</code>で接続可能です。</p>\n<h2 id=\"VMwareのパッチ情報\"><a href=\"#VMwareのパッチ情報\" class=\"headerlink\" title=\"VMwareのパッチ情報\"></a>VMwareのパッチ情報</h2><p>ESXiのパッチ情報は以下を参照してください。当該ページの左ペインメニューには最新パッチの情報が掲載されていますので、最新のパッチ情報を辿ってください。また、過去のパッチの情報も提供されています。</p>\n<blockquote>\n<p>VMware ESXi 7.0 Update 3l（2023-3-30発表）<br> <a href=\"https://docs.vmware.com/en/VMware-vSphere/7.0/rn/vsphere-esxi-70u3l-release-notes.html\">https://docs.vmware.com/en/VMware-vSphere/7.0/rn/vsphere-esxi-70u3l-release-notes.html</a></p>\n</blockquote>\n<p>最近パッチ公開が頻繁ですね。ESXi7.0も8.0もパッチが提供されています。TPMに関する脆弱性のようで、CVE-2023-1017とCVE-2023-1018が対象です。CVE-2023-1017の方は、CVSS 3.x Severity and MetricsのBase Scoreは7.8（HIGH）となっています。</p>\n<h2 id=\"製品パッチの情報を入手する\"><a href=\"#製品パッチの情報を入手する\" class=\"headerlink\" title=\"製品パッチの情報を入手する\"></a>製品パッチの情報を入手する</h2><p>ESXiのセットアップ時にCustomer Connectへの登録を行い、個人向けvSphere Hypervisorのライセンス（無償）を入手されている事を前提にしています。</p>\n<p><strong>VMware Customer Connect</strong>にサインインし、<mark class=\"label primary\">製品とエンタイトルメント　アカウント</mark>メニューから、”製品パッチ”を選択します。</p>\n<blockquote>\n<p>VMware Customer Connect<br> <a href=\"https://customerconnect.vmware.com/jp\">https://customerconnect.vmware.com/jp</a></p>\n</blockquote>\n<img src=\"/new-technology/2020/06/14/esxi67-patch/myvm3.png\" class=\"\" title=\"alt\">\n\n<p>さらに、”ESXi”とバージョンの”7.0”を選択し”検索”ボタンをクリックすると、パッチの一覧が表示されます。以下は7.0U3lの画面です。</p>\n<img src=\"/new-technology/2020/06/14/esxi67-patch/myvm2.png\" class=\"\" title=\"alt\">\n\n<p>基本的にESXiは7.0のバージョンのまま修正パッチを適用する場合はこの7.0という2桁の数字は変わりません。この数字が変わる更新をアップグレードと呼びます。それ以外の小さい更新をパッチまたはアップデートと呼びます。但し、ESXi7.0の場合はUpdate2,Update3というグループがあり、さらにUpdate3k、Update3lという具合にグループ単位でパッチ毎に末尾の英字が大きくなっていきます。VMwareのパッチは累積パッチとなるため、最新のパッチを適用するだけでよく、古いパッチの適用は必要ありません。ここでは最新版のパッチをダウンロードします。</p>\n<h2 id=\"パッチ適用作業\"><a href=\"#パッチ適用作業\" class=\"headerlink\" title=\"パッチ適用作業\"></a>パッチ適用作業</h2><p>ESXiにログインし、以下の作業を行います。</p>\n<ul>\n<li>SSHを有効にします</li>\n<li>仮想マシンを全てシャットダウンします</li>\n<li>ESXiをメンテナンスモードに切り替えます</li>\n<li>ダウンロードしたパッチファイル（ZIPファイル）をESXiにアップロードします</li>\n<li>SSHでESXiにログインします</li>\n<li>パッチ適用コマンドを入力、リブートします</li>\n<li>メンテナンスモードを終了します</li>\n<li>SSHを無効にします</li>\n<li>仮想マシンを起動します</li>\n</ul>\n<ol>\n<li><p>SSHを有効にする<br> ESXiの左ペインの<mark class=\"label primary\">ホストー管理</mark>から、”サービス”のタブをクリックし、”TSM-SSH”を選択し”起動”ボタンをクリックし、SSHを有効にします。</p>\n <img src=\"/new-technology/2020/06/14/esxi67-patch/esxi1.png\" class=\"\" title=\"alt\">\n</li>\n<li><p>仮想マシンを全てシャットダウンします</p>\n</li>\n<li><p>ESXiをメンテナンスモードに切り替えます</p>\n <img src=\"/new-technology/2020/06/14/esxi67-patch/esxi2.png\" class=\"\" title=\"alt\">\n</li>\n<li><p>パッチファイルのESXiへのアップロード<br> ESXiの左ペインメニューの”ストレージ”を選択、メインのストレージ（一般的にはdatastore1）を選択し、”データストアブラウザ”をクリックします</p>\n <img src=\"/new-technology/2020/06/14/esxi67-patch/esxi3.png\" class=\"\" title=\"alt\">\n <mark class=\"label primary\">アップロード</mark>ボタンをクリックし、ダウンロードしたパッチファイルをZIPのままアップロードします。ここの例では<mark class=\"label primary\">ディレクトリの作成</mark>ボタンでupdateフォルダを作成し、そこにアップロードします。\n</li>\n<li><p>SSHでESXiにログイン<br> ログイン後、パッチをアップロードしたフォルダ（datastore1&#x2F;update）に移動しアップロードしたパッチファイルが存在するか<code>ls</code>で確認します</p>\n <figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">The time and <span class=\"built_in\">date</span> of this login have been sent to the system logs.</span><br><span class=\"line\"></span><br><span class=\"line\">WARNING:</span><br><span class=\"line\">  All commands run on the ESXi shell are logged and may be included <span class=\"keyword\">in</span></span><br><span class=\"line\">  support bundles. Do not provide passwords directly on the <span class=\"built_in\">command</span> line.</span><br><span class=\"line\">  Most tools can prompt <span class=\"keyword\">for</span> secrets or accept them from standard input.</span><br><span class=\"line\"></span><br><span class=\"line\">VMware offers supported, powerful system administration tools.  Please</span><br><span class=\"line\">see www.vmware.com/go/sysadmintools <span class=\"keyword\">for</span> details.</span><br><span class=\"line\"></span><br><span class=\"line\">The ESXi Shell can be disabled by an administrative user. See the</span><br><span class=\"line\">vSphere Security documentation <span class=\"keyword\">for</span> more information.</span><br><span class=\"line\">[root@esxi:~] <span class=\"built_in\">cd</span> /vmfs/volumes/datastore1/update</span><br><span class=\"line\">[root@esxi:~] <span class=\"built_in\">ls</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>パッチ適用コマンドを入力します<br> 新しいドライバやバグフィックス、セキュリティパッチなど含めたprofileとして整合性が取れたvibのアップデートはprofile updateを実行します。ここでは、ESXi7.0Update3kからUpdate3lにアップデートすることを例にします。</p>\n</li>\n</ol>\n<p> 現在の実行中のprofileを確認します。<code>esxcli software profile get</code><br> <figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@esxi2:/vmfs/volumes/6215b59a-6031d17a-ea0d-80615f0db1ce/update] esxcli software profile get</span><br><span class=\"line\">(Updated) ESXi-7.0U3k-21313628-standard</span><br><span class=\"line\">   Name: (Updated) ESXi-7.0U3k-21313628-standard</span><br><span class=\"line\">   Vendor: VMware, Inc.</span><br><span class=\"line\">   Creation Time: 2023-02-23T08:32:52</span><br><span class=\"line\">   Modification Time: 2023-04-04T11:39:38</span><br><span class=\"line\">   Stateless Ready: True</span><br></pre></td></tr></table></figure></p>\n<p> 一般的にはバージョンの最後に”-standard”の文字が付いています。standard版がインストールされている事を示します。<br> 次に、パッチファイルに登録されているprofileを確認します（パッチはフルパス指定が必要です）。<br> <figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@esxi2] esxcli software sources profile list -d /vmfs/volumes/datastore1/update/VMware-ESXi-7.0U3l-21424296-depot.zip</span><br><span class=\"line\">Name                            Vendor        Acceptance Level  Creation Time        Modification Time</span><br><span class=\"line\">------------------------------  ------------  ----------------  -------------------  -----------------</span><br><span class=\"line\">ESXi-7.0U3sl-21422485-standard  VMware, Inc.  PartnerSupported  2023-03-30T00:00:00  2023-03-30T00:00:00</span><br><span class=\"line\">ESXi-7.0U3sl-21422485-no-tools  VMware, Inc.  PartnerSupported  2023-03-30T00:00:00  2023-03-10T16:04:06</span><br><span class=\"line\">ESXi-7.0U3l-21424296-standard   VMware, Inc.  PartnerSupported  2023-03-30T00:00:00  2023-03-30T00:00:00</span><br><span class=\"line\">ESXi-7.0U3l-21424296-no-tools   VMware, Inc.  PartnerSupported  2023-03-30T00:00:00  2023-03-11T01:18:32</span><br></pre></td></tr></table></figure></p>\n<p>これは、セキュリティパッチのみと不具合修正（またはドライババージョンアップ）+セキュリティパッチのパターンのパッチですね。VMWare Toolsを含まないProfileであるno-tools、VMWare Tools付きのstandard版となります。VMWare Toolsを使う一般的なユーザーはNo Tools版を選択しないので除外します。</p>\n<p>ESXi-7.0U3l-21424296-standardとESXi-7.0U3sl-21422485-standardとの比較です。</p>\n<table>\n<thead>\n<tr>\n<th>ESXi-7.0U3l-21424296-standard</th>\n<th>ESXi-7.0U3l-21422485-standard</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>VMware_bootbank_esx-dvfilter-generic-fastpath_7.0.3-0.85.21424296</td>\n<td>VMware_bootbank_esx-dvfilter-generic-fastpath_7.0.3-0.80.21422485</td>\n</tr>\n<tr>\n<td>VMware_bootbank_vsan_7.0.3-0.85.21424296</td>\n<td>VMware_bootbank_vsan_7.0.3-0.80.21422485</td>\n</tr>\n<tr>\n<td>VMware_bootbank_bmcal_7.0.3-0.85.21424296</td>\n<td>VMware_bootbank_bmcal_7.0.3-0.80.21422485</td>\n</tr>\n<tr>\n<td>VMware_bootbank_crx_7.0.3-0.85.21424296</td>\n<td>VMware_bootbank_crx_7.0.3-0.80.21422485</td>\n</tr>\n<tr>\n<td>VMware_bootbank_esx-ui_2.9.2-21141530</td>\n<td>VMware_bootbank_esx-ui_2.9.2-21141530</td>\n</tr>\n<tr>\n<td>VMware_bootbank_esxio-combiner_7.0.3-0.85.21424296</td>\n<td>VMware_bootbank_esxio-combiner_7.0.3-0.80.21422485</td>\n</tr>\n<tr>\n<td>VMware_bootbank_vsanhealth_7.0.3-0.85.21424296</td>\n<td>VMware_bootbank_vsanhealth_7.0.3-0.80.21422485</td>\n</tr>\n<tr>\n<td>VMware_bootbank_native-misc-drivers_7.0.3-0.85.21424296</td>\n<td>VMware_bootbank_native-misc-drivers_7.0.3-0.80.21422485</td>\n</tr>\n<tr>\n<td>VMware_bootbank_gc_7.0.3-0.85.21424296</td>\n<td>VMware_bootbank_gc_7.0.3-0.80.21422485</td>\n</tr>\n<tr>\n<td>VMware_bootbank_cpu-microcode_7.0.3-0.85.21424296</td>\n<td>VMware_bootbank_cpu-microcode_7.0.3-0.80.21422485</td>\n</tr>\n<tr>\n<td>VMware_bootbank_vdfs_7.0.3-0.85.21424296</td>\n<td>VMware_bootbank_vdfs_7.0.3-0.80.21422485</td>\n</tr>\n<tr>\n<td>VMware_bootbank_esx-xserver_7.0.3-0.85.21424296</td>\n<td>VMware_bootbank_esx-xserver_7.0.3-0.80.21422485</td>\n</tr>\n<tr>\n<td>VMware_bootbank_esx-base_7.0.3-0.85.21424296</td>\n<td>VMware_bootbank_esx-base_7.0.3-0.80.21422485</td>\n</tr>\n<tr>\n<td>VMware_bootbank_trx_7.0.3-0.85.21424296</td>\n<td>VMware_bootbank_trx_7.0.3-0.80.21422485</td>\n</tr>\n<tr>\n<td>VMware_bootbank_esx-update_7.0.3-0.85.21424296</td>\n<td>VMware_bootbank_esx-update_7.0.3-0.80.21422485</td>\n</tr>\n<tr>\n<td>VMware_bootbank_loadesx_7.0.3-0.85.21424296</td>\n<td>VMware_bootbank_loadesx_7.0.3-0.80.21422485</td>\n</tr>\n<tr>\n<td>VMW_bootbank_ntg3_4.1.9.0-4vmw.703.0.85.21424296</td>\n<td></td>\n</tr>\n<tr>\n<td>VMW_bootbank_vmkusb_0.1-8vmw.703.0.85.21424296</td>\n<td></td>\n</tr>\n<tr>\n<td>VMW_bootbank_nvme-pcie_1.2.3.16-2vmw.703.0.85.21424296</td>\n<td></td>\n</tr>\n<tr>\n<td>VMware_locker_tools-light_12.1.5.20735119-21422485</td>\n<td>VMware_locker_tools-light_12.1.5.20735119-21422485</td>\n</tr>\n</tbody></table>\n<p>いつものことですが、セキュリティパッチのみよりは、不具合対応を含むパッチの方が全体的なバージョンが上になっています。特にドライバが変わることの懸念などが無ければESXi-7.0U3l-21424296-standardを適用します。</p>\n<p>以下のようにパッチファイルのzipをフルパスで指定し、VMwareのパッチ情報にあるプロファイル名を指定しパッチを適用します。ここではstandardを指定します。<br> <figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@esxi:~] esxcli software profile update -d /vmfs/volumes/datastore1/update/VMware-ESXi-7.0U3l-21424296-depot.zip -p ESXi-7.0U3l-21424296-standard</span><br></pre></td></tr></table></figure></p>\n<ol>\n<li><p><code>esxcli software profile update</code>の実行後しばらくしてから、結果が表示されます。</p>\n <figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">Update Result</span><br><span class=\"line\">   Message: The update completed successfully, but the system needs to be rebooted for the changes to be effective.</span><br><span class=\"line\">   Reboot Required: true</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>コマンドプロンプトから、<code>reboot</code>としてESXiを再起動します。</p>\n</li>\n<li><p>再起動完了後、ESXiにログインします。左ペインメニューの”ホスト”をクリックし、バージョンの表記に今回パッチを当てたビルド番号が表示されている事を確認してください。今回はU3lとなっているはずです。</p>\n</li>\n</ol>\n<ul>\n<li>ESXi7.0  <img src=\"/new-technology/2020/06/14/esxi67-patch/esxi5.png\" class=\"\" title=\"alt\"></li>\n</ul>\n<p>  または、sshでESXiに接続し、<code>vmware -v</code>を実行し確認します。</p>\n <figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@esxi2:~] vmware -v</span><br><span class=\"line\">VMware ESXi 7.0.3 build-21424296</span><br></pre></td></tr></table></figure>\n\n<ol start=\"4\">\n<li>最後にこれまで実施してきたメンテナンス準備とは反対の作業をします。メンテナンスモードの終了・SSHの無効化・仮想マシンの起動と続けます。</li>\n</ol>\n<h2 id=\"パッチのロールバック\"><a href=\"#パッチのロールバック\" class=\"headerlink\" title=\"パッチのロールバック\"></a>パッチのロールバック</h2><p>あまり考えたくはありませんが、パッチ適用後、うまく動作しないなどの場合にはロールバックします。ESXiはひとつ前のバージョンに戻せます（アップグレードの場合は戻せない場合があります）。<br>ESXiホストを再起動し、起動中にShift+’R’キーを押します。</p>\n<blockquote>\n<p>VMware ESXi を前のバージョンに戻す (1033604)<br> <a href=\"https://kb.vmware.com/s/article/1033604?lang=ja\">https://kb.vmware.com/s/article/1033604?lang=ja</a></p>\n</blockquote>\n<blockquote>\n<p>Hypervisor のプログレス バーの読み込みが開始されたら、Shift+R を押します。(これはバーが表示されたロード後ではなく、ロード中に実行する必要があります。コマンドを実行するタイミングを逃さないよう、”system is preparing to boot” 表示中に Shift+R を繰り返し押すことをお勧めいたします)。</p>\n</blockquote>\n<p> 以下の通り、今動いているビルド番号と前のビルド番号が表示されます。</p>\n<img src=\"/new-technology/2020/06/14/esxi67-patch/rollback.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p>ここでロールバックを選択します。</p>\n<h2 id=\"構成情報のバックアップ（任意）\"><a href=\"#構成情報のバックアップ（任意）\" class=\"headerlink\" title=\"構成情報のバックアップ（任意）\"></a>構成情報のバックアップ（任意）</h2><p>今後、パッチ適用を重ねていきますが、ある時点にロールバックしたいと思った時に、ホスト構成バックアップから戻す必要が出てきます。パッチを当てる度に構成情報のバックアップを取得されることをお勧めします。</p>\n<p>参考にするドキュメントはこちらです。</p>\n<blockquote>\n<p>ESXi ホストの構成のバックアップ方法 (2042141)<br> <a href=\"https://kb.vmware.com/s/article/2042141?lang=ja\">https://kb.vmware.com/s/article/2042141?lang=ja</a></p>\n</blockquote>\n<ol>\n<li>SSHでESXiに接続します。</li>\n<li>ストレージの確実な同期のためのコマンド<code>vim-cmd hostsvc/firmware/sync_config</code>を実行します。</li>\n<li>バックアップコマンド<code>vim-cmd hostsvc/firmware/backup_config</code>を実行します。</li>\n<li>画面にダウンロードパスが表示されるのでそのURLにブラウザから接続し構成情報をダウンロードします。</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@esxi:~] vim-cmd hostsvc/firmware/sync_config</span><br><span class=\"line\">[root@esxi:~] vim-cmd hostsvc/firmware/backup_config</span><br><span class=\"line\">Bundle can be downloaded at : http://*/downloads/52ce000f-cad4-20c0-078d-a111fa1ad82x/configBundle-esxi.local.tgz</span><br><span class=\"line\">[root@esxi:~]</span><br></pre></td></tr></table></figure>\n\n<p>先頭に<code>http://*/</code>とありますが、ここはESXiのホスト名またはIPアドレスを指定しブラウザからアクセスします。例えば、<code>http://192.168.1.1/downloads〜</code>という具合です。万が一レストアが必要になってしまった場合はバックアップを取得したバージョンのパッチを適用の上、メンテナンスモードに移行してから<code>vim-cmd hostsvc/firmware/restore_config /your_backup_location/configBundle-esxi.local.tgz</code>で戻します。バックアップを取得してから既にハードウェア構成が変わっていたりする場合は戻せない場合があります。仮想マシンはデータストアブラウザから再登録する必要があります。詳細は上記VMwareのドキュメントを参照してください。</p>\n","categories":["Software"],"tags":["ESXi"]},{"title":"IPv6のUnique Local Addressを生成する","url":"/new-technology/2020/04/18/ipv6/","content":"<p class=\"onepoint\">この記事で実現すること</p>\nプライベートなIPv6アドレスを利用するため、機器のMACアドレスを用いて、Unique Local Address（ULA）を生成します。\n\n<span id=\"more\"></span>\n\n<h2 id=\"IPv6-Unique-Local-Address（ULA-について\"><a href=\"#IPv6-Unique-Local-Address（ULA-について\" class=\"headerlink\" title=\"IPv6 Unique Local Address（ULA)について\"></a>IPv6 Unique Local Address（ULA)について</h2><p>IPv6はその広大なアドレス空間により、NATを必要としません。ホームユーザー向けのインターネットサービスにおいても、多くのプロバイダでパブリックIPv6が振られ、NAT変換無しでインターネットに接続できます。ただしホームユーザー環境においての実運用としては、パブリックIPアドレスが変わった場合に宅内のIPアドレスも変更しなければならず、内側のホスト間通信の運用が困難になります。Firewallなど内部ホストを管理する必要のあるネットワークでは、IPv4のプライベートIPに近い考えであるIPv6のULAを使い、インターネットに対してはNAT変換することが考えられます。厳密には、ULA≠プライベートIPアドレスなので、外部のサイトとは重複しないアドレスを利用する事が求められます。</p>\n<p>ULAは、MACアドレスと時刻からおおよそ一意となるIPv6アドレスを作成することが可能となります。アドレスは、<code>fd00::/8</code>から始まる48ビットのプリフィックス（prefix）を持ちます。従い、<code>fdxx:xxxx:xxxx::/48</code>のプリフィックスに加え、<code>0000</code>〜<code>ffff</code>までのサブネットの範囲を持ちます。</p>\n<p><code>fdxx:xxxx:xxxx:0000::/64</code> - <code>fdxx:xxxx:xxxx:ffff::/64</code></p>\n<h2 id=\"IPv6-ULAの生成を行う\"><a href=\"#IPv6-ULAの生成を行う\" class=\"headerlink\" title=\"IPv6 ULAの生成を行う\"></a>IPv6 ULAの生成を行う</h2><p>ULAを求めるPythonプログラムを私の方で用意し、<strong>JDoodle</strong>に配置しています。JDoodleでPythonプログラムを実行できます。JDoodleは、教育用としてプログラムソースコードを登録すると、プログラムが実行できる機能を提供しています。<sup><b><a href=\"#note1\">[1]</a></b></sup></p>\n<p>最初にIPv6を割り振りたいホストのMACアドレスを調べておいてください。算出時にMACアドレスを入力するので、<code>XX:XX:XX:XX:XX:XX</code>または<code>XX-XX-XX-XX-XX-XX</code>と表示されているMACアドレスを予めコピーしてください。大文字小文字はどちらでも構いません。また、仮想環境でサーバーなどを構築されている場合は仮想MACアドレスではなく、物理MACアドレスを採用される事をお勧めします。</p>\n<blockquote>\n<p>JDoodle -ULA Generator-<br> <a href=\"https://www.jdoodle.com/a/20tR\">https://www.jdoodle.com/a/20tR</a></p>\n</blockquote>\n<img src=\"/new-technology/2020/04/18/ipv6/jdoodle1.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<ol>\n<li>入力エリア　<mark class=\"label primary\">Stdin Inputs</mark></li>\n<li>実行ボタン　<mark class=\"label primary\">▶︎Execute</mark></li>\n<li>実行結果　<mark class=\"label primary\">Result</mark></li>\n</ol>\n<img src=\"/new-technology/2020/04/18/ipv6/jdoodle.png\" class=\"\" width=\"800\" title=\"alt\">\n<mark class=\"label primary\">Stdin Inputs</mark>に入力します。MACアドレスを貼り付け、<mark class=\"label primary\">▶︎Execute</mark>ボタンをクリックしてください。\n\n<mark class=\"label primary\">Result</mark>に、以下の4つの項目が表示されます。これらがプライベート環境で利用するユニークなIPv6アドレスです。MACアドレスが正しく入力されなかった場合は、\"Bad MAC Adderss\"と表示されます。\n\n<h3 id=\"IPv6-ULAのプログラムについて\"><a href=\"#IPv6-ULAのプログラムについて\" class=\"headerlink\" title=\"IPv6 ULAのプログラムについて\"></a>IPv6 ULAのプログラムについて</h3><ul>\n<li>RFC4193に基づき生成しています</li>\n<li>MACアドレスから<mark class=\"label primary\">Modified EUI-64</mark>を生成するにあたり、RFC4291に基づき生成しています</li>\n<li>本来はNTPを利用してハッシュキーの一部に利用しますが、通信は行わずホストの時間を取得し、NTP時刻に変換しています</li>\n<li>NTPは64ビットのデータ型となっており、2036年にオーバーフローします。しかし、RFC4330で定義されているように再び0から開始し、正しく動く処理をしています</li>\n<li>JDoodleサイトは2021年10月17日時点でCookieを求められます。</li>\n<li>ソースコードはGitHubのリポジトリにあります。<br> <a href=\"https://github.com/yoshi0808/ula-generator\">https://github.com/yoshi0808/ula-generator</a></li>\n</ul>\n<p><small id=\"note1\"><strong>[1]</strong><br>JDoodleの利用規約などを探してみましたが見つかりませんでした。学生向けに教育用としての利用を想定されているようです。このブログの目的から鑑み、利用目的が逸脱している事は無いと考え、利用させていただいております。<br></small></p>\n","categories":["Network"],"tags":["XG Firewall","IPv6"]},{"title":"MIスマートバンド5を活用する","url":"/new-technology/2020/11/28/miband5/","content":"<img src=\"/new-technology/2020/11/28/miband5/Lark20200709-192509.jpg\" class=\"\" title=\"alt\">\n\n<h2 id=\"MIスマートバンド5-MI-band5-で健康になる\"><a href=\"#MIスマートバンド5-MI-band5-で健康になる\" class=\"headerlink\" title=\"MIスマートバンド5(MI band5)で健康になる\"></a>MIスマートバンド5(MI band5)で健康になる</h2><p>「健康になる」とは言うものの、多くの人の一番の興味はダイエットではないでしょうか。MIスマートバンド5は、中国の小米（シャオミ）から2020年10月に日本で発表されたスマートウォッチです。実売価格は4,000円前後からとリーズナブルで、小型で軽量、とても多機能です。特にリモートワークが増え、運動不足が気になる人にはまずは試していただきたいスマートウォッチです。ウォーキングやランニングをはじめ、11種類のワークアウトに対応しており、継続的に利用する気にさせる優れたデバイスです。現時点で日本語版として流通している製品はあるようですが（こちらの価格は5,000円前後）、正式に日本で発売されたという情報は見当たりません。日本語版・中国語版・グローバル版の3種類が存在するようです。グローバル版は、技適の認証を受けており、日本国内で利用可能です。MI band本体の操作メニューは英語であるものの、スマホからの通知メッセージなどは日本語表示が可能となっています。また、時計機能以外の操作はMI Fitと呼ばれるスマホアプリで操作します。アプリは完全に日本語となっており、操作に困る事はありません。</p>\n<span id=\"more\"></span>\n\n<div class=\"note warning\"><p>この記事は2020年のものであり、MI bandの最新版は2022年4月時点でMI band6となっています。スマートバンドを管理するスマホアプリも当時とは名称が変わっていますのでアプリの使い方などは「<a href=\"/new-technology/2021/07/24/miband6/\" title=\"MIスマートバンド6を活用する\">MIスマートバンド6を活用する</a>」の記事を参照してください。</p>\n</div>\n\n\n<h2 id=\"MI-band-5の特徴（抜粋）\"><a href=\"#MI-band-5の特徴（抜粋）\" class=\"headerlink\" title=\"MI band 5の特徴（抜粋）\"></a>MI band 5の特徴（抜粋）</h2><img src=\"/new-technology/2020/11/28/miband5/image4.png\" class=\"\" width=\"480\" title=\"alt\">\n\n<ul>\n<li>活動指数（PAI）の管理</li>\n<li>ストレスモニタリング</li>\n<li>心拍数モニタリング</li>\n<li>睡眠モニタリング</li>\n<li>電話、メール、SMSなどの通知機能（スマホ連動）</li>\n<li>音楽再生（スマホ連動）</li>\n<li>11種類のワークアウトの記録</li>\n<li>14日間のバッテリー持ち</li>\n<li>50m防水</li>\n<li>軽量11.9g</li>\n</ul>\n<h2 id=\"MI-band5の活用\"><a href=\"#MI-band5の活用\" class=\"headerlink\" title=\"MI band5の活用\"></a>MI band5の活用</h2><p>リモートワークの機会が増え、時計をする機会が減った方も多いのではないでしょうか。様々なスマートウォッチがありますが、私が利用したいスマートウォッチは頻繁に充電を必要としないもので、歩数や運動した記録を残すものでした。なお、スマートウォッチ単体で音楽を聴きたい、電子決済で買い物したいというニーズも多いでしょうがMI bandにはその機能はありません。※中国版ではNFCの機能はありますが、グローバル版にはありません。その他機能紹介はシャオミのWebサイトなどでご確認いただき、健康に重きを置くユーザーの視点として使い勝手および活用の紹介をしていきます。スマホアプリのMi FitはiOS、Androidに対応しています。</p>\n<p>・ダイエットしたい<br>・アスリートではないが、手軽に活動量計として記録したい<br>・運動不足を解消する目安を知りたい<br>・睡眠の状況を客観的に把握したい</p>\n<h2 id=\"体を動かす事を習慣に\"><a href=\"#体を動かす事を習慣に\" class=\"headerlink\" title=\"体を動かす事を習慣に\"></a>体を動かす事を習慣に</h2><p>密室を避ける意味でジムにも通いづらくなり、外でウォーキングやランニングをする事になるのか、最近はウォーキング、ランニングしている人を多く見かけるようになりました。スマホアプリをインストールして使う事になりますが、GPSの記録に拘らない場合は、常にスマホと一緒に持ち歩く必要はありません。小型で非常に軽いため、手首に付けている事が殆ど気になりません。わざわざワークアウトの開始を宣言せずとも記録を続けてくれる、着けている事を忘れさせてくれる、そんなデバイスです。私はグローバル版を8月くらいにネットで購入し、継続して使っています。</p>\n<h2 id=\"MI-Fitアプリ\"><a href=\"#MI-Fitアプリ\" class=\"headerlink\" title=\"MI Fitアプリ\"></a>MI Fitアプリ</h2><p>MI bandを最初に使う時はMI Fitアプリをインストールしてから、スマホとbluetoothでペアリングし、アカウントを作成します。MI Fitを起動した画面は以下になります。</p>\n<img src=\"/new-technology/2020/11/28/miband5/mifit1.png\" class=\"\" width=\"480\" title=\"alt\">\n\n<p>MI bandの設定ですが、2週間弱程度での充電を許容される方は、心拍数モニタリングは最も頻度の高い「自動心拍数モニタリングと睡眠アシスタント」を選んでください。また、モニタリング頻度も1分に設定します。もう少し電池持ちを良くするためにはモニタリング頻度を落とす事になります。</p>\n<p>最初の画面の表示内容はカスタマイズできますが、歩数、PAI、睡眠記録、心拍数と続きます。この日（前日の金曜日）はリモートワークでしたが、ほんと動かないですね。1日でたったの1,012歩。これではやっぱり不健康ですし、太ります。そのくせ10時間も寝てるという。通勤時間も無くなれば多く寝てしまいますよね。</p>\n<h3 id=\"PAI-パーソナルアクティビティインテリジェンス）\"><a href=\"#PAI-パーソナルアクティビティインテリジェンス）\" class=\"headerlink\" title=\"PAI(パーソナルアクティビティインテリジェンス）\"></a>PAI(パーソナルアクティビティインテリジェンス）</h3><p>MI bandには活動に反応して活動量を計測し指数化してくれる機能があります。心拍数を計測し活動量が増加すると、心拍モニタの頻度が上昇し、心拍数を細かく記録していきます。PAIは7日間の合計でスコアリングされます。これを100以上に保つ事で健康が維持されるとの事です。ロジックは公開されていませんが、年齢・性別・安静時心拍数・過去7日間の心拍数に基づきPAIスコアが計算されます。強度が低いウォーキングであれば加算される数字は小さいですし、強度の高い運動であれば数字は大きくなります。1週間前のデータは無効となるため、継続的な運動が必要です。1日全く活動しなくても構いませんが、数字はどんどん減っていきます。この数字を見ながら活動する事である程度の運動強度を意識し、PAIを100以上にし続ける事が推奨されています。このPAIは心疾患の予防の観点が主ですが、ダイエット目的にも活用できます。</p>\n<p>PAIはその人固有の状況に合わせて管理されるので、その人にとっては早歩きのウォーキングも強い活動量という事であればPAIの値も大きく増加します。一方、それなりの運動を継続している人であれば意識して早く歩き、心拍数をそれなりに上げないとPAIカウントは増えていかないようです。</p>\n<p>これらの仕組みによって、まずは自分の出来る範囲での活動から記録していく事で飽きずにモチベーションを長く維持できる仕組みとなっています。</p>\n<p>軽く30分ほど運動した日は以下の通り、PAIが16ほどカウントされています。これも特段Mi Fitでワークアウトを開始・終了を指示しておらず、自動的に計測されているものです。PAIは高・中・低の3種類の運動量で記録されています。</p>\n<img src=\"/new-technology/2020/11/28/miband5/IMG_2112.png\" class=\"\" width=\"480\" title=\"alt\">\n\n<p>通勤時や仕事での移動には少し早歩きしたり階段を使う事を意識するとPAIの数字が上がり、活動した実感が出てきます。PAIは100以上の数値を求めてより多く運動してもあまり効果は無いとの説明がありますが、これは心肺機能に限っての説明ですので、長い時間運動すればダイエットには効果があるでしょう。また、PAIの数値が上がれば上がるほど数字は増えにくくなる仕組みとなっているため、適度な数字を目安にすべきと考えられます。こういう数字を見る習慣をつけると、エスカレーターやエレベーターを使わずに階段を使ったり、ひと駅分は歩こうかなという気にさせてくれます。</p>\n<h3 id=\"睡眠スコア\"><a href=\"#睡眠スコア\" class=\"headerlink\" title=\"睡眠スコア\"></a>睡眠スコア</h3><p>睡眠スコアの画面です。MI bandを着けたまま寝ると睡眠スコアが記録されます。深い眠り、浅い眠り、REM睡眠、覚醒時間と分かれています。また日中に昼寝をすると、仮眠が記録されます。</p>\n<img src=\"/new-technology/2020/11/28/miband5/IMG_2115.png\" class=\"\" width=\"480\" title=\"alt\">\n<img src=\"/new-technology/2020/11/28/miband5/IMG_2116.png\" class=\"\" width=\"480\" title=\"alt\">\n<img src=\"/new-technology/2020/11/28/miband5/IMG_2117.png\" class=\"\" width=\"480\" title=\"alt\">\n\n<p>REM睡眠となっている部分は自分のなかでは殆ど起きているような感じを持っていますが、結構この感覚とMI Fitの結果と合っています。長い時間寝てもぐっすり眠れなかったなと気がする時は大体深い眠りが短くなってしまっています。<mark class=\"label primary\">睡眠の質分析</mark>と共に、<mark class=\"label primary\">類似したユーザーとの比較</mark>もあるので、自分の改善ポイントが良くわかります。しかし、ぐっすり深く眠るというのはなかなか難しいものだと痛感します。寝る前のコーヒーを控えたり、日中に適度な運動をしたり、自分に合った睡眠の工夫をする機会が得られます。</p>\n<h3 id=\"心拍数\"><a href=\"#心拍数\" class=\"headerlink\" title=\"心拍数\"></a>心拍数</h3><p>MI Fitはなんと言ってもこの心拍数を記録する機能が重要です。</p>\n<img src=\"/new-technology/2020/11/28/miband5/IMG_2119.png\" class=\"\" width=\"480\" title=\"alt\">\n\n<p>特に運動する場合において重要な心拍数ゾーンが管理できます。Mi Fitでは以下のようにゾーンが分類されています。</p>\n<ul>\n<li>最大酸素摂取量</li>\n<li>無酸素</li>\n<li>有酸素</li>\n<li>インテンシブ</li>\n<li>ライト</li>\n<li>リラックス</li>\n</ul>\n<p>上が一番激しい運動で下に行くほど軽い運動となるわけですが、運動する際はどのゾーンでどれだけ運動するかがポイントになります。これは年齢や日頃の運動している状況によってかなり変わるのであくまで目安となるものです。強すぎる運動（無酸素運動）では長い時間行えませんし、ダイエットの観点では脂肪燃焼どころか筋肉の減少や怪我に繋がるおそれがあります。また負荷が軽すぎる遅いウォーキングでも効果はあまりみられません。その人にとっての心拍数ゾーンが存在します。なお、体調のバロメーターとして、安静時心拍数が取得できます。私は普段60弱ぐらいの数字ですが、60を超える時はやや調子が悪いので朝起きた時にこの数字を確認し、数値が悪い場合はあまり無理をしない日にしようと意識するようにしています。</p>\n<h3 id=\"ストレスレベル\"><a href=\"#ストレスレベル\" class=\"headerlink\" title=\"ストレスレベル\"></a>ストレスレベル</h3><p>ストレスレベルも自動で計測してくれます。MI bandのストレス計測方法はどのように行っているかはわかりませんでした。しかしいくつかの文献では、ストレスを感じていない時は心拍数にゆらぎ（常に一定間隔ではない）が発生しているのが通常であって、ストレスを感じた時はその間隔が一定になるとの事でそのような仕組みを利用していると推測されます。少しストレスを感じている時は気分転換をしたり深呼吸をすれば、ストレスを下げる事ができます。</p>\n<img src=\"/new-technology/2020/11/28/miband5/IMG_2120.png\" class=\"\" width=\"480\" title=\"alt\">\n\n<h3 id=\"通知機能\"><a href=\"#通知機能\" class=\"headerlink\" title=\"通知機能\"></a>通知機能</h3><p>MI bandはスマホとBluetoothで接続状態にある場合は、電話、メール、アプリなどの通知を行ってくれます。LINEやTwitterも通知できますが、上記以外はアプリとして一括りですので、着信を許可したいもの、したくないものとのカスタマイズは限られます。とはいえ、PCを使っている時にSMSでワンタイムパスワードを受け取る時などは、結構便利です。以下のようにグローバル版であっても漢字を含む日本語は明瞭に表示されます。</p>\n<img src=\"/new-technology/2020/11/28/miband5/IMG_2123.png\" class=\"\" width=\"480\" title=\"alt\">\n\n<h3 id=\"ランニングを計測してみる\"><a href=\"#ランニングを計測してみる\" class=\"headerlink\" title=\"ランニングを計測してみる\"></a>ランニングを計測してみる</h3><p>MI bandにワークアウト開始を指示すると、細かい情報が取れます。GPSの記録を行う場合はスマホを持ってランニングする必要があります。</p>\n<img src=\"/new-technology/2020/11/28/miband5/IMG_2100.png\" class=\"\" width=\"480\" title=\"alt\">\n\n<p>平均心拍数や平均ペース（kmあたりの所要時間）に加え、ケイデンス（回転数※この場合は歩数）、ストライド（歩幅）まで出るのは驚きです。また、kmあたりのペース（スプリット）まで出るのは本格的です。心拍数も、心拍ゾーンが表示されます。この例ではかなりゆっくり、自身では心拍数は130程度を維持し負荷はほとんど感じない内容ですが、心拍ゾーンは有酸素に多く割り当てられています。インテンシブと書かれている項目は脂肪燃焼ゾーンといったほうがわかりやすいですが、自分の感覚ではもう少し低い負荷で走っているつもりが有酸素となっているのは若干違和感がありました。また、私は音楽を聴きながらのんびり走る事が多いのですが、ワークアウトを開始するとMi bandのミュージックコントロールが行えなくなってしまいます。これは仕様のようですが、若干不便なところが気になりました。</p>\n<h2 id=\"ASICSのRunkeeperを併用する\"><a href=\"#ASICSのRunkeeperを併用する\" class=\"headerlink\" title=\"ASICSのRunkeeperを併用する\"></a>ASICSのRunkeeperを併用する</h2><p>ランニングをする方には絶大な人気があるASICSのRunkeeperというスマホアプリがあります。MI bandの説明には何も書かれておらず、正式サポートはしていないかもしれませんが、このRunkeeperでMI bandから心拍数を取得できます。また、Runkeeperは音楽を再生する事が出来ます。加えて定期的に音楽のボリュームを下げて、現在の距離、ペース、心拍数などを音声で読み上げてくれるのでなかなか便利です。太陽の下でMI bandの画面を走りながら小さい画面の文字の心拍数を見るのはかなり厳しく、音声のほうが便利です。MI bandも音声読み上げ機能はありますが、Runkeeperの方ががやはり本格的です。</p>\n<h3 id=\"RunkeeperとMI-bandのペアリング\"><a href=\"#RunkeeperとMI-bandのペアリング\" class=\"headerlink\" title=\"RunkeeperとMI bandのペアリング\"></a>RunkeeperとMI bandのペアリング</h3><p>Runkeeperの設定画面を開くと、以下のように<mark class=\"label primary\">デバイス＆ハードウェア</mark>という項目があります。</p>\n<img src=\"/new-technology/2020/11/28/miband5/runkeeper1.png\" class=\"\" width=\"480\" title=\"alt\">\n<p>ここから<mark class=\"label primary\">ペアリング</mark>します。ペアリングの際はMI bandの画面を点灯させたまま行うと認識しやすいです。</p>\n<h3 id=\"RunkeeperとMI-bandの音声ガイド\"><a href=\"#RunkeeperとMI-bandの音声ガイド\" class=\"headerlink\" title=\"RunkeeperとMI bandの音声ガイド\"></a>RunkeeperとMI bandの音声ガイド</h3><p>実際の音声ガイドについては以下の項目が選択できるようになります。MI bandの情報は平均心拍数と現在の心拍数の読み上げが可能です。心拍数ゾーンという項目もありますが、これはMI bandでは利用できないようです。</p>\n<img src=\"/new-technology/2020/11/28/miband5/runkeeper2.png\" class=\"\" width=\"480\" title=\"alt\">\n\n<p>Runkeeperの読み上げは数分単位、距離単位と細かな設定が可能ですので、ペースの調整に役立ちます。以下は7分弱&#x2F;kmのペースで5km走ったRunkeeperの分析データです。ずっと同じペースで走っていますが、スタートから10分までは心拍数が急に上昇しその後はスッと落ちています。このあたりは少し見た目でわかりやすくなっていて数秒毎で平均値を取っているようにみえます。iOSの場合、Runkeeperの結果はヘルスケアに取り込めます。</p>\n<img src=\"/new-technology/2020/11/28/miband5/IMG_2101.png\" class=\"\" width=\"480\" title=\"alt\">\n\n<p>MI bandと、Runkeeperを活用し、ペースを意識しながら走る（Runkeeperは自転車の計測も可能です）ことや、もっと遅いゆっくりとしたペースで家族や友人と会話を楽しみながら走るのも良いものです。</p>\n<h2 id=\"他のデバイス、アプリとの連携\"><a href=\"#他のデバイス、アプリとの連携\" class=\"headerlink\" title=\"他のデバイス、アプリとの連携\"></a>他のデバイス、アプリとの連携</h2><p>Runkeeperは、Withingsの体重計と連携でき、RunkeeperのPCサイトでは運動と体重の推移が確認できますので、自身の健康管理にも役立ちます。Withingsの体重計のデータはWi-FiでWithingsのクラウドに自動アップロードされるため、とても便利です。</p>\n<blockquote>\n<p>Withings<br> <a href=\"https://www.withings.com/jp/ja/scales\">https://www.withings.com/jp/ja/scales</a></p>\n</blockquote>\n<p>なお、心拍数とゾーンの関係についてのもう少し詳細な説明は、<strong>以下の記事</strong>を参照してください。</p>\n<blockquote>\n<p>earnest.fit -体脂肪が効率よく燃える有酸素運動の適切な心拍数について、計算式から徹底解説-<br> <a href=\"https://earnest.fit/intensity-aerobic-exercise/\">https://earnest.fit/intensity-aerobic-exercise/</a></p>\n</blockquote>\n<p>iOS限定ではありますが、RunkeeperからAppleヘルスケアにデータ連携させておけば、その後、Zonesというアプリを利用する事でゾーン毎の運動時間を把握できます。</p>\n<img src=\"/new-technology/2020/11/28/miband5/zones.png\" class=\"\" width=\"480\" title=\"alt\">\n\n<div class=\"note warning\"><p>音楽を聴きながらジョギングする場合は公園など安全な場所で行ってください。さらに外音を取り込む機能のあるイヤホンを利用される事をお勧めします。</p>\n</div>\n","categories":["SmartWatch"],"tags":["miband"]},{"title":"MIスマートバンド6を活用する","url":"/new-technology/2021/07/24/miband6/","content":"<img src=\"/new-technology/2021/07/24/miband6/section01-1.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<h2 id=\"MIスマートバンド6（MI-band6）の発売\"><a href=\"#MIスマートバンド6（MI-band6）の発売\" class=\"headerlink\" title=\"MIスマートバンド6（MI band6）の発売\"></a>MIスマートバンド6（MI band6）の発売</h2><p>2020年の10月に発売されたMI band5から1年も経たずに、MI band6が2021年7月9日に発売されました。ディスプレイが大きくなり、SPO2（血中酸素濃度）が計測可能という触れ込みです。AmazonではXiaomi公式で5,990円で発売しています。私は一足先にグローバル版を購入して数ヶ月使っていますので使い心地などを書いていきます。グローバル版は、技適の認証を受けており、日本国内で利用可能です。MI band本体の操作メニューは英語であるものの、スマホからの通知メッセージなどは日本語表示が可能です。Zepp Lifeと呼ばれるスマホアプリで操作します。</p>\n<span id=\"more\"></span>\n\n<h2 id=\"MI-band-6の特徴（抜粋）\"><a href=\"#MI-band-6の特徴（抜粋）\" class=\"headerlink\" title=\"MI band 6の特徴（抜粋）\"></a>MI band 6の特徴（抜粋）</h2><ul>\n<li>活動指数（PAI）の管理</li>\n<li>ストレスモニタリング</li>\n<li>心拍数モニタリング</li>\n<li>睡眠モニタリング</li>\n<li>電話、メール、SMSなどの通知機能（スマホ連動）</li>\n<li>音楽再生（スマホ連動）</li>\n<li>30種類のワークアウトの記録</li>\n<li>14日間のバッテリー持ち（フル機能活用では実質4日〜5日程度）</li>\n<li>水深50m防水</li>\n</ul>\n<h2 id=\"MI-band5と比較して\"><a href=\"#MI-band5と比較して\" class=\"headerlink\" title=\"MI band5と比較して\"></a>MI band5と比較して</h2><p>Mi Band 6のディスプレイはサイズが1.56インチ、解像度が486ｘ152ピクセルとなっています。Mi Band 5は1.1インチ、294ｘ126ピクセルでしたから、視認性が高くなっています。また、ディスプレイの大型化で操作性が向上し、スマホアプリを使わずband単体で操作できる事が増えています。</p>\n<p>追加されたSPO2計測については、体内にきちんと酸素が取り込めている事を検査する目的ですが、MI band6は医療機器では無いのであくまで参考程度に考えておいたほうが良いでしょうか。</p>\n<p>MI band5はモニタリング機能を全て有効にして約2週間の電池持ちでしたが、band6の「睡眠事呼吸の質（beta機能）」を有効にし、設定頻度を全て高めにすると4日程度の電池持ちになります。これくらいであれば許容範囲ではないでしょうか。</p>\n<h2 id=\"Zepp-Lifeアプリ\"><a href=\"#Zepp-Lifeアプリ\" class=\"headerlink\" title=\"Zepp Lifeアプリ\"></a>Zepp Lifeアプリ</h2><p>MI bandを最初に使う時はiOSまたはAndroidのZepp Lifeアプリをインストールし、アプリからペアリングします。アプリを起動した画面は以下になります。</p>\n<img src=\"/new-technology/2021/07/24/miband6/zepp1.png\" class=\"\" width=\"360\" title=\"alt\">\n\n<h2 id=\"大型ディスプレイ\"><a href=\"#大型ディスプレイ\" class=\"headerlink\" title=\"大型ディスプレイ\"></a>大型ディスプレイ</h2><p>Mi Band 6のディスプレイはサイズが1.56インチ、解像度が152ｘ486ピクセル。Mi Band 5は1.1インチ、126ｘ294ピクセルでした。あまり大きくなると煩わしくなりますが、操作性はかなりアップしています。</p>\n<img src=\"/new-technology/2021/07/24/miband6/band.png\" class=\"\" width=\"360\" title=\"alt\">\n\n<p>メインディスプレイのそれぞれの機能の場所をタッチするとサブメニューに移動します。band5では画面を一旦タッチしてからメニュー一覧をスライドさせて目的の機能に移動していましたからかなり便利です。<br>多機能になった事でband6のメニュー一覧も増えていますが、量が多すぎますので表示メニューをカスタマイズし、減らす事ができます。</p>\n<img src=\"/new-technology/2021/07/24/miband6/zepp2.png\" class=\"\" width=\"360\" title=\"alt\">\n\n<p>私の場合、普段もっとも使う通知とジョギング時のミュージックコントロールはショートカットメニュー（横スワイプで表示）に割り当ているのでディスプレイ設定はストレス〜アラームの4つのみです。</p>\n<p>この1年ほどMI bandを使ってきてタイマーやストップウォッチは殆ど使う事がなく、イベントリマインダーもスマホアプリから設定する必要があるので使いづらく、使うのはアラームのみになっています。長時間の移動や乗換えタイミングなど到着5分前にアラームを設定しています。スマホのアラームだとアラーム音が鳴り響くので外出時には使いづらく感じます。平日の目覚まし目的にしてもアラーム音で起こされるよりはMI bandのバイブの方が心地よく目覚められます。</p>\n<img src=\"/new-technology/2021/07/24/miband6/face1.png\" class=\"\" width=\"360\" title=\"alt\">\n\n<p>このように画面が大きくなった事で操作性が高くなりアラームの設定もしやすいです。</p>\n<h3 id=\"SPO2\"><a href=\"#SPO2\" class=\"headerlink\" title=\"SPO2\"></a>SPO2</h3><p>MI Band6のウリとしているSPO2計測ですが、その精度を確認してみました。医療機器として認定を受けているパルスオキシメーターとMI band6とで同時計測した場合、2％-3％程度の誤差はありましたが、脈拍含めて大きな誤差はありませんでした。MI band6はバンドの締め方などでSPO2の測定値が変わる一方、パルスオキシメーターは98％〜99％で安定していました。パルスオキシメーターは例えばSPO2が90％を割り込んだ場合など、呼吸器疾患がある場合にこそ価値があるものですが、健康な人間が計測する限りでは比較や評価は難しいところです。</p>\n<img src=\"/new-technology/2021/07/24/miband6/spo2.png\" class=\"\" width=\"480\" title=\"alt\">\n\n<h3 id=\"睡眠スコア\"><a href=\"#睡眠スコア\" class=\"headerlink\" title=\"睡眠スコア\"></a>睡眠スコア</h3><p>睡眠スコアの画面です。MI bandを着けたまま寝ると睡眠スコアが記録されます。深い眠り、浅い眠り、REM睡眠、覚醒時間と分かれています。また日中に昼寝をすると、仮眠が記録されます。</p>\n<img src=\"/new-technology/2021/07/24/miband6/mifit3.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<p>今回、<mark class=\"label primary\">睡眠呼吸の質</mark>という項目が加えられています。<mark class=\"label primary\">Beta</mark>の表記がありますので、最終的にどのような機能になるかはわかりません。100点満点のスコアのうち、90点以上であれば合格のようです。アプリ上での説明では、以下のポイントが記載されています。</p>\n<ol>\n<li>就寝前に飲酒しない</li>\n<li>横向きの姿勢で寝る</li>\n<li>減量</li>\n<li>運動</li>\n</ol>\n<p>繰り返しになりますが、医療向けの製品ではありませんのであくまで参考に留め、寝る前のコーヒーを控え日中に適度な運動をしたり、自分に合った睡眠の工夫をするのが一番でしょうか。</p>\n<h3 id=\"ストレスレベル\"><a href=\"#ストレスレベル\" class=\"headerlink\" title=\"ストレスレベル\"></a>ストレスレベル</h3><p>ストレスレベルも定期的に計測してくれるので、わざわざ計測するというアクションは不要です。スマホは不要でストレスが高いかなと思った時にbandのストレス項目を確認できます。数値が高ければ深呼吸するというルーティンを作るのがおすすめです。時々計測されない時間帯がありますが、これは移動したり運動をしている時に計測しないように見えます。</p>\n<img src=\"/new-technology/2021/07/24/miband6/zepp3.png\" class=\"\" width=\"360\" title=\"alt\">\n\n<h3 id=\"心拍数\"><a href=\"#心拍数\" class=\"headerlink\" title=\"心拍数\"></a>心拍数</h3><p>bandディスプレイの心拍数がそれなりの頻度でモニタリングしてくれるのでスマホアプリで確認する必要はありません。日常生活では歩き出すとbandが計測頻度を高めてくれるので、よく使う階段などでおおよそ心拍数がどれだけ上がったかを確認できます。</p>\n<h3 id=\"PAI-パーソナルアクティビティインテリジェンス）\"><a href=\"#PAI-パーソナルアクティビティインテリジェンス）\" class=\"headerlink\" title=\"PAI(パーソナルアクティビティインテリジェンス）\"></a>PAI(パーソナルアクティビティインテリジェンス）</h3><p>MI bandには活動に反応して活動量を計測し指数化してくれる機能があります。心拍数を計測し活動量が増加すると、心拍モニタの頻度が上昇し、心拍数を細かく記録していきます。PAIは7日間の合計でスコアリングされます。これを100以上に保つ事で健康が維持されるとの事です。ロジックは公開されていませんが、年齢・性別・安静時心拍数・過去7日間の心拍数に基づきPAIスコアが計算されます。強度が低いウォーキングであれば加算される数字は小さいですし、強度の高い運動であれば数字は大きくなります。1週間前のデータは無効となるため、継続的な運動が必要です。1日全く活動しなくても構いませんが、数字はどんどん減っていきます。この数字を見ながら活動する事である程度の運動強度を意識し、PAIを100以上にし続ける事が推奨されています。このPAIは心疾患の予防の観点が主ですが、ダイエット目的にも活用できます。</p>\n<p>PAIはその人固有の状況に合わせて管理されるので、その人にとっては早歩きのウォーキングも強い活動量という事であればPAIの値も大きく増加します。一方、それなりの運動を継続している人であれば意識して早く歩き、心拍数をそれなりに上げないとPAIカウントは増えていかないようです。</p>\n<p>これらの仕組みによって、まずは自分の出来る範囲での活動から記録していく事で飽きずにモチベーションを長く維持できる仕組みとなっています。</p>\n<p>軽く30分ほど運動した日は以下の通り、PAIが16ほどカウントされています。これも特段Zepp Lifeでワークアウトを開始・終了を指示しておらず、自動的に計測されているものです。PAIは高・中・低の3種類の運動量で記録されています。</p>\n<img src=\"/new-technology/2021/07/24/miband6/IMG_2112.png\" class=\"\" width=\"480\" title=\"alt\">\n\n<p>通勤時や仕事での移動には少し早歩きしたり階段を使う事を意識するとPAIの数字が上がり、活動した実感が出てきます。PAIは100以上の数値を求めてより多く運動してもあまり効果は無いとの説明がありますが、これは心肺機能に限っての説明ですので、長い時間運動すればダイエットには効果があるでしょう。また、PAIの数値が上がれば上がるほど数字は増えにくくなる仕組みとなっているため、適度な数字を目安にすべきと考えられます。こういう数字を見る習慣をつけると、エスカレーターやエレベーターを使わずに階段を使ったり、ひと駅分は歩こうかなという気にさせてくれます。</p>\n<h3 id=\"band計測対象のカスタマイズ\"><a href=\"#band計測対象のカスタマイズ\" class=\"headerlink\" title=\"band計測対象のカスタマイズ\"></a>band計測対象のカスタマイズ</h3><p>アプリの設定で<mark class=\"label primary\">心拍数モニタリング</mark>という項目があり、その設定は以下の画面の通りです。</p>\n<img src=\"/new-technology/2021/07/24/miband6/zepp4.png\" class=\"\" width=\"360\" title=\"alt\">\n\n<h2 id=\"ASICSのRunkeeperを併用する\"><a href=\"#ASICSのRunkeeperを併用する\" class=\"headerlink\" title=\"ASICSのRunkeeperを併用する\"></a>ASICSのRunkeeperを併用する</h2><p>（この章は「<a href=\"/new-technology/2020/11/28/miband5/\" title=\"MIスマートバンド5を活用する\">MIスマートバンド5を活用する</a>」の再掲です）<br>ランニングをする方には絶大な人気があるASICSのRunkeeperというスマホアプリがあります。MI bandの説明には何も書かれておらず、正式サポートはしていないかもしれませんが、このRunkeeperでMI bandから心拍数を取得できます。また、Runkeeperは音楽を再生する事が出来ます。加えて定期的に音楽のボリュームを下げて、現在の距離、ペース、心拍数などを音声で読み上げてくれるのでなかなか便利です。太陽の下でMI bandの小さい画面の文字の心拍数を見るのはかなり厳しく、音声のほうが便利です。MI bandも音声読み上げ機能はありますが、Runkeeperの方が本格的です。</p>\n<h3 id=\"RunkeeperとMI-bandのペアリング\"><a href=\"#RunkeeperとMI-bandのペアリング\" class=\"headerlink\" title=\"RunkeeperとMI bandのペアリング\"></a>RunkeeperとMI bandのペアリング</h3><p>Runkeeperの設定画面を開くと、<mark class=\"label primary\">アプリ、サービス、およびデバイス</mark>という項目があり、さらに<mark class=\"label primary\">デバイス＆ハードウェア</mark>という項目があります。</p>\n<img src=\"/new-technology/2021/07/24/miband6/runkeeper1.png\" class=\"\" width=\"360\" title=\"alt\">\n\n<p>ここから<mark class=\"label primary\">ペアリング</mark>します。ペアリングの際は、Zepp Lifeアプリを終了させ、MI bandの画面を点灯させたまま行うと認識しやすいです。</p>\n<h3 id=\"RunkeeperとMI-bandの音声ガイド\"><a href=\"#RunkeeperとMI-bandの音声ガイド\" class=\"headerlink\" title=\"RunkeeperとMI bandの音声ガイド\"></a>RunkeeperとMI bandの音声ガイド</h3><p>実際の音声ガイドについては以下の項目が選択できるようになります。MI bandの情報は平均心拍数と現在の心拍数の読み上げが可能です。心拍数ゾーンという項目もありますが、これはMI bandでは利用できないようです。</p>\n<img src=\"/new-technology/2021/07/24/miband6/runkeeper2.png\" class=\"\" width=\"360\" title=\"alt\">\n\n<p>Runkeeperの読み上げは数分単位、距離単位と細かな設定が可能ですので、ペースの調整に役立ちます。以下は7分弱&#x2F;kmのペースで5km走ったRunkeeperの分析データです。ずっと同じペースで走っていますが、スタートから10分までは心拍数が急に上昇しその後はスッと落ちています。このあたりは少し見た目でわかりやすくなっていて数秒毎で平均値を取っているようにみえます。iOSの場合、Runkeeperの結果はヘルスケアに取り込めます。</p>\n<img src=\"/new-technology/2021/07/24/miband6/IMG_2101.png\" class=\"\" width=\"360\" title=\"alt\">\n\n<p>MI bandと、Runkeeperを活用し、ペースを意識しながら走る（Runkeeperは自転車の計測も可能です）ことや、もっと遅いゆっくりとしたペースで家族や友人と会話を楽しみながら走るのも良いものです。</p>\n","categories":["SmartWatch"],"tags":["miband"]},{"title":"マルチカレンシー口座 WISE","url":"/new-technology/2022/06/28/multi-currency-account/","content":"<img src=\"/new-technology/2022/06/28/multi-currency-account/wise.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p class=\"onepoint\">この記事で実現すること</p>\n\n<p>最近の円安や物価高と慢性的な在庫不足によりIT機器も買いづらい状況が続いています。海外通販でパーツ等を購入する時、クレジットカードやPayPalを使われている方は自動で両替されるためあまり為替レートを意識することも少ないかもしれません。輸送コストに加え、この為替の両替手数料は意外とトータルコストに響きます。少しでもコストを抑えてショッピングできる、WISEデビットカードが便利です。カードを作るのに1,200円が掛かることと多少本人確認作業に手間は掛かりますが月額の口座管理料などは掛からないため持っておくと便利なカードです。外貨口座を持てるので、海外送金も廉価に行えます。アカウントを作るにはマイナンバーカードが必要です。</p>\n<span id=\"more\"></span>\n\n<h2 id=\"匿名によるショッピングのメリットと為替手数料\"><a href=\"#匿名によるショッピングのメリットと為替手数料\" class=\"headerlink\" title=\"匿名によるショッピングのメリットと為替手数料\"></a>匿名によるショッピングのメリットと為替手数料</h2><p>米国eBayをはじめとする海外の通販サイトでパーツやIT機器をショッピングされる方はPayPalを使っていらっしゃる方が多いのでは無いでしょうか。クレジットカードを使う際のトラブルなどを考えると、住所はともかく、クレジット番号を販売者に知られたくないというのはもはや基本事項になってきていると感じます。ApplePayの利用は海外では大きく売上を伸ばしていると聞きます。日本でも個人対個人における商取引のメルカリなどは住所や支払い口座など匿名が大原則ですね。</p>\n<p>PayPalはeBayをはじめ対応しているサイトが多く、日本国内、海外に限らずよく利用されます。しかしながらPayPalの場合は日本のユーザーだと円決済でPayPalが為替レートを提示し、そのレートで外貨に両替の上取引が成立します。この手数料が4％とかなり高額です。</p>\n<p>もちろん、商売でやっていることなので一定のフィーが掛かるのはわかりますが、そのコストをユーザーからわかりづらくして4％という高額な手数料を徴収するのは私は少し抵抗があります。また、海外サイトでの為替レートの提示は例えば130円&#x2F;ドルという我々が見慣れた表記ではなく、ドル&#x2F;円表記なので”0.00769”と提示されるため余計に分かりづらくなっています。</p>\n<h2 id=\"ドルの両替相場\"><a href=\"#ドルの両替相場\" class=\"headerlink\" title=\"ドルの両替相場\"></a>ドルの両替相場</h2><p>円からドルに交換した場合、有名なクレジットカード会社、Amazon.com、PayPal、Wiseと比較しています。</p>\n<table>\n<thead>\n<tr>\n<th>両替会社</th>\n<th>手数料</th>\n<th>URL</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>三井住友カード</td>\n<td>2.20%</td>\n<td><a href=\"https://www.smbc-card.com/mem/service/sec/kaigai01.jsp\">https://www.smbc-card.com/mem/service/sec/kaigai01.jsp</a></td>\n</tr>\n<tr>\n<td>楽天カード Mastercard</td>\n<td>1.63%</td>\n<td><a href=\"https://www.rakuten-card.co.jp/overseas/payment/\">https://www.rakuten-card.co.jp/overseas/payment/</a></td>\n</tr>\n<tr>\n<td>楽天カード Visa</td>\n<td>1.63%</td>\n<td></td>\n</tr>\n<tr>\n<td>楽天カード JCB</td>\n<td>1.60%</td>\n<td></td>\n</tr>\n<tr>\n<td>イオンカード Mastercard</td>\n<td>1.60%</td>\n<td><a href=\"https://www.aeonbank.co.jp/aeoncard/use/shopping_w/\">https://www.aeonbank.co.jp/aeoncard/use/shopping_w/</a></td>\n</tr>\n<tr>\n<td>イオンカード Visa</td>\n<td>1.60%</td>\n<td></td>\n</tr>\n<tr>\n<td>イオンカード JCB</td>\n<td>1.60%</td>\n<td></td>\n</tr>\n<tr>\n<td>PayPayカード Mastercard</td>\n<td>2.20%</td>\n<td><a href=\"https://card.yahoo.co.jp/service/faq/04usage/oversea/1401.html\">https://card.yahoo.co.jp/service/faq/04usage/oversea/1401.html</a></td>\n</tr>\n<tr>\n<td>PayPayカード Visa</td>\n<td>2.20%</td>\n<td></td>\n</tr>\n<tr>\n<td>PayPayカード JCB</td>\n<td>1.60%</td>\n<td></td>\n</tr>\n<tr>\n<td>Amazon.com</td>\n<td>1.45%</td>\n<td>Yahoo  financeの週末レート(134.9600)とAmazon.comのCheckoutレート(136.9163950055)を確認（6&#x2F;18）</td>\n</tr>\n<tr>\n<td>PayPal</td>\n<td>4.00%</td>\n<td><a href=\"https://www.paypal.com/jp/webapps/mpp/paypal-fees#no-fee\">https://www.paypal.com/jp/webapps/mpp/paypal-fees#no-fee</a></td>\n</tr>\n<tr>\n<td>Wise</td>\n<td>0.60%</td>\n<td><a href=\"https://wise.com/jp/pricing/card-fees?sourceAmount=100000&amp;sourceCcy=JPY&amp;targetCcy=USD\">https://wise.com/jp/pricing/card-fees?sourceAmount=100000&amp;sourceCcy=JPY&amp;targetCcy=USD</a></td>\n</tr>\n</tbody></table>\n<p>10万円のものを購入して、Wiseでは約600円、2.2％のカード会社であれば約2,200円です。PayPalに至っては約4,000円にもなります。</p>\n<h2 id=\"Wise社とは\"><a href=\"#Wise社とは\" class=\"headerlink\" title=\"Wise社とは\"></a>Wise社とは</h2><p>Wiseは、第二種資金移動業として関東財務局に「ワイズ・ペイメンツ・ジャパン株式会社」として登録されています。金融というよりはFintechの会社というところでしょうか。また、顧客から預かった資産は自己の資産とは分別して管理されています。</p>\n<blockquote>\n<p>金融庁　資金移動業社登録一覧<br> <a href=\"https://www.fsa.go.jp/menkyo/menkyoj/shikin_idou.pdf\">https://www.fsa.go.jp/menkyo/menkyoj/shikin_idou.pdf</a></p>\n</blockquote>\n<p>Wise社はエストニア出身の二人が作った会社でロンドン証券取引所に上場しています。世界各国にWebサイトがあります。<br>Wiseデビットカードを作ると200カ国で利用できます。このブログではその機能の一部、海外通販の決済についてしか触れませんが、海外のATMで外貨を引き出したり海外送金したり外貨を受け取ることができます。</p>\n<blockquote>\n<p>Wise<br><a href=\"https://wise.com/\">https://wise.com</a></p>\n</blockquote>\n<h2 id=\"口座開設\"><a href=\"#口座開設\" class=\"headerlink\" title=\"口座開設\"></a>口座開設</h2><p>口座を作るのは無料ですが、実質的にデビットカードが必要ですので1,200円が掛かります。年会費は無料です。</p>\n<p>口座開設は本人確認が必要ですが、日本の金融機関と同じように、2つの本人確認、つまり、本人の証明と身元確認が必要です。<br>日本の法律としては犯罪収益移転防止法と税法との関係で、マイナンバーカードが必要になります。<br>本人確認はFintech企業らしく、eKYCで行われます。免許証・マイナンバーカードで犯収法の確認を行い、さらに税法上、マイナンバーの提出義務があります。この2つが身元証明です。そしてメモ紙に4桁の数字を書かされ、それを持った自分自身を写メし、画像をアップロードすることで間違いなく本人であることの証明が行われ、口座開設の本人確認が終了します。<br>運転免許証で犯収法への確認はOKですが、税法上の理由で結局はマイナンバーカードが必要です。過去に発行されたマイナンバーの通知カードでは対応できません。</p>\n<p>マイナンバーカードの写メを撮ってアップロードしたり、4桁の数字を片手で持ってもう片手のスマホで写メを撮って海外企業に送るというのは、若干の抵抗はあります。が、今の日本の法律がそれを求めているので必要なことです。</p>\n<h2 id=\"デビットカード\"><a href=\"#デビットカード\" class=\"headerlink\" title=\"デビットカード\"></a>デビットカード</h2><p>口座開設が完了したら、まずは口座に入金が必要です。国内の指定された銀行口座に円で振り込みます。最低1,200円を振り込み、デビットカードの作成に進みます。クレジットカードとは異なり、後払いではなく事前入金が必要です。入金時は、振り込み名義人にWiseの口座番号を指定するのが必要です。これを行わず普通の仮名氏名で送ってしまうと入金確認に数日掛かってしまいます（私は最初これで数日掛かってしまいました）。通常は3時間程度で反映されます。</p>\n<p>また米ドルやユーロなど使うと想定される口座を開ける必要があります。米ドル口座を開くと日本の金融機関では馴染みのない、個人のルーティングナンバーが付与され、米ドルの銀行口座として使用可能になります。海外で仕事をする時など、このルーティングナンバーを指定して振り込んでもらいます。海外通販の決済に使う場合はこのルーティングナンバーは使うことはありませんが、日本に居ながらここまでできるのは結構すごいことだなと感心しました。</p>\n<p>その後、マスターカードのアイコンがついたデビットカードが2〜3週間程度で届けられます。</p>\n<p>黄緑色のカードで表には識別する番号や名前などはありません。Mastercardのマークついており、裏面にはカード番号、名前が記入されています。</p>\n<p>さて、届いてすぐに使えるわけではなく、後払いのクレジットカードとは違い、まず円で入金しておかなければなりません。デビットカードを作るときに余分に円を入れておけばその金額分は普通にショッピングで使えます。<mark class=\"label primary\">Mastercardコンタクトレス</mark>、すなわちタッチ決済が使えますので、国内のコンビニでも気軽に使えます。</p>\n<p>最初に使うのにはお作法が必要で、指定のATMで残高照会をしてデビットカードを有効化する必要があります。<br>以下のページにあるように、有効化には以下の場所で残高照会をする必要があります。</p>\n<ul>\n<li>イオン</li>\n<li>イーネット</li>\n<li>ビューカード</li>\n<li>デイリーヤマザキ</li>\n</ul>\n<p>私はイオン銀行のATMで残高照会をしてみましたが使えないカードと言われてしまいました。。。<br>結局ファミリーマートのATMのイーネットで残高照会をし有効化できました。残高照会時に照会する口座種別を聞かれたように記憶していますが、その際は「チェッキング」を選択します。チェッキングは決済用口座で一般的に決済用の用途で利用され、金利がつかない口座のことです。</p>\n<blockquote>\n<p>Wiseデビットカードを有効化する方法<br> <a href=\"https://wise.com/ja/help/articles/2978024/\">https://wise.com/ja/help/articles/2978024/</a></p>\n</blockquote>\n<p>その日のうちにコンビニでタッチ決済を使ってみましたが、利用の記録もアプリで確認できました。</p>\n<h2 id=\"アプリと両替\"><a href=\"#アプリと両替\" class=\"headerlink\" title=\"アプリと両替\"></a>アプリと両替</h2><p>Wiseのアプリをスマホにインストールしておくと便利です。好きなタイミングで外貨に交換できます。あらかじめ両替しておいてももちろん構いませんが、円貨のまま保有していても通販で購入時にWise側で外貨に自動的に両替してくれるので便利です（特に割り増し手数料などはありません）。もちろん、事前にある程度まとまった金額をドルに変えておいても良いですね（今後さらに円安に振れるとお考えなのであれば）。アプリは2要素認証に対応しており、Webログイン時にプッシュ通知で確認を求められるように設定できます。</p>\n<p>両替自体はマーケットレートを使って一瞬で交換が成立します（その時に手数料も差し引かれます）。</p>\n<p>なお、自動両替という機能もあり、レートを指定しておくと、そのレートになった時に両替してくれる機能もあります。</p>\n<h2 id=\"ネットショッピングでの使い方\"><a href=\"#ネットショッピングでの使い方\" class=\"headerlink\" title=\"ネットショッピングでの使い方\"></a>ネットショッピングでの使い方</h2><p>Amazon、eBay(PayPal)など外貨で決済を使うユーザーに最も適しています。</p>\n<h3 id=\"eBayの場合\"><a href=\"#eBayの場合\" class=\"headerlink\" title=\"eBayの場合\"></a>eBayの場合</h3><p>仮にConnect X-3をeBayで購入するとしましょう。</p>\n<img src=\"/new-technology/2022/06/28/multi-currency-account/ebay1.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p>カートに入れて…USDを選んで…</p>\n<img src=\"/new-technology/2022/06/28/multi-currency-account/ebay2.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p>確認、ここで気を付けてください！！「今すぐ支払う」をクリックしてはいけません。</p>\n<img src=\"/new-technology/2022/06/28/multi-currency-account/ebay3.png\" class=\"\" width=\"480\" title=\"alt\">\n<p>eBayでドル払いと言いつつ、PayPalが円からドルに4％の手数料で両替し、円＋手数料をPayPalに払うことになってしまうんです。<br>わざと目立たなくしている、「通貨オプションを表示」をクリックする必要があります。ここでは私が赤枠で囲っていますが、人間の目線をうまく回避するかのような絶妙な右側の外れた位置にポツンと円表記があります。</p>\n<img src=\"/new-technology/2022/06/28/multi-currency-account/ebay4.png\" class=\"\" width=\"480\" title=\"alt\">\n<p>これは毎回「通貨オプションを表示」をクリックする必要があります。</p>\n<p>USDをクリックして確実にWiseでドル払いにして決済します。</p>\n<img src=\"/new-technology/2022/06/28/multi-currency-account/ebay5.png\" class=\"\" width=\"480\" title=\"alt\">\n\n<h3 id=\"Amazon-comの場合\"><a href=\"#Amazon-comの場合\" class=\"headerlink\" title=\"Amazon.comの場合\"></a>Amazon.comの場合</h3><p>こちらも同じような状況です。ipolexの2PortのX710がありました。でも高いですね。。。4ヶ月前にX710の4Portが$500だったのに2Portで＄420です。。</p>\n<img src=\"/new-technology/2022/06/28/multi-currency-account/amazon1.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p>Amaon.comの場合は、普通にクレジットカードのようにカード番号を入力して購入します。私はドル払いでしかAmazon.comで購入したことはありませんが、デフォルトは円払いになっています。良い点は為替レートが良心的であることでしょうか。それでも約1.5％ですね。あとは1ドル137円という表記で多少は分かりやすいのが良いところでしょうか。</p>\n<img src=\"/new-technology/2022/06/28/multi-currency-account/amazon2.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p>こちらもドル払いに変更して、チェックアウトします。</p>\n<h2 id=\"リスク\"><a href=\"#リスク\" class=\"headerlink\" title=\"リスク\"></a>リスク</h2><p>便利なデビットカードによるショッピングですがデメリットもあります。一般的なクレジットカードに付帯されている海外通販などの保険がありません。Wiseの約款においてはショッピング保険などの対応は一切できないことが明確です。従い、多くのサイトでカード番号を入力せずに、信頼のおけるサイトやタッチ決済などのクレカ番号が相手に知られない決済方法に限り利用すべきでしょう。</p>\n<h2 id=\"利用限度額\"><a href=\"#利用限度額\" class=\"headerlink\" title=\"利用限度額\"></a>利用限度額</h2><p>Wiseのアプリでは利用限度額が設定できます。</p>\n<ul>\n<li>ATM引き出し</li>\n<li>ICチップ決済（暗証番号を使った決済）</li>\n<li>磁気ストライプ決済</li>\n<li>オンラインでの支払い</li>\n<li>コンタクトレス決済</li>\n</ul>\n<p>これだけ細かく設定できればカード紛失を想定しあらかじめ設定しておけるでしょう。</p>\n<h2 id=\"まとめ\"><a href=\"#まとめ\" class=\"headerlink\" title=\"まとめ\"></a>まとめ</h2><p>海外の色々なものが割高になっているので気軽に買い物できる状況には無いかもしれませんが、持っておいて損はないカードです。是非検討される事をお勧めします。</p>\n"},{"title":"ESXiでネットワークカードのファームウェアを更新する","url":"/new-technology/2022/04/02/nic-firmware/","content":"<img src=\"/new-technology/2022/04/02/nic-firmware/title.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p class=\"onepoint\">この記事で実現すること</p>\n\n<p>ESXiにおいてネットワークカードの主要ITベンダーであるintelおよびMellanox(NVidia)のファームウェアをアップデートします。sshでESXiホストに接続したままアップデート可能です（作業中は何度かのシステムリスタートが必要になります）。</p>\n<span id=\"more\"></span>\n\n<h2 id=\"ネットワークカード自体の脆弱性\"><a href=\"#ネットワークカード自体の脆弱性\" class=\"headerlink\" title=\"ネットワークカード自体の脆弱性\"></a>ネットワークカード自体の脆弱性</h2><p>（2023-3-5更新）<br>2023-2-14にintelのサイトで700シリーズおよびE810シリーズでCVE-2022-36382の脆弱性について発表がありました。<br>境界外への書き込みでサービス拒否に繋がるとの事（Base Score: 6.0 MEDIUM）です。</p>\n<p>その数日後の23-2-17に700シリーズでは新しいv9.2、およびE180シリーズではv4.2のファームウェアが発表されています。</p>\n<blockquote>\n<p>Intel® Ethernet Controllers and Adapters Advisory<br> <a href=\"https://www.intel.com/content/www/us/en/security-center/advisory/intel-sa-00754.html\">https://www.intel.com/content/www/us/en/security-center/advisory/intel-sa-00754.html</a></p>\n</blockquote>\n<blockquote>\n<p>Intel 700 nvmupdate v9.2<br> <a href=\"https://www.intel.co.jp/content/www/jp/ja/download/18638/non-volatile-memory-nvm-update-utility-for-intel-ethernet-adapters-700-series-vmware-esx.html?wapkw=nvm%E3%80%80update\">https://www.intel.co.jp/content/www/jp/ja/download/18638/non-volatile-memory-nvm-update-utility-for-intel-ethernet-adapters-700-series-vmware-esx.html?wapkw=nvm%E3%80%80update</a></p>\n</blockquote>\n<blockquote>\n<p>Intel E810 nvmupdate v4.2<br> <a href=\"https://www.intel.com/content/www/us/en/download/19624/non-volatile-memory-nvm-update-utility-for-intel-ethernet-network-adapter-e810-series.html\">https://www.intel.com/content/www/us/en/download/19624/non-volatile-memory-nvm-update-utility-for-intel-ethernet-network-adapter-e810-series.html</a></p>\n</blockquote>\n<blockquote>\n<p>NATIONAL VULNERABILITY DATABASE<br> <a href=\"https://nvd.nist.gov/vuln/detail/CVE-2022-36382\">https://nvd.nist.gov/vuln/detail/CVE-2022-36382</a></p>\n</blockquote>\n<p>脆弱性対策情報データベースである、JVN iPdeiaでの検索では、2020年以降、Intel(R) Ethernet I210 Controller、Intel(R) Ethernet 700 Series Controller 、Intel(R) Ethernet Network Controller E810において脆弱性が発見されています。</p>\n<ul>\n<li>JVN iPdeia （”Intel Ethernet Controller”で検索）<br> <a href=\"https://jvndb.jvn.jp/search/index.php?mode=_vulnerability_search_IA_VulnSearch&amp;lang=ja&amp;keyword=Intel+Ethernet+Controller&amp;useSynonym=1&amp;vendor=&amp;product=&amp;datePublicFromYear=&amp;datePublicFromMonth=&amp;datePublicToYear=&amp;datePublicToMonth=&amp;dateLastPublishedFromYear=&amp;dateLastPublishedFromMonth=&amp;dateLastPublishedToYear=&amp;dateLastPublishedToMonth=&amp;cwe=&amp;searchProductId=\">https://jvndb.jvn.jp/search/index.php?mode=_vulnerability_search_IA_VulnSearch&amp;lang=ja&amp;keyword=Intel+Ethernet+Controller&amp;useSynonym=1&amp;vendor=&amp;product=&amp;datePublicFromYear=&amp;datePublicFromMonth=&amp;datePublicToYear=&amp;datePublicToMonth=&amp;dateLastPublishedFromYear=&amp;dateLastPublishedFromMonth=&amp;dateLastPublishedToYear=&amp;dateLastPublishedToMonth=&amp;cwe=&amp;searchProductId=</a></li>\n</ul>\n<p>Mellanox(NVIDIA)のネットワークカードについては脆弱性は見つかっていないようです。</p>\n<h2 id=\"ネットワークカード-NIC-の保守期限\"><a href=\"#ネットワークカード-NIC-の保守期限\" class=\"headerlink\" title=\"ネットワークカード(NIC)の保守期限\"></a>ネットワークカード(NIC)の保守期限</h2><p>ESXiでのドライバはintelやMellanoxを使っている限りは最適なドライバがパッチ公開のタイミングで提供されます。但し、チップを動作させるネットワークカード上のファームウェアは別途NICの提供ベンダーからのパッチを適用する必要があります。<br>ESXiのハードウェア互換リストでは古いネットワークカードでも対応している場合があります。しかし、ベンダー側でサポート終了（EOSL）となっている製品もあり注意が必要です。ビジネス用途でなければ使えるうちは使うといった対応が取れますが、万が一ファームウェアで脆弱性などが指摘された場合は、そのNICの利用を取りやめる必要が出てきます。</p>\n<h2 id=\"intelのサポート終了NIC\"><a href=\"#intelのサポート終了NIC\" class=\"headerlink\" title=\"intelのサポート終了NIC\"></a>intelのサポート終了NIC</h2><p>以下のリンクではintelの製造終了のNIC一覧情報があります。さらに5年経過でサポート終了という事です。X520やX540なども製造終了しており、5年間の保証ポリシーの対象となっています。</p>\n<ul>\n<li>intel<br> <a href=\"https://www.intel.co.jp/content/www/jp/ja/support/articles/000026530/ethernet-products/legacy-ethernet-products.html\">https://www.intel.co.jp/content/www/jp/ja/support/articles/000026530/ethernet-products/legacy-ethernet-products.html</a></li>\n</ul>\n<p>しかし、X520とX540の新しいファームウェアのダウンロードについては見つかりませんでした。私の見落としでなければ、最新版のファームウェアの提示が無いというのはこれから新規導入する場合、リスクが大きく感じます。</p>\n<h2 id=\"Melanoxのサポート終了NIC\"><a href=\"#Melanoxのサポート終了NIC\" class=\"headerlink\" title=\"Melanoxのサポート終了NIC\"></a>Melanoxのサポート終了NIC</h2><p>Mellanoxにおいても”Products End-of-Life Policy”というものがあり、販売終了から5年経過し、End of Supportとなるようです。<br>以前にはEOSの製品一覧が記載されているExcelファイルが置いてあったんですが、最近は無くなってしまいました。</p>\n<p>最近は$40で購入できるMCX311A-XCATなどは2020年3月31日に販売終了となっています。<br>Mellanoxの場合はVMwareの互換リストから外れているConnect X-3についてもWebにはファームウェアの情報が掲載されているので、いつでも最新のファームウェアに更新できます。</p>\n<h2 id=\"intelのNICファームウェア更新\"><a href=\"#intelのNICファームウェア更新\" class=\"headerlink\" title=\"intelのNICファームウェア更新\"></a>intelのNICファームウェア更新</h2><p>intelの純正のNICであればそのカード名称でintelのサイトを検索しファームウェアを更新します。また、3rdベンダーがintelチップを採用し製造したNICだとintelのチップの名称でファームウェアをダウンロードする必要があります。「<a href=\"/new-technology/2022/02/27/building-setup-esxi7/\" title=\"ESXI7.0をRyzen7 5700Gで構築\">ESXI7.0をRyzen7 5700Gで構築</a>」では、私は3rdベンダーが製造したintel X710を搭載したNICを購入したと書きましたが、このようなケースではintelが提供するファームウェアを適用可能なのか、それとも3rdベンダーが提供するファームウェアがあるのか事前に確認する必要があります。X710のSFP＋を4Portというのは低消費電力・低発熱で魅力的ですが、前述した脆弱性について既に確認していたため、ファームウェアのアップデートに言及できるベンダーのものを選定しました。販売者の中には「できるはずだがお勧めしない」という回答もありました。3rdベンダーの場合は、ファームウェアアップデートの設定ファイルの書き換えが必要な場合もあります（私の購入したNICはこの修正が不要でした）。</p>\n<p>導入はシンプルでnvmupdateというファームウェア更新ツールとセットになったNICのファームウェアをintelのサイトからダウンロードし、ESXiにSSHで接続し実行するだけです。留意点としては、誤った種類のファームウェア適用によりNICが使えなくなってしまった場合は自己責任であり、リスクはあります。</p>\n<p>導入手順を説明します。intelのサイトで”nvm update”を検索します。するとX550シリーズ、700シリーズ、E810シリーズとnvmupdateについて表示されるのでお使いのチップに相当するモジュールをダウンロードしてください。intel純正のカードであればカード名で検索も可能です。</p>\n<ul>\n<li><p>X550シリーズ<br> <a href=\"https://www.intel.co.jp/content/www/jp/ja/download/19362/non-volatile-memory-nvm-update-utility-for-intel-ethernet-adapters-550-series-vmware-esx.html?wapkw=nvm%20update%20esxi\">https://www.intel.co.jp/content/www/jp/ja/download/19362/non-volatile-memory-nvm-update-utility-for-intel-ethernet-adapters-550-series-vmware-esx.html?wapkw=nvm%20update%20esxi</a></p>\n</li>\n<li><p>700シリーズ<br> <a href=\"https://www.intel.co.jp/content/www/jp/ja/download/18638/non-volatile-memory-nvm-update-utility-for-intel-ethernet-adapters-700-series-vmware-esx.html?wapkw=nvm%E3%80%80update\">https://www.intel.co.jp/content/www/jp/ja/download/18638/non-volatile-memory-nvm-update-utility-for-intel-ethernet-adapters-700-series-vmware-esx.html?wapkw=nvm%E3%80%80update</a></p>\n</li>\n<li><p>E810シリーズ<br> <a href=\"https://www.intel.co.jp/content/www/jp/ja/download/19628/non-volatile-memory-nvm-update-utility-for-intel-ethernet-network-adapters-e810-series-vmware-esx.html?wapkw=e810%20nvm%20update\">https://www.intel.co.jp/content/www/jp/ja/download/19628/non-volatile-memory-nvm-update-utility-for-intel-ethernet-network-adapters-e810-series-vmware-esx.html?wapkw=e810%20nvm%20update</a></p>\n</li>\n</ul>\n<p>それぞれのダウンロードページには、クイック使用ガイドというものがありますのでそこに詳細な手順が記されています。</p>\n<p> <a href=\"https://www.intel.co.jp/content/www/jp/ja/embedded/products/networking/nvm-update-tool-vmware-esx-quick-usage-guide.html\">https://www.intel.co.jp/content/www/jp/ja/embedded/products/networking/nvm-update-tool-vmware-esx-quick-usage-guide.html</a></p>\n<p>700シリーズのファームウェア適用の実例です。まずNICのFirmwareを確認します。対象のNIC（vmnicx）を指定し内容を確認します。<code>esxcli network nic get -n [物理NICのID]</code></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@esxi2:~] esxcli network nic get -n vmnic0</span><br><span class=\"line\">   Advertised Auto Negotiation: true</span><br><span class=\"line\">   Advertised Link Modes: Auto, 10000BaseT/Full</span><br><span class=\"line\">   Auto Negotiation: true</span><br><span class=\"line\">   Cable Type: DA</span><br><span class=\"line\">   Current Message Level: 1</span><br><span class=\"line\">   Driver Info:</span><br><span class=\"line\">         Bus Info: 0000:01:00:0</span><br><span class=\"line\">         Driver: i40en</span><br><span class=\"line\">         Firmware Version: 8.50 0x8000b6c5 1.2074.0</span><br><span class=\"line\">         Version: 1.11.1.31</span><br><span class=\"line\">   Link Detected: true</span><br><span class=\"line\">   Link Status: Up</span><br><span class=\"line\">   Name: vmnic0</span><br><span class=\"line\">   PHYAddress: 0</span><br><span class=\"line\">   Pause Autonegotiate: false</span><br><span class=\"line\">   Pause RX: true</span><br><span class=\"line\">   Pause TX: true</span><br><span class=\"line\">   Supported Ports: DA</span><br><span class=\"line\">   Supports Auto Negotiation: true</span><br><span class=\"line\">   Supports Pause: true</span><br><span class=\"line\">   Supports Wakeon: true</span><br><span class=\"line\">   Transceiver:</span><br><span class=\"line\">   Virtual Address: 00:00:00:00:00:00</span><br><span class=\"line\">   Wakeon: MagicPacket(tm)</span><br></pre></td></tr></table></figure>\n<p>続いてダウンロードしたファイル（700シリーズは2023年3月5日時点では最新がv9.2です）をscpかストアブラウザを使ってESXi上にアップロードします。その後展開し実行します。<br>特に注意点はありませんが、私は実行にあたりメンテナンスモードにして（VMを停止）から開始しました（アップデート中に、仮想マシンが止まるようなことはありませんが）。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@esxi2:] tar -xvf 700Series_NVMUpdatePackage_v9_20_ESX.tar.gz</span><br><span class=\"line\">#展開されたフォルダに入り以下を実行します。</span><br><span class=\"line\">[root@esxi2:] ./nvmupdaten64e</span><br></pre></td></tr></table></figure>\n\n<p>以下ではNICを全て対象、NVMイメージのバックアップは有りということで実行したログになります。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">Intel(R) Ethernet NVM Update Tool</span><br><span class=\"line\">NVMUpdate version 1.39.32.6</span><br><span class=\"line\">Copyright(C) 2013 - 2023 Intel Corporation.</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">WARNING: To avoid damage to your device, do not stop the update or reboot or power off the system during this update.</span><br><span class=\"line\">Inventory in progress. Please wait [****......]</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Num Description                          Ver.(hex)  DevId S:B    Status</span><br><span class=\"line\">=== ================================== ============ ===== ====== ==============</span><br><span class=\"line\">01) Intel(R) Ethernet Controller X710  8.112(8.70)   1572 00:001 Update</span><br><span class=\"line\">    for 10GbE SFP+                                               available</span><br><span class=\"line\"></span><br><span class=\"line\">Options: Adapter Index List (comma-separated), [A]ll, e[X]it</span><br><span class=\"line\">Enter selection: A</span><br><span class=\"line\">Would you like to back up the NVM images? [Y]es/[N]o: Y</span><br><span class=\"line\">Update in progress. This operation may take several minutes.</span><br><span class=\"line\">[....|*****]</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Num Description                          Ver.(hex)  DevId S:B    Status</span><br><span class=\"line\">=== ================================== ============ ===== ====== ==============</span><br><span class=\"line\">01) Intel(R) Ethernet Controller X710   9.32(9.20)   1572 00:001 Update</span><br><span class=\"line\">    for 10GbE SFP+                                               successful</span><br><span class=\"line\"></span><br><span class=\"line\">Reboot is required to complete the update process.</span><br><span class=\"line\"></span><br><span class=\"line\">Tool execution completed with the following status: All operations completed successfully.</span><br><span class=\"line\">Press any key to exit.</span><br><span class=\"line\"></span><br><span class=\"line\">[root@esxi2:~] reboot</span><br></pre></td></tr></table></figure>\n<p>最後にリブートが必要とのことでリブートしています。</p>\n<p>ホストが再起動後、ファームウェアが適用されているか再び確認します。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@esxi2:~] esxcli network nic get -n vmnic0</span><br><span class=\"line\">   Advertised Auto Negotiation: true</span><br><span class=\"line\">   Advertised Link Modes: Auto, 10000BaseT/Full</span><br><span class=\"line\">   Auto Negotiation: true</span><br><span class=\"line\">   Cable Type: DA</span><br><span class=\"line\">   Current Message Level: 1</span><br><span class=\"line\">   Driver Info:</span><br><span class=\"line\">         Bus Info: 0000:01:00:0</span><br><span class=\"line\">         Driver: i40en</span><br><span class=\"line\">         Firmware Version: 9.20 0x8000d8bc 1.2074.0</span><br><span class=\"line\">         Version: 1.11.1.31</span><br><span class=\"line\">   Link Detected: true</span><br><span class=\"line\">   Link Status: Up</span><br><span class=\"line\">   Name: vmnic0</span><br><span class=\"line\">   PHYAddress: 0</span><br><span class=\"line\">   Pause Autonegotiate: false</span><br><span class=\"line\">   Pause RX: true</span><br><span class=\"line\">   Pause TX: true</span><br><span class=\"line\">   Supported Ports: DA</span><br><span class=\"line\">   Supports Auto Negotiation: true</span><br><span class=\"line\">   Supports Pause: true</span><br><span class=\"line\">   Supports Wakeon: true</span><br><span class=\"line\">   Transceiver:</span><br><span class=\"line\">   Virtual Address: 00:00:00:00:00:00</span><br><span class=\"line\">   Wakeon: MagicPacket(tm)</span><br></pre></td></tr></table></figure>\n\n<p><code>Firmware Version: 9.20</code>ということで、無事更新されました。</p>\n<p>intelの手順書では、NOTEとして、以下の説明があります。</p>\n<blockquote>\n<p>On 700 Series and 500 Series devices, updating to the most current NVM (with the NVM Update Package) and driver does not update the Option ROM. Intel recommends an Option ROM update after the NVM and driver are updated. Refer to the User Guide for Intel® Ethernet Adapters page for the most current Option ROM update process version.</p>\n</blockquote>\n<p>これはネットワークブート時の<mark class=\"label primary\">UEFI Network Driver Option ROM</mark>をLinuxまたはUEFIシェルを使ってUEFIネットワークドライバを更新するものです。今回はこの作業については割愛します。</p>\n<h2 id=\"MellanoxのNICファームウェア更新\"><a href=\"#MellanoxのNICファームウェア更新\" class=\"headerlink\" title=\"MellanoxのNICファームウェア更新\"></a>MellanoxのNICファームウェア更新</h2><p>Mellanoxの場合は、NVIDIAのサイトに”How-to: Install NVIDIA Firmware Tools (MFT) on VMware ESXi 6.7&#x2F;7.0.”というマニュアルがありますので、そこで手順を確認します。</p>\n<blockquote>\n<p>How-to: Install NVIDIA Firmware Tools (MFT) on VMware ESXi 6.7&#x2F;7.0.<br> <a href=\"https://docs.nvidia.com/networking/pages/releaseview.action?pageId=15049813\">https://docs.nvidia.com/networking/pages/releaseview.action?pageId=15049813</a></p>\n</blockquote>\n<p>NVIDIA Firmware Toolをダウンロードし、ESXiにインストールします。その後別途ファームウェアをダウンロードしてファームウェアのアップグレードを行います。昔はflintでしたが、上記手順によれば今はmlxfwmanagerというのが使われるようです。Windowsではそのサブセットのmlxupが一般的です。</p>\n<ol>\n<li><p>ツールを2つダウンロードするために、ダウンロードページにアクセスします。<br> <a href=\"http://www.mellanox.com/page/management_tools\">http://www.mellanox.com/page/management_tools</a></p>\n</li>\n<li><p>ここの例ではESXi7.0向けのVersion4.18.1を使い進めます。</p>\n</li>\n<li><p>“7 Native”、”x64”を選択し、”Mellanox-NATIVE-NMST_4.18.1.14-1OEM.700.1.0.15843807_19206114-package.zip”をダウンロードし展開します。</p>\n</li>\n<li><p>ZIPの中にはさらにZIPファイルがあり、”MEL_bootbank_nmst_4.18.1.14-1OEM.700.1.0.15843807.vib”というESXiのモジュールファイルを見つけます。 <img src=\"/new-technology/2022/04/02/nic-firmware/nmst.png\" class=\"\" width=\"480\" title=\"alt\"></p>\n</li>\n<li><p>続いて、”Mellanox-MFT-Tools_4.18.1.14-1OEM.700.1.0.15843807_19206112-package.zip”をダウンロードし展開します。</p>\n</li>\n<li><p>こちらもZIPの中にさらにZIPファイルがあり、”mft”というフォルダの中に”MEL_bootbank_mft_4.18.1.14-0.vib”のモジュールファイルを見つけます。別にOEMというフォルダがあり、NVIDIAの手順書でもファイル名からもOEMを選ぶべきのように見えますが、OEMのフォルダのものは必要なモジュールが見つかりません。<img src=\"/new-technology/2022/04/02/nic-firmware/mft.png\" class=\"\" width=\"480\" title=\"alt\"></p>\n</li>\n<li><p>scpかストアブラウザを使いこの2つのファイルをESXiにアップロードします。2つのモジュールは1つづつインストール、リブートが必要になりますので、&#x2F;tmpにコピーする場合は最初のリブートで&#x2F;tmpがクリアされるのでお気をつけください。</p>\n</li>\n<li><p>ESXiにSSHで接続し、最初のモジュール(NMST)をインストールします。<code>esxcli software vib install -v /tmp/MEL_bootbank_nmst_4.18.1.14-1OEM.700.1.0.15843807.vib -f</code></p>\n <figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@localhost:/tmp] esxcli software vib install -v /tmp/MEL_bootbank_nmst_4.18.1.14-1OEM.700.1.0.15843807.vib -f</span><br><span class=\"line\">Installation Result</span><br><span class=\"line\">   Message: The update completed successfully, but the system needs to be rebooted <span class=\"keyword\">for</span> the changes to be effective.</span><br><span class=\"line\">   Reboot Required: <span class=\"literal\">true</span></span><br><span class=\"line\">   VIBs Installed: MEL_bootbank_nmst_4.18.1.14-1OEM.700.1.0.15843807</span><br><span class=\"line\">   VIBs Removed:</span><br><span class=\"line\">   VIBs Skipped:</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></li>\n<li><p>ここで一旦リブートします。</p>\n</li>\n<li><p>SSHで接続後、2つ目のモジュール(MFT-Tools)をインストールします。<code>esxcli software vib install -v /tmp/MEL_bootbank_mft_4.18.1.14-0.vib -f</code></p>\n <figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\"> [root@localhost:/tmp] esxcli software vib install -v /tmp/MEL_bootbank_mft_4.18.1.14-0.vib -f</span><br><span class=\"line\">Installation Result</span><br><span class=\"line\">   Message: The update completed successfully, but the system needs to be rebooted for the changes to be effective.</span><br><span class=\"line\">   Reboot Required: true</span><br><span class=\"line\">   VIBs Installed: MEL_bootbank_mft_4.18.1.14-0</span><br><span class=\"line\">   VIBs Removed:</span><br><span class=\"line\">   VIBs Skipped:</span><br></pre></td></tr></table></figure></li>\n<li><p>再びリブートします。</p>\n</li>\n<li><p>ESXiにインストールされているモジュールを確認します。<code>esxcli software vib list</code><br> 先頭に以下のモジュールがあるはずです。PartnerSupportedとなっており、セキュアブートのESXiでも問題ありません。</p>\n <figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\"> Name                           Version                                Vendor  Acceptance Level  Install Date</span><br><span class=\"line\">-----------------------------  -------------------------------------  ------  ----------------  ------------</span><br><span class=\"line\">mft                            4.18.1.14-0                            MEL     PartnerSupported  2022-03-13</span><br><span class=\"line\">nmst                           4.18.1.14-1OEM.700.1.0.15843807        MEL     PartnerSupported  2022-03-13</span><br></pre></td></tr></table></figure></li>\n<li><p>SSHで接続後、ツールの動作確認をします。ここではConnectX3がある環境です。<code>cd /opt/mellanox/bin</code>,<code>./mst start</code>,<code>./mst status</code>,<code>./mst status -vv</code></p>\n <figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@localhost:/opt/mellanox/bin] ./mst start</span><br><span class=\"line\">Module mst is already loaded</span><br><span class=\"line\">[root@localhost:/opt/mellanox/bin] ./mst status</span><br><span class=\"line\">MST devices:</span><br><span class=\"line\">------------</span><br><span class=\"line\">mt4099_pciconf0</span><br><span class=\"line\">mt4099_pci_cr0</span><br><span class=\"line\"></span><br><span class=\"line\">[root@localhost:/opt/mellanox/bin] /opt/mellanox/bin/mst status -vv</span><br><span class=\"line\">PCI devices:</span><br><span class=\"line\">------------</span><br><span class=\"line\">DEVICE_TYPE             MST                           PCI       RDMA            NET                       NUMA</span><br><span class=\"line\">ConnectX3(rev:1)        mt4099_pciconf0               01:00.0   net-vmnic0</span><br><span class=\"line\">ConnectX3(rev:1)        mt4099_pci_cr0                01:00.0   net-vmnic0</span><br></pre></td></tr></table></figure></li>\n<li><p>ファームウェアアップデートに使うmlxfwmanagerの動作確認をします。<code>./mlxfwmanager --query</code></p>\n <figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@localhost:/opt/mellanox/bin] ./mlxfwmanager --query</span><br><span class=\"line\">Querying Mellanox devices firmware ...</span><br><span class=\"line\"></span><br><span class=\"line\">Device #1:</span><br><span class=\"line\">----------</span><br><span class=\"line\"></span><br><span class=\"line\"> Device Type:      ConnectX3</span><br><span class=\"line\"> Part Number:      MCX311A-XCA_Ax</span><br><span class=\"line\"> Description:      ConnectX-3 EN network interface card; 10GigE; single-port SFP+; PCIe3.0 x4 8GT/s; RoHS R6</span><br><span class=\"line\"> PSID:             MT_1170110023</span><br><span class=\"line\"> PCI Device Name:  mt4099_pci_cr0</span><br><span class=\"line\"> Port1 MAC:        0002c9xxxxxx</span><br><span class=\"line\"> Port2 MAC:        0002c9xxxxxx</span><br><span class=\"line\"> Versions:         Current        Available</span><br><span class=\"line\">    FW             2.33.5220      N/A</span><br><span class=\"line\">    PXE            3.4.0467       N/A</span><br><span class=\"line\"></span><br><span class=\"line\"> Status:           No matching image found</span><br></pre></td></tr></table></figure>\n<p> 今回のケースでは、ebayにて＄50で購入可能な、ConnectX-3（MCX311A-XCAT）を対象としています。</p>\n</li>\n<li><p>NVIDIAのサイトからファームウェアをダウンロードします。<br>　<a href=\"https://network.nvidia.com/support/firmware/firmware-downloads/\">https://network.nvidia.com/support/firmware/firmware-downloads/</a></p>\n</li>\n<li><p>該当するEthernetファームウェアを選択し、ZIPファイルをダウンロードし展開します。*.binというファイルが抽出されます。</p>\n <img src=\"/new-technology/2022/04/02/nic-firmware/firmware.png\" class=\"\" width=\"480\" title=\"alt\">\n</li>\n<li><p>scpまたはストアブラウザでbinファイルをESXiの&#x2F;tmpにアップロードします。</p>\n</li>\n<li><p>ファームウェアのアップデートを行います <code>./mlxfwmanager -u -i /tmp/ファームウェア.bin</code>。ファームウェアの実行直前に確認が求められるので、”y”を入力します。</p>\n <figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@localhost:/opt/mellanox/bin] ./mlxfwmanager -u -i /tmp/fw-ConnectX3-rel-2_42_5000-MCX311A-XCA_Ax-FlexBoot-3.4.752.bin</span><br><span class=\"line\">Querying Mellanox devices firmware ...</span><br><span class=\"line\"></span><br><span class=\"line\">Device #1:</span><br><span class=\"line\">----------</span><br><span class=\"line\"></span><br><span class=\"line\"> Device Type:      ConnectX3</span><br><span class=\"line\"> Part Number:      MCX311A-XCA_Ax</span><br><span class=\"line\"> Description:      ConnectX-3 EN network interface card; 10GigE; single-port SFP+; PCIe3.0 x4 8GT/s; RoHS R6</span><br><span class=\"line\"> PSID:             MT_1170110023</span><br><span class=\"line\"> PCI Device Name:  mt4099_pci_cr0</span><br><span class=\"line\"> Port1 MAC:        0002c9232da0</span><br><span class=\"line\"> Port2 MAC:        0002c9232da1</span><br><span class=\"line\"> Versions:         Current        Available</span><br><span class=\"line\">    FW             2.33.5220      2.42.5000</span><br><span class=\"line\">    PXE            3.4.0467       3.4.0752</span><br><span class=\"line\"></span><br><span class=\"line\"> Status:           Update required</span><br><span class=\"line\"></span><br><span class=\"line\">---------</span><br><span class=\"line\">Found 1 device(s) requiring firmware update...</span><br><span class=\"line\"></span><br><span class=\"line\">Perform FW update? [y/N]: y</span><br><span class=\"line\">Device #1: Updating FW ...</span><br><span class=\"line\">Done</span><br><span class=\"line\"></span><br><span class=\"line\">Restart needed for updates to take effect.</span><br></pre></td></tr></table></figure></li>\n<li><p>リブートします。</p>\n</li>\n<li><p>再び、<code>./mlxfwmanager --query</code>を実行し、ファームウェアがアップデートされたか確認します。</p>\n <figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">[root@localhost:/opt/mellanox/bin]  ./mlxfwmanager --query</span><br><span class=\"line\">Querying Mellanox devices firmware ...</span><br><span class=\"line\"></span><br><span class=\"line\">Device #1:</span><br><span class=\"line\">----------</span><br><span class=\"line\"></span><br><span class=\"line\"> Device Type:      ConnectX3</span><br><span class=\"line\"> Part Number:      MCX311A-XCA_Ax</span><br><span class=\"line\"> Description:      ConnectX-3 EN network interface card; 10GigE; single-port SFP+; PCIe3.0 x4 8GT/s; RoHS R6</span><br><span class=\"line\"> PSID:             MT_1170110023</span><br><span class=\"line\"> PCI Device Name:  mt4099_pci_cr0</span><br><span class=\"line\"> Port1 MAC:        0002c9xxxxxx</span><br><span class=\"line\"> Port2 MAC:        0002c9xxxxxx</span><br><span class=\"line\"> Versions:         Current        Available</span><br><span class=\"line\">    FW             2.42.5000      N/A</span><br><span class=\"line\">    PXE            3.4.0752       N/A</span><br><span class=\"line\"></span><br><span class=\"line\"> Status:           No matching image found</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></li>\n</ol>\n<h2 id=\"まとめ\"><a href=\"#まとめ\" class=\"headerlink\" title=\"まとめ\"></a>まとめ</h2><p>intelでは新しいファームウェアについて推奨と書かれる場合があり判断が難しいケースがありますが、脆弱性や製品の組み合わせなど問題が顕在化する環境に当てはまる場合のみ、新しいファームウェアを適用すべきでしょうか。ファームウェアとドライバーとの整合性もあるのでリリースノートを参照されることをお勧めします。</p>\n","categories":["Network","Hardware"],"tags":["ESXi"]},{"title":"XG Firewall自身を防御する","url":"/new-technology/2020/06/24/protect-xg/","content":"<p class=\"onepoint\">この記事で実現すること</p>\nホームユーザー向けにXG Firewall自身を防御する、ベストプラクティスとなる設定をします。\n<span id=\"more\"></span>\n\n<h2 id=\"Best-practices-for-securing-your-firewall\"><a href=\"#Best-practices-for-securing-your-firewall\" class=\"headerlink\" title=\"Best practices for securing your firewall\"></a>Best practices for securing your firewall</h2><p>2020-6-24にSophos Communityのお勧め記事に「Sophos XG Firewall: Best practices for securing your firewall」というタイトルの文書が投稿されました。以下の記載があります。</p>\n<blockquote class=\"blockquote-center\">\n<p>このドキュメントの焦点は、Sophos XG Firewallを最低限のレベルでセキュリティを確保するための基本的なガイダンスを提供することです。この文書では、内部ネットワークデバイスやリソースを保護する個々のファイアウォール機能についてのガイダンスは提供しません （詳細な Sophos XG Firewall ベストプラクティスガイドは後日公開される予定です）。</p>\n\n</blockquote>\n\n<p>「<a href=\"/new-technology/2020/05/09/best-practice/\" title=\"XG Firewall v18の設定におけるベストプラクティス\">XG Firewall v18の設定におけるベストプラクティス</a>」で記載した通り、ルールやポリシーについてのベストプラクティスを記載していますが、将来Sophosから詳細なベストプラクティスガイドが公開されるとの事です。今回公開されたものはルールやポリシーではなく、運用について記述されたものであり、どのようにしてFirewallを守るかに言及されています。IPSの設定については、過去記事をアップデートしています。</p>\n<blockquote>\n<p>Sophos XG Firewall: Best practices for securing your firewall<br> <a href=\"https://community.sophos.com/products/xg-firewall/f/recommended-reads/121461/sophos-xg-firewall-best-practices-for-securing-your-firewall\">https://community.sophos.com/products/xg-firewall/f/recommended-reads/121461/sophos-xg-firewall-best-practices-for-securing-your-firewall</a></p>\n</blockquote>\n<h2 id=\"Firewall自身のセキュリティ強化\"><a href=\"#Firewall自身のセキュリティ強化\" class=\"headerlink\" title=\"Firewall自身のセキュリティ強化\"></a>Firewall自身のセキュリティ強化</h2><p>まずこのガイドの先頭には以下の説明があります。</p>\n<blockquote>\n<p>管理者は、ファイアウォール自体の安全性を確保する前に、内部ネットワークやリソースを保護するために、ファイアウォールの機能や機能を設定することに集中してしまうことがよくあります。</p>\n</blockquote>\n<p>これはご指摘の通りで、確かにXG自身にログインするパスワードもLAN内からのアクセスだからという理由で単純なパスワードにしがちです。業務で利用するほど厳格では無いにせよ、ホームユーザーとしてもFirewall自身の管理をしっかりと行うべきです。具体的なドキュメントについては、上記のページにあるPDFを参照いただくのが一番ベストですが、ここではホームユーザーにとって重要と思われるものを紹介します。</p>\n<h3 id=\"ローカルサービスACL\"><a href=\"#ローカルサービスACL\" class=\"headerlink\" title=\"ローカルサービスACL\"></a>ローカルサービスACL</h3><p>XGの左ペインメニューの<mark class=\"label primary\">管理</mark>の”デバイスのアクセス”でWANなど外部ゾーンからのすべてのサービスを削除します。使わないサービスはオフにするのが原則であり、SSHを利用しないのであればLANゾーンのSSHもオフにしてしまうのがお勧めです。</p>\n<img src=\"/new-technology/2020/06/24/protect-xg/acl.png\" class=\"\" title=\"alt\">\n\n<p>このSophosのドキュメントではSSHのために、公開鍵認証を行う事を勧めています。もし、LANやVPNからSSHを使うのであればこの<mark class=\"label primary\">デバイスのアクセス</mark>の画面の下部に<mark class=\"label primary\">管理者の公開鍵認証</mark>の項目があるので、そこで公開鍵を追加できます。</p>\n<h3 id=\"DDoS防御\"><a href=\"#DDoS防御\" class=\"headerlink\" title=\"DDoS防御\"></a>DDoS防御</h3><p>これまでも特にDDoS防御については説明してきていませんでした。ホームユーザーには不要と考えているためです。ping関連のDDoS防御の勧めが記述されていますので紹介します。しかしこの設定を行うとダウンロードのスループットが低下するので確認しながら利用の判断可否が必要です。XGの左ペインメニューの<mark class=\"label primary\">侵入防御</mark>の”DoS／スプーフ防御”のタブにてICMP&#x2F;ICMPv6フラッドの項目を以下の図のように設定します。</p>\n<img src=\"/new-technology/2020/06/24/protect-xg/ips.png\" class=\"\" title=\"alt\">\n\n<p>このドキュメント上で”XG550”、”XG650”および”XG750”のハードウェア提供モデルのDDoS防御の設定が記載してありますが、XG Home（ソフトウェアバージョン）はこのDDoS防御の機能は持っていません。</p>\n<h3 id=\"管理者ID\"><a href=\"#管理者ID\" class=\"headerlink\" title=\"管理者ID\"></a>管理者ID</h3><p>XGの左ペインメニューの<mark class=\"label primary\">管理</mark>の”管理の設定”で以下のように管理者のログイン失敗時のブロック、パスワードの複雑性の登録を行います。新しい管理者アカウントを作成し、2要素認証の設定は可能ですが、デフォルト管理者のadminアカウントは無効に設定できません。業務上利用する場合は担当者が変わる場合など意味がありますが、ホームユーザーが利用する場合は定期的なパスワード変更も不要であり、2要素認証の設定は現時点ではあまり魅力はありません。adminアカウントの無効化対応を期待します。</p>\n<img src=\"/new-technology/2020/06/24/protect-xg/admin.png\" class=\"\" title=\"alt\">\n\n<p>「<a href=\"/new-technology/2020/04/03/Notifications/\" title=\"XG Firewallの通知設定を行う\">XG Firewallの通知設定を行う</a>」で記載した通り、通知設定を行う事でログイン失敗の状況も迅速にキャッチが可能です。</p>\n<h3 id=\"HotFixの自動インストール\"><a href=\"#HotFixの自動インストール\" class=\"headerlink\" title=\"HotFixの自動インストール\"></a>HotFixの自動インストール</h3><p>XGに脆弱性が見つかった場合に、過去の事例では極めて迅速にパッチが自動適用されます。具体的には下記の図のように、左ペインメニューの<mark class=\"label primary\">バックアップ＆ファームウェア</mark>の”ファームウェア”タブの画面にある、”ホットフィックスの自動インストールを許可する”にチェックが付いている事を確認してください。</p>\n<img src=\"/new-technology/2020/06/24/protect-xg/hotfix.png\" class=\"\" title=\"alt\">\n\n<p>また、定期的な設定のバックアップが推奨されています。この<mark class=\"label primary\">バックアップ＆ファームウェア</mark>メニュー上でのバックアップを取得されると共に、仮想環境をお使いの方は仮想環境上でのバックアップを取得される事をお勧めします。</p>\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"子供のスマホ・タブレットの使い方","url":"/new-technology/2022/01/29/parerentalcontrol/","content":"<img src=\"/new-technology/2022/01/29/parerentalcontrol/title.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p>子供のスマホ・タブレットについては、未就学児・小学生低学年においては、親のものを使うケースが多いようです。そして、小学生の高学年以上ともなると子供のスマホ保有率も高まります。なお、本年4月より民法改正で18歳から大人になります。子供がスマホ・タブレットを使うリスクを踏まえた適切な利用の仕方を考えてみます。</p>\n<span id=\"more\"></span>\n\n<h2 id=\"子供のスマホ・タブレット利用のリスク\"><a href=\"#子供のスマホ・タブレット利用のリスク\" class=\"headerlink\" title=\"子供のスマホ・タブレット利用のリスク\"></a>子供のスマホ・タブレット利用のリスク</h2><p>色々なニュースで子供のスマホ・タブレットの利用に関わるトラブルを耳にします。未就学児〜小学生低学年、小学生中学年、小学生高学年〜中学生とそれぞれの世代で問題となる内容は異なるようです。子供の成長に合わせて子供自身で出来ることが増えてくるため、年齢を重ねるたびに、結果的に抱えるリスクが増えます。総務省では「インターネットトラブル事例集（2021年度版）」として公開している情報があります。この事例集からトラブルを抜粋してみます。</p>\n<table>\n<thead>\n<tr>\n<th>分類</th>\n<th>内容</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>日常生活</td>\n<td>スマホの過度な使用による生活や体調への支障</td>\n</tr>\n<tr>\n<td></td>\n<td>ながらスマホが招いた自転車衝突事故</td>\n</tr>\n<tr>\n<td></td>\n<td>メッセージアプリでの悪口・仲間外れ</td>\n</tr>\n<tr>\n<td></td>\n<td>腕試しで自作したウイルスをネットに公開</td>\n</tr>\n<tr>\n<td></td>\n<td>個人や学校などへの脅迫行為や犯行予告</td>\n</tr>\n<tr>\n<td>個人情報</td>\n<td>入力した個人情報の意図しない二次利用</td>\n</tr>\n<tr>\n<td></td>\n<td>メールからの誘導によるフィッシング詐欺被害</td>\n</tr>\n<tr>\n<td></td>\n<td>悪意あるWi-Fiスポットを利用したことによる情報流出</td>\n</tr>\n<tr>\n<td>ネット取引</td>\n<td>フリマなどネットを介した取引によるトラブル</td>\n</tr>\n<tr>\n<td>著作権</td>\n<td>他者の権利を侵害する投稿・二次利用・ダウンロード</td>\n</tr>\n<tr>\n<td>ゲーム</td>\n<td>ゲーム上でのやり取りから生じたトラブル</td>\n</tr>\n<tr>\n<td>SNS</td>\n<td>悪ふざけなどの不適切な投稿</td>\n</tr>\n<tr>\n<td></td>\n<td>投稿から個人が特定されたことによる被害</td>\n</tr>\n<tr>\n<td></td>\n<td>旅行中の写真投稿や書き込みによる空き巣被害</td>\n</tr>\n<tr>\n<td></td>\n<td>自画撮り写真の交換に端を発した脅迫被害</td>\n</tr>\n<tr>\n<td>ネットのコミュニケーション</td>\n<td>コミュニティサイトなどでの未成年によるアプローチ</td>\n</tr>\n<tr>\n<td></td>\n<td>アルバイト応募が招いた犯罪への加担</td>\n</tr>\n<tr>\n<td></td>\n<td>心のよりどころだったSNS上の知人による誘い出し</td>\n</tr>\n<tr>\n<td></td>\n<td>SNS等での誹謗中傷による慰謝料請求</td>\n</tr>\n</tbody></table>\n<p>出典：総務省ホームページ（<a href=\"https://www.soumu.go.jp/main_content/000707803.pdf\">https://www.soumu.go.jp/main_content/000707803.pdf</a>）</p>\n<p>上記以外にも、表面化しづらい以下のようなものがありますね。</p>\n<table>\n<thead>\n<tr>\n<th>分類</th>\n<th>内容</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>金銭的被害</td>\n<td>アプリに課金</td>\n</tr>\n<tr>\n<td></td>\n<td>投げ銭（YouTubeスーパーチャットなど）</td>\n</tr>\n<tr>\n<td>健全性の問題</td>\n<td>スマホ・タブレットに多くの時間を費やす</td>\n</tr>\n<tr>\n<td></td>\n<td>家族との会話がなくなる</td>\n</tr>\n<tr>\n<td></td>\n<td>アダルトサイトや好ましくないサイトの閲覧</td>\n</tr>\n</tbody></table>\n<h2 id=\"子供のネット利用について\"><a href=\"#子供のネット利用について\" class=\"headerlink\" title=\"子供のネット利用について\"></a>子供のネット利用について</h2><p>子供のネット利用は以下のものが挙げられます。</p>\n<ul>\n<li>動画視聴</li>\n<li>知育アプリ・教育</li>\n<li>ゲーム</li>\n<li>SNS</li>\n<li>音楽視聴</li>\n<li>情報検索（ニュース、ナビ）</li>\n</ul>\n<p>内閣府からは「令和2年度青少年のインターネット利用環境実態調査調査結果（速報）」が公開されています。<br> <a href=\"https://www8.cao.go.jp/youth/kankyou/internet_torikumi/tyousa/r02/net-jittai/pdf/sokuhou.pdf\">https://www8.cao.go.jp/youth/kankyou/internet_torikumi/tyousa/r02/net-jittai/pdf/sokuhou.pdf</a></p>\n<p>詳細は上記リンクを参照いただければと思いますが、低年齢層では親のスマホを利用させるケースが圧倒的に多いことがわかります。子供が成長するに伴い、上記リスクを踏まえるとどこかできちんと管理しなければならない時期が来ると考えられます。低年齢層では親と共用しているスマホ・タブレットがメインであっても、年齢と共に親と共用する比率が減っていきます（P10）。中学生ともなればほぼ子供専用のスマホを保有しているでしょうけれども、この資料を参考にどのタイミングで子供専用のスマホを持たせるべきかのタイミングがわかります。</p>\n<p>小学生高学年〜中学生になって個人のスマホを持つようになり、音楽視聴、SNS、情報発信など個人にフォーカスした利用が増加することになります。サービスの幅が広がり、コミュニケーション、課金、法律の理解に加えモラルと犯罪防止（身を守る）というテーマに親子でどう向き合うかが課題となります。個人中心になれば親の目も届かなくなります。このタイミングで様々なリスクが顕在化します。</p>\n<p>小学生の高学年までには自然に覚えていく事も多いでしょうが、親としてそれまでに徐々に学ぶ機会を与えてあげるべきではないでしょうか？</p>\n<p>低年齢層では親自身がIT機器やアプリに対する理解が必要となります。子供にできる事も少ないですが、リテラシーがない子供に<strong>能力以上の権限を与えない</strong>のは親の役目になります。</p>\n<p>また、スマホ・タブレットの活用という考え方ではなく、緊急連絡の手段として子供にスマホを持たせるケースもあります。</p>\n<h3 id=\"低年齢層（5歳〜8歳）への管理策\"><a href=\"#低年齢層（5歳〜8歳）への管理策\" class=\"headerlink\" title=\"低年齢層（5歳〜8歳）への管理策\"></a>低年齢層（5歳〜8歳）への管理策</h3><p>&lt;低年齢層の子供への技術的対策&gt;</p>\n<ul>\n<li>親が認めたアプリのみ利用を可能にする</li>\n<li>スマホ・タブレットの利用時間を制限する</li>\n<li>SNSなど家族以外の知らない人とのコミュニケーションを制限する</li>\n<li>有料サービスなど課金の仕組みに制限をつける</li>\n<li>Web閲覧はホワイトリストを利用する</li>\n</ul>\n<p>子供専用の端末を用意する場合はiOS・Android共にアプリケーションで対策が可能です（後述します）。<br>実際には知育アプリやゲームのみを利用可能にし、メール、SNSは禁止にするという単純なルールでも良いですね。ただ難しいのはゲームの中に色々な人とコミュニケーションを取れるものがあるということです。この世代に家族以外とのコミュニケーションを取ることができるアプリは親がしっかりと確認し制限すべきでしょうか。そのうち知育アプリでも子供から課金して使いたいと言われる事もあるでしょう。その場合は親の判断が必要です。</p>\n<p>YouTubeはキッズ版がありますが、実際親が見せたい（ためになる）動画はキッズ版になかったりと理想通りにはなかなか上手く行かないようです。<br>スマホのYouTubeアプリからリビングのTVに飛ばすことができるのでそれで（親が見せたい）動画を子供に見せることができます。ブラウザについては子供向けサイトなど決められたサイトのみの範囲であればホワイトリスト方式（親が認めたサイトのドメインを一覧化）で管理できます。<br>なお、OSやアプリなどの<strong>仕組み</strong>では管理できないものもあります。</p>\n<p>&lt;低年齢層の子供への運用的対策（例）&gt;</p>\n<ul>\n<li>1日で使う時間を相談して決める（体への影響を説明することが必要です）</li>\n<li>食事の時は使わない</li>\n<li>使う場所はリビングのみ</li>\n<li>外で使う時は親に確認する</li>\n</ul>\n<p>ルールを決めたら、都度使っていい、よくないと判断・説明するより自主的な利用を促したいものです。 知育アプリであってもお金を払えば色々なものが追加で使えるというのがわかるようになっていきます。ただ、この頃の子供はブラウザの使い方や調べ方も良く分からないでしょうから親のスマホ・タブレットを貸与する方法でも十分運用は回ります。</p>\n<p>小学校に入ったら見守りを目的としてGPSで子供の居場所を確認したいニーズが出てきます。小学校ではスマホの持ち込みを禁止しているところもあり、小さいGPS機器、例えば株式会社ミクシィが提供している「みてねみまもりGPS」などの小さいGPS機器を持たせる方が使い勝手が良いと思われます。</p>\n<img src=\"/new-technology/2022/01/29/parerentalcontrol/gps.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<blockquote>\n<p>みてねみまもりGPS<br> <a href=\"https://mitene.us/gps\">https://mitene.us/gps</a></p>\n</blockquote>\n<h3 id=\"小学校3、4年（9歳〜10歳）への管理策\"><a href=\"#小学校3、4年（9歳〜10歳）への管理策\" class=\"headerlink\" title=\"小学校3、4年（9歳〜10歳）への管理策\"></a>小学校3、4年（9歳〜10歳）への管理策</h3><p>ブラウザによる検索など、Webでの調べ物をするのであればブラックリスト方式、これは通信キャリアが提供する「あんしんフィルター」を活用できます。漢字の読みも含めて親がそばで使い方を教えてあげる必要があります。この辺りから道徳心や判断力を学んでいくことになりますし、親のスマホを貸与する方法では運用が難しくなってきます。情報発信は認めず、閲覧だけは認める事を前提に、調べる能力を養うことができます。記事の正確性以前にこの年代の子供には難しすぎることを一生懸命調べても逆効果な事もあります。これは親が教えていく以外ありません。まだ外へのスマホ持ち出しは早いかもしれませんが両親ともに共働きの場合は緊急連絡手段の電話として持つケースも出てくる頃でしょう。</p>\n<p>&lt;小学校中学年の子供への技術的追加対策&gt;</p>\n<ul>\n<li>あんしんフィルターを活用する</li>\n</ul>\n<p>&lt;低年齢層の子供への運用的追加対策&gt;</p>\n<ul>\n<li>アプリケーションの利用時間を把握する</li>\n<li>ウェブ閲覧は親が一緒に手伝う</li>\n</ul>\n<p>既にキッズ版のYouTubeは見てもいないでしょうし、ブラウザに関してはホワイトリスト管理は煩雑すぎて運用が回らないのではないでしょうか。家族以外とのコミュニケーションは禁止しつつ、敢えて色々な事は教えない事も親の方針の1つでしょう。<br>なお、TV番組「Why?!プログラミング」で有名なScratchも8歳以上が想定されています。コミュニティにアップして評価を受けたりできます。全てのやりとりを拒絶するというのは現代では難しくなっているように感じます。参考になるのは、「Scratchコミュニティのガイドライン」です。非常にコンパクトにまとめられていますが、「誰にでも敬意を持って接すること」、「安全を保つこと: 個人情報や連絡先を公開しないでください」、「役立つコメントをすること」など子供にとって大切なことが書かれており参考になります。</p>\n<blockquote>\n<p>Scratchコミュニティーのガイドライン<br> <a href=\"https://scratch.mit.edu/community_guidelines\">https://scratch.mit.edu/community_guidelines</a></p>\n</blockquote>\n<p> 他の子供よりも少し進んでいることになるかもしれませんが、リテラシーを学んでいくにはこの頃が良いのかもしれません。</p>\n<h3 id=\"小学校高学年〜中学生（9歳〜14歳）への管理策、教育・啓蒙\"><a href=\"#小学校高学年〜中学生（9歳〜14歳）への管理策、教育・啓蒙\" class=\"headerlink\" title=\"小学校高学年〜中学生（9歳〜14歳）への管理策、教育・啓蒙\"></a>小学校高学年〜中学生（9歳〜14歳）への管理策、教育・啓蒙</h3><p>小学校高学年からいよいよ個人のスマホの活用が広がります。コミュニケーションは最初のうちは仲間内にとどめるべきと言われます。アプリやスマホ本体で制約はしつつも、この年齢になると重要なのは親子の信頼関係です。インターネットに向けて情報公開（発信）するにはまだ早いとも思われる場合、親が十分に関与してあげる必要があります。不正アクセスやフィッシング、著作権違反などありとあらゆるリスクを抱えます。色々な共通の趣味を持つ人たちとのつながりを求めるようになる時期ですが、犯罪や事故に巻き込まれないために親の指導が大切です。様々なインターネット犯罪について子供と話し合う必要が出てきます。この世代が一番難しいと思います。本来、中学生や高校生でゆっくりと友人とのコミュニケーションを学んでいく事がこの年代でスマホを保有することによって急に知識・能力以上の物を求められてしまうからです。</p>\n<p>もうこの頃には子供が見たいものと親が見せたいものとは一致しない事も多いでしょうか。</p>\n<p>低年齢層の頃はルールや安全管理措置に重点を置くことが大事でしたが、この頃からは、<strong>道徳心・判断力</strong>を身につけてもらう必要があります。親子ともに犯罪やトラブル事例集から身を守るために考えることが大事です。この世代の親ならば学校やPTAの会合で啓発や学習の機会もあることでしょう。子供は悪気はなくとも興味の方が勝ってしまう事もあるでしょうから、未使用のクレジットカードなどの保管場所にも気を使う必要が出てきます。これは親の暗黙のルールの一つとして考えたいものです。</p>\n<p>&lt;小中学生の子供への技術的追加対策&gt;</p>\n<ul>\n<li>キッズスマホ</li>\n</ul>\n<p>&lt;小中学生の子供への運用的追加対策&gt;</p>\n<ul>\n<li>ニュースや様々な子供のネットに関する問題を親子で話し合う</li>\n<li>著作権、法律に関する知識をわかりやすい形で学んでもらう</li>\n<li>メールやSNSを始めるときはまずは友達など顔を知っている人間のみに限定する</li>\n<li>フィッシングや詐欺など犯罪に関する知識を学ばせる</li>\n</ul>\n<p>キッズスマホの代表格でもあるトーンモバイルは親が安心する機能が盛り込まれています。ただ中学生になると子供はiPhoneを欲しがるかもしれません。</p>\n<blockquote>\n<p>トーンモバイル<br> <a href=\"https://tone.ne.jp/lp/a/b1.html\">https://tone.ne.jp/lp/a/b1.html</a></p>\n</blockquote>\n<p>ある程度子供側の道徳心や判断力が高まったのであれば、子供のプライバシーにも配慮し、ブラウザのアクセス履歴を親がチェックする必要もないでしょう。</p>\n<h3 id=\"高校生（15歳〜17歳）\"><a href=\"#高校生（15歳〜17歳）\" class=\"headerlink\" title=\"高校生（15歳〜17歳）\"></a>高校生（15歳〜17歳）</h3><p>民法改正によって成人18歳への移行もあと2か月強ですが、正直、この年齢ならば親の制約というのも難しくなっているでしょう。働いていない高校生に課金を制約するのは子供も一定の理解を示すことと思いますが、18歳で大人の同意なしにスマホの契約が可能になります。高校生であっても自分で決定し、自己責任を持つことになります。これまで子供扱いだったものが高校3年生でいきなり大人の自己責任と言われても無理があります。言い方を変えると学ぶ機会が不十分であれば子供の自主性に任せるということはできません。</p>\n<p>成人18歳となり、今の高校生は起業やクレジットカードに興味がある一方、自己責任という重さも認識を持っているようです。金銭の使い方を身につける必要があり、投資の詐欺などから身を守る必要があるため、かなり短期間で学習する必要があります。大学進学を考えるとここに全てを集中するのは非常に難しい問題です。</p>\n<p>結局のところ、早めの教育機会を確保し、子供のリテラシーを向上させ無理なく大人になるための階段を用意してあげたいところです。</p>\n<p>もうここまで来ればビジネス（社会）と同じです。報告・連絡・相談、権利と義務。ルール遵守から行動規範への変化です。定期的に話し合い、必要に応じて改善を促すことになるでしょう。</p>\n<h3 id=\"ここまでの整理\"><a href=\"#ここまでの整理\" class=\"headerlink\" title=\"ここまでの整理\"></a>ここまでの整理</h3><p>子供の成長の段階で、低年齢層の子供は管理中心に考えることになりますが、子供の成長とともに管理よりは学習、啓蒙が重要になってきます。子供への制約、管理だけを中心に考えていると後からが大変になりそうです。</p>\n<h2 id=\"子供の端末を管理する\"><a href=\"#子供の端末を管理する\" class=\"headerlink\" title=\"子供の端末を管理する\"></a>子供の端末を管理する</h2><p>低年齢層の時代から制約を主眼にするのではなく、子供に色々な発見の機会を与え自主的に行動してもらうためにも、子供専用端末を用意することを検討してみてください。子供が小さいうちであれば「こういうもの」として納得感は得られやすいですが、大きくなってからだと「権利が剥奪された」と感じてしまう可能性があります。繰り返しですがルールを明確にし子供に説明し、納得してもらいましょう。<br>iOS、Androidそれぞれ操作方法は異なりますが、子供専用端末によって以下の事が管理できるようになります。</p>\n<ul>\n<li>親が認めたアプリのみを使用可能とする</li>\n<li>使用時間帯の制限が可能</li>\n<li>アプリ毎の利用時間を設定可能・利用時間の確認が可能</li>\n<li>ブラウザはホワイトリスト、ブラックリストによる運用が可能</li>\n<li>親の判断で臨機応変に利用時間の延長が可能</li>\n<li>子供の居場所の確認</li>\n</ul>\n<p>基本的には親のスマホで子供の端末をコントロールします。アプリのインストールは以下の流れです。<br>子供端末でアプリインストール→親の承認→インストール実行</p>\n<p>子供端末がAndroidの場合、親のスマホはAndoroidでもiOSでも可能です。<br>子供端末がiOSの場合は、親のスマホはiOSが必要です。</p>\n<p>両方で共通ですが、Androidならば子供のGoogleアカウント、iOSならば子供のAppleアカウントを作成する必要があります。</p>\n<h3 id=\"子供の端末がAndroid\"><a href=\"#子供の端末がAndroid\" class=\"headerlink\" title=\"子供の端末がAndroid\"></a>子供の端末がAndroid</h3><p>Androidには古いタブレット・スマホでも利用可能なGoogleファミリーリンクというアプリがあります。<br>これはタブレット・スマホを子供専用とし、親のスマホからコントロールするものです。</p>\n<img src=\"/new-technology/2022/01/29/parerentalcontrol/familylink.png\" class=\"\" width=\"480\" title=\"alt\">\n\n<p>個人的にはiOSよりもAndroidのファミリーリンクの方がより機能が分離されており使い勝手が良く感じます。</p>\n<p>Android<br><a href=\"https://play.google.com/store/apps/details?id=com.google.android.apps.kids.familylink\">https://play.google.com/store/apps/details?id=com.google.android.apps.kids.familylink</a><img src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAM0AAADNCAAAAAA+16u1AAAC1UlEQVR42u3ayW7CQBAA0fz/TxPllAgxQ1WPIRzKJxTw8iyl1dvX1/Pj9nP8fvo97n5y97dHZ9BL7X9ydKRJk2b5vODGy3vuv7jpY/mewBlp0qSZat4WyfavA0TV5bdp0qR5oWb/lCDLoM+2vGWaNGk+QKMym2GNArKsNGnSvEZDr7BPZfYukDO9pVpLkyaN7x1+yKfLO7dp0qQZdh9psNsnIaC+cQ+ZJk2a4T+3qiT22QQYlIAWBk1bSJ6WJk0aoPFdSpVRUKsnpUmT5lxDZwtg+AkqE6AZpjdp0qS5UqPSGxrE6APShieOaWnSpFGxZJ9NvC3NAnUQKYHSpEmjNGCxYPgTEL/oUiXIgNKkSTPVqDUG0MhUNQodedL0K02aNFijZhAq1AAhbbziyUiaNGlONCpWXbgMcTwf/fMpTZo0XgMWFU4mGbQb4ke0TxocadKkUetP/vo0yqhoqd4EmXumSZOGaugwgY4tQQakhh34UmnSpBlqFGTYuKDdEDX7eJLZpEmTxmvAUJPOQql6MM9cXiBNmjRDjSo7aF+EVitgkYJ2YdKkSTPQqPg17IsMG5mKlCZNmqkGrCWqksUHMbqkRXqsadKk8Rr6bOAmauLhL6WqnzRp0mANnW7QpEY90XClglRradKkURo/yRjuP4LARs/F85s0adJ4je9h0hbp8TzkyXw0TZo0XrN/Xj/3dJuLp/OVdWBLkyYN1dDBxv6eKtjR2YcataZJk+Zc40/21QpNg/wLvJ/fpEmThmpI4mP6Dv514JGMWa5IkyYN1tzgAUKNKm38ihXptqZJk8ZrTsKgalqqVQzanwF7VmnSpCEaGsmG4YdmO+q1DSYeadKk2WtUuUNXGv078RsRD5O1NGnSXK0BQWe4xnDSHEmTJs1/aPyqk+9FqFbHetiRJk0apaEdTrUnqYRq0rI+I02aNJfMNPHKwnTMavIe1WdJkyaN0nwDcBFyyBqgyVgAAAAASUVORK5CYII=\" alt=\"family link\" title=\"\" class=\"title: family Link\"></p>\n<p>iOS<br><a href=\"https://apps.apple.com/jp/app/google-family-link/id1150085200\">https://apps.apple.com/jp/app/google-family-link/id1150085200</a><img src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKUAAAClCAAAAAAYQGIGAAACA0lEQVR42u3awW7EIAxF0fn/n07VVaUqJvdBZzDVZVUlKZyMRDDGr9dzu77byrWfVl5bbypV7lFeVbsbvey/HL3sr5TfjqFSZVtlOWPH3vGLlLN4/EvcXlOp8lBlNE/BC49vqFT5n5Tlc+N1lj6iUuXRynEPYCNFo8ry7noUrFLlx5V09Pf99ZcZGJUqP6S84pYn7Wgeo+5FpcqOymgNBNuxKGVIsxwqVbZU0rCPvheY3hN8lSo7KmlqYswHB03j78NSpKlS5R4l6BWk8/KAkq64KlU2V4Kahyj1ThfC8XO3e0iVKpspwYpGK4vGa2B+4qtSZV/lwzlqktPLR6drqkqVLZU0kxftq2hYOt6Y/U6pq1R5gBIUztFyh6hqr+5Apcq2ShAU0pPXaHRcL6FSZUdlnlfPz3Rpco90pVJlHyUIFOlzy4l5cvKsUmUzZZ7xA3FotMQ+hKAqVXZU0uOlqBJo5aSqvqtSZW8lzcNNAieKIejXRKXK3UqwLoJYMj+BIrs9lSo7KqNK18nlD6yp0QKsUuV2ZbR9olNvsvyu/sqoVNlRSad3vq/KK5UmYk6VKncrJ7PfIMjMj7oeiopUquyojDIJ0YYr+q7Uz6lUebySVP0kkSF+EZUqD1VGJ7n554J0pVJlWyXNl+cVQ1H1q0qVZymj3EYUFNLdGf0PlSr7KL8A5VktoFxizrQAAAAASUVORK5CYII=\" alt=\"family link\" title=\"\" class=\"title: family Link\"></p>\n<p>ソフトバンクからYouTube動画が提供されていましたので紹介します。</p>\n<blockquote>\n<p>ファミリーリンク 保護者さまの端末から設定する方法（12歳以下のお子さま用）<br> <a href=\"https://www.youtube.com/watch?v=uCcaFvRyYlY\">https://www.youtube.com/watch?v=uCcaFvRyYlY</a></p>\n</blockquote>\n<img src=\"/new-technology/2022/01/29/parerentalcontrol/familylink-under12.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<blockquote>\n<p>ファミリーリンク 保護者さまの端末から設定する方法（13歳以上のお子さま用）<br> <a href=\"https://www.youtube.com/watch?v=rFO-nXEnC-Y\">https://www.youtube.com/watch?v=rFO-nXEnC-Y</a></p>\n</blockquote>\n<img src=\"/new-technology/2022/01/29/parerentalcontrol/familylink-over13.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<h3 id=\"子供の端末がiOS\"><a href=\"#子供の端末がiOS\" class=\"headerlink\" title=\"子供の端末がiOS\"></a>子供の端末がiOS</h3><blockquote>\n<p>Apple 「iPhone、iPad、iPod touch でスクリーンタイムを使う」<br> <a href=\"https://support.apple.com/ja-jp/HT208982\">https://support.apple.com/ja-jp/HT208982</a></p>\n</blockquote>\n<p>iOSの場合はアプリのインストールは不要です。<br>まず、子供のAppleアカウントを作成し、iOSに子供のアカウントでログインします。また親のスマホで設定のファミリー共有から子供のアカウントをファミリーに加えます。その後、子供端末の設定からスクリーンタイムを選び、設定します。</p>\n<h2 id=\"使い方の一例\"><a href=\"#使い方の一例\" class=\"headerlink\" title=\"使い方の一例\"></a>使い方の一例</h2><h3 id=\"ブラウザのホワイトリスト\"><a href=\"#ブラウザのホワイトリスト\" class=\"headerlink\" title=\"ブラウザのホワイトリスト\"></a>ブラウザのホワイトリスト</h3><p>低年齢層の子供に見せたいサイトをブックマークなどして使えるようにし、他の難しすぎるサイトは許可しないとする場合、都度ホワイトリストのURLを更新する必要があります。この場合は、以下の使い方で効率よくホワイトリストが加えられます。</p>\n<p>iOSの場合<br> AirDropを使う<br> iOSの場合は親のスマホなどで見せたい（許可したい）URLがあれば、それを子供の端末に向けてAirDropします。子供端末のSafariで開き、その時に「以下のページは制限されているのでブラウズできません」という表示とともに「Webサイトを許可する」リンクもあるのでそちらをタップします。<br> その後、スクリーンタイム・パスコードの4桁の数字を入力し、許可します。</p>\n<p> Androidの場合<br>  Googleチャット（旧ハングアウト）などのチャットツールを使う<br>  URLなどを親の端末から子供の端末に送り、そこからChromeなどでアクセスします。子供の端末から親のスマホへの閲覧リクエストが送られ、親のスマホでドメインを許可するようになります。</p>\n<p>なお、iOS、AndroidともにWebサイト単位の許可となりURLパラメータまでは含まれず、YouTubeの個別の動画を指定するということはできません。<br>しかし、実運用としては、このホワイトリスト管理はかなり大変です。キャリアが提供する「あんしんフィルター」や「iフィルター」などの有償ソフトウェアで管理に任せるという考え方も現実的でしょうか。</p>\n<blockquote>\n<p>iフィルター<br> <a href=\"https://www.daj.jp/cs/purchase/#md\">https://www.daj.jp/cs/purchase/#md</a></p>\n</blockquote>\n<h3 id=\"家族のメッセージやビデオチャット\"><a href=\"#家族のメッセージやビデオチャット\" class=\"headerlink\" title=\"家族のメッセージやビデオチャット\"></a>家族のメッセージやビデオチャット</h3><p>iOSの場合<br> スクリーンタイムでFaceTimeやMessageについて連絡先に登録されている人のみに絞ることができます。</p>\n<p>Androidの場合<br> 前出のGoogleチャット、Google Meetでビデオ通話ができます。明確に相手を絞ることは難しいようですがGoogleアカウントをネットなどで公開していなければそう問題になることはないと考えられます。</p>\n<p> ゲームはゲーム機として、スマホ・タブレットは学習の道具というイメージを子供に持ってもらう方法も良いのではないかと思います。私は家族のコミュニケーションはAmazonのエコーショーを使っています。遠方の家族ともビデオチャットができます。「アレクサ、●●さんに電話して」の呼びかけは低年齢層の子供、高齢者にも扱いやすく、高齢者の見守りと低年齢層の知育とが両立できます。子供が留守番というシチュエーションでも親のスマホのアレクサアプリから自宅のエコーショーにビデオ通話ができますし、その逆も可能です。留守番をしている子供は親の顔を見て話ができるので安心感が得られます。</p>\n<img src=\"/new-technology/2022/01/29/parerentalcontrol/echoshow.png\" class=\"\" width=\"480\" title=\"alt\">\n\n<h3 id=\"利用時間の延長\"><a href=\"#利用時間の延長\" class=\"headerlink\" title=\"利用時間の延長\"></a>利用時間の延長</h3><p>例えば、平日は2時間以内、休日は4時間以内としつつも、祭日や少し多く使いたい場合があるケースなど延長が可能になります。iOSではあらかじめ決めた子供の端末上で4桁のパスコードで許可します。Androidは親のスマホで6桁のワンタイムパスワードを使って子供の端末を操作可能です。</p>\n<h3 id=\"Android固有の情報\"><a href=\"#Android固有の情報\" class=\"headerlink\" title=\"Android固有の情報\"></a>Android固有の情報</h3><ul>\n<li>Androidは何故かアプリのアンインストールが許可なしで実行できてしまいます。セキュリティソフトをアンインストールされると困りますね。</li>\n<li>Androidでは管理者の他に1名保護者が設定できます。従い、夫婦で子供のリクエストを承認できます。</li>\n</ul>\n<h2 id=\"Sophos-Firewallを利用する\"><a href=\"#Sophos-Firewallを利用する\" class=\"headerlink\" title=\"Sophos Firewallを利用する\"></a>Sophos Firewallを利用する</h2><p>子供のWeb閲覧のフィルタリングのためにこのブログで紹介しているSophos Firewallを使うこともできます。ただし、子供のWebアクセスのフィルタリングの目的だけにFirewallを導入するのはハードウェアの用意など大掛かりすぎますので、iフィルターの方が現実的です。既にSophos Firewallを導入されている方は設定してみる価値はあります。</p>\n<p>「<a href=\"/new-technology/2020/02/23/XG-Firewall/\" title=\"Sophos Firewallの導入\">Sophos Firewallの導入</a>」</p>\n<p>かなり細分化されたリストになっていますが、これでもある程度絞り込んでいます。ここからさらに許容するものを選択から外します。</p>\n<table>\n<thead>\n<tr>\n<th>カテゴリ</th>\n<th>説明</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Advertisements</td>\n<td>広告画像やポップアップ広告などを含むサイトです。</td>\n</tr>\n<tr>\n<td>Alcohol &amp; Tobacco</td>\n<td>酒や煙草の売買を促進するサイトです。</td>\n</tr>\n<tr>\n<td>Anonymizers</td>\n<td>URL 変換を行うサイトです。プロキシサーバーを経由せずに URL にアクセスするため、未承認のアクセスが発生する可能性があります。</td>\n</tr>\n<tr>\n<td>Auctions &amp; Classified Ads</td>\n<td>個人向けに物品やサービスの宣伝や取引に関するサービスを提供するサイト。</td>\n</tr>\n<tr>\n<td>Business Networking</td>\n<td>ビジネスや仕事に特化した SNS のサイトです (LinkedIn など)。</td>\n</tr>\n<tr>\n<td>CRL and OCSP</td>\n<td>証明書失効サービス。</td>\n</tr>\n<tr>\n<td>Command &amp; Control</td>\n<td>感染したマシン上の悪意のあるソフトウェアからのコマンド＆コントロール (C2) 通信で接続されたサイトおよびトラフィック。</td>\n</tr>\n<tr>\n<td>Controlled substances</td>\n<td>マリファナ以外の法規制によって制御や規制が行われている薬物に関する使用、取引、製造に関する情報や宣伝を行っているサイトが含まれます。</td>\n</tr>\n<tr>\n<td>Criminal Activity</td>\n<td>錠破りや窃盗をはじめとする違法行為や、自殺の方法を紹介するサイトです。</td>\n</tr>\n<tr>\n<td>Extreme</td>\n<td>暴力や傷害 (自傷を含む) を主とするサイト。死体や傷、グロテスクなイメージや恐怖感を呼び起こす描写を含むものです。ただし、ニュース、歴史的事件、報道事件は除きます。</td>\n</tr>\n<tr>\n<td>Financial services</td>\n<td>金融サービス、経済、経理など金銭に関わる情報を提供するサイト。国民保険、国際保険、その他の保険に関わる情報を提供するサイトも含みます。</td>\n</tr>\n<tr>\n<td>Gambling</td>\n<td>ギャンブルに関する情報を掲載したり、オンラインギャンブルを促進するサイトです。</td>\n</tr>\n<tr>\n<td>Games</td>\n<td>ゲーム情報を提供するサイト。ビデオゲーム、コンピュータゲーム、ロールプレイングゲーム、オンラインゲームなどが含まれます。</td>\n</tr>\n<tr>\n<td>Hacking</td>\n<td>不正アクセスを助長するサイト。コンピュータや通信機器、ソフトウェア、データベースへの違法アクセスに関する情報を含みます。</td>\n</tr>\n<tr>\n<td>Hunting &amp; Fishing</td>\n<td>残酷な画像を含む可能性のある狩猟や釣りなどに関する専用のサイト。</td>\n</tr>\n<tr>\n<td>Intolerance &amp; Hate</td>\n<td>人種差別や男女差別などを助長するサイトです。</td>\n</tr>\n<tr>\n<td>Jobs Search</td>\n<td>就職活動や転職活動をサポートする情報を提供するサイトです。</td>\n</tr>\n<tr>\n<td>Legal highs</td>\n<td>規制されていない麻薬的物質の栽培&#x2F;取引&#x2F;使用に関する情報を提供するサイトです。</td>\n</tr>\n<tr>\n<td>Live audio</td>\n<td>インターネットラジオやインターネットテレビ番組を配信するサイトです。</td>\n</tr>\n<tr>\n<td>Live video</td>\n<td>イベントやプログラミングに関するライブ動画のストリーミングを提供するサイト。</td>\n</tr>\n<tr>\n<td>Marijuana</td>\n<td>違法ドラッグの栽培、調合、使用についての情報を提供するサイトです。</td>\n</tr>\n<tr>\n<td>Militancy &amp; Extremist</td>\n<td>反政府的な思想や行動を主導・主張するグループの情報を提供するサイトです。</td>\n</tr>\n<tr>\n<td>Military</td>\n<td>軍隊および関連機関が提供するサイトです。</td>\n</tr>\n<tr>\n<td>NGOs &amp; Non-Profits</td>\n<td>非政府組織によるコンテンツを含むサイトです (非営利団体、労働組合、支援団体など)。</td>\n</tr>\n<tr>\n<td>Nudity</td>\n<td>ヌードやセミヌード写真を提供するサイト。過度な性的表現を含むものは除きます。映画俳優やモデル、ヌードアートや写真を含みます。</td>\n</tr>\n<tr>\n<td>Online Chat</td>\n<td>Web チャットサービスを提供するサイトや、HTTP&#x2F;IRC　経由でのチャット情報を提供するサイトです。</td>\n</tr>\n<tr>\n<td>Online Shopping</td>\n<td>一般消費者向けのオンラインショッピングサイト (性的なもの、下着、水着、投資、薬品、教育、コンピュータのソフトウェア&#x2F; ハードウェアは除きます)。ショールームや、一般消費者向け店舗のサイトも含みます。</td>\n</tr>\n<tr>\n<td>ParkedDomain</td>\n<td>ドメインを取得後、コンテンツがアップロードされていない未完成のサイトです。アクセスすると、検索エンジンやポータルページにリダイレクトされることがあります。</td>\n</tr>\n<tr>\n<td>Peer-to-peer &amp; torrents</td>\n<td>Bittorrent などの P2P テクノロジーを使用して取得できるコンテンツへのリンクを提供するサイトです。業務に関連のない帯域幅の大量消費や IP &#x2F; 著作権侵害を阻止できます。メッセージや写真の投稿を通じ、他のユーザーと気軽にコミュニケーションできるサイトです。</td>\n</tr>\n<tr>\n<td>Phishing &amp; Fraud</td>\n<td>悪質な目的で個人情報 (名前、住所、クレジットカード番号、学歴、スケジュールなど) を収集するサイトです。</td>\n</tr>\n<tr>\n<td>Pro-Suicide &amp; Self-Harm</td>\n<td>自殺、自傷行為を促す内容を提供するサイト。</td>\n</tr>\n<tr>\n<td>Radio &amp; Audio Hosting</td>\n<td>音楽検索サービスを提供するサイトです。</td>\n</tr>\n<tr>\n<td>Real Estate</td>\n<td>不動産の売買・賃貸情報や住宅ローン情報を提供するサイトです。</td>\n</tr>\n<tr>\n<td>Restaurants &amp; Dining</td>\n<td>レストランなどの外食を促進するサイト。予約サービス、レビュー、おすすめ情報などを含みます。</td>\n</tr>\n<tr>\n<td>Sex Education</td>\n<td>性教育に関する情報や、性の悩みを解決する薬品を提供するサイトです。ポルノ的なコンテンツは除きます。</td>\n</tr>\n<tr>\n<td>Sexually Explicit</td>\n<td>18歳未満にはふさわしくないアダルト向けコンテンツのうち、Porn、Nudity、SwimwearAndLingerie、SexHealthAndEducation、HealthAndMedicines に該当しないサイトです。</td>\n</tr>\n<tr>\n<td>Social Networking</td>\n<td>メッセージや写真の投稿を通じ、他のユーザーと気軽にコミュニケーションできるサイトです。</td>\n</tr>\n<tr>\n<td>Spam URLs</td>\n<td>一方的なスパムメールに含まれる URL です。これらの URL のコンテンツには、製品を売り込む目的のものから、詐欺などの不正なサイトまでがあります。</td>\n</tr>\n<tr>\n<td>Spyware &amp; Malware</td>\n<td>ユーザーが気が付かないようにソフトウェアのダウンロードを行うサイトまたはページ (簡単なユーザー認証を除く)。</td>\n</tr>\n<tr>\n<td>Stocks &amp; Trading</td>\n<td>株式市場、株式売買に関する情報やチャート、フォーラムを提供するサイトです。オンライン株取引や証券会社のサイトも含みます。</td>\n</tr>\n<tr>\n<td>Swimwear &amp; Lingerie</td>\n<td>下着&#x2F;水着のモデルや雑誌のサイトです。ヌードや性的なものは除きます。アート的な大人の画像や、下着のショッピングサイトを含みます。</td>\n</tr>\n<tr>\n<td>Unauthorized Software Stores</td>\n<td>モバイル機器&#x2F;コンピュータ向けに、違法な可能性があるソフトウェアやアプリを提供しているサイトです。</td>\n</tr>\n<tr>\n<td>Video hosting</td>\n<td>動画検索サービスを提供するサイトです。</td>\n</tr>\n<tr>\n<td>Weapons</td>\n<td>武器に関する情報を提供したり、売買をサポートするサイトです。</td>\n</tr>\n<tr>\n<td>Web E-Mail</td>\n<td>Web メールサービスを提供するサイトや、メールサービスに関する情報を含むサイトです。</td>\n</tr>\n</tbody></table>\n<blockquote>\n<p>上記はSophosのサイトより引用「Sophos XG Firewall: Web カテゴリ」<br> <a href=\"https://support.sophos.com/support/s/article/KB-000038862?language=ja\">https://support.sophos.com/support/s/article/KB-000038862?language=ja</a></p>\n</blockquote>\n<p>Sophos Firewallでは子供の端末をIPアドレスで特定した上で、Sophos FirewallのWebポリシーで設定し、Firewallルールを記述することになります。</p>\n<h3 id=\"まとめ\"><a href=\"#まとめ\" class=\"headerlink\" title=\"まとめ\"></a>まとめ</h3><p>ホワイトリストや都度アプリのインストールなど、親の方がそれなりに時間を使うことを覚悟しないとなかなかこの運用は難しいとも感じます。しかし自分の子供があまり素性の良くないアプリを入れることを友達から勧められた場合、親の承認が必要だからと断る事も可能になり、制約が長所になります。</p>\n<p>小さいうちに野放しだったものが、大きくなってからいきなりスクリーンタイムを親が一方的に設定すると子供にはネガティブな感情が生まれ、回避する方法を探します。 Web上には不満とともに回避する方法を探す投稿なども見かけます。ITの仕組みはフェールセーフくらいに考え、対話を重ねることが何よりも大事と考えさせられます。</p>\n","categories":["Security"]},{"title":"PC（ハードウェア）の準備","url":"/new-technology/2020/02/25/provision/","content":"<h2 id=\"ネットワーク構成\"><a href=\"#ネットワーク構成\" class=\"headerlink\" title=\"ネットワーク構成\"></a>ネットワーク構成</h2><p>Sophos Firewall(XG Firewal 以下、XG)を導入した場合のネットワーク構成は以下の図のようになります。一般的にはプロバイダーから貸与されるホームゲートウェイ（外側の光モデム等は省略）に直接PCを繋ぐか、ホームゲートウェイの無線機能でPCやスマホを接続する事になります。XGを導入する場合は、ホームゲートウェイとPCの間にXGを挟み込む形になります。</p>\n<span id=\"more\"></span>\n <img src=\"/new-technology/2020/02/25/provision/network.drawio.png\" class=\"\" title=\"alt\">\n\n<p>この構成はXGのWAN側とXGのLAN側と2つのネットワークを持つ事になり、XGには2枚のネットワークカード（以下、NIC）あるいは、2つ以上のPortを持っているNICを1枚用意する事になります。XGのWAN側のインタフェースは、ホームゲートウェイからDHCPでプライベートIPアドレスやDNSを割り当てられます。そして、LAN側のPCやスマホのために、XGはあらかじめユーザが決めたプライベートネットワークアドレスを割り当てます。XGはこのIP割り当てのためのDHCP機能やDNS機能を持っています。また、スマホのネット接続のために無線ルータを別途用意する必要があり、この場合は無線ルータをブリッジモードでセットアップする事になります。</p>\n<h2 id=\"ハードウェア構成の検討\"><a href=\"#ハードウェア構成の検討\" class=\"headerlink\" title=\"ハードウェア構成の検討\"></a>ハードウェア構成の検討</h2><p>上記の構成のために、2つのネットワークPortを持ったPCが1台必要になります。XGの制約としては、6Gbyteのメモリ上限とCPUが4coreまでとなります。物理サーバにそのままXGをインストールしても良いし、ESXi等の仮想ソフトの上にVMを構築しても良いです。ESXiの場合は、ハードウェア互換が厳しいため、本質的には互換リストを元にハードウェアの互換性を事前に確認します。</p>\n<blockquote>\n<p>VMware Compatibility Guide<br> <a href=\"https://www.vmware.com/resources/compatibility/search.php\">https://www.vmware.com/resources/compatibility/search.php</a></p>\n</blockquote>\n<p>ネットワークカードを検索する場合は、検索カテゴリに<mark class=\"label primary\">I/Oデバイス</mark>、I&#x2F;Oデバイスタイプに<mark class=\"label primary\">Network</mark>を選択します。お目当ての製品がある場合は製品名を入力し検索すると良いでしょう。</p>\n<p>ただし、法人向けの要素が強く個人が利用するデバイスがあまりリストされていません。CPUおよびネットワークカードはintel製が比較的認識しやすいという傾向があります。一般的には、以下のものが安全策で好まれるようで、私も昔はこのNICを2枚差してXGを使っていました。また、ストレージについてはESXi6.7からはsataのSSDで認識しないというのは少ないようですが、M2.NVMeは対象が絞られます。</p>\n<blockquote>\n<p>インテル® ギガビット CT デスクトップ・アダプター<br> <a href=\"https://www.intel.co.jp/content/www/jp/ja/products/details/ethernet/gigabit-network-adapters/gigabit-ct-desktop-adapters.html\">https://www.intel.co.jp/content/www/jp/ja/products/details/ethernet/gigabit-network-adapters/gigabit-ct-desktop-adapters.html</a><br> <img src=\"/new-technology/2020/02/25/provision/ct-desktop.png\" class=\"\" width=\"800\" title=\"alt\"></p>\n</blockquote>\n<p>2022年2月までは以下の10GbpsのNICをESXiで使っていました。</p>\n<blockquote>\n<p>インテル® イーサネット・コンバージド・ネットワーク・アダプター X550<br> <a href=\"https://www.intel.co.jp/content/www/jp/ja/products/details/ethernet/gigabit-network-adapters/gigabit-ct-desktop-adapters.html\">https://www.intel.co.jp/content/www/jp/ja/products/details/ethernet/gigabit-network-adapters/gigabit-ct-desktop-adapters.html</a><br> <img src=\"/new-technology/2020/02/25/provision/x550.png\" class=\"\" width=\"800\" title=\"alt\"></p>\n</blockquote>\n<p>このNICだと、1つのPCI Expressバスにこのカード1枚を刺し、WanとLanのインタフェースを用意できます。</p>\n<p>（2022-3-25更新）<br>最近、Ryzenでマシンを一新しました。NVMeも動作させており、ネットワークカードはX710に変えました。参考までにこちらの記事も参照して下さい。</p>\n<a href=\"/new-technology/2022/02/27/building-setup-esxi7/\" title=\"ESXI7.0をRyzen7 5700Gで構築\">ESXI7.0をRyzen7 5700Gで構築</a>\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"無償版ESXiのVMをQNAP NASにバックアップ","url":"/new-technology/2021/12/04/qnap-hdp/","content":"<img src=\"/new-technology/2021/12/04/qnap-hdp/title.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p class=\"onepoint\">この記事で実現すること</p>\n\n<p>QNAPより無償版ESXiの仮想マシン（VM）バックアップが可能なHyper Data Protector(HDP)という無償ソフトウェアが提供されています。Windows Server2016および2019のHyper-Vにも対応しています（Windows10のHyper-Vには対応しません）。無償版ESXiのバックアップソフトは「<a href=\"/new-technology/2021/03/06/esxi-nakivo/\" title=\"無償版ESXiの高度なバックアップ\">無償版ESXiの高度なバックアップ</a>」で書いた有償のもの（1年期限の無償版）は存在します。無償バックアップソフトは無償版ESXiに対応していないという難しい状況でしたが、NASが必須という前提はあるものの、無償ESXi×無償バックアップソフトウェアが登場してきました。エージェントレスで、ESXi本体やVMには何もインストールする必要はありません。まだ製品として安定していませんが、この記事ではESXiのVMをQNAPのNAS上にバックアップする方法をまとめています。なお、別のNASメーカーであるSynologyからもActive Backup for Businessという製品が提供されています。</p>\n<blockquote>\n<p>QNAP<br> <a href=\"https://www.qnap.com/ja-jp/software/hyper-data-protector\">https://www.qnap.com/ja-jp/software/hyper-data-protector</a><br>Synology<br> <a href=\"https://www.synology.com/ja-jp/dsm/feature/active_backup_business\">https://www.synology.com/ja-jp/dsm/feature/active_backup_business</a></p>\n</blockquote>\n<span id=\"more\"></span>\n\n<h2 id=\"稼働条件\"><a href=\"#稼働条件\" class=\"headerlink\" title=\"稼働条件\"></a>稼働条件</h2><ol>\n<li>HDPは現在x86ベース（IntelまたはAMD）のNAS QTS 4.5.4（またはそれ以降）のみ対応しています、またはQuTS hero h4.5.4（以降）を搭載したQuTS hero NASのみ対応しています。</li>\n<li>VMware ESXiは6.5、6.7、7.0が対象です（6.7以下は既にVMWareのサポートが切れていますので実質ESXi7.0が対象です）</li>\n</ol>\n<h2 id=\"直近のHDPのアップデート\"><a href=\"#直近のHDPのアップデート\" class=\"headerlink\" title=\"直近のHDPのアップデート\"></a>直近のHDPのアップデート</h2><p>アップデートのリストは以下を参照してください。</p>\n<blockquote>\n<p>QNAP Hyper Data Protector リリースノーツ（英語）<br> <a href=\"https://www.qnap.com/ja-jp/app_releasenotes/list.php?app_choose=HyperDataProtector\">https://www.qnap.com/ja-jp/app_releasenotes/list.php?app_choose=HyperDataProtector</a></p>\n</blockquote>\n<p> 現在は、2022年12月に発表された、1.4.2.1201が最新です。</p>\n<h2 id=\"HDPの主要な機能について\"><a href=\"#HDPの主要な機能について\" class=\"headerlink\" title=\"HDPの主要な機能について\"></a>HDPの主要な機能について</h2><ol>\n<li>VMのバックアップを複数世代管理</li>\n<li>ジョブスケジューリング機能<br> ワンタイム、定期、日次、週次、月次を利用できます。</li>\n<li>重複排除（データ圧縮）<br> ストレージレベルの重複排除ではありません。VMに対してのデータ圧縮を重複排除と表現しています。</li>\n<li>暗号化転送</li>\n<li>バックアップデータの暗号化</li>\n</ol>\n<h2 id=\"QNAP-NASの事前準備\"><a href=\"#QNAP-NASの事前準備\" class=\"headerlink\" title=\"QNAP NASの事前準備\"></a>QNAP NASの事前準備</h2><h3 id=\"HDPのインストール\"><a href=\"#HDPのインストール\" class=\"headerlink\" title=\"HDPのインストール\"></a>HDPのインストール</h3><p>QNAPのWeb画面に管理者としてログインし、AppCenterから”Hyper Data Protector”をインストールします。なおContainerStationが合わせてインストールされます。</p>\n<img src=\"/new-technology/2021/12/04/qnap-hdp/install.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p>上記はインストール済みの状態ですが、<mark class=\"label primary\">「＋ インストール」ボタン</mark>をクリックしてインストールします。<br>必須要件のContainerStationがインストールされると物理ネットワークカードに対し仮想ネットワークが自動構築されます。既存端末から手動でのルーティング設定は不要でQNAP自身がProxyのように振る舞います。QNAPのQuFirewallを利用している場合は追加設定が必要となる場合があります。</p>\n<h3 id=\"共有フォルダの設定\"><a href=\"#共有フォルダの設定\" class=\"headerlink\" title=\"共有フォルダの設定\"></a>共有フォルダの設定</h3><p>バックアップデータを保存する共有フォルダを作成します。<mark class=\"label primary\">コントロールパネル</mark>を起動し、<mark class=\"label primary\">権限設定</mark>-<mark class=\"label primary\">共有フォルダ</mark>へと進み、<mark class=\"label primary\">作成</mark>ボタンをクリックします。</p>\n<div class=\"note info\"><h4 id=\"可用性および機密性向上のために\"><a href=\"#可用性および機密性向上のために\" class=\"headerlink\" title=\"可用性および機密性向上のために\"></a>可用性および機密性向上のために</h4><ul>\n<li>バックアップデータが肥大化して他のファイル共有サービスなどに影響を与えないよう、バックアップ計画に基づいたデータ容量を計算の上で、HDP専用のディスクボリュームを作成される事をお勧めします。</li>\n<li>HDPの運用には管理者権限を持ったユーザーが必要です。セキュリティ向上のため、HDP専用ユーザーを新規作成しフォルダへのアクセス権を最小限にし、各種ネットワークサービスを無効化される事をお勧めします。また、HDP管理画面へのログインは2要素認証に対応しています。</li>\n</ul>\n</div>\n\n<ol>\n<li><p>バックアップデータを保存したいディスクボリュームを選択し、フォルダ名を指定します。私の例では事前にディスクボリュームを作成しています（次項で説明します）。</p>\n <img src=\"/new-technology/2021/12/04/qnap-hdp/share-folder1.png\" class=\"\" width=\"640\" title=\"alt\">\n<p> バックアップ領域を暗号化するのであれば、このタイミングで暗号化を選択（チェック）し、パスワードを設定、暗号化キーの保存を選択（チェック）します。</p>\n</li>\n<li><p>共有フォルダにアクセス可能な管理者ユーザーを指定します。この例ではhdpという管理者アカウントを作成しており、そのアカウントに共有フォルダのアクセス権を加えています（この手順ではユーザーの作成は省略しています）。</p>\n <img src=\"/new-technology/2021/12/04/qnap-hdp/share-folder2.png\" class=\"\" width=\"640\" title=\"alt\"></li>\n<li><p>フォルダのオプションを設定します。</p>\n <img src=\"/new-technology/2021/12/04/qnap-hdp/share-folder3.png\" class=\"\" width=\"640\" title=\"alt\"></li>\n</ol>\n<p>暗号化有無によってバックアップ速度は殆ど変わりません。</p>\n<h3 id=\"専用ディスクボリュームの設定（任意）\"><a href=\"#専用ディスクボリュームの設定（任意）\" class=\"headerlink\" title=\"専用ディスクボリュームの設定（任意）\"></a>専用ディスクボリュームの設定（任意）</h3><p>前述したとおり、バックアップ計画に基づき割り当てるディスクボリュームを設定します。</p>\n<ol>\n<li><mark class=\"label primary\">ストレージ＆スナップショット</mark>を起動し、左ペインメニューの<mark class=\"label primary\">ストレージ＆スナップショット</mark>から<mark class=\"label primary\">作成</mark>ボタンをクリックし、ディスクボリュームを作成するストレージプールを選択します。\n <img src=\"/new-technology/2021/12/04/qnap-hdp/volume1.png\" class=\"\" width=\"800\" title=\"alt\">\n</li>\n<li><p>ボリュームのエイリアス名を指定し、ボリューム容量を決定します。</p>\n <img src=\"/new-technology/2021/12/04/qnap-hdp/volume2.png\" class=\"\" width=\"640\" title=\"alt\">\n</li>\n<li><mark class=\"label primary\">次へ</mark>ボタン、続いて<mark class=\"label primary\">完了</mark>ボタンをクリックしてボリュームを作成します。</li>\n</ol>\n<p>HDPはバックアップ時の圧縮が可能ですので、目安としてはVMのシンプロビジョニングの容量×世代数で圧縮率が50％〜70％程度を目標にするのがよろしいかと思います。シックプロビジョニングであれば圧縮率が高い事が期待されます。私の環境では64GBのWin10、40GBのSophos Firewall、256GBのUbuntuと合計360GBのVMが最終的に62.73GBまで圧縮されています。Ubuntuの実態はおそらく数GBしかなく、シック プロビジョニング (Lazy Zeroed)は相当に圧縮率が高くなると思われます。一旦テストでバックアップを取得され、圧縮結果を確認のうえ、世代数を乗じたものをボリューム容量とされるのが1つの方法かとも思われます。</p>\n<p>私の場合、最低半年の月毎のバックアップを6世代、直近月内の週毎のバックアップを4世代と考え、合計10世代としています。計算上は640GB、もちろん今後アプリケーションやデータを追加していけばVMは膨らんでいくので、目安として1TBを確保しています。</p>\n<h2 id=\"ESXiの事前準備\"><a href=\"#ESXiの事前準備\" class=\"headerlink\" title=\"ESXiの事前準備\"></a>ESXiの事前準備</h2><p>ESXiには以下の設定が必要です。</p>\n<ol>\n<li>HDPからESXiに対しHTTPS(Port443)、SSH(Port22)を使って接続可能なように設定します。</li>\n<li>HDPがバックアップするVMはCBT(Changed Block Tracking)を有効にしなければなりません。</li>\n<li>（任意）セキュリティ向上のため、ESXi上に管理者アカウントを作成します。</li>\n<li>（任意）セキュリティ向上のため、接続可能なIPアドレスをESXi上のFirewall設定で絞ります。</li>\n</ol>\n<h3 id=\"ESXi上でHTTPS、SSHの解放\"><a href=\"#ESXi上でHTTPS、SSHの解放\" class=\"headerlink\" title=\"ESXi上でHTTPS、SSHの解放\"></a>ESXi上でHTTPS、SSHの解放</h3><p>無償版ESXiを使う場合はブラウザから基本はvSphere Web Clientを使いますので、HTTPS(Pprt443)の解放は特に意識する必要はありません。ESXiのファイアウォールで接続可能なIPアドレスを絞っている場合はQNAP NASのIPアドレスから接続できるようにしておきます。</p>\n<p>SSH(Port22)についてはESXiはデフォルトでサービス停止されている状態ですので、シェルおよびSSHのサービスを起動します。<br>左ペインメニューの<mark class=\"label primary\">ホスト</mark>ー<mark class=\"label primary\">管理</mark>の<mark class=\"label primary\">サービスタブ</mark>から<mark class=\"label primary\">TSM</mark>および<mark class=\"label primary\">TSM-SSH</mark>を起動します。<br> <img src=\"/new-technology/2021/12/04/qnap-hdp/esxi1.png\" class=\"\" width=\"800\" title=\"alt\"><br>この2つのサービスは右クリックメニューの<mark class=\"label primary\">ポリシー</mark>から<mark class=\"label primary\">ホストと連動して起動および停止します</mark>をチェックしておく事でESXiの起動時に自動的にサービスが起動するようになります。</p>\n<h3 id=\"VMのChanged-Block-Trackingの設定\"><a href=\"#VMのChanged-Block-Trackingの設定\" class=\"headerlink\" title=\"VMのChanged Block Trackingの設定\"></a>VMのChanged Block Trackingの設定</h3><p>事前にVMのデータを退避することをお勧めします。VMを停止のうえで、データストアブラウザからVMの入っているフォルダ毎別の場所にコピーしてください。もし、設定の変更でVMを壊してしまった場合は、当該フォルダの<code>VM名.vmx</code>を右クリックから「VMの登録」で再登録できます。<a href=\"/new-technology/2020/10/11/esxi-backup/\" title=\"VMware ESXiの仮想マシンをバックアップする\">VMware ESXiの仮想マシンをバックアップする</a>を参考にghettoVCBなど無償ツールでバックアップを取る事も可能です。</p>\n<p>ESXiの機能であるChanged Block Tracking(CBT)はVMが稼働していて前回バックアップしたものから未更新のディスクブロックをスキップして差分のみバックアップする機能です。途中で別のバックアップ製品によるバックアップ、例えばghettoVCBなどでバックアップされると、次回のバックアップはフルバックアップを行います。</p>\n<p>最初にVMがインストールされているディスクを調べ、そのSCSI-IDを確認します。<br>ESXi管理画面のVMを選択し右クリックして<mark class=\"label primary\">設定の編集</mark>をクリックします。</p>\n<img src=\"/new-technology/2021/12/04/qnap-hdp/esxi2.png\" class=\"\" width=\"640\" title=\"alt\">\n\n<mark class=\"label primary\">ハードディスク</mark>の詳細を開き、<mark class=\"label primary\">コントローラの場所</mark>でSCSI-IDを確認します（SCSI(0:0)など）。\n\n<ol>\n<li>VMを停止します。</li>\n<li>ESXi管理画面のVMを右クリックして、<mark class=\"label primary\">設定の編集</mark>をクリックします。</li>\n<li><mark class=\"label primary\">VMオプション</mark>タブをクリックします。</li>\n<li><mark class=\"label primary\">詳細</mark>セクションを開き <mark class=\"label primary\">設定パラメータ</mark>の<mark class=\"label primary\">設定の編集</mark>をクリックします。<mark class=\"label primary\">設定パラメータ</mark>ダイアログが開きます。</li>\n<li><mark class=\"label primary\">パラメータの追加</mark>をクリックします。</li>\n<li><code>ctkEnabled</code>パラメータを追加して、その値を<code>true</code>に設定します。</li>\n<li>さらに<mark class=\"label primary\">パラメータの追加</mark>をクリックし、<code>scsi0:0.ctkEnabled</code>を追加して、その値を<code>true</code>に設定します（環境に合わせて<code>scsi0:0</code>の内容は変更してください）。</li>\n<li>OKボタンをクリックし設定を完了させます。</li>\n<li>VMを起動します。</li>\n<li>SSHでESXiに入り、VMが配置されているディレクトリで、<code>VM名-ctk.vmdk</code>ファイルがあることを確認します。</li>\n</ol>\n<p>CBTを無効にする場合はこの逆の手順、ctkEnabledの値をfalseに設定します。<br>VMWareによるCBTの説明は以下を参照してください。</p>\n<blockquote>\n<p>VMware VM上の変更ブロックのトラッキング（CBT） (1020128)<br> <a href=\"https://kb.vmware.com/s/article/1031873?lang=ja&amp;queryTerm=changed+block+tracking\">https://kb.vmware.com/s/article/1031873?lang=ja&amp;queryTerm=changed+block+tracking</a></p>\n</blockquote>\n<h3 id=\"（任意）管理者アカウントの作成\"><a href=\"#（任意）管理者アカウントの作成\" class=\"headerlink\" title=\"（任意）管理者アカウントの作成\"></a>（任意）管理者アカウントの作成</h3><p>セキュリティの観点からrootはできるだけ使わない事をお勧めします。これは一般論でありrootがよく知られたユーザー名だからです。例えばQNAP-NASからESXiのrootユーザーの情報が漏洩しないようにrootを使う機会を減らすべきです。以下の手順で管理者アカウントを作成します。</p>\n<ol>\n<li>管理メニューの左ペイン<mark class=\"label primary\">ホスト</mark>ー<mark class=\"label primary\">管理</mark>から<mark class=\"label primary\">セキュリティとユーザー</mark>に進み、<mark class=\"label primary\">ユーザー</mark>から<mark class=\"label primary\">ユーザーの追加</mark>をクリックします。<img src=\"/new-technology/2021/12/04/qnap-hdp/esxi5.png\" class=\"\" width=\"800\" title=\"alt\"></li>\n<li>HDPから接続する専用のユーザー名とパスワードを登録してユーザーの作成を終えます。</li>\n<li>管理メニューの左ペイン<mark class=\"label primary\">ホスト</mark>から<mark class=\"label primary\">アクション</mark>を選択し、プルダウンの<mark class=\"label primary\">権限</mark>をクリックします。</li>\n<li>さらに<mark class=\"label primary\">ユーザーの追加</mark>を選択します。実際には上記で作成したユーザーと同一名のユーザー名を入力します。ロールについては”システム管理者”を選択します。<img src=\"/new-technology/2021/12/04/qnap-hdp/esxi4.png\" class=\"\" width=\"800\" title=\"alt\"></li>\n</ol>\n<p>これで新しいユーザーが作成できたので、Web管理画面からログイン可能か確認してください。rootユーザーは長めのパスワードを再設定し、パスワード管理ソフトに登録し普段は使わないようにします。普段から使わずにパスワードを封印しておけばより安全になります。</p>\n<h3 id=\"（任意）SSH、Web-Clientのために接続可能なIPアドレスを絞る\"><a href=\"#（任意）SSH、Web-Clientのために接続可能なIPアドレスを絞る\" class=\"headerlink\" title=\"（任意）SSH、Web Clientのために接続可能なIPアドレスを絞る\"></a>（任意）SSH、Web Clientのために接続可能なIPアドレスを絞る</h3><p>この機能はESXiではファイアウォールと呼ばれ、Linuxのiptablesやufwと同様にシンプルなものです。ホームユーザーはシンプルなLANで閉じられたアクセスですが、安全のために特にSSHは設定を検討すべきです。<br>Web管理画面の左ペインメニューの <mark class=\"label primary\">ネットワーク</mark>を選択し、<mark class=\"label primary\">ファイアウォール</mark>タブをクリックして見つける事ができます。デフォルトでは一切の制約なく接続可能になっていますので、ここでSSHとWeb Clientに接続可能なIPを登録できます。</p>\n<img src=\"/new-technology/2021/12/04/qnap-hdp/esxi3.png\" class=\"\" title=\"alt\">\n\n<h2 id=\"HDPへのログイン\"><a href=\"#HDPへのログイン\" class=\"headerlink\" title=\"HDPへのログイン\"></a>HDPへのログイン</h2><p>QNAP-NASでHDPを起動するとHDPのログイン画面が表示されます。</p>\n<img src=\"/new-technology/2021/12/04/qnap-hdp/hdp1.png\" class=\"\" title=\"alt\">\n\n<p>2要素認証を設定されている方には「2段階認証」のポップアップが表示されます。6桁のワンタイムパスワードを入力しログインします。</p>\n<p>以下はログイン直後のメインページです。</p>\n<img src=\"/new-technology/2021/12/04/qnap-hdp/hdp2.png\" class=\"\" title=\"alt\">\n\n<table>\n<thead>\n<tr>\n<th>ネットワーク</th>\n<th>内容</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>インベントリ</td>\n<td>ESXiのホストおよび登録されているVMを選択します</td>\n</tr>\n<tr>\n<td>リポジトリ領域</td>\n<td>QNAP-NASの共有フォルダを選択し、そこにバックアップデータを登録します。複数の保存先が設定できます</td>\n</tr>\n<tr>\n<td>バックアップ</td>\n<td>バックアップジョブを作成します。同一のVMについて周期の異なるジョブやリポジトリを変えたジョブを作成できます</td>\n</tr>\n<tr>\n<td>復元</td>\n<td>バックアップからESXiにVMを復元します</td>\n</tr>\n<tr>\n<td>ジョブの状態</td>\n<td>バックアップジョブ毎のジョブ状態を表示します</td>\n</tr>\n<tr>\n<td>システム</td>\n<td>イベントログが表示されます</td>\n</tr>\n</tbody></table>\n<h2 id=\"インベントリ登録\"><a href=\"#インベントリ登録\" class=\"headerlink\" title=\"インベントリ登録\"></a>インベントリ登録</h2><p>ここでは、任意の名前、ESXiのIPアドレス、ESXiにログインするユーザーおよびパスワードを指定し、登録します。</p>\n<img src=\"/new-technology/2021/12/04/qnap-hdp/hdp3.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<p>登録が無事完了するとVMの数が表示されます。</p>\n<h2 id=\"バックアップリポジトリ登録\"><a href=\"#バックアップリポジトリ登録\" class=\"headerlink\" title=\"バックアップリポジトリ登録\"></a>バックアップリポジトリ登録</h2><p>既に作成してある共有フォルダを指定します。画面右上の<mark class=\"label primary\">バックアップリポジトリの追加</mark>ボタンをクリックします。</p>\n<img src=\"/new-technology/2021/12/04/qnap-hdp/hdp4.png\" class=\"\" width=\"640\" title=\"alt\">\n\n<mark class=\"label primary\">選択</mark>ボタンをクリックし、共有フォルダを選択します。バックアップデータを暗号化しない場合は<mark class=\"label primary\">データ暗号化を有効にする</mark>のチェックボックスが空白になっています。NASの共有フォルダを暗号化している場合はチェックボックスが選択された状態になっています。\n\n<h2 id=\"バックアップ\"><a href=\"#バックアップ\" class=\"headerlink\" title=\"バックアップ\"></a>バックアップ</h2><p>いよいよバックアップです。</p>\n<img src=\"/new-technology/2021/12/04/qnap-hdp/hdp5.png\" class=\"\" width=\"640\" title=\"alt\">\n<p>画面右上の<mark class=\"label primary\">ジョブの作成</mark>ボタンをクリックし、ジョブを構成します。</p>\n<ol>\n<li><p>VMの選択<br> VMとバックアップ先のリポジトリを設定します</p>\n <img src=\"/new-technology/2021/12/04/qnap-hdp/hdp6.png\" class=\"\" width=\"640\" title=\"alt\">\n</li>\n<li><p>スケジュール</p>\n <mark class=\"label primary\">スケジューラー</mark>、<mark class=\"label primary\">リンクしたジョブの後に実行</mark>、<mark class=\"label primary\">スケジュールなし</mark>を選択します。\n <img src=\"/new-technology/2021/12/04/qnap-hdp/hdp7.png\" class=\"\" width=\"640\" title=\"alt\">\n<p> 少し気づきづらいですが、画面上部の <mark class=\"label primary\">スケジュール</mark>の隣に<mark class=\"label primary\">保持</mark>とあります。ここをクリックすると、以下の通りバックアップの保存期間を設定可能です。</p>\n <img src=\"/new-technology/2021/12/04/qnap-hdp/hdp8.png\" class=\"\" width=\"640\" title=\"alt\">\n</li>\n<li><p>ルール<br> バックアップ時のデータ転送に関する暗号化や圧縮について設定します。</p>\n <img src=\"/new-technology/2021/12/04/qnap-hdp/hdp9.png\" class=\"\" width=\"640\" title=\"alt\">\n <mark class=\"label primary\">全VMに対しVMware CBTを有効にする</mark>では以下の説明があります。\n<p>「VMware CBT (Changed Block Tracking) は、Hyper Data Protectorがバックアップを実行する時には有効になっていなければなりません」<br> また、<mark class=\"label primary\">アプリケーションアウェア処理の有効化</mark>とあります。VSSというのはWindowsのVolume Shadow Copy Serviceを指しています。スナップショットなどを取得する場合、VSSに対応したアプリケーションに対して一旦データ書き込みなどを待たせるなどの命令を出し、アプリケーションのデータ一貫性を保つ機能です。バックアップ対象がWindowsの場合に意味があります。詳しくは以下の記事を参照してください。</p>\n<blockquote>\n<p>Microsoft<br> <a href=\"https://docs.microsoft.com/ja-jp/windows-server/storage/file-server/volume-shadow-copy-service\">https://docs.microsoft.com/ja-jp/windows-server/storage/file-server/volume-shadow-copy-service</a></p>\n</blockquote>\n</li>\n<li><p>要約<br> 設定した内容を確認し、スケジューリングしたものを保存するか、すぐにバックアップを取得するかを選択します。</p>\n <img src=\"/new-technology/2021/12/04/qnap-hdp/hdp10.png\" class=\"\" width=\"640\" title=\"alt\"></li>\n</ol>\n<p>HDPのデザインですが、以下の注意事項があります。</p>\n<div class=\"note warning\"><ul>\n<li>ESXiのVMのバックアップはESXi上でほぼ同じサイズのコピーを作成します。従い、ESXiのデータストアはVMの分だけ空きを残している必要があります。ストレージが不足していても単にバックアップエラーとなり原因に悩みますのでご注意ください</li>\n</ul>\n</div>\n\n<p>メニューの<mark class=\"label primary\">ジョブの状態</mark>、<mark class=\"label primary\">システム</mark>ではバックアップの状況やエラーログを確認できます。また、HDPの右上のメニューから通知の設定ができますので、スマホなどへの通知設定をお勧めします。</p>\n<p>私の環境のバックアップ時間は、リポジトリ暗号化なし、転送時暗号化あり、圧縮なしのオプションで64GBのWindows10のバックアップに16分程度掛かりました。ESXiとNASはそれぞれ10GbEで接続され、NASはHDDとQtierと呼ばれるNVMeとの動的な組み合わせになっていますが、データ転送時は最大で2.5Gbps程度の速度です。</p>\n<h2 id=\"復元\"><a href=\"#復元\" class=\"headerlink\" title=\"復元\"></a>復元</h2><p>復元メニューからジョブの作成を行います。まず最初に復元するジョブと復元するVMの場所を指定します。</p>\n <img src=\"/new-technology/2021/12/04/qnap-hdp/hdp11.png\" class=\"\" width=\"640\" title=\"alt\">\n\n<p>バックアップジョブ（リポジトリ）に含まれている対象のバックアップを選択します。</p>\n <img src=\"/new-technology/2021/12/04/qnap-hdp/hdp12.png\" class=\"\" width=\"640\" title=\"alt\">\n\n<p>復元先はデフォルトでバックアップしたESXiが選択されています。</p>\n<img src=\"/new-technology/2021/12/04/qnap-hdp/hdp13.png\" class=\"\" width=\"640\" title=\"alt\">\n\n<mark class=\"label primary\">ターゲットの編集</mark>をクリックして、VMストレージ先の変更や新しい場所に（別のVMとして）復元する事も可能です。ここでも戻す際のESXi上のデータストアの容量には気をつけてください。\n\n<p>続いてスケジュールが必要であれば設定します。</p>\n<mark class=\"label primary\">ルール</mark>設定では、VMを上書きするか名前の変更して別名で登録するかを選びます。\n\n<img src=\"/new-technology/2021/12/04/qnap-hdp/hdp14.png\" class=\"\" width=\"640\" title=\"alt\">\n\n<p>復元されたVMを自動的に起動するというオプションもあります。これは上書きで戻す場合には使い勝手が良いですが、複製を作る場合はvSwitchにおける仮想NICが変わる事やIPアドレスの重複の可能性に留意する必要があります。もちろんOSのライセンス上の問題もありますので注意が必要です。</p>\n<p>最後にジョブを作成するかすぐに復元するか選択します。</p>\n<h2 id=\"HDPを使った感想\"><a href=\"#HDPを使った感想\" class=\"headerlink\" title=\"HDPを使った感想\"></a>HDPを使った感想</h2><p>HDPは有償版ESXiのvStorageAPIを使ったバックアップのように高機能ではありませんが、日次・週次のバックアップなどホームユーザーが利用するための必須条件は押さえていると思います。</p>\n","categories":["Software"],"tags":["ESXi","QNAP"]},{"title":"安全快適にリモートワークを行う","url":"/new-technology/2020/08/14/remote-work/","content":"<img src=\"/new-technology/2020/08/14/remote-work/title.png\" class=\"\" title=\"alt\">\n\n<h2 id=\"安全快適な在宅勤務を行うために\"><a href=\"#安全快適な在宅勤務を行うために\" class=\"headerlink\" title=\"安全快適な在宅勤務を行うために\"></a>安全快適な在宅勤務を行うために</h2><p>すっかり在宅勤務が新たな日常として定着しつつありますが、2020-07-01に<strong>ICT-ISAC</strong>（アイシーティ・アイザック）から「家庭内で安全快適に在宅勤務を行うためのリファレンスガイド」が公開されています。ICT-ISACは、サイバーセキュリティに関する情報収集・調査・分析等の業務を行っている組織で、<strong>IPA情報処理推進機構</strong>と同様に、情報セキュリティについて分かり易く記事が掲載されています。ガイドの詳細は、以下の記事を参照してください。</p>\n<blockquote>\n<p>ICT-ISAC（アイシーティ・アイザック）<br> <a href=\"https://www.ict-isac.jp/index.html\">https://www.ict-isac.jp/index.html</a><br>IPA情報処理推進機構<br> <a href=\"https://www.ipa.go.jp/\">https://www.ipa.go.jp</a><br>家庭内で安全快適に在宅勤務を行うための リファレンスガイド<br> <a href=\"https://www.ict-isac.jp/news/remote%20work%20reference%20guide.pdf\">https://www.ict-isac.jp/news/remote%20work%20reference%20guide.pdf</a></p>\n</blockquote>\n<span id=\"more\"></span>\n<h2 id=\"在宅勤務のための技術的要件\"><a href=\"#在宅勤務のための技術的要件\" class=\"headerlink\" title=\"在宅勤務のための技術的要件\"></a>在宅勤務のための技術的要件</h2><p>上記のリファレンスガイドは、大事な会議の内容を家族などに聞かれないなどの<strong>体制面</strong>の話と、Wi-Fiルーターの設定などの<strong>技術面</strong>の2つを両立する必要があります。会社のノートPCを貸与され、自宅の無線ルーターおよびインターネット回線を用い、VPNで会社に接続するのが一般的な形態ではないでしょうか。ここでは技術的要件として、セキュリティ上安全である事を筆頭に、大事な会議中に無線が切断されてしまう事の無い安定したリモートワークを実現するための無線ルーターの設定やソフトウェアなどの活用について紹介します。</p>\n<p>まず、上記のリファレンスをチェックシートにすると以下の内容となります。</p>\n<table>\n<thead>\n<tr>\n<th>要件</th>\n<th>対応方法</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>P6自宅のルーターの管理画面や機器がインターネットから見えていないこと</td>\n<td>（1）無線ルーターについて</td>\n</tr>\n<tr>\n<td>P8自宅のルーターの管理画面のパスワードを適切に設定しておく</td>\n<td>（2）パスワード管理ソフトの導入</td>\n</tr>\n<tr>\n<td>P9自宅のWi-Fiネットワークのセキュリティを適切に設定する</td>\n<td>（1）無線ルーターについて</td>\n</tr>\n<tr>\n<td>P12パソコンの共有設定を確認しておく</td>\n<td>（1）無線ルーターについて</td>\n</tr>\n<tr>\n<td>P13自宅のLANに接続されている機器を確認しておく</td>\n<td>（4）ネットワークチェックツールの利用</td>\n</tr>\n<tr>\n<td>P15すべての機器のファームウェアを更新する</td>\n<td>（1）無線ルーターについて</td>\n</tr>\n<tr>\n<td>P16すべての機器に対して適切なパスワードを設定する</td>\n<td>（2）パスワード管理ソフトの導入</td>\n</tr>\n<tr>\n<td>P18パソコンに接続されたマイクやカメラの状態を意識する</td>\n<td>（3）セキュリティ対策ソフトの導入</td>\n</tr>\n<tr>\n<td>P20利用機器のサポート体制を確認する</td>\n<td>（1）無線ルーターについて<p>※メーカーWebサイトの確認</td>\n</tr>\n</tbody></table>\n<h2 id=\"（1）無線ルーターについて\"><a href=\"#（1）無線ルーターについて\" class=\"headerlink\" title=\"（1）無線ルーターについて\"></a>（1）無線ルーターについて</h2><p>無線ルーターの設定のポイントは上記で示すようにたくさんあります。無線ルーターは毎年規格が新しくなっていくもので、耐用年数もPCなどと比較し、寿命が短いと言えます。</p>\n<ul>\n<li>ルーターの設定画面がインターネットから見えていないこと</li>\n<li>Wi-Fiネットワークのセキュリティを適切に設定する</li>\n<li>利用機器のサポート体制を確認する</li>\n</ul>\n<p>上記の1点目はデフォルト設定で特に問題は起きない内容ではあります。ルーターの設定画面についても、業務用ルーターを間違った使い方をしない限りは発生しないものです。Wi-Fiのセキュリティについて、WPA2も一時は脆弱性で話題となりましたが、最近発売されているルーターはきちんと対応がなされています。しかし、過去に販売されているものを継続して使っている場合はサポートが切れていないか確認が必要です。<strong>サポートが切れている機器はセキュリティ事故が発生する前に、速やかな交換が必要です</strong>。Wi-Fiセキュリティについて、最近はWPA3に対応した製品も発売されています。WPA3&#x2F;WPA2と併用できる設定もありますが、脆弱性の対応がなされているWPA2（AES）であれば無理をしてWPA3を併用する必要はありません。Apple社のWi-Fiアクセスポイントに関する推奨としては、WPA3→WPA3&#x2F;WPA2（AES）併用→WPA2（AES）の順に推奨されています。詳細は以下を参照してください。</p>\n<blockquote>\n<p>NECプラットフォームズ：【重要】「WPA2」の脆弱性に関するお知らせ<br> <a href=\"https://www.aterm.jp/product/atermstation/info/2017/info1018.html\">https://www.aterm.jp/product/atermstation/info/2017/info1018.html</a><br>バッファロー：無線LAN商品のWPA2の脆弱性について<br> <a href=\"https://www.buffalo.jp/news/detail/20171017-01.html\">https://www.buffalo.jp/news/detail/20171017-01.html</a><br>Apple -Wi-Fi ルーターと Wi-Fi アクセスポイントの推奨設定-<br> <a href=\"https://support.apple.com/ja-jp/HT202068\">https://support.apple.com/ja-jp/HT202068</a></p>\n</blockquote>\n<h3 id=\"機器のファームウェアを更新する\"><a href=\"#機器のファームウェアを更新する\" class=\"headerlink\" title=\"機器のファームウェアを更新する\"></a>機器のファームウェアを更新する</h3><p>国内の無線LANの有名メーカーでは、ファームウェアは自動更新する方式に変わってきています。もし無線ルーターを買い換えるのであれば自動更新機能がついた機器を購入される事をお勧めします。過去の発売された無線ルーターもファームウェアの更新で、自動更新モードが加えられるケースもあります。脆弱性対応のために<strong>自動更新を設定する事</strong>をお勧めします。</p>\n<p>「ご家庭でWi-Fiルーターをより安全にお使い頂くために」というタイトルで、Wi-Fiルーターを利用する上での注意喚起が公開されています。提言しているのは以下の4社です。ITリテラシーの啓蒙だけではなく、こういう形でメーカー自らが主導する取り組みは素晴らしい事です。詳細は以下を参照してください。</p>\n<p>  ・株式会社アイ・オー・データ機器<br>  ・NECプラットフォームズ株式会社<br>  ・エレコム株式会社<br>  ・株式会社バッファロー</p>\n<blockquote>\n<p>一般社団法人デジタルライフ推進協会-ご家庭で Wi-Fi ルーターをより安全にお使い頂くために-<br> <a href=\"https://dlpa.jp/pdf/dlpa_pr_20191218.pdf\">https://dlpa.jp/pdf/dlpa_pr_20191218.pdf</a><br>NECプラットフォームズ：【重要】Wi-Fiルータをより安全にお使いいただくためのお願い<br> <a href=\"https://www.aterm.jp/product/atermstation/info/2019/info1218.html\">https://www.aterm.jp/product/atermstation/info/2019/info1218.html</a><br>バッファロー：Wi-Fiルーター&#x2F;中継機を最新のファームウェアに更新する方法（ファームウェア自動更新機能を利用）<br> <a href=\"https://www.buffalo.jp/support/faq/detail/15923.html\">https://www.buffalo.jp/support/faq/detail/15923.html</a></p>\n</blockquote>\n<h3 id=\"パソコンの共有設定を確認する\"><a href=\"#パソコンの共有設定を確認する\" class=\"headerlink\" title=\"パソコンの共有設定を確認する\"></a>パソコンの共有設定を確認する</h3><p>会社から貸与されたPCを使う上でのポイントを記載します。会社が貸与するPCは流石にセキュリティ対策もしっかりしたものが行われていると考えられますが、完全にそれを信頼するわけにはいきません。逆もまた然りで、個人の利用するPCが会社の貸与PCに対しての脅威となる可能性があります。パソコンの共有設定を制限する代わりに、<strong>ゲスト用の無線APに接続する事で対策が可能</strong>となります。バッファローでは”ゲストポート”、NECプラットフォームズでは”ネットワーク分離機能”と呼ばれます。有線接続を含めた個人の機器へ一切アクセスさせずにインターネットの接続が可能となります。</p>\n<h3 id=\"無線ルーターのチェックポイント\"><a href=\"#無線ルーターのチェックポイント\" class=\"headerlink\" title=\"無線ルーターのチェックポイント\"></a>無線ルーターのチェックポイント</h3><p>価格．COMの無線LANルーター(Wi-Fiルーター) 人気売れ筋ランキング2022年3月によれば、人気のある無線ルーターは、バッファロー、NECプラットフォームズ（Aterm）などの国内製品が上位20位までに19がランクインしています。私見ですが、少しでも安定稼働、安全に利用するためのポイントを記載します。</p>\n<ol>\n<li><p>無線LANのAPモードにでは、固定IPを振る<br>無線LANをAPモードにする場合は親機やプロバイダ貸与のHGWからのDHCPによってIPを割り当てられますが、固定IPとする方が瞬断などの不具合の可能性を下げられます。</p>\n</li>\n<li><p>Wi-Fiの5GHzはW52固定を利用する<br>気象レーダーや軍事レーダーの影響でW53およびW56は1分間無線の出力を停止してしまう可能性があります。大事な会議では致命的です。自宅がレーダーの影響を受けないと確認できていれば気にする必要はありません。無線チャンネルが自動選択の場合（Atermではオートチャネルセレクトと呼ばれます）も瞬断の原因になりやすいため、使わない方が無難です。また最新の高性能ルーターでは160Mzhのオクタチャンネルで高速化を図る製品も出ていますが、これもW52の4チャネルでは不足し、他のチャネルを併用することになります。つまり、レーダーの影響を受ける事になるため、W52のクアッドチャネルまでに留めておいたほうが無難です。</p>\n</li>\n<li><p>暗号キーの自動更新間隔について<br>設定画面で暗号キーを一定間隔で更新するという機能があり、更新間隔の設定項目があります。基本的にビジネスで利用するアプリケーションは殆どがユニキャスト通信（1対1の通信）で、これの暗号キーはフレーム単位に鍵を変化させており、この設定間隔とは関係ありません。但しブロードキャストおよびマルチキャストのような1対1通信ではない場合は、1フレーム毎に変更というわけにはいかず、暗号キーを一定期間で更新する仕組みを取っています。従い暗号キーを一定間隔で更新しない事が即座に脆弱性となるわけではなく、ネットワークが混乱しないようにする仕組みと考えた方が良いようです。バッファローの初期値は0（更新しない）、Atermは30分となっています。ビジネス用途ではありませんが動画配信のDLNAプロトコルはマルチキャストですから、アプリケーションが利用するプロトコルによってはこの鍵更新のタイミングで途切れる場合があります。</p>\n</li>\n<li><p>マルチキャストの速度設定<br>上述したDLNAはひかりTVなどで利用されます。このDLNAに利用されるマルチキャストは、バッファローであればマルチキャストレート、Atermであればマルチキャスト伝送速度という名前で記載されています。例えばAtermですと初期値が6Mbpsで、これだと十分に番組を伝送出来ない可能性があります。従いその値を増やす事でTV映像は安定します。しかし、マルチキャストは1対多で指定した帯域を確保し伝送するわけですから、全ての端末にデータ配信が行われます。無線機に接続された仕事用の端末はマルチキャストパケットの帯域確保が優先されてしまう事で仕事上のTV会議などが思わず影響を受けてしまう事になります。従いマルチキャストレートは上げすぎても良くないという事になります。マルチキャスト通信も種類があり、上述のひかりTVは番組を視聴している間ずっとマルチキャストを転送し続けますが、PanasonicのプライベートビエラなどのPortableTVなどは最初だけマルチキャストで接続を確認した後はユニキャストになります。</p>\n<blockquote>\n<p>Panasonic プライベートビエラ<br> <a href=\"https://panasonic.jp/privateviera/\">https://panasonic.jp/privateviera/</a></p>\n</blockquote>\n</li>\n<li><p>UPnpの停止<br>Universal plug and playの機能でホームゲートウェイなど光回線に接続する機器には装備されている機能です。インターネットからLAN内の機器に接続する仕組みです。これは過去から脆弱性攻撃に利用されやすいものですので明確に必要としていない場合はこの機能を停止する事をお勧めします。</p>\n</li>\n</ol>\n<h2 id=\"（2）パスワード管理ソフトの導入\"><a href=\"#（2）パスワード管理ソフトの導入\" class=\"headerlink\" title=\"（2）パスワード管理ソフトの導入\"></a>（2）パスワード管理ソフトの導入</h2><p>無線ルーターの設定では、機器にログインするためのIDとSSIDに対するパスワード（暗号キー）を必ず変更して下さい。Wi-Fiに入られない限り安全だろうという理由で、無線ルーターのパスワードが短かったり単純なものは危険です。悪意のあるスマホアプリからWi-Fiを経由し、簡単に無線ルーターの乗っ取りが可能です。個人的にはパスワード管理ソフトとして、米国の<strong>bitwarden</strong>がお勧めです。</p>\n<blockquote>\n<p>bitwarden<br> <a href=\"https://bitwarden.com/\">https://bitwarden.com/</a></p>\n</blockquote>\n<ul>\n<li>パスワードの自動生成が可能</li>\n<li>Windows、macOS、iOS、Androidに対応</li>\n<li>スマホは指紋認証（Touch ID）や顔認証（Face ID）に対応</li>\n<li>主要ブラウザに対応</li>\n<li>サイトのURLに反応しID、パスワードを自動入力可能（フィッシング対策としても有効）</li>\n<li>無償（有償オプションもあるが無償でも十分利用可能）</li>\n<li>暗号化に関する部分のソースコードが公開されている</li>\n<li>日本語対応</li>\n</ul>\n<p>パスワードの使い回しが良くない事と理解しつつも、少しだけ変えた似たようなパスワードを使い、しかも忘れてしまいパスワードの再作成というのはよく経験する事でないでしょうか。ブラウザからでもオートコンプリートで一発入力なので非常に快適です。クラウド上にパスワードを置くのが怖いという考え方もありますが、2要素認証の標準化により、昔ほどパスワード漏洩が脅威では無くなりつつあります。何よりパスワードの使い回しより遥かに安全です。私は本当に重要なサイト、2要素認証アプリのパスワードを除き、bitwardenでランダムに生成した13桁程度の文字列をパスワードに利用し、全てbitwarden任せです。詳細は「<a href=\"/new-technology/2020/08/30/bitwarden/\" title=\"パスワード管理ソフトのbitwardenを活用する\">パスワード管理ソフトのbitwardenを活用する</a>」を参照してください。</p>\n<h2 id=\"（3）セキュリティ対策ソフトの導入\"><a href=\"#（3）セキュリティ対策ソフトの導入\" class=\"headerlink\" title=\"（3）セキュリティ対策ソフトの導入\"></a>（3）セキュリティ対策ソフトの導入</h2><p>Windowsをお使いの方であれば、WindowsDefenderがありますから敢えて別のウィルス対策ソフトを購入する必要はありません。ただ付加機能として、有名どころのNortonやカスペルスキーなどでは、個人PCのカメラを意図して使われないようにコントロールできる機能を持っています。リモートワークでのTV会議の風景を録画されてしまう事の対策として利用を検討してみて下さい。個人的には多少ITスキルを要求しますが、ルーマニアのBitdefender SRL社が提供する<strong>bitdefender</strong>をお勧めします。私は、Windows、macOSなど複数の端末を持っているため、”トータルセキュリティ2020”という製品を利用しています。ちょっとだけ微妙な日本語はご愛嬌ですが、よりプライバシーに配慮したセキュリティ対策ソフトです。彼らのプライバシーポリシーはとても丁寧に記述されている事、どのソフトが通信しているかコントロールしやすい（かといって煩雑すぎもしない絶妙なバランス）点が挙げられます。カメラのコントロール、マイクを使うタイミングでのアラート機能が装備されています。こちらは有償のソフトウェアですが、対応している機能からすれば非常に安価です。</p>\n<blockquote>\n<p>bitdefender<br> <a href=\"https://www.bitdefender.com/\">https://www.bitdefender.com/</a></p>\n</blockquote>\n<p>macOS、Linuxでも「ウィルス対策ソフトは本当に必要か？」という議論を見かけますがほとんどのケースで必要と考えています。対策ソフトで完璧に防ぐ事は困難ですが、自身の不注意から最悪のシナリオに繋がるケースから守ってくれる事もあります。「全てのOS、利用しているアプリケーションの脆弱性に伴うパッチを公開初日に確実に適用する自信がある」かつ「信頼できない未確認のサイトにアクセスしない」とわかっている場合のみウィルス対策ソフトは不要です（パッチ未公開の攻撃はホームユーザーにとって防御が困難です）。IoTはウィルス対策ソフトが導入できない代わりに「パッチの自動更新が必須」でありインターネットへアクセス可能な範囲を絞るべきです。<br>ウィルス対策ソフトで確実に防御できるわけではありません。対策ソフトにも優劣がありますし限界があります。申し上げたいのは稼働させられるウィルス対策ソフトを使っていなかった、つまり<strong>本人の過失</strong>とならないように稼働させる事をお勧めするものです。</p>\n<p>では、WindowsDefenderを導入しておけば絶対安全か？と言われればそうではありません。デフォルトでWindowsにインストールされているウィルス対策ソフトで防御されてしまうレベルの攻撃では全く意味がない事を攻撃者は理解しているからです。繰り返しになりますがウィルス対策ソフトは稼働させた上でデータのバックアップや頻繁なパッチ適用をお勧めします。</p>\n<p>また、音声で留意する点は、Google Home、Apple HomePod、Amazon Echo（Alexa）の存在です。これはどのタイミングで音声をキャプチャされているか分かりませんので十分気を付ける必要があります。</p>\n<h2 id=\"（4）ネットワークチェックツールの利用\"><a href=\"#（4）ネットワークチェックツールの利用\" class=\"headerlink\" title=\"（4）ネットワークチェックツールの利用\"></a>（4）ネットワークチェックツールの利用</h2><h3 id=\"簡易なネットワーク脆弱性チェック\"><a href=\"#簡易なネットワーク脆弱性チェック\" class=\"headerlink\" title=\"簡易なネットワーク脆弱性チェック\"></a>簡易なネットワーク脆弱性チェック</h3><p>上述したbitdefender社から、<strong>Home Scanner</strong>という無償ツールが公開されています。これは彼らの製品であるbitdefender BOXと呼ばれるFirewallを売るためのチェックツールでもあります。ネットワーク上の端末やIoT機器に脆弱性のリスクがあると警告してくれます。実際の対策内容は”bitdefender BOXの導入を”となるわけですが、私の環境ですと、きちんとファームウェアの更新された無線機器1台とQNAPのhttpで脆弱性ありとの診断結果でした。QNAPではhttpを使っており、httpsに強制リダイレクトされるデザインなのですが、どういう点での脆弱性の可能性を指摘しているのかは一切不明で実態の把握しようがありませんでした。初級者〜中級者向けにはこのツールを使い、まずは当該機器のファームウェア更新の有無を確認するために活用できるでしょう。また、忘れがちのIoT機器に気づくきっかけとなります。前述した「家庭内で安全快適に在宅勤務を行うためのリファレンスガイド」ではトレンドマイクロ社の「オンラインスキャンfor Home Network」が紹介されています。これは家庭向けIDS(Intrusion Detection System)といったところの機能です。仕組み上、ネットワーク全体の速度としての遅延が発生しますので、このブログでお勧めしている <a href=\"/new-technology/2020/02/23/XG-Firewall/\" title=\"Sophos Firewallの導入\">Sophos Firewallの導入</a> ほど手間を掛けられないが安心は得たいという事であれば検討してみる価値はあります。</p>\n<blockquote>\n<p>bitdefender Home Scanner<br> <a href=\"https://www.bitdefender.com/solutions/home-scanner.html\">https://www.bitdefender.com/solutions/home-scanner.html</a></p>\n</blockquote>\n<h3 id=\"脆弱性検証ツール「Nessus」\"><a href=\"#脆弱性検証ツール「Nessus」\" class=\"headerlink\" title=\"脆弱性検証ツール「Nessus」\"></a>脆弱性検証ツール「Nessus」</h3><p>上級者向けには、ビジネスでは有名どころのTenable社の<strong>Nessus</strong>が候補に挙げられます。Nessusは16IPを上限に検査できるNessus Essential（無償）が提供されています。しょっちゅう稼働させるプロダクトではありませんので、ノートPCにインストールしておき、普段はサービスを停止させておくと便利です。前出のNASのQNAPに対しNessusのBasicスキャンをかけてみると<del>リスク＝Mediumとして、アクセス権がなくともNFSのディレクトリ名が参照可能（これは許容）の結果でした。</del> <sup><strong><a href=\"#note1\">[1]</a></strong></sup>、 Windowsで利用しているSMB（Port445）については、送受信するデータに署名が行われていないので中間者攻撃が可能（リスク＝Medium）との結果でした。対策が難しい場合にはある程度のリスクを受容し、NASに接続する端末を絞るなどNAS自身が持つFirewallで回避策を用意する事が有効です。</p>\n<blockquote>\n<p>Nessus<br> <a href=\"https://jp.tenable.com/products/nessus\">https://jp.tenable.com/products/nessus</a></p>\n</blockquote>\n<h3 id=\"OSのファイアーウォール設定\"><a href=\"#OSのファイアーウォール設定\" class=\"headerlink\" title=\"OSのファイアーウォール設定\"></a>OSのファイアーウォール設定</h3><p>私見ですが、自宅のネットワーク環境を安易に信頼しない事です。Windowsはパブリックネットワーク、macOSではOSが持つFirewallを有効にする事を検討してください。パブリックネットワークの設定でもプリンターは使えますし、さほど不便はありません。FirewallでSSLインスペクションが使えないIoTやAndroid端末もネットワークの他のホストとは通信させず可能な限り分離させています。もちろん絶対に通信させてはいけないという事ではなく、あらかじめ利用がわかっているものはもちろん明示的に許可をします。あくまで使わないものは遮断しておくのが安全です。私はAppleのAirDropはとても便利なので明示的に許可しています。</p>\n<p>（2020-09-30追記）<br>iOS14では設定に<mark class=\"label primary\">ローカルネットワーク</mark>という項目が追加されました。悪意のあるスマホアプリがネットワーク上の機器に不正アクセスするリスクが懸念されますが、ネットワーク内にある他の端末にアクセス可能なアプリを最低限度に抑える事ができるようになりました。こちらも是非設定される事をお勧めします。</p>\n<h2 id=\"可用性のために検討すること\"><a href=\"#可用性のために検討すること\" class=\"headerlink\" title=\"可用性のために検討すること\"></a>可用性のために検討すること</h2><p>会議の時に自宅が停電というリスクを考えると、デスクトップPCよりはノートPCのほうが可用性が高いです。また、Wi-Fiルーターが停止した場合の予備機を考えるよりは、スマホのテザリングでしのぐ方が現実的ですのであらかじめスマホとPCにそれぞれ設定される事をお勧めします。</p>\n<p><small id=\"note1\"><strong>[1]</strong><br>2020-09-04発表のQTS4.4.3.1421で解消（Fixed a vulnerability concerning world-readable NFS shared folders.）<br></small></p>\n","categories":["Security"],"tags":["Wi-Fi"]},{"title":"XG Firewall v18のルールとポリシーについて","url":"/new-technology/2020/03/14/rule-policy1/","content":"<p class=\"onepoint\">この記事で実現すること</p>\nXG Firewall v18のルールとポリシーの基本的な機能を紹介します。また、インストール後、最初から設定されているデフォルトポリシーの内容を説明します。\n<span id=\"more\"></span>\n\n<h2 id=\"ルールとポリシーの機能説明\"><a href=\"#ルールとポリシーの機能説明\" class=\"headerlink\" title=\"ルールとポリシーの機能説明\"></a>ルールとポリシーの機能説明</h2><p>この記事では、XG Firewallの具体的な設定を行います。Firewallは、TCP&#x2F;UDPのレイヤ3またはレイヤ4の制御が一般的です。httpsであればPort443、SSH（セキュアシェル）であればPort22などに対し、通過させるか拒否するかを決めます。XG Firewallはレイヤ7、つまりアプリケーションの中身を見て可否を判断する事が可能です。サイトがどういうサービスを提供しているかジャンル分けされており、好ましくないサイトには接続しないように設定が出来ます。従来の方法、例えばSSHであればPort22を止めるだけのFirewallは時代に合わなくなってきています。</p>\n<p>あやしい振る舞いをするアプリケーションの挙動を見ていると、httpsの443で繋いでみてダメだったら一般的なProxyである8080などからの接続を試み、さらにダメならPort80と続きます。次に接続ドメインを変えたりするなど、ありとあらゆる手段を使って外部との接続を試みようとします。このような問題のあるアプリケーションをインストールしない事が一番良いのですが、ファイル交換サイトへのアクセスは禁じるという設定を行う事で一定の抑止力が発揮できます。</p>\n<p>XGのインストール直後は内部”LAN”からインターネット”WAN”への接続は、初期設定として全て通します。前述したレイヤ3、レイヤ4については一切制約は掛かっていません。原則WANへの通信は通すというのが最初の状態です。逆インターネットから内部のサーバに向けた接続は行えず、1つの接続対象毎に都度ルールを作成していく事になります。</p>\n<p>左ペインのルールとポリシーを選択し、デフォルトの設定を見てみましょう。ルールグループというグループ化されたルールとデフォルトルールがあります。</p>\n<img src=\"/new-technology/2020/03/14/rule-policy1/rule_menu.png\" class=\"\" title=\"alt\">\n\n<ul>\n<li>Traffic to Internal Zone<br> Firewallの内側（内部のLANにサーバを立てる場合）にアクセスするルールを記載します。</li>\n<li>Traffic to Wan<br> インターネットにアクセスするルールを記載します。</li>\n<li>Traffic to DMZ<br> 今回は使いません。そもそもは業務上サーバを立てる場合はDMZにWebサーバやメールサーバを配置し、内部クライアントとは分離するのが業務上一般的です。今回の設定では、個人でそこまでは不要としています。</li>\n<li>Default Network Policy<br> 上から順にルールを実行してきて、全てをチェックし、最後に全てを許可するルールとなっています。一番右の（•••）マークでルールのOn&#x2F;Offをトグルで切り替えられるようになっています。</li>\n<li>すべてをドロップ<br> これは設定変更できず、視覚的に最後は全てドロップする事を示しています。</li>\n</ul>\n<h2 id=\"“Default-Network-Policy”の説明\"><a href=\"#“Default-Network-Policy”の説明\" class=\"headerlink\" title=\"“Default Network Policy”の説明\"></a>“Default Network Policy”の説明</h2><img src=\"/new-technology/2020/03/14/rule-policy1/rule1.png\" class=\"\" title=\"alt\">\n<p>このルールは「許可する」となっています。なお、「破棄する」は無応答で相手はタイムアウトを待つ事になります。「拒否する」は接続要求をAcceptせず、接続を確立させず、すぐにエラーとなります。</p>\n<img src=\"/new-technology/2020/03/14/rule-policy1/rule2.png\" class=\"\" title=\"alt\">\n<p>ここでは、LANからWANへの通信を対象としています。送信元デバイスはLANにあるクライアントを指定出来るようになっています。サービスはプロトコルの設定を行うためのものですが、Port番号の数字ではなく、「ftp」や「ntp」などサービスとして登録できます。宛先ネットワークという項目もあります。これは国を指定する事、ビルトインの”FQDNホスト”または”FQDNホストグループ”として、”Apple Services”や”Google API Hosts”など宛先サーバー指定する事が可能です。</p>\n<p>次に、アプリケーションFirewallの設定です。</p>\n<img src=\"/new-technology/2020/03/14/rule-policy1/rule3.png\" class=\"\" title=\"alt\">\n<p>レイヤ7のファイアウォールでは、データの中身を見てNGと判断すると、接続を許可しません。このために、Webポリシー&#x2F;IPS&#x2F;アプリケーションコントロールなど設定が出来るようになっています。</p>\n<p>Webポリシーは、Default Policy、Allow Allなど複数のポリシーが存在しています。サイトの属性（広告、ギャンブル、アダルト）によって拒否する事が可能です。”Allow All”は原則全てを通します。”Default Policy”は一定のリスクがあるものを対象とし、ある程度XGにお任せで制御するポリシーです。まだ初期セットアップの段階なので、ここで慌てて何かを決める必要はありません。いきなり厳しくしないのであれば、”Allow All”に一旦変更しても良いでしょう。</p>\n<p>IPSは攻撃防御としてXGにお任せで”lantowan_general”として下さい。悪意のあるサイトからの脆弱性攻撃を防御するものであり、通常の利用で不便な事はありません。アプリケーションコントロールは、使いたく無いアプリケーションを拒否するものですが、ホームユーザーにとっては危険なVPNやProxyなどを停止する用途になります。初期セットアップが終わってから改めて検証しながら設定するべきものです。初期セットアップ時は”なし”にしておくのが無難でしょう。</p>\n<p>SSL&#x2F;TLSインスペクションの機能について補足します。v18では以下のオプションは利用しません。</p>\n<ul>\n<li>DPIエンジンでなくWEBプロキシを使用する</li>\n<li>Webプロキシでのフィルタリング中にHTTPSを復号化する</li>\n</ul>\n<p>これは前バージョンのv17まではPort443のみをProxyとしてhttpsの解析を行っていました。v18の目玉機能であるDPIエンジンはPortに依存しないため、複数Portを検査できる方法、つまりWEBプロキシは利用しない事が前提になります。SSL&#x2F;TLSインスペクションの詳しい説明については、「<a href=\"/new-technology/2020/03/20/ssl-inspection/\" title=\"SSLインスペクションについて\">SSLインスペクションについて</a>」を参照してください。</p>\n<p>ここまで、”Default Network Policy”について設定されている内容を説明しました。もちろんこのルールを修正する事は可能ですが、このデフォルトルールは最後のルールとし、それより優先度の高い”上部に位置する”ルールを追加していくのが通常です。”上部に位置するルール”で許可するものを細かく設定し、最後のルールは”拒否”にする方法ももちろん可能です（業務系ファイアウォールは原則拒否で、必要なもののみ許可設定を行います）。</p>\n<h2 id=\"ファイアウォールルールの組み立て方\"><a href=\"#ファイアウォールルールの組み立て方\" class=\"headerlink\" title=\"ファイアウォールルールの組み立て方\"></a>ファイアウォールルールの組み立て方</h2><p>上記で説明してきた通り、レイヤ7のファイアウォールはHTTPSプロトコルを通すという前提で、コンテンツの中身についてどのように制御するかを設定していく事になります。最初から存在しているDefault Network Policyはいくつもの上位ルールを通り抜けてきて最後に処理するルールです。以下にXGで対応可能なファイアウォールルールの組み立て方の一例について記載します。これは端末ごとにルールを決めていくやり方で、比較的シンプルな方法です。基本的に上位のルールはより絞り、下位のルールは甘めになります。</p>\n<ol>\n<li>不要国のアクセスは拒否</li>\n<li>IoT機器の利用プロトコル、接続先を制限するルール</li>\n<li>サーバー用途端末のルール。WANに対してhttp&#x2F;https&#x2F;ntpの接続のみ</li>\n<li>子供の端末向けの好ましく無いジャンルの禁止ルール</li>\n<li>SSLインスペクションを行えないクライアント向けルール（プロトコル制限）</li>\n<li>SSLインスペクションを行える一般端末のルール（やや緩めでプロトコル制限無し）</li>\n<li>Default Network Policy（全て許可）、または全て拒否</li>\n</ol>\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"Withings ScanWatch","url":"/new-technology/2021/04/26/scanwatch/","content":"<img src=\"/new-technology/2021/04/26/scanwatch/subhero-ca-jp.png\" class=\"\" title=\"alt\">\n\n<h2 id=\"WithingsのスマートウォッチScanWatch\"><a href=\"#WithingsのスマートウォッチScanWatch\" class=\"headerlink\" title=\"WithingsのスマートウォッチScanWatch\"></a>WithingsのスマートウォッチScanWatch</h2><p>WithingsのScanWatchはスマートウォッチというには、ITっぽくない、お洒落な時計です。落ち着いた文字盤で、ぱっと見は全くスマートウォッチには見えません。サファイアガラス、38mm、42mmの2つのサイズが用意されており、とてもお洒落な時計です。電池持ちは公称では30日という事です。設定によりますが、実稼働でも20日は持ち、充電の煩雑さは全くありません。5気圧防水で日常で使いやすいものです。2021年9月よりSPO2の計測に対応しました。</p>\n<span id=\"more\"></span>\n\n<h2 id=\"時計がお好きな方にお勧めです\"><a href=\"#時計がお好きな方にお勧めです\" class=\"headerlink\" title=\"時計がお好きな方にお勧めです\"></a>時計がお好きな方にお勧めです</h2><p>「<a href=\"/new-technology/2020/11/28/miband5/\" title=\"MIスマートバンド5を活用する\">MIスマートバンド5を活用する</a>」で紹介したスマートバンドとは全く異なる、どちらかといえばビジネスシーンを中心にカジュアルなエクササイズにも使える時計です。腕の細い人が多い日本人には38mmが合うと思いますが、若い方であれば42mmも素敵です。いかにもスマートウォッチというものでなく、多分言われないと気づかない品の良さを兼ね備えています。控えめながら機能美を持つこの時計は魅力的です。私の場合、休日・テレワークではもっぱらMI Bandですが、出社する時、ジャケットを着る場合、最近は殆どScanWatchです。おかげで他の時計は殆ど着けなくなってしまいました。</p>\n<h2 id=\"ScanWatchの機能\"><a href=\"#ScanWatchの機能\" class=\"headerlink\" title=\"ScanWatchの機能\"></a>ScanWatchの機能</h2><ul>\n<li>心拍数モニタリング</li>\n<li>睡眠中の呼吸の乱れを追跡</li>\n<li>アクティビティ自動検出、記録</li>\n<li>GPS接続機能（スマホとの接続）</li>\n<li>睡眠サイクル、睡眠スコア、SmartWake-up</li>\n<li>スマホ通知</li>\n<li>HEALTH MATEアプリとの連携</li>\n<li>アスリート御用達STRAVA連携</li>\n</ul>\n<p>これらの機能はスマートウォッチとしての基本を押さえています。</p>\n<h2 id=\"機能美\"><a href=\"#機能美\" class=\"headerlink\" title=\"機能美\"></a>機能美</h2><p>下の写真はScanWatchの盤面ですが、小さい赤い針は何だと思いますか？クロノグラフのように秒針があるわけではないですし。</p>\n<img src=\"/new-technology/2021/04/26/scanwatch/sw.png\" class=\"\" width=\"360\" title=\"alt\">\n\n<p>ScanWatchでは1日における自身の目標歩数に対する達成率（針が1周すると100％達成）なんです。<br>ここを敢えてアナログにしているところにとてもスマートさを感じます。</p>\n<h2 id=\"SPO2\"><a href=\"#SPO2\" class=\"headerlink\" title=\"SPO2\"></a>SPO2</h2><p>2021年9月にScanWatchはSPO2に対応しました。計測の様子は以下になります。</p>\n<video src=\"ar.mov\" preload=\"metadata\" controlslist=\"nodownload\" controls playsinline poster=\"\"></video>\n\n<p>数分後にパルスオキシメーターでSPO2を計測してみました。ScanWatchと近い値が出ています。</p>\n<img src=\"/new-technology/2021/04/26/scanwatch/spo2.png\" class=\"\" width=\"360\" title=\"alt\">\n\n<p>体調不良時にどのように違いが出てくるのかという確認は難しいのですが、後述する睡眠時のチェックは有用です。</p>\n<p>日本では医療関連の認可が厳しいという理由で「心電図」測定機能が今のところロックされています。</p>\n<h2 id=\"Health-Mateアプリ\"><a href=\"#Health-Mateアプリ\" class=\"headerlink\" title=\"Health Mateアプリ\"></a>Health Mateアプリ</h2><p>Health Mateはフィットネス、健康管理の総合アプリという位置付けです。Withingsは体重計や血圧計、体温計など様々なヘルスケア製品を販売していますが、これらを統合的に管理するのがHealth Mateです。ScanWatchはbluetoothでスマホアプリと接続され、Withingsのクラウド上にパーソナルデータとして管理されます。私はWithingsの体重計も愛用していますが、Wi-fiに一瞬接続してクラウド上にデータを更新してくれますので、体重計に乗るときスマホを操作する必要はありません。ScanWatchも一度スマホと接続が必要ですが、一旦ペアリングしたあとは殆どIT機器として意識する事はありません。</p>\n<p>後述する、呼吸スキャンはバッテリーを多く消費してしまいますが、通常の利用であれば電池持ちを気にする事は殆どありません。電池持ちにも徹底して拘り、時計はシンプルに時計としての使い勝手を、多機能な健康に関する分析機能はスマホアプリで。切り分けが明快です。</p>\n<h2 id=\"睡眠中の呼吸の乱れを追跡\"><a href=\"#睡眠中の呼吸の乱れを追跡\" class=\"headerlink\" title=\"睡眠中の呼吸の乱れを追跡\"></a>睡眠中の呼吸の乱れを追跡</h2><p>呼吸スキャンは月に1度を目安に実行するものです。</p>\n<img src=\"/new-technology/2021/04/26/scanwatch/IMG_2240.PNG\" class=\"\" width=\"480\" title=\"alt\">\n\n<p>睡眠呼吸障害を検知というほど、医療向けに作られているデバイスではありませんが、客観的な情報を得られます。ストレスも多い現代ですから、なかなか夜ぐっすり眠るというのは難しいでしょうし、お酒を飲み過ぎた場合や体調がすぐれない場合も客観的なデータで確認できます。</p>\n<p>SPO2の計測が可能となり、睡眠中のSPO2を定期的に計測できるようになりました。</p>\n<img src=\"/new-technology/2021/04/26/scanwatch/hm-spo2.png\" class=\"\" width=\"480\" title=\"alt\">\n\n<p>睡眠時無呼吸症候群（SAS）の確認として睡眠中にもSPO2を定期的に計測してくれるのはありがたいですね。</p>\n<h2 id=\"アクティビティ自動検出\"><a href=\"#アクティビティ自動検出\" class=\"headerlink\" title=\"アクティビティ自動検出\"></a>アクティビティ自動検出</h2><p>ウォーキングは操作する事が不要で、時計を着けているだけです。WithingsのWebでは、「ScanWatchを付けるだけでを歩くことや走ること、または泳ぐことで自動的にアクティビティを記録します」とあります。</p>\n<ul>\n<li>ウォーキング</li>\n<li>ランニング</li>\n<li>サイクリング</li>\n<li>テニス</li>\n<li>卓球</li>\n<li>スカッシュ</li>\n<li>バドミントン</li>\n<li>ボディビル</li>\n<li>バスケットボール</li>\n<li>サッカー</li>\n<li>バレーボール</li>\n<li>ダンス</li>\n<li>ボクシング</li>\n</ul>\n<p>ボディビルってどうやって検知するんでしょうね<span class=\"github-emoji\" alias=\"grin\" style=\"\" fallback-src=\"https://github.githubassets.com/images/icons/emoji/unicode/1f601.png?v8\">&#x1f601;</span>。ちなみに、ScanWatchを着けてゴルフをしても、普通のウォーキング扱いになる事もあります。ランニングも何となくランニングの計測をスタートしてから（竜頭を長押しで開始します）走り始めるのとそれが手間でもないので私の場合自動計測はあまり意味が無いようです。いろいろなスポーツをされる方は便利な機能になりますね。</p>\n<h2 id=\"アクティビティの記録\"><a href=\"#アクティビティの記録\" class=\"headerlink\" title=\"アクティビティの記録\"></a>アクティビティの記録</h2><p>ランニングの記録はアプリで以下のように表示できます。</p>\n<img src=\"/new-technology/2021/04/26/scanwatch/sw2.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<p>走ったコース、心拍数の推移と運動強度、こちらも年齢などから自動的に中程度、激しい、ピークと分類してくれます。ダイエットを考えた場合に、心拍数とゾーンの関係についての詳細な説明は、以下の記事がわかりやすいですが、以下の簡易的な計算で求められます。</p>\n<blockquote>\n<p>体脂肪が効率よく燃える有酸素運動の適切な心拍数について、計算式から徹底解説<br> <a href=\"https://earnest.fit/intensity-aerobic-exercise/\">https://earnest.fit/intensity-aerobic-exercise/</a></p>\n</blockquote>\n<blockquote>\n<p>運動時の心拍数が最大心拍数の50〜70%の範囲になると、ファットバーンゾーンに突入して体脂肪の燃焼効果が高まることが分かっており、これは体感的には少しきつめの運動になります。これよりも軽い負荷で運動をしても、消費カロリーがあまり増えないため体脂肪の燃焼効果も良くありません。<br>また、前述したようにこれ以上の心拍数になる激しい運動をすると、有酸素運動自体の効果は高まっても体脂肪の燃焼効果は下がります。</p>\n</blockquote>\n<blockquote>\n<p>目標心拍数＝(220−年齢）×0.5〜0.7<br>30歳の場合は（220−30)×0.5〜0.7＝95〜133</p>\n</blockquote>\n<p>これは個人差がありますが、Health Mateの心拍数ゾーンの<mark class=\"label primary\">激しい</mark>というのが、ファットバーンゾーンに該当する事になるでしょうか。</p>\n<p>また、ランニングのペースは詳細画面から確認します。</p>\n<img src=\"/new-technology/2021/04/26/scanwatch/IMG_2236.PNG\" class=\"\" width=\"480\" title=\"alt\">\n\n<p>内容的にはアスリート向けという事はなく、健康に気を遣う方のライフログとしては十分なレベルを目指したというところかと思います。走っている最中はスマホの画面はいちいち見ていられませんから、ScanWatchに時々目をやるようにしてペース配分を確認します。ワークアウト中はScanWatchのディスプレイを常にOnにする設定があり、この設定をお勧めします。kmあたりのペースや心拍数を把握できるので上記のように、例えば、6分半のペースで走ろうとした時にはそれなりにバランスを取りながら一定のペースで走る事ができます。</p>\n<h3 id=\"健康レベル\"><a href=\"#健康レベル\" class=\"headerlink\" title=\"健康レベル\"></a>健康レベル</h3><p>Health Mateには、健康レベルという評価数値があります。これは以下のデータを元に算出します。</p>\n<blockquote>\n<p>当社の健康レベル評価は、いくつかの要因に基づいて計算されます。最も重要なものには、心拍数、年齢、性別、体重などがあり、これらはランニングセッション中にScanWatchで追跡されたGPSデータと組み合わせられます。その後健康レベルは、あなたの心拍数とペースを比較して推定されます。</p>\n</blockquote>\n<p>詳細については、Withingsのサイトを参照してください。</p>\n<blockquote>\n<p>健康レベルに関するよくあるご質問<br> <a href=\"https://support.withings.com/hc/ja/articles/360010120778-ScanWatch-%E5%81%A5%E5%BA%B7%E3%83%AC%E3%83%99%E3%83%AB%E3%81%AB%E9%96%A2%E3%81%99%E3%82%8B%E3%82%88%E3%81%8F%E3%81%82%E3%82%8B%E3%81%94%E8%B3%AA%E5%95%8F\">https://support.withings.com/hc/ja/articles/360010120778-ScanWatch-健康レベルに関するよくあるご質問</a></p>\n</blockquote>\n<p>このScanWatchはITっぽさを感じず、それ故に物足りなさを感じる方もいらっしゃるかもしれませんが、逆にスマートウォッチっぽくなく、むしろ古典的な時計に見えるようで、「それ、どこの時計？」と良く聞かれます。ITに特段詳しく無い方でも時計として使う分には全く難しいものではありませんし、大切な方へのプレゼントにも良いかもしれませんね。</p>\n","categories":["SmartWatch"],"tags":["scanwatch"]},{"title":"XG Firewall v18のルールを作成する","url":"/new-technology/2020/03/14/rule-policy2/","content":"<p class=\"onepoint\">この記事で実現すること</p>\nXG Firewall v18を使ったインターネットアクセスのための、デフォルトのルールを作成します。この際にリスクの大きい通信を止めたり、Webのポリシー（閲覧が好ましくないサイト）の設定ができるようになります。また、v18のNATについて説明します。\n<span id=\"more\"></span>\n\n<h2 id=\"Traffic-to-Wanルールの作成\"><a href=\"#Traffic-to-Wanルールの作成\" class=\"headerlink\" title=\"Traffic to Wanルールの作成\"></a>Traffic to Wanルールの作成</h2><p>いよいよ、実際の基本的なルールを作成します。ルールとポリシーのメニューから、<mark class=\"label primary\">ファイアウォールルールの追加</mark>ボタンを押し、”新しいファイアウォールルール”を選択します。ルール名にはここでは”To_Internet”とします。ルールグループは”自動”のままで構いません。アクションは”許可する”のままです。ファイアウォールのログは出力するようにチェックしておきます。現時点で”選択した条件に一致しないため、ルールを既存のグループに追加できません”との表示がありますが、その下のルール設定に進みます。</p>\n<img src=\"/new-technology/2020/03/14/rule-policy2/rule1.png\" class=\"\" title=\"alt\">\n\n<p> 送信元ゾーンには、”LAN”を設定します。今後、VPNを使う方は”VPN”も加えてください。宛先ゾーンは”WAN”を指定します。その他は変更しません。これを設定した段階で上部に表示されていた注意メッセージが”このルールは自動的にルールグループTraffic to WANに追加されます”という表記に変わります。</p>\n<p> 続いて、アプリケーションファイアウォールの設定です。</p>\n<img src=\"/new-technology/2020/03/14/rule-policy2/rule2.png\" class=\"\" title=\"alt\">\n\n<p>セキュリティ機能の<mark class=\"label primary\">Webフィルタリング</mark>をクリックし、詳細メニューをオープンします。今回は基本的なルール追加の説明としてスタンダードな内容を設定します。</p>\n<ul>\n<li>Webポリシーは”Default Policy”を選択します</li>\n<li>“HTTPおよび復号化したHTTPSをスキャン”をチェックします</li>\n<li>“FTPのマルウェアをスキャン”をチェックします</li>\n<li>QUICプロトコルのブロックは任意選択です<br> Googleのサービスで利用されています。私はチェックしています。Google自体は問題ないですがそのプロトコルを利用した悪質なサイトがFirewallを回避するリスクを減らすという意味で選択しています</li>\n<li>その他のセキュリティ機能でアプリケーションコントロールを選択します<br> 最もリスクが高いアプリケーションを拒否する”Block very high risk(Risk Level 5) apps”を選択します</li>\n<li>IPSは一般的なルール”lantowan_general”を選択します</li>\n</ul>\n<p>保存ボタンをクリックするとルールの追加が行われます。Webポリシーが”Default Policy”で広告が禁止されていればブラウザではエラー画面が表示されます。またサイトのカテゴリ（ギャンブル、アダルト）などもDefault Policyの設定内容によって、どのようにアクセスが止まるのか確認をしてください。XG画面の右上に<mark class=\"label primary\">ログビューア</mark>があるので、”ファイアウォールルール”、”アプリケーションフィルタ”、”Webフィルタ”のログを確認してください。許可・拒否のログを確認しながら、さらに新しいルールを加えるなど、カスタマイズを進めてください。Webフィルタについての解説は、「<a href=\"/new-technology/2020/03/14/customize-policy/\" title=\"XG Firewall v18のポリシーをカスタマイズする\">XG Firewall v18のポリシーをカスタマイズする</a>」、「<a href=\"/new-technology/2020/05/06/web-application-filter/\" title=\"XG FirewallのWebとアプリケーションフィルタについて\">XG FirewallのWebとアプリケーションフィルタについて</a>」を参照してください。なお、SSL&#x2F;TLSインスペクションの設定が有効になるまでは、アプリケーションフィルタやWebフィルタも完全には動作しません。Windows、macOS、iOSにはSSL&#x2F;TLSインスペクションを設定される事をお勧めします。SSL&#x2F;TLSインスペクションについては「<a href=\"/new-technology/2020/03/20/ssl-inspection/\" title=\"SSLインスペクションについて\">SSLインスペクションについて</a>」を参照してください。</p>\n<h2 id=\"宛先ネットワークの留意点\"><a href=\"#宛先ネットワークの留意点\" class=\"headerlink\" title=\"宛先ネットワークの留意点\"></a>宛先ネットワークの留意点</h2><p>宛先ネットワークの指定は、ドメインで絞るなど使い方によっては非常に便利です。しかし、昨今では目的のサービスがAWS上にホストされていたりCDN（Content Delivery Network）に登録されているケースもあり、ドメインで絞る事が難しい場合もあります。FirewallのログにはIPアドレスが表示されていても、どのドメインに対してのアクセスなのかは判別が難しく少し煩雑な対応を必要とするケースがあります。</p>\n<h2 id=\"3つのルール\"><a href=\"#3つのルール\" class=\"headerlink\" title=\"3つのルール\"></a>3つのルール</h2><p>ルールとポリシーのメニューには、”ファイアウォールルール”と”SSL&#x2F;TLSインスペクションルール”、NATに関する”NATルール”の3つの設定があります。最初からビルトインされている”Default SNAT IPv4”というNATルールは、プライベートIPアドレスからWANへ出ていく時に、パブリックIPへと変換するためのNATの仕組みが記述されています。具体的には、NATルールの<mark class=\"label primary\">インターフェースの一致条件</mark>において、”Port2”から出ていくパケットはSNATの”MASQ”が必要と記述されています。</p>\n<p>XG v17まではファイアウォールのルール1つ1つに対して、NATを行うか否かを設定していました。v18では、ファイアウォールルールとNATルールとは切り離されました。v18ではLANからWAN、VPNからWANなどのインタフェースやIPアドレス単位でNATの設定を行います。v17からv18にバージョンアップした際はマイグレーションプロセスによって、ファイアウォールルールとリンクされたNATが1つづつ作成されます。ホームユーザーにおいては、よほど複雑な環境でなければNATのルールはVPN+LANからWANへの1つで十分です。</p>\n<h3 id=\"3つのルールの関係\"><a href=\"#3つのルールの関係\" class=\"headerlink\" title=\"3つのルールの関係\"></a>3つのルールの関係</h3><table>\n<thead>\n<tr>\n<th>ルール</th>\n<th>内容</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>ファイアウォール</td>\n<td>インタフェース、接続元ホスト、接続先ホスト、プロトコル単位に許可、拒否のルールを決定します。今回は”To Internet”というLAN（VPN）からWANに対して全てのトラフィックを通過させるルールを追加しました。</td>\n</tr>\n<tr>\n<td>NAT</td>\n<td>インターフェース、IPアドレス単位にNATを行うか否かを決定します。最初からNATルール”Default SNAT IPv4”が登録されており、WANから出ていくトラフィックはファイアウォールルールの種類に関わらず、原則NATされます。</td>\n</tr>\n<tr>\n<td>SSL&#x2F;TLSインスペクション</td>\n<td>SSL&#x2F;TLSインスペクションを行う端末か対象外の端末かを決定します。TLSの低いバージョンを除外する仕組みを持ちます。また検査除外するドメインも指定可能です。</td>\n</tr>\n</tbody></table>\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"SFP+の2.5GbE対応","url":"/new-technology/2022/07/30/sfp-plus-nbaset/","content":"<p class=\"onepoint\">この記事で実現すること</p>\n\n<p>スイッチングハブのSFP&#x2F;SFP+ポートは2.5Gbps&#x2F;5Gbpsに対応していない製品が多いです。元々、10GBase-T&#x2F;1000Base-Tなどもスイッチに対し無理やり10G Base-SRのように見せかけて動作させており、SFPの世界にはNBase-Tが一般的に存在しません。ビジネス向けスイッチではそもそもの対応がされていない製品も多く、ホームユーザー向けもSFPがあまり一般的ではないことから2.5GbEのサポートは普及していません。しかしながら対応モジュールを組み合わせることで回避することは可能です。</p>\n<span id=\"more\"></span>\n\n<h2 id=\"SFP-スイッチの2-5Gbpsサポート\"><a href=\"#SFP-スイッチの2-5Gbpsサポート\" class=\"headerlink\" title=\"SFP+スイッチの2.5Gbpsサポート\"></a>SFP+スイッチの2.5Gbpsサポート</h2><p>一般的なSFP＋スイッチは1G&#x2F;10Gのみのインタフェースとなります。また、10GBase-Tモジュールでは「ASF-10G-T」という型番のSFP＋モジュールが一般的に良く知られています。日本のAmazonだと10GTek、ipolexの取り扱いがあります。これは内部のチップにMarvell社の88X3310が使われています。これはNBase-Tに対応したチップが使われており、スイッチ側をオートネゴシエーションにしておくとスイッチ上は10Gと認識していますが、端末側の速度に合わせ2.5G、100Base-TXもリンクアップします。</p>\n<p>必ずしも全てのモジュールがオートネゴシエーションでリンクアップするわけではありません。例えば、Broadcomチップで80m対応の省電力モジュール「Cisco SFP-10G-T-80互換」は<strong>2.5GbEに対応したスイッチ</strong>で2.5GbEと認識し正しく通信できますが、オートネゴシエーションモードではリンクアップしません。10GBase-Tで慣れている方はNBase-T対応が当然でもあり、少し違和感があるのでは無いでしょうか。</p>\n<p>SFPモジュールの2.5Gbps対応状況について、まずは結論です。</p>\n<table>\n<thead>\n<tr>\n<th>10GBase-Tモジュール</th>\n<th>メーカー</th>\n<th>2.5GbE速度</th>\n<th>2.5GbEオートネゴ</th>\n<th>発熱</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>ASF-10G-T</td>\n<td>ipolex,10GTek</td>\n<td>×</td>\n<td>◯</td>\n<td>◯</td>\n</tr>\n<tr>\n<td>Cisco SFP-10G-T-80互換</td>\n<td>各社</td>\n<td>◯</td>\n<td>×</td>\n<td>◯</td>\n</tr>\n<tr>\n<td>2.5GBase-Tモジュール</td>\n<td>FSなど各社</td>\n<td>◯</td>\n<td>×</td>\n<td>◎</td>\n</tr>\n<tr>\n<td>S+RJ10</td>\n<td>MikroTik</td>\n<td>◯</td>\n<td>◯</td>\n<td>×</td>\n</tr>\n<tr>\n<td>Aquantiaモジュール</td>\n<td>Supermicro,FS</td>\n<td>◯</td>\n<td>◯</td>\n<td>◯</td>\n</tr>\n</tbody></table>\n<p>スイッチのPortをオートネゴ（10gbps）とし、モジュール側で2.5GbEをサポートする場合の制限は2つあります。1つ目は熱の問題で、2.5Gや100Baseであってもチップ自身は10Gbpsですから、消費電力および発熱量は高くなります。<br>2つ目は相手を2.5Gbpsと認識しているのはモジュール内部のチップだけであり、スイッチはその事実を全く知らないため、10Gbpsの速度でスイッチからSFP+モジュールに対してデータ送信します。このためSFP+モジュールはキャパオーバーとなり、データバッファが溢れ、データ再送が繰り返される事になります。つまり、一般的によく出回っているASF-10G-T（Marvell社の88X3310チップ）は2.5GbEとしては全く実用的ではありません。</p>\n<p>実際に問題となるケースを説明します。クライアントは2.5GBase-Tを持つWindows10で10GBase-TのSFPモジュールを使いSFP＋スイッチにオートネゴモードで接続されています。サーバーはUbuntu20で10GbpsのSFP+DACケーブルで同じスイッチに接続されています。サーバーからデータをダウンロード、アップロードすることを想定し、iperf3を実行します。</p>\n<img src=\"/new-technology/2022/07/30/sfp-plus-nbaset/nbase-t.drawio.png\" class=\"\" width=\"640\" title=\"alt\">\n\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># クライアントで実行：上り</span></span><br><span class=\"line\"></span><br><span class=\"line\">C:\\Users\\yoshi&gt;iperf3 -c 192.168.x.181</span><br><span class=\"line\">Connecting to host 192.168.x.181, port 5201</span><br><span class=\"line\">[  4] <span class=\"built_in\">local</span> 192.168.x.164 port 62653 connected to 192.168.x.181 port 5201</span><br><span class=\"line\">[ ID] Interval           Transfer     Bandwidth</span><br><span class=\"line\">[  4]   0.00-1.00   sec   283 MBytes  2.37 Gbits/sec</span><br><span class=\"line\">[  4]   1.00-2.00   sec   282 MBytes  2.37 Gbits/sec</span><br><span class=\"line\">[  4]   2.00-3.00   sec   282 MBytes  2.37 Gbits/sec</span><br><span class=\"line\">[  4]   3.00-4.00   sec   283 MBytes  2.37 Gbits/sec</span><br><span class=\"line\">[  4]   4.00-5.00   sec   282 MBytes  2.37 Gbits/sec</span><br><span class=\"line\">[  4]   5.00-6.00   sec   282 MBytes  2.37 Gbits/sec</span><br><span class=\"line\">[  4]   6.00-7.00   sec   281 MBytes  2.36 Gbits/sec</span><br><span class=\"line\">[  4]   7.00-8.00   sec   282 MBytes  2.37 Gbits/sec</span><br><span class=\"line\">[  4]   8.00-9.00   sec   282 MBytes  2.37 Gbits/sec</span><br><span class=\"line\">[  4]   9.00-10.00  sec   282 MBytes  2.37 Gbits/sec</span><br><span class=\"line\">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class=\"line\">[ ID] Interval           Transfer     Bandwidth</span><br><span class=\"line\">[  4]   0.00-10.00  sec  2.76 GBytes  2.37 Gbits/sec                  sender</span><br><span class=\"line\">[  4]   0.00-10.00  sec  2.76 GBytes  2.37 Gbits/sec                  receiver</span><br><span class=\"line\"></span><br><span class=\"line\">iperf Done.</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># クライアントで実行：下り</span></span><br><span class=\"line\">C:\\Users\\yoshi&gt;iperf3 -c 192.168.x.181 -R</span><br><span class=\"line\">Connecting to host 192.168.x.181, port 5201</span><br><span class=\"line\">Reverse mode, remote host 192.168.x.181 is sending</span><br><span class=\"line\">[  4] <span class=\"built_in\">local</span> 192.168.x.164 port 62643 connected to 192.168.x.181 port 5201</span><br><span class=\"line\">[ ID] Interval           Transfer     Bandwidth</span><br><span class=\"line\">[  4]   0.00-1.00   sec   184 MBytes  1.54 Gbits/sec</span><br><span class=\"line\">[  4]   1.00-2.00   sec   153 MBytes  1.29 Gbits/sec</span><br><span class=\"line\">[  4]   2.00-3.00   sec   127 MBytes  1.06 Gbits/sec</span><br><span class=\"line\">[  4]   3.00-4.00   sec   121 MBytes  1.02 Gbits/sec</span><br><span class=\"line\">[  4]   4.00-5.00   sec   120 MBytes  1.01 Gbits/sec</span><br><span class=\"line\">[  4]   5.00-6.00   sec   121 MBytes  1.02 Gbits/sec</span><br><span class=\"line\">[  4]   6.00-7.00   sec   123 MBytes  1.03 Gbits/sec</span><br><span class=\"line\">[  4]   7.00-8.00   sec   121 MBytes  1.02 Gbits/sec</span><br><span class=\"line\">[  4]   8.00-9.00   sec   120 MBytes  1.00 Gbits/sec</span><br><span class=\"line\">[  4]   9.00-10.00  sec   119 MBytes  1.00 Gbits/sec</span><br><span class=\"line\">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class=\"line\">[ ID] Interval           Transfer     Bandwidth       Retr</span><br><span class=\"line\">[  4]   0.00-10.00  sec  1.28 GBytes  1.10 Gbits/sec  16710             sender</span><br><span class=\"line\">[  4]   0.00-10.00  sec  1.28 GBytes  1.10 Gbits/sec                  receiver</span><br><span class=\"line\"></span><br><span class=\"line\">iperf Done.</span><br></pre></td></tr></table></figure>\n\n<p>Windows（クライアント：2.5Gbps）からUbuntu(サーバー:10Gbps)へのアップロードは2.5Gbps相当の速度が出ていますが、Ubuntu(サーバー:10Gbps)からWindows(クライアント：2.5Gbps)にダウンロードする方向で1Gbps程度の速度に落ち込みます。ubuntuの送信リトライの数が16710と大きな数字になっています。</p>\n<p>上記のiperf3の実行結果についてクライアント側でネットワークアナライザのWireSharkを使い、下りデータをキャプチャしたものが以下のグラフです。</p>\n<p>まずは、往復遅延時間（Round trip）です。</p>\n<img src=\"/new-technology/2022/07/30/sfp-plus-nbaset/latency-ipolex.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<p>X軸が時間の経過で10秒間、Y軸が往復遅延時間です。<br>問題は2つあります。1つ目は1ms（ミリ秒）を超える遅延（青いドット）がいくつか発生しています。2つ目は0ms〜1msの間に青いドットが集約され、青い帯のように見えます。LANの通信で帯に見える場合は数百μs（マイクロ秒）のレイテンシが発生し断続的に遅延が発生しています。レイテンシが小さいなら太い実線程度であり帯のようには見えません。</p>\n<p>次に、スループットです。</p>\n<img src=\"/new-technology/2022/07/30/sfp-plus-nbaset/throughput-ipolex.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<p>X軸は時間の経過、Y軸は2つあり、茶色の実線および右の目盛りはスループットを表します。青色の点および左の目盛りは受信したデータ長を表します。<br>茶色のスループットは最初1.5Gbpsまでは上がり、その後スループットが落ち込んでいきます。グラフ上部の青い水平線はTCPのデータ1460バイトの点がプロットされたものが集まっており、実線に見えます。また、パケットが欠損するとこのように全体に青いドットが散らばり、中途半端なバイト数の受信を示します。</p>\n<p>実際のパケットの中身を確認してみます。</p>\n<img src=\"/new-technology/2022/07/30/sfp-plus-nbaset/capture-ipolex.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p>IPの末尾181がubuntu、IPの末尾164がWindowsです。No307,309,310と1460バイトのTCPデータが受信されていますが、No311で318バイトを受信しています。ここで恐らくパケットが欠損したと思われます。その次の受信は、No313でシーケンス365001、No314でシーケンス366461を受信しています。受け損ねたと思われるNo311のシーケンスは360621です。(366461-360621)&#x2F;1460&#x3D;4とちょうど割り切れるため、サーバー側はTCP1460バイトを連続で送っていたものとみられます。No311で318バイトの残り1142バイトをロストし、次のシーケンス363541も1460バイト全体をロストしたのでしょう。</p>\n<p>この後、クライアントは、あくまで自身が欲しいパケットのシーケンスは欠損した360621なのでDup ACKを送出しこれを要求しますが、要求している間にもどんどん次のトラフィックが送信されてきます。最終的には、360621の再送要求がサーバーに届き、サーバーは優先度を上げて360621を再送しますが、それまでに結構なタイムロスがあります。</p>\n<p>iperf3など同一LAN内であれば、再送によるレイテンシも小さく済みますが、相手サーバーがInternet経由だとレイテンシが数ミリ秒〜数十ミリ秒あります。このためハイトラフィックテストや大きなファイルのダウンロードは更に落ち込む事になります。私の環境では200Mbpsが精一杯でした。</p>\n<p>要約すると以下の通りです。</p>\n<div class=\"note info\"><ul>\n<li>SFP＋スイッチの2.5GbEサポート状況はメーカー次第</li>\n<li>SFP＋ 10GBase-Tモジュールのいくつかは2.5GbEをサポートするが、対応状況は不明瞭</li>\n<li>スイッチが2.5GbEに対応しない場合、10GBase-Tモジュールで2.5GbEを認識する場合があるが、片側の速度が1Gbps未満に落ち込むモジュールが大半</li>\n<li>2.5GbE接続であっても10GbEチップを使えば発熱量は増える</li>\n</ul>\n</div>\n\n<blockquote>\n<p>WireShark<br> <a href=\"https://www.wireshark.org/\">https://www.wireshark.org</a></p>\n</blockquote>\n<h2 id=\"FS社のAquantiaチップ特注モジュール\"><a href=\"#FS社のAquantiaチップ特注モジュール\" class=\"headerlink\" title=\"FS社のAquantiaチップ特注モジュール\"></a>FS社のAquantiaチップ特注モジュール</h2><p>FS社では特にホームページで記載されていないものの、実はAquantiaチップを使ったRJ45 10GbEモジュールを特注で提供してくれます。Aquantiaチップのモジュールは、数年前よりSupermicro社が提供するRJ45モジュールで唯一の2.5GbE&#x2F;5GbE対応のものと言われていましたが、$200と高価なものでした。</p>\n<img src=\"/new-technology/2022/07/30/sfp-plus-nbaset/aquantia.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<p>（ラベルは至って普通。でも特注です）</p>\n<p>SFP+スイッチでこのモジュールを10GbEオートネゴで使い、上記の2.5Gbpsのテストをやってみたところ、十分な速度が出ました。今回はリトライもありません。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">Connecting to host 192.168.x.181, port 5201</span><br><span class=\"line\">Reverse mode, remote host 192.168.x.181 is sending</span><br><span class=\"line\">[  4] <span class=\"built_in\">local</span> 192.168.x.164 port 54413 connected to 192.168.x.181 port 5201</span><br><span class=\"line\">[ ID] Interval           Transfer     Bandwidth</span><br><span class=\"line\">[  4]   0.00-1.00   sec   279 MBytes  2.34 Gbits/sec</span><br><span class=\"line\">[  4]   1.00-2.00   sec   283 MBytes  2.37 Gbits/sec</span><br><span class=\"line\">[  4]   2.00-3.00   sec   283 MBytes  2.38 Gbits/sec</span><br><span class=\"line\">[  4]   3.00-4.00   sec   283 MBytes  2.37 Gbits/sec</span><br><span class=\"line\">[  4]   4.00-5.00   sec   283 MBytes  2.37 Gbits/sec</span><br><span class=\"line\">[  4]   5.00-6.00   sec   283 MBytes  2.38 Gbits/sec</span><br><span class=\"line\">[  4]   6.00-7.00   sec   283 MBytes  2.37 Gbits/sec</span><br><span class=\"line\">[  4]   7.00-8.00   sec   283 MBytes  2.37 Gbits/sec</span><br><span class=\"line\">[  4]   8.00-9.00   sec   283 MBytes  2.37 Gbits/sec</span><br><span class=\"line\">[  4]   9.00-10.00  sec   283 MBytes  2.37 Gbits/sec</span><br><span class=\"line\">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class=\"line\">[ ID] Interval           Transfer     Bandwidth       Retr</span><br><span class=\"line\">[  4]   0.00-10.00  sec  2.76 GBytes  2.37 Gbits/sec    0             sender</span><br><span class=\"line\">[  4]   0.00-10.00  sec  2.76 GBytes  2.37 Gbits/sec                  receiver</span><br><span class=\"line\"></span><br><span class=\"line\">iperf Done.</span><br></pre></td></tr></table></figure>\n\n<p>Aquantiaチップの特性でデータロストから耐えられたように見えます。<br>スループットを見てみましょう。</p>\n<img src=\"/new-technology/2022/07/30/sfp-plus-nbaset/throughput-fs.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<p>茶色の実線のスループットは最初の1秒で2Gbpsまで順調に伸びています。1460バイトのTCPデータが連続して受信されている事が青色の実線でわかります。制御のためのデータ送受信もあり、全てが1460バイトにはなりませんが、中途半端なレングスのパケットが点在していません。iperf3の結果だけ見るとすこぶる結果は良好ですが、実際のグラフにしてみるとそれなりに速度の変動は発生しています。</p>\n<p>次にRound tripです。</p>\n<img src=\"/new-technology/2022/07/30/sfp-plus-nbaset/latency-fs.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<p>iperf3の開始直後は5msを超える遅延（青いドット）がいくつか発生しています。断続的に1msに近いレイテンシは10秒間の全体を通して発生しています。見た目だけですと最初の「ASF-10G-T」よりも悪くなっているように見えますが、遅延が0に近い場所の青い線の厚みがあることで「ASF-10G-T」よりは遅延の数が少ないと想定されます。何よりスループットは十分な速度が出ていますので許容範囲と考えるべきでしょう。10Gbpsと2.5Gbpsという速度差から発生するギャップがあり、TCP通信の初期段階で通信速度の差をある程度調整することになりますが、一定の数の調整を無くすことはできません。</p>\n<h2 id=\"スイッチのフローコントロール\"><a href=\"#スイッチのフローコントロール\" class=\"headerlink\" title=\"スイッチのフローコントロール\"></a>スイッチのフローコントロール</h2><p>2.5GbEに対応していないSFP+スイッチであっても、Aquantiaモジュール側の2.5Gbpsの自動認識および速度調整によって上手くいくことが確認できました。それはスイッチの<strong>フロー制御</strong>によっても支えられています。QNAPのQSW-M408-4Cスイッチを使ってテストをし、デフォルトでは有効になっている「フローコントロール」を無効にしてみます。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ iperf3 -c 192.168.x.1 -R</span><br><span class=\"line\">Connecting to host 192.168.x.2, port 5201</span><br><span class=\"line\">Reverse mode, remote host 192.168.x.2 is sending</span><br><span class=\"line\">[  5] <span class=\"built_in\">local</span> 192.168.x.1 port 49780 connected to 192.168.x.2 port 5201</span><br><span class=\"line\">[ ID] Interval           Transfer     Bitrate</span><br><span class=\"line\">[  5]   0.00-1.00   sec   176 MBytes  1.47 Gbits/sec</span><br><span class=\"line\">[  5]   1.00-2.00   sec   172 MBytes  1.45 Gbits/sec</span><br><span class=\"line\">[  5]   2.00-3.00   sec   159 MBytes  1.34 Gbits/sec</span><br><span class=\"line\">[  5]   3.00-4.00   sec   163 MBytes  1.37 Gbits/sec</span><br><span class=\"line\">[  5]   4.00-5.00   sec   170 MBytes  1.42 Gbits/sec</span><br><span class=\"line\">[  5]   5.00-6.00   sec   183 MBytes  1.54 Gbits/sec</span><br><span class=\"line\">[  5]   6.00-7.00   sec   176 MBytes  1.47 Gbits/sec</span><br><span class=\"line\">[  5]   7.00-8.00   sec   183 MBytes  1.53 Gbits/sec</span><br><span class=\"line\">[  5]   8.00-9.00   sec   194 MBytes  1.63 Gbits/sec</span><br><span class=\"line\">[  5]   9.00-10.00  sec   183 MBytes  1.53 Gbits/sec</span><br><span class=\"line\">- - - - - - - - - - - - - - - - - - - - - - - - -</span><br><span class=\"line\">[ ID] Interval           Transfer     Bitrate         Retr</span><br><span class=\"line\">[  5]   0.00-10.00  sec  1.73 GBytes  1.48 Gbits/sec  13430             sender</span><br><span class=\"line\">[  5]   0.00-10.00  sec  1.72 GBytes  1.48 Gbits/sec                  receiver</span><br><span class=\"line\"></span><br><span class=\"line\">iperf Done.</span><br></pre></td></tr></table></figure>\n\n<p>汎用モジュールの「ASF-10G-T」ほど数字は落ち込みませんが、AquantiaチップのSFP＋モジュールでも2.5Gbpsのレートは出ません。こちらはRetrの数字が大きいことから、スイッチのフロー制御が無いまま、TCPの世界でリトライが多発しているように見えます。これはスイッチによっても差がでます。</p>\n<p>ホームユーザーが利用するスイッチは様々な速度の機器を接続したり品質の悪いケーブルの利用も想定しフローコントロールはオンになっていることが多いように思えます。一方、ビジネス向けのスイッチはもちろんフローコントロールの機能を持ちますが、デフォルトでオフになっていることが多いです。</p>\n<p>（デフォルトではフロー制御ONのQNAPスイッチ）</p>\n<img src=\"/new-technology/2022/07/30/sfp-plus-nbaset/qsw.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<p>スイッチのフローコントロールは、<strong>送信側</strong>にPauseフレームをマルチキャスト送信し、送信側を一時停止させます。システムの速度差が問題を引き起こすため、何らかの理由でスイッチのバッファが溢れそうになる時にはスイッチのフローコントロールによってネットワーク全体が安定的に動作します。ここまでの検証で、Aquantiaチップは十分なバッファを持っていることである程度は大量のトラフィックに耐えますが、バッファが溢れそうになった段階でスイッチに限界を通知し、スイッチにPauseフレーム送信を促すことにより通信が安定するものとみられます。</p>\n<h2 id=\"FSでのAquantia-10GbE-SFP＋モジュール（RJ45）の指定方法\"><a href=\"#FSでのAquantia-10GbE-SFP＋モジュール（RJ45）の指定方法\" class=\"headerlink\" title=\"FSでのAquantia　10GbE SFP＋モジュール（RJ45）の指定方法\"></a>FSでのAquantia　10GbE SFP＋モジュール（RJ45）の指定方法</h2><p>これはFS社から教わりましたが、注文時に備考欄に  <mark class=\"label primary\">Aquantia方案</mark>と記載して欲しいとのこと。この指定が無ければMarvellチップのモジュールになります。受注生産とのことで納品まで1か月程度掛かりますが、これはホームユーザーにとって強い味方になると思われます。</p>\n<img src=\"/new-technology/2022/07/30/sfp-plus-nbaset/fs.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<h2 id=\"2-5GbE-SFP＋モジュール（RJ45）\"><a href=\"#2-5GbE-SFP＋モジュール（RJ45）\" class=\"headerlink\" title=\"2.5GbE SFP＋モジュール（RJ45）\"></a>2.5GbE SFP＋モジュール（RJ45）</h2><p>スイッチが2.5GbEに対応しているなら、日本ではあまり見かけない2.5Gbase-Tモジュールが利用できる可能性があります。これはスイッチの対応状況に依存するため、事前にモジュールメーカーへ問い合わせが必須となります。スイッチのパフォーマンスを最大限活かせること、10GbEのチップほど温度が上がらないメリットがあります。モジュール自体の価格も10GBase-Tのものよりは安価です。</p>\n<img src=\"/new-technology/2022/07/30/sfp-plus-nbaset/fs25.png\" class=\"\" width=\"480\" title=\"alt\">\n\n<h2 id=\"モジュールの温度\"><a href=\"#モジュールの温度\" class=\"headerlink\" title=\"モジュールの温度\"></a>モジュールの温度</h2><p>モジュールの温度に関して具体的な数値の記録は以下の通りです。</p>\n<p>前回記事「<a href=\"/new-technology/2022/05/28/sfp-plus/\" title=\"10GネットワークとSFP+\">10GネットワークとSFP+</a>」と同様にモジュールの表面に金属センサーを接触させ計測しています。</p>\n<ul>\n<li>ファンレススイッチでオートネゴによる10Gbpsと2.5Gbpsでのリンクアップの違い</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>10GBase-Tモジュール</th>\n<th>速度</th>\n<th>温度</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>ASF-10G-T</td>\n<td>2.5Gbps</td>\n<td>46℃</td>\n</tr>\n<tr>\n<td>Aquantia10Gモジュール</td>\n<td>2.5Gbps</td>\n<td>45℃</td>\n</tr>\n<tr>\n<td>ASF-10G-T</td>\n<td>10Gbps</td>\n<td>49.4℃</td>\n</tr>\n<tr>\n<td>Aquantia10Gモジュール</td>\n<td>10Gbps</td>\n<td>49.5℃</td>\n</tr>\n<tr>\n<td>（室温29℃）</td>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n<p> Marvell、Aquantiaのモジュールは温度に関して違いは見られません。そういえば、Aquantiaは3年前にMarvellに買収されましたね。今となってはMarvell、Aquantiaという名前で比較するにはふさわしく無いのかもしれません。</p>\n<ul>\n<li>ファン付きスイッチで2.5GbEチップと10GbEチップ（2.5Gbpsオートネゴ接続）との比較</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>モジュール(2.5Gbpsで接続)</th>\n<th>温度</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Cisco SFP-10G-T-80互換</td>\n<td>37.7℃</td>\n</tr>\n<tr>\n<td>Aquantia 10Gモジュール</td>\n<td>38℃</td>\n</tr>\n<tr>\n<td>Marvell 2.5Gモジュール</td>\n<td>35.8℃</td>\n</tr>\n<tr>\n<td>（室温31℃）</td>\n<td></td>\n</tr>\n</tbody></table>\n<p> Cisco SFP-10G-T-80互換のBroadcomチップは低発熱で使いやすいモジュールですが、やはり2.5Gbps専用チップに軍配が上がります。</p>\n<h2 id=\"補足\"><a href=\"#補足\" class=\"headerlink\" title=\"補足\"></a>補足</h2><p>2.5Gbps対応スイッチとオートネゴのASF-10G-Tとの遅延を比較したグラフのスケールを拡大して比較したものを載せておきます。上記ではレイテンシの幅について「帯」という表現をしましたが、拡大してみるとレイテンシの状況にはかなりの違いが見られます。</p>\n<img src=\"/new-technology/2022/07/30/sfp-plus-nbaset/compare.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p>左：2.5Gbpsモジュール（フローコントロール無し）<br>右：ASF-10G-T（2.5GbEオートネゴシエーション）</p>\n<p>0.5秒前後を切り取っただけであり、どちらのモジュールも1msを超える大きな遅延はあります。順調なケースと問題を抱えているケースとしての比較です。左はかなり良い状態を切り取っています。どのモジュールでも数百μsの遅延は定期的に発生します。しかし帯と表現した右側のグラフでは、300μsを超えるレイテンシが継続して発生しており、何らかの問題を抱えていることがわかります。<br>遅延だけでなく、スループットを併せて見ることで遅延は無いが送る量が少ないケースも見極める必要があります。</p>\n<p>iperf3の出力結果だけでもある程度の状況は把握できますが、WireSharkで厳密にスループットのグラフや往復遅延時間を確認し、スイッチやモジュールの能力を見極められます。</p>\n","categories":["Network","Hardware"],"tags":["SFP+"]},{"title":"10GネットワークとSFP+","url":"/new-technology/2022/05/28/sfp-plus/","content":"<img src=\"/new-technology/2022/05/28/sfp-plus/title.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p class=\"onepoint\">この記事で実現すること</p>\n\n<p>リモートワークやインターネット回線の高速化に伴い、10Gネットワークが普及し、近ごろは10GBase-Tの発熱に対する声が聞かれるようになってきました。10Gネットワークにおいて従来のLANケーブルではなく光ファイバーで省電力化と低発熱を求める場合、SFP+が選択肢となります。実はあまり知られていない低遅延の効果も大きいため、10Gネットワークを前提にまとめてみました。夏本番を迎える前に発熱対策を検討してはいかがでしょうか？</p>\n<span id=\"more\"></span>\n\n<h2 id=\"10Gネットワークの消費電力と発熱\"><a href=\"#10Gネットワークの消費電力と発熱\" class=\"headerlink\" title=\"10Gネットワークの消費電力と発熱\"></a>10Gネットワークの消費電力と発熱</h2><p>10GBase-Tの消費電力は1Portあたり3W程度で、単体で見るとさほど大きいものではありませんが、スイッチなどそれが4Port&#x2F;8Portとなると全体で30W程度の消費電力とPC程度のものになってきます。以前に紹介したQNAPの10Gを4Port持つQSW-M408-4Cスイッチングハブの電力を計測してみるとアイドル状態で11.3Wです。これにcat6ケーブルを用い10Gbpsで接続すると3W増加し14.3Wとなります。これだけだと大した消費電力とは思えません。</p>\n<p>しかし、10Gbase-Tのネットワーク機器が出す熱は軽く40度を超え、夏場は60度を超える場合もあります。そもそも10Gbpsという高速処理は負荷が高いのに加え、10GBase-Tに必要なエラー訂正とアナログ&#x2F;デジタル変換の負荷が高くなります。モジュールの消費電力に比例して温度も高くなる傾向があります。</p>\n<p>発熱はスイッチやネットワークカード、PC本体などその周辺機器に悪影響を与えます。特に真夏で部屋の温度が40度近くに達する場合は、これらの高熱を出す機器も内部温度は70度近くに上がってしまい一気に故障する可能性が高くなります。ファンが付いているスイッチは大きいファンノイズが発生しますし、エアコンやファンでエアフローにも気を遣う必要が出てきます。一般的な建売戸建やマンションでクローゼットに回線引き込みがされ、各部屋へのCD管またはPF管が集約されている場合、そこにルーターやスイッチングハブを設置せざるを得ません。こうなると発熱対策、騒音対策が結構な問題になってきます。</p>\n<p>私の自宅の2階のクローゼットの中にある、インターネット配線設備（マルチメディアポート）の内部。家の中で最も熱が篭る場所に配置されています。。。</p>\n<img src=\"/new-technology/2022/05/28/sfp-plus/mmport.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p>右手前がホームゲートウェイ、配線設備の内部にテレビアンテナケーブル（黒）、電話線（グレー）、auひかりのシングルモードファイバケーブル（白）、スイッチングハブから各部屋へのCat6 UTPケーブル（青）、マルチモードファイバケーブル（水色）を通しています。マルチメディアポートの奥に各部屋に繋がるオレンジ色のCD管（直径2cm）が見えます。</p>\n<h2 id=\"SFP-x2F-SFP-とは\"><a href=\"#SFP-x2F-SFP-とは\" class=\"headerlink\" title=\"SFP&#x2F;SFP+とは\"></a>SFP&#x2F;SFP+とは</h2><p>SFPはSmall Form-factor Pluggableの略で光ファイバーの通信に使われるもので、個人向けのネットワーク機器においても利用可能な価格帯のハードウェアです。本来は遠距離の通信や高速化が主で法人向けでしたが、普及に伴い、価格がこなれてきました。個人向けには発熱を抑えた高速通信という意味で利用価値があります。レイテンシが小さく、自宅の通信経路にFirewallやルーターを通しても遅延が少なく済みます。</p>\n<p>10Gネットワークのタイプとレイテンシ</p>\n<table>\n<thead>\n<tr>\n<th>タイプ</th>\n<th>レイテンシ</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>1000Base-T</td>\n<td>10マイクロ秒前後（幅が大きい）</td>\n</tr>\n<tr>\n<td>10GBase-T</td>\n<td>2〜2.5マイクロ秒</td>\n</tr>\n<tr>\n<td>SFP+</td>\n<td>0.3マイクロ秒</td>\n</tr>\n</tbody></table>\n<p>1000Base-TのネットワークでFirewallやルータを挟むと10マイクロ秒のレイテンシが、HGW、ファイアウォールWAN、ファイアウォールLAN、クライアントへとそれぞれがパケット単位で時間を要し、ファイアウォール自身が高性能であっても「ファイアウォールが遅い」という話になります。また、大きなファイルをダウンロードしないから10Gネットワークが不要というわけではなく、一つひとつの処理をキビキビと動作させるためにSFP+の利用価値があります。通常1,500バイトのMTUを9,000バイトとしたジャンボフレームの設定で遅延を緩和できますが、抜本的改善としてSFP+を選択する効果は大きいです。</p>\n<p>SFPは主として光ケーブルを接続するためのインタフェースです。スイッチやネットワークカードにはSFPスロット（ポート）があり、SFPモジュール（トランシーバとも呼ばれます）を挿して使います。モジュールは光ケーブル、銅線のダイレクトアタッチケーブル、従来のLANケーブル（RJ-45端子）などを接続可能なインタフェースがあります。SFPはさまざまなモジュールを使い分けることにより、速度、距離、ケーブルの種類に対応できます。</p>\n<img src=\"/new-technology/2022/05/28/sfp-plus/sw.png\" class=\"\" width=\"640\" title=\"alt\">\n\n<p>QSW-M408-4Cスイッチのように、10GBase-TのPortとSFP+のPortが用意されている製品もありますが、SFP&#x2F;SFP+スロットしかないスイッチもあります。</p>\n<h2 id=\"距離、ケーブルの種類によるモジュールの使い分け\"><a href=\"#距離、ケーブルの種類によるモジュールの使い分け\" class=\"headerlink\" title=\"距離、ケーブルの種類によるモジュールの使い分け\"></a>距離、ケーブルの種類によるモジュールの使い分け</h2><p>ホームユーザーが自宅でSFPモジュールを使い分けるには、既存ケーブルの有無、配線の距離、価格面の優位性を見ながら選択することになります。</p>\n<table>\n<thead>\n<tr>\n<th>名称</th>\n<th>距離</th>\n<th>お勧め度</th>\n<th>消費電力</th>\n<th>発熱</th>\n<th>補足説明</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>パッシブダイレクトアタッチケーブル</td>\n<td>〜7m</td>\n<td>◎</td>\n<td>0.2w</td>\n<td>微弱</td>\n<td>安価。Twinaxとも呼ばれる</td>\n</tr>\n<tr>\n<td>アクティブダイレクトアタッチケーブル</td>\n<td>〜15m</td>\n<td>△</td>\n<td>1w未満</td>\n<td>弱</td>\n<td>殆ど見かけない</td>\n</tr>\n<tr>\n<td>AOCケーブル</td>\n<td>〜100m</td>\n<td>◯</td>\n<td>0.5w〜2w</td>\n<td>弱</td>\n<td>流通量少ない（高価）</td>\n</tr>\n<tr>\n<td>MMFモジュール（10GBase-SR）+OM3ケーブル</td>\n<td>〜300m</td>\n<td>◎</td>\n<td>0.6W</td>\n<td>弱</td>\n<td>安価、取り回しやすい</td>\n</tr>\n<tr>\n<td>SMFモジュール＋SM1 or SM2ケーブル</td>\n<td>100m〜40km〜</td>\n<td>△</td>\n<td>0.6w〜1w</td>\n<td>弱</td>\n<td>長距離向け、ケーブルが折り曲げに弱い</td>\n</tr>\n<tr>\n<td>10GBase-Tモジュール</td>\n<td>〜80m</td>\n<td>◯</td>\n<td>2.5W〜3w</td>\n<td>強</td>\n<td>やや高額</td>\n</tr>\n</tbody></table>\n<p>SFP+は対向機器の電源が入っていなくてもモジュールを挿すだけで電力を消費します。単体をスイッチに挿し、対向が接続していない状態でDACと1000Base-Tは0.1W程度の消費で誤差の範囲ですが、10GBase-SRは単体で0.5W消費します。10GBase-Tモジュールは1W程度消費します。</p>\n<p>端末、スイッチ間の距離が7m未満であればパッシブダイレクトアタッチケーブル（DAC）を最優先に選定します。DACと言えば、一般的にはパッシブのことを言います。特に電流を増幅させずそのままデータを送信するので発熱が極めて少ないですが、距離の制限があります。ホームユーザーが熱対策を考える場合、どうにかして7mの距離以内に端末・スイッチを配置する事が最優先となります。</p>\n<h3 id=\"DAC\"><a href=\"#DAC\" class=\"headerlink\" title=\"DAC\"></a>DAC</h3><img src=\"/new-technology/2022/05/28/sfp-plus/dac.png\" class=\"\" width=\"640\" title=\"alt\">\n\n<p>金額も安価で1mのDACで1,600円程度です。このケーブルにはモジュールも両端に付いているので別途モジュールを購入する必要はありません。銅線（Copper）で、1mであればCat6の一般的なケーブルよりは細いですが、しなやかさは劣ります。7mまでの距離に応じて線の太さが太くなります。安価で発熱が殆どありません。</p>\n<p>業務用に使われるCiscoやHPなどの機器はベンダーロックインという排他的な仕組みがあり、うまく接続できない場合があります。最近の個人向けのintelやMellanoxなどのネットワークカードや、個人向けスイッチについてはベンダーロックインの話は聞いたことがありません。DACの難しいところは異なるベンダーの機器を接続する時にどちらかのベンダーの互換性を重視して購入することになる点です。NIC側の互換性をメインに考えるか、スイッチ側の互換性をメインに考えるか判断が必要です。SFPはMSA(マルチソースアグリーメント）によって業界で標準化されたトランシーバデバイスとして、可能な限り規格を統一されるように取り組まれています。しかしながら互換性が不十分な機器もあるようで、DACで動作しないケースもあり得ます。<br>スイッチやネットワークカードのベンダーはこの汎用品の利用について保証しませんが、ベンダー側もユーザーに応えるように、常日頃からファームウェアのアップデートなどが行われています。</p>\n<h3 id=\"10GBase-SR-OM3ケーブル\"><a href=\"#10GBase-SR-OM3ケーブル\" class=\"headerlink\" title=\"10GBase-SR+OM3ケーブル\"></a>10GBase-SR+OM3ケーブル</h3><p>7mを超える距離、例えば異なる部屋にLANを通す場合には、10GBase-SRモジュールとOM3光ケーブルを使います。SRとはShort Reach（短距離）の意味です。光ケーブルも発熱は少なく、マルチモードファイバは、かなりケーブルが細くしなやかです。ただし、UTPほどは強いものではなく、極端な折り曲げは通信エラーになりますし、通線ワイヤーを使い各部屋を通す場合には強い力でぐいぐいと引っ張るわけにもいきません。うっかり足を引っ掛けると断線します。ケーブルを絨毯の下に這わせたり、ドアの隙間を通したりするのは難しいでしょう。丁寧に扱う必要があります。</p>\n<img src=\"/new-technology/2022/05/28/sfp-plus/om3.png\" class=\"\" width=\"640\" title=\"alt\">\n\n<p>SFP+の10Gbpsで利用するマルチモードファイバは、LC-LCという2対の組みをトランシーバに挿して使います。2本の光ファイバがセットになり、送信用（Tx)と受信用（RX)とに役割があります。また、速度によってケーブルの被覆の色が決められており、OM3、OM4はアクアジャケットになります。<strong>2本の線があるからマルチではなく</strong>、1本の線の中で複数の光の波形を通すのでマルチモードと呼ばれます。</p>\n<table>\n<thead>\n<tr>\n<th>MMF</th>\n<th>1Gbps</th>\n<th>10Gbps</th>\n<th>40Gbps</th>\n<th>100Gbps</th>\n<th>ジャケット色</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>OM1</td>\n<td>275m</td>\n<td>33m</td>\n<td>ー</td>\n<td>ー</td>\n<td>オレンジ</td>\n</tr>\n<tr>\n<td>OM2</td>\n<td>550m</td>\n<td>82m</td>\n<td>ー</td>\n<td>ー</td>\n<td>オレンジ</td>\n</tr>\n<tr>\n<td>OM3</td>\n<td>ー</td>\n<td>300m</td>\n<td>100m</td>\n<td>70m</td>\n<td>アクア</td>\n</tr>\n<tr>\n<td>OM4</td>\n<td>ー</td>\n<td>550m</td>\n<td>150m</td>\n<td>150m</td>\n<td>アクア</td>\n</tr>\n<tr>\n<td>OM5</td>\n<td>ー</td>\n<td>550m</td>\n<td>150m</td>\n<td>150m</td>\n<td>ライム</td>\n</tr>\n</tbody></table>\n<p>10mのOM3で1,500円、10mのOM4で3,000円程度です。将来の拡張性のために、40Gbps、100Gbpsを150mの距離に対応しているOM4を選択しても良いように見えます。しかし今のところ25GbpsのスイッチではOM3のLC-LCケーブルが使えますが、40Gbpsはスイッチ側もQFSPインタフェースとなり、LC-LCではなくMPOケーブルとなります。また、古い規格のSCコネクタのケーブル（SC-SCケーブル）もありますが、現代の個人向け機器では殆ど使うことはありません。</p>\n<p>ケーブルの両端のモジュールはそれぞれ接続する機器のベンダーのものを選択します。例えばNASとスイッチとを接続する場合、NASのNICがMellanoxでスイッチがMikrotikであれば、両端のモジュールはそれぞれのベンダーのモジュールを購入します。DACで対応が難しいケースは短い距離でもこの方法で接続します。</p>\n<h3 id=\"10GBase-Tモジュール、1000Base-Tモジュール\"><a href=\"#10GBase-Tモジュール、1000Base-Tモジュール\" class=\"headerlink\" title=\"10GBase-Tモジュール、1000Base-Tモジュール\"></a>10GBase-Tモジュール、1000Base-Tモジュール</h3><p>既存のRJ45端子のLANケーブル（UTPケーブル）を接続するためのモジュールです。10GBase-Tの口を持っていないスイッチが多くあるため、このモジュールを利用し、既存の10GBase-T環境と接続することになります。10GBase-TモジュールはLANケーブルの長さが30mまでを限界としている製品が多いです。ケーブルが長くなれば電力量が増え3Wを超えてしまうためです。通信量と消費電力とは殆ど関係ありません。確かにIEEE802.3azという規格では無通信時は省電力にする仕組みを持っていますが、消費電力は距離によって変わります。最近、MarvellではなくBroadcomのチップを使った10GBase-Tモジュールも出てきており省電力で80mまで可能となっています。</p>\n<h3 id=\"AOCケーブル\"><a href=\"#AOCケーブル\" class=\"headerlink\" title=\"AOCケーブル\"></a>AOCケーブル</h3><p>OM3ケーブルはシングルファイバほどの扱いの丁寧さは不要ですが、もう少しだけ被覆の強度のあるものを選ぶとすればAOCケーブルを選択します。見た目はDACのようで両端にモジュールが付いており、線の内部は光が使われます。短いケーブルはOM3ですが距離が長いAOCはOM4が使われます。ただし、ユーザーの利便性から考えると一般的にはSFPトランシーバとOM3、OM4ケーブルの選定が一般的で、購入先もなかなか見つからないかもしれません。</p>\n<h3 id=\"その他ケーブル、トランシーバ\"><a href=\"#その他ケーブル、トランシーバ\" class=\"headerlink\" title=\"その他ケーブル、トランシーバ\"></a>その他ケーブル、トランシーバ</h3><p>サンワサプライ社（<a href=\"https://www.sanwa.co.jp/\">https://www.sanwa.co.jp/</a>）のHPから商品紹介を前提で画像が引用可能ということでしたので以下に紹介します。</p>\n<ul>\n<li><p>SC-SCケーブル（光ファイバケーブル（1m））HKB-SCSC1-01L</p>\n <img src=\"/new-technology/2022/05/28/sfp-plus/HKB-SCSC1-01L_MA.png\" class=\"\" width=\"300\" title=\"alt\">\n<p> 古い規格の光ファイバ端子です。GBICとも呼ばれます。これはSFP&#x2F;SFP+モジュールには接続できません。</p>\n</li>\n<li><p>MPOケーブル</p>\n <img src=\"/new-technology/2022/05/28/sfp-plus/mpo_main.png\" class=\"\" width=\"300\" title=\"alt\">\n<p> 40GbpsのQFSPトランシーバ（QSFP-40G-SR4）に利用されます。</p>\n</li>\n</ul>\n<h3 id=\"ネットワークカードの消費電力\"><a href=\"#ネットワークカードの消費電力\" class=\"headerlink\" title=\"ネットワークカードの消費電力\"></a>ネットワークカードの消費電力</h3><p>intel X710の4Portについて、10GBase-TのモデルとSFP+のモデルとで比較します。</p>\n<table>\n<thead>\n<tr>\n<th>型番</th>\n<th>接続方式</th>\n<th>通常消費電力</th>\n<th>最大消費電力</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>X710T4(旧型)</td>\n<td>UTP(RJ45)4Port 10Gbps</td>\n<td>23.7W</td>\n<td>28.9W</td>\n</tr>\n<tr>\n<td>X710TL4</td>\n<td>UTP(RJ45)4Port 10Gbps</td>\n<td>13.6W</td>\n<td>14.2W</td>\n</tr>\n<tr>\n<td>X710TL4</td>\n<td>UTP(RJ45)4Port 2.5Gbps</td>\n<td>9.5W</td>\n<td>9.9W</td>\n</tr>\n<tr>\n<td>X710DA4</td>\n<td>SFP+4Port 10GBase-SR</td>\n<td>6.2W</td>\n<td>6.6W</td>\n</tr>\n<tr>\n<td>X710DA4</td>\n<td>SFP+4Port DAC</td>\n<td>3.6W</td>\n<td>3.8W</td>\n</tr>\n</tbody></table>\n<p>10GBase-Tは従来のX710T4はものすごい消費電力でしたが、X710TL4となり随分と消費電力が抑制されています。2.5Gbpsであればさらに抑制することはできますが、速度が1&#x2F;4になったからといって、消費電力が1&#x2F;4に下がるわけではありません。X710(40Gbpsのチップ）のポテンシャルが無駄になっているということでしょうか。</p>\n<p>これに対してSFPは光の10GBase-SRは最大6.6Wとかなり抑制され、DACに至っては最大で3.8Wです。</p>\n<blockquote>\n<p>intel<br> <a href=\"https://www.intel.com/content/dam/www/public/us/en/documents/product-briefs/ethernet-x710-t2l-t4l-brief.pdf\">https://www.intel.com/content/dam/www/public/us/en/documents/product-briefs/ethernet-x710-t2l-t4l-brief.pdf</a><br> <a href=\"https://www.intel.com/content/dam/www/public/us/en/documents/product-briefs/ethernet-x710-brief.pdf\">https://www.intel.com/content/dam/www/public/us/en/documents/product-briefs/ethernet-x710-brief.pdf</a></p>\n</blockquote>\n<h2 id=\"SFPモジュールの価格\"><a href=\"#SFPモジュールの価格\" class=\"headerlink\" title=\"SFPモジュールの価格\"></a>SFPモジュールの価格</h2><p>それぞれのモジュールの価格帯は以下の通りです。</p>\n<table>\n<thead>\n<tr>\n<th>タイプ</th>\n<th>国内価格</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>DAC</td>\n<td>1,600円前後</td>\n</tr>\n<tr>\n<td>MMF+OM3</td>\n<td>MMF 3,000円前後(1つの値段)、OM3ケーブル 1,500円前後</td>\n</tr>\n<tr>\n<td>1000Base-T</td>\n<td>3,000円〜4,000円（1つの値段）</td>\n</tr>\n<tr>\n<td>10GBase-T</td>\n<td>7,000円〜10,000円（1つの値段）</td>\n</tr>\n</tbody></table>\n<p>FS社のモジュールは世界的に見てもよく利用されています。日本語のWebサイトがあり円建てで購入できます。日本Amazonでは10GTekやipolexのモジュールを購入できます。物によってはやや割高です。海外通販を利用する際、通常は2％程度の為替手数料を、PayPalに至っては通貨の追加設定をしないと4％の割高な為替手数料を適用されます。また、最近高騰している輸送コストでかえって割高になってしまいます。</p>\n<blockquote>\n<p>FS 10Gモジュール<br> <a href=\"https://www.fs.com/jp/c/10g-modules-56\">https://www.fs.com/jp/c/10g-modules-56</a></p>\n</blockquote>\n<p>FSのWebサイトは法人向けがメインとあって、モジュールの注文画面ではCisco、Juniper、Aristaと有名な海外ベンダー名が列挙されています。<mark class=\"label primary\">もっと＋</mark>ボタンをクリックするとNetgear、intel、Mellanoxなどの名前が出てきます。それでも該当するメーカーが無い場合は<mark class=\"label primary\">カスタム</mark>のボタンをクリックすると、カスタムモジュールの注文画面に遷移し、さらに細かなベンダー一覧が表示されます。見つからない場合、<mark class=\"label primary\">対応ブランド</mark>に「その他」を、<mark class=\"label primary\">デバイスの型番</mark>に、メーカーと型番を記入すればOKです（FS社から教えてもらいました）。無償の技術サポートがあり質問もできます。法人を対象にビジネスされているでしょうし、個人ユーザーが色々聞くのも気が引けるかもしれませんが、きちんと回答してもらえます。</p>\n<img src=\"/new-technology/2022/05/28/sfp-plus/fs1.png\" class=\"\" width=\"640\" title=\"alt\">\n\n<p>DACについても互換性が心配な場合は、同様にベンダー名や機器名を記入し注文します。</p>\n<img src=\"/new-technology/2022/05/28/sfp-plus/fs2.png\" class=\"\" width=\"640\" title=\"alt\">\n\n<h3 id=\"SFP-モジュールの発熱\"><a href=\"#SFP-モジュールの発熱\" class=\"headerlink\" title=\"SFP+モジュールの発熱\"></a>SFP+モジュールの発熱</h3><p>室温26度の状況下でそれぞれのモジュールの温度を計測しました。計測するにあたり以下の機器を使いました。これでモジュールの表面にこの金属のセンサを当てて温度を測ります。</p>\n<img src=\"/new-technology/2022/05/28/sfp-plus/TM902C.png\" class=\"\" width=\"480\" title=\"alt\">\n\n<p>併せてスイッチのコマンドラインからモジュールの温度が取得できるのでそれも加え比較します。</p>\n<ul>\n<li>ファン付きスイッチ</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>No</th>\n<th>タイプ</th>\n<th>実際の温度</th>\n<th>スイッチ上のCLI</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>1</td>\n<td>DAC</td>\n<td>27℃</td>\n<td>なし</td>\n</tr>\n<tr>\n<td>2</td>\n<td>10GBase-SR(10m)</td>\n<td>32.9℃</td>\n<td>36.8℃</td>\n</tr>\n<tr>\n<td>3</td>\n<td>10GBase-SR(20m)</td>\n<td>33.8℃</td>\n<td>39.1℃</td>\n</tr>\n<tr>\n<td>4</td>\n<td>10GBase-T “Broadcom”</td>\n<td>36.2℃</td>\n<td>40.7℃</td>\n</tr>\n<tr>\n<td>5</td>\n<td>10GBase-T “Broadcom” 2.5Gbps動作 <sup><b><a href=\"#note1\">[1]</a></b></sup></td>\n<td>32.3℃</td>\n<td>29.5℃</td>\n</tr>\n<tr>\n<td>6</td>\n<td>10GBase-T “MikroTik” S+RJ10</td>\n<td>40.3℃</td>\n<td>61.0℃</td>\n</tr>\n<tr>\n<td>7</td>\n<td>1000Base-T ASF-GE-T</td>\n<td>34.2℃</td>\n<td>なし</td>\n</tr>\n<tr>\n<td>8</td>\n<td>10GBase-T “Marvell” ASF-10G-T</td>\n<td>40.2℃</td>\n<td>なし</td>\n</tr>\n<tr>\n<td></td>\n<td>(スイッチ:Ubiquiti USW-Pro-Aggregation)</td>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n<p><small id=\"note1\">[1]スイッチは2.5Gbpsに対応し、10GBase-Tモジュールを2.5Gbpsでリンクさせています。</small></p>\n<p>No1-5は常にスイッチに挿したまま、6,7,8は計測の都度挿し替えしています。</p>\n<ul>\n<li>ファンレススイッチ</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>No</th>\n<th>タイプ</th>\n<th>実際の温度</th>\n<th>スイッチ上のCLI</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>1</td>\n<td>10GBase-SR(20m)</td>\n<td>43.6℃</td>\n<td>48.61℃</td>\n</tr>\n<tr>\n<td>2</td>\n<td>1000Base-T ASF-GE-T</td>\n<td>44.6℃</td>\n<td>なし</td>\n</tr>\n<tr>\n<td>3</td>\n<td>10GBase-T “Marvell” ASF-10G-T</td>\n<td>48.6℃</td>\n<td>なし</td>\n</tr>\n<tr>\n<td>4</td>\n<td>10GBase-T “Broadcom”</td>\n<td>45.4℃</td>\n<td>54.3℃</td>\n</tr>\n<tr>\n<td>5</td>\n<td>10GBase-T “MikroTik” S+RJ10</td>\n<td>49.5℃</td>\n<td>67.06℃</td>\n</tr>\n<tr>\n<td></td>\n<td>(スイッチ:Ubiquiti USW-Aggregation)</td>\n<td></td>\n<td></td>\n</tr>\n</tbody></table>\n<p>No1,2は常にスイッチに挿したまま、3,4,5は計測の都度挿し替えしています。</p>\n<p>ファンレスのスイッチは筐体内部に熱を持つため、それがモジュールにも伝播しているのが分かります。また、”実際の温度”はモジュールのコネクタ部分に近い箇所を計測しています。スイッチのCLIで表示される温度は、モジュールのセンサーの1か所の温度でありモジュール全体ではありません。10GBase-SRの出す熱の範囲は高温ながら範囲が限定的で、センサーがなかなか一定数値にはなりませんでした（最も高い数値を採用しています）。10GBase-Tは測る場所によって多少温度は異なりますがモジュール全体から発熱しています。</p>\n<p>60℃を超えるとハードウェア環境面としては相当に厳しいでしょうか。まずはエアフローが大事ということになります。特にファンレススイッチを使う場合、この時期は問題ありませんが、夏場はエアコンまたはサーキュレーターが必要そうです。次に、可能な限り10GBase-Tを使わずDACや10GBase-SRを使い、熱を抑える必要があります。クライアントの10GBase-Tの速度を2.5Gbpsに落とすのも効果的です。ファンレスのスイッチで10GBase-Tを多用すると、スイッチがスローダウンまたはシステムダウンする可能性があります。</p>\n<p>技術面でポイントをまとめると以下の通りです。</p>\n<ul>\n<li>10GBase-Tを多用する場合はファンレススイッチでは厳しい</li>\n<li>10Gネットワークを使う場合は可能な限りDACや10GBase-SRへの移行を</li>\n<li>爆熱と噂のMikroTikのS+RJ10はやはりすごい熱でした（QSW-M408-4Cとの組み合わせで55℃を記録）</li>\n<li>10GBase-TモジュールのBroadcomチップ対応のもの（80m対応）は熱対策には有効</li>\n<li>1000Base-Tのモジュールも意外と発熱する。リビングなど多くの100&#x2F;1000Mbps機器が揃う箇所にはSFPのスイッチはかえって不向き。4Portなどの小型ハブに逃した方が良い</li>\n</ul>\n<p>ここまでSFP+スイッチで温度を計測してきましたが、QNAP QSW-M408-4Cはどうでしょうか？</p>\n<img src=\"/new-technology/2022/05/28/sfp-plus/qnap.png\" class=\"\" width=\"640\" title=\"alt\">\n\n<p>筐体の下部は全般的に赤枠で囲った範囲において43℃、部分的に48℃に達する場所もあります。たった1本の10Gbase-TをRJ45ポートに接続しただけですが、これは夏場はエアコンのある部屋で運用しないと厳しいです。エアコンの無い環境における夏場の日中はサーキュレーターで風の流れを作ってあげないと相当に厳しいと思われます。個人ユーザーのニーズとしては静かなファンレスのスイッチを好む傾向にあり、メーカー側もファンレスや静かなスイッチを販売せざるを得ない傾向のように見えますが、今の10GBase-Tのファンレススイッチは設置場所を選ぶというのが結論です。</p>\n<p> SFPトランシーバはDDM(Digital Diagnostic Monitoring)の機能を持ち、スイッチのCLIで光の強さなども把握できます。ただ個人向けは短距離が基本なのでさほど気にすることも無いでしょうから今回は割愛します。</p>\n<h4 id=\"クライアント側の発熱抑制\"><a href=\"#クライアント側の発熱抑制\" class=\"headerlink\" title=\"クライアント側の発熱抑制\"></a>クライアント側の発熱抑制</h4><p>デスクトップPCを都度電源オフにせずスリープにされる方は、スイッチ側のSFPモジュールは通電している状態かもしれません。Windowsの省電力の設定で殆どリンクダウン状態にする事でより省電力、発熱を抑えられます。WakeOnLanを使わない方は設定を検討してはいかがでしょうか。<br> <img src=\"/new-technology/2022/05/28/sfp-plus/win.png\" class=\"\" width=\"480\" title=\"alt\"></p>\n<h2 id=\"SFP-x2F-SFP-モジュールの挿入、取り外し\"><a href=\"#SFP-x2F-SFP-モジュールの挿入、取り外し\" class=\"headerlink\" title=\"SFP&#x2F;SFP+モジュールの挿入、取り外し\"></a>SFP&#x2F;SFP+モジュールの挿入、取り外し</h2><p>モジュールの挿入は差し込むだけです。カチッと音がし、ロックされます。取り出すときはケーブルを抜き、ラッチを引き下げるとロックが外れます。<br> <img src=\"/new-technology/2022/05/28/sfp-plus/latch.png\" class=\"\" width=\"300\" title=\"alt\"></p>\n<p>このとき、光が出ている部分を覗き込むと目を痛める恐れがありますので注意してください。</p>\n<p>DACも同様に差し込むのは簡単です。取り外すときは、プルタブを指に引っ掛けて引き抜きます。Amazonの口コミを見ていただけるとわかりますが、メーカーによって引き抜きにくい製品があります。個体差やNICとの相性もあるのでしょうが、過去、10GTekのDACでMellanoxのカードとのロックが外れず焦った記憶があります。モジュールを片手の指で押さえて、もう片手の指でプルタブを引っ掛け引き抜くと確実です。無理に片手でプルタブを強く引っ張るとスイッチやNICが破損しますので注意してください。<br> <img src=\"/new-technology/2022/05/28/sfp-plus/dac2.png\" class=\"\" width=\"300\" title=\"alt\"></p>\n<h2 id=\"ネットワークカードへのSFP-モジュールの挿入\"><a href=\"#ネットワークカードへのSFP-モジュールの挿入\" class=\"headerlink\" title=\"ネットワークカードへのSFP+モジュールの挿入\"></a>ネットワークカードへのSFP+モジュールの挿入</h2><p>PCやNASのSFP+対応のネットワークカードにはSFP+モジュールを挿しますが、ネットワークカードからSFPポートへの電力供給は3W程度です。従い、DACやMMFトランシーバはもちろん問題ありませんが、10GBase-Tモジュールは電力を要するので基本的にネットワークカードには10GBase-Tモジュールを挿しません。もちろん動作はしますが、電力供給が不足する可能性が高く、また、発熱のためにネットワークカードが破損する可能性があります。</p>\n<h2 id=\"OM3ケーブルを配管に通すには\"><a href=\"#OM3ケーブルを配管に通すには\" class=\"headerlink\" title=\"OM3ケーブルを配管に通すには\"></a>OM3ケーブルを配管に通すには</h2><p>LC-LCをそのまま直径2cm程度の既存配管に通すのは難しいのですが、一旦端子部分を繋いでいるコネクタを外す事ができます。<br> <img src=\"/new-technology/2022/05/28/sfp-plus/lclc.png\" class=\"\" width=\"300\" title=\"alt\"></p>\n<p>私の場合、UTPケーブルの被覆を使い、コネクタ部分を被せるようにしてテープを巻いています。CD管&#x2F;PF管の内径の大きさの問題もありますが、LCのコネクタは長いので、CD管&#x2F;PF管が曲がる箇所を通過させるのが難しいところです。コネクタとコネクタの間を少し大きく取り、CD管が曲がっている場所も通りやすくします。通線ワイヤーとテープでしっかりと繋いで配管を通します。電話線など他の配線があって通せない場合は工事業者さんにお願いした方が良いでしょう（一旦電話線を抜いて光を通し、電話線を再配線すると楽ですが、電話線の敷設は資格が必要です）。最近、ショートノーズの新製品が出てきているので配管を通す場合はお勧めです。</p>\n <img src=\"/new-technology/2022/05/28/sfp-plus/lclc2.png\" class=\"\" width=\"300\" title=\"alt\">\n\n<h2 id=\"失敗事例\"><a href=\"#失敗事例\" class=\"headerlink\" title=\"失敗事例\"></a>失敗事例</h2><p>光ケーブルは弱いと書きましたが、既に配管にケーブルがあるにも関わらず追加でOM3を通そうとして途中の配管のカーブで詰まってしまい、諦めて戻したことがあります。UTPケーブルなら体重を掛けてぐいぐい引っ張るところですが、さすがにOM3のケーブルなので片手で引っ張る程度で手加減したつもりでしたが損傷していました。ケーブルに損傷がないかスイッチのCLIで見た結果が以下です。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">(UBNT) &gt;show fiber-ports optics all</span><br><span class=\"line\">                                                 Output   Input</span><br><span class=\"line\">Port    Physical Port/  Temp  Voltage  Current   Power    Power     TX     LOS</span><br><span class=\"line\">        Lane Number     [C]   [Volt]     [mA]    [dBm]    [dBm]     Fault</span><br><span class=\"line\">------  --------------  ----  -------  -------   -------  -------   -----  ---</span><br><span class=\"line\">0/1     0/1-Lane1       43.9    3.321      7.7    -2.947   -3.036   No     No</span><br><span class=\"line\">0/4     0/4-Lane1       44.4    3.348      7.8    -2.818   -2.476   No     No</span><br><span class=\"line\">0/16    0/16-Lane1      43.4    3.389      7.8    -3.011  -11.733   No     No</span><br><span class=\"line\">0/21    0/21-Lane1       N/A      N/A      N/A       N/A      N/A   N/A    N/A</span><br><span class=\"line\">0/22    0/22-Lane1       N/A      N/A      N/A       N/A      N/A   N/A    N/A</span><br><span class=\"line\">0/23    0/23-Lane1       N/A      N/A      N/A       N/A      N/A   N/A    N/A</span><br><span class=\"line\">0/24    0/24-Lane1       N/A      N/A      N/A       N/A      N/A   N/A    N/A</span><br><span class=\"line\">0/28    0/28-Lane1      46.7    3.372      6.0    -3.010   -3.010   No     No</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>上記Port16が該当のケーブルなんですが、Input Powerが-11.733dBmとなっています。これはケーブルの品質が極めて悪化していることを示しています。光ケーブルの品質は以下の表が参考にすべき内容となっています。大昔よりEMC社が提示しているリストで、多くの方に目安として使われています。私のケースだと、-11.733dBmなので2Gbpsも危ういということがわかります。実際のiperf3の計測では4Gbps〜5Gbpsほどは出ていますが、このケーブルは廃棄するしかありませんでした。</p>\n<table>\n<thead>\n<tr>\n<th>microwatt</th>\n<th>milliwatt</th>\n<th>dBm</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>1</td>\n<td>0.001</td>\n<td>-30</td>\n<td>Loss of Signal</td>\n</tr>\n<tr>\n<td>10</td>\n<td>0.01</td>\n<td>-20</td>\n<td></td>\n</tr>\n<tr>\n<td>25.1</td>\n<td>0.0251</td>\n<td>-16</td>\n<td>2Gbps minimum accept signal</td>\n</tr>\n<tr>\n<td>31.6</td>\n<td>0.0316</td>\n<td>-15</td>\n<td>4Gbps minimum accept signal</td>\n</tr>\n<tr>\n<td>50</td>\n<td>0.05</td>\n<td>-13.01</td>\n<td></td>\n</tr>\n<tr>\n<td>100</td>\n<td>0.1</td>\n<td>-10</td>\n<td>2Gbps minimum send signal</td>\n</tr>\n<tr>\n<td>125.9</td>\n<td>0.1259</td>\n<td>-9</td>\n<td>4Gbps minimum send signal</td>\n</tr>\n<tr>\n<td>150</td>\n<td>0.15</td>\n<td>-8.24</td>\n<td></td>\n</tr>\n<tr>\n<td>200</td>\n<td>0.2</td>\n<td>-6.99</td>\n<td>Normal range of optical signal strength</td>\n</tr>\n<tr>\n<td>250</td>\n<td>0.25</td>\n<td>-6.02</td>\n<td></td>\n</tr>\n<tr>\n<td>300</td>\n<td>0.3</td>\n<td>-5.23</td>\n<td></td>\n</tr>\n<tr>\n<td>350</td>\n<td>0.35</td>\n<td>-4.26</td>\n<td></td>\n</tr>\n<tr>\n<td>400</td>\n<td>0.4</td>\n<td>-3.98</td>\n<td></td>\n</tr>\n</tbody></table>\n<h2 id=\"まとめ\"><a href=\"#まとめ\" class=\"headerlink\" title=\"まとめ\"></a>まとめ</h2><p>もし、既存のネットワークにSFP+ポートを持ったスイッチングハブがあるのであれば是非SFP+にチャレンジしてみてください。低レイテンシ・低発熱のネットワークが構築できます。もちろん、スイッチを使わずNASとPCとをDACで直結するという方法もあります。ebayに目を向ければ＄50の10GネットワークカードのMellanox ConnectX-3があります。</p>\n<p>なお、SFPの注意点としてはNBase-T(2.5Gbps&#x2F;5Gbps)に対応していないスイッチも多く存在することです。スイッチが対応していなくても10GBase-TモジュールのNBase-Tサポートでカバーできる場合があります。SFP+のNBase-Tへの対応については「 <a href=\"/new-technology/2022/07/30/sfp-plus-nbaset/\" title=\"SFP+の2.5GbE対応\">SFP+の2.5GbE対応</a> 」を参照してください。</p>\n","categories":["Network","Hardware"],"tags":["SFP+","10GbE"]},{"title":"XG Firewall v18のSSL/TLSインスペクションの設定","url":"/new-technology/2020/03/20/ssl-inspection1/","content":"<p class=\"onepoint\">この記事で実現すること</p>\nXG Firewall v18のSSL/TLSインスペクションを使い、暗号化されたSSL/TLS通信を解読します。これにより、ウィルスやマルウェアなどの脅威を通信中に検出し、PCやiPhone等（Windows、macOS、Linux、iOS）が攻撃を受ける前に防御できるようになります。\n<span id=\"more\"></span>\n\n<h2 id=\"XG-Firewall-v18のメリット\"><a href=\"#XG-Firewall-v18のメリット\" class=\"headerlink\" title=\"XG Firewall v18のメリット\"></a>XG Firewall v18のメリット</h2><p>XGでは暗号化された通信を高速に解読し、ウィルスやマルウェアのダウンロードをPCやスマホが受信する前に防ぐ事が可能となります。また、利用を認めていないアプリケーションのデータのやりとりを未然に防ぐ事も可能です。v18では、全く新しい<mark class=\"label primary\">XStreamアーキテクチャ</mark>によって、この解読（SSL&#x2F;TLSインスペクション）の速度が大幅に向上しました。</p>\n<h2 id=\"SSL-x2F-TLSインスペクションの対象ホストを決める\"><a href=\"#SSL-x2F-TLSインスペクションの対象ホストを決める\" class=\"headerlink\" title=\"SSL&#x2F;TLSインスペクションの対象ホストを決める\"></a>SSL&#x2F;TLSインスペクションの対象ホストを決める</h2><p>「<a href=\"/new-technology/2020/03/20/ssl-inspection/\" title=\"SSLインスペクションについて\">SSLインスペクションについて</a>」に記載した通り、SSL&#x2F;TLSインスペクションを行うためには、PC等のクライアントにXGのCA証明書をインストールする事が必須となります。従いSSL&#x2F;TLSインスペクションの対象のグループ、家電やAndroidなどのSSL&#x2F;TLSインスペクションを使えないグループとに分類します。この2つのグループはIPアドレスの範囲で分割するのが最も簡単な方法です。例えば、SSL&#x2F;TLSインスペクショングループはスタティックでIPを割り当て、非SSL&#x2F;TLSインスペクショングループはDHCPで動的なIPアドレスを配布する方法があります。<strong>XGのDHCPサーバーはMACアドレスを元に固定IPをスタティックに割り振る事が可能です</strong>。</p>\n<h3 id=\"SSL-x2F-TLSインスペクションの対象をDHCPに登録する\"><a href=\"#SSL-x2F-TLSインスペクションの対象をDHCPに登録する\" class=\"headerlink\" title=\"SSL&#x2F;TLSインスペクションの対象をDHCPに登録する\"></a>SSL&#x2F;TLSインスペクションの対象をDHCPに登録する</h3><p>左ペインのネットワークからDHCPのタブをクリックし、<mark class=\"label primary\">Default DHCP Server</mark>をクリックします。そこには、”スタティックIP_MACマッピング”があるので、DHCPで自動リースをしている以外のIPアドレスをスタティックに割り振って登録してください。管理の一例としては以下の通りです。</p>\n<ul>\n<li>証明書を登録できないIoTなどをDHCPで<code>192.168.2.101</code>〜<code>192.168.2.128</code>を動的割り当て</li>\n<li>証明書が登録可能なホストをスタティックIPマッピングで<code>192.168.2.129</code>〜<code>192.168.2.192</code>を固定割り当て</li>\n</ul>\n<p>ここはユーザーの「決め」ですが、上記で証明書がインストール出来るグループを”IPホスト”としてXGに登録しましょう。左ペインの<mark class=\"label primary\">ホストとサービス</mark>から、IPホストのタブをクリックし追加ボタンをクリックします。以下の通り、ホストのIPの範囲を示す名前を入力し、IPの範囲を入力して保存ボタンをクリックします。ここでは、<mark class=\"label primary\">CA_Client_IPv4</mark>として登録する事にします。</p>\n<img src=\"/new-technology/2020/03/20/ssl-inspection1/host1.png\" class=\"\" title=\"alt\">\n\n<h2 id=\"ファイアウォールルールの設定\"><a href=\"#ファイアウォールルールの設定\" class=\"headerlink\" title=\"ファイアウォールルールの設定\"></a>ファイアウォールルールの設定</h2><p>左ペインのルールとポリシーからルールとポリシーを選択します。「<a href=\"/new-technology/2020/03/14/rule-policy2/\" title=\"XG Firewall v18のルールを作成する\">XG Firewall v18のルールを作成する</a>」にて、デフォルトのルール”To_Internet”を作成しました。<mark class=\"label primary\">Traffic to WAN</mark>のグループ配下に”To_Internet”ルールがある事を確認してください。このファイアウォールルールはLANおよびVPNからWANへの接続を許可するシンプルなものですが、今回これは修正しません。XG v18では、SSL&#x2F;TLSインスペクションとファイアウォールルールは互いに独立していて、別メニューで設定する事になります。</p>\n<h2 id=\"SSL-x2F-TLSインスペクションルールの設定\"><a href=\"#SSL-x2F-TLSインスペクションルールの設定\" class=\"headerlink\" title=\"SSL&#x2F;TLSインスペクションルールの設定\"></a>SSL&#x2F;TLSインスペクションルールの設定</h2><p>ここで、SSL&#x2F;TLSインスペクショングループと非SSL&#x2F;TLSインスペクショングループとの明確化を行います。左ペインのルールとポリシーからSSL&#x2F;TLSインスペクションルールをクリックします。</p>\n<ol>\n<li>画面右側の追加ボタンをクリックします</li>\n<li>ルール名を入力します。ここでは”Catch_SSL”とします</li>\n<li>ルールの位置は”最下位”のままにします</li>\n<li>処理は<mark class=\"label primary\">復号化</mark>を選択します</li>\n<li>復号化のプロファイルは<mark class=\"label primary\">Strict Compliance</mark>を選択します</li>\n<li>送信元の送信ゾーンは、”LAN”と”VPN”を選択します</li>\n<li>送信元ネットワークとデバイスは、”任意”を外し、SSL&#x2F;TLSインスペクショングループとして作成した”CA_Client_IPv4”を選択します</li>\n<li>宛先とサービスの宛先ゾーンは、”WAN”を選択します</li>\n<li>最後に保存ボタンをクリックします</li>\n</ol>\n<p>暗号化のプロファイルの<mark class=\"label primary\">Strict Compliance</mark>は一番厳しいものです。左ペインのプロファイルの”復号化のプロファイル”を見てもらうと分かりますが、TLS1.0と1.1を認めないという事です。主要なブラウザは2020年上半期にTLS1.0と1.1を無効化するので、この設定が主流になると予想されます。</p>\n<h2 id=\"XGのCA証明書をクライアントにインストール\"><a href=\"#XGのCA証明書をクライアントにインストール\" class=\"headerlink\" title=\"XGのCA証明書をクライアントにインストール\"></a>XGのCA証明書をクライアントにインストール</h2><p>左ペインの一番下の証明書から、認証局（CA）をクリックします。この中に<mark class=\"label primary\">Security Appliance_SSL_CA</mark>という名前の証明書があります。今回これをクライアントに配布していく事になります。右の下向きの矢印があるダウンロードを選択してクライアントにルート証明書をダウンロードします。<mark class=\"label primary\">Security Appliance_SSL_CA.pem</mark>という名前になります。</p>\n<img src=\"/new-technology/2020/03/20/ssl-inspection1/certificate1.png\" class=\"\" title=\"alt\">\n\n<p>ルート証明書をダウンロードした後、クライアントへのインストールについては、OS毎に手順をそれぞれ確認し設定します。</p>\n<h3 id=\"Windowsにルート証明書をインストール\"><a href=\"#Windowsにルート証明書をインストール\" class=\"headerlink\" title=\"Windowsにルート証明書をインストール\"></a>Windowsにルート証明書をインストール</h3><ol>\n<li><mark class=\"label primary\">プログラムとファイル名の検索</mark>のボックスに<mark class=\"label primary\">MMC</mark>と入力して<mark class=\"label primary\">Microsoft Management Console</mark>を開きます。</li>\n<li><mark class=\"label primary\">ファイル</mark>-<mark class=\"label primary\">スナップインの追加と削除</mark>を選択して\"スナップインの追加と削除\"を開きます。</li>\n</ol>\n<img src=\"/new-technology/2020/03/20/ssl-inspection1/win1.png\" class=\"\" title=\"alt\">\n\n<ol start=\"3\">\n<li>一覧から<mark class=\"label primary\">証明書</mark> を選択して、<mark class=\"label primary\">追加</mark>をクリックすると”スナップインの追加と削除”のウィンドウが開かれます。</li>\n<li><mark class=\"label primary\">コンピュータアカウント</mark>を選択して、<mark class=\"label primary\">次へ</mark>をクリックします。</li>\n<li>ローカルコンピューターがラジオボタンで選択されている事を確認し<mark class=\"label primary\">完了</mark>をクリックします。</li>\n<li>“OK”をクリックして証明書をスナップインに追加すると”スナップインの追加と削除”のウィンドウに<mark class=\"label primary\">証明書（ローカルコンピューター）</mark>が表示されます。</li>\n</ol>\n<img src=\"/new-technology/2020/03/20/ssl-inspection1/win2.png\" class=\"\" title=\"alt\">\n\n<ol start=\"7\">\n<li>証明書（ローカルコンピューター）のコンテナを展開して、<mark class=\"label primary\">信頼されたルート証明機関</mark>を右クリックして、”すべてのタスク &gt; インポート”を選択して証明書インポートのウィザードを開始します。</li>\n<li>証明書インポートのウィザードでは、<mark class=\"label primary\">参照</mark>ボタンをクリックして、拡張子pemを読み込むため<mark class=\"label primary\">すべてのファイル(＊.＊)</mark>を選び、XGからダウンロードした、<mark class=\"label primary\">Security Appliance_SSL_CA.pem</mark>を選択します。</li>\n</ol>\n<img src=\"/new-technology/2020/03/20/ssl-inspection1/win3.png\" class=\"\" title=\"alt\">\n\n<img src=\"/new-technology/2020/03/20/ssl-inspection1/win4.png\" class=\"\" title=\"alt\">\n\n<p>9.<mark class=\"label primary\">信頼されたルート証明機関</mark>としてXGの証明書を登録し完了です。</p>\n<h3 id=\"macOSにルート証明書をインストール\"><a href=\"#macOSにルート証明書をインストール\" class=\"headerlink\" title=\"macOSにルート証明書をインストール\"></a>macOSにルート証明書をインストール</h3><ol>\n<li>iCloud Driveに証明書を配置します</li>\n<li>ローカルドライブに証明書をコピーします</li>\n<li>証明書を開きます。キーチェーンアクセスが起動するので、以下のようにキーチェーンアクセスから証明書を”常に信頼する”設定を加えます</li>\n</ol>\n<img src=\"/new-technology/2020/03/20/ssl-inspection1/mac_ca2.png\" class=\"\" title=\"alt\">\n\n<img src=\"/new-technology/2020/03/20/ssl-inspection1/mac_ca3.png\" class=\"\" title=\"alt\">\n\n<h3 id=\"Linuxにルート証明書をインストール\"><a href=\"#Linuxにルート証明書をインストール\" class=\"headerlink\" title=\"Linuxにルート証明書をインストール\"></a>Linuxにルート証明書をインストール</h3><ol>\n<li>Linux側にsshで接続できる事が前提です。PCなどからscpで証明書をLinuxにコピーします</li>\n</ol>\n  <figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ scp ./SecurityAppliance_SSL_CA.pem linux-host:/tmp/ca.crt</span><br></pre></td></tr></table></figure>\n\n<ol start=\"2\">\n<li>Linux上で証明書をインストールします。</li>\n</ol>\n<p> ubuntu、Debianの場合</p>\n  <figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ sudo <span class=\"built_in\">cp</span> /tmp/ca.crt /usr/local/share/ca-certificates/</span><br><span class=\"line\">$ sudo update-ca-certificates</span><br></pre></td></tr></table></figure>\n<p> CentOS、Fedora、またはRedHatベースのシステムの場合<br>  <figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ sudo <span class=\"built_in\">cp</span> /tmp/ca.crt /etc/pki/ca-trust/source/anchors/</span><br><span class=\"line\">$ sudo update-ca-trust</span><br></pre></td></tr></table></figure><br>※ubuntu20.04で動作確認をしています。</p>\n<h3 id=\"iOSにルート証明書をインストール\"><a href=\"#iOSにルート証明書をインストール\" class=\"headerlink\" title=\"iOSにルート証明書をインストール\"></a>iOSにルート証明書をインストール</h3><p>iOSで「ファイル」アプリを使います。</p>\n<ol>\n<li>iCloud Driveに証明書を配置します</li>\n<li>“ファイル”アプリを起動します。iCloud Driveから証明書ファイルをタップしダウンロードします</li>\n<li>“プロファイルがダウンロードされました”と表示されます</li>\n<li>設定アプリを起動します</li>\n<li>“設定”→”一般”→”プロファイル”と進みます</li>\n<li>ダウンロード済プロファイルに、<mark class=\"label primary\">Sophos SSL CA_xxxx</mark>が表示されているので、タップします</li>\n<li>画面右上の”インストール”をタップします</li>\n<li>iOSのパスコードを入力します</li>\n<li>右上のインストールを再度タップし、インストールを完了します</li>\n<li>“設定”→”一般”→”情報”と進みます</li>\n<li>画面の一番下の”証明書信頼設定”をタップします</li>\n<li><mark class=\"label primary\">Sophos SSL CA_xxxx</mark>が表示されているので、スイッチを右側に移動させオン（緑色点灯）します</li>\n</ol>\n<h2 id=\"Firefoxへの証明書インストール\"><a href=\"#Firefoxへの証明書インストール\" class=\"headerlink\" title=\"Firefoxへの証明書インストール\"></a>Firefoxへの証明書インストール</h2><p>FirefoxはOSの証明書ストアを参照しないため、ブラウザ自身に証明書を取り込む必要があります。ブラウザの設定から以下の通り証明書を取り込みます（ubuntuの例）。</p>\n<img src=\"/new-technology/2020/03/20/ssl-inspection1/firefox.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<h2 id=\"動作確認\"><a href=\"#動作確認\" class=\"headerlink\" title=\"動作確認\"></a>動作確認</h2><p>ブラウザの鍵マークをクリックする事でXGの証明書によって再署名されている事が確認出来ます。XGのログイン後のコントロールセンターの左上にライセンスナンバーが記載されていますが、実際の証明書でもそのナンバーが確認出来ます。</p>\n<img src=\"/new-technology/2020/03/20/ssl-inspection1/installed_cert1.png\" class=\"\" title=\"alt\">\n\n<p>これで証明書のインストールは完了です。この証明書のインストールがXG Firewallの設定で一番大切な部分です。</p>\n<div class=\"note warning\"><p>XGのCA証明書がインストールできないIoT機器をSSL&#x2F;TLSインスペクションの対象とすると、証明書エラーとなり機器が正しく動作しなくなる可能性があります。</p>\n</div>\n\n<p>（2020-09-30追記）<br>iOS14より、Wi-Fiの設定に<mark class=\"label primary\">プライベートアドレス</mark>という項目が追加されています。これはWi-Fiネットワーク毎にMACアドレスを自動的に変更し、匿名性を保つ機能になります。このページでXGのSSL&#x2F;TLSインスペクションを利用する際は、MACアドレスを元にDHCPでいつも同じIPアドレスが配布される仕組みを推奨しています。つまり、このMACアドレスが毎回変わるようだと固定IPを割り当て出来ません。対策としては、自宅のWi-Fiについては<mark class=\"label primary\">プライベートアドレス</mark>をオフにする（推奨）、或いはiOSに最初からスタティックのIPアドレスを割り振る方法があります。Apple社からのプライベートアドレスに関する説明がされています。この機能の目的は以下のようです。</p>\n<blockquote>\n<p>デバイスがすべてのネットワークで常に同じ Wi-Fi MAC アドレスを使っていると、時間の経過に伴い、ネットワークの事業者やその他のネットワーク観測者がそのアドレスをデバイスのネットワーク活動や位置情報に紐付けることがたやすくなります</p>\n</blockquote>\n<p>詳細は以下の記事を参照してください。</p>\n<blockquote>\n<p>Apple -iOS 14、iPadOS 14、watchOS 7 でプライベート Wi-Fi アドレスを使う-<br> <a href=\"https://support.apple.com/ja-jp/HT211227\">https://support.apple.com/ja-jp/HT211227</a></p>\n</blockquote>\n<p>自宅での利用の場合は見知らぬMACアドレスがあると、知らない端末からの接続があったのかとちょっとびっくりしますので、自宅では使用しない選択が良いでしょう。</p>\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"SSLインスペクションについて","url":"/new-technology/2020/03/20/ssl-inspection/","content":"<p class=\"onepoint\">この記事で実現すること</p>\nXG Firewallなどの次世代Firewallで利用されているSSL/TLSインスペクションについて、PCやiPhone等（Windows/macOS/Linux/iOS）を防御する仕組み、および必要となる対応を説明します。\n<span id=\"more\"></span>\n\n<h2 id=\"SSLインスペクションとは\"><a href=\"#SSLインスペクションとは\" class=\"headerlink\" title=\"SSLインスペクションとは\"></a>SSLインスペクションとは</h2><p>https通信では、サーバーとクライアント間がSSLで暗号化されます。SSLというのは本来はTLS（Transport Layer Security）が正しい名称ですが、SSLという言葉が過去より定着しているので、今日でも”SSL証明書”などSSLという言葉は一般的に使われます。この暗号化された通信をIPS（Intrusion Prevension System）は暗号を解読しながらコンテンツの中身の検査を行います。暗号通信の復号化方法として<mark class=\"label primary\">SSL/TLSインスペクション</mark>という方式が採用されています。ここではSSL&#x2F;TLSインスペクションによりどのようにFirewallが暗号化された通信を「正当な方法で」解読するかをシーケンスで説明します。</p>\n<h2 id=\"ブラウザとサーバーのSSL-x2F-TLS通信のシーケンス\"><a href=\"#ブラウザとサーバーのSSL-x2F-TLS通信のシーケンス\" class=\"headerlink\" title=\"ブラウザとサーバーのSSL&#x2F;TLS通信のシーケンス\"></a>ブラウザとサーバーのSSL&#x2F;TLS通信のシーケンス</h2><pre class=\"mermaid\">\nsequenceDiagram\nparticipant cl as クライアント&lt;br&gt;（ブラウザ）\nparticipant sv as Webサーバー\n\ncl -&gt;&gt;+ sv : 1.Webサーバーへの接続\nsv --&gt;&gt;- cl : 2.サーバー証明書と&lt;br&gt;公開鍵を送付\nNote over cl: 3.ルート証明機関でサーバーの証明書の正当性を検証\nNote over cl: 4.一時的な共通鍵を作成し、サーバーの公開鍵で暗号化\ncl -&gt;&gt;+ sv : 5.暗号化された共通鍵を送信\nsv --&gt;&gt;- cl : 6.共通鍵で暗号化されたデータの送信\nNote over cl: 7.共通鍵で復号\n</pre>\n\n<p>上記のようにサーバーは公開鍵をクライアントに渡し、ブラウザ（クライアント）は保持しているルート証明書（ルート証明機関）への照合によってサーバーが正しいURLのものかを判別します。クライアントが生成した共通鍵はサーバーの公開鍵で暗号化されているため、サーバー自身が持つ秘密鍵でなければ解読できません。よって、クライアントとサーバーの間に第三者が割り込んでも電文の中身を解読できません。</p>\n<h2 id=\"Firewallを経由するSSL通信のシーケンス\"><a href=\"#Firewallを経由するSSL通信のシーケンス\" class=\"headerlink\" title=\"Firewallを経由するSSL通信のシーケンス\"></a>Firewallを経由するSSL通信のシーケンス</h2><p>正当な方法として、FirewallのCA証明書を予めクライアントに承認させることで、電文の検査を行う事ができます。実際にhttpsの通信を開始するシーケンスは以下の通りです。</p>\n<pre class=\"mermaid\">\nsequenceDiagram\nparticipant cl as クライアント&lt;br&gt;（ブラウザ）\nparticipant xg as Firewall\nparticipant sv as Webサーバー\n\ncl -&gt;&gt;+ xg : 1.Webサーバーへの接続\nxg -&gt;&gt;+ sv : 2.Webサーバーへの接続\nsv --&gt;&gt;- xg : 3.サーバー証明書と&lt;br&gt;公開鍵を送付\nNote over xg: 4.サーバー証明書に紐づくルート証明書でサーバー証明書の正当性を検証\nxg --&gt;&gt;- cl : 5.FWのサーバー証明書と公開鍵を送付\nNote over cl: 6.FWのルート証明書でFWの証明書の正当性を検証\nNote over cl: 7.一時的な共通鍵を作成し、FWの公開鍵で暗号化\ncl -&gt;&gt;+ xg : 8.暗号化された共通鍵を送信\nNote over xg: 9.FWの秘密鍵で復号化、共通鍵を取得\nNote over xg : 10.共通鍵をWebサーバーの公開鍵で暗号化\nxg -&gt;&gt;+ sv : 11.暗号化された共通鍵を送信\nsv --&gt;&gt;- xg : 12.共通鍵で暗号化されたデータの送信\nNote over xg: 13.共通鍵で復号\nNote over xg: 14.コンテンツの中身の検証\nxg --&gt;&gt;- cl : 15.共通鍵で暗号化されたデータの送信\nNote over cl: 16.共通鍵で復号\n</pre>\n\n<p>FirewallはクライアントとWebサーバーとの間に入り、SSLの解読を行います。クライアントはFirewallが暗号化した電文を解読する事になります。</p>\n<h3 id=\"このシーケンスのポイント\"><a href=\"#このシーケンスのポイント\" class=\"headerlink\" title=\"このシーケンスのポイント\"></a>このシーケンスのポイント</h3><p>Firewallが間に入らない通常のシーケンスにおいては、<strong>間にFirewallが割り込んで共通鍵を取得しようとしてもWebサーバーの秘密鍵を持っていないため、解読できません</strong>。従い、共通鍵を取得するためにFiewallが自分自身の公開鍵をクライアントへ渡しますが、Firewallの独自証明書はクライアント側のルート証明機関の検証によって不正と扱われます。Firewallがセキュリティ対策のための正当なサーバーである事を明示するために、<strong>クライアントにはFirewallのCA証明書を事前に”ルート証明機関”としてインストールしておく必要があります</strong>。クライアントに、FirewallのCA証明書が登録されていない状態でSSLインスペクションを行うと、ブラウザは「信頼されないサイト」として警告を発します。このような仕組みでSSL通信は悪意を持った第三者攻撃を防ぎつつ、ユーザがFirewallのCA証明書を許可する事でSSL検査を可能にしています。</p>\n<div class=\"note info\"><p>SSL&#x2F;TLSインスペクションを行うためには、FirewallのCA証明書を端末毎にインストールする必要があります。</p>\n</div>\n\n<h3 id=\"コンテンツの中身の検証\"><a href=\"#コンテンツの中身の検証\" class=\"headerlink\" title=\"コンテンツの中身の検証\"></a>コンテンツの中身の検証</h3><p>上記シーケンスの14番目がFirewallの大きな役割です。暗号化されたhttpsのデータを解読し、流れるデータの中にさまざまな脅威が無いか検証を行います。</p>\n<h2 id=\"CA証明書のインストール\"><a href=\"#CA証明書のインストール\" class=\"headerlink\" title=\"CA証明書のインストール\"></a>CA証明書のインストール</h2><p>上述した通り、SSL&#x2F;TLSインスペクションを行うためには、FirewallのCA証明書をクライアントにインストールしなくてはなりません。復号化については、以下の端末で検証をしています。</p>\n<ul>\n<li>Windows</li>\n<li>macOS</li>\n<li>iOS</li>\n<li>Linux(ubuntu)</li>\n</ul>\n<p>なお、Androidには証明書はインストール出来ますが、Chrome以外のアプリで証明書を信頼する事が出来ず、実質SSL&#x2F;TLSインスペクションは使えません。他の家電TVなども難しいと考えてください。</p>\n<p>SSL&#x2F;TLSインスペクションを設定後、ブラウザのURLの鍵マークにカーソルを合わせるとそのサイトで利用している本来の認証局ではなく、以下のようにFirewall（この実例ではSophos XG Firewall）の認証局が有効となっている事が分かります。</p>\n<img src=\"/new-technology/2020/03/20/ssl-inspection/ssl-inspection.png\" class=\"\" title=\"alt\">\n\n<h2 id=\"SNIによる接続時検査\"><a href=\"#SNIによる接続時検査\" class=\"headerlink\" title=\"SNIによる接続時検査\"></a>SNIによる接続時検査</h2><p>次世代FirewallでSSL&#x2F;TLSの中身を検査するためにはCA証明書が必要と記載しましたが、URLの宛先サーバーのみのチェックであればSSL&#x2F;TLSインスペクションを利用せずとも可能です。https通信では、最初の接続時にどのサーバーに接続するかの文字列情報をSNI（Server Name Indication）でWebサーバーに通知します。これは平文です。Firewallはこのhttpsの通信開始時に宛先の正当性を検査し、接続を拒否する事が可能です。Firewallが持つURLフィルタ（ドメインフィルタ）機能はどのFirewall製品でも一般的なものですが、これはCA証明書のインストールは不要です。但し電文の中に含まれるマルウェアや脆弱性に対する攻撃などを防ぐには完全な電文の解読が必要です。</p>\n<p>余談ですが、”公衆WIFIでは、httpsを使えば安全”というWebサイト上の記載を見かけます。しかしながら、実際にユーザーがどのWebサイトを閲覧しているかは、こういったSNIの平文やDNSクリエストによって公衆WIFIの提供業者に把握されているのが実態です。</p>\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"XG Firewall v18のSSLインスペクションの動作確認と調整","url":"/new-technology/2020/03/21/ssl-inspection2/","content":"<p class=\"onepoint\">この記事で実現すること</p>\nXG FirewallのSSL/TLSインスペクションが有効に機能している事をテストマルウェアを使い検証します。また、SSL/TLSインスペクションによって接続出来なくなる場合は除外設定を行います。\n<span id=\"more\"></span>\n\n<h2 id=\"SSL-x2F-TLSインスペクションの動作確認\"><a href=\"#SSL-x2F-TLSインスペクションの動作確認\" class=\"headerlink\" title=\"SSL&#x2F;TLSインスペクションの動作確認\"></a>SSL&#x2F;TLSインスペクションの動作確認</h2><p>前回までの記事でXGのSSL&#x2F;TLSインスペクションの設定が完了している事を前提にしています。SSL&#x2F;TLSインスペクションに関する記事は以下を参照してください。</p>\n<ul>\n<li><a href=\"/new-technology/2020/03/20/ssl-inspection/\" title=\"SSLインスペクションについて\">SSLインスペクションについて</a></li>\n<li><a href=\"/new-technology/2020/03/20/ssl-inspection1/\" title=\"XG Firewall v18のSSL&#x2F;TLSインスペクションの設定\">XG Firewall v18のSSL&#x2F;TLSインスペクションの設定</a></li>\n</ul>\n<p>IPS（Intrusion Prevension System）によるSSLインスペクションでの動作確認のため、テストマルウェアの検知について行います。有名どころでは、eicarのテストマルウェアが挙げられます。早速、ダウンロードページにまいりましょう。<strong>eicarのダウンロードページ</strong>に行くと、<mark class=\"label primary\">Download area using the secure, SSL enabled protocol HTTPS</mark>という項目があり、httpsの4つのダウンロードリンクがあります。</p>\n<blockquote>\n<p>eicar<br> <a href=\"https://www.eicar.org/?page_id=3950\">https://www.eicar.org/?page_id=3950</a></p>\n</blockquote>\n<ul>\n<li>実行ファイル</li>\n<li>実行ファイルをtxtに拡張子を変えたもの</li>\n<li>zipに圧縮したもの</li>\n<li>zipの二重圧縮</li>\n</ul>\n<p>実行ファイルについては、マルウェアを検知する前にXGのポリシーによって、実行ファイルをダウンロードできないという表示になる可能性があります。その際はWebのポリシーで修正するか、ルールとポリシーを修正し実行ファイルを一時的に許可し、確認してみて下さい。前回までの記事で記載してきた通り、SSL&#x2F;TLSインスペクションが行えるクライアントと行えないクライアントで挙動は変わります。</p>\n<p>SSL&#x2F;TLSインスペクションが行えるクライアントは、この4つを全て検出し、ブラウザにはXGによるマルウェア検知のエラー画面が表示されます。PCに入っているウィルス対策ソフトが検知する以前にダウンロードは行わない挙動となります。また、SSLインスペクション対象外のクライアントからのアクセスについてはhttpsのダウンロードはマルウェアを検出できず、ダウンロードしてしまいます。</p>\n<p>IPSは速度と検出能力という相反する事を同時に成り立たせなくてはいけません。上記のようにマルウェアの検出は可能ですが、あくまで通信で怪しいものをカットする程度に考え、クライアントにはウィルス対策ソフト（Windows Defenderを含む）やマルウェア対策ソフトの導入をお勧めします。Sophosはホームユーザー向けに無償のウィルス対策ソフトを提供していますが、個人的には異なる会社のソフトを組み合わせて使う事をお勧めします。</p>\n<h2 id=\"SSL-x2F-TLSインスペクションの除外\"><a href=\"#SSL-x2F-TLSインスペクションの除外\" class=\"headerlink\" title=\"SSL&#x2F;TLSインスペクションの除外\"></a>SSL&#x2F;TLSインスペクションの除外</h2><p>XGは、Webフィルターやアプリケーションフィルターなどのポリシーで接続の可否を判断しますが、実はSSL&#x2F;TLSインスペクションが理由で接続できないという問題も発生します。これは以下の通りです。</p>\n<ol>\n<li>TLSが正当ではないと判断される</li>\n<li>XGの証明書がアプリケーションに認められない</li>\n</ol>\n<p>接続できない理由は後述しますが、XGは、XG自身で最初からSSL&#x2F;TLSインスペクションの対象外とするドメインリストを既に保持しています。そのリストになく、自身で利用するサイトやアプリケーションがSSL&#x2F;TLSインスペクションによって動作しない場合は個別に当該ドメインをSSL&#x2F;TLSインスペクションの対象外と指定します。</p>\n<p>XGで最初からSSL&#x2F;TLSインスペクションの対象外となっているリストは、XGの左ペインメニュー<mark class=\"label primary\">web</mark>の”URLグループ”に<mark class=\"label primary\">Managed TLS exclusion list</mark>があり、ここに複数の有名なWebサイトのドメインが列挙されています。</p>\n<img src=\"/new-technology/2020/03/21/ssl-inspection2/exclusion.png\" class=\"\" title=\"alt\">\n\n<div class=\"note warning\"><p>このリストは編集できません。ファームウェアの更新によって管理されます。</p>\n</div>\n\n<h3 id=\"除外設定\"><a href=\"#除外設定\" class=\"headerlink\" title=\"除外設定\"></a>除外設定</h3><p>除外リスト<mark class=\"label primary\">Managed TLS exclusion list</mark>にドメインが列挙されておらず、またポリシー上は利用できるはずのWebサイトに接続できない場合、XGの画面右上のログビューアからSSL&#x2F;TLSインスペクションを選択しSSL&#x2F;TLSインスペクションでエラーが発生していないか確認を行います。Web→URLグループの<mark class=\"label primary\">Local TLS Exclusion List</mark>という個別にカスタマイズ可能なリストがあるので、そのリストにドメインを追加する事でSSL&#x2F;TLSインスペクションの対象外とできます。以下の通り、SSL&#x2F;TLSインスペクションルール画面では、デフォルトの除外リストに<mark class=\"label primary\">Managed TLS exclusion list</mark>および<mark class=\"label primary\">Local TLS Exclusion List</mark>が存在します。<mark class=\"label primary\">Local TLS Exclusion List</mark>の初期状態は何も登録されていません。</p>\n<img src=\"/new-technology/2020/03/21/ssl-inspection2/inspection-rule3.png\" class=\"\" title=\"alt\">\n<img src=\"/new-technology/2020/03/21/ssl-inspection2/inspection-rule4.png\" class=\"\" title=\"alt\">\n\n<h3 id=\"SSL-x2F-TLSインスペクションによって接続できない理由\"><a href=\"#SSL-x2F-TLSインスペクションによって接続できない理由\" class=\"headerlink\" title=\"SSL&#x2F;TLSインスペクションによって接続できない理由\"></a>SSL&#x2F;TLSインスペクションによって接続できない理由</h3><p>SSL&#x2F;TLSインスペクションで接続できない理由の1つ目は、SSL&#x2F;TLS証明書の正当性を厳しくチェックしすぎる場合が該当します。過渡期ではありますが、まだまだ古いバージョンのTLSが利用されていサイトもあります。これを緩める場合は、XGの左ペインメニュー<mark class=\"label primary\">ルールとポリシー</mark>の”SSL&#x2F;TLSインスペクションルール”画面で、SSL&#x2F;TLSインスペクションを行っているプロファイルのルールを緩めるか、”SSL&#x2F;TLSインスペクションの設定”をカスタマイズします。</p>\n<img src=\"/new-technology/2020/03/21/ssl-inspection2/inspection-rule2.png\" class=\"\" title=\"alt\">\n\n<p>もう1つの接続できない理由は、アプリケーション自体が、OSにインストールされた証明書などを認めていないケースです。こちらはアプリケーションの内部に証明書を保持しており、その証明書の正当性を確認しているケースです。以下の例ではpython関連のモジュールをアップグレードするケースで以下のエラーが発生します。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">&gt;pip3 install --upgrade pip</span><br><span class=\"line\"></span><br><span class=\"line\">WARNING: Retrying (Retry(total=4, connect=None, <span class=\"built_in\">read</span>=None, redirect=None, status=None))</span><br><span class=\"line\">after connection broken by <span class=\"string\">&#x27;SSLError(SSLCertVerificationError(1,</span></span><br><span class=\"line\"><span class=\"string\">&#x27;</span>[SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed: unable to get <span class=\"built_in\">local</span> issuer certificate (_ssl.c:1076)<span class=\"string\">&#x27;))&#x27;</span>: /simple/pip/</span><br></pre></td></tr></table></figure>\n\n<p>XGの画面右上にある”ログビューア”から”SSL&#x2F;TLSインスペクション”を選択し、どのURLのSSL&#x2F;TLSインスペクションが行われているのかを確認できます。また、エラーがある場合は、そこで除外を指定する事で自動的に<mark class=\"label primary\">Local TLS Exclusion List</mark>にドメインが追加されます。下記はあくまで一例ですが除外しておいた方が良いドメインを列挙します。追加した証明書を参照しないプロダクトはアプリケーションの挙動とこのログを見ながら手作業で<mark class=\"label primary\">Local TLS Exclusion List</mark>に除外するドメインを追加する作業を行います。</p>\n<table>\n<thead>\n<tr>\n<th>ドメイン</th>\n<th>内容</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>pypi.org, pythonhosted.org</td>\n<td>Python関連</td>\n</tr>\n<tr>\n<td>npmjs.org</td>\n<td>Node.js関連</td>\n</tr>\n<tr>\n<td>github.com</td>\n<td>GitHub</td>\n</tr>\n<tr>\n<td>ubuntu.com,snapcraft.io</td>\n<td>ubuntu関連</td>\n</tr>\n<tr>\n<td>livepatch.canonical.com</td>\n<td>ubuntu関連</td>\n</tr>\n<tr>\n<td>auone.jp, paypay.ne.jp, merpay.com</td>\n<td>〜pay関連</td>\n</tr>\n<tr>\n<td>norton.com</td>\n<td>Norton AntiVirus関連</td>\n</tr>\n<tr>\n<td>d.line-scdn.net</td>\n<td>LINE動画</td>\n</tr>\n</tbody></table>\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"XG Firewall SSL-VPN","url":"/new-technology/2021/05/30/ssl-vpn/","content":"<img src=\"/new-technology/2021/05/30/ssl-vpn/title.png\" class=\"\" title=\"alt\">\n<p class=\"onepoint\">この記事で実現すること</p>\n\n<p>XG FirewallのSSL-VPNを構成し、実家や友人宅または、ホテル滞在時など公衆Wi-FiをはじめとしたさまざまなWi-Fi環境下においてIPSec-VPNよりも接続可能性を高める事を目的にします。SSL-VPNのTCPの待ち受けポートを設定し、自宅がv6プラスの環境でも接続可能となる期待があります。公衆Wi-Fiによく見られるIPv4アドレスのみ払い出しされる環境においても、IPv4 VPNトンネルの中でIPv4&#x2F;IPv6デュアルスタックによるインターネットアクセス、および自宅LANリソースにアクセスできます。</p>\n<span id=\"more\"></span>\n\n<h2 id=\"XG-FirewallのIPSec-VPN\"><a href=\"#XG-FirewallのIPSec-VPN\" class=\"headerlink\" title=\"XG FirewallのIPSec-VPN\"></a>XG FirewallのIPSec-VPN</h2><p>IPSec-VPNは一般的に安全性が高く安定しているため、それが使える場合はまずは最優先候補に挙げられますが、制約があります。</p>\n<ol>\n<li>v6プラスの環境では接続に必要なポートが制限され接続できません（別途PPPoEで接続している場合は可能です）。</li>\n<li>公衆Wi-Fiの一部では最低必要なUDPを除き、UDP全般を止めているところがあります（VPNを禁止していないところでも）。</li>\n<li>公衆WIFIではIPv4のみ提供している場所が多いです。</li>\n</ol>\n<h2 id=\"SSL-VPNについて\"><a href=\"#SSL-VPNについて\" class=\"headerlink\" title=\"SSL VPNについて\"></a>SSL VPNについて</h2><p>Sophosは昨年（2020年10月）に<strong>Sophos Connectクライアント Ver2</strong>を発表し、SSL VPNで接続できるようになりました。またv18 MR3より、SSL-VPNのパフォーマンスが向上しているとの事です。</p>\n<blockquote>\n<p>Sophos Connectクライアント Ver2<br> <a href=\"https://partnernews.sophos.com/ja-jp/2020/10/products/sophos-connect-v2-remote-access-vpn/\">https://partnernews.sophos.com/ja-jp/2020/10/products/sophos-connect-v2-remote-access-vpn/</a></p>\n</blockquote>\n<p>XGのIPSec-VPNの速度と安定性は大変満足していますが、IPv6インターネットに対応しません<sup><strong><a href=\"#note1\">[1]</a></strong></sup>。デュアルスタック環境のWi-Fiに接続した場合、VPNを張ってもIPv4のみがVPNを経由し、IPv6は素のままInternetに出ていきます。また大部分のUDPポートが止められているケースを想定し、IPSec-VPNとは別にSSL-VPNもセットアップしておこうと考えました。前述したSophosのドキュメントでは、”macOSサポートが間も無く予定されていますが”との事ですが、なかなか発表される様子がありません。Big Sur対応で苦労されているんでしょうか。現時点において、IPSec-VPNを補完する<strong>HTTPS接続によるSSL-VPN構成</strong>を考えてみます。</p>\n<h2 id=\"SSL-VPNの構成\"><a href=\"#SSL-VPNの構成\" class=\"headerlink\" title=\"SSL VPNの構成\"></a>SSL VPNの構成</h2><p>ここでは、一般例としてXGとインターネットとの間にホームゲートウェイ（HGW）が配置されている前提です。もちろん、IPv4のみのネットワーク環境でもVPNは構築できます。自宅のパブリックIPアドレスに接続するためにダイナミックDNS(DDNS)としてSophosが提供している<code>myfirewall.co</code>を使います。</p>\n <img src=\"/new-technology/2021/05/30/ssl-vpn/sslvpn2.drawio.png\" class=\"\" title=\"alt\">\n\n<table>\n<thead>\n<tr>\n<th>ネットワーク</th>\n<th>内容</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>IPv4 LAN Segment①</td>\n<td>LANで利用しているIPv4プライベートネットワーク</td>\n</tr>\n<tr>\n<td>IPv6 LAN Segment②</td>\n<td>LANで利用しているIPv6プライベートネットワーク。<code>fdxx:xxxx:xxxx/48</code>を先頭に持つ64ビットPrefixのユニークローカルアドレス（ULA）です。</td>\n</tr>\n<tr>\n<td>IPv4 Session③</td>\n<td>XGのWANに流れるInternet向けのトラフィックです。このセグメントは一般的にプライベートIPで、HGWでNAT変換されます。</td>\n</tr>\n<tr>\n<td>IPv6 Session④</td>\n<td>XGのWANに流れるInternet向けのIPv6トラフィックです。このセグメントは一般的にHGWからDHCPv6またはRouter Advertisement(RA)によって、パブリックIPアドレスが振られます。</td>\n</tr>\n</tbody></table>\n<p>ここまでが通常LANからInternetに接続する構成です。そしてSSL-VPNではIPv4のVPNトンネルを1つ、その中にIPv4セッション、IPv6セッションを張ります。このトンネルを張る事で、XGの物理インタフェースのWAN、LANに加えて仮想のVPNセグメントが設定されます。</p>\n<table>\n<thead>\n<tr>\n<th>ネットワーク</th>\n<th>内容</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>IPv4 SSL VPN Tunnel⑤</td>\n<td>テザリングや公衆Wi-Fiで振られたIPアドレスから、Internetを経由し、XGのWANポートとを結ぶセッション。</td>\n</tr>\n<tr>\n<td>IPv4 VPN Segment⑥</td>\n<td>VPNトンネルの中で作成される仮想IPv4ネットワーク。これはLANとは異なるプライベートIPネットワークアドレスです。</td>\n</tr>\n<tr>\n<td>IPv6 VPN Segment⑦</td>\n<td>VPNトンネルの中で作成される仮想IPv6ネットワーク。これはLANとは異なるULAです。</td>\n</tr>\n</tbody></table>\n<p>仮想のVPNセグメントは、LANとネットワークアドレスを重複させてはいけません。あくまで別のセグメントです。また可能性は低いですが、公衆Wi-FiなどプライベートIPを使う場所でVPNセグメントのプライベートIPと重複し、VPNセッションを張れない可能性があります。<br>私が知る限り、公衆Wi-Fiでは10.x.x.xのネットワークが多く使われるようです。<br>⑤のトンネルが張られると、クライアントでは仮想ネットワークインタフェース<mark class=\"label primary\">Sophos TAP Adapter</mark>がActiveになります。<br> <img src=\"/new-technology/2021/05/30/ssl-vpn/TAP-Driver.png\" class=\"\" width=\"480\" title=\"alt\"></p>\n<h2 id=\"SSL-VPNの事前準備\"><a href=\"#SSL-VPNの事前準備\" class=\"headerlink\" title=\"SSL VPNの事前準備\"></a>SSL VPNの事前準備</h2><ol>\n<li>VPNセッションのためのIPv4ネットワークアドレス（IPの範囲でも可能）を決める</li>\n<li>XGのSSL待ち受けポートを決める</li>\n<li>DDNSのホスト名を決定する</li>\n<li>VPNセッションのためのIPv6 ULAを決める</li>\n</ol>\n<p>XGのSSL-VPNはUDPがTCPの3倍ほど高速ですが、公衆Wi-Fiを使う場合、<strong>安全・安心・確実に接続するにはHTTPS(443&#x2F;TCP)を使う事が手堅いです</strong>。自宅がv6プラスの方はプロバイダーから自宅まで通す事のできるポートの範囲を選定する事になります。</p>\n<p>LANのIPv6は、「<a href=\"/new-technology/2020/04/29/xg-ipv6-2/\" title=\"Sophos FirewallでIPv6の設定を行う（後半）\">Sophos FirewallでIPv6の設定を行う（後半）</a>」の記事で設定したように、ULAの48ビットPrefixにサブネットの16ビットを加えて64ビットPrefixを決定しました。今回のVPNはサブネットの16ビットの値を変える事で別のセグメントを割り当てます。</p>\n<h2 id=\"サーバー（XG）側の設定\"><a href=\"#サーバー（XG）側の設定\" class=\"headerlink\" title=\"サーバー（XG）側の設定\"></a>サーバー（XG）側の設定</h2><h3 id=\"SSL-VPNの設定\"><a href=\"#SSL-VPNの設定\" class=\"headerlink\" title=\"SSL VPNの設定\"></a>SSL VPNの設定</h3><p>XGの管理画面の左ペイン<mark class=\"label primary\">VPN</mark>を選択すると、右上に<mark class=\"label primary\">VPN設定を表示</mark>という項目があるのでこれをクリックします。さらに<mark class=\"label primary\">SSL VPN</mark>と<mark class=\"label primary\">L2TP</mark>のタブがありますので、SSLVPNを選択します。</p>\n<img src=\"/new-technology/2021/05/30/ssl-vpn/vpn-conf.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p>前の章で事前に決めた設定内容を加えていきます。</p>\n<ul>\n<li>赤枠で囲ったTCP&#x2F;UDPの別はTCPとポート番号、そして、<mark class=\"label primary\">ホスト名の上書き</mark>というところはNo-IPなどのダイナミックDNSホスト名を入力します。設定可能なダイナミックDNSについては、「<a href=\"/new-technology/2020/03/28/vpn/\" title=\"XG Firewall VPNについて\">XG Firewall VPNについて</a>」の記事を参照してください。</li>\n<li>IPv4のVPNネットワークの範囲は、LANやその他競合しないと思われるプライベートIP群から設定します。デフォルトの10.xでも構いませんが、あまり使われない、<code>192.168.200.x/24</code>近辺を使ってはいかがでしょうか。</li>\n<li>VPNクライアントが参照するDNSはXGのDNSですので、XGのLAN側IPアドレスを入力します。</li>\n<li>IPv6は利用しているULAの別のサブネットを設定します。<code>fd00:beef:cafe:2::/64</code>をLANで使っているとすれば、<code>fd00:beef:cafe:12::/64</code>という具合です。</li>\n<li>IPv6を利用するのであれば、リースモードを”IPv4とIPv6の両方”を選択します。</li>\n</ul>\n<p>適用をクリックし変更を完了させます。</p>\n<p>もし、VPNの待ち受けポートを443&#x2F;TCPとするならば、ユーザーポータルがデフォルト443&#x2F;TCPですので合わせて変更する必要があります。これは、XGの左ペインメニューの<mark class=\"label primary\">管理</mark>→<mark class=\"label primary\">管理者とユーザーの設定</mark>に<mark class=\"label primary\">ユーザーポータルHTTPSポート</mark>とありますので、そこの443を別のポートに変更します。</p>\n<div class=\"note warning\"><p><mark class=\"label primary\">ホスト名の上書き</mark>にDDNSホストを登録しないとVPN設定ファイルにXGのWANのプライベートIPアドレスが含まれてしまい、VPN接続に大幅に時間が掛かりますので必ず設定してください。XGにパブリックIPアドレスが割り振られている環境の方は設定は不要です。</p>\n</div>\n\n<h3 id=\"利用セグメントのIPホストへの登録\"><a href=\"#利用セグメントのIPホストへの登録\" class=\"headerlink\" title=\"利用セグメントのIPホストへの登録\"></a>利用セグメントのIPホストへの登録</h3><p>XGでは、セグメント間の通信には必ずそのネットワークの名前を登録し、その名前でアクセス許可を行うため、ネットワークやホストの名前を付ける必要があります。左ペインメニューの<mark class=\"label primary\">ホストとサービス</mark>→<mark class=\"label primary\">IPホスト</mark>でVPNとLANの相互アクセスのために、LANで利用しているIPv4のネットワークアドレスとIPv6のネットワークアドレスを登録します。</p>\n<p>また、SSLインスペクションをVPNでも使う方は、VPNで割り当てる上記のIPv4の範囲とIPv6のネットワークアドレスを登録します。</p>\n<p>以下のように、VPNのネットワーク、いつも利用しているLANの合計4つ（IPv4のみであれば2つ）を名前をつけて登録します。</p>\n<img src=\"/new-technology/2021/05/30/ssl-vpn/ipv4host.png\" class=\"\" width=\"800\" title=\"alt\">\n<img src=\"/new-technology/2021/05/30/ssl-vpn/ipv6host.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<h3 id=\"VPNユーザーの作成\"><a href=\"#VPNユーザーの作成\" class=\"headerlink\" title=\"VPNユーザーの作成\"></a>VPNユーザーの作成</h3><p>初めてVPNを設定する方はユーザーの作成が必要です。既にIPSec-VPNを設定されている方は対応不要です。XGの左ペインメニューから<mark class=\"label primary\">認証</mark>を選択、<mark class=\"label primary\">ユーザー</mark>のタブから、追加ボタンをクリックします。そして以下のようにユーザー名、パスワードとメールアドレスを入力します。</p>\n<img src=\"/new-technology/2021/05/30/ssl-vpn/user1.png\" class=\"\" title=\"alt\">\n<img src=\"/new-technology/2021/05/30/ssl-vpn/user2.png\" class=\"\" title=\"alt\">\n\n<h3 id=\"SSL-VPN設定2\"><a href=\"#SSL-VPN設定2\" class=\"headerlink\" title=\"SSL VPN設定2\"></a>SSL VPN設定2</h3><p>左ペインメニューの<mark class=\"label primary\">VPN</mark>から<mark class=\"label primary\">SSL VPN（リモートアクセス）</mark>に進み、<mark class=\"label primary\">追加</mark>ボタンをクリックします。</p>\n<img src=\"/new-technology/2021/05/30/ssl-vpn/vpn-conf2.png\" class=\"\" width=\"640\" title=\"alt\">\n\n<ul>\n<li>名前を決め、<mark class=\"label primary\">ポリシーメンバー</mark>には、ユーザーグループまたはユーザーを追加します。</li>\n<li><mark class=\"label primary\">デフォルトのゲートウェイとして使用</mark>を\"ON\"にします。</li>\n<li>許可するネットワークソースには、上記で作成済みのLANのネットワークアドレスを追加します（VPNのネットワークアドレスではありません）。</li>\n</ul>\n<p>適用をクリックして登録を完了させます。</p>\n<div class=\"note info\"><p>XGをデフォルトゲートウェイとする事で、DNSを含めた全てのリクエスト情報を公衆回線に流さない事をお勧めします</p>\n</div>\n\n<h3 id=\"デバイスのアクセス\"><a href=\"#デバイスのアクセス\" class=\"headerlink\" title=\"デバイスのアクセス\"></a>デバイスのアクセス</h3><p>左ペインメニューの<mark class=\"label primary\">管理</mark>から<mark class=\"label primary\">デバイスのアクセス</mark>に進み、<mark class=\"label primary\">ローカルサービスACL</mark>でWANにSSL VPNの権限を付与します。また、VPNからXGのDNSが参照できるように設定します。</p>\n<img src=\"/new-technology/2021/05/30/ssl-vpn/acl.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p>LANからVPNを張る事が無ければ、LANのSSLVPNのチェックは外した方が良いでしょう。</p>\n<h3 id=\"ファイアウォールルール\"><a href=\"#ファイアウォールルール\" class=\"headerlink\" title=\"ファイアウォールルール\"></a>ファイアウォールルール</h3><p>ファイアウォールルールでは、VPNからInternetとLANへのアクセスを許可します。送信元ゾーンがLANとVPNになっている事を確認します。</p>\n<img src=\"/new-technology/2021/05/30/ssl-vpn/rule1.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p>また、LANとVPNとが相互に許可されている事を確認します。</p>\n<img src=\"/new-technology/2021/05/30/ssl-vpn/rule2.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p>これらはIPv4、IPv6それぞれで設定が必要です。また、NATルールに関しては、WANポートから出ていくパケットが変換対象となるので追加設定は不要です。ただし、XGv17以前の互換性のために用意されているLinkedNATを利用されている方は、ファイアウォールルール毎に対応したリンクNATルールを追加してください。</p>\n<p>もし、VPNに対してもSSLインスペクションを有効にするのであれば、SSL&#x2F;TLSインスペクションのルールにVPNセグメントのネットワーク情報を追加します。</p>\n<img src=\"/new-technology/2021/05/30/ssl-vpn/rule3.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<h2 id=\"ホームゲートウェイの設定\"><a href=\"#ホームゲートウェイの設定\" class=\"headerlink\" title=\"ホームゲートウェイの設定\"></a>ホームゲートウェイの設定</h2><p>HGWはユーザーの環境によって異なりますが、IPsec VPNで設定したように、HGWでIPv4のSSL VPNに関するパケットをXGに着信させる設定を加えます。</p>\n<img src=\"/new-technology/2021/05/30/ssl-vpn/hgw.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<h2 id=\"VPNクライアント（Windows）\"><a href=\"#VPNクライアント（Windows）\" class=\"headerlink\" title=\"VPNクライアント（Windows）\"></a>VPNクライアント（Windows）</h2><p>Windowsでは、Sophos提供のSophos Connectを利用します。クライアントとVPN設定ファイルのダウンロードのために、ユーザーポータル<code>https://xgのIPアドレス:443/</code>にログインします。ユーザーポータルの待ち受けポートを変更された方は443を適切な値に変更してアクセスしてください。</p>\n<img src=\"/new-technology/2021/05/30/ssl-vpn/portal.png\" class=\"\" width=\"480\" title=\"alt\">\n\n<p>赤枠で囲った”Download client for Windows”のリンクをクリックします。Windowsクライアントのセットアップは難しくありません、順に進めていけば完了します。セットアップが完了するとプロセスがタスクバーに常駐します。<br>続いて、”その他のOS向け設定のダウンロード”を行います。ここでは拡張子ovpnのファイルがダウンロードされます。ダウンロードしたファイルをダブルクリックすると、VPN設定ファイルがSophos Connectに取り込まれます。</p>\n<img src=\"/new-technology/2021/05/30/ssl-vpn/sc1.png\" class=\"\" width=\"480\" title=\"alt\">\n\n<p>少し判りづらいですが、Homeの項目がIPSec-VPNでmyfirewall.coのものがSSL-VPNです。</p>\n<p>ユーザーIDとパスワードを入力し、接続ボタンをクリックすると接続に掛かる時間は12秒程度でしょうか、IPSec-VPNが2〜3秒程度なので、結構時間が掛かる気がします。</p>\n<img src=\"/new-technology/2021/05/30/ssl-vpn/sc2.png\" class=\"\" width=\"480\" title=\"alt\">\n\n<p>このSophosConnectはアプリケーションの作りが洗練されていません。一旦接続しにいくと、キャンセルをクリックしようとしてもボタンが押せず、タイムアウトが発生するまで、十数秒〜数十秒くらい待たされてしまいます。Sophos Connectの<strong>紹介記事</strong>ではmacOS向けに<strong>OPENVPN Connect</strong>を勧めていますが、OPENVPN Connectは、Windows版もあります。OPENVPN ConnectではVPNの接続ネゴシエーション中にキャンセルすると即座にVPNサーバーに対しRSTを送信すると共に、瞬時にUIもキャンセル応答します。このあたりは流石デファクトスタンダードというところでしょうか。もちろん、正しくセションを終了した時は行儀良くFINを送信し接続終了しています。IPSec-VPNとSSL-VPNとで2つのクライアントを持つのが嫌でなければ、操作性でシンプルなOPENVPN Connectのほうが使い勝手が良いでしょう。設定もovpnファイルを取り込むだけでそれ以外の設定はありません。</p>\n<blockquote>\n<p>Sophos Connect<br> <a href=\"https://partnernews.sophos.com/ja-jp/2020/10/products/sophos-connect-v2-remote-access-vpn/\">https://partnernews.sophos.com/ja-jp/2020/10/products/sophos-connect-v2-remote-access-vpn/</a><br>OPENVPN Connect<br> <a href=\"https://openvpn.net/vpn-client/\">https://openvpn.net/vpn-client/</a></p>\n</blockquote>\n<img src=\"/new-technology/2021/05/30/ssl-vpn/openvpn.png\" class=\"\" width=\"480\" title=\"alt\">\n\n<h2 id=\"VPNクライアント（macOS）\"><a href=\"#VPNクライアント（macOS）\" class=\"headerlink\" title=\"VPNクライアント（macOS）\"></a>VPNクライアント（macOS）</h2><p>macOSはOPENVPN Connectがお勧めされているわけですが、私は<strong>Tunnelblick</strong>をお勧めします。こちらはオープンソースでGNU GPLv2です。UIが少し古いかなという印象はありますが、日本語に翻訳されており細かい設定が可能で詳細なログも分かり易いのでエンジニア向けです。設定は2箇所あります。</p>\n<blockquote>\n<p>Tunnelblick<br> <a href=\"https://tunnelblick.net/\">https://tunnelblick.net/</a></p>\n</blockquote>\n<img src=\"/new-technology/2021/05/30/ssl-vpn/tunnelblick.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<ul>\n<li>IPv6無効のチェックを外しIPv6を有効にする</li>\n<li>不意の切断時に「ネットワーク接続を切断する」を選択する</li>\n</ul>\n<p>この2つの設定を加えます。後者はいつの間にかVPNセションが切れていてVPNを通さず公衆Wi-Fiを使っていた、という事が無くなり、ピタリとアクセスが止まります。安全措置として良い機能です。</p>\n<p>macOS Big Surではインストールに少し手間が掛かるようです。詳細は以下の記事を参照してください。</p>\n<blockquote>\n<p>Installing System Extensions<br> <a href=\"https://tunnelblick.net/cKextsInstallation.html\">https://tunnelblick.net/cKextsInstallation.html</a></p>\n</blockquote>\n<p>これら2つのクライアントは、Homebrewからもインストール可能です。<br><code>brew install openvpn-connect --cask</code><br><code>brew install tunnelblick --cask</code></p>\n<p>Tunnelblickは前述した接続キャンセル時の応答性も機敏です（RST送信と即座のUI応答）。</p>\n<h2 id=\"VPNクライアント（その他）\"><a href=\"#VPNクライアント（その他）\" class=\"headerlink\" title=\"VPNクライアント（その他）\"></a>VPNクライアント（その他）</h2><p>スマホ、Linux向けにも、OPENVPN Connectがあります。設定ファイルの取り込みは、クラウド経由やメールの添付などの方法でアプリに渡します。</p>\n<h2 id=\"ワンタイムパスワード\"><a href=\"#ワンタイムパスワード\" class=\"headerlink\" title=\"ワンタイムパスワード\"></a>ワンタイムパスワード</h2><p>XGではSSL-VPNにおいても2要素認証の設定が可能ですので設定される事をお勧めします。「<a href=\"/new-technology/2020/03/28/vpnotp/\" title=\"XG Firewall VPNに2要素認証を設定する\">XG Firewall VPNに2要素認証を設定する</a>」の記事を参照してください。XGにおけるVPN-SSLのワンタイムパスワードはパスワードの文字列に続けてOTPの数字6文字を入力する事で2要素認証を行います。パスワードが”abcdef”でOTPが”123456”ならば、パスワードに”abcdef123456”を入力します。</p>\n<p> <small id=\"note1\"><strong>[1]</strong><br>IPSecによるサイト間接続VPNはIPv6に対応しています。クライアントからのリモートアクセスとしてのIPSecはIPv6未対応です。<br></small></p>\n","categories":["Security","VPN"],"tags":["XG Firewall"]},{"title":"Ubiquiti UniFiの世界","url":"/new-technology/2022/08/27/ubiquiti-unifi/","content":"<img src=\"/new-technology/2022/08/27/ubiquiti-unifi/title.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p class=\"onepoint\">この記事で実現すること</p>\n\n<p>米国Ubiquiti（ユビキティ）社のネットワーク製品群であるUniFiを紹介します。Ubiquiti社はAppleにも在籍経験のあるロバートJ・ペラ氏が立ち上げた会社でWi-Fiネットワークの製品に強みを持っています。NY証券取引所にも上場しており、ビジネス向けのネットワーク機器販売が主力のビジネスです。<br>Ubiquitiにもいくつか製品群があり、このうちUniFiという製品群では、ネットワーク、監視カメラ、入退室管理などの製品があります。法人向けと個人向けのちょうど中間に位置するこの製品群は、ビジネスグレードという位置付けながら廉価です。Ubiquti製品群でも上級者向けのEdgeMaxシリーズがあり、初級者〜中級者向けをターゲットとしているのがUniFiです（ネットワークの知識は必要です）。ここではネットワーク製品のうちスイッチとWi-Fiにフォーカスを当ててどのような機能・サービスがあるのか説明していきます。ペラ氏はカリフォルニア大学において日本語の学士号を保有されており、親近感を覚えます。</p>\n<span id=\"more\"></span>\n\n<h2 id=\"UniFi製品の特徴\"><a href=\"#UniFi製品の特徴\" class=\"headerlink\" title=\"UniFi製品の特徴\"></a>UniFi製品の特徴</h2><p>UniFiはネットワークの「見える化」をテーマとした製品群と言えます。複数のネットワーク機器や個々の端末を集中管理することに長けています。代表的なのは特にWi-Fiですが、クライアントの通信量や電波の届き具合、通信量、どこのアクセスポイントに接続されているか把握・管理が容易です。ネットワークスイッチも同様でネットワークトポロジーが明瞭で設定内容やトラフィック量が把握できます。インターネットに接続するルーターの役目を果たすセキュリティゲートウェイはどのようなサイトに接続しているか、どれくらいのトラフィック量なのかが非常に見やすくなっています。また、直感的に分かりやすいGUIによる管理が可能で、難しい従来のコマンドラインは必要ありません（※詳細の情報把握にSSHでコマンド確認することも可能です）</p>\n<p>カメラや電話などのネットワーク製品を除いた、UniFiにおけるコアネットワーク製品を管理するためにはUniFi OS Consoleが必要です。</p>\n<h3 id=\"UniFi-OS-Console\"><a href=\"#UniFi-OS-Console\" class=\"headerlink\" title=\"UniFi OS Console\"></a>UniFi OS Console</h3><img src=\"/new-technology/2022/08/27/ubiquiti-unifi/console.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p>UniFi OS ConsoleはUniFi環境において必ず1つ必要なものです。Wi-Fi機器やネットワーク機器はコントロールのためのGUIなど持ち合わせていないため、GUI管理のためのConsoleが必要となります。セキュリティゲートウェイである、UniFi Dream Machine(UDM)やUDM Proはセキュリティゲートウェイと各ネットワーク機器を管理するConsole機能を持ちます。Dream Machineはセキュリティゲートウェイ、Wi-Fi（日本では11ac対応）、Consoleとが一体になっています。UDM Proは、Wi-Fiの機能は持ちませんが、LAN&#x2F;WANに10GbE SFP+を持ち、IDS(侵入検知システム）&#x2F;IPS(侵入防止システム）のスループットが3.5Gbpsあります（iperf3で計測しているとの記載があります）。</p>\n<p>残念ながら、私はUniFiのセキュリティゲートウェイであるDream MachineやUDM Proを保有していないので、ここでUniFiの魅力的な製品の1つであるセキュリティ製品の説明ができません。私の場合、IPv6やセキュリティなど多くのことを求めるというのもありますが、日本の環境におけるMAP-EやDS-Liteに対応していないように見えます。UDM ProなどはIPv6 Delegationに対応しており魅力的ですが、日本においてはプロバイダを選ぶ（具体的にはフレッツなどでひかり電話を契約し&#x2F;56などの複数のIPv6プレフィックスの割り当てが必要）ことになり、かなり利用環境が限定されます。私自身、セキュリティを担保するルーターにはこのブログでも紹介しているSophos Firewallと現在のプロバイダ（auひかり）に非常に満足しているため、購入には至っておらずここではUniFiのセキュリティルーターの紹介ができません。どうぞご容赦ください。日本でもUDM Proを動作させているユーザーもいらっしゃるようです。もし、UniFiの監視カメラなどを導入されたい場合は、ハードディスクをセッティングする必要がありUniFiの専用ハードウェアが必要です。この場合は、UDMシリーズや後述するCloud Key Gen2 Plusを導入する必要があります。</p>\n<p>なお、セキュリティゲートウェイの機能という意味ではUDMやUDM ProはIDS&#x2F;IPS、DPI（ディープパケットインスペクション）の機能を持ち、DNSフィルタやパケットのシグネチャを検査する仕組みを持っています。DPIは通信するPort番号に関わらず、TCP通信のデータの中身を見てそれが何のアクセスデータか分類したり脅威分析を行いますが、暗号化されたSSL&#x2F;TSL通信を解読できません。今日では、AWS&#x2F;Akamai&#x2F;CloudflareなどのCDN（コンテンツデリバリネットワーク）が台頭してきており、接続先のサーバー名だけでは容易に安全性の判断ができなくなってきています。SSL&#x2F;TLSの解読にはSophos FirewallなどのSSL&#x2F;TLSインスペクションの機能を持つ製品が必要です。セキュリティゲートウェイではVPNはPPTP、L2TPに加え、最近Teleport VPNに対応しています。</p>\n<blockquote>\n<p>UDM Pro<br> <a href=\"https://jp.store.ui.com/collections/UniFi-network-UniFi-os-consoles/products/udm-pro\">https://jp.store.ui.com/collections/UniFi-network-UniFi-os-consoles/products/udm-pro</a><br> <img src=\"/new-technology/2022/08/27/ubiquiti-unifi/udmpro.png\" class=\"\" width=\"480\" title=\"alt\"></p>\n</blockquote>\n<blockquote>\n<p>Dream Machine<br> <a href=\"https://jp.store.ui.com/collections/UniFi-network-UniFi-os-consoles/products/UniFi-dream-machine\">https://jp.store.ui.com/collections/UniFi-network-UniFi-os-consoles/products/UniFi-dream-machine</a><br> <img src=\"/new-technology/2022/08/27/ubiquiti-unifi/udm.png\" class=\"\" width=\"240\" title=\"alt\"></p>\n</blockquote>\n<p>UniFi OS Console単体機能として、Cloud Keyという製品もあります。</p>\n<p>Cloud Key Gen2は25,000円ほどしますが、監視カメラを導入する場合は必要です。予め1TBのHDDが用意されているので特に難しいセットアップは不要でUniFiの運用を開始できます。</p>\n<blockquote>\n<p>Cloud Key Gen2 Plus<br> <a href=\"https://jp.store.ui.com/collections/UniFi-network-UniFi-os-consoles/products/UniFi-cloudkey-gen2-plus-1\">https://jp.store.ui.com/collections/UniFi-network-UniFi-os-consoles/products/UniFi-cloudkey-gen2-plus-1</a><br> <img src=\"/new-technology/2022/08/27/ubiquiti-unifi/cloudkey.png\" class=\"\" width=\"240\" title=\"alt\"></p>\n</blockquote>\n<p>UniFi OS Consoleを購入しなくとも、WindowsやmacOSでUniFi Network Applicationをセットアップできます。別途、Java8のインストールが必要です。もし、仮想環境のESXiをお持ちであれば（一定のネットワークの知識があることが前提です）、ESXi上にUbuntuなどを導入し、そこにUniFi Network Applicationをセットアップできます。ネットワークアプリケーションのロールバックはサポートされておらず、旧バージョンを再インストールするか、ESXiによるバックアップからロールバックすることになります。UniFi本来のメリットを享受するためには見える化が大事ですから24時間365日の稼働とトラフィック収集が重要です。もちろんカジュアルユーザーは設定変更時だけ都度PCを起動し、UniFi Network Applicationを起動し、設定変更する方法もあります。</p>\n<p>自分でUniFi Network Applicationをセットアップする場合は自身で用意するハードウェア以外の費用はかかりません。UniFiソフトウェアは無償ですし、サブスクリプションなどの定額支払いもありません。Linuxの場合、最低2GByteのメモリ、HDDは最低10Gバイトが必要です。私はUbuntu Desktop上に構築しており、4Gバイトのメモリ、HDDは40Gバイトにしています。UniFiのセットアップやバージョンアップにGUIは不要ですが、ハードウェアスペックに余裕のある方はGUI(Ubuntu Desktop)をお薦めします。</p>\n<blockquote>\n<p>UniFi Help Center<br> <a href=\"https://help.ui.com/hc/en-us/articles/360012282453-UniFi-Network-Self-Hosting-your-UniFi-Network-Without-a-Console-Advanced-\">https://help.ui.com/hc/en-us/articles/360012282453-UniFi-Network-Self-Hosting-your-UniFi-Network-Without-a-Console-Advanced-</a></p>\n</blockquote>\n<h3 id=\"UniFiの管理画面\"><a href=\"#UniFiの管理画面\" class=\"headerlink\" title=\"UniFiの管理画面\"></a>UniFiの管理画面</h3><p>UniFiの管理画面は新旧の2種類あります。旧画面は日本語にも対応していますが、最新機器の製品名が表示されないなどちょっと中途半端な対応状況です。デザイン的にも少し洗練された新画面はまだまだ機能が不足しているというデメリットもあり、ユーザーも好みによって使い分けているというのが現状です。</p>\n<p>新画面の抜粋</p>\n<img src=\"/new-technology/2022/08/27/ubiquiti-unifi/unifi1.png\" class=\"\" width=\"1024\" title=\"alt\">\n<img src=\"/new-technology/2022/08/27/ubiquiti-unifi/unifi2.png\" class=\"\" width=\"1024\" title=\"alt\">\n<img src=\"/new-technology/2022/08/27/ubiquiti-unifi/unifi3.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p>旧画面</p>\n<img src=\"/new-technology/2022/08/27/ubiquiti-unifi/unifi4.png\" class=\"\" width=\"1024\" title=\"alt\">\n<img src=\"/new-technology/2022/08/27/ubiquiti-unifi/unifi5.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<h3 id=\"スマホアプリ\"><a href=\"#スマホアプリ\" class=\"headerlink\" title=\"スマホアプリ\"></a>スマホアプリ</h3><p>UniFiの管理システムはハイブリッドクラウドのような仕組みがあり、無償で利用できます。完全なオンプレミスも可能ですが、外出先から自宅内のネットワーク機器を手軽にコントロールできるのは魅力的です。</p>\n<p>特にスマホアプリから行うWi-Fi機器やスイッチ機器のモニタリング、設定変更が容易で秀逸です。コントローラは2要素認証に対応しており、自宅でコントローラにログインすると、スマホにPush通知が来ますのでこれに応答することによりログインが完了します。アプリからはLANの直接接続、或いはUbiquitiのクラウド経由で自宅のConsoleまたはネットワークアプリケーションと接続されますが、クラウド経由の場合でも自宅のFirewallやルーターで特定のPortで待ち受ける（Port解放する）ことなく、UniFi Console（ネットワークアプリケーション）側からUbiquitiのクラウドへ接続する形態です。セキュリティ的にも一段レベルが上で、ダイナミックDNSなどの準備が不要であることが特徴です。</p>\n<p>UniFi Networkアプリ（iOS&#x2F;Android)<br>UniFiのシングルサインオンアカウントを使ってスマホアプリにログインします。自宅内でも自宅外であってもVPNなど意識することなく簡単かつ素早くUniFi機器の管理ができます。</p>\n<img src=\"/new-technology/2022/08/27/ubiquiti-unifi/app1.png\" class=\"\" width=\"360\" title=\"alt\">\n<img src=\"/new-technology/2022/08/27/ubiquiti-unifi/app2.png\" class=\"\" width=\"360\" title=\"alt\">\n<img src=\"/new-technology/2022/08/27/ubiquiti-unifi/app3.png\" class=\"\" width=\"360\" title=\"alt\">\n\n<p>新しい機器をスイッチポートに接続する際にはどのVLANに属するか設定しますが、この場合はスマホアプリからConsoleを経由し大抵のことができます。SFP＋のDDM(Digital Diagnostic Monitoring)の値も取れますし、スイッチによっては機器本体の温度も把握できます。</p>\n<p>このスマホアプリではARという機能があり、UniFiスイッチの第2世代以降は以下のビデオのようにスマホで実際のスイッチ機器をかざすことによって接続された端末がVR的にマッピングされたものを見られます。UniFiスイッチを一躍有名にした機能でもあります。</p>\n<video src='ar.mov' type='video/mp4' controls='controls'  width='45%' height='45%'>\n</video>\n\n<p> UI Verifyアプリ（iOS&#x2F;Android)<br> これはConsoleやUbiquitiのサイトにログインする際の2要素認証のためのワンタイムパスワードのスマホアプリです。</p>\n<img src=\"/new-technology/2022/08/27/ubiquiti-unifi/verify1.png\" class=\"\" width=\"360\" title=\"alt\">\n\n<p>これを導入してシングルサインオンの設定をしておくとPCなどからログインした際にはプッシュ通知がされます。</p>\n<img src=\"/new-technology/2022/08/27/ubiquiti-unifi/verify2.png\" class=\"\" width=\"360\" title=\"alt\">\n\n<p>これで2要素認証も簡単に対応できます。</p>\n<h3 id=\"その他管理\"><a href=\"#その他管理\" class=\"headerlink\" title=\"その他管理\"></a>その他管理</h3><ul>\n<li><p>Syslog&#x2F;SNMP<br>UniFi Console、各機器それぞれが統合管理されるので、1箇所のSyslogサーバにログを書き出せます。あくまでsyslogなので、UniFiシステムの障害切り分けに使うレベルのものです。また、SNMPv3の管理機能を持ちます。</p>\n</li>\n<li><p>SSH<br> スイッチの詳細情報を確認できます、パスワード認証、公開鍵認証が可能です。私はYubicoのYubiKeyで公開鍵認証を使っています。</p>\n</li>\n<li><p>バックアップ<br> 構成情報を定期的にバックアップできます。</p>\n</li>\n<li><p>通知<br> メール、アプリにイベントを通知できます。ファームウェア更新の通知（自動更新も可能）、スイッチやWi-Fiを対象にすればクライアント（インタフェース）の新規接続、切断、ローミングが通知されます。他にもリスク管理の通知機能があります。</p>\n</li>\n</ul>\n<h3 id=\"オンラインストア\"><a href=\"#オンラインストア\" class=\"headerlink\" title=\"オンラインストア\"></a>オンラインストア</h3><p>UniFi製品は日本のオンラインストアがあります。製品はワールドワイドに展開されていますが、ONUと接続する可能性のあるセキュリティゲートウェイや電波を出すWi-Fi製品は技適マークもありますし、ネットワークスイッチの電源コードはPSEマークも付与されており安心して購入できます（電源ケーブルは3PINとなっており、日本のコンセントに合うように2PIN変換アダプタが別途必要です）。</p>\n<blockquote>\n<p>Ubiquit Japan Store<br> <a href=\"https://jp.store.ui.com/\">https://jp.store.ui.com</a></p>\n</blockquote>\n<p>世界的にはUbiquitiの製品・パーツは非常に廉価です。日本においては今年に円安のため2回ほど価格改定があり、以前と比べると特別廉価とは感じなくなっています。</p>\n<ul>\n<li>MMモジュール（10Gbpsマルチモード光学モジュール）2つで6,282円</li>\n<li>10GSFP+ RJ45モジュール9,092円</li>\n</ul>\n<p>日本のサイトでは今のところ送料が無料です。UbiquitiのMMモジュールは様々な機器に繋いでいますが、特段問題が発生したことはありません。UbiquitiのスイッチではSFP&#x2F;SFP+の互換性の問題が出やすいため、純正のMMモジュールまたは信頼のあるSFPベンダーからの購入をお勧めします。</p>\n<p>ケーブルに関してはUbiquitiの純正のOM3ケーブルは部屋と部屋とを繋ぐにしては短すぎるものばかりなので別途FSやAmazonなどで調達する必要があります。</p>\n<p>UbiquitiのRJ45ケーブル（Cat6)はコネクタ付近で曲げることができるユニークなパッチケーブルです。基本的にCat6Aはなく、Cat6のケーブルのみの取り扱いですが、最大8メートルのパッチケーブルであれば10GbEでも問題が出ることはありません。</p>\n<img src=\"/new-technology/2022/08/27/ubiquiti-unifi/cat6.png\" class=\"\" width=\"280\" title=\"alt\">\n\n<h3 id=\"ネットワークスイッチ\"><a href=\"#ネットワークスイッチ\" class=\"headerlink\" title=\"ネットワークスイッチ\"></a>ネットワークスイッチ</h3><p>ここ数ヶ月、このブログでは省電力化および低発熱を目的としてSFP＋の説明をしてきましたが、UniFiスイッチを簡単に紹介します。</p>\n<p>UniFiスイッチはL2の製品群が主流です。設定はGUIのみで行います。SSHでスイッチに接続し、設定変更は行えますが再起動のタイミングにおいて、GUIで設定した内容に上書きされます。見える化やスイッチ全体の一括管理のために、全てのスイッチをUniFiのものに統一したくなりますが、部分的にUniFiスイッチを導入できます。UniFiスイッチはハードウェア自体は一般的なL2スイッチとあまり違いは無いので異なるメーカーのL2スイッチをUniFiスイッチに接続し、VLANで相互に運用できます。</p>\n<p>個人で利用する場合、無理にVLANを切る必要もありませんが、マルチプルVLANも対応しているので、1つのネットワークアドレスで複数のVLANに属する形を取ればネットワーク分離も簡単に行えます。</p>\n<p>一部の製品にはL3に対応したスイッチも存在しますが、IPv6に対応していないことや、アクセスコントロール（ACL）が行えないというものであり、L3としてはまだ使えるレベルには達していません。</p>\n<h4 id=\"USW-Aggregation\"><a href=\"#USW-Aggregation\" class=\"headerlink\" title=\"USW-Aggregation\"></a>USW-Aggregation</h4><img src=\"/new-technology/2022/08/27/ubiquiti-unifi/USW-Aggregation.png\" class=\"\" width=\"280\" title=\"alt\">\n\n<p>ファンレスL2スイッチです。SFP＋ポートを8つ持ちます。小規模なネットワークにも向いていますが、アグリゲーションという名前が付くだけあって、本来はいくつかのスイッチを束ねる目的のスイッチでもあります。MikroTikの8Portスイッチと値段も同程度でもあり、良く比較される対象になっています。奥行きは短いですが、基本は19インチラックに合うように作られているので結構幅があります。あまりIT機器のようにも見えないデザインでもあり、リビングに単独で置いても違和感はありません。</p>\n<h4 id=\"USW-Pro-Aggregation\"><a href=\"#USW-Pro-Aggregation\" class=\"headerlink\" title=\"USW-Pro-Aggregation\"></a>USW-Pro-Aggregation</h4><img src=\"/new-technology/2022/08/27/ubiquiti-unifi/USW-Aggregation-PRO.png\" class=\"\" width=\"280\" title=\"alt\">\n<p>L3スイッチです。10G SFP＋ポートを28ポート、および25G SFP28ポートを4ポート持っています。私は寝室にあるクローゼットにこのスイッチを置いており、ファンの音はしますが、クローゼットのドアを閉めれば全く気にならない程度で静音といえます。L3は前述したように本来のL3としては制約がありますが、セグメント超えのiperf3を実行しても殆どスループットは落ちません。ここはさすがL3スイッチです。</p>\n<h4 id=\"USW-Enterprise-8-PoE\"><a href=\"#USW-Enterprise-8-PoE\" class=\"headerlink\" title=\"USW-Enterprise-8-PoE\"></a>USW-Enterprise-8-PoE</h4><img src=\"/new-technology/2022/08/27/ubiquiti-unifi/USW-Enterprise-8-PoE.png\" class=\"\" width=\"280\" title=\"alt\">\n<p>L3スイッチです。Enterpriseという割には小ぶりでリビングに似合いそうなスイッチです。SFP＋を2ポート、2.5GbE（1GbE、100Base）のRJ45ポートを8ポート持ちます。ファンの音は殆どわかりません。実際にフロントのLCDパネルでファンの回転数を引き上げられ、その際はさすがにファンの音はするものの、やがて自動運転ではかなりの抑えた風量に戻るようです。米国ではTVとかオーディオなど色々な専用セグメントが必要だったりするのでL3が必要なのでしょうか。これはPoEスイッチでもあり、UniFiの世界では小型スイッチやWi-FiがPoE、つまりLANケーブル1本で通信と給電とが行われます。家が小さい日本ではあまり馴染みがないテクノロジですが、アメリカのように大きい家ではLANケーブル1本で各部屋まで配線し、天井や壁にWi-Fiやスイッチを埋め込む形でLANを構築していく事が多いのでPoEが重宝されます。RJ45の8ポートが2.5GbEであると同時にPoEによる給電が可能です。かなりの発熱で筐体上部は50℃ほどあり、コンソールからは70℃以上の熱を示しています。この温度であればファンが回っても良さそうな雰囲気ですが、LCDパネル上のファン回転数は80rpmで静かです。普段の運用ではファンが回るイメージがありません。</p>\n<h4 id=\"Switch-Flex-Mini\"><a href=\"#Switch-Flex-Mini\" class=\"headerlink\" title=\"Switch Flex Mini\"></a>Switch Flex Mini</h4><img src=\"/new-technology/2022/08/27/ubiquiti-unifi/USW-Flex-Mini.png\" class=\"\" width=\"280\" title=\"alt\">\n\n<p>小型の1G RJ45を5ポート持つ小型スイッチです。4,794円と廉価です（最近の円安で値上がりしました）。UniFiではトランクポートとして設定する場合、複数のVLANを選択しグループ化しますが、トランクポートは全てのVLANが対象となる制約があります。一応L2対応になっています。洗練されたデザインで小型のこのスイッチは発熱が小さく安定しており気に入ってます。しかし、気に入っている割には無造作にマジックテープを裏面にべったり貼り付け、TVの後ろに貼り付けています。PoEの入力が可能なので、PoEスイッチから電源を取っていますが、はっきり言ってこのスイッチの電源をPoEで取ることに関してはメリットは殆ど感じられません。最初から小さい電源アダプタも付属していますので普通にコンセントから給電すれば済みます。100Base-TXのLANを持つテレビなどは目立たないこのスイッチに集約させ、多くの長いLANケーブルから解放されるのに便利です。3,700円でUniFiの世界をテストドライブしてみるのも良いかもしれません。</p>\n<h3 id=\"Wi-Fi\"><a href=\"#Wi-Fi\" class=\"headerlink\" title=\"Wi-Fi\"></a>Wi-Fi</h3><p>米国ではUniFiのWi-Fiシステムは非常に多くの製品が発売されていますが、日本で販売されている利用可能な製品はWi-Fi5、Wi-Fi6の有線接続を必須とする数製品に絞られます。日本のメーカーとは異なった魅力のあるアクセスポイント（AP）です。主流の11ax対応製品については、3製品あります。Lite、Pro、LR（ロングレンジ）になります。日本においては、発売予定という製品はあるものの、現時点ではワイヤレスメッシュとなる製品が発売されていません。つまり中継機の機能を持つ製品が日本では発売されていません。</p>\n<img src=\"/new-technology/2022/08/27/ubiquiti-unifi/U6-Pro1.png\" class=\"\" width=\"280\" title=\"alt\">\n\n<p>基本的に壁に固定し、LANケーブルのPoEから電源を取ります。これまでのWi-Fiルータを棚やテーブルに置くという方法ではなく、電源コンセントの制約が無いため、自由度が高く、壁などに取り付けられます。APの設置は壁にねじ止めするのが本来の姿ですが、小心者の私は100均で売っている壁にメモを留めるようなピンを打ち付けてAPを固定しています。APを取り外した後も壁紙の補修液を塗り込めば壁の穴は目立ちません。</p>\n<p>UniFiのWi-Fi製品は、ネットワークスイッチのPoEまたはPoEインジェクタを別途購入し接続することになります。</p>\n<img src=\"/new-technology/2022/08/27/ubiquiti-unifi/poe.png\" class=\"\" width=\"280\" title=\"alt\">\n\n<p>壁掛けで1本のLANケーブルのみであれば部屋に馴染み、さほど気になるものでもありません。<br>Fast Roaming(802.11r)を前提として、APの切り替えがスムーズに行えます。一般的には端末を持つ人が移動した時のローミングを目的としていますが、家族が普段通りにスマホを使っていながら接続APを切り替えられます。私の場合、自宅の1階にU6-Proを、2階にU6-Liteを設置していますが、どちらのAPからも家じゅう電波は届きます。APの故障対策のためというよりは、私が色々なことをやってAPやスイッチの設定を変更したりリブートしたりするので、自宅内で家族向けに安定的なWi-Fiサービスの提供のためにはとても便利な機能です。AP毎の周波数を設定し、お互いが競合しないようにするなど、より細かい設定ができます。</p>\n<p>ハードウェアスペックとしては一般的ですが、端末がどのAPに接続されているか、それぞれの端末の電波状況などがわかります。また時間でSSID単位に停波させることも可能で、私は夜間は11gの最小限の送信出力に絞り11axは止めています。スマホは夜間に勝手に11gに切り替わり最低限の通信は可能になっています。</p>\n<p>日本のWiーFiルーターも多機能で、当たり前のようにあるWPSプッシュボタンによるクライアント登録（認証）や子供の端末を管理するなどの機能はUniFiは持っていません。下手に長いWi-Fiパスワードにしてしまうと、UniFiではIoTに対するパスワード入力が困難です。UniFiと国内のWi-Fiルーターとは目指す方向が違う事になり、基本性能という意味では殆ど変わらないものとお考えください。</p>\n<p>ホームゲートウェイやスイッチなどが揃っている環境でUniFiのWi-Fi製品のみを導入できます。</p>\n<h2 id=\"まとめ\"><a href=\"#まとめ\" class=\"headerlink\" title=\"まとめ\"></a>まとめ</h2><p>ここではUniFiの製品群を説明しました。製品としては荒削りなところもあり、それなりに不具合や未対応の箇所を抱えながら少しづつ機能強化しているというプロダクトの特徴があります。特に見える化という観点で、ネットワーク環境を変える予定のある方は検討の候補になるかもしれません。私が保有しているスイッチを簡単に紹介しましたがSFP+に偏っており、他にも魅力的なスイッチがありますので、是非Ubiquitオンラインストアにアクセスされてみることをお勧めします。なお、サポートは存在しますが、原則はコミュニティで自ら情報収集・調査する必要があり、簡単とは言えません。</p>\n<p>このブログでは仮想環境のESXi上にUbuntuをセットアップし、UniFi Network Applicationを運用する方法を紹介しています。</p>\n<ul>\n<li>「<a href=\"/new-technology/2022/09/23/ubuntu22-04lts/\" title=\"Ubuntu22.04LTSをESXiにセットアップする\">Ubuntu22.04LTSをESXiにセットアップする</a>」</li>\n<li>「<a href=\"/new-technology/2022/09/23/unifi-network-application/\" title=\"UniFi Network Applicationのセットアップ\">UniFi Network Applicationのセットアップ</a>」</li>\n<li>「<a href=\"/new-technology/2022/10/23/unifi-network-application2/\" title=\"UniFi Network Applicationの運用\">UniFi Network Applicationの運用</a>」</li>\n<li>「<a href=\"/new-technology/2022/11/23/unifi-switch/\" title=\"UniFiスイッチ\">UniFiスイッチ</a>」</li>\n</ul>\n","categories":["Network","Hardware"],"tags":["SFP+","10GbE","Wi-Fi","UniFi"]},{"title":"UniFi Wi-Fiシステム","url":"/new-technology/2022/12/31/unifi-ap/","content":"\n<p class=\"onepoint\">この記事で実現すること</p>\n\n<p>この記事ではホームユーザー向けにUniFi AP(Wi-Fiアクセスポイント）の設定ができるようになることを目的としています。</p>\n<span id=\"more\"></span>\n\n<h2 id=\"最近のWi-Fi事情\"><a href=\"#最近のWi-Fi事情\" class=\"headerlink\" title=\"最近のWi-Fi事情\"></a>最近のWi-Fi事情</h2><p>2022年9月にWi-Fiで6GHzも利用できるよう法律が変更されました（Wi-Fi6E）。国内のメーカーはこの6GHzとメッシュを謳い文句にWi-Fiルータの販売強化を図っているようです。しかしながら、端末側は今年に発売するiPhoneで6Eの対応が見送られた事であまり盛り上がってはいないようです。</p>\n<p>Wi-Fiの難しいところはその住居の形や家の周りの電波状態に大きく左右されてしまう点で、これがベストという構成を見出せません。私の例で言えば、凡庸な建売の木造2階建であり、無線APが1つだけでも、それなりに無難にWi-Fiが使えるという環境です。</p>\n<p>最近販売され始めた無線ルーターは、メッシュ対応のものが多く出てきました。メッシュは複数台のAPと無線でデータをやり取りできる機能です。無線の中継機は常に親機に集約されていましたが、メッシュは複数台のAPと相互に接続します。一般的には中継専用のSSIDを用いお互いにデータを中継します。</p>\n<p>最近のメッシュWi-Fiルーターでは高速ローミング（802.11k、802.11r、802.11v）に対応している製品も出てきており、端末を持ちながら移動した場合に、アクセスポイント（AP）間を高速ローミングすることで切断時間を短くし、近くのAPに接続できます。また、それぞれのAPがメッシュ（無線）ではなく、有線接続して互いの情報を交換できる<strong>イーサネットバックホール（有線バックホール）</strong>という機能に対応している製品を複数の部屋に設置することでずいぶん快適になるでしょう。</p>\n<p>なお、6EはDFSの影響を受けないチャンネルなので、自宅の間取りで6GHzが効率よく使える環境下であれば利便性は増します。私は6GHzの無線APは保有していないので、どのくらい電波が届くものなのかは今後機会があれば評価してみたいと考えています。周波数が上がるにつれて障害物によって遠くに届きづらくなるとは考えられます。各部屋に有線がなく、イーサネットバックホールが使えないケースでは、AP同士を6Eの独立チャンネルで接続する事で中継機能が改善することが期待されます（これまでは親機と中継機が同一のチャンネルを使うことで効率が大幅に落ちるケースがありました）。</p>\n<p>また、端末側の6E対応状況が進捗するまではしばらくはWi-Fi6（5GHz）のままというのが現状でしょうか。</p>\n<h2 id=\"UniFi-APのスペック\"><a href=\"#UniFi-APのスペック\" class=\"headerlink\" title=\"UniFi APのスペック\"></a>UniFi APのスペック</h2><p>日本国内で販売されているUniFi APはルーター機能を持たず、アクセスポイントに特化したハードウェアです。今のところ日本国内で販売されている機器にはメッシュ機能はなく、複数のAPは有線接続が前提となっており、UniFiネットワークアプリケーションまたはUniFiコンソールを介して情報連携が行われます。</p>\n<table>\n<thead>\n<tr>\n<th>機種</th>\n<th>U6 Pro</th>\n<th>U6 Lite</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>有線</td>\n<td>GbE RJ45ポート x1</td>\n<td>GbE RJ45ポート x1</td>\n</tr>\n<tr>\n<td>給電方法</td>\n<td>PoE</td>\n<td>PoE</td>\n</tr>\n<tr>\n<td>最大消費電力</td>\n<td>13W</td>\n<td>13.5W</td>\n</tr>\n<tr>\n<td>最大送信パワー2.4GHz</td>\n<td>22dBm</td>\n<td>23dBm</td>\n</tr>\n<tr>\n<td>最大送信パワー5GHz</td>\n<td>26dBm</td>\n<td>23dBm</td>\n</tr>\n<tr>\n<td>MIMO 2.4GHz</td>\n<td>2x2</td>\n<td>2x2</td>\n</tr>\n<tr>\n<td>MIMO 5GHz</td>\n<td>4x4</td>\n<td>2x2</td>\n</tr>\n</tbody></table>\n<p>Wi-FiのスペックとしてはU6 Proで日本国内のやや高性能モデルに相当するでしょうか。アンテナ数を見ても、国内のWi-Fi機器と比較して特段優れている項目はありません。U6 Liteも一般的なスペックです。</p>\n<h2 id=\"UniFi-APの実速度\"><a href=\"#UniFi-APの実速度\" class=\"headerlink\" title=\"UniFi APの実速度\"></a>UniFi APの実速度</h2><p>iPhone11を使ってAPに1mの距離まで近づけて、iperf3を実行した時の結果は以下の通りです。</p>\n<blockquote>\n<p>U6 Pro<br> <img src=\"/new-technology/2022/12/31/unifi-ap/u6-pro3.png\" class=\"\" width=\"360\" title=\"alt\"></p>\n</blockquote>\n<blockquote>\n<p>U6 Lite<br> <img src=\"/new-technology/2022/12/31/unifi-ap/u6-lite3.png\" class=\"\" width=\"360\" title=\"alt\"></p>\n</blockquote>\n<p>参考までに、Aterm WX6000HPの場合は以下です。</p>\n<blockquote>\n<img src=\"/new-technology/2022/12/31/unifi-ap/aterm.png\" class=\"\" width=\"360\" title=\"alt\">\n</blockquote>\n<p>U6 Proの個性として、iperf3の起動直後は少しスロースタートに見えます。省電力の最適化に重きを置いているのでしょうか。</p>\n<p>また、私の自宅の1階において、macOSのWi-Fi Explorerで電波の強さを計測してみました。1階にはU6 ProとAterm、2階にはU6 Liteが配置されています。</p>\n<img src=\"/new-technology/2022/12/31/unifi-ap/wifi-explorer.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p>電波の強さだけであればAtermのWX6000HPが素晴らしい結果を出しています。しかしiperf3の最高速度という観点についてはU6 Proの方が良いスコアです。</p>\n<p>pingのレイテンシも見てみましょう。iPhoneからNASへのping応答速度です。iOSやmacOSはpingのレイテンシ数値が高く出てしまう傾向にあります。実は上記のiperf3を含めてL3スイッチ経由でルーティングしてNASのiperf3サーバーに接続しており、1ホップあります。</p>\n<ul>\n<li><p>Aterm pingレイテンシ</p>\n <img src=\"/new-technology/2022/12/31/unifi-ap/aterm4.png\" class=\"\" width=\"360\" title=\"alt\">\n</li>\n<li><p>U6 Pro pingレイテンシ</p>\n <img src=\"/new-technology/2022/12/31/unifi-ap/u6-pro4.png\" class=\"\" width=\"360\" title=\"alt\"></li>\n</ul>\n<blockquote>\n<p>PingPlotterによる計測<br> <a href=\"https://www.pingman.com/\">https://www.pingman.com</a></p>\n</blockquote>\n<p>U6 Proの方が電波の出力は低いものの、レイテンシは15msあたりで上限が整っています。一方、Atermは時々、20msを超えるスパイクが発生しています。U6 Proの速度が出る理由はレイテンシが低い事と想定されます。スマホやノートPCの一般的な操作では100Mbpsを超えたあたりから殆どその差については分からなくなってきますが、リモートワークのビデオ会議の安定性を考えるとレイテンシは意識したいところです。</p>\n<p>UniFi APはWi-Fi設定が非常に詳細まで行えることがメリットであり、電波が届かないなどの対策としての購入用途には向いていません。</p>\n<h2 id=\"UniFi-APの設置\"><a href=\"#UniFi-APの設置\" class=\"headerlink\" title=\"UniFi APの設置\"></a>UniFi APの設置</h2><p>電源を取るのはPoEアダプタまたはPoEスイッチからというのが独特です。これによってLANケーブルのみでデータ送受信と送電が行え、美観を損ねる事なく、壁の上部にAPを配置し、障害物を避けた効率の良い電波の発信が行えます。Wi-Fiはハードウェアスペックも関係ありますが、こういった物理的な配置も重要です。後述しますが、有線バックホールを使わずにPoEの電力だけを使い、メッシュにすることもできます。この場合、UniFi APは有線接続されている他のAPにメッシュで接続してくれます。</p>\n<p>有線バックホールの一例です。</p>\n<p>（U6 Liteを2階に設置）</p>\n<img src=\"/new-technology/2022/12/31/unifi-ap/u6-lite.png\" class=\"\" width=\"640\" title=\"alt\">\n\n<p>コアスイッチから2階のこの部屋までは光で通し、SFP+スイッチ（usw-Aggregation)から1GbEでAPに接続しています。このスイッチにはPoE機能はないため、別途PoEアダプタを使ってAPに給電しています。</p>\n<img src=\"/new-technology/2022/12/31/unifi-ap/poe.png\" class=\"\" width=\"640\" title=\"alt\">\n<p>PoEアダプタを電源に繋ぎ、LANをusw-AggregationにRJ45で接続し、POEをU6 LiteにRJ45で接続します。</p>\n<p>（私の環境の場合）電波の弱い階段のエリアにまで電波を届かせるために出来るだけ障害物を避けるAPの配置の工夫をしました。階を移動した時にスムーズなローミングができ、ビデオ会議で相手の声がなるべく途切れない事を目的としています。</p>\n<img src=\"/new-technology/2022/12/31/unifi-ap/u6-lite2.png\" class=\"\" width=\"640\" title=\"alt\">\n\n<p>2階の各部屋に電波を届けつつ、立体的に見て、壁と2階の床を抜ける箇所を想定し、試行錯誤しながら配置を決めていきます。</p>\n<h2 id=\"UniFi-Wi-Fi設定\"><a href=\"#UniFi-Wi-Fi設定\" class=\"headerlink\" title=\"UniFi Wi-Fi設定\"></a>UniFi Wi-Fi設定</h2><p>ここでは、UniFiコンソールやUniFiネットワークアプリケーションが既にセットアップされている事を前提に説明します。<br>UniFiネットワークアプリケーションを最初からセットアップされる方は以下の記事を参照してください。</p>\n<ul>\n<li>「<a href=\"/new-technology/2022/08/27/ubiquiti-unifi/\" title=\"Ubiquiti UniFiの世界\">Ubiquiti UniFiの世界</a>」</li>\n<li>「<a href=\"/new-technology/2022/09/23/ubuntu22-04lts/\" title=\"Ubuntu22.04LTSをESXiにセットアップする\">Ubuntu22.04LTSをESXiにセットアップする</a>」</li>\n<li>「<a href=\"/new-technology/2022/09/23/unifi-network-application/\" title=\"UniFi Network Applicationのセットアップ\">UniFi Network Applicationのセットアップ</a>」</li>\n<li>「<a href=\"/new-technology/2022/10/23/unifi-network-application2/\" title=\"UniFi Network Applicationの運用\">UniFi Network Applicationの運用</a>」</li>\n</ul>\n<p>ネットワークアプリケーションの<mark class=\"label primary\">SETTINGS</mark>から<mark class=\"label primary\">WiFi</mark>の画面を開くと以下の表示となります。</p>\n<img src=\"/new-technology/2022/12/31/unifi-ap/wifi1.png\" class=\"\" width=\"640\" title=\"alt\">\n\n<p>画面上部のWiFiについては、既存のSSID一覧が表示されます。画面下部の<mark class=\"label primary\">Global AP Settings</mark>では、複数台のAPに共通設定を指定します。</p>\n<p>メインとなる5GHzの無線設定では、DFSのこともあり、一般的には80MHzを指定します。日本の製品ではアンテナ数で上り2、下り2として2x2という表現がされている事が多いでしょうか。スマホなど多くは80MHzになります。高機能なWiFiクライアントをお持ちの場合は160MHzも設定可能です（U6 Liteは80MHzが上限です）。</p>\n<mark class=\"label primary\">Transmit Power</mark>は環境に応じて、Auto、High、Medium、Low、Custom（固定数値指定）と設定できます。\n\n<p>有線バックホール無しでAPを設置する場合は、<mark class=\"label primary\">Wireless Connectivity</mark>の<mark class=\"label primary\">Wireless Meshing</mark>のチェックボックスをOnにします。私は普段は有線バックホールで運用していますが、U6-Proでは有線接続せずにメッシュ接続も行えました。</p>\n<p>続いて、SSIDの設定です。</p>\n<img src=\"/new-technology/2022/12/31/unifi-ap/wifi2.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<p>SSIDの名前、パスワード、ネットワーク、そのSSIDにどのAPを参加させるかを決めます。ここでは個人向けのWi-Fiとして一般的なWPA2パーソナルまたはWPA3パーソナルを前提としています。</p>\n<p>続いて、マニュアル設定でSSIDの詳細を設定していきます。</p>\n<img src=\"/new-technology/2022/12/31/unifi-ap/wifi3.png\" class=\"\" width=\"480\" title=\"alt\">\n<img src=\"/new-technology/2022/12/31/unifi-ap/wifi4.png\" class=\"\" width=\"480\" title=\"alt\">\n\n\n<table>\n<thead>\n<tr>\n<th>項目名</th>\n<th>説明</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>WiFi Band</td>\n<td>2.4GHz&#x2F;5GHzを選択します。両方を有効にもできます。</td>\n</tr>\n<tr>\n<td>WiFi Type</td>\n<td>通常はStandardです。カフェのように外部にWiFiを解放する場合はGuest Hotspotを選択します。</td>\n</tr>\n<tr>\n<td>Band Steering</td>\n<td>バンドステアリング。Bandで2.4GHz、5GHzを指定した場合に設定でき、電波状態によって自動で切り替わります。</td>\n</tr>\n<tr>\n<td>Bandwidth Profile</td>\n<td>帯域制限を指定します。</td>\n</tr>\n<tr>\n<td>Multicast Management</td>\n<td>通常必要ありませんので説明は割愛します。</td>\n</tr>\n<tr>\n<td>Client Device Isolation</td>\n<td>クライアントをお互いに接続できないようにします。Guest扱い。</td>\n</tr>\n<tr>\n<td>Proxy ARP</td>\n<td>混雑している環境ではWiFiデバイスの代わりにAPが代理応答します。</td>\n</tr>\n<tr>\n<td>BSS Transition</td>\n<td>AP同士でクライアントの状況を共有します。デフォルト有効。</td>\n</tr>\n<tr>\n<td>UAPSD</td>\n<td>省電力に関するパラメータです。古いデバイスでは問題が出る場合があります。</td>\n</tr>\n<tr>\n<td>Fast Roaming</td>\n<td>Fast Roamingに対応している端末であれば有効にすべきです。逆に言えば、Fast Roamingに対応した端末専用のSSIDにすべきです。</td>\n</tr>\n<tr>\n<td>802.11 DTIM Period</td>\n<td>デフォルト有効。Autoを推奨。説明は割愛します。</td>\n</tr>\n<tr>\n<td>Minimum Data Rate Control</td>\n<td>デフォルト有効。最低通信量を定め、それを下回る場合クライアントにAP切り替えを促すはずですが、私の環境ではあまり有効に機能しません。</td>\n</tr>\n<tr>\n<td>Security Protocol</td>\n<td>WPA2、WPA3の指定をします。WPA Enterpriseを指定することでRADIUS認証（ユーザー認証）が可能です。子供が友達にWi-Fiパスワード共有することに対策したいというこだわりのある方などチャレンジされてはいかがでしょうか。QNAPのNASなどでRADIUSサーバを稼働させられます</td>\n</tr>\n<tr>\n<td>PMF</td>\n<td>保護された管理フレーム。WPA3では必須。WPA2では任意にすることも可能。必須にすると古い端末は繋がらない可能性があリます。</td>\n</tr>\n<tr>\n<td>Group Rekey Interval</td>\n<td>暗号化キーの交換を定期的に行います。デフォルトは3600秒（＝1時間）です。</td>\n</tr>\n<tr>\n<td>Hide WiFi Name</td>\n<td>使うメリットはありません。説明は割愛します。</td>\n</tr>\n<tr>\n<td>MAC Address Filter</td>\n<td>MACアドレスのホワイトリスト、ブラックリストを指定します。</td>\n</tr>\n<tr>\n<td>RADIUS MAC Authentication</td>\n<td>説明は割愛します。</td>\n</tr>\n</tbody></table>\n<p>WiFi Schedulerは夜間など使わない時の時間を設定できます。私は夜間は弱い2.4GHzのみ利用し、日中使っている5GHzは止めています。</p>\n<h2 id=\"AP単位の設定\"><a href=\"#AP単位の設定\" class=\"headerlink\" title=\"AP単位の設定\"></a>AP単位の設定</h2><p>UniFiのDevice画面の<mark class=\"label primary\">Settings</mark>から、AP本体の設定を変更します。主にはIPアドレス、無線のチャンネルを指定します。</p>\n<img src=\"/new-technology/2022/12/31/unifi-ap/u6-pro5-1.png\" class=\"\" width=\"360\" title=\"alt\">\n\n<p>５GHzについては、APを2つ設置するならば、メインはDFSを受けないチャネル、サブは別のチャネルにするとお互い競合せずに安定した電波の受信ができます。2.4GHzはChannel幅は20MHzとし、1、6、11という具合に５づつスライドさせてAP毎に電波が重ならないように設定します。こういったきめ細かい設定が行えるのもUniFi APの特徴です。</p>\n<p>IPアドレスはDHCP、固定が選べます。</p>\n<img src=\"/new-technology/2022/12/31/unifi-ap/u6-pro5-2.png\" class=\"\" width=\"360\" title=\"alt\">\n\n<p>このAP自体が属するマネジメント用のVLANを指定します。Wi-Fi設定ではSSID毎にVLANを設定できるので、APに接続するスイッチは、マネジメントVLANを含む全てのVLAN IDを含めるようにトランクポートとして設定する必要があります。</p>\n<p>VLANを使った設定の一例です。</p>\n<p>デバイスの管理をデフォルトVLAN（かつネイティブVLAN）、一般端末をVLAN100、会社用・ゲストをVLAN500とした、よくある一般的なシナリオです。</p>\n<img src=\"/new-technology/2022/12/31/unifi-ap/network.drawio.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p>UniFIでは複数VLANのペアを作って、そのうちの１つをネイティブVLANとして指定します。この例ではマネジメントVLANをDefault（VLAN ID＝1）、かつ、ネイティブVLAN（タグ無し）としています。会社のPCやゲスト用端末はClient Device IsolationをEnableにして互いの機器の通信を拒否します。スイッチ間のトランクポートは必ず通信するVLAN IDのタグを含めてあげる必要があります。</p>\n<h2 id=\"APのファームウェア\"><a href=\"#APのファームウェア\" class=\"headerlink\" title=\"APのファームウェア\"></a>APのファームウェア</h2><p>UniFi APの最新のOfficialのファームウェアは、ローミングの切り替わりが安定しないように見えますが、現在リリース候補となっている、6.5.40は遅延の少ないローミングが成功しているように見えます。また、Wi-Fi6Eに対応したU6 Enterpriseもいよいよ発売されるようです。</p>\n<h2 id=\"通知機能\"><a href=\"#通知機能\" class=\"headerlink\" title=\"通知機能\"></a>通知機能</h2><p>通知はUniFiコンソールまたはUniFiネットワークアプリケーションの機能ですが、APに関して通知機能は以下の通りです。</p>\n<img src=\"/new-technology/2022/12/31/unifi-ap/wifi5.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<p>DFSを受信した時にアラートが受けられるのと、自宅付近に同じSSIDを持つAPを発見した場合通知してくれます。特に後者はセキュリティ上有用です。これは試験的にUniFi以外のAPを同じSSIDで起動して検知させています。</p>\n<img src=\"/new-technology/2022/12/31/unifi-ap/wifi6.png\" class=\"\" width=\"360\" title=\"alt\">\n\n<p>通知はメールとスマホアプリと2種類あり、選択できます。<mark class=\"label primary\">Hotspot Client Connection Change</mark>は、端末の接続&#x2F;切断を検知したり、ローミングの切り替わり状況を通知してくれます。家族の自宅への出入りも把握できます。ただし、通知数が多くなるので、メール通知は避け、アプリ通知にした方が良さそうです。本来の趣旨は知らないMACアドレスからの接続があった時に検知するものです。</p>\n<p>これらの機能はハイブリッドクラウド機能を持つUniFi製品の特徴ですが、これらが無償で利用できるというのは本当にありがたい存在です。</p>\n","categories":["Network","Hardware"],"tags":["UniFi"]},{"title":"Ubuntu22.04LTSをESXiにセットアップする","url":"/new-technology/2022/09/23/ubuntu22-04lts/","content":"<img src=\"/new-technology/2022/09/23/ubuntu22-04lts/title.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p class=\"onepoint\">この記事で実現すること</p>\n\n<p>この記事では24時間稼働させるサーバーとして、intel&#x2F;AMDの<strong>ESXi</strong>上にUbuntuをセットアップするケースを想定しています。従来のSSHで接続するコマンドラインベースだけではなく、WindowsやmaOSから<strong>GUIで接続するUbuntu環境</strong>になります。長期サポートの最新バージョンであるUbuntu22.04LTSを仮想環境であるESXi7.0上に導入します。リモートデスクトップに相当するクライアントソフトウェアはESXiに付属する<strong>VMware Remote Console</strong>(VMRC)を使います。Ubuntu22.04LTSのEOLは2027年4月であり、十分に長い期間のサポートがあります。</p>\n<span id=\"more\"></span>\n\n<h2 id=\"ESXiにおけるUbuntuのセットアップのポイント\"><a href=\"#ESXiにおけるUbuntuのセットアップのポイント\" class=\"headerlink\" title=\"ESXiにおけるUbuntuのセットアップのポイント\"></a>ESXiにおけるUbuntuのセットアップのポイント</h2><p>サーバーとして動作させるUbuntuをESXiおよびVMRCで仮想マシンを操作する事のメリットはトラブルに強いという事でしょうか。直接ハードウェアにインストールする（いわゆるベアメタル）方式ですと、IPアドレス周りの設定変更で失敗するとSSHで繋がらなくなり、ディスプレイに本体を繋いでリカバリするなど面倒です。VMRCはESXi本体に接続し操作するため、仮想マシン上のネットワークがダウンしていても操作可能です。特に複数VLANに跨いだ環境を構築したり、ファイアウォール(ufw)を設定する場合はトラブルになりやすいため、復旧しやすい構成を目指します。</p>\n<p>Requirements:</p>\n<p>Ubuntu Desktop Edition<br>2 GHz dual core processor<br>4 GiB RAM (system memory)<br>25 GB (8.6 GB for minimal) of hard-drive space (or USB stick, memory card or external drive but see LiveCD for an alternative approach)<br>VGA capable of 1024x768 screen resolution<br>Either a CD&#x2F;DVD drive or a USB port for the installer media<br>Internet access is helpful</p>\n<blockquote>\n<p>Ubuntu documentation<br> <a href=\"https://help.ubuntu.com/community/Installation/SystemRequirements\">https://help.ubuntu.com/community/Installation/SystemRequirements</a></p>\n</blockquote>\n<p>実際には、動かすアプリケーションを想定し、CPU、メモリ、ストレージを増やしておくことになるでしょう。ここでは、一例として、2vCPU、4GBメモリ、64GBストレージで進めます。</p>\n<p>また、Ubuntuのパッチ管理のために、Ubuntu Oneアカウントの申請および、ライセンス（個人利用は無償）の取得が必要となります（後述します）。</p>\n<p>環境面の前提としては、仮想マシンからDHCPでIPアドレスおよびDNSが取得でき、インターネットに接続可能な環境とします。</p>\n<h2 id=\"Ubuntu22-04LTSのダウンロード\"><a href=\"#Ubuntu22-04LTSのダウンロード\" class=\"headerlink\" title=\"Ubuntu22.04LTSのダウンロード\"></a>Ubuntu22.04LTSのダウンロード</h2><p>最初にUbuntu22.04LTSのダウンロードを行います。日本語Remix版を利用します。</p>\n<blockquote>\n<p>Ubuntu 22.04 LTS 日本語Remix<br> <a href=\"https://www.ubuntulinux.jp/News/ubuntu2204-ja-remix\">https://www.ubuntulinux.jp/News/ubuntu2204-ja-remix</a><br> ファイル名は「ubuntu-ja-22.04-desktop-amd64.iso」です。</p>\n</blockquote>\n<h2 id=\"ESXiで仮想マシンを作成する\"><a href=\"#ESXiで仮想マシンを作成する\" class=\"headerlink\" title=\"ESXiで仮想マシンを作成する\"></a>ESXiで仮想マシンを作成する</h2><h3 id=\"ESXiへのisoファイルのアップロード\"><a href=\"#ESXiへのisoファイルのアップロード\" class=\"headerlink\" title=\"ESXiへのisoファイルのアップロード\"></a>ESXiへのisoファイルのアップロード</h3><p>ESXiのWebUIにログインします。<br>ESXiの左ペインメニューの<mark class=\"label primary\">ストレージ</mark>から<mark class=\"label primary\">データストアブラウザ</mark>を開き、そこにダウンロードしたUbuntuのisoファイル（ubuntu-ja-22.04-desktop-amd64.iso)をアップロードします。</p>\n<h3 id=\"ネットワークポートグループの作成（任意）\"><a href=\"#ネットワークポートグループの作成（任意）\" class=\"headerlink\" title=\"ネットワークポートグループの作成（任意）\"></a>ネットワークポートグループの作成（任意）</h3><p>Ubuntuのネットワークで使うESXiのポートグループを用意します。新しく作成する場合は、左ペインメニューの<mark class=\"label primary\">ネットワーク</mark>から<mark class=\"label primary\">ポートグループの追加</mark>を選択し、該当するvSwitch上に新しいポートグループを作成します。</p>\n<h3 id=\"仮想マシンの作成\"><a href=\"#仮想マシンの作成\" class=\"headerlink\" title=\"仮想マシンの作成\"></a>仮想マシンの作成</h3><p>左ペインメニューの<mark class=\"label primary\">仮想マシン</mark>から、<mark class=\"label primary\">仮想マシンの作成/登録</mark>をクリックし、<mark class=\"label primary\">新規仮想マシンの作成</mark>を選択します。ここでは仮想マシンの名前と仮想マシンのバージョンによる互換性とゲストOSの種類を指定します。互換性は特に理由がなければ一番新しいものを選んでください。<mark class=\"label primary\">ゲストOSファミリ</mark>は”Linux”を、<mark class=\"label primary\">ゲストOSのバージョン</mark>は”Ubuntu Linxu(64ビット）”を選択します。</p>\n<img src=\"/new-technology/2022/09/23/ubuntu22-04lts/ubuntu1.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<p>続いて仮想マシンを作成するストレージを選択します。</p>\n<img src=\"/new-technology/2022/09/23/ubuntu22-04lts/ubuntu1-1.png\" class=\"\" width=\"800\" title=\"alt\">\n\n\n<mark class=\"label primary\">設定のカスタマイズ</mark>では、<mark class=\"label primary\">仮想ハードウェア</mark>と<mark class=\"label primary\">仮想マシンオプション</mark>があります。<mark class=\"label primary\">仮想ハードウェア</mark>のタブでは、CPU、メモリ、ディスク、ネットワークアダプタ（上記で作成したポートグループ）を指定し、CD/DVDドライブの場所でUbuntuのisoファイルを選択します。ネットワークアダプタが10GbEの場合は、<mark class=\"label primary\">ネットワークアダプタ1</mark>のプルダウンをクリックして\"VMXNET3\"が選択されていることを確認してください。\n<img src=\"/new-technology/2022/09/23/ubuntu22-04lts/ubuntu2.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<mark class=\"label primary\">仮想マシンオプション</mark>の画面に移動し、VMWare Toolsのプルダウンを開き、<mark class=\"label primary\">Toolsのアップグレード</mark>の<mark class=\"label primary\">パワーオン前に毎回VMware Toolsをチェックしてアップグレード</mark>のチェックボックスをオンにします。また、<mark class=\"label primary\">起動オプション</mark>では<mark class=\"label primary\">ファームウェア</mark>に\"EFI\"を選択し、<mark class=\"label primary\">この仮想マシンに対してUEFIセキュア ブートを有効にするかどうかを指定します</mark>のチェックボックスをオンにします。セキュアブートは必須ではありませんが、セキュリティ向上のためにお勧めします。\n\n<img src=\"/new-technology/2022/09/23/ubuntu22-04lts/ubuntu3.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<p>完了させたら、左ペインメニューの<mark class=\"label primary\">仮想マシン</mark>から、対象の仮想マシンを起動します。もし、クライアント端末（Windows,macOS）にVMRCをダウンロードしていなければダウンロードし、クライアント上でセットアップしておきます。</p>\n<img src=\"/new-technology/2022/09/23/ubuntu22-04lts/ubuntu3-1.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<mark class=\"label primary\">仮想マシン</mark>を<mark class=\"label primary\">パワーオン</mark>し、<mark class=\"label primary\">リモートコンソールを起動</mark>します。VMRCのセットアップが完了していれば以下のようなウィンドウがブラウザから独立して起動します。\n\n<img src=\"/new-technology/2022/09/23/ubuntu22-04lts/ubuntu4.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<mark class=\"label primary\">Ubuntuをインストール</mark>を選択します。\n\n<h3 id=\"Ubuntuのセットアップ\"><a href=\"#Ubuntuのセットアップ\" class=\"headerlink\" title=\"Ubuntuのセットアップ\"></a>Ubuntuのセットアップ</h3><p>最初は、キーボードレイアウトを選択します。下記の例ではJapanese(Macintosh)が選択されていますが、日本語キーボードのmacOSや一般的なWindowsの日本語キーボードは一番上の”Japanese”が一般的です。<mark class=\"label primary\">キーボード入力をここで試してください</mark>で実際のキー入力が確認できるのでここで試してから選択しましょう。インストール後にいつでも変更できます。</p>\n<img src=\"/new-technology/2022/09/23/ubuntu22-04lts/ubuntu5.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<p>ここでは<mark class=\"label primary\">最小インストール</mark>を選択します。なお、ESXiの場合、サードパーティのドライバはここでは選択する必要はありません。最初の仮想マシン作成時に、VMware Toolsをインストールするように指示しましたから、”open-vm-tools”が自動的にインストールされます。</p>\n<img src=\"/new-technology/2022/09/23/ubuntu22-04lts/ubuntu6.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<p>ここでは<mark class=\"label primary\">ディスクを削除してUbuntuをインストール</mark>を選択し”インストール”ボタンをクリックします。仮想マシン作成時に設定した64GBのディスクを初期化します。</p>\n<img src=\"/new-technology/2022/09/23/ubuntu22-04lts/ubuntu7.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<p>住んでいる場所を指定します。</p>\n<img src=\"/new-technology/2022/09/23/ubuntu22-04lts/ubuntu8.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<p>ホスト名、ユーザー名を設定します。ここで設定するホスト名・ユーザー名を使ってSSHで接続します。</p>\n<img src=\"/new-technology/2022/09/23/ubuntu22-04lts/ubuntu9.png\" class=\"\" width=\"800\" title=\"alt\">\n<img src=\"/new-technology/2022/09/23/ubuntu22-04lts/ubuntu9-1.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<p>インストールは完了です。再起動後、下記の画面が表示されるので、一旦Enterを押下します。</p>\n<img src=\"/new-technology/2022/09/23/ubuntu22-04lts/ubuntu9-2.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<p>最初の起動画面です。ウェルカム画面というのでしょうか。初期案内のウィンドウが表示されます。</p>\n<img src=\"/new-technology/2022/09/23/ubuntu22-04lts/ubuntu10.png\" class=\"\" width=\"800\" title=\"alt\">\n<p>ここでは、Ubuntuシングルサインオンを行います。一旦、Ubuntuはこのままにして、クライアントのブラウザからUbuntuのOneアカウントサイトにアクセスします。</p>\n<blockquote>\n<p>One account for everything on Ubuntu<br> <a href=\"https://login.ubuntu.com/\">https://login.ubuntu.com</a></p>\n</blockquote>\n<p>ここでは、以下のようにアカウントを作成します。メールアドレス、フルネーム、ユーザー名、パスワードを入力します。このユーザー名はUbuntuへのログインユーザーと同じである必要はありません。</p>\n<img src=\"/new-technology/2022/09/23/ubuntu22-04lts/ubuntu12.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<p>“Create account”ボタンをクリックし、アカウントを作成すると、登録したメールにコンファーメーションが行きますのでそこで確認のリンクをクリックしUbuntu Oneアカウントの登録は完了します。</p>\n<img src=\"/new-technology/2022/09/23/ubuntu22-04lts/ubuntu13.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<p>続いて、再びUbuntuの画面に戻り、今作成したUbuntu Oneアカウントをここで入力します。</p>\n<img src=\"/new-technology/2022/09/23/ubuntu22-04lts/ubuntu11.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<p>アカウントの照合がうまくいくと、キーリングの登録になります。これは第2パスワードというべき位置付けでもあり、Ubuntuにログインしていても重要な操作の前にはこのキーリングを求められます。Ubuntuをサーバーとして使うのであればGUIでログインする場合は設定変更が主な作業でしょうから、それなりの頻度で求められることになるためパスワード管理ソフトありきの長い覚えられないパスワードにすると実際の運用で大変になってしまうので注意してください。</p>\n<img src=\"/new-technology/2022/09/23/ubuntu22-04lts/ubuntu13-1.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<p>さて、続いてUbuntuにパッチを適用する際のライセンスが必要です。Ubuntu22からはLivePatchに制限が付きます。個人アカウントは3台のUbuntuまでLivePatchが適用できます。このLivePatchが有効になっていると、可能な限りリブートなく最新パッチが自動的に更新される素晴らしい仕組みとなっています。<br><strong>UbuntuのFirefoxを起動</strong>し、Ubuntu Advantageにアクセスします。</p>\n<blockquote>\n<p>Ubuntu Advantage<br> <a href=\"https://ubuntu.com/advantage\">https://ubuntu.com/advantage</a></p>\n</blockquote>\n<p>Ubuntu Oneアカウントでログインします。</p>\n<img src=\"/new-technology/2022/09/23/ubuntu22-04lts/ubuntu15.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<mark class=\"label primary\">Free for personal use</mark>の\"Register\"をクリックします。\n\n<img src=\"/new-technology/2022/09/23/ubuntu22-04lts/ubuntu16.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<p>これで、パーソナルトークンが作成されました。<mark class=\"label primary\">Token</mark>に記載のある文字列をマウスで選択し、右クリックからコピーを選びます。</p>\n<p>ウェルカム画面でUbuntu Oneのシングルサインオン完了後に次の画面に進むと、<mark class=\"label primary\">LivePatchのセットアップ</mark>に進みます。別の方法として、”ソフトウェアの更新”アプリケーションから<mark class=\"label primary\">設定</mark>をクリックし、<mark class=\"label primary\">LivePatch</mark>のタブを選択することでも可能です。</p>\n<img src=\"/new-technology/2022/09/23/ubuntu22-04lts/ubuntu20.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<img src=\"/new-technology/2022/09/23/ubuntu22-04lts/ubuntu21.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<mark class=\"label primary\">LivePatchは再起動することなく。..</mark>の表示とトグルスイッチがありますので、これをオンにします。\n<img src=\"/new-technology/2022/09/23/ubuntu22-04lts/ubuntu22.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<p>Ubuntu Advantageのトークンを貼り付けします。Ubuntu Advantageの更新は少しタイムラグがあるようで、Tokenの作成直後は登録がうまく行かない場合があるので、その場合は数時間待ってください。</p>\n<img src=\"/new-technology/2022/09/23/ubuntu22-04lts/ubuntu19.png\" class=\"\" width=\"800\" title=\"alt\">\n\n\n<h3 id=\"Open-SSH-Serverのインストール\"><a href=\"#Open-SSH-Serverのインストール\" class=\"headerlink\" title=\"Open SSH Serverのインストール\"></a>Open SSH Serverのインストール</h3><p>UbuntuにSSHするために必ず必要なモジュールです。GUIでコマンドを扱うには<mark class=\"label primary\">端末</mark>というアプリケーションを起動します。 そこからopensshをインストールします。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ sudo apt update</span><br><span class=\"line\">$ sudo apt install openssh-server</span><br><span class=\"line\"></span><br><span class=\"line\">パッケージリストを読み込んでいます... 完了</span><br><span class=\"line\">依存関係ツリーを作成しています... 完了</span><br><span class=\"line\">状態情報を読み取っています... 完了</span><br><span class=\"line\">以下の追加パッケージがインストールされます:</span><br><span class=\"line\">  ncurses-term openssh-sftp-server ssh-import-id</span><br><span class=\"line\">提案パッケージ:</span><br><span class=\"line\">  molly-guard monkeysphere ssh-askpass</span><br><span class=\"line\">以下のパッケージが新たにインストールされます:</span><br><span class=\"line\">  ncurses-term openssh-server openssh-sftp-server ssh-import-id</span><br><span class=\"line\">アップグレード: 0 個、新規インストール: 4 個、削除: 0 個、保留: 0 個。</span><br><span class=\"line\">751 kB のアーカイブを取得する必要があります。</span><br><span class=\"line\">この操作後に追加で 6,046 kB のディスク容量が消費されます。</span><br><span class=\"line\">続行しますか? [Y/n] Y</span><br></pre></td></tr></table></figure>\n\n<p>Ubuntuで<mark class=\"label primary\">端末</mark>アプリケーションを起動する場合、キーボードショートカットによる起動が便利です。セットアップ時のキーボードの選択によって内容は変わりますが、Widnowsは”Ctrl”+”Alt”+”T”で起動します。macOSでは”option”+”control”+”T”で起動します。</p>\n<h2 id=\"任意設定\"><a href=\"#任意設定\" class=\"headerlink\" title=\"任意設定\"></a>任意設定</h2><h3 id=\"VMRCとクライアントとのCopy-Paseteを連携する\"><a href=\"#VMRCとクライアントとのCopy-Paseteを連携する\" class=\"headerlink\" title=\"VMRCとクライアントとのCopy -Paseteを連携する\"></a>VMRCとクライアントとのCopy -Paseteを連携する</h3><p>WindowsやmacOSでブラウザで検索した結果をUbuntu上で貼り付けたい場合があります。この場合は仮想マシンをシャットダウンし、仮想マシンのオプションから以下のパラメータを設定します。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">isolation.tools.copy.disable          FALSE</span><br><span class=\"line\">isolation.tools.paste.disable         FALSE</span><br><span class=\"line\">isolation.tools.setGUIOptions.<span class=\"built_in\">enable</span>  TRUE</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<img src=\"/new-technology/2022/09/23/ubuntu22-04lts/ubuntu25.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<blockquote>\n<p>Copy &amp; Pasetを有効にする<br> <a href=\"https://kb.vmware.com/s/article/57122\">https://kb.vmware.com/s/article/57122</a></p>\n</blockquote>\n<h3 id=\"フォルダのパスを英語に変更する\"><a href=\"#フォルダのパスを英語に変更する\" class=\"headerlink\" title=\"フォルダのパスを英語に変更する\"></a>フォルダのパスを英語に変更する</h3><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ LANG=C xdg-user-dirs-gtk-update</span><br></pre></td></tr></table></figure>\n\n<img src=\"/new-technology/2022/09/23/ubuntu22-04lts/ubuntu24.png\" class=\"\" width=\"480\" title=\"alt\">\n\n<mark class=\"label primary\">Don't ask me this again</mark>をチェックし、\"Update Names\"をクリックします。\n\n<h2 id=\"VMRCの便利な起動方法\"><a href=\"#VMRCの便利な起動方法\" class=\"headerlink\" title=\"VMRCの便利な起動方法\"></a>VMRCの便利な起動方法</h2><p>ESXiで該当する仮想マシンを開き、URLを確認すると、URLの末尾に仮想マシンNoとも言える2桁の番号が振られています。</p>\n<img src=\"/new-technology/2022/09/23/ubuntu22-04lts/esxi1.png\" class=\"\" width=\"640\" title=\"alt\">\n\n<p>この数字を使って以下のURLをブラウザのお気に入りに登録しておくことによって、ESXiの画面にログインしてから仮想マシンにアクセスすることなく、直接VMRCを起動し仮想マシンにアクセスできます。</p>\n<p><code>vmrc://[ユーザー名]@[ESXiのホスト名]/?moid=[仮想マシンNo]</code><br>例：<br><code>vmrc://root@192.168.1.1/?moid=20</code></p>\n<h3 id=\"セットアップ完了\"><a href=\"#セットアップ完了\" class=\"headerlink\" title=\"セットアップ完了\"></a>セットアップ完了</h3><p>ESXiにおけるUbuntu22.04LTSのセットアップは完了です。最後に、仮想マシンのバックアップを取得されることをお勧めします。Linuxには個人ユーザー向けの有力なウィルス対策ソフトが存在しないため、色々なサイトをブラウジングするには多少抵抗がありますが、限られたパッケージシステムのみをインストールし、自宅内のサーバーとして利用するにはESXiとの組み合わせは最適です。バックアップやスナップショットを活用し、トラブル時には迅速にロールバックできる環境はとても便利です。</p>\n<ul>\n<li><a href=\"/new-technology/2020/10/11/esxi-backup/\" title=\"VMware ESXiの仮想マシンをバックアップする\">VMware ESXiの仮想マシンをバックアップする</a></li>\n<li><a href=\"/new-technology/2021/12/04/qnap-hdp/\" title=\"無償版ESXiのVMをQNAP NASにバックアップ\">無償版ESXiのVMをQNAP NASにバックアップ</a></li>\n<li><a href=\"/new-technology/2021/03/06/esxi-nakivo/\" title=\"無償版ESXiの高度なバックアップ\">無償版ESXiの高度なバックアップ</a></li>\n</ul>\n","categories":["Software"],"tags":["ESXi","Ubuntu"]},{"title":"UniFiスイッチ","url":"/new-technology/2022/11/23/unifi-switch/","content":"<img src=\"/new-technology/2022/11/23/unifi-switch/title.png\" class=\"\" width=\"1024\" title=\"alt\">\n<p class=\"onepoint\">この記事で実現すること</p>\n\n<p>この記事ではホームユーザー向けにUniFiスイッチの設定ができるようになることを目的としています。</p>\n<span id=\"more\"></span>\n\n<h2 id=\"UniFiスイッチの特徴\"><a href=\"#UniFiスイッチの特徴\" class=\"headerlink\" title=\"UniFiスイッチの特徴\"></a>UniFiスイッチの特徴</h2><p>UniFiネットワークスイッチの特徴としては、どちらかといえばスモールビジネス向けの製品が中心ではあります。<br>スモールオフィスの基幹ネットワークを構成しながら、監視カメラやWi-Fiシステムを導入し、トータルソリューションが売りになります。<br>ネットワークスイッチ単独の機能として見ると、以下の特徴があります。</p>\n<ol>\n<li>Wi-FiにRJ45ケーブルで通信と電力出力を兼ねるPoE</li>\n<li>SFP＋などの10GbEネットワーク</li>\n<li>UniFiネットワークアプリケーションによる集中管理</li>\n</ol>\n<p>ホームユーザー向けとして自宅内のネットワークを10GbEかつSFP+を選択する場合は、いくつかの魅力的なネットワークスイッチが候補に上がります。<br>発熱対策のために各部屋にSFP+でOM3などの光ケーブルを通す場合は、個人向けのネットワークスイッチではPortが不足してしまうのが実態です。<br>機器の価格帯が個人向け、かつ消去法でいくとMikroTikかUniFiが選択肢に上がります。円安で昔ほどは安いと思えなくなりましたが、SFP+スイッチは廉価です。</p>\n<h2 id=\"基本設定\"><a href=\"#基本設定\" class=\"headerlink\" title=\"基本設定\"></a>基本設定</h2><p>基本設定です。UniFiスイッチを新規導入する際には、ネットワークアプリケーションに登録（採用）する必要があります。初期セットアップについては、以下の記事を参照してください。UniFi製品群の標準の考え方ではセキュリティゲートウェイをインターネットルーターの役割として配置し、そこに各UniFi製品群をぶら下げることになります。私はSophos Firewallを利用しており、UniFiセキュリティゲートウェイは不要としているため、集中管理のためのUniFiネットワークアプリケーションを導入しています。</p>\n<ul>\n<li><a href=\"/new-technology/2022/08/27/ubiquiti-unifi/\" title=\"Ubiquiti UniFiの世界\">Ubiquiti UniFiの世界</a></li>\n<li><a href=\"/new-technology/2022/09/23/unifi-network-application/\" title=\"UniFi Network Applicationのセットアップ\">UniFi Network Applicationのセットアップ</a></li>\n<li><a href=\"/new-technology/2022/10/23/unifi-network-application2/\" title=\"UniFi Network Applicationの運用\">UniFi Network Applicationの運用</a></li>\n</ul>\n<p>UniFiスイッチが採用（Adoption）されると、ネットワークアプリケーションから管理できるようになります。</p>\n<p>スイッチ毎の<mark class=\"label primary\">Settings</mark>では、<mark class=\"label primary\">Service</mark>で基本設定を、<mark class=\"label primary\">Network</mark>でIPアドレスを設定できます。</p>\n<img src=\"/new-technology/2022/11/23/unifi-switch/netapp2.png\" class=\"\" width=\"360\" title=\"alt\">\n\n<mark class=\"label primary\">Service</mark>では、スイッチ自身がどのネットワーク（VLAN）に属するのかを決め、Flow ControlやJumbo Frameの設定が可能です。デフォルトでFlow ControlはOffです。ネットワーク速度が異なる端末を接続する場合は、Flow ControlはOnの方が良いでしょう。もちろん、送信側端末のネットワークカードがFlow Controlに対応している必要はあります。最近、UniFiネットワークアプリケーションではスイッチのGlobalSettingが可能となり、スイッチ毎にこれらの設定が不要になっています。\n\n<img src=\"/new-technology/2022/11/23/unifi-switch/netapp3.png\" class=\"\" width=\"360\" title=\"alt\">\n\n<mark class=\"label primary\">Network</mark>では、静的IPアドレスを設定することもできます。\n<p>その他、<mark class=\"label primary\">Settings</mark>からは、スイッチの再起動が可能です。</p>\n<h2 id=\"スイッチポート確認\"><a href=\"#スイッチポート確認\" class=\"headerlink\" title=\"スイッチポート確認\"></a>スイッチポート確認</h2><p>スイッチ毎の<mark class=\"label primary\">Ports</mark>からはPortの稼働状況が確認できます。</p>\n<img src=\"/new-technology/2022/11/23/unifi-switch/netapp4.png\" class=\"\" width=\"360\" title=\"alt\">\n\n<table>\n<thead>\n<tr>\n<th>項目名</th>\n<th>内容</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Status</td>\n<td>実際に接続されている速度を示します。稀にファームウェアのアップデートのタイミングで誤った認識になる場合があります</td>\n</tr>\n<tr>\n<td>Tx&#x2F;Rx</td>\n<td>送信(Tx)、受信(Rx)量を示します</td>\n</tr>\n<tr>\n<td>Profile</td>\n<td>UniFiのVLANは複数のネットワークを指定した上で纏めたトランクポートを複数種類作成可能です。私の環境の一例では、管理用LAN（タグ無し※デフォルトVLAN）、家族用VLAN、ゲスト用VLAN（会社向けやIoTなどのゲストネットワーク）を1つに束ねて上流スイッチから接続しています。</td>\n</tr>\n<tr>\n<td>Uplink</td>\n<td>上流の機器を示します。UniFiがInternetへのルーティングを解析し、Internet接続ルーターを上流として自動的にUplinkポートを判別します</td>\n</tr>\n</tbody></table>\n<p>その他、SFPモジュールの情報などが出力されています。</p>\n<h2 id=\"スイッチポート設定\"><a href=\"#スイッチポート設定\" class=\"headerlink\" title=\"スイッチポート設定\"></a>スイッチポート設定</h2><p>スイッチ毎の<mark class=\"label primary\">Ports</mark>からさらに<mark class=\"label primary\">Port Management</mark>を選択すると、個々のPortの設定を行えます。</p>\n<img src=\"/new-technology/2022/11/23/unifi-switch/netapp5.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p>これはPro-Aggregationの例ですが、Portごとに接続されているクライアントが表示されています。ここで個別のPortを選択すると、ポートの速度やVLANを設定できます。</p>\n<h3 id=\"Portの設定変更\"><a href=\"#Portの設定変更\" class=\"headerlink\" title=\"Portの設定変更\"></a>Portの設定変更</h3><p>Portの物理的な設定変更は以下の<mark class=\"label primary\">Port Profile Override</mark>から行います。</p>\n<img src=\"/new-technology/2022/11/23/unifi-switch/netapp7.png\" class=\"\" width=\"360\" title=\"alt\">\n\n<table>\n<thead>\n<tr>\n<th>項目名</th>\n<th>内容</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Operation</td>\n<td>Switching または、Aggregate（複数のPortを束ねて帯域を増やす）、Mirrorを選択します。</td>\n</tr>\n<tr>\n<td>Link Speed</td>\n<td>オートネゴ、10Gbps、2.5Gbpsなどの速度固定を選択します。なお、2.5Gはオートネゴでは動作しません</td>\n</tr>\n<tr>\n<td>Port Isolation</td>\n<td>Uplinkポートのみトラフィックを転送します</td>\n</tr>\n<tr>\n<td>Storm Control</td>\n<td>ブロードキャスト、マルチキャストなどの飽和を某防止します</td>\n</tr>\n<tr>\n<td>LLDP</td>\n<td>ディスカバリプロトコルを有効にします（デフォルトON）</td>\n</tr>\n<tr>\n<td>Spanning Tree Protocol</td>\n<td>スパニングツリーを有効にします（デフォルトON）</td>\n</tr>\n</tbody></table>\n<p>ミラーPortはトラブル時の確認のために使います。トラブルのあるPort番号を指定し、ミラーに設定することで同じデータが流れます。ノートPCなどを接続し、WireSharkなどを使いパケット解析します。</p>\n<p>SFP+の製品であっても、USW-AggregationスイッチやUSW-Enterprise-8-PoEのSFP+ポートは2.5GbEに対応していません。過去記事「<a href=\"/new-technology/2022/07/30/sfp-plus-nbaset/\" title=\"SFP+の2.5GbE対応\">SFP+の2.5GbE対応</a>」で書いたように、10GbEを2.5GbEとして偽装させる特殊なSFP+モジュールが必要になります（もっとも、USW-Enterprise-8-PoEは2.5GbEのRJ45ポートを備えているので運用上困ることはありませんが）。</p>\n<h2 id=\"VLANを設定\"><a href=\"#VLANを設定\" class=\"headerlink\" title=\"VLANを設定\"></a>VLANを設定</h2><p>VLANを作成するにはネットワークアプリケーションの<mark class=\"label primary\">SETTINGS</mark>から<mark class=\"label primary\">NETWORKS</mark>を選択し、<mark class=\"label primary\">Create New Network</mark>をクリックします。</p>\n<p>L3スイッチではなく、単にVLANを作成したい場合は、ここで<mark class=\"label primary\">VLAN-only Network</mark>のチェックボックスをONにし、VLAN IDを決定します。</p>\n<img src=\"/new-technology/2022/11/23/unifi-switch/netapp8.png\" class=\"\" width=\"360\" title=\"alt\">\n\n<p>こういったネットワーク構成全般の変更を行うと、全てのスイッチに対してコンフィグの転送が行われ、スイッチの再構成が実行されます。</p>\n<p>トランクポートとして使うのであれば予め作成した複数のネットワークを束ねたProfileを作成した上でそれを指定します。<br>Profile作成時には指定する複数のネットワークのうちどれか1つをネイティブVLANとしてタグ無しに設定します。昨今、デフォルトVLANを変えることがセキュリティ上優位であるとも思えないので、私は管理用VLANは無条件にデフォルトVLAN（VLAN ID&#x3D;1）で管理するようにしています。</p>\n<img src=\"/new-technology/2022/11/23/unifi-switch/netapp6.png\" class=\"\" width=\"1024\" title=\"alt\">\n<p>ProfileではこのようにネイティブVLANがどのネットワークか定め、タグ付きのVLANを追加で選択していきます。この例では、 UniFi-APはデフォルトVLANで接続し、AP同士の制御用パケットは全てデフォルトVLAN配下に流れます。また、タグ付きネットワークでVLAN-XXX（一般端末向け）とGuestがありますが、UniFi-APは複数のネットワークに属することができますので1つのAPで複数のネットワークに対してWi-Fiサービス提供できるようになります。</p>\n<p>ネットワーク機器のLANをデフォルトVLAN、かつ、ネイティブVLAN（タグ無し）としているのは何らかのトラブル時に復旧させやすいという点もあります。</p>\n<p>なお、SFP＋のインタフェースを持つFirewallなどの機器からホームゲートウェイ(HGW)などRJ45を持つ機器に接続するときにはインタフェースの変換が必要となります。スイッチを2Port、LANとは異なるVLANネットワークにし、RJ45 SFP+モジュールを使うことでインタフェースの変換に使うのもVLANの一つの活用方法です。上記の例ではHGWという名前のVLANを作成し、auひかりから提供されるHGWのRJ45ポートから、スイッチのPort26（RJ45モジュール）へ、FirewallのWAN（SFP＋）をスイッチのPort22へ接続し、実質メディアコンバーターとして使っています。</p>\n<p>SFP+のネットワークカード（NIC）に10GbEのRJ45モジュールを使う事はお勧めしません。電力不足によりリンクアップしなかったり2.5Gbpsでリンクアップするなどの事象が発生する場合があります。また、モジュールの発熱によるNICの故障の原因になります。</p>\n<p>スイッチを最初にAdoptした時はPortのプロファイルは”All”となっています。これはネイティブVLANおよび全てのタグ付きVLANを転送するモードです。VLANを設定しないならProfileはALLのままで使っても構いません。</p>\n<h2 id=\"SSH\"><a href=\"#SSH\" class=\"headerlink\" title=\"SSH\"></a>SSH</h2><p>UniFiスイッチは廉価なSwitch Flex Miniを除き、大半のスイッチはSSH接続が可能です。ネットワークアプリケーションで設定したID&#x2F;パスワードでも接続できますし、公開鍵認証でも接続可能です。スイッチにSSHすると Linuxのインタフェースのように見えます。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ ssh xxx</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">BusyBox v1.25.1 () built-in shell (ash)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">  ___ ___      .__________.__</span><br><span class=\"line\"> |   |   |____ |__\\_  ____/__|</span><br><span class=\"line\"> |   |   /    \\|  ||  __) |  |   (c) 2010-2022</span><br><span class=\"line\"> |   |  |   |  \\  ||  \\   |  |   Ubiquiti Inc.</span><br><span class=\"line\"> |______|___|  /__||__/   |__|</span><br><span class=\"line\">            |_/                  https://www.ui.com</span><br><span class=\"line\"></span><br><span class=\"line\">      Welcome to UniFi USW-Aggregation!</span><br><span class=\"line\"></span><br><span class=\"line\">********************************* NOTICE **********************************</span><br><span class=\"line\">* By logging <span class=\"keyword\">in</span> to, accessing, or using any Ubiquiti product, you are     *</span><br><span class=\"line\">* signifying that you have <span class=\"built_in\">read</span> our Terms of Service (ToS) and End User   *</span><br><span class=\"line\">* License Agreement (EULA), understand their terms, and agree to be       *</span><br><span class=\"line\">* fully bound to them. The use of SSH (Secure Shell) can potentially      *</span><br><span class=\"line\">* harm Ubiquiti devices and result <span class=\"keyword\">in</span> lost access to them and their data. *</span><br><span class=\"line\">* By proceeding, you acknowledge that the use of SSH to modify device(s)  *</span><br><span class=\"line\">* outside of their normal operational scope, or <span class=\"keyword\">in</span> any manner             *</span><br><span class=\"line\">* inconsistent with the ToS or EULA, will permanently and irrevocably     *</span><br><span class=\"line\">* void any applicable warranty.                                           *</span><br><span class=\"line\">***************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">USW-Aggregation-US.6.3.13<span class=\"comment\"># cd /var/log</span></span><br><span class=\"line\">USW-Aggregation-US.6.3.13<span class=\"comment\"># vi messages</span></span><br><span class=\"line\">USW-Aggregation-US.6.3.13<span class=\"comment\"># ping 192.168.x.100</span></span><br><span class=\"line\">PING 192.168.x.100 (192.168.x.100): 56 data bytes</span><br><span class=\"line\">64 bytes from 192.168.x.100: <span class=\"built_in\">seq</span>=0 ttl=64 time=0.000 ms</span><br><span class=\"line\">64 bytes from 192.168.x.100: <span class=\"built_in\">seq</span>=1 ttl=64 time=10.000 ms</span><br><span class=\"line\">64 bytes from 192.168.x.100: <span class=\"built_in\">seq</span>=2 ttl=64 time=10.001 ms</span><br><span class=\"line\">64 bytes from 192.168.x.100: <span class=\"built_in\">seq</span>=3 ttl=64 time=10.000 ms</span><br><span class=\"line\">64 bytes from 192.168.x.100: <span class=\"built_in\">seq</span>=4 ttl=64 time=10.001 ms</span><br></pre></td></tr></table></figure>\n\n<p><code> /var/log/messages</code>にはsyslogがありますので、たまには中身を確認されることをお勧めします（viコマンドなどで開きます）。表向き、SFPモジュールが動作しているように見えても、互換性の問題でエラーを吐いている場合もあります。ダイレクトアタッチケーブルなどを対向の端末を繋がずスイッチに接続している場合など定期的にLinkDownのアラートが出ている場合もあります。RJ45とは動きは異なります。</p>\n<p>上記はUSW-Aggregationに接続した状態ですが、pingも動作しますが、レスポンスは悪いです。LAN内の機器の応答に10ms掛かっていますが驚かないでください。スイッチのデータ転送は専用チップ（ASIC）が行うため、機器のCPUがスイッチの実力にはなりません。OSに割り当てるCPUリソースの関係でしょうか、このpingの応答速度は「ご参考」として割り切った方が良さそうです。</p>\n<h3 id=\"スイッチの詳細情報について\"><a href=\"#スイッチの詳細情報について\" class=\"headerlink\" title=\"スイッチの詳細情報について\"></a>スイッチの詳細情報について</h3><p>Linuxのコンソールから、<code>cli</code>コマンドを投入することで、Ciscoライクなスイッチのコマンドモードに入ることができます。<br>コマンド入力途中でタブを押下するとコマンドが補完されます。<br><code>show  running-config</code>などそのまま使えます。<code>copy running-config startup-config</code>なども実行できそうですが、UniFiではネットワークアプリケーションから完全同期されていることが大前提であり、コマンドモードで設定しても再起動時にはネットワークアプリケーションから上書きされてしまいます。<br>ややこしいのは、スイッチ毎にコマンドの互換性が殆どないことです。コマンドの途中で<code>&quot;？&quot;</code>を入力すると、実行できるパラメータが列挙されるので推測でコマンドを補完しながら入力することになります。私の知る限り、機種毎のコマンドラインのマニュアルは存在しないようです。</p>\n<h3 id=\"USW-Pro-Aggregation-L3スイッチ\"><a href=\"#USW-Pro-Aggregation-L3スイッチ\" class=\"headerlink\" title=\"USW-Pro-Aggregation(L3スイッチ)\"></a>USW-Pro-Aggregation(L3スイッチ)</h3><p>このスイッチは比較的コマンドが充実しています。<code>cli</code>でコマンドモードに入り、<code>en</code>で特権モードに入ります。<br>Portの状況を見るには以下のコマンドを使います。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">(UBNT) #show interface ethernet 0/x</span><br></pre></td></tr></table></figure>\n<p>これだと100行余りの結果が表示されるのでパイプ（｜）で区切り、必要な項目だけフィルタできます。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">(UBNT) #show interface ethernet 0/x | include Error|Collision|Discard</span><br><span class=\"line\"></span><br><span class=\"line\">Total Packets Received Without Errors.......... 43388669</span><br><span class=\"line\">Receive Packets Discarded...................... 0</span><br><span class=\"line\">Total Packets Received with MAC Errors......... 0</span><br><span class=\"line\">Alignment Errors Received...................... 0</span><br><span class=\"line\">FCS Errors Received............................ 0</span><br><span class=\"line\">URPF Discards.................................. 0</span><br><span class=\"line\">Transmit Packets Discarded..................... 0</span><br><span class=\"line\">Total Transmit Errors.......................... 0</span><br><span class=\"line\">FCS Errors Transmitted......................... 0</span><br><span class=\"line\">Total Transmit Packets Discarded............... 0</span><br><span class=\"line\">Single Collision Frames........................ 0</span><br><span class=\"line\">Multiple Collision Frames...................... 0</span><br><span class=\"line\">Excessive Collision Frames..................... 0</span><br><span class=\"line\"></span><br><span class=\"line\">(UBNT) #</span><br></pre></td></tr></table></figure>\n\n<p>このようにして重要な情報のみ取得できます。あくまで一般的なパラメータとしていますが、現代の全二重の通信前提であればCollisionまで見る必要はないですね。一般的にはReceiveでエラーがあるときはケーブルを最初に疑ってみること、Transmit Packets Discardedの場合はVLANの設定が間違っている可能性があることでしょうか。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">clear counters all</span><br></pre></td></tr></table></figure>\n<p>カウンタをクリアします。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">show fiber-ports optics-info all</span><br></pre></td></tr></table></figure>\n<p>モジュールのメーカーやシリアル番号を表示します。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">(UBNT) #show fiber-ports optics all</span><br><span class=\"line\"></span><br><span class=\"line\">                                                 Output   Input</span><br><span class=\"line\">Port    Physical Port/  Temp  Voltage  Current   Power    Power     TX     LOS</span><br><span class=\"line\">        Lane Number     [C]   [Volt]     [mA]    [dBm]    [dBm]     Fault</span><br><span class=\"line\">------  --------------  ----  -------  -------   -------  -------   -----  ---</span><br><span class=\"line\">0/4     0/4-Lane1       34.2    3.328     10.2    -3.370   -2.496   No     No</span><br><span class=\"line\">0/5     0/5-Lane1       34.5    3.265     10.4    -2.976   -3.373   No     No</span><br><span class=\"line\">0/8     0/8-Lane1       34.0    3.360     10.2    -3.799   -1.643   No     No</span><br><span class=\"line\">0/9     0/9-Lane1        N/A      N/A      N/A       N/A      N/A   N/A    N/A</span><br><span class=\"line\">0/12    0/12-Lane1       N/A      N/A      N/A       N/A      N/A   N/A    N/A</span><br><span class=\"line\">0/15    0/15-Lane1       N/A      N/A      N/A       N/A      N/A   N/A    N/A</span><br><span class=\"line\">0/18    0/18-Lane1       N/A      N/A      N/A       N/A      N/A   N/A    N/A</span><br><span class=\"line\">0/19    0/19-Lane1       N/A      N/A      N/A       N/A      N/A   N/A    N/A</span><br><span class=\"line\">0/22    0/22-Lane1       N/A      N/A      N/A       N/A      N/A   N/A    N/A</span><br><span class=\"line\">0/26    0/26-Lane1      33.3    3.235      6.0    -3.002   -3.002   No     No</span><br><span class=\"line\"></span><br><span class=\"line\"> Temp - Internally measured transceiver temperatures.</span><br><span class=\"line\"> Voltage - Internally measured supply voltage.</span><br><span class=\"line\"> Current - Measured TX bias current.</span><br><span class=\"line\"> Output Power - Measured optical output power relative to 1mW.</span><br><span class=\"line\"> Input Power - Measured optical power received relative to 1mW.</span><br><span class=\"line\"> TX Fault - Transmitter fault.</span><br><span class=\"line\"> LOS - Loss of signal.</span><br><span class=\"line\"></span><br><span class=\"line\">(UBNT) #</span><br></pre></td></tr></table></figure>\n<p>モジュールのDDM（温度、光の強さ）を表示します。</p>\n<h3 id=\"USW-Aggregation-SFP-8Port\"><a href=\"#USW-Aggregation-SFP-8Port\" class=\"headerlink\" title=\"USW-Aggregation(SFP+ 8Port)\"></a>USW-Aggregation(SFP+ 8Port)</h3><p>このスイッチは<code>cli</code>でコマンドモードに入ったら、すぐに大半のコマンドが実行できます。代表的なのは以下のものです。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">show interfaces TenGigabitEthernet x</span><br></pre></td></tr></table></figure>\n<p>Port xのPort状況を表示します。パケットカウントやコリジョンなどの数を示します。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">clear interfaces TenGigabitEthernet  x counters</span><br></pre></td></tr></table></figure>\n<p>Port xのカウンタをクリアします。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">show fiber-transceiver-info interfaces  TenGigabitEthernet  x</span><br></pre></td></tr></table></figure>\n<p>SFPモジュールの種類やシリアル番号を表示します。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">show fiber-transceiver interfaces  TenGigabitEthernet x</span><br></pre></td></tr></table></figure>\n<p>SFPモジュールのDDM（信号の強さ、温度）を示します。</p>\n<h2 id=\"L3スイッチの制約\"><a href=\"#L3スイッチの制約\" class=\"headerlink\" title=\"L3スイッチの制約\"></a>L3スイッチの制約</h2><p>UniFiのL3スイッチはDHCP機能を持ちますが、管理機能やルーティングについてはIPv6には対応していません。スイッチ自身はIPv6アドレスを持てるようですが、現段階でIPv6のL3ルーティングできるようにはなっていません。別のルーターでDHCPv6を割り当て、そちらをゲートウェイにするなどが必要です。L2スイッチを含めてIPv6通信が行えないということではありません。</p>\n<h2 id=\"SFPモジュール\"><a href=\"#SFPモジュール\" class=\"headerlink\" title=\"SFPモジュール\"></a>SFPモジュール</h2><p>Ubiquitiのモジュール群は廉価なため、光モジュールは純正が間違いないでしょう。OM3ケーブルやDACはさまざまなメーカーのものを使いましたが、UniFi製品で問題が発生したことはありません。RJ45モジュールは特に10GbEのものは低電力を踏まえるとSFPメーカーの製品を選定することになります。</p>\n<img src=\"/new-technology/2022/11/23/unifi-switch/module.png\" class=\"\" width=\"640\" title=\"alt\">\n\n<p>1GbE tp-link TL-SM331<br>一般的なMarvell社88E1111などを使ったモジュールが通常使用（Typical）で1.05Wの消費電力なのに対し、その半分以下の0.5Wとなっており、発熱もかなり抑えられています。最近、国内でも発売になったようですが、私は今年の5月に米Amazonで$19.99で購入し、問題なく使えています。</p>\n<blockquote>\n<p>tp-link<br> <a href=\"https://www.tp-link.com/jp/service-provider/switch-accessory/tl-sm331t/\">https://www.tp-link.com/jp/service-provider/switch-accessory/tl-sm331t/</a></p>\n</blockquote>\n<p>10GbE Fiber mall SFP-10G-T-UB-80m<br>80mまで対応した省電力の10GbEモジュールです。こちらも米Amazonで購入しました。＄68.99でした。BroadcomのBCM84891のチップを採用している80mに対応したモジュールはいくつか存在します。Cisco用のモジュール（SFP-10G-TS80）についてはメーカーの公表ではDDMに対応していないと記載があるものの、UniFiスイッチ上では、モジュールの温度などのパラメータが出力されています。</p>\n<blockquote>\n<p>Fiber mall<br> <a href=\"https://www.fibermall.com/ja/news/10g-copper-sfp.htm\">https://www.fibermall.com/ja/news/10g-copper-sfp.htm</a></p>\n</blockquote>\n<p>英語ですが、ぜひAmazonのカスタマーレビューを見てください。より詳細で素晴らしい知見に基づいたコメントが見られます。</p>\n<blockquote>\n<p>米Amazon Customer Review<br> <a href=\"https://www.amazon.com/gp/customer-reviews/RLHW2OL4I1QZP/ref=cm_cr_dp_d_rvw_ttl?ie=UTF8&amp;ASIN=B0B18BY1XK\">https://www.amazon.com/gp/customer-reviews/RLHW2OL4I1QZP/ref=cm_cr_dp_d_rvw_ttl?ie=UTF8&amp;ASIN=B0B18BY1XK</a></p>\n</blockquote>\n<h2 id=\"PoE\"><a href=\"#PoE\" class=\"headerlink\" title=\"PoE\"></a>PoE</h2><p>スイッチにおけるPoEもネットワークアプリケーションから設定できます。USW-Enterprise-8-PoEの例では、Switch Flex MiniおよびAPのU6 Proに給電している状況が確認できます。</p>\n<img src=\"/new-technology/2022/11/23/unifi-switch/netapp9.png\" class=\"\" width=\"640\" title=\"alt\">\n\n<p>Port ManagementからPoEのOn&#x2F;Offが可能となっています。</p>\n<h2 id=\"まとめ\"><a href=\"#まとめ\" class=\"headerlink\" title=\"まとめ\"></a>まとめ</h2><p>これらのように、ネットワークスイッチをただ単に繋げるための道具ではなく、ITやネットワークを見える化するという目的においては非常に有用な機器になります。セキュリティ観点ではできることは限られていますが、ホームユーザーにとっても有用な機能は活用できると思われます。</p>\n","categories":["Network","Hardware"],"tags":["SFP+","10GbE","UniFi"]},{"title":"UniFi Network Applicationの運用","url":"/new-technology/2022/10/23/unifi-network-application2/","content":"<img src=\"/new-technology/2022/10/23/unifi-network-application2/unifi1.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p class=\"onepoint\">この記事で実現すること</p>\n\n<p>前回記事「<a href=\"/new-technology/2022/09/23/unifi-network-application/\" title=\"UniFi Network Applicationのセットアップ\">UniFi Network Applicationのセットアップ</a>」では、UniFi Network ApplicationをUbuntu上にセットアップし、UniFiネットワーク製品の登録（Adoption）までを行いました。この記事ではホームユーザーがUniFi製品を運用していくにあたり、必要な操作ができるようになることを目的としています。</p>\n<span id=\"more\"></span>\n\n<h2 id=\"UniFiデバイス一覧およびアップデート\"><a href=\"#UniFiデバイス一覧およびアップデート\" class=\"headerlink\" title=\"UniFiデバイス一覧およびアップデート\"></a>UniFiデバイス一覧およびアップデート</h2><p><code>https://UniFi Network Application Host:8443/</code>に接続すると左にカテゴリのアイコンが並びます。以下のように左の赤枠で囲った<mark class=\"label primary\">UNIFI DEVICES</mark>一覧では現在のAdoptされているUniFi機器の一覧が確認できます。</p>\n<img src=\"/new-technology/2022/10/23/unifi-network-application2/u1.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p>バージョンアップの通知があれば、ここで<mark class=\"label primary\">Click to Update</mark>のように表示されますので、これをクリックしてデバイスのアップデートが行えます。<br>リリースの情報についてはCommunityを参照することになります。</p>\n<blockquote>\n<p>UniFi リリース一覧<br> <a href=\"https://community.ui.com/releases/\">https://community.ui.com/releases/</a></p>\n</blockquote>\n<img src=\"/new-technology/2022/10/23/unifi-network-application2/rel.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p>ここでは、<mark class=\"label primary\">Official</mark>または<mark class=\"label primary\">Release Candidate(リリース候補）</mark>と区分されています。Network Applicationの初期設定では、Officialのものが自動的にアップデートされる仕組みになっています。後に説明する設定画面で、Official,Release Candidate,Early Accessと3つの区分を選択可能です。</p>\n<p>実際のリリースのポストを参照すると先頭には簡単なリリースノーツが記述されており、それ以下でユーザーによるレポートが続きます。前回も記載しましたが、マニュアルがないことや製品提供機能やUbiquitiの今後の方向性があまり見えてこないこともあり、他のプロダクトと比較しても、ユーザーからは辛辣な意見が寄せられる事が多いです。単なる不満（ユーザーのスキル不足や、製品への過剰な期待や思い込みが原因である事も多いように感じられます）の投稿によって重要な情報を見失わないようにすることが大事です。詳細な検証結果など貴重な情報を提供してくれるユーザーも存在しています。</p>\n<p>デバイスを選択すると個々のデバイスのトラフィック状況などが確認できます。<mark class=\"label primary\">Settings</mark>に進むとバージョンアップや再起動、ファームウェアのロールバックなどが実行できます。また、デバイスをリセットする場合や他のネットワークに使う場合は、<mark class=\"label primary\">Forget</mark>を選択します。</p>\n<img src=\"/new-technology/2022/10/23/unifi-network-application2/u2.png\" class=\"\" width=\"360\" title=\"alt\">\n\n<p>ファームウェアをロールバック（ダウングレード）する場合は、該当製品のファームウェアバージョンのURLを指定します。ここで説明している使い方は、Ubiquitiクラウド連携を前提としており、UniFiネットワークアプリケーション、スイッチ共にインターネットへ接続可能である必要があります。リリース一覧は以下のURLから確認します。</p>\n<blockquote>\n<p>UniFi APなど<br><a href=\"https://www.ui.com/download/unifi/\">https://www.ui.com/download/unifi/</a></p>\n</blockquote>\n<blockquote>\n<p>UniFi スイッチ<br><a href=\"https://www.ui.com/download/unifi-switching-routing\">https://www.ui.com/download/unifi-switching-routing</a></p>\n</blockquote>\n<img src=\"/new-technology/2022/10/23/unifi-network-application2/dl.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p>左メニューのプルダウンから製品を選択すると以下のように最新バージョンが表示されます。ここから<mark class=\"label primary\">PAST FIRMWARE</mark>を選択し、具体的なバージョンを指定してから、ダウンロードを選択するとURLが示されるので、そのURLをネットワークアプリケーションのデバイスのURLに貼り付け、Updateを実行します。</p>\n<img src=\"/new-technology/2022/10/23/unifi-network-application2/rel1.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<p>ここまでの作業はスマホアプリ（UniFi Network）でも同様の操作が可能です。</p>\n<h2 id=\"クライアントデバイス一覧\"><a href=\"#クライアントデバイス一覧\" class=\"headerlink\" title=\"クライアントデバイス一覧\"></a>クライアントデバイス一覧</h2><p>以下のように左の赤枠で囲った<mark class=\"label primary\">CLIENT DEVICES</mark>では現在のUniFiネットワークに接続されているクライアント一覧が確認できます。</p>\n<img src=\"/new-technology/2022/10/23/unifi-network-application2/u3.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p>ここではIPアドレス、クライアントが所属するVLAN、接続しているWi-Fiの情報、トラフィックなどが確認できます。もし、UniFiのL3スイッチがあれば、L3スイッチにDHCP機能があるので、この画面からスタティックIPアドレスを設定可能です。</p>\n<p>この画面もスマホアプリで同様の操作と確認ができます。</p>\n<h2 id=\"設定\"><a href=\"#設定\" class=\"headerlink\" title=\"設定\"></a>設定</h2><p>以下のように左の赤枠で囲った<mark class=\"label primary\">SETTINGS</mark>ではUniFi製品群の全般的な設定をします。なおこの記事のUniFiの構成では、UDM Proなどのセキュリティゲートウェイを保有していない状態であり、単独のUniFi Network Applicationの設定例となります。以下の左側メニューの<mark class=\"label primary\">Internet</mark>、<mark class=\"label primary\">VPN</mark>、<mark class=\"label primary\">Traffic Management</mark>、<mark class=\"label primary\">Firewall & Security</mark>は対象外です。</p>\n<img src=\"/new-technology/2022/10/23/unifi-network-application2/u4.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<h3 id=\"WiFi\"><a href=\"#WiFi\" class=\"headerlink\" title=\"WiFi\"></a>WiFi</h3><p>WiFi設定では名前、所属するVLAN、チャンネルなど設定します。UniFiは集中型管理であるため、個々のAP毎に設定するよりはネットワーク全体でどのように管理するかを決めるモデルとなります。</p>\n<ul>\n<li><p>Global AP Settings<br> この設定で、複数APを立てることを想定し、全般設定を行います。</p>\n</li>\n<li><p>Channel Width<br> 2.4GHz、5GHzそれぞれでバンド幅を設定します。ここは個人の好みによりますが、一般的なデバイスのために2.4GHzは20MHzを、5GHzでは80MHzを設定することをお勧めします。もちろん、PCなども無線でできるだけ速度を求める方は160MHzの設定が可能です。こういった場合は、AP単位にバンド幅を個別設定し、クライアント単位に接続させるAPを固定させる事ができます。</p>\n</li>\n<li><p>Transmit Power<br> 無線の送信出力を決めます。Auto&#x2F;High&#x2F;Medium&#x2F;Lowが選択できます。</p>\n</li>\n<li><p>AP Site Settings<br> Wiress Meshingの項目がありますが、メッシュ製品（無線によるバックホール接続）は現在日本では発売されていません。</p>\n</li>\n<li><p>Nightly Channel Optimization<br> 夜間に外部のWiFiの電波状況を見ながらUniFi側でWiFiチャネルの最適化を行います。比較的近い距離で同一のチャンネルを選択していると競合することになるのでこれは実際にテストしながら選択されることをお勧めします。</p>\n</li>\n</ul>\n<p>これより詳細のWiFi設定についてはまた別の機会があれば書きたいと思います。</p>\n<h3 id=\"Networks\"><a href=\"#Networks\" class=\"headerlink\" title=\"Networks\"></a>Networks</h3><p>Networksでは主にVLANとスイッチの全般設定をします。</p>\n<img src=\"/new-technology/2022/10/23/unifi-network-application2/u5.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p>今回の記事は概要に留めますが、VLANを構成する場合にはスイッチ単位ではなく、ネットワークアプリケーションでネットワーク全体の構成を決めることになります。もし、UniFiのL3スイッチがあり、L3ネットワークにするのであれば、L3のDHCPを有効にします。L3スイッチがない場合で単にL2のVLANを作成する場合は、<mark class=\"label primary\">VLAN Only Network</mark>としてVLANを作成し、ルーティングやDHCP機能はFirewallやルータに任せることになります。</p>\n<p>一旦ネットワークアプリケーションでVLANを定義すると、どのスイッチからもそのVLANが利用できるようになります。</p>\n<p>以下はFirewallを利用する場合の一例です。インターネット接続がホームゲートウェイとなる場合、もちろんFirewallとHGWとを直結しても構いませんが、トラフィックを把握するためにVLANを定義し、FirewallのWANとHGWとをスイッチに接続します。こういった場合にはUniFiスイッチではFirewallの外側（ホームゲートウェイ側）と内側（LAN）のネットワークとを分離するため、VLAN OnlyでWANのVLANを作成することになります。</p>\n<img src=\"/new-technology/2022/10/23/unifi-network-application2/switch.drawio.png\" class=\"\" width=\"480\" title=\"alt\">\n\n<p>UniFiネットワークの初期設定ではVLANが無い状態であり、”ALL”というプロファイルになります。これは全てのVLANを転送するPortになります。セグメントを分離する場合は、ALLを使わず、Defaultに加え、WAN、管理用という具合にそれぞれの独立したネットワークを作成することになります。マルチプルVLANを使う場合にはALLプロファイルを使います。一般的な個人向けのルータを使い、シンプルに一つのセグメント（例えば192.168.1.x&#x2F;24）だけがある環境で、自宅用と会社用との端末の相互アクセスを禁止する場合はマルチプルVLANは便利です（この場合はルータをALLプロファイル、自宅用の端末はDefault、会社用端末はVLAN1という具合に分離します）。</p>\n<p>ESXiなどでLAN用に複数の物理Portが存在する場合、仮想マシンを使うセグメントと仮想マシンのバックアップ用（NAS）LANとトラフィックを分離するのも一つの使い方です。</p>\n<ul>\n<li><p>Global Network Settings<br> ネットワーク設定全般を行います。スイッチの共通設定部分になります。</p>\n</li>\n<li><p>Multicast DNS<br> Apple AirPlayやGoogle Chromecastのためにネットワークセグメントを超えてmDNS(Bonjour)の名前解決およびデータ配信を支援します。</p>\n</li>\n<li><p>IGMP Snooping<br> 本来は、マルチキャストトラフィックを使っていないクライアントに対してはパケットの転送を抑制するためのものですが、スイッチでPackets Discardedのカウンタが増えるのが気になり私は無効にしています。WiFiネットワークがあるセグメントにひかりTVなど、対象セグメントに一定量のマルチキャストトラフィックを流すのが気になる場合はセグメントをVLANで分離する方がお勧めです。</p>\n</li>\n<li><p>Global Switch Settings<br> 複数スイッチの共通設定を指定します。主には、Flow Control、Jumbo Framesがあります。また固有のスイッチだけフローコントロールを外すとか個別設定が可能なように、<mark class=\"label primary\">Switch Exclusion</mark>から該当するスイッチを選択できます。</p>\n</li>\n</ul>\n<h3 id=\"System\"><a href=\"#System\" class=\"headerlink\" title=\"System\"></a>System</h3><p>Systemでは主にネットワークアプリケーション全般設定をします。</p>\n<img src=\"/new-technology/2022/10/23/unifi-network-application2/u6.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<mark class=\"label primary\">Network Notification</mark>で通知設定ができます。これはメール、スマホアプリへの通知、ネットワークアプリケーション画面上での通知が選択できます。ファームウェア通知、APのレーダー受信、クライアントの接続/切断通知など設定項目は多岐にわたります。\n\n<p>その他主要項目を抜粋します。</p>\n<ul>\n<li><p>Updates<br> ここではデバイスのファームウェア情報についての設定です。ネットワークアプリケーション自身のアップデートがある場合、デバイスのアップデートがある場合は通知できます。ここで接続チャネル（Officail&#x2F;Release Candidate&#x2F;Early Access）が選べます。なお、ネットワークアプリケーションはインストールで実施したようにShellスクリプトで実施することになります（後述します）。</p>\n</li>\n<li><p>Device Auto Updates<br> デバイスを自動的にアップデートするか選択します。最新ファームウェアが公開されると時刻に関係なくアップデートされるので、ここはオフに設定し、<mark class=\"label primary\">Schedule Device Updates</mark>で週末などにアップデートする設定を追加することをお勧めします。</p>\n <img src=\"/new-technology/2022/10/23/unifi-network-application2/u7.png\" class=\"\" width=\"240\" title=\"alt\">\n</li>\n<li><p>Backup<br> ネットワークアプリケーションの設定のバックアップです。日次、週次、月次でバックアップ可能です。トラフィックログも併せてバックアップが可能です。</p>\n</li>\n<li><p>System Logging<br> デバイスのログをsyslogに転送できます。syslogサーバのIPアドレスとPort（一般的に514）を設定します。</p>\n</li>\n<li><p>Network Device SSH Authentication<br> スイッチやAPに対しSSH可能です。スイッチの詳細なカウンタを取得するために必要です。カウンタのエラーが無いか、切断回数などを確認するために使います。パスワード認証または公開鍵を設定することでUniFiデバイスへ接続可能になります。</p>\n <img src=\"/new-technology/2022/10/23/unifi-network-application2/u8.png\" class=\"\" width=\"480\" title=\"alt\">\n</li>\n<li><p>Other Configuration<br> NTPの設定、メールサーバーの設定ができます。メールサーバーはCloudを選択するとUbiquitiクラウドからメール通知が行われます。</p>\n</li>\n</ul>\n<h2 id=\"Network-Applicationのバージョンアップ\"><a href=\"#Network-Applicationのバージョンアップ\" class=\"headerlink\" title=\"Network Applicationのバージョンアップ\"></a>Network Applicationのバージョンアップ</h2><p>Network ApplicationはこのGUIから更新することはできず、前回記事「<a href=\"/new-technology/2022/09/23/unifi-network-application/\" title=\"UniFi Network Applicationのセットアップ\">UniFi Network Applicationのセットアップ</a>」で説明したLinuxのシェルからアップデートスクリプトを実行することになります。Windows、macOSでお使いの方は最新モジュールをダウンロードし、セットアップを実行することになります。ここではUbuntuのアップデートの例を記載します。</p>\n<p>スクリプトの情報は、コミュニティにあります。<br><a href=\"https://community.ui.com/questions/UniFi-Installation-Scripts-or-UniFi-Easy-Update-Script-or-UniFi-Lets-Encrypt-or-UniFi-Easy-Encrypt-/ccbc7530-dd61-40a7-82ec-22b17f027776\">https://community.ui.com/questions/UniFi-Installation-Scripts-or-UniFi-Easy-Update-Script-or-UniFi-Lets-Encrypt-or-UniFi-Easy-Encrypt-/ccbc7530-dd61-40a7-82ec-22b17f027776</a></p>\n<p>セットアップで失敗した際にすぐに戻れるように、このタイミングでESXiのスナップショット、またはバックアップの取得をお勧めします。</p>\n<p>実行は3ステップです。Ubuntuの<mark class=\"label primary\">端末</mark>から、以下のコマンドを実行します。</p>\n<ol>\n<li><p>管理者になります</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ sudo -i</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>証明書などのダウンロードをします。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ apt-get update; apt-get install ca-certificates wget -y</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>ネットワークアプリケーションのアップデートを行います。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ <span class=\"built_in\">rm</span> unifi-update.sh &amp;&gt; /dev/null; wget https://get.glennr.nl/unifi/update/unifi-update.sh &amp;&amp; bash unifi-update.sh</span><br></pre></td></tr></table></figure></li>\n</ol>\n<p>上記のCommunityでは、個別のバージョンのスクリプトシェルへのリンクもありますので、unifi-updates.shの代わりに、バージョンを指定したスクリプトでインストールすることもできます。ロールバックは対応していないとの情報があるので、私はESXiでのバックアップを保存するようにしています。</p>\n","categories":["Network"],"tags":["UniFi"]},{"title":"macOSのアプリケーションファイアウォール Vallum","url":"/new-technology/2021/09/04/vallum/","content":"<img src=\"/new-technology/2021/09/04/vallum/vallum-title.png\" class=\"\" title=\"alt\">\n\n<p class=\"onepoint\">この記事で実現すること</p>\n\n<p>macOS(Big Sur)向けアプリケーションファイアウォールのVallumを使い、macOS標準のファイアウォールよりも高度な制御をします。自宅のWi-Fiの接続状態やVPN接続状態に応じたコントロールが可能です。</p>\n<span id=\"more\"></span>\n\n<h2 id=\"Vallumについて\"><a href=\"#Vallumについて\" class=\"headerlink\" title=\"Vallumについて\"></a>Vallumについて</h2><p>Vallum4は、macOS Big Sur向けに作成されたアプリケーションファイアウォールです。Catalina以前のmacOSにはVallum3が提供されています。作者はイタリアの方で現在3名程度のチームでエンハンスされているようです。仕組みとしてはアプリケーション毎に外への接続要求、および受信を受け入れる要求とをそれぞれにルールを決めるタイプのものです。Vallumの価格は＄15に日本国内の消費税を加え、1,850円前後でとても安価です。</p>\n<p>ファイアウォールは一般的に上位のルールから順に下位に順次チェックを行っていき、ルールが最初に一致したものを選択しアクセス制御をするのが一般的です。しかし、このVallumはファイアウォールルールが特徴的で、複数一致するルールを用意し、最後に一致したものが採用されるという方式です。</p>\n<p>Vallum4から実装された機能に接続中のWi-FiのAP名でルールを機動的に変更できます。仕事用のAPと自宅用APとで制御を変えるなど、外出事の運用には非常に有用です。</p>\n<blockquote>\n<p>Vallum Firewall<br> <a href=\"https://vallumfirewall.com/\">https://vallumfirewall.com</a></p>\n</blockquote>\n<h2 id=\"アプリケーションファイアーウォールの有用性\"><a href=\"#アプリケーションファイアーウォールの有用性\" class=\"headerlink\" title=\"アプリケーションファイアーウォールの有用性\"></a>アプリケーションファイアーウォールの有用性</h2><p>個人向けのサイバーセキュリティ対策としてのアプリケーションファイアーウォールは難易度が高いことや、アプリケーションの信頼性評価が難しい事によって積極的に厳格な設定を勧める記事はあまり見かけません。しかし、昨今のランサムウェアなどの個人向けサイバー攻撃の脅威を考えると、アプリケーション自身に悪意はなくとも、脆弱性を悪用されるケースが懸念されます。アプリケーションの振る舞いを把握し制約を与える事は個人向けの一歩進んだセキュリティ対策と言えるでしょう。Windowsでは、Windows Defenderの<mark class=\"label primary\">セキュリティが強化されたWindows Defenderファイアウォール</mark>の設定で、受信&#x2F;送信それぞれのルール毎にIPアドレスやPortを詳細にフィルタできます。なお、セキュリティ対策ソフトに付属するアプリケーションファイアウォールはレピュテーションチェック<sup><a href=\"#note1\"><strong>[1]</strong></a></sup>がメインであり、アプリケーションの信頼性評価によって通信の可否をコントロールする事を目的としていますので趣旨は異なります。</p>\n<p>一方、macOSのファイアウォールには昔から<strong>Little Snitch</strong>という定番のソフトウェアがあります。これは非常にグラフィカルで、世界地図を見せながらどの場所からアクセスしているのか、非常にわかりやすくなっています。こちらはアプリケーションの特性からどの範囲に通信を認めるかをユーザーが厳格に決める事を目的としています。45ユーロなので6,000円弱というコストで非常に長い間多くの方に愛用されているソフトウェアです。</p>\n<blockquote>\n<p>Little Snitch<br> <a href=\"https://www.obdev.at/products/littlesnitch/index.html\">https://www.obdev.at/products/littlesnitch/index.html</a></p>\n</blockquote>\n<p>Little Snitchのおかげか、macOSユーザーがアプリケーションファイアウォールに求めるレベルは高いものがあります。グラフィカルな見せ方や設定よりも、シンプルに細かい制御をしたいという事であればVallum Firewallは廉価でお勧めです。</p>\n<p>この記事ではVallumを使い、以下のセキュリティ強化策を実現します。</p>\n<ol>\n<li>ローカルネットワークへのアクセス不要なアプリケーションはアクセス要求を拒否します。</li>\n<li>インターネット接続先が固有ドメインなど決まっている場合はそのドメインのみ許可します。</li>\n<li>受信ルールとして最低限度必要なサービスのみ受信要求を許可します。</li>\n<li>自宅と自宅外で受信ルールを変え、外出先ではさらに受信要求を拒否します。</li>\n</ol>\n<p>Vallumは、アプリケーションのレピュテーションをチェックする機能はありません。しかし、macOSの場合はフォルダへのアクセス権など<strong>セキュリティとプライバシー</strong>でアプリケーション毎に明確に設定可能です。またApp StoreやHomebrewを使う事で正当なアプリケーションである事に一定の信頼性が担保されています。</p>\n<h2 id=\"Vallum設定の一例（Outbound）\"><a href=\"#Vallum設定の一例（Outbound）\" class=\"headerlink\" title=\"Vallum設定の一例（Outbound）\"></a>Vallum設定の一例（Outbound）</h2><p>いくつかOutbound（外に出ていく通信）のルールの例を挙げてみます。まずは翻訳ソフトのDeepLです。</p>\n<img src=\"/new-technology/2021/09/04/vallum/rule1.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p>これは翻訳するためにDeepLのサイトに接続する事だけを許可するというわかりやすい例です。そして、 <strong>Locals</strong>というのは私が作成したグループですが、IPv4、IPv6のプライベートネットワークアドレス（リンクローカル、IPv6のULAを含む）です。翻訳ソフトは自宅のネットワークのホストにアクセスする必要は無いので、プライベート宛通信をブロックしています。iOSの<strong>ローカルネットワーク</strong>の機能で制限を与えるのと同等の設定になります。</p>\n<p>ルールに無いものは自動的にポップアップされ、その動作をユーザーに決めるよう促されます。</p>\n<img src=\"/new-technology/2021/09/04/vallum/rule2.png\" class=\"\" width=\"360\" title=\"alt\">\n\n<p>上記の例、例えばSafariであれば、さまざまなURLへとアクセスするので、個々のサイト、ドメインに対して許可するのではなく、Safariに対してインターネットアクセス全てを認める事になるでしょう。</p>\n<h2 id=\"Vallumのセットアップ\"><a href=\"#Vallumのセットアップ\" class=\"headerlink\" title=\"Vallumのセットアップ\"></a>Vallumのセットアップ</h2><p>まずはVallumのWebサイトに <mark class=\"label primary\">DOWNLOAD VALLUM 4</mark>という文字を見つけそこからダウンロードします。macOSのCatalina以前はVallumのVersionは3となり、この記事での説明は該当しませんのでご注意ください。Vallum4にはBig Surが必要です。2021-9-4時点の最新バージョンは、4.0.3となります。<br>また、Homebrewでもインストール可能です。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">brew install vallum --cask</span><br></pre></td></tr></table></figure>\n<img src=\"/new-technology/2021/09/04/vallum/install.png\" class=\"\" width=\"640\" title=\"alt\">\n\n<p>まず、アプリケーションのインストールが完了するとOS起動時に自動起動するように構成されます。初期セットアップでは、基本ルールをVallum Assistantによって決定します。</p>\n<img src=\"/new-technology/2021/09/04/vallum/setup.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<p>ルールは、Inbound、Outboundそれぞれ分かれています。</p>\n<h3 id=\"Inbound-Policy①\"><a href=\"#Inbound-Policy①\" class=\"headerlink\" title=\"Inbound Policy①\"></a>Inbound Policy①</h3><table>\n<thead>\n<tr>\n<th>項目</th>\n<th>説明</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Pass connections from local networks</td>\n<td>プライベートIP（IPv6はリンクローカル）からの接続要求を許可</td>\n</tr>\n<tr>\n<td>Pass mDNS connections</td>\n<td>マルチキャストDNS(Bonjour) による名前解決の要求を受入</td>\n</tr>\n<tr>\n<td>Block unsigned apps</td>\n<td>署名されていないアプリケーションをブロック</td>\n</tr>\n</tbody></table>\n<mark class=\"label primary\">Block unsigned APP</mark>は止めたくなりますが、最初から厳しくするとトラブルの元になるので最初は外しておいた方が無難でしょうか。ファイアウォールでよくある話です。私の場合、プリンタドライバが該当しました。また、mDNSによる名前解決はWindows、Linuxでも使えるのでそれなりに便利ですが、ここは普段の利用状況で判断してください。\n\n<h3 id=\"Outbound-Policy②\"><a href=\"#Outbound-Policy②\" class=\"headerlink\" title=\"Outbound Policy②\"></a>Outbound Policy②</h3><table>\n<thead>\n<tr>\n<th>項目</th>\n<th>説明</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Pass root connections</td>\n<td>rootユーザーによる接続を許可</td>\n</tr>\n<tr>\n<td>Pass mDNS connections</td>\n<td>マルチキャストDNS(Bonjour) による名前解決の要求を許可</td>\n</tr>\n<tr>\n<td>Pass connections to local networks</td>\n<td>プライベートIP（IPv6はリンクローカル）への接続要求を許可</td>\n</tr>\n<tr>\n<td>Pass connections to Apple and iCloud</td>\n<td>Appleのパブリックネットワークおよび関連ドメイン、iCloudへの接続要求を許可</td>\n</tr>\n<tr>\n<td>Pass all App Store apps</td>\n<td>Appストアでインストールしたアプリケーションは接続要求を許可</td>\n</tr>\n<tr>\n<td>Pass all macOS preinstall apps</td>\n<td>macOSのプリインストールされたアプリケーションは接続要求を許可</td>\n</tr>\n<tr>\n<td>Pass trusted system process</td>\n<td>macOSの信頼されたシステムプロセスは接続要求を許可</td>\n</tr>\n<tr>\n<td>Pass Safari Bookmarks</td>\n<td>ブラウザSafariのブックマークされたURLへの接続要求を許可</td>\n</tr>\n<tr>\n<td>Block unsigned apps</td>\n<td>署名されていないアプリケーションをブロック</td>\n</tr>\n</tbody></table>\n<h3 id=\"ルールに該当しない場合の挙動③\"><a href=\"#ルールに該当しない場合の挙動③\" class=\"headerlink\" title=\"ルールに該当しない場合の挙動③\"></a>ルールに該当しない場合の挙動③</h3><p>これらのデフォルトのルールや個別のアプリケーションで明確なルールが見つからなかった場合の挙動を選択します。</p>\n<ul>\n<li>Request user authorizationユーザーに許可するかどうかをポップアップし判断を促します（デフォルト）</li>\n<li>Block all inbound connections by defaultユーザーに尋ねずInboundの接続要求をブロックします</li>\n<li>Allow all inbound connections by defaultユーザーに尋ねずInboundの接続要求を受け入れます</li>\n<li>Allow all outbound connections by defaultユーザーに尋ねずOutboundの接続要求を許可します。</li>\n</ul>\n<p>最初はデフォルト設定で運用し、安定してきたらInboundの接続要求をブロックするなどカスタマイズされる事をお勧めします。最初から厳しくするとトラブルの元なので慣れるまでは割と緩めの設定が良いでしょう。</p>\n<p>初期設定の後は、常駐プロセスがアクセスする都度、しばらくポップアップのラッシュが続きます。落ち着くまでは<em>Pass</em>ボタンをクリックし続けるしかありませんが、ある程度経ってから、アプリケーション毎にアクセスする形態を鑑み、サブドメイン単位の許可、Port単位の許可など調整していくのが良いでしょう。</p>\n<p>Outboundルールについては、数時間ルールと格闘する事にはなりますが、やがて落ち着きポップアップの頻度も減ってくる事でしょう。</p>\n<h2 id=\"Outboundルール\"><a href=\"#Outboundルール\" class=\"headerlink\" title=\"Outboundルール\"></a>Outboundルール</h2><p>デフォルトのポリシーでセットアップした場合のOutboundルールを見てみましょう。Vallumのアイコンから<mark class=\"label primary\">Firewall Configuration</mark>を選択し、<mark class=\"label primary\">FIREWALLS RULES</mark>の<mark class=\"label primary\">Outbound</mark>を選択します。</p>\n<img src=\"/new-technology/2021/09/04/vallum/outbound-rule1.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<p>Outboundのルール0にユーザーに尋ねる原則ルール（ASK）があります（これは必ず一致するルールです）。ルール1以降に一致する条件が無ければ、ルール0が選択され、”ユーザーに尋ねる”という事です。</p>\n<p>VallumはASKの選択の仕方にも種類があります。</p>\n<img src=\"/new-technology/2021/09/04/vallum/outbound-rule2.png\" class=\"\" width=\"800\" title=\"alt\">\n<p>Actionの項目でユーザーに動作を尋ねる<mark class=\"label primary\">ASK</mark>がありますが、ユーザーが応答しなかった場合、さらにその挙動を明示できます。VallumのConfigurationからPreferenceボタンをクリックし、Alert画面で設定が可能です。上記のキャプチャの右側に<mark class=\"label primary\">Notification expire after</mark>という項目があります。ここではデフォルトの30秒となっていますが、この30秒ユーザーが無応答の場合は2分だけ接続を許可する設定ができます。また、許可する場合も永遠に許可する、今日は許可するなどの設定も可能です。<br>なお、<mark class=\"label primary\">Bg Action</mark>という項目は、Vallumが稼働していない時の挙動を決めるものです。厳密にいえば、OS起動時にネットワーク接続した時点ではVallumはまだ起動していないでしょう。この時にルール0で許可するか拒否するかを決めます。Vallumが起動していなければルール1以降の判断は不可能で通信を許可するかしないかのいずれかです。特にOutboundの<mark class=\"label primary\">Bg Action</mark>をBlockにすると、DHCPのIP配布に必要な通信も行えない事で、Wi-Fiが接続完了にならない事、自動起動するアプリが軒並み通信リトライとなり、大幅にOSの起動完了が遅れますのでBlockする事はお勧めしません。</p>\n<p>初期セットアップで自動作成されたルール1は、最初から用意されたグループ<mark class=\"label primary\">local-nets</mark>、これはプライベートIPネットワークアドレスからUDP&#x2F;67のDHCPのリクエストがあります。ここのルールには<mark class=\"label primary\">quick</mark>という記述がされています。この<mark class=\"label primary\">quick</mark>はVallum独特の考え方で、これ以降のルールチェックは行わないというものです。Vallumは最後に有効となったルールが選択されるという原則がありますが、quickが付いたルールの場合はそれ以降のチェックは行いません。DHCPのやりとりでIPアドレスの配布が受けられないと何も始められません。</p>\n<p>続いてルール2はUDP&#x2F;53のDNSリクエスト、UDP&#x2F;5353のmDNS(Bonjour)リクエストです。こちらもquick付きで許可されています。</p>\n<p>ルール3は信頼されたシステムプロセスが許可されています。これはquickがついていないので、この後ろに拒否ルールを加える事である条件でリクエストを拒否できます。</p>\n<h3 id=\"サブドメインで許可する\"><a href=\"#サブドメインで許可する\" class=\"headerlink\" title=\"サブドメインで許可する\"></a>サブドメインで許可する</h3><p>ここからは、個別のアプリケーションの通信毎にポップアップされる都度、許可する事でルールが追加されていきます。ユーザーにアクションが求められた場合、IPアドレスで許可する、サブドメインで許可する、このアプリケーションは全て許可するなどの設定が行えます。翻訳ソフトや画像編集ソフトなど、インターネット接続先が固定的になるものはできるだけサブドメインで許可するとメンテナンスが簡単になります。</p>\n<h3 id=\"ローカルネットワークへのアクセスを拒否する\"><a href=\"#ローカルネットワークへのアクセスを拒否する\" class=\"headerlink\" title=\"ローカルネットワークへのアクセスを拒否する\"></a>ローカルネットワークへのアクセスを拒否する</h3><p>前述の翻訳ソフトのDeepLなど、ローカルネットへのアクセスが不要な場合は、手動で<mark class=\"label primary\">local-nets</mark>に対するアクセス拒否を加えます。ちなみに、DeepLに限らず大半のアプリケーションは、ネット接続するためにDNSによる名前解決が必須です。DeepLが自宅内（ローカルネット）のDNSにリクエストする際は、1つ前の章で説明したルール2のDNSリクエストが該当します。ルール2はquickオプションがついているため、どんなアプリケーションもDNSへの名前解決は拒否されない仕組みです。よく考えられているなと感心します。</p>\n<h3 id=\"Outboundルールの工夫\"><a href=\"#Outboundルールの工夫\" class=\"headerlink\" title=\"Outboundルールの工夫\"></a>Outboundルールの工夫</h3><p>アプリケーションには、写真編集やフローチャート作成などネットアクセスを必要としない種類がありますが、バージョンアップの目的でインターネットにアクセスする場合があります。こういったケースでアクセスするドメインを絞る事ができます。またアプリケーションのバージョンアップはApp StoreまたはHomebrew任せにしているのであればアプリケーション単体のバージョンアップチェックも拒否できます。</p>\n<p>ウィルス対策ソフトなどによるURLチェックなど、信頼するしかないという場合などはベンダー指定で許可できますのでルールもシンプルになります。</p>\n<h2 id=\"Inboundのルール\"><a href=\"#Inboundのルール\" class=\"headerlink\" title=\"Inboundのルール\"></a>Inboundのルール</h2><p>Inboundルールは、Outboundに比べると多少設定はやや難しいのですが、自宅か外出先で制御を変えられるのが魅力です。Inboundは他の端末からどのようにアクセスされているのかわかりづらいため、ログファイルを活用して検証する必要があります。</p>\n<p>デフォルトのポリシーでセットアップした場合のInboundルールを見てみましょう。Vallumのアイコンから<mark class=\"label primary\">ファイアウォールConfiguration</mark>を選択し、<mark class=\"label primary\">FIREWALLS RULES</mark>の<mark class=\"label primary\">Inbound</mark>を選択します。</p>\n<img src=\"/new-technology/2021/09/04/vallum/inbound-rule1.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<ul>\n<li>ルール0<br>Outbound同様に原則ルール（ASK）があります。</li>\n<li>ルール1ダイナミック&#x2F;プライベートPortを許可します。<br>これはIANAによって明示された範囲外のPortでユーザーが自由に使えます。アプリケーションがサーバーPortを任意のタイミングで開く場合があるので明確に不要と判断できるまでは削除しないほうが良いでしょう。ダイナミック&#x2F;プライベートPortに関する説明はJPNICのWebサイトを参照してください。</li>\n<li>ルール2 DHCPサーバーからの受信</li>\n<li>ルール3 mDNS(Bonjour)の受信（名前解決の要求）</li>\n<li>ルール4 IPv6のicmp<br>IPv6のicmpはIPv4とは異なり、通信に必須のものなので止める事はできません。</li>\n</ul>\n<blockquote>\n<p>JPNIC -ポート番号とは-<br> <a href=\"https://www.nic.ad.jp/ja/basics/terms/port-number.html\">https://www.nic.ad.jp/ja/basics/terms/port-number.html</a></p>\n</blockquote>\n<p>なお、IPv6でDHCPv6を使っていらっしゃる方は、UDP&#x2F;546も手動で加える必要があります。</p>\n<h3 id=\"macOSのアプリケーションファイアウォールの設定\"><a href=\"#macOSのアプリケーションファイアウォールの設定\" class=\"headerlink\" title=\"macOSのアプリケーションファイアウォールの設定\"></a>macOSのアプリケーションファイアウォールの設定</h3><p>まずはmacOSのファイアウォールを有効にし、ファイアウォールオプションから必要なアプリケーションを許可します。</p>\n<img src=\"/new-technology/2021/09/04/vallum/fw-rule.png\" class=\"\" width=\"640\" title=\"alt\">\n\n<mark class=\"label primary\">外部からの接続をすべてブロック</mark>のチェックを外します。チェックされていると印刷できない、またはファイル共有できない場合があります。ここでは一般的に良く利用されるAirDropを例に許可していきます。以下のようにsharingdを許可します。<mark class=\"label primary\">内蔵ソフトウェアが外部からの接続を受け入れるのを自動的に許可</mark>にチェックしておく事で、macOSのファイアウォールで細かくアプリケーション毎に設定する必要がなくなり、Vallumに集約してコントロールできます。\n\n<h3 id=\"アクセス要求の受け入れ\"><a href=\"#アクセス要求の受け入れ\" class=\"headerlink\" title=\"アクセス要求の受け入れ\"></a>アクセス要求の受け入れ</h3><p>macOS自身がサーバーPortをクライアントからの接続要求を受け入れる場合、macOS自身のアプリケーションからの接続要求についてはフックできません。アプリケーションがPortをオープンし、そのPortに外部のクライアントが接続しようとしたところでVallumは検出し、許可&#x2F;拒否をユーザーに尋ねます。</p>\n<img src=\"/new-technology/2021/09/04/vallum/popup.png\" class=\"\" width=\"360\" title=\"alt\">\n\n<h3 id=\"ログの確認\"><a href=\"#ログの確認\" class=\"headerlink\" title=\"ログの確認\"></a>ログの確認</h3><p>外部のクライアントから接続の際、ログを確認しながらルールを検証します。アクセスが来ていないのか、Vallumで拒否されているのか、はたまたmacOSのファイアウォールで拒否されているのかを切り分けします。</p>\n<p>コンソールを開きます。</p>\n<img src=\"/new-technology/2021/09/04/vallum/console.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p>次にVallumのログをフィルタし、フィルタ条件を保存します。</p>\n<img src=\"/new-technology/2021/09/04/vallum/console1.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<ol>\n<li>コンソールの右上の検索窓で”flow”と入力し、Enterキーを押します。</li>\n<li>検索窓のプルダウン”いずれか”をクリックし、”カテゴリ”を選択します。</li>\n<li>これでVallumのログが絞り込まれます。</li>\n<li>最後に保存ボタンをクリックし、”Vallum log”など名前を付けて条件を保存します。</li>\n<li>ログを出力するにはコンソール上で開始ボタンをクリックします。</li>\n</ol>\n<h3 id=\"接続を受け入れる\"><a href=\"#接続を受け入れる\" class=\"headerlink\" title=\"接続を受け入れる\"></a>接続を受け入れる</h3><p>実際にAirDropの例でやってみます。スマホからmacOSにAirDropすると、Vallumはsharingdについてポップアップします。AirDropと表示されており分かりやすいですね。ちなみに、<mark class=\"label primary\">Firewall Configuration</mark>の<mark class=\"label primary\">Services and Ports</mark>でPort名称のカスタマイズができます。NetBIOS(137-139)やSMBの445などは”File Sharing”となっていますので、気になる人は変更してください。</p>\n<img src=\"/new-technology/2021/09/04/vallum/popup2.png\" class=\"\" width=\"360\" title=\"alt\">\n\n<p>許可、Passする際、Logを出力するようにチェックボックスにチェックを入れてください。これでコンソールを起動しログ出力させておけば、AirDropされる度にコンソールへログが出力されます。</p>\n<img src=\"/new-technology/2021/09/04/vallum/console2.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p>AirDropは、IPv6のリンクローカルアドレスで通信しているようですね。これだとどの端末からアクセスされたのかはわかりづらいですが。。。</p>\n<h2 id=\"自宅Wi-Fi-x2F-有線LAN-x2F-VPNと外出時の制御\"><a href=\"#自宅Wi-Fi-x2F-有線LAN-x2F-VPNと外出時の制御\" class=\"headerlink\" title=\"自宅Wi-Fi&#x2F;有線LAN&#x2F;VPNと外出時の制御\"></a>自宅Wi-Fi&#x2F;有線LAN&#x2F;VPNと外出時の制御</h2><p>いよいよVallumの高度な設定に取り組みます。ここでは、自宅Wi-Fiに接続しているor有線LANに接続しているor自宅へのVPNに接続しているという条件でAirDropを許可し、それ以外の状態、自宅外のAPに接続している場合はAirDropを許可しないというものです。大まかなルールは以下のように記述します。</p>\n<ol>\n<li>AirDropなど個々のアプリケーションで受信を許可</li>\n<li>条件として、自宅Wi-FiまたはLANの物理インタフェースがActiveでない場合は、全てのアプリケーションを拒否</li>\n<li>VPNのインタフェースがActiveの場合、AirDropなど個々のアプリケーションで受信を許可</li>\n</ol>\n<p>1と3が重複感がありますが、VPNが入った場合の条件が複雑で今のVallumではこのような設定になります。2については、個々のルールで”quick”と指定したDHCPやDNSなどのネットワーク系通信以外は1で許可したものが2の条件（外出中）で全て拒否される事になります。それで3で外出中であってもVPNが有効な場合は再び許可する事になります。</p>\n<p>2の条件はINBOUND RULEの一覧を右クリックし<mark class=\"label primary\">ADD New Rule</mark>を選択します。</p>\n<img src=\"/new-technology/2021/09/04/vallum/newrule1.png\" class=\"\" width=\"640\" title=\"alt\">\n\n<p>さらに、<mark class=\"label primary\">Advanced</mark>をクリックします。</p>\n<img src=\"/new-technology/2021/09/04/vallum/newrule2.png\" class=\"\" width=\"640\" title=\"alt\">\n\n<ol>\n<li>Logの出力をチェックします。</li>\n<li><mark class=\"label primary\">Condition</mark>のタブをクリックし、<mark class=\"label primary\">Not Connected to hotspots</mark>の項目に自宅のWi-Fiのアクセスポイント名を入力します。</li>\n<li>有線接続時の条件のために、<mark class=\"label primary\">Interfaces are not active</mark>にインタフェース名を入力します。有線接続し、<code>ifconfig</code>で実際にIPが割り当てられているインタフェースの名前を入力します。私の場合はLANはen5でした。</li>\n</ol>\n<p>この設定を加える事で自宅外の接続ではAirDropはできなくなります。</p>\n<p>簡単にテストするために、Wi-Fi接続からiPhoneなどへのテザリングに切り替え、そこでiPhoneからmacOSにAirDropすると以下のログがコンソールに出力されます。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">Log: 🔴 block ⬇️ Rule:18 sharingd PID:445 UID:501 from fe80::xxxx:xxxx:xxxx:xxxx:50392 to fe80::xxxx:xxxx:xxxx:xxxx:8770</span><br></pre></td></tr></table></figure>\n\n<p>一旦は許可したAirDropが再び拒否されるようになりました。テザリングを停止し自宅Wi-Fiに戻した際にはこのログは出力されず、再びAirDropできるはずです。</p>\n<p>さて、最後にVPNです。</p>\n<ol>\n<li>AirDropを許可したルールを複製します。</li>\n</ol>\n<img src=\"/new-technology/2021/09/04/vallum/newrule3.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<ol start=\"2\">\n<li>複製したルールを選択、ドラッグし自宅外はDropするルールの下に移動します。</li>\n</ol>\n<img src=\"/new-technology/2021/09/04/vallum/newrule4.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<ol start=\"3\">\n<li>このルールをVPN接続中のみ有効にします。</li>\n</ol>\n<img src=\"/new-technology/2021/09/04/vallum/newrule5.png\" class=\"\" width=\"640\" title=\"alt\">\n\n<p>ルールのAdvancedを選び、Logの出力をチェック、<mark class=\"label primary\">Interface is active</mark>にVPNのインタフェース名を入力します。これもVPN接続時に<code>ifconfig</code>でインタフェース名を確認できます。</p>\n<p>いよいよテストです。macOSをiPhoneへテザリング接続し、さらにVPNに接続します。iPhoneからmacOSにAirDropが行え、ログに以下の通り出力される事が確認できます。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">Log: 🟢 pass ⬇️ Rule:19 sharingd PID:445 UID:501 from fe80::xxxx:xxxx:xxxx:xxxx:60433 to fe80::xxxx:xxxx:xxxx:xxxx:8770</span><br></pre></td></tr></table></figure>\n<p> ログは上記のように最後に選択されたルールのみが出力されます。</p>\n<p>NetBIOSやmDNSの拒否など外出中には基本は拒否設定としつつ、VPN接続中には一部のサービスを生かすという使い方ができます。</p>\n<h2 id=\"設定ファイルの保存\"><a href=\"#設定ファイルの保存\" class=\"headerlink\" title=\"設定ファイルの保存\"></a>設定ファイルの保存</h2><p>ルールはファイルに保存できます。<mark class=\"label primary\">Firewall Configuration</mark>から<mark class=\"label primary\">Import / Export</mark>ボタンをクリックし、Exportを選んでください。初期設定の<mark class=\"label primary\">Run Assistant</mark>を選ぶと既存ルールが全てクリアされます。定期的にバックアップをお勧めします。</p>\n<p>なお、Vallum4に関するオンラインヘルプが用意されています。</p>\n<blockquote>\n<p>Vallum 4 Help<br> <a href=\"https://help.vallumfirewall.com/index.php?chapter=introduction\">https://help.vallumfirewall.com/index.php?chapter=introduction</a></p>\n</blockquote>\n<h2 id=\"その他機能\"><a href=\"#その他機能\" class=\"headerlink\" title=\"その他機能\"></a>その他機能</h2><h3 id=\"Flows-Monitor\"><a href=\"#Flows-Monitor\" class=\"headerlink\" title=\"Flows Monitor\"></a>Flows Monitor</h3><p>Flows Monitorを選択すると、現在通信しているプロセスの一覧が参照できます。</p>\n<h3 id=\"帯域制限ツール-Snail\"><a href=\"#帯域制限ツール-Snail\" class=\"headerlink\" title=\"帯域制限ツール　Snail\"></a>帯域制限ツール　Snail</h3><p>Vallumには、アプリケーション毎に帯域制限できるツール、Snailのライセンスが付属します。Snailは別途インストールする必要があり、Homebrewには登録されていません。詳細は以下を参照してください。</p>\n<blockquote>\n<p><a href=\"https://www.murusfirewall.com/snail/\">https://www.murusfirewall.com/snail/</a></p>\n</blockquote>\n<p><small id=\"note1\"><strong>[1]</strong><br>レピュテーションチェック　アプリケーションの信頼性を第三者となる企業によって評価したもの。セキュリティベンダーなどが独自の尺度でアプリケーションを評価したりアプリケーションの振る舞いによって安全か不審かを評価するもの。<br></small></p>\n","categories":["Security"]},{"title":"UniFi Network Applicationのセットアップ","url":"/new-technology/2022/09/23/unifi-network-application/","content":"<img src=\"/new-technology/2022/09/23/unifi-network-application/unifi1.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p class=\"onepoint\">この記事で実現すること</p>\n\n<p>米国Ubiquiti（ユビキティ）社のUniFi製品であるネットワークスイッチ、Wi-Fiアクセスポイントを利用するには、管理コンソールとしてUniFi OS ConsoleまたはUniFi Network Applicationが必要となります。UniFi Network ApplicationはUbiquitiより無償提供されており、管理・運用においてはUniFiクラウドサービスと連携します。一般的にはこのようなサービスはサブスクリプション費用が必要ですが、この費用も掛かりません。UniFi製品はネットワークの見える化に特化しているため、管理コンソールの24時間稼働が理想です。最初からハード組み込みのセキュリティ機器（UniFi Security Gateway等）やUniFi Cloud Keyを購入すればすぐにUniFi製品を使い始めることができますが、これらのハードウェアを購入しなくとも、ネットワークやLinuxの知識がある人はUniFi Network Applicationをセットアップし、使い始めることができます。</p>\n<span id=\"more\"></span>\n\n<h2 id=\"UniFi-Network-Applicationのセットアップの前提\"><a href=\"#UniFi-Network-Applicationのセットアップの前提\" class=\"headerlink\" title=\"UniFi Network Applicationのセットアップの前提\"></a>UniFi Network Applicationのセットアップの前提</h2><p>「<a href=\"/new-technology/2022/08/27/ubiquiti-unifi/\" title=\"Ubiquiti UniFiの世界\">Ubiquiti UniFiの世界</a>」ではUniFiの機能全般を説明しました。UniFi Network Applicationをセットアップする以前に製品の情報やアップデートの情報は全てUbiquitiの提供するCommunityから入手します。英語のコミュニティサイトではSOHOなどのユーザーはUDM Proなどのセキュリティゲートウェイに、スイッチ、APを組み合わせているケースが多く見られます。スイッチユーザーは、もう少し大きな規模のユーザーがネットワークアプリケーションをLinuxで構築しているユーザーが多いように見えます。実際に顧客にサービスを提供しているSIerやエンジニアの参加もあります。コミュニティの情報・不具合などの割合から見ると、ネットワークアプリケーションの機能とスイッチの情報が圧倒的に多いように見え、セキュリティゲートウェイの質問やセキュリティそのものに関する技術的な内容は少ないように見えます。</p>\n<p>手っ取り早くUniFi機器を稼働させるには、Windows、macOSのUniFi Network Applicationをセットアップし、動作させることです。</p>\n<p>基本的には24時間稼働させ、スイッチ&#x2F;APからリアルタイムで情報を収集したり、スイッチ&#x2F;APに必要な動作を指示するのがConsole&#x2F;Network Applicationの役目です。Linux上（Debian&#x2F;Ubuntu）にセットアップされるケースが多いようです。わざわざLinuxのセットアップをするのは手間だと思えますが、運用を継続することを考えると、Linuxへのセットアップがお勧めです。また、バックアップや設定変更で動作しなくなった時のロールバックを考えると仮想環境（ESXi）にセットアップされることをお勧めします。Ubuntuの最新バージョンであるUbuntu22.04LTSはサポート期間が2027年までと十分長い期間があります。UniFiのためのUbuntuのセットアップ記事は「<a href=\"/new-technology/2022/09/23/ubuntu22-04lts/\" title=\"Ubuntu22.04LTSをESXiにセットアップする\">Ubuntu22.04LTSをESXiにセットアップする</a>」を参照してください。</p>\n<p>ローカル環境のみのアクセス（オンプレミス）、リモート（スマホアプリ）から管理可能なハイブリッドクラウド方式がありますが、ここではハイブリッドクラウド方式で進めます。クラウドはUbiquitが提供する無償のサービスです（※有償のUbiquitiクラウド管理の方式もあります）。基本的には機器のCPU、メモリ使用量、温度管理に加え、スマホへの通知やリモートによる機器のリスタート、アップグレード、高い利便性があります。</p>\n<p>UniFiはAppleのiPhoneのように説明書が無くても使えることを目標にしているのでしょうか。難しいスイッチなどのコマンドラインを必要としませんが、マニュアルというものがありません。コミュニティにはUbiquitiのサポートスタッフも発言していますが、コミュニティが貴重な情報源でもあります。操作が不明な場合や不具合かなと思った場合は、まずコミュニティで検索することから始まります。</p>\n<h3 id=\"UniFi-Networkのリモートアクセス\"><a href=\"#UniFi-Networkのリモートアクセス\" class=\"headerlink\" title=\"UniFi Networkのリモートアクセス\"></a>UniFi Networkのリモートアクセス</h3><p>Requirementとして以下のドキュメントがあります。</p>\n<blockquote>\n<p>UniFi Network - Remote Access Requirements<br> <a href=\"https://help.ui.com/hc/en-us/articles/115012240067-UniFi-Network-Remote-Access-Requirements\">https://help.ui.com/hc/en-us/articles/115012240067-UniFi-Network-Remote-Access-Requirements</a></p>\n</blockquote>\n<p>説明は至ってシンプルです。UIシングルサインオンアカウント、インターネットに接続されているネットワークアプリケーションホストが必要とあります。<br>よくあるトラブルとしては、Port解放の問題、DNS、NTPへの接続が必要という項目があります。また、コミュニティのリリースポストを参照してほしいとあります。</p>\n<p>UniFiの環境は慣れるまでは理解するのが大変ですが、その世界観を理解できれば1つ1つは難しくありません。</p>\n<h3 id=\"UIシングルサインオンアカウントの作成\"><a href=\"#UIシングルサインオンアカウントの作成\" class=\"headerlink\" title=\"UIシングルサインオンアカウントの作成\"></a>UIシングルサインオンアカウントの作成</h3><p>早速、Ubiquitiのシングルサインオンアカウントを作成しましょう。アカウントの作成は無償です。</p>\n<p><a href=\"https://account.ui.com/register\">https://account.ui.com/register</a></p>\n<p>ユーザー名、メールアドレス、パスワードが必要です。ユーザー名は他のユーザーと重複しない名前が必要です。一度決定するとこのユーザー名でローカル環境もログインする事になります。</p>\n<img src=\"/new-technology/2022/09/23/unifi-network-application/unifi4.png\" class=\"\" width=\"360\" title=\"alt\">\n\n<p>登録が完了すると以下の画面になります。</p>\n<img src=\"/new-technology/2022/09/23/unifi-network-application/unifi6.png\" class=\"\" width=\"360\" title=\"alt\">\n\n<p>登録したメールアドレスに”Email Verification”が行きますのでVerifyしてください。</p>\n<h2 id=\"UniFi-Consoleの要件\"><a href=\"#UniFi-Consoleの要件\" class=\"headerlink\" title=\"UniFi Consoleの要件\"></a>UniFi Consoleの要件</h2><ul>\n<li>2 GHz dual core processor(2vCPU)</li>\n<li>4 GiB RAM (system memory)</li>\n<li>64 GB Disk</li>\n</ul>\n<p>UniFi Network Applicationに対してはユーザーからのWebサービス、スイッチからネットワークアプリケーションへの接続などがあり、いくつかのサーバーPortをオープンしておく必要があります。Ubuntuと言われるとWindows上のWSL2を思い浮かべますが、WindowsOS上にPort Forwardの設定を行う必要があり、通常のUbuntuより余計な手間が掛かるためWSL2はお勧めしません。</p>\n<p>UniFi Network ApplicationではMongoDB3.6&#x2F;Java8を使います。MongoDB3.6は2021年4月で既にEOLを迎えています。Java8は古いプロダクトではありますが、2030年まではサポートされることが言及されています。これらのミドルウェアの利用はアプリケーション内部の組み込み型モジュールとして考えるべきでもあり、セキュリティの観点からは可能な限りUbuntu上の公開ポートを制限すべきです。従い、UbuntuはUniFiネットワークアプリケーション専用として利用し、必要なPort以外は閉じます。</p>\n<p>実際のインストールは有志が作成した素晴らしいシェルスクリプトが公開されており、悩むことなくセットアップは完了します。</p>\n<p>UniFi Network Applicationのバージョンアップはインストール同様にシェルスクリプトを動作させます。また、UniFi Network Applicationはロールバックに対応していないため、何か問題があった場合に旧環境に戻すにはアンインストール、インストールをするかESXiのレベルでスナップショットからの戻し、または仮想マシンごとのバックアップからの戻しをします。ESXiによるOSのロールバックは非常に手軽なため、万が一の際はOSレベルでのレストアが早く確実です。</p>\n<blockquote>\n<p>Oracle Java<br> <a href=\"https://www.oracle.com/jp/java/technologies/java-se-support-roadmap.html\">https://www.oracle.com/jp/java/technologies/java-se-support-roadmap.html</a><br> オラクルは今後も、 java.comで、個人ユーザー、開発ユーザー、およびその他のユーザーに、Java SE 8の無償の公開アップデートと自動アップデートを無期限に提供します。</p>\n</blockquote>\n<blockquote>\n<p>MongoDB<br> <a href=\"https://www.mongodb.com/support-policy/lifecycles\">https://www.mongodb.com/support-policy/lifecycles</a></p>\n</blockquote>\n<h2 id=\"Ubuntuの事前準備\"><a href=\"#Ubuntuの事前準備\" class=\"headerlink\" title=\"Ubuntuの事前準備\"></a>Ubuntuの事前準備</h2><p>ここでは「<a href=\"/new-technology/2022/09/23/ubuntu22-04lts/\" title=\"Ubuntu22.04LTSをESXiにセットアップする\">Ubuntu22.04LTSをESXiにセットアップする</a>」で記載したようにUbuntuがESXi上にセットアップされ、ESXiのUbuntuにVMware Remote Consoleで接続して操作する事を前提としています。ESXiのWebUIにログインし、Ubuntuの仮想マシンに対してVMRCで接続するか、ブラウザから、<code>vmrc://ユーザー名@esxiのホスト名/?moid=[仮想マシンのID]</code>で接続します（VMRCウィンドウが起動します）。クライアントへのVMRCのインストールはESXiのWebUIからダウンロードできます。</p>\n<h3 id=\"Ubuntuの固定IPアドレスの設定\"><a href=\"#Ubuntuの固定IPアドレスの設定\" class=\"headerlink\" title=\"Ubuntuの固定IPアドレスの設定\"></a>Ubuntuの固定IPアドレスの設定</h3><p>UniFiの機器から、或いはWeb Consoleとして常に同一のIPアドレスに接続するために固定IPアドレス、またはDHCPの配布でmacアドレスを元に常に同じIPアドレスを配布するように設定します。Ubuntu上で固定IPにするには、<mark class=\"label primary\">設定</mark>画面の<mark class=\"label primary\">ネットワーク</mark>で固定IPを設定します。</p>\n<img src=\"/new-technology/2022/09/23/unifi-network-application/unifi15.png\" class=\"\" width=\"640\" title=\"alt\">\n\n<p>UniFi Network Applicationでは現時点でIPv4のみを利用しIPv6は未対応と考えてください。個々のスイッチ&#x2F;APはもちろんIPv6通信に対応していますが、機器本体の管理をIPv4で行います。</p>\n<h3 id=\"ufwの設定\"><a href=\"#ufwの設定\" class=\"headerlink\" title=\"ufwの設定\"></a>ufwの設定</h3><p>UniFi Consoleで最低限のPortを開けるため、UbuntuのFirewallであるufwを設定します。Ubuntuの<mark class=\"label primary\">端末</mark>を起動します。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ sudo ufw status</span><br><span class=\"line\">状態: 非アクティブ</span><br><span class=\"line\">$</span><br></pre></td></tr></table></figure>\n\n<p>ufwを有効にします。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ sudo ufw <span class=\"built_in\">enable</span></span><br><span class=\"line\">ファイアウォールはアクティブかつシステムの起動時に有効化されます。</span><br></pre></td></tr></table></figure>\n\n<p>再度状態確認します。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ sudo ufw status</span><br><span class=\"line\">状態: アクティブ</span><br><span class=\"line\">$</span><br></pre></td></tr></table></figure>\n\n<div class=\"note danger\"><p>ESXiやVMRCを使わずSSHで接続しufwを有効にする場合は、SSHポート（22&#x2F;TCP)を許可しておかないと新しいSSHの接続ができません。再起動などのタイミングでSSHできず面倒になるのでご注意ください。なお、UniFi Network Applicationのセットアップ途中でSSHポートを開けます。</p>\n</div>\n\n<p>ufwを有効化しただけでは外部へ接続する方向へは制限しませんが、UbuntuのFirefoxでInternetに接続可能な状態である事を確認します。セキュリティ機器やFirewall機器で<strong>Outbound通信</strong>に厳密な管理をされている方は以下の記事を参考に必要なPortを開けてください。UniFi Network ApplicationのセットアップにはInternetへの接続が必要です。Internetから内部にポート解放する必要はありません。</p>\n<blockquote>\n<p>UniFi - Setting Up a UniFi OS Console<br> <a href=\"https://help.ui.com/hc/en-us/articles/4416276882327-UniFi-Setting-Up-a-UniFi-OS-Console\">https://help.ui.com/hc/en-us/articles/4416276882327-UniFi-Setting-Up-a-UniFi-OS-Console</a></p>\n</blockquote>\n<h2 id=\"UniFi-Network-Applicationのインストール\"><a href=\"#UniFi-Network-Applicationのインストール\" class=\"headerlink\" title=\"UniFi Network Applicationのインストール\"></a>UniFi Network Applicationのインストール</h2><p>スクリプトの情報は、コミュニティにあります。<br><a href=\"https://community.ui.com/questions/UniFi-Installation-Scripts-or-UniFi-Easy-Update-Script-or-UniFi-Lets-Encrypt-or-UniFi-Easy-Encrypt-/ccbc7530-dd61-40a7-82ec-22b17f027776\">https://community.ui.com/questions/UniFi-Installation-Scripts-or-UniFi-Easy-Update-Script-or-UniFi-Lets-Encrypt-or-UniFi-Easy-Encrypt-/ccbc7530-dd61-40a7-82ec-22b17f027776</a></p>\n<p>セットアップで失敗した際にすぐに戻れるように、このタイミングでESXiのスナップショット、またはバックアップの取得をお勧めします。</p>\n<p>実行は3ステップです。Ubuntuの<mark class=\"label primary\">端末</mark>から、以下のコマンドを実行します。</p>\n<ol>\n<li><p>管理者になります</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ sudo -i</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>証明書などのダウンロードをします。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ apt-get update; apt-get install ca-certificates wget -y</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>ネットワークアプリケーションのセットアップを行います。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ <span class=\"built_in\">rm</span> unifi-latest.sh &amp;&gt; /dev/null; wget https://get.glennr.nl/unifi/install/install_latest/unifi-latest.sh &amp;&amp; bash unifi-latest.sh</span><br></pre></td></tr></table></figure>\n<p>必要なモジュールをインストールし、最新のUniFi Network Applicationをインストールしていきます。何回かユーザーとコマンド上の対話があります。全て”Y”を回答します。</p>\n</li>\n</ol>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Do you want to keep the script on your system after completion? (Y/n)</span></span><br></pre></td></tr></table></figure>\n<p>“Y”を入力しEnterを押下します。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Do you want to proceed with updating your system? (Y/n)</span></span><br></pre></td></tr></table></figure>\n<p>“Y”を入力しEnterを押下します。その後いくつかのモジュールがセットアップされていきます。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Preparing for MongoDB installation...</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Adding key for MongoDB 3.6...</span></span><br><span class=\"line\"><span class=\"comment\"># Successfully added key for MongoDB 3.6!</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Running apt-get update...</span></span><br><span class=\"line\"><span class=\"comment\"># Successfully ran apt-get update!</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Installing mongodb-org version 3.6...</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Preparing OpenJDK 8 installation...</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Installing openjdk-8-jre-headless...</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Installing your UniFi Network Application ( 7.2.94 )...</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Downloading the UniFi Network Application...</span></span><br><span class=\"line\"><span class=\"comment\"># Successfully downloaded application version 7.2.94!</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Installing the UniFi Network Application...</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Would you like to update the UniFi Network Application via APT?</span></span><br><span class=\"line\"><span class=\"comment\"># Do you want the script to add the source list file? (Y/n)</span></span><br></pre></td></tr></table></figure>\n\n<p>“Y”を入力しEnterを押下します。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Is/will your application only be used locally ( regarding device discovery )? (Y/n)</span></span><br></pre></td></tr></table></figure>\n<p>あなたのアプリケーションはディスカバリにおいてローカル環境だけで使いますか？という質問ですが、これはスクリプトの中身を見る限りは、”Y”を選択しないと、ufwの10001&#x2F;udpを開けないので、”Y”を選択します。10001&#x2F;UDPを開けないとローカル環境のUniFi機器を見つけられません。AWSなどのクラウド上にネットワークアプリケーションをセットアップする場合、ローカルのUniFi機器を直接UniFi Network Applicationに向かわせる方法もあり、その場合はクラウド上のローカルネットワークに不要なポートを公開しないための設定と考えられます。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Do you want to add the required ports for your UniFi Network Application? (Y/n)</span></span><br></pre></td></tr></table></figure>\n<p>“Y”を入力しEnterを押下します。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Successfully added port 3478/udp to UFW.</span></span><br><span class=\"line\"><span class=\"comment\"># Successfully added port 8080/tcp to UFW.</span></span><br><span class=\"line\"><span class=\"comment\"># Successfully added port 8443/tcp to UFW.</span></span><br><span class=\"line\"><span class=\"comment\"># Successfully added port 8880/tcp to UFW.</span></span><br><span class=\"line\"><span class=\"comment\"># Successfully added port 8843/tcp to UFW.</span></span><br><span class=\"line\"><span class=\"comment\"># Successfully added port 6789/tcp to UFW.</span></span><br><span class=\"line\"><span class=\"comment\"># Successfully added port 10001/udp to UFW.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Your SSH port ( 22 ) doesn&#x27;t seem to be in your UFW list..</span></span><br><span class=\"line\"><span class=\"comment\"># Do you want to add your SSH port to the UFW list? (Y/n)</span></span><br></pre></td></tr></table></figure>\n<p>UniFiに必要なポートを開け、さらにSSHも開けますか？と聞かれるので”Y”を入力しEnterを押下します。</p>\n<p>最後に以下の表示でスクリプトは終了します。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># UniFi Network Application 7.2.94 has been installed successfully</span></span><br><span class=\"line\"><span class=\"comment\"># Your application address: https://192.168.xxx.222:8443</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># UniFi is active ( running )</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Author   |  Glenn R.</span></span><br><span class=\"line\"><span class=\"comment\"># Email    |  glennrietveld8@hotmail.nl</span></span><br><span class=\"line\"><span class=\"comment\"># Website  |  https://GlennR.nl</span></span><br></pre></td></tr></table></figure>\n\n<p>とても素晴らしいシェルスクリプトです。Glenn R氏に深謝です。<br>最後の”Your application address:”にあるように、クライアントのブラウザから<code>https://UbuntuのIPアドレス:8443</code>に接続します。</p>\n<h2 id=\"UniFi-ネットワークアプリケーションのセットアップ\"><a href=\"#UniFi-ネットワークアプリケーションのセットアップ\" class=\"headerlink\" title=\"UniFi ネットワークアプリケーションのセットアップ\"></a>UniFi ネットワークアプリケーションのセットアップ</h2><p>ここからはしばらくUbuntuは操作しません。WindowsやmacOS、スマホなどのクライアントから<code>https://UbuntuのIPアドレス:8443</code>に接続します。独自証明書のため、ブラウザのエラーが表示されますが、「危険を理解して進む」などをクリックして画面を開きます。UniFi Network ApplicationのSSL対応は別の機会に記事を書きます。</p>\n<p>以下では規約に同意するチェックを入れ、”Next”で進みます。</p>\n<img src=\"/new-technology/2022/09/23/unifi-network-application/unifi7.png\" class=\"\" width=\"480\" title=\"alt\">\n\n<p>ここでは、<mark class=\"label primary\">Switch to Advanced Setup</mark>をクリックします。</p>\n<img src=\"/new-technology/2022/09/23/unifi-network-application/unifi8.png\" class=\"\" width=\"480\" title=\"alt\">\n\n<mark class=\"label primary\">Advanced remote and local access</mark>では、以下のようにリモートアクセスとUIシングルサインオンアカウントのトグルスイッチをOnにした状態で\"Next\"で進みます。\n<img src=\"/new-technology/2022/09/23/unifi-network-application/unifi8-1.png\" class=\"\" width=\"480\" title=\"alt\">\n<p>UIシングルサインオンアカウントでログインします。</p>\n<img src=\"/new-technology/2022/09/23/unifi-network-application/unifi8-2.png\" class=\"\" width=\"480\" title=\"alt\">\n\n<p>ここではバックアップを有効にします。</p>\n<img src=\"/new-technology/2022/09/23/unifi-network-application/unifi8-3.png\" class=\"\" width=\"480\" title=\"alt\">\n\n<p>デバイスセットアップです。ここで新しいUniFiのハードウェアがネットワークアプリケーションのサブネット内で接続状態であれば、自動的に検出します。ただし、ネットワークアプリケーションで最初にネットワークアドレスを設定する必要があり、ここではデバイスのセットアップをせずに、”Next”で進みます。</p>\n<img src=\"/new-technology/2022/09/23/unifi-network-application/unifi9.png\" class=\"\" width=\"640\" title=\"alt\">\n\n<p>WiFiセットアップです。UniFiのAPがある場合はここでWiFiセットアップが可能ですが、スキップし”Next”で進みます。</p>\n<img src=\"/new-technology/2022/09/23/unifi-network-application/unifi10.png\" class=\"\" width=\"640\" title=\"alt\">\n\n<p>確認画面です。所在地である日本を選択し、”Finish”で完了します。</p>\n<img src=\"/new-technology/2022/09/23/unifi-network-application/unifi11.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<p>ここまで完了すると初期画面が表示されます。</p>\n<img src=\"/new-technology/2022/09/23/unifi-network-application/unifi12.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<h2 id=\"UniFi-ネットワークアプリケーションの初期設定\"><a href=\"#UniFi-ネットワークアプリケーションの初期設定\" class=\"headerlink\" title=\"UniFi ネットワークアプリケーションの初期設定\"></a>UniFi ネットワークアプリケーションの初期設定</h2><p>最初にUniFiネットワークアプリケーションのネットワークアドレスと動作モードを設定します。<br>ネットワークアプリケーションの左下の歯車アイコンをクリックし、<mark class=\"label primary\">Networks</mark>を選択します。</p>\n<img src=\"/new-technology/2022/09/23/unifi-network-application/unifi13.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<p>最初のネットワークアドレスは”192.168.1.0&#x2F;24”となっていますのでこれを修正します。</p>\n<img src=\"/new-technology/2022/09/23/unifi-network-application/unifi13-1.png\" class=\"\" width=\"480\" title=\"alt\">\n\n<mark class=\"label primary\">Auto Scale Network</mark>のチェックを外し、実際のルーターのLAN側IPアドレスを入力します。\n<img src=\"/new-technology/2022/09/23/unifi-network-application/unifi13-2.png\" class=\"\" width=\"480\" title=\"alt\">\n\n<p>続いて<mark class=\"label primary\">Advanced Configuration</mark>では、今回のようにセキュリティゲートウェイなどのUniFi Consoleがありませんが、デフォルトではセキュリティゲートウェイがDHCPを提供するDHCPサーバーモードとなっています。</p>\n<img src=\"/new-technology/2022/09/23/unifi-network-application/unifi13-3.png\" class=\"\" width=\"480\" title=\"alt\">\n\n<p>ここでは、DHCPモードを”無し”にし、”Apply Changes”で変更を完了させます。</p>\n<img src=\"/new-technology/2022/09/23/unifi-network-application/unifi13-4.png\" class=\"\" width=\"480\" title=\"alt\">\n\n<p>左側の丸い二重丸のアイコン（UniFiAPのシンボルです）からは、新しいUniFi機器のAdoptが可能な状態になっています。</p>\n<img src=\"/new-technology/2022/09/23/unifi-network-application/unifi14.png\" class=\"\" width=\"480\" title=\"alt\">\n\n<p>Ubuntuを再起動後してみてください。再度ブラウザでUniFi管理画面にログインできること、UbuntuにSSH可能である事を確認しましょう。</p>\n<p>これでUniFiネットワークアプリケーションの設定は一旦完了です。もちろんこの段階で検出したスイッチを採用（Adopt）できますが、管理の主体はスマホアプリで可能なため、スマホアプリをインストールしていきましょう。</p>\n<h2 id=\"UniFi-ネットワーク-スマホアプリ\"><a href=\"#UniFi-ネットワーク-スマホアプリ\" class=\"headerlink\" title=\"UniFi ネットワーク スマホアプリ\"></a>UniFi ネットワーク スマホアプリ</h2><p>UniFiの使い勝手の良さはスマホアプリにあります。スマホアプリからUniFiネットワークアプリケーションを制御します。普段はスマホアプリがあれば大抵は事足ります。アプリストアから”UniFi Network&#x2F;Ubiquiti Inc”を見つけスマホにアプリをインストールします。</p>\n<ul>\n<li><p>Apple iOS</p>\n <img src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAKUAAAClCAAAAAAYQGIGAAAB90lEQVR42u3a0W7DIAxG4b7/S2d3mzQFc36Stg46XHUqK18rEYzt12s+jt/x9+dwyr/J9aeczVsdKlV+R3mMBiXQrzR8txaoVNlcebbccKV6Mti79MGhUuVOyuFKgBWtoVLldsrhIZq/UqlyE2UdXy4ef/U3vD0KVqny40p6tr3v1U0ZGJUqP6k84KDnGN2nRzJUqmypBHstQtOzMlpXpcqWymHaL0qBL558dc5x/DOqVNlCuXj/ispQUXWX/KAqVbZQggxEdExGm5/GoSpV9lWCPEbe5FAfrHVtaxIAq1TZRxkluekVbfEWhy95KlV+W0n7FmiNqQ5VF8tVKlW2VNZ58HylesdGrUmT7L9KlX2U0edfrk9lNzaVKh+ljPb9PQHlJHWpUmUz5WL5NbqigZgzK02pVNlCmd+XorwIzUxM5qlU2VYZpekWWyBApEmaIVSq7KO8nA8E8qgtYvyQUKmyrRLs7LzvCISloKFVpconKPGGm8eXeTF2kp1XqfJRSrpwvQhNhEyeNypVNlMecFzJkkcVqNPJKlV2VNIMXV64ilL79D9UquymBG11N27qPFuhUmVzZdTfsJgyzFMiKlVuosx3O2ifoJUqlSo3UdJmCFywBXyVKtsq6/gyajkC8SVti1CpsrkyCvZAkSq6f9EAVaXKZsofDWwJqEp4wN0AAAAASUVORK5CYII=\" alt=\"UniFi Network\" title=\"\" class=\"title: UniFi Network\">\n<p> <a href=\"https://apps.apple.com/jp/app/unifi-network/id1057750338\">https://apps.apple.com/jp/app/unifi-network/id1057750338</a></p>\n</li>\n<li><p>Android</p>\n <img src=\"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALkAAAC5CAAAAABRxsGAAAACV0lEQVR42u3bS46EMAxF0dr/pqtnNUAkuc9BLRHfjFrF74CEcRz357Me39+4/Ha3y2Xc7Ty8Bt0ZD+XKz5CDC893Kd4SuIfFscqVt5HTt53e0vzm5k8HqJQrV559vOeBY54+3KUZypUrr8YW8BuVD73KlSvPJsAgeoAUAGx9cmahXPnr5Xn96T/+eqg6p1z5m+XRLPiZ2AK++QSkXHkHOXifd77qxdozXrNSrvxwOV31yddq6fnAhtudlSvvIM9XaUBsmacKO7UwUv5Wrvw0efTxBlXjPCsHbVfjHEK58nPltKWCzn2jdVkadMZPWrnyw+Xzrzp42yPlfM4N8vPbAKNc+bnyyAGy7bwWVg0wypW3kRe/9OAwKgfhTLnyjvJ5sRmUogvJxkZ+vphGK1d+rpy+1BG6GKboDEG58mby6GBQbAaxCjSDkNK5cuXnyvP2p6gqBq4BWjTImZUrP00ODo6WZIuVssJ1lSvvJQeOqC0i6nKKopZy5crJ/5p+1iPvlaK3rlx5H/lOsXln8hy1d1zPolx5B3lhgr0m7Eyoo1ZK5cpbyHEH0rqRgk6F6aLSIvVQrryNHLzZeQ9U1H+RNUIpV95anndO0AJ0VJlePDHlytvI8+ZB2iAxjw9RzUy58mbyLxzZK79eWaI5xDgdUa68g5y+ylnaDFOAfBk5ikHKlR8ip+cCX/VqAlKMLcqVt5HnjQ9Rsap4cyS2KFeunG4F7RjzZADUwZUrV57FlnwrnRKQdSLlyjvIix2EO7GFZgnjnZUr7yCPsmM6g366ql0YypW/Xf4Hl2yz0I8KdVwAAAAASUVORK5CYII=\" alt=\"UniFi Network\" title=\"\" class=\"title: UniFi Network\">\n<p> <a href=\"https://play.google.com/store/apps/details?id=com.ubnt.easyunifi&amp;hl=en_US&amp;gl=US\">https://play.google.com/store/apps/details?id=com.ubnt.easyunifi&amp;hl=en_US&amp;gl=US</a></p>\n</li>\n</ul>\n<p>ここではiPhoneで操作します。”Set up a New Device”をタップします</p>\n<img src=\"/new-technology/2022/09/23/unifi-network-application/app1.png\" class=\"\" width=\"280\" title=\"alt\">\n\n<p>ネットワークを検索しに行きます</p>\n<img src=\"/new-technology/2022/09/23/unifi-network-application/app2.png\" class=\"\" width=\"280\" title=\"alt\">\n\n<p>UniFi OS Consoleは存在していないので見つけられません。”Set up a connection by IP address”でUniFi Network ApplicationのIPアドレスを指定します。</p>\n<img src=\"/new-technology/2022/09/23/unifi-network-application/app3.png\" class=\"\" width=\"280\" title=\"alt\">\n\n<p>UniFi Network ApplicationのIPアドレス、UIシングルサインオンアカウントのIDとパスワードを指定します。</p>\n<img src=\"/new-technology/2022/09/23/unifi-network-application/app4.png\" class=\"\" width=\"280\" title=\"alt\">\n\n<p>しばらく経ってから、UniFi Network Applicationを見つけるので、”Proceed”をタップします。</p>\n<img src=\"/new-technology/2022/09/23/unifi-network-application/app5.png\" class=\"\" width=\"280\" title=\"alt\">\n\n<p>無事ログインが完了し、早速Adopt可能なデバイスが表示されます。Adoptしてみます。”Set Up”をタップします。</p>\n<img src=\"/new-technology/2022/09/23/unifi-network-application/app6.png\" class=\"\" width=\"280\" title=\"alt\">\n\n<p>“Next”をタップします。</p>\n<img src=\"/new-technology/2022/09/23/unifi-network-application/app7.png\" class=\"\" width=\"280\" title=\"alt\">\n\n<p>デバイスを採用中です。しばらく待ちます。少し時間が掛かります。ここではデバイスの採用と最新ファームウェアのダウンロード、適用が行われます。</p>\n<img src=\"/new-technology/2022/09/23/unifi-network-application/app8.png\" class=\"\" width=\"280\" title=\"alt\">\n\n<p>デバイスの採用が完了すると、以下の画面になります。”Go to Dashboard”をタップします。</p>\n<img src=\"/new-technology/2022/09/23/unifi-network-application/app9.png\" class=\"\" width=\"280\" title=\"alt\">\n\n<p>Top画面です</p>\n<img src=\"/new-technology/2022/09/23/unifi-network-application/app10.png\" class=\"\" width=\"280\" title=\"alt\">\n\n<p>UniFiデバイスの画面をタップすると、採用されたスイッチが見えます。</p>\n<img src=\"/new-technology/2022/09/23/unifi-network-application/app11.png\" class=\"\" width=\"280\" title=\"alt\">\n\n<p>スイッチのPortの状況です。GbEでアップリンク（上流のネットワーク）に接続されています。</p>\n<img src=\"/new-technology/2022/09/23/unifi-network-application/app12.png\" class=\"\" width=\"280\" title=\"alt\">\n\n<p>アプリの歯車アイコン（System）から”Network Application Configuration”を選択します。以下のHostname&#x2F;IPとなっている場所にネットワークアプリケーションのIPアドレスを設定しておきます。</p>\n<img src=\"/new-technology/2022/09/23/unifi-network-application/app12-1.png\" class=\"\" width=\"280\" title=\"alt\">\n\n<h2 id=\"UniFiネットワーク経由のログイン\"><a href=\"#UniFiネットワーク経由のログイン\" class=\"headerlink\" title=\"UniFiネットワーク経由のログイン\"></a>UniFiネットワーク経由のログイン</h2><p>UniFiスマホアプリを終了し、Wi-Fiをオフにしてから再びアプリを起動します。今度は”Log in to Your UI Account”をタップし、UIシングルサインオンアカウントでログインします。</p>\n<img src=\"/new-technology/2022/09/23/unifi-network-application/app13.png\" class=\"\" width=\"280\" title=\"alt\">\n\n<p>接続に少し時間が掛かりますが、Ubiquitiのクラウド経由でローカルのUniFiネットワークアプリケーションに接続され、スイッチや接続されたクライアントの状態が把握可能となります。厳密にはUbiquitiクラウドからスマホのパブリックIPアドレスを取得し、UniFi Network Applicationからスマホアプリへの直接接続を行うようです。</p>\n<h2 id=\"2要素認証\"><a href=\"#2要素認証\" class=\"headerlink\" title=\"2要素認証\"></a>2要素認証</h2><p>ハイブリッドクラウドで外部からログインができるようになったので、2要素認証を設定します。ブラウザで<code>&lt;https://account.ui.com/&gt;</code>に接続します。</p>\n<p>“My Security”をタップします。</p>\n<img src=\"/new-technology/2022/09/23/unifi-network-application/verify1.png\" class=\"\" width=\"280\" title=\"alt\">\n\n<p>Multi Factor Authentication(MFA)をEnableにします。</p>\n<img src=\"/new-technology/2022/09/23/unifi-network-application/verify2.png\" class=\"\" width=\"280\" title=\"alt\">\n\n<p>”UI Verify”アプリを選択します。</p>\n<img src=\"/new-technology/2022/09/23/unifi-network-application/verify3.png\" class=\"\" width=\"280\" title=\"alt\">\n\n<p>UI VerifyアプリをダウンロードしAppを構成します。</p>\n<img src=\"/new-technology/2022/09/23/unifi-network-application/verify4.png\" class=\"\" width=\"280\" title=\"alt\">\n\n<p>2要素認証が完了し、アプリが使えない場合のメールアドレスへの通知が2要素認証のバックアップとして利用されます。</p>\n<img src=\"/new-technology/2022/09/23/unifi-network-application/verify5.png\" class=\"\" width=\"280\" title=\"alt\">\n\n<p>これで2要素認証が必須となり、UniFi Networkスマホアプリでは初回の認証時にUI Verifyアプリへのプッシュ通知が行われます。ユーザーが確認の応答を実施しログインが完了します。ローカル環境でブラウザなどからネットワークアプリケーションにログインする際や、UIアカウントサイトにログインする場合も2要素認証が求められ、UI Verifyアプリで応答する必要があります。</p>\n<img src=\"/new-technology/2022/09/23/unifi-network-application/verify6.png\" class=\"\" width=\"280\" title=\"alt\">\n\n<h2 id=\"ufwのGUI\"><a href=\"#ufwのGUI\" class=\"headerlink\" title=\"ufwのGUI\"></a>ufwのGUI</h2><p>Ubuntuで今回設定したufwの設定を追加する場合、GUIによるツールを導入しておくと便利です。<mark class=\"label primary\">Ubuntu Software</mark>から”gufw”を探し、インストールします。</p>\n<img src=\"/new-technology/2022/09/23/unifi-network-application/ubuntu1.png\" class=\"\" width=\"640\" title=\"alt\">\n\n<h2 id=\"セットアップの完了\"><a href=\"#セットアップの完了\" class=\"headerlink\" title=\"セットアップの完了\"></a>セットアップの完了</h2><p>ここまででUniFiのセットアップは完了です。ESXiのスナップショットを取得していらした方はスナップショットの管理から「すべて削除」し、一旦、Ubuntu全体のバックアップを取得される事をお勧めします。次の記事「<a href=\"/new-technology/2022/10/23/unifi-network-application2/\" title=\"UniFi Network Applicationの運用\">UniFi Network Applicationの運用</a>」で、UniFi Network Applicationの運用全般（設定のバックアップ、アップデート、通知）を紹介します。</p>\n","categories":["Network"],"tags":["UniFi"]},{"title":"XG Firewall VPNについて","url":"/new-technology/2020/03/28/vpn/","content":"<p class=\"onepoint\">この記事で実現すること</p>\n外出先から、PC（Windows、macOS）を使い、宅内にあるXG FirewallのIPSecを使ったVPNへ接続できます。ウィルス・マルウェア対策、Webフィルタなど安全なネット閲覧や、宅内のLANリソースへリモートアクセスができます。\n\n<span id=\"more\"></span>\n\n<h2 id=\"XG-FirewallのVPN\"><a href=\"#XG-FirewallのVPN\" class=\"headerlink\" title=\"XG FirewallのVPN\"></a>XG FirewallのVPN</h2><p>XGのVPNはプロトコルが何種類かあります。一般的なSSL-VPN,L2TP,PPTP、そしてSophosConnectというIPSecベースのものがあります。IPSecは一般的に安全性が高く、安定しているため、ここではIPSecのVPN導入について説明します。なお、この記事ではXG（VPNサーバ）側の設定およびPC（クライアント）に関する設定について記載しますが、最終的にはスマホ対応、2要素認証まで設定する事を目標にします。</p>\n<div class=\"note warning\"><p>XGにおけるIPSec-VPNはIPv4のみ対応しています。<br>プロバイダとの接続形態がDS-Liteおよびv6プラスの場合、NATまたは利用ポート制限のため、IPSecによるVPNは利用できません。<br>v6プラスの場合、SSL-VPNを利用する事で利用できる見込みがあります。XGにおけるSSL-VPNについては、「<a href=\"/new-technology/2021/05/30/ssl-vpn/\" title=\"XG Firewall SSL-VPN\">XG Firewall SSL-VPN</a>」を参照してください。</p>\n</div>\n\n<h2 id=\"IPSec-VPNについて\"><a href=\"#IPSec-VPNについて\" class=\"headerlink\" title=\"IPSec VPNについて\"></a>IPSec VPNについて</h2><p>IPSec VPNの設定にあたり、インターネットに接続されているホームゲートウェイから、VPNのパケットについては内部のXGのWANインターフェースに転送しなくてはなりません。一般的に市販されているルーターにも装備されていますが、この方法には2通りあります。</p>\n<ol>\n<li><p>全ての宅内へのトラフィックは全てXGに転送する<br> ルーターやホームゲートウェイの製品によって呼び方は異なりますが、DMZホスト機能などと呼ばれます。この場合はインターネットから入ってくるデータは全てXGに送られますので、宅内にサーバーを立てる場合、ホームゲートウェイからはXG以外の端末は接続出来なくなります。ただし、設定は単純というメリットがあります。</p>\n <img src=\"/new-technology/2020/03/28/vpn/dmz.png\" class=\"\" title=\"alt\">\n</li>\n<li><p>IPSecに必要なプロトコルおよび通信PortのみXGに転送する<br> こちらは一般的にポートマッピングと呼ばれます。内→外、外→内の方向について細かく設定します。IPSecに必要なプロトコルとPortは外→内で以下の通信になります。</p>\n</li>\n</ol>\n<ul>\n<li>ESPプロトコル（プロトコル番号：50）</li>\n<li>UDP 500,UDP 4500</li>\n</ul>\n <img src=\"/new-technology/2020/03/28/vpn/portmapping.png\" class=\"\" title=\"alt\">\n\n<p>プロバイダが上記ポートを通せること、また、上記の2つのいずれか対応できれば、XGに対するIPSec-VPN接続が行えます。この画面はホームゲートウェイの画面であり、契約しているインターネット回線業者により、提供される機器は異なりますのであくまで設定例は参考となります。</p>\n<h2 id=\"XG側のVPNユーザー作成\"><a href=\"#XG側のVPNユーザー作成\" class=\"headerlink\" title=\"XG側のVPNユーザー作成\"></a>XG側のVPNユーザー作成</h2><p>最初にユーザーの作成が必要です。VPNの最終接続形態としては、2要素認証対応のセキュアなものを目指します。ただし、いきなり全ての事を実施すると切り分けが難しいのでまずは2要素認証無しでの接続をし、次に2要素認証有りの接続に取り組みます。XGの左ペインメニューから<mark class=\"label primary\">認証</mark>を選択、<mark class=\"label primary\">ユーザー</mark>のタブから、追加ボタンをクリックします。そして以下のようにユーザー名、パスワードとメールアドレスを入力します。</p>\n<img src=\"/new-technology/2020/03/28/vpn/user1.png\" class=\"\" title=\"alt\">\n<img src=\"/new-technology/2020/03/28/vpn/user2.png\" class=\"\" title=\"alt\">\n\n<p>他はグループのところで、<mark class=\"label primary\">OPEN Group</mark>を選択するくらいで設定するところはありません。このまま保存をクリックします。VPNは、このユーザー名&#x2F;パスワードで接続する事になります。</p>\n<h2 id=\"XG側のIPSec-VPNの設定\"><a href=\"#XG側のIPSec-VPNの設定\" class=\"headerlink\" title=\"XG側のIPSec-VPNの設定\"></a>XG側のIPSec-VPNの設定</h2><p>XGの左ペインメニューから<mark class=\"label primary\">VPN</mark>を選択、<mark class=\"label primary\">Sophos Connect</mark>のタブを選択します。特に拘りがなければ、デジタル証明書ではなく、事前共有鍵を選択する事にしましょう。それなりの鍵の長さを設定しておけば安全です。また最終的にはワンタイムパスワードを設定する事でかなりの安心感が得られます。鍵はパスワードと異なり、一度クライアントに設定すれば接続の都度入力する必要もないため、複雑で長い鍵長の事前共有鍵の設定が好ましいでしょう。設定は以下の通りに行います。</p>\n<ul>\n<li><mark class=\"label primary\">インターフェース</mark>はPort2(WAN)を選択します</li>\n<li><mark class=\"label primary\">認証タイプ</mark>は事前共有鍵を選択します</li>\n<li><mark class=\"label primary\">事前共有鍵</mark>は文字列を入力、また繰り返し同じ鍵を入力します</li>\n<li><mark class=\"label primary\">許可されたユーザー</mark>には、上記で作成したユーザーを選択します</li>\n</ul>\n<img src=\"/new-technology/2020/03/28/vpn/vpn1.png\" class=\"\" title=\"alt\">\n\n<ul>\n<li>名前はXGの配置場所として適当な名前を入力します</li>\n<li>XGのVPNの割り当てネットワークは、LANとは別のネットワークアドレスを入力します。例えばLANが<code>192.168.2.0/24</code>のネットワークならば、<code>192.168.20.1</code>〜<code>192.168.20.8</code>などと別のネットワークを入力します</li>\n<li>DNSについては、XG自身のDNS（XGのLAN側のIPアドレス）を入力します</li>\n<li>詳細設定の<mark class=\"label primary\">トンネルがアイドルの時に切断</mark>を有効にします</li>\n<li><mark class=\"label primary\">アイドルセッション時間の間隔</mark>は600にします（ご自身で希望の値を設定してください）</li>\n</ul>\n<img src=\"/new-technology/2020/03/28/vpn/vpn2.png\" class=\"\" title=\"alt\">\n\n<p>適用ボタンをクリックすると、”これにより、同じローカルピアとリモートピア間で設定したすべての接続の事前共有鍵が更新されます。続行してもよいですか？”と表示されます。OKをクリックすれば、VPNが有効になります。</p>\n<h2 id=\"XG側のFirewallルールの確認\"><a href=\"#XG側のFirewallルールの確認\" class=\"headerlink\" title=\"XG側のFirewallルールの確認\"></a>XG側のFirewallルールの確認</h2><p>上記で設定したVPNがFirewallのルールに登録されている事を確認します。VPNとWANの接続を優先に考え設定します。「<a href=\"/new-technology/2020/03/14/rule-policy2/\" title=\"XG Firewall v18のルールを作成する\">XG Firewall v18のルールを作成する</a>」では、デフォルトのルール”To_Internet”を作成しました。ルールについて、以下の図のように<mark class=\"label primary\">送信元ゾーン</mark>が、LANとVPNとなっている事を確認してください。</p>\n<img src=\"/new-technology/2020/03/28/vpn/rule1.png\" class=\"\" title=\"alt\">\n\n<p>続いて、VPNからLANへのルールを作成します。NATは使わず全てのトラフィックを通過させるものです。以下の通り、送信元ゾーンはVPN、宛先ゾーンはLANのルールを設定します。</p>\n<img src=\"/new-technology/2020/03/28/vpn/rule2.png\" class=\"\" title=\"alt\">\n\n<p>（2020-06-20更新）このルールでは、<mark class=\"label primary\">リンクNATルールの作成</mark>は行いません。NATの動作の確認のために「NATしない事を明示する」設定を行うと挙動がわかりやすいというメリットはありますが、v18では原則リンクNATは使わず運用可能という考え方のようで当初記載していたリンクNATの記述を削除しました。</p>\n<p>さらにルールで保存をクリックしてルールの設定は完成です。念のため現在のルールについて確認しましょう。<mark class=\"label primary\">Traffic to Internal</mark>として、VPNからLANへの接続ルールがあります。もう1つは、<mark class=\"label primary\">Traffice to WAN</mark>として、VPNおよびLANからWANへの接続ルールがあります。</p>\n<img src=\"/new-technology/2020/03/28/vpn/rule6.png\" class=\"\" title=\"alt\">\n\n<h2 id=\"XG側のDynamic-DNSの設定\"><a href=\"#XG側のDynamic-DNSの設定\" class=\"headerlink\" title=\"XG側のDynamic DNSの設定\"></a>XG側のDynamic DNSの設定</h2><p>自宅のXGに接続するためには自宅に割り当てられたIPアドレスをあらかじめ知る必要がありますので、ここでダイナミックDNS（DDNS）が必要となります。</p>\n<p>(2021-8-15更新）<br>Sophosが提供するDDNSであるmyfirewall.coについては2022年1月末をもってサービス提供終了となります。またXG v18.5では既にmyfirewall.coを選択できなくなっています。XGが対応しているDDNSは以下の通りです。もちろん、このDDNSでなくとも、NASをお持ちの方であればNASが提供しているDDNSを利用できます。</p>\n<ul>\n<li>DynDNS</li>\n<li>ZoneEdit</li>\n<li>EasyDNS</li>\n<li>DynAccess</li>\n<li>No-IP</li>\n<li>DNS-O-Matic</li>\n<li>Google DNS</li>\n<li>Namecheap</li>\n<li>FreeDNS</li>\n</ul>\n<mark class=\"label primary\">IPv4アドレス</mark>の箇所は、<mark class=\"label primary\">NATされたパブリックIP</mark>を選んでください。\n\n<img src=\"/new-technology/2020/03/28/vpn/ddns.png\" class=\"\" title=\"alt\">\n\n<p>登録が終わると、直ちにグローバルIPがダイナミックDNSに登録されます。その後、<mark class=\"label primary\">前回更新したIP</mark>にグローバルIPが表示され、<mark class=\"label primary\">前回更新した状態</mark>にSuccessと表示されます。</p>\n<img src=\"/new-technology/2020/03/28/vpn/ddns2.png\" class=\"\" title=\"alt\">\n\n<h2 id=\"XG側のデバイスのアクセス設定\"><a href=\"#XG側のデバイスのアクセス設定\" class=\"headerlink\" title=\"XG側のデバイスのアクセス設定\"></a>XG側のデバイスのアクセス設定</h2><p>XG側はこれが最後の設定です。左ペインの<mark class=\"label primary\">管理</mark>から、<mark class=\"label primary\">デバイスのアクセス</mark>へと進みます。そこに、LAN、WAN、VPN毎にサービスのアクセス権限が定めている一覧になります。ここでは以下の項目のアクセス権を加えます。</p>\n<ul>\n<li>管理サービス　HTTPS&#x2F;SSH<br> XGの管理メニューにVPN経由でアクセスする事を可能とします。</li>\n<li>Ping&#x2F;Ping6<br> こちらの設定は任意です。</li>\n<li>DNS<br> LANおよびVPNからのアクセスはXGのDNSをまず最初に参照します。LANにあるホストを参照する時は、XGのDNSがプライベートIPを返すように、スタティックのプライベートIPをDNSに登録しておきたいためです。これは後々サーバーを宅内に立てる場合、活用する事になります。</li>\n</ul>\n<h2 id=\"クライアントのダウンロード\"><a href=\"#クライアントのダウンロード\" class=\"headerlink\" title=\"クライアントのダウンロード\"></a>クライアントのダウンロード</h2><p>WindowsでVPN接続するためにはVPNクライアントをダウンロードします。上記のXGのVPN設定画面で<mark class=\"label primary\">Sophos Connectクライアントのダウンロード</mark>というボタンがありました。そちらをクリックし、ソフトウェアをダウンロードします。こちらは、Windows版、macOS版のダウンロードが出来ます。</p>\n<h3 id=\"XG-v18-MR-3以前の設定ファイル\"><a href=\"#XG-v18-MR-3以前の設定ファイル\" class=\"headerlink\" title=\"XG v18 MR-3以前の設定ファイル\"></a>XG v18 MR-3以前の設定ファイル</h3><p>この画面の<mark class=\"label primary\">接続のエクスポート</mark>ボタンをクリックし、接続設定ファイルをダウンロードしてください（拡張子tgb）。</p>\n<h3 id=\"XG-v18-MR-4以降の設定ファイル\"><a href=\"#XG-v18-MR-4以降の設定ファイル\" class=\"headerlink\" title=\"XG v18 MR-4以降の設定ファイル\"></a>XG v18 MR-4以降の設定ファイル</h3><p>XG v18 MR-4以降はIPSecの接続に関する詳細設定がXG本体で行えるようになりました。設定画面は以下の通りです。</p>\n<img src=\"/new-technology/2020/03/28/vpn/mr4.png\" class=\"\" title=\"alt\">\n\n<ul>\n<li>VPNを張る場合、クライアントからの全ての通信を原則XGを経由するため、<mark class=\"label primary\">デフォルトのゲートウェイとして使用</mark>を”On”にします。</li>\n<li>ユーザー、パスワードの保存を許可をチェックします。</li>\n<li>2要素認証を使う場合は「2FAトークンの入力を求める」にチェックしますが、2要素認証の事前セットアップが必要であるため、この段階では一旦外しておきましょう。</li>\n</ul>\n<p>上記設定し、<mark class=\"label primary\">接続のエクスポート</mark>ボタンをクリックし、接続設定ファイルをダウンロードしてください（拡張子tar.gz）。このなかにさらに拡張子scxというファイルがありそれを使います。</p>\n<h2 id=\"クライアントのセットアップ\"><a href=\"#クライアントのセットアップ\" class=\"headerlink\" title=\"クライアントのセットアップ\"></a>クライアントのセットアップ</h2><p>クライアントへのセットアップは、Windowsの場合は、SophosConnect.msiをインストールします。macOSの場合は、SophosConnect.pkgをインストールします。プログラム実行後、右上のメニューから、<mark class=\"label primary\">Import Connection</mark>をクリックし、先ほどダウンロードした接続設定ファイル（拡張子scx）を読み込んでください。</p>\n<p>もし、DDNSを上記のDDNS提供業者ではなく、別のものを用意するものに変更するのであれば、scxファイルのddns名の箇所を任意のホスト名に修正できます。<br>以下のように、”gateway”で始まる行にホスト名またはIPアドレスが記述されているので、この行を目的のホスト名に変更します。<br>私の場合、QNAPのNASのDDNSがありますので、この例だと以下のように書き換えます。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">&quot;gateway&quot; : &quot;xxxx.myfirewall.co&quot;,</span><br></pre></td></tr></table></figure>\n\n<p>→</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">&quot;gateway&quot; : &quot;xxxx.myqnapcloud.com&quot;,</span><br></pre></td></tr></table></figure>\n\n<img src=\"/new-technology/2020/03/28/vpn/install.png\" class=\"\" title=\"alt\">\n\n<h2 id=\"VPNの接続確認\"><a href=\"#VPNの接続確認\" class=\"headerlink\" title=\"VPNの接続確認\"></a>VPNの接続確認</h2><mark class=\"label primary\">Connect</mark>をクリックし、VPN用に設定したユーザー名とパスワードでインターネットから、宅内のXGに接続します。\n\n<img src=\"/new-technology/2020/03/28/vpn/connected1.png\" class=\"\" title=\"alt\">\n<img src=\"/new-technology/2020/03/28/vpn/connected2.png\" class=\"\" title=\"alt\">\n\n<p>VPN経由でインターネットに接続し、ブラウザからアクセスできること、IPアドレスがプロバイダから貸与されたアドレスになっているか確認します。また、LANの機器との接続が行える事も確認してください。接続業者によっては、IPSecで利用するESP,UDPプロトコルを通さないところもあります。</p>\n<p>なお、ここまで説明してきた通り、LANとVPNのネットワークセグメントは異なりますので、ブロードキャストで相手を見つけるようなアプリケーションはVPNからLANに対する接続は行えません。</p>\n<p>公衆回線経由でXGにIPSecで接続できたら、続いて2要素認証の設定に続きます。「<a href=\"/new-technology/2020/03/28/vpnotp/\" title=\"XG Firewall VPNに2要素認証を設定する\">XG Firewall VPNに2要素認証を設定する</a>」を参照してください。</p>\n<h2 id=\"SSL-x2F-TLSインスペクションの設定（任意設定）\"><a href=\"#SSL-x2F-TLSインスペクションの設定（任意設定）\" class=\"headerlink\" title=\"SSL&#x2F;TLSインスペクションの設定（任意設定）\"></a>SSL&#x2F;TLSインスペクションの設定（任意設定）</h2><p>ここまでの設定でVPNの設定は終了ですが、VPNについてもSSL&#x2F;TLSインスペクションが有効となるように設定をお勧めします。一旦はVPNのネットワークからインターネットにアクセスする場合は、全てがSSL&#x2F;TLSインスペクションの対象とし、ファイアウォールルールを修正します。</p>\n<ol>\n<li><p>最初にVPNのネットワークアドレスを左ペインの<mark class=\"label primary\">ホストとサービス</mark>から<mark class=\"label primary\">IPホスト</mark>を登録します。<img src=\"/new-technology/2020/03/28/vpn/vpn3.png\" class=\"\" title=\"alt\"></p>\n</li>\n<li><p>上記のようにネットワークにIPアドレス（この記事では192.168.20.0&#x2F;24としています）を登録します。VPNのネットワークは、LANのネットワークとは別のネットワークアドレスとする必要があります。</p>\n</li>\n<li><p>次に、左ペインの<mark class=\"label primary\">ルールとポリシー</mark>から、<mark class=\"label primary\">SSL/TLSインスペクション</mark>を選択します。</p>\n</li>\n<li><p>事前に作成してある<mark class=\"label primary\">Catch SSL</mark>ルールを選択し、ここにVPNのネットワークがSSL&#x2F;TLSインスペクションの対象である事を設定します。<img src=\"/new-technology/2020/03/28/vpn/vpn4.png\" class=\"\" title=\"alt\"></p>\n</li>\n<li><p>上記の図では<mark class=\"label primary\">送信元ネットワークとデバイス</mark>に、CAがインストールされているPCおよびiPhoneを対象とするIPグループを<mark class=\"label primary\">CA_Clinet_IPv4</mark>として登録していました。これに今回はVPNのネットワーク<mark class=\"label primary\">VPN_Network_IPv4</mark>を追加登録します。</p>\n</li>\n</ol>\n<p>ここまでの設定でIPSec-VPNの設定は一段落です。SSL&#x2F;TLSインスペクションの設定および動作確認については、下記の記事を参照して下さい。</p>\n<ul>\n<li><a href=\"/new-technology/2020/03/20/ssl-inspection/\" title=\"SSLインスペクションについて\">SSLインスペクションについて</a></li>\n<li><a href=\"/new-technology/2020/03/20/ssl-inspection1/\" title=\"XG Firewall v18のSSL&#x2F;TLSインスペクションの設定\">XG Firewall v18のSSL&#x2F;TLSインスペクションの設定</a></li>\n<li><a href=\"/new-technology/2020/03/21/ssl-inspection2/\" title=\"XG Firewall v18のSSLインスペクションの動作確認と調整\">XG Firewall v18のSSLインスペクションの動作確認と調整</a></li>\n</ul>\n","categories":["Security","VPN"],"tags":["XG Firewall"]},{"title":"XG Firewall VPNに2要素認証を設定する","url":"/new-technology/2020/03/28/vpnotp/","content":"<p class=\"onepoint\">この記事で実現すること</p>\nPC（Windows、macOS）からXG FirewallのIPSec VPNへ接続しているユーザーに、ワンタイムパスワードによる2要素認証機能を追加し、セキュリティを高められます。\n\n<span id=\"more\"></span>\n\n<h2 id=\"XGが提供するVPNの2要素認証\"><a href=\"#XGが提供するVPNの2要素認証\" class=\"headerlink\" title=\"XGが提供するVPNの2要素認証\"></a>XGが提供するVPNの2要素認証</h2><p>XGのVPNにおいて、SSL-VPNとIPSecはワンタイムパスワードが設定できます。サイバー攻撃の脅威がますます大きくなる今日においては、VPNの多要素認証は必須条件ではないでしょうか。</p>\n<h2 id=\"ワンタイムパスワードアプリ\"><a href=\"#ワンタイムパスワードアプリ\" class=\"headerlink\" title=\"ワンタイムパスワードアプリ\"></a>ワンタイムパスワードアプリ</h2><p>ワンタイムパスワードについては、定番のGoogleのオーセンティケーターが有名です。GoogleのオーセンティケーターはXGが表示するワンタイムパスワードのQRコードが読み込めません。Sophosからは、以下のスマホアプリが提供されています。</p>\n<blockquote>\n<p>Sophos Intercept X for Mobile(iOS)<br> <a href=\"https://apps.apple.com/jp/app/sophos-intercept-x-for-mobile/id1086924662\">https://apps.apple.com/jp/app/sophos-intercept-x-for-mobile/id1086924662</a><br>Sophos Intercept X for Mobile(Android)<br> <a href=\"https://play.google.com/store/apps/details?id=com.sophos.smsec\">https://play.google.com/store/apps/details?id=com.sophos.smsec</a></p>\n</blockquote>\n<p>なお、私は複数の端末でワンタイムパスワードの同期ができる<strong>Authy</strong>を利用しています。</p>\n<blockquote>\n<p>Authy<br> <a href=\"https://apps.apple.com/jp/app/authy/id494168017\">https://apps.apple.com/jp/app/authy/id494168017</a></p>\n</blockquote>\n<h2 id=\"ワンタイムパスワードの基本設定\"><a href=\"#ワンタイムパスワードの基本設定\" class=\"headerlink\" title=\"ワンタイムパスワードの基本設定\"></a>ワンタイムパスワードの基本設定</h2><p>XGにおけるワンタイムパスワードの設定は、左ペインの<mark class=\"label primary\">認証</mark>から<mark class=\"label primary\">ワンタイムパスワード</mark>へと進んでください。設定ボタンをクリックし、以下の項目を設定します。</p>\n<img src=\"/new-technology/2020/03/28/vpnotp/otp3.png\" class=\"\" title=\"alt\">\n\n<ul>\n<li><mark class=\"label primary\">ワンタイムパスワード</mark>のトグルをオンにします</li>\n<li><mark class=\"label primary\">全ユーザーのOTP</mark>のトグルはオフにします</li>\n<li><mark class=\"label primary\">ユーザーのOTPトークンを自動生成</mark>のトグルはオンにします</li>\n<li><mark class=\"label primary\">以下のユーザーとグループにOTPが必要</mark>のリストボックスからは、Open Groupを選択します</li>\n<li><mark class=\"label primary\">以下について、OTPを有効化</mark>は、<mark class=\"label primary\">ユーザーポータル</mark>、<mark class=\"label primary\">IPSecリモートアクセス</mark>にチェックします</li>\n<li>最後に適用ボタンをクリックします</li>\n</ul>\n<h2 id=\"ワンタイムパスワードの自動生成\"><a href=\"#ワンタイムパスワードの自動生成\" class=\"headerlink\" title=\"ワンタイムパスワードの自動生成\"></a>ワンタイムパスワードの自動生成</h2><p>続いて、ユーザーポータルという画面にログインします。これは管理者向けではなく、ユーザー向けに提供されているものです。XGの管理者メニューは、デフォルトでは、<code>https://XGのIPアドレス:4444/</code>になっていますが、<code>https://XGのIPアドレス/</code>に接続するとユーザーポータル画面が開きます。XGの管理画面の<mark class=\"label primary\">管理</mark>メニュー→<mark class=\"label primary\">管理者とユーザーの設定</mark>メニューでユーザーポータルのHTTPSポートが確認できます。</p>\n<p>ユーザーポータル画面では、VPN向けに作成したユーザーとパスワードでログインします。すると、次にワンタイムパスワードのトークンが自動生成され、QRコードが表示されます。</p>\n<img src=\"/new-technology/2020/03/28/vpnotp/otp1.png\" class=\"\" title=\"alt\">\n\n<p>ここで、ワンタイムパスワードのアプリでQRコードを読み込み、アプリにトークンを取り込んでください。完了後、XGのメニューで<mark class=\"label primary\">ログインに進む</mark>をクリックすると、再びログイン画面になります。ここではユーザーはそのまま入力、パスワードの部分は、<strong>パスワード＋ワンタイムパスワードの数字6桁を続けて入力</strong>します。ユーザーポータルにログインできれば、ワンタイムパスワードは正しくアプリに取り込まれています。</p>\n<p>再び、XGの管理画面にadminでログインします。左ペインの<mark class=\"label primary\">認証</mark>から<mark class=\"label primary\">ワンタイムパスワード</mark>に進むと、<mark class=\"label primary\">シークレット</mark>が生成されている事がわかります。</p>\n<img src=\"/new-technology/2020/03/28/vpnotp/otp2.png\" class=\"\" title=\"alt\">\n\n<p>これで、IPsecVPNにはワンタイムパスワードが必須となりました。以前作成したSophosConnectクライアントの接続設定ファイルについて、再設定が必要になります。「<a href=\"/new-technology/2020/03/28/vpn/\" title=\"XG Firewall VPNについて\">XG Firewall VPNについて</a>」ではVPNのセットアップを行い、クライアントソフトウェアをダウンロードしましたが、2要素認証の設定を加える必要があります。</p>\n<h2 id=\"XG-v18-MR-3以前の設定ファイル\"><a href=\"#XG-v18-MR-3以前の設定ファイル\" class=\"headerlink\" title=\"XG v18 MR-3以前の設定ファイル\"></a>XG v18 MR-3以前の設定ファイル</h2><h3 id=\"scadminツールで設定ファイルを作成\"><a href=\"#scadminツールで設定ファイルを作成\" class=\"headerlink\" title=\"scadminツールで設定ファイルを作成\"></a>scadminツールで設定ファイルを作成</h3><p>こちらは少し古い方法です。v18MR-3以前の場合は、SophosConnectクライアントではなく、もう1つの設定ファイル作成ツールである、scadminツールをWindowsにインストールします。このアプリケーションはmacOS版がありませんので、Windowsで設定ファイルを作成する事になります。出力された設定ファイルは、Windows、mac共に共通で利用出来ますので、それをSophosConnectクライアントに取り込みます。scadmin.msiをインストールし起動します。OPENボタンを押して、以前に生成された接続設定ファイル（拡張子tgb）ファイルを開きます。</p>\n<img src=\"/new-technology/2020/03/28/vpnotp/otp4.png\" class=\"\" title=\"alt\">\n\n<p>設定は<mark class=\"label primary\">Allow Password Saving</mark>と、<mark class=\"label primary\">Prompt for 2FA</mark>のトグルスイッチをOnにするのみです。そして、右下のSaveで保存してください。今回はファイルの拡張子は、scxとなっています。最後に、Sophos Connect Clientより、再度作成した設定ファイル（scx）を読み込み完了です。IDとパスワードに加え、ワンタイムパスワードをセットし接続できる事を確認してください。</p>\n<h2 id=\"XG-v18-MR-4以降の設定ファイル\"><a href=\"#XG-v18-MR-4以降の設定ファイル\" class=\"headerlink\" title=\"XG v18 MR-4以降の設定ファイル\"></a>XG v18 MR-4以降の設定ファイル</h2><p>MR-4以降の場合は、XG管理画面のVPN→IPSecで詳細設定が可能ですので、<mark class=\"label primary\">ユーザーに2FAトークンの入力を求める</mark> をチェックし、2要素認証を有効に設定します。その後、設定ファイル（tar.gz）をダウンロード、その中にある拡張子scxの設定ファイルをSophosConnectクライアントに取り込みます。</p>\n<img src=\"/new-technology/2020/03/28/vpnotp/mr4.png\" class=\"\" title=\"alt\">\n\n<h2 id=\"接続\"><a href=\"#接続\" class=\"headerlink\" title=\"接続\"></a>接続</h2><p>SophosConnectクライアントから接続します。ユーザー、パスワードを保存しておくと、次回からはワンタイムパスワードのみを入力すれば接続可能となります。</p>\n<img src=\"/new-technology/2020/03/28/vpnotp/otp5.png\" class=\"\" title=\"alt\">\n\n<p>これまでの設定で、外出先から2要素認証による堅牢な環境でLANの機器にアクセスしたり、安全なWebブラウジングができるようになりました。</p>\n","categories":["Security","VPN","ワンタイムパスワード"],"tags":["XG Firewall"]},{"title":"XG FirewallのWebとアプリケーションフィルタについて","url":"/new-technology/2020/05/06/web-application-filter/","content":"<p class=\"onepoint\">この記事で実現すること</p>\nXG FirewallのWebフィルタ・アプリケーションフィルタについて、活用方法を説明します。\n\n<span id=\"more\"></span>\n\n<h2 id=\"Webフィルタについて\"><a href=\"#Webフィルタについて\" class=\"headerlink\" title=\"Webフィルタについて\"></a>Webフィルタについて</h2><p>XGの左ペインメニューでは、<mark class=\"label primary\">Web</mark>、<mark class=\"label primary\">アプリケーション</mark>とそれぞれ分かれています。<mark class=\"label primary\">Web</mark>ではサイトのカテゴリが分かれていて、そのサイトのカテゴリによっては閲覧を制限する事が一般的な使い方です。これらのポリシーは、「Sophos XG Firewall: Web カテゴリ」の記事にも日本語の解説があります。サイトのカテゴリについては、ビジネス、ギャンブル、ゲーム、アダルト、ファイナンス等多岐に渡ります。ホームユーザーとしてはいわゆる怪しいサイトや過度な広告をフィルタする事が主目的になります。しかし、上記サイトのポリシーを眺めていると疑問に感じるところがあります。”ActiveX”、”Applets”、”SpamURLs”です。ActiveXやAppletは単純にサーバー名とも関係ありません。サイトのカテゴリに加え、URLまでを対象としているようです。Web カテゴリについては、以下のの記事を参照してください。</p>\n<blockquote>\n<p><a href=\"https://community.sophos.com/kb/ja-jp/134155\">https://community.sophos.com/kb/ja-jp/134155</a></p>\n</blockquote>\n<p>上記のWebカテゴリには記載がないものの、XGの左ペインメニューの<mark class=\"label primary\">Web</mark>の<mark class=\"label primary\">ファイルタイプ</mark>の内容には、ファイル拡張子やMIMEヘッダーの情報が並びます。そしてここにはZIPファイルなどの”Compressed Files”、Windowsの実行ファイルである”Executable File”などの項目が並んでいます。</p>\n<p>ホームユーザーとしては、ZIPファイルやEXEファイルが使えないと不便なのでフィルタする事は考えにくいですが、何らかのMIMEタイプを拒否するポリシーを作成する場合は有効に機能しそうです。最終的には、Webフィルタは以下の種類の分類となります。</p>\n<ul>\n<li>Webカテゴリ</li>\n<li>URLグループ（自身で作成したURLの集まり）、280blockerなどのURLデータベースもこのグループ</li>\n<li>ファイルタイプ</li>\n<li>ダイナミックカテゴリ（ActiveX・Applets・Cookies・HTTP Upload）</li>\n</ul>\n<p>これらの事から、Webフィルタはカテゴリの分類という主目的はあるものの、ブラウザを対象としたフィルタの機能である事がわかります。</p>\n<h2 id=\"SNIとフィルタとの関係\"><a href=\"#SNIとフィルタとの関係\" class=\"headerlink\" title=\"SNIとフィルタとの関係\"></a>SNIとフィルタとの関係</h2><p>SNIとは、Server Name Indicationの略です。SSL&#x2F;TLS通信において、クライアントからサーバ証明書を要求する時に<strong>サーバ名（SNI）を暗号化せずサーバーに渡します</strong>。XGはこのSNIを見てWebフィルタを行っていますので、接続しようとしているドメインやサーバー単位にアクセス許可・不許可の判断が可能になります。しかし<strong>フォルダ構成やMIMEタイプ、引数やダウンロードするデータを検査するには、SSLインスペクションが必要です</strong>。もちろん、ドメイン単位の制御でIoT機器はある程度の防御が可能と言えますが、防御を最大限に高めるにはSSLインスペクションが必要です。「<a href=\"/new-technology/2020/03/21/ssl-inspection2/\" title=\"XG Firewall v18のSSLインスペクションの動作確認と調整\">XG Firewall v18のSSLインスペクションの動作確認と調整</a> 」で記載した通り、ZIP化されたマルウェアはSSLインスペクションが行えなければ検知は出来ません。</p>\n<h2 id=\"アプリケーションフィルタについて\"><a href=\"#アプリケーションフィルタについて\" class=\"headerlink\" title=\"アプリケーションフィルタについて\"></a>アプリケーションフィルタについて</h2><p>XGのアプリケーションフィルタは、XGの左ペインメニューの<mark class=\"label primary\">アプリケーション</mark>から確認できます。ブラウザーではないインターネットに接続するアプリケーションを対象にしています。ここの挙動の確認は非常に難しいものがあります。例えば、MicrosoftのOneDriveを題材にテストしてみましょう。SSLインスペクションが行えるWindows端末とSSLインスペクションが行えないAndroid端末を用いて検証します。</p>\n<p>OneDriveのURLは、現時点で、<code>https://onedrive.live.com/</code>です。Webフィルタで当該ドメインのフィルタを行うと、想定通りブラウザーからOneDriveにはアクセス出来ません。これはSNIで判断できるため、SSLインスペクションの有無に関わらずアクセス不可が実現できます。</p>\n<img src=\"/new-technology/2020/05/06/web-application-filter/onedrive.png\" class=\"\" title=\"alt\">\n\n<p>しかし、Android端末の<strong>OneDriveアプリ</strong>経由では制御が効かずファイルをアップロードできてしまいます。また、WindowsPCのエクスプローラーの<strong>OneDriveフォルダ</strong>からもファイルが削除出来、クラウド上のファイルは削除されます。これは<strong>アプリが使うWebAPIのURLとブラウザが使うURLとは異なる</strong>ためにこういった事象（Webフィルタでは制御できないこと）が発生すると考えられます。</p>\n<p>さらに検証を続けます。一旦Webフィルタを削除し、アプリケーションフィルタにOneDriveの項目があるので、そちらをフィルタしてみます。</p>\n<p>XGの左ペインメニューの<mark class=\"label primary\">アプリケーション</mark>からファイアウォールルールで選択されているポリシーの先頭で<mark class=\"label primary\">追加</mark>ボタンをクリックし、<mark class=\"label primary\">スマートフィルタ</mark>に<code>onedrive</code>と入力し、Enterキーを押します。</p>\n<img src=\"/new-technology/2020/05/06/web-application-filter/appfilter2.png\" class=\"\" title=\"alt\">\n\n<p>OneDriveのルールがいくつか表示されます。”OneDrive Application”,”OneDrive Base”,”OneDrive File Download”,”OneDrive File Upload”です。<mark class=\"label primary\">アクション</mark>を”拒否”して最後に”保存”をクリックします。この作業の結果は以下の通りの挙動でした。</p>\n<table>\n<thead>\n<tr>\n<th>OS</th>\n<th>テスト内容</th>\n<th>結果</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Windows</td>\n<td>ブラウザからOneDriveにアクセス</td>\n<td>接続不可</td>\n</tr>\n<tr>\n<td></td>\n<td>WindowsエクスプローラーからOneDriveにファイル追加</td>\n<td>不可</td>\n</tr>\n<tr>\n<td></td>\n<td>WindowsエクスプローラーからOneDriveのファイル削除</td>\n<td><strong>不可</strong></td>\n</tr>\n<tr>\n<td>Android</td>\n<td>ブラウザからOneDriveにアクセス</td>\n<td>接続不可</td>\n</tr>\n<tr>\n<td></td>\n<td>OneDriveアプリからファイル追加</td>\n<td>不可</td>\n</tr>\n<tr>\n<td></td>\n<td>OneDriveアプリからファイル削除</td>\n<td><strong>可能</strong></td>\n</tr>\n</tbody></table>\n<p>上記のOneDriveに関するテスト結果では、ファイル削除について、SSLインスペクションの有無で動作に違いが表れました。AndroidはSSLインスペクションが行えないため、URL（SNI）の検証は行えますが、データの中身はhttpsで暗号化されておりファイル削除については制御出来ませんでした。また、OneDriveはファイルのアップロード・ダウンロードと分かれていましたが、他のアプリケーションであるAppleのiCloudDriveに関してはアプリケーションフィルタは1種類だけです。このようにアプリケーションフィルタは、アプリの作り方にも左右されるものとなります。</p>\n<p>なお、アプリケーションフィルタの中には、”EXE File Download”というフィルタも存在しますが、あくまで汎用的なものです。全てのいかなるアプリケーションからのEXEファイルのダウンロードを禁止できるものではありません。</p>\n<div class=\"note info\"><p>Webフィルタ・アプリケーションフィルタを完全に動作させるには、SSLインスペクションが必要です。</p>\n</div>\n\n<p>このアプリケーションは止めておきたいというニーズに対して、都度メンテナンスしていくのはとても大変です。従い、高リスクのアプリケーションは拒否する設定をします。具体的な設定については、「<a href=\"/new-technology/2020/05/09/best-practice/\" title=\"XG Firewall v18の設定におけるベストプラクティス\">XG Firewall v18の設定におけるベストプラクティス</a>」を参照してください。</p>\n<p>XGを運営しているプロダクトチームは、こういったトラフィックの中身を見ながら制御するポリシーを作るのですから、極めて大変な作業です。特にクラウドアプリケーションは予告なくURLやAPIが変更されるでしょうから、そのメンテナンスコストは計り知れません。</p>\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"XG FirewallでIPv6の設定を行う（前半）","url":"/new-technology/2020/04/25/xg-ipv6-1/","content":"<p class=\"onepoint\">この記事で実現すること</p>\nXG FirewallからホームゲートウェイとをIPv6で接続し、IPv6ホストの名前解決をテストします。\n\n<span id=\"more\"></span>\n\n<h2 id=\"IPv6を取り巻く環境\"><a href=\"#IPv6を取り巻く環境\" class=\"headerlink\" title=\"IPv6を取り巻く環境\"></a>IPv6を取り巻く環境</h2><p>いつかは枯渇すると言われているIPv4アドレスですが、欧州を管轄するRIPE NCCから、2019年11月25日に欧州のIPv4アドレスが枯渇したと発表されました。インターネットにいきなり大きく影響が出てくる事はありませんが、これからは徐々にIPv4だけでは接続出来ないサイトが出てくるものと思われます。IPv6の接続方式は、PPPoEの接続方法とIPoEの2通りの接続方法があります。プロトコル自体に優劣はさほどありません。いろいろな記事ではPPPoEが劣っているという書き振りを見かける事が多いのですが、これは大手回線業者の固有事情によるものです。実態としては単にIPv6のユーザーが少なく、途中のネットワークが空いている事が多いだけで、プロトコルとして高速なわけではありません。ただ現状の環境からすると、IPv6ネットワークはまだ将来を見据えて余裕がある状態である事は間違いなく、混雑しづらい状況にあります。</p>\n<p>IPv6は実質無限といっていいほどのアドレス空間を持ちます。IPアドレスは例を挙げると、<mark class=\"label primary\">2001:0db8:0000:0000:3456:0000:0000:0001</mark>のように表記が長く、管理する側もIPv4に比べて大変です。ホームユーザーとしては、宅内のIPアドレス管理の主体はIPv4としつつ、IPv6のサイトへのアクセスも可能というくらいに考えておく事が必要です。インターネットの接続業者によってはネット契約とは別にIPv6を改めて申し込む必要があります。大半の接続業者ではIPv6の利用は無料です。</p>\n<h2 id=\"IPv6の設定にあたって\"><a href=\"#IPv6の設定にあたって\" class=\"headerlink\" title=\"IPv6の設定にあたって\"></a>IPv6の設定にあたって</h2><p>XG FirewallはIPv6に対応しています。回線業者およびプロバイダがIPv6のサポートをしている前提で、ホームゲートウェイ（HGW）に接続する形態を想定しています。XGからHGWには普通にIPv6としてのネットワーク通信を行います。そういう意味ではIPoEとも言えます。貸与されているHGWとXGとのIPv6接続が正しく行えるかが最初のハードルとなります。この記事では、ホームゲートウェイからXGにてIPv6アドレスを割り当てられ、XGからIPv6でインターネットへのアクセスが可能か確認します。また、制約としてAndoroidはXGの構成によってはIPv6を使えない可能性があります。</p>\n<h2 id=\"HGWからIPv6の配布を受ける\"><a href=\"#HGWからIPv6の配布を受ける\" class=\"headerlink\" title=\"HGWからIPv6の配布を受ける\"></a>HGWからIPv6の配布を受ける</h2><p>ホームゲートウェイから配布されるIPアドレスは、従来のIPv4であればDHCPの機能となりますが、IPv6の場合は以下の2通りがあります。</p>\n<ol>\n<li>DHCPv6</li>\n<li>Router Advertisement</li>\n</ol>\n<p>最近の機械だとHGWに設定する箇所もなく、IPv6の契約があれば、プロバイダからIPoEでIPv6の接続が可能になっている状況もあるようです。XGは、上記いずれの方法でもHGWからのパブリックIPアドレスを受け取れるようです。</p>\n<h3 id=\"WANインタフェースでIPv6を構成する\"><a href=\"#WANインタフェースでIPv6を構成する\" class=\"headerlink\" title=\"WANインタフェースでIPv6を構成する\"></a>WANインタフェースでIPv6を構成する</h3><p>XGのPort2（WAN側）でIPv6の設定を行います。XGの左ペインメニューから、<mark class=\"label primary\">ネットワーク</mark>の<mark class=\"label primary\">インターフェース</mark>を選び、<mark class=\"label primary\">Port2</mark>をクリックします。</p>\n<img src=\"/new-technology/2020/04/25/xg-ipv6-1/network.png\" class=\"\" title=\"alt\">\n\n<ul>\n<li><mark class=\"label primary\">IPv6設定</mark>のチェックボックスをOnにします</li>\n<li><mark class=\"label primary\">IPの割り当て</mark>はDHCPを選びます</li>\n<li><mark class=\"label primary\">モード</mark>は<mark class=\"label primary\">手動</mark>、<mark class=\"label primary\">ステートレス</mark>、<mark class=\"label primary\">DHCPから他の設定を承認</mark>を選択します</li>\n<li><mark class=\"label primary\">ゲートウェイ名</mark>は<mark class=\"label primary\">IPv6_GW</mark>など、自由に命名してください</li>\n</ul>\n<mark class=\"label primary\">保存</mark>をクリックすると下記の確認画面が表示されます<img src=\"/new-technology/2020/04/25/xg-ipv6-1/update.png\" class=\"\" title=\"alt\">\n\n<mark class=\"label primary\">インターフェースを更新</mark>をクリックすると、以下の通り、パブリックIPv6アドレスがHGWより割り当てられます\n <img src=\"/new-technology/2020/04/25/xg-ipv6-1/update2.png\" class=\"\" title=\"alt\">\n\n<h3 id=\"DNSv6を設定する\"><a href=\"#DNSv6を設定する\" class=\"headerlink\" title=\"DNSv6を設定する\"></a>DNSv6を設定する</h3><p>XGの左ペインメニューから<mark class=\"label primary\">ネットワーク</mark>を選び、<mark class=\"label primary\">DNS</mark>をクリックします。IPv6の項目があり、初期設定ではスタティックの設定となっています。HGWの<mark class=\"label primary\">fe80:</mark>からはじまるリンクローカルアドレス、またはホームゲートウェイのパブリックIPアドレスが指定されているはずです。HGWのDNS改ざん攻撃などもあるようですし、私はプロバイダのDNSのIPアドレスを調べ、それを手動でXGに設定しています。なお、DNSv4もプロバイダのDNSを指定される事をお勧めします。実運用としてプロバイダのDNSのIPアドレスは殆ど変更される事がありません。</p>\n<img src=\"/new-technology/2020/04/25/xg-ipv6-1/update3.png\" class=\"\" title=\"alt\">\n\n<p>設定が環境と合っているか診断を行います。XGの左ペインメニューから<mark class=\"label primary\">診断</mark>を選んでください。<mark class=\"label primary\">名前参照</mark>から、<mark class=\"label primary\">DNSサーバーIP</mark>を<mark class=\"label primary\">すべての設定済みサーバーを使用して参照</mark>を選択し、<mark class=\"label primary\">名前参照</mark>をクリックしてください。</p>\n <img src=\"/new-technology/2020/04/25/xg-ipv6-1/diag.png\" class=\"\" title=\"alt\">\n\n<p>正常な場合は以下の通り、設定したIPv4とIPv6のDNSでipv6.google.comの名前解決をした結果と計測時間を表示します。</p>\n <img src=\"/new-technology/2020/04/25/xg-ipv6-1/diag2.png\" class=\"\" title=\"alt\">\n\n<p>診断結果がうまくいかない場合は、先のDNS設定と、HGWからのIP配布方法などの設定をいくつか試してみてください。</p>\n","categories":["Security"],"tags":["XG Firewall","IPv6"]},{"title":"Sophos FirewallでIPv6の設定を行う（後半）","url":"/new-technology/2020/04/29/xg-ipv6-2/","content":"<p class=\"onepoint\">この記事で実現すること</p>\nSophos Firewall配下のクライアントにIPv6アドレスを配布し、IPv6インターネットに接続します。また、SSL/TLSインスペクションを設定します。\n\n<span id=\"more\"></span>\n\n<h2 id=\"XGのIPv6\"><a href=\"#XGのIPv6\" class=\"headerlink\" title=\"XGのIPv6\"></a>XGのIPv6</h2><p>IPv6は一般的に内部のホストに対してもパブリックIPアドレスを割り当てます。IPv6独自の工夫として、端末を特定されないために一時アドレスを割り当てます。一時アドレスは端末再起動時に変更され、外部からホストの特定を防ぐ目的があります。IPv4の枯渇が課題だったがために、到達性と安全面を考慮した設計と推察されます。</p>\n<p>一方、Sophos FirewallのIPv6の考え方としてはNATを前提にします。内部ホストから外部に出ていくものはSNAT（Source NAT）、公開するホストはDNAT（Destination NAT）で外部から内部ホストに転送するという原則があります。LAN側のIPv6にはプライベートIPの考え方に近い、ユニークローカルアドレス（ULA）を用います。</p>\n<p>ULAは、プライベート環境で自由に割り当てして良いというわけではなく、なるべく世界の中で一意にすべきという考え方です。企業向けとしては合併などがあった場合に重複しない事を前提としています。<code>192.168.1.0/24</code>のように、誰でも使って良いアドレスとは異なるのがIPv6のULAです。このULAは一定のルールに従い機械的に生成する必要があります。</p>\n<h2 id=\"XGのIPv6を構成するまで\"><a href=\"#XGのIPv6を構成するまで\" class=\"headerlink\" title=\"XGのIPv6を構成するまで\"></a>XGのIPv6を構成するまで</h2><p>以下の流れでXGのIPv6をセットアップします。</p>\n<ol>\n<li>ULAを生成</li>\n<li>XGのLAN側のIPアドレスにULAを設定</li>\n<li>LAN側ホストにIPv6を割り当てるためのDHCPv6、ルーターアドバタイズメント（RA）の設定</li>\n<li>Firewallルールの設定</li>\n<li>固定IPv6アドレスの登録</li>\n<li>SSL&#x2F;TLSインスペクションの設定</li>\n</ol>\n<h3 id=\"ULAを生成する\"><a href=\"#ULAを生成する\" class=\"headerlink\" title=\"ULAを生成する\"></a>ULAを生成する</h3><p>ULAの生成にはネットワークカードのMACアドレスが必要です。仮想環境で構築している方は仮想MACアドレスではなく、可能な限り衝突を避けるべく、物理マシンのMACアドレスを使ってください。</p>\n<p>物理マシンに直接Firewallをインストールしている方は、Sophos Firewallの左ペインメニューの<mark class=\"label primary\">ネットワーク</mark>から<mark class=\"label primary\">インターフェース</mark>の”Port1(LAN)”を選択し、<mark class=\"label primary\">詳細設定</mark>をクリックするとMACアドレスが確認出来ます。</p>\n<img src=\"/new-technology/2020/04/29/xg-ipv6-2/mac1.png\" class=\"\" title=\"alt\">\n\n<p>仮想環境の場合、ESXiを例に挙げると、以下のようにLAN側物理MACアドレス（当方の環境では、vmnic1）にMACアドレスがあります。</p>\n<img src=\"/new-technology/2020/04/29/xg-ipv6-2/mac2.png\" class=\"\" title=\"alt\">\n\n<p>ULAの生成は以下の通り過去記事にありますので、上記MACアドレスをコピーし、過去記事「<a href=\"/new-technology/2020/04/18/ipv6/\" title=\"IPv6のUnique Local Addressを生成する\">IPv6のUnique Local Addressを生成する</a>」を参考にULAを求めて下さい。<br>結果として、以下のような情報が得られるので、First IPv6 Addressの<code>fd</code>から始まるULAを控えてください。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">First IPv6 Address-&gt; fd00:beef:cafe::1/64</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"LAN側にULAを設定\"><a href=\"#LAN側にULAを設定\" class=\"headerlink\" title=\"LAN側にULAを設定\"></a>LAN側にULAを設定</h3><p>XGの左ペインメニューの<mark class=\"label primary\">ネットワーク</mark>の<mark class=\"label primary\">インターフェース</mark>にある、<mark class=\"label primary\">IPv6設定</mark>のチェックボックスをチェックします。次に、<mark class=\"label primary\">IPv6　プレフィックス</mark>の項目に生成したULAを貼り付け、<code>/64</code>の部分を削除してください。画面を見てもらえると解りますが、IPv6のサブネット<mark class=\"label primary\">/64</mark>は画面上で固定表示されています。</p>\n<img src=\"/new-technology/2020/04/29/xg-ipv6-2/ula1.png\" class=\"\" title=\"alt\">\n\n<p>このアドレス体系は以下の通りです。</p>\n<ol>\n<li>IPv6の体系は128ビットで、ユニキャストアドレスは1つのセグメントが64ビットとなります。XGでも64ビットで扱います。</li>\n<li>48ビットのULAに16ビットの内部サブネット<code>0000</code>を加え、64ビットプレフィックスを定義しています。別のサブネットにするのであれば、ここを<code>0001</code>などとしていきます<sup><b><a href=\"#note1\">[1]</a></b></sup>。</li>\n<li>IPv6における、デフォルトルーターは、リンクローカルアドレスの1とするのが一般的です（<code>fe00::1</code>）。これに倣い、XG自身のIPv6アドレスの後半64ビットのインターフェース識別子は<code>0000:0000:0000:0001</code>としています。</li>\n<li><code>::</code>は、IPv6アドレスの<code>0000</code>が続く部分を省略できるものです。（例）<code>fd00:beef:cafe:0000:0000:0000:0000:0001/64</code>の連続する<code>0</code>部分を省略し、<code>fd00:beef:cafe::1/64</code>としています。</li>\n</ol>\n<p>保存ボタンをクリックし、LAN側のインタフェースにIPv6を割り当てます。</p>\n<h3 id=\"RAおよびDHCPv6の設定\"><a href=\"#RAおよびDHCPv6の設定\" class=\"headerlink\" title=\"RAおよびDHCPv6の設定\"></a>RAおよびDHCPv6の設定</h3><h4 id=\"DHCPv6の設定\"><a href=\"#DHCPv6の設定\" class=\"headerlink\" title=\"DHCPv6の設定\"></a>DHCPv6の設定</h4><p>クライアントにIPv6のアドレスを配布します。SSL&#x2F;TLSインスペクションが行えるクライアントは固定IP範囲を明示的に割り当てます。XGの左ペインメニューから<mark class=\"label primary\">ネットワーク</mark>、<mark class=\"label primary\">DHCP</mark>と進み、<mark class=\"label primary\">サーバー</mark>の”追加”ボタンをクリックします。次にIPv6のタブをクリックし、以下の画面の通り入力していきます。</p>\n<img src=\"/new-technology/2020/04/29/xg-ipv6-2/dhcp.png\" class=\"\" title=\"alt\">\n\n<ul>\n<li>DHCPの<mark class=\"label primary\">名前</mark>は、IPv6のDHCPと分かるよう命名してください。</li>\n<li><mark class=\"label primary\">インターフェース</mark>は\"Port1\"を選択してください。すでに割り当てられているFirewallのIPv6アドレスが表示されます。</li>\n<li><mark class=\"label primary\">ダイナミックIPリース</mark>は、自動割り当てするIPv6アドレスの範囲を入力します。IPv4は10進数で表示する事が多いですが、IPv6は16進で表示する事になるので、ログを見た時に解りやすいIPアドレス体系となるような構成にされる事をお勧めします。</li>\n<li><mark class=\"label primary\">スタティックIPのDUIDマッピング</mark>は後ほど入力します。一旦は空のままにしておいてください。</li>\n<li><mark class=\"label primary\">DNSサーバー</mark>は、FirewallのLAN側IPv6アドレスを指定して下さい。内部ホストの名前解決のために必要です。</li>\n</ul>\n<h4 id=\"RAの設定\"><a href=\"#RAの設定\" class=\"headerlink\" title=\"RAの設定\"></a>RAの設定</h4><p> クライアントにDNSの通知を行うため、RAの設定を行います。DHCPで明示的にIPv6アドレスを指定しないクライアントはRAにより自身のIPv6アドレスを自動生成しつつ、ゲートウェイ、DNSの情報を受け取ります。RAでは、マネージドフラグ（Mフラグ）、アザーフラグ（Oフラグ）という言葉が登場します。</p>\n<ul>\n<li><strong>Mフラグ</strong>　DHCPv6によって明示的に割り当てたステートフルなIPv6アドレス（ON）にする（※IPv4のDHCPと同じ）か、RAによってPrefixが通知され、クライアントは自分のMACアドレスから生成するステートレスIPアドレスにする（OFF）かを決めます</li>\n<li><strong>Oフラグ</strong>　IPアドレス以外の情報をDHCPv6サーバやRAから取得する（ON）、取得せず手動設定（OFF）</li>\n</ul>\n<p>IPv6において最近のトレンドとしては、DHCPv6を使わずRAのみとする（Mフラグ＝OFF、Oフラグ＝ON）が定番です。長いIPv6アドレスの管理は大変なので、この設定が一番楽な管理方法です。しかし、私のXGに関する記事ではSSL&#x2F;TLSインスペクションを最も重要視しています。MACアドレスをベースにクライアントでIPv6アドレスが生成されると、FirewallでCA証明書が登録されている端末か否かの判断が行えません。よってMフラグ＝ONとし、FirewallがIPv6アドレスを管理する、ステートフルなIPv6アドレスとする必要があります。OフラグがOFFの場合はDNSの情報は手動設定であり、ステートフルなプロトコルを受け付け出来ないという解釈です。</p>\n<p>Sophos Firewallでの結論としては、<strong>ステートフルなDHCPv6で全てを管理するため、Mフラグ＝ON、Oフラグ＝ONとなります</strong>。やや管理者寄りの理論です<sup><b><a href=\"#note2\">[2]</a></b></sup>。また、IPv6では上述した通り、一時IPv6アドレスというものが存在します（XG上では自律）。これを認めると、クライアントが再起動の度にIPアドレスが変わり、SSL&#x2F;TLSインスペクションを迂回されてしまいますからこの一時アドレスの設定もOFFにします。XGの左ペインメニューの<mark class=\"label primary\">ネットワーク</mark>から、<mark class=\"label primary\">IPv6ルーターアドバタイズ</mark>を選択し、”追加”ボタンをクリックし、以下の図のように登録していきます。</p>\n<img src=\"/new-technology/2020/04/29/xg-ipv6-2/ra1.png\" class=\"\" title=\"alt\">\n\n<ul>\n<li><mark class=\"label primary\">インターフェース</mark>は、\"Port1\"を選択します</li>\n<li><mark class=\"label primary\">マネージドフラグ</mark>にチェックします</li>\n<li><mark class=\"label primary\">アザーフラグ</mark>にチェックします</li>\n<li><mark class=\"label primary\">デフォルトゲートウェイ</mark>にチェックします</li>\n<li><mark class=\"label primary\">アドバタイズ設定のプレフィックス</mark>の<mark class=\"label primary\">プレフィックス</mark>には、今回作成した、ULA（例）`fd00.beef.cafe::`を入力します。また、一時アドレスは使わないので<mark class=\"label primary\">自律</mark>のチェックを外します</li>\n<li>保存をクリックし、設定を完了させます</li>\n</ul>\n<p>この段階でクライアントのIPを取り直すと、IPv6に関してはULAが１つだけ割り振られているはずです。</p>\n<h2 id=\"ファイアウォールルール設定\"><a href=\"#ファイアウォールルール設定\" class=\"headerlink\" title=\"ファイアウォールルール設定\"></a>ファイアウォールルール設定</h2><p>ここまでの設定で、クライアントはIPv6アドレスが割り振られています。インターネットにIPv6で接続するためには、Firewallルールの設定が必要となります。XGの左ペインメニューの<mark class=\"label primary\">ルールとポリシー</mark>で”IPv6”をクリックします。</p>\n<img src=\"/new-technology/2020/04/29/xg-ipv6-2/rule1.png\" class=\"\" title=\"alt\">\n\n<h3 id=\"ファイアウォールルールの追加\"><a href=\"#ファイアウォールルールの追加\" class=\"headerlink\" title=\"ファイアウォールルールの追加\"></a>ファイアウォールルールの追加</h3><mark class=\"label primary\">ファイアウォールルールの追加</mark>から<mark class=\"label primary\">新しいファイアウォールルール</mark>をクリックします。\n<p>ここでの設定内容は、「<a href=\"/new-technology/2020/03/14/rule-policy2/\" title=\"XG Firewall v18のルールを作成する\">XG Firewall v18のルールを作成する</a>」でIPv4について設定した内容と変わりません。”To Internet”というルールを作りましたが、同じ内容になります。</p>\n<ul>\n<li>ルール名はここでは”To_Internet_IPv6”とします。</li>\n<li>送信元ゾーンには、”LAN”を設定します。VPNを使う方は”VPN”も加えてください。宛先ゾーンは”WAN”を指定します。</li>\n<li>IPv4でもリンクNATは使いませんでしたが、IPv6においても利用しません。</li>\n</ul>\n<p>セキュリティの”Webフィルタリング”をクリックし、詳細メニューをオープンします。</p>\n<ul>\n<li>Webポリシーは”Default Policy”を選択します（任意）</li>\n<li>“HTTPおよび復号化したHTTPSをスキャン”をチェックします</li>\n<li>“FTPのマルウェアをスキャン”をチェックします</li>\n<li>QUICプロトコルのブロックは任意選択です<br>  Googleのサービスで利用されています。私はチェックしています。Google自体は問題ないですがそのプロトコルを利用した悪質なサイトがFirewallを回避するリスクを減らすという意味で選択しています</li>\n<li>その他のセキュリティ機能でアプリケーションコントロールを選択します<br>  私は”Block very high risk(Risk Level 5) apps”を選択しています</li>\n<li>IPSは”lantowan_general”を選択します</li>\n<li>保存ボタンをクリックします</li>\n</ul>\n<h3 id=\"NATルールの設定\"><a href=\"#NATルールの設定\" class=\"headerlink\" title=\"NATルールの設定\"></a>NATルールの設定</h3><mark class=\"label primary\">ルールとポリシー</mark>の<mark class=\"label primary\">NATルール</mark>から\"IPv6\"をクリックします。ここでは、既にIPv6の自動設定された情報が\"Default SNAT IPv6\"という名前で登録されています。ルールを開いて、<mark class=\"label primary\">ルールのステータス</mark>のトグルスイッチをOnにしてください。最後に\"保存\"をクリックしてください。この段階ではSSL/TLSインスペクションの設定は出来ていませんが、IPv6で接続可能な状態になっています。\n\n<p>テストのために、<code>ipv6.google.com</code>が正しく表示出来るか確認してください。</p>\n<h2 id=\"固定IPアドレスの登録\"><a href=\"#固定IPアドレスの登録\" class=\"headerlink\" title=\"固定IPアドレスの登録\"></a>固定IPアドレスの登録</h2><p>端末にルート証明書を導入できる端末（Windows、macOS、Linux、iOS）に対してSSL&#x2F;TLSインスペクションを行いますので、DHCPv6では、該当端末が常に固定のIPv6アドレスを持つための設定を行います。XGの左ペインの<mark class=\"label primary\">ネットワーク</mark>の<mark class=\"label primary\">DHCP</mark>から、”IPv6リース”の状況をみると、実際にIPv6のアドレスが割り当てられている一覧が確認できます。ここの”DUID”が端末固有情報であるため、この値を控えて、<strong>DHCPv6の設定にIPv6とDUIDのペアを登録していく事になります</strong>。ここでは、DUIDの値をメモしてください。残念ながら以下の通りDUIDの文字列が長すぎて、表記が見切れます。マウスをポイントしてポップアップされたDUIDをメモする必要があります。</p>\n<img src=\"/new-technology/2020/04/29/xg-ipv6-2/dhcp1.png\" class=\"\" title=\"alt\">\n\n<p>再び、DHCPの設定画面で、<mark class=\"label primary\">IPv6 DHCP Server</mark>を選択します。以下のように、<mark class=\"label primary\">スタティックIPのDUIDマッピング</mark>の項目にDUIDとIPv6のセットを登録してください。</p>\n<img src=\"/new-technology/2020/04/29/xg-ipv6-2/dhcp2.png\" class=\"\" title=\"alt\">\n\n<div class=\"note warning no-icon\"><p>SSLインスペクションでは、IPアドレスの範囲を明確に設定し、IoTなどSSL&#x2F;TLSインスペクション対象外の端末が含まれないように注意してください。</p>\n</div>\n\n<h2 id=\"SSL-x2F-TLSインスペクションの設定\"><a href=\"#SSL-x2F-TLSインスペクションの設定\" class=\"headerlink\" title=\"SSL&#x2F;TLSインスペクションの設定\"></a>SSL&#x2F;TLSインスペクションの設定</h2><p>IPv6のSSL&#x2F;TLSインスペクションの設定を行います。まずは、IPv4で対応した時と同じように、SSL&#x2F;TLSインスペクションの対象範囲のIPホストを登録します。XGの左ペインメニューの<mark class=\"label primary\">ホストとサービス</mark>から、<mark class=\"label primary\">IPホスト</mark>のタブで、<mark class=\"label primary\">追加</mark>ボタンをクリックします。</p>\n<img src=\"/new-technology/2020/04/29/xg-ipv6-2/host.png\" class=\"\" title=\"alt\">\n\n<p>上記の通り、SSL&#x2F;TLSインスペクションのためのIPv6の範囲を”CA_Client_IPv6”として登録します。16進数のアドレス表記ですが、ここでもIPv4のアドレス体系に合わせておくと、ログを確認した時の視認性が上がります。続いて、XGの左ペインメニューの<mark class=\"label primary\">ルールとポリシー</mark>から<mark class=\"label primary\">SSL/TLSインスペクションルール</mark>に進み、”IPv6”をクリックします。「<a href=\"/new-technology/2020/03/20/ssl-inspection1/\" title=\"XG Firewall v18のSSL&#x2F;TLSインスペクションの設定\">XG Firewall v18のSSL&#x2F;TLSインスペクションの設定</a>」で、このSSL&#x2F;TLSインスペクションルールを一度作成しています。ここにIPv6の設定を加える事になります。</p>\n<img src=\"/new-technology/2020/04/29/xg-ipv6-2/rule2.png\" class=\"\" title=\"alt\">\n\n<p>上記のように、<mark class=\"label primary\">送信元ネットワークとデバイス</mark>に、今回作成した、IPv6のホスト群である、”CA_Client_IPv6”を選択して追加します。</p>\n<p>これでIPv6に関する設定は完了です。IPv6についても、SSL&#x2F;TLSインスペクションの対象となり、IPSなど多くのコンテンツフィルタが可能となりました。一度IPv4でXGのルート証明書を端末にインストールしてあれば、再度インストールする必要はありません。SSL&#x2F;TLSインスペクションのための端末へのインストールについては、「<a href=\"/new-technology/2020/03/20/ssl-inspection1/\" title=\"XG Firewall v18のSSL&#x2F;TLSインスペクションの設定\">XG Firewall v18のSSL&#x2F;TLSインスペクションの設定</a>」を参照してください。</p>\n<h2 id=\"動作確認\"><a href=\"#動作確認\" class=\"headerlink\" title=\"動作確認\"></a>動作確認</h2><p>IPv6サイトをブラウザ等で閲覧後、XGのログのログビューアを開き、プルダウンから、<mark class=\"label primary\">SSL/TLSインスペクション</mark>を選択します。</p>\n<img src=\"/new-technology/2020/04/29/xg-ipv6-2/rule3.png\" class=\"\" title=\"alt\">\n\n<p>上記の通り、同じホストでもIPv4とIPv6の通信が混在している事、またSSL&#x2F;TLSインスペクションの対象&#x2F;対象外についてもログの内容を見て確認できます。</p>\n<p><small id=\"note1\"><strong>[1]</strong><br>ULAの48ビットに対するネットワークアドレスとして（例）<code>fd00:beef:cafe:0000</code>を使うため、業務上実際に使う64ビットプリフィックスは（例）<code>fd00:beef:cafe:0001::/64</code>から開始するのが一般的です。今回はホームユーザー向けの一例として出来るだけ簡素化する事を目的とし、短い文字列で済むようにサブネットに<code>0000</code>を設定にしています。そういう私も自分の環境では、Prefixの後半16ビットは<code>0001</code>以降の数字を使っています。</small></p>\n<p><small id=\"note2\"><strong>[2]</strong><br>DHCPv6とRAの戦いというものがあって、RA派は合理化を目指す方向です。ネットワーク管理者がIPアドレスの管理をすべきでサーバー管理者がやるべきでないという論調です。DHCPv6派はクライアントが勝手にアドレスを決めるのは困るという理論です。Sophosには頑張ってもらって、もう少し簡単に証明書が入っている端末を区別できるように期待したいところです。</small></p>\n","categories":["Security"],"tags":["XG Firewall","IPv6"]},{"title":"XG Firewall VPNにスマホから接続する","url":"/new-technology/2020/03/31/vpn-iphone/","content":"<p class=\"onepoint\">この記事で実現すること</p>\nスマホ（iPhone、Android）からXG FirewallのVPNに接続できます。2要素認証の設定も可能です。\n\n<span id=\"more\"></span>\n\n<h2 id=\"事前準備\"><a href=\"#事前準備\" class=\"headerlink\" title=\"事前準備\"></a>事前準備</h2><p>前回の記事でPC（WindowsおよびmacOS）からXGの<mark class=\"label primary\">VPN（Sophos Connect）</mark>に2要素認証で安全に接続できるようになりました。ここでは、スマホからVPNへ接続できるように設定していきます。この記事では、XG側に一通りVPNの設定が終わっている事を前提としています。以下の記事を参考にしてください。</p>\n<ul>\n<li><a href=\"/new-technology/2020/03/28/vpn/\" title=\"XG Firewall VPNについて\">XG Firewall VPNについて</a></li>\n<li><a href=\"/new-technology/2020/03/28/vpnotp/\" title=\"XG Firewall VPNに2要素認証を設定する\">XG Firewall VPNに2要素認証を設定する</a></li>\n</ul>\n<p>前提条件は以下の通りです。なお、この記事では、ワンタイムパスワードを必ず必須とはしていません。PCとは異なり、移動しながら使うスマホは毎回ワンタイムパスワードを入力するのでは利便性に欠けます。ここは利便性とセキュリティの安全面を比較し判断という事になります。</p>\n<ul>\n<li>XGにVPN(Sophos Connect)の設定を終えている</li>\n<li>XGの外側（インターネット側）にホームゲートウェイがあり、ホームゲートウェイからXGに対し必要なVPNのパケットを転送出来ている</li>\n</ul>\n<h2 id=\"iOS-iPhone-、AndroidのVPN設定\"><a href=\"#iOS-iPhone-、AndroidのVPN設定\" class=\"headerlink\" title=\"iOS(iPhone)、AndroidのVPN設定\"></a>iOS(iPhone)、AndroidのVPN設定</h2><h3 id=\"iOSの設定\"><a href=\"#iOSの設定\" class=\"headerlink\" title=\"iOSの設定\"></a>iOSの設定</h3><p>LAN環境にて、XGのユーザーポータル<code>https://XGのIPアドレス/</code>に接続します。ユーザーポータルには、前回までに作成したVPNユーザーでログインします。ポータルのログイン後には、以下の画面のように、iPhone（iOS）のIPSec VPNに必要な設定ファイルをダウンロードできるようになっています。</p>\n<img src=\"/new-technology/2020/03/31/vpn-iphone/iphone.png\" class=\"\" title=\"alt\">\n\n<div class=\"note warning\"><p>ダウンロードした設定ファイルは一部修正が必要ですので、PCでダウンロードしファイルを修正の後、iOSにインストールする事をお勧めします。</p>\n</div>\n\n<p>ファイルをダウンロードしたらメモ帳やテキストエディットなどで設定ファイルを開きます。以下はファイルの先頭からの抜粋ですが、11行目にXGのWAN側のIPアドレスが記載されている行があります。内容は以下の通りです。</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">plist</span> <span class=\"attr\">version</span>=<span class=\"string\">&quot;1.0&quot;</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">dict</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">key</span>&gt;</span>PayloadContent<span class=\"tag\">&lt;/<span class=\"name\">key</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">array</span>&gt;</span></span><br><span class=\"line\">                <span class=\"tag\">&lt;<span class=\"name\">dict</span>&gt;</span></span><br><span class=\"line\">                        <span class=\"tag\">&lt;<span class=\"name\">key</span>&gt;</span>IPSec<span class=\"tag\">&lt;/<span class=\"name\">key</span>&gt;</span></span><br><span class=\"line\">                        <span class=\"tag\">&lt;<span class=\"name\">dict</span>&gt;</span></span><br><span class=\"line\">                                <span class=\"tag\">&lt;<span class=\"name\">key</span>&gt;</span>AuthenticationMethod<span class=\"tag\">&lt;/<span class=\"name\">key</span>&gt;</span></span><br><span class=\"line\">                                <span class=\"tag\">&lt;<span class=\"name\">string</span>&gt;</span>SharedSecret<span class=\"tag\">&lt;/<span class=\"name\">string</span>&gt;</span></span><br><span class=\"line\">                                <span class=\"tag\">&lt;<span class=\"name\">key</span>&gt;</span>RemoteAddress<span class=\"tag\">&lt;/<span class=\"name\">key</span>&gt;</span></span><br><span class=\"line\">                                <span class=\"tag\">&lt;<span class=\"name\">string</span>&gt;</span>192.168.x.x<span class=\"tag\">&lt;/<span class=\"name\">string</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>上記のIPアドレスをXGで設定してあるダイナミックDNSのホスト名に書き換えます（Sophos社が提供しているダイナミックDNSであれば、xxxx.myfirewall.coです）。その後、ファイルを保存し、iCloudまたはメールなどでiPhoneに転送し、iPhoneから設定ファイルをインストールします。macOSだとFinderからファイルを選んでAirDropでiPhoneに送信すると簡単ですね。iPhoneではプロファイルのインストール時には、最初にiPhoneのパスワードを求められますのでiPhoneのパスワードを入力します。次にXGの接続ユーザーのパスワードを求められますが、ここはワンタイムパスワードの有無で設定が異なります。前回の記事ではワンタイムパスワードが必要なユーザーを作成しましたが、ワンタイムパスワードが不要であれば、ワンタイムパスワードを使わないユーザーを改めて作成してください。</p>\n<p>以下の場合は、XGの接続ユーザーのパスワードを入力します。</p>\n<ul>\n<li>ワンタイムパスワードは利用しない</li>\n<li>iPhoneにパスワードを記憶させたい</li>\n</ul>\n<p>以下の場合は、パスワードを入力せずプロファイルのインストールを完了させます。</p>\n<ul>\n<li>ワンタイムパスワードを利用する</li>\n<li>iPhoneにパスワードを記憶させたくない</li>\n</ul>\n<h4 id=\"（2021-4-7更新）v18-MR-4での不具合について\"><a href=\"#（2021-4-7更新）v18-MR-4での不具合について\" class=\"headerlink\" title=\"（2021-4-7更新）v18 MR-4での不具合について\"></a>（2021-4-7更新）v18 MR-4での不具合について</h4><p>v18 MR-4では不具合により、上記設定ファイルがダウンロードできない状況でした。このケースに遭遇した場合はVPNのプロファイルを使わずに手動設定できます。なお、v18 MR-5ではこの不具合は解消されています。</p>\n<ol>\n<li>iOSの設定から<mark class=\"label primary\">VPN</mark>を選択します</li>\n<li><mark class=\"label primary\">VPN構成を追加...</mark>をタップします</li>\n<li>以下のパラメータを入力し、完了をタップします。</li>\n</ol>\n<table>\n<thead>\n<tr>\n<th>説明</th>\n<th>内容</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>タイプ</td>\n<td><mark class=\"label primary\">IPSec</mark>を選択します</td>\n</tr>\n<tr>\n<td>サーバー</td>\n<td>xxx.myfirewall.coなどのダイナミックDNSのホスト名を入力します</td>\n</tr>\n<tr>\n<td>アカウント</td>\n<td>VPNで接続するユーザーIDを入力します</td>\n</tr>\n<tr>\n<td>シークレット</td>\n<td>XGで設定した共有鍵を入力します</td>\n</tr>\n</tbody></table>\n<h3 id=\"iOS-iPhone-からVPNに接続\"><a href=\"#iOS-iPhone-からVPNに接続\" class=\"headerlink\" title=\"iOS(iPhone)からVPNに接続\"></a>iOS(iPhone)からVPNに接続</h3><p>iPhoneの設定アプリからVPNを選択、XGの接続先が選択されている状態で<mark class=\"label primary\">状況</mark>のトグルスイッチをオンにします。パスワードが設定済みの方は短い時間でXGへの接続が完了します。ワンタイムパスワードを設定している方、或いはパスワードを記憶させていない方は、パスワード入力のポップアップが表示されます。ワンタイムパスワードは、パスワードのあと続けてワンタイムパスワードの6つの数字を続けて入力します。一旦ポップアップが表示されると他のアプリに切り替えられないので一旦キャンセルします。ワンタイムパスワードアプリで6桁の数字を記憶するかコピーするなどし、最大30秒以内で設定アプリに再度切り替え、VPNのパスワードを完成させ接続する事になります。</p>\n<h3 id=\"Androidの設定\"><a href=\"#Androidの設定\" class=\"headerlink\" title=\"Androidの設定\"></a>Androidの設定</h3><p>AndroidからVPNに接続する場合は、以下の設定を行います。今回の実例はAndroidのバージョン9のタブレットで説明します。機種によって操作は異なるかとおもいますが、ご容赦ください。無線とネットワーク→VPN→<mark class=\"label primary\">VPNネットワークの追加</mark>をタップします。</p>\n<table>\n<thead>\n<tr>\n<th>説明</th>\n<th>内容</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>名前</td>\n<td>接続名を入力します</td>\n</tr>\n<tr>\n<td>タイプ</td>\n<td><mark class=\"label primary\">IPSec Xauth PSK</mark>を選択します</td>\n</tr>\n<tr>\n<td>サーバー</td>\n<td>xxx.myfirewall.coなどのダイナミックDNSのホスト名を入力します</td>\n</tr>\n<tr>\n<td>IPSec ID</td>\n<td>空白のままで構いません</td>\n</tr>\n<tr>\n<td>IPSec事前共有鍵</td>\n<td>XGで設定した共有鍵を入力します</td>\n</tr>\n</tbody></table>\n<img src=\"/new-technology/2020/03/31/vpn-iphone/android.png\" class=\"\" title=\"alt\">\n\n<h3 id=\"AndroidからVPNに接続\"><a href=\"#AndroidからVPNに接続\" class=\"headerlink\" title=\"AndroidからVPNに接続\"></a>AndroidからVPNに接続</h3><mark class=\"label primary\">設定</mark>から<mark class=\"label primary\">無線とネットワーク</mark>に進みVPNを選択し、ユーザーIDとパスワードを入力し接続します。ワンタイムパスワードを利用する場合は、パスワードの後ろにワンタイムパスワード（6桁の数字）を続けて入力します。\n\n<p>Androidに関しては1点、注意点があります。Androidは、SSLインスペクションについて、Chromeブラウザ以外のアプリからは使えない前提があります。そこで、Android専用のVPNユーザーを作成しSSLインスペクションの対象からAndroidユーザーを除外するなどの設定が必要となります。</p>\n<h2 id=\"2要素認証の有無による使い分け\"><a href=\"#2要素認証の有無による使い分け\" class=\"headerlink\" title=\"2要素認証の有無による使い分け\"></a>2要素認証の有無による使い分け</h2><p>私はVPN接続ユーザーを2つ有効にしています。2要素認証が必要なユーザーはLANへのアクセスを許可するもの、2要素認証を不要としているユーザーはLANおよびHGWのセグメントへのアクセスを不許可とするルールを作成しています。またVPNからXGの管理画面には接続できないようにもしています。</p>\n","categories":["Security","VPN","ワンタイムパスワード"],"tags":["XG Firewall"]},{"title":"XG Firewall v18 MR3の更新","url":"/new-technology/2020/10/25/xg-v18-mr3/","content":"<img src=\"/new-technology/2020/10/25/xg-v18-mr3/XG.png\" class=\"\" title=\"alt\">\n\n<h2 id=\"XG-Firewall-v18-MR-3\"><a href=\"#XG-Firewall-v18-MR-3\" class=\"headerlink\" title=\"XG Firewall v18 MR-3\"></a>XG Firewall v18 MR-3</h2><p>XG Firewall v18のMR-3が2020年10月12日に発表されました。変更点について記載します。なお、XG Firewallの最新パッチについては、「<a href=\"/new-technology/2020/10/11/esxi-backup/\" title=\"VMware ESXiの仮想マシンをバックアップする\">VMware ESXiの仮想マシンをバックアップする</a>」の関連リンクを参照してください。</p>\n<span id=\"more\"></span>\n\n<h2 id=\"主なエンハンスの内容\"><a href=\"#主なエンハンスの内容\" class=\"headerlink\" title=\"主なエンハンスの内容\"></a>主なエンハンスの内容</h2><ul>\n<li>セキュリティ強化<br>機密情報の暗号化が行われました。これに伴い、新たにセキュア・ストレージ・マスターキーというものを作成する必要があります。また次回のアップデートでも暗号化される項目は追加されるとの事です。</li>\n<li>SSL VPNの強化。トラフィック転送量が増加し、WindowsクライアントにSSL VPNが対応しました。</li>\n<li>その他の不具合の修正</li>\n</ul>\n<h3 id=\"XGのアップデート\"><a href=\"#XGのアップデート\" class=\"headerlink\" title=\"XGのアップデート\"></a>XGのアップデート</h3><p>XGのv17からのアップデートは、 v17.5 MR13&#x2F; MR14&#x2F; MR14-1が対象となっています。XGのv18であればMR-3へのアップデートは可能です。<br>XGの管理画面にログイン後、左ペインメニューの<mark class=\"label primary\">バックアップ＆ファームウェア</mark>の<mark class=\"label primary\">ファームウェアの確認</mark>ではただちに全てのユーザーにアップデートの案内が来るわけでは無いようなので、アップデートにはMySophosにログインし、バージョンアップの差分モジュールをダウンロードします。</p>\n<p>(2020-12-22 追記)<br>XG v18 MR-3はMR-4の発表によりダウンロードできなくなりました。最新パッチについては、「<a href=\"/new-technology/2020/12/17/xg-v18-mr4/\" title=\"XG Firewall v18 MR4の更新\">XG Firewall v18 MR4の更新</a>」を参照してください。MR-3で導入されたセキュア・ストレージ・マスターキーはMR-4でも引き続き設定が必要なものですので、この記事については残しておきます。</p>\n<ol>\n<li>Sophosのサイトの右上のメニューから、<mark class=\"label primary\">マイアカウント</mark>をクリックします。</li>\n<li>Sophos IDをお持ちでなければIDを作成します。</li>\n<li>ログイン後、<mark class=\"label primary\">My Sophos</mark>のリンクをクリックし、さらに画面左側の<mark class=\"label primary\">Network Protection</mark>をクリックします。</li>\n<li><mark class=\"label primary\">ファームウェアの更新</mark>をクリックします。</li>\n<li>「製品名&#x2F;OSを使った検索」で”ファイアーウォール”を選択し、その後現れるプルダウンは”ソフトウェア”を選択します。</li>\n<li><mark class=\"label primary\">選択可能なダウンロードを表示</mark>ボタンをクリックします。</li>\n</ol>\n<img src=\"/new-technology/2020/10/25/xg-v18-mr3/mysophos.png\" class=\"\" title=\"alt\">\n\n<ol start=\"7\">\n<li>上記画面で”SW-18.0.3_MR-3.SFW-457.sig”というアップデータが表示されますのでダウンロードします。</li>\n<li>MY Sophosはここで終了し、XGの管理画面にログインし、左ペインメニューの<mark class=\"label primary\">バックアップ＆ファームウェア</mark>の<mark class=\"label primary\">ファームウェアのタブメニュー</mark>から、以下の画面に赤丸で囲った矢印のアイコンをクリックし、ダウンロードしたモジュールをアップロードします。</li>\n</ol>\n<img src=\"/new-technology/2020/10/25/xg-v18-mr3/verup.png\" class=\"\" title=\"alt\">\n\n<p>アップロード＆再起動ボタンをクリックし、MR-3へのアップグレードを完了させます。</p>\n<div class=\"note info no-icon\"><p>仮想環境（ESXi）上にXGをインストールされている方はアップグレードの前に、「<a href=\"/new-technology/2020/10/11/esxi-backup/\" title=\"VMware ESXiの仮想マシンをバックアップする\">VMware ESXiの仮想マシンをバックアップする</a>」を参考に、XGのバックアップを確保される事をお勧めします。</p>\n</div>\n\n<h2 id=\"セキュア・ストレージ・マスターキー\"><a href=\"#セキュア・ストレージ・マスターキー\" class=\"headerlink\" title=\"セキュア・ストレージ・マスターキー\"></a>セキュア・ストレージ・マスターキー</h2><p>XGが再起動し、ログイン後、新たに追加されたセキュア・ストレージ・マスターキーの作成を求められます。</p>\n<img src=\"/new-technology/2020/10/25/xg-v18-mr3/key1.png\" class=\"\" title=\"alt\">\n\n<p>以下の通り、最低12文字で、大文字・小文字・記号を含める必要があります。</p>\n<img src=\"/new-technology/2020/10/25/xg-v18-mr3/key2.png\" class=\"\" title=\"alt\">\n\n<p>登録を終えると、マスターキーがセットされたとのメッセージが表示されて対応は完了です。</p>\n<img src=\"/new-technology/2020/10/25/xg-v18-mr3/key3.png\" class=\"\" title=\"alt\">\n\n<p>マスターキーの情報は「<a href=\"/new-technology/2020/08/30/bitwarden/\" title=\"パスワード管理ソフトのbitwardenを活用する\">パスワード管理ソフトのbitwardenを活用する</a>」を参考に、暗号化された安全な場所へ保管されることをお勧めします。</p>\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"XG Firewall v18 MR5の更新","url":"/new-technology/2021/04/07/xg-v18-mr5/","content":"<img src=\"/new-technology/2021/04/07/xg-v18-mr5/XG.png\" class=\"\" title=\"alt\">\n\n<h2 id=\"XG-Firewall-v18-MR-5\"><a href=\"#XG-Firewall-v18-MR-5\" class=\"headerlink\" title=\"XG Firewall v18 MR-5\"></a>XG Firewall v18 MR-5</h2><p>2021年4月28日に、v18-MR5のbuild586が発表されています。なお、XG Firewallの最新パッチについては、「<a href=\"/new-technology/2020/10/11/esxi-backup/\" title=\"VMware ESXiの仮想マシンをバックアップする\">VMware ESXiの仮想マシンをバックアップする</a>」の関連リンクを参照してください。</p>\n<span id=\"more\"></span>\n\n<h2 id=\"主なエンハンスの内容\"><a href=\"#主なエンハンスの内容\" class=\"headerlink\" title=\"主なエンハンスの内容\"></a>主なエンハンスの内容</h2><h3 id=\"VPNの新機能\"><a href=\"#VPNの新機能\" class=\"headerlink\" title=\"VPNの新機能\"></a>VPNの新機能</h3><ul>\n<li>同時IPSecVPNトンネル容量の大幅な50%の増加</li>\n<li>ソフォス接続v2.1経由のリモートアクセスのためのIPSecプロビジョニングファイルのサポート（Windows）</li>\n</ul>\n<h3 id=\"証明書の管理とセキュリティ\"><a href=\"#証明書の管理とセキュリティ\" class=\"headerlink\" title=\"証明書の管理とセキュリティ\"></a>証明書の管理とセキュリティ</h3><ul>\n<li>秘密キーのセキュリティ強化</li>\n<li>PEM形式証明書のアップロード&#x2F;ダウンロードのサポート</li>\n</ul>\n<p>その他、Sophos Central Firewallレポーティングの強化、50項目以上の不具合修正があります。また、build586では、SNMPとIPSecVPNに関する細かな不具合が修正されています。</p>\n<blockquote>\n<p><a href=\"https://community.sophos.com/sophos-xg-firewall/b/blog/posts/sophos-xg-firewall-v18-mr5--build-586-is-now-available\">https://community.sophos.com/sophos-xg-firewall/b/blog/posts/sophos-xg-firewall-v18-mr5--build-586-is-now-available</a></p>\n</blockquote>\n<blockquote>\n<p><strong>Upgrade as soon as possible</strong></p>\n</blockquote>\n<blockquote>\n<p>While we always encourage you to keep your firewalls up to date with the latest firmware, over the next few months we are recommending you rapidly apply maintenance releases to ensure you have all the important security, performance, and feature enhancements applied as soon as possible.</p>\n</blockquote>\n<blockquote>\n<p>ファイアウォールを最新のファームウェアで最新の状態に保つことを常に推奨していますが、今後数ヶ月間は、重要なセキュリティ、パフォーマンス、機能強化のすべてを可能な限り早く適用できるように、メンテナンスリリースを迅速に適用することをお勧めします。</p>\n</blockquote>\n<h2 id=\"XGのアップデート\"><a href=\"#XGのアップデート\" class=\"headerlink\" title=\"XGのアップデート\"></a>XGのアップデート</h2><p>XGのv17からのアップデートは、 v17.5 MR6以降から可能です。XGのv18であればMR-5へのアップデートは可能です。<br>XGの管理画面にログイン後、左ペインメニューの<mark class=\"label primary\">バックアップ＆ファームウェア</mark>の<mark class=\"label primary\">ファームウェアの確認</mark>ではただちに全てのユーザーにアップデートの案内が来るわけでは無いようなので、アップデートにはMySophosにログインし、バージョンアップの差分モジュールをダウンロードします。</p>\n<ol>\n<li>Sophosのサイトの右上のプルダウンメニューから、<mark class=\"label primary\">ライセンスポータル</mark>をクリックします。</li>\n<li>Sophos IDをお持ちでなければIDを作成します。</li>\n<li>ログイン後、<mark class=\"label primary\">Network Protection</mark>をクリックします。</li>\n<li><mark class=\"label primary\">ファームウェアの更新</mark>をクリックします。</li>\n<li>「製品名&#x2F;OSを使った検索」で”ファイアーウォール”を選択し、その後現れるプルダウンは”ソフトウェア”を選択します。</li>\n<li><mark class=\"label primary\">選択可能なダウンロードを表示</mark>ボタンをクリックします。</li>\n</ol>\n<img src=\"/new-technology/2021/04/07/xg-v18-mr5/mysophos.png\" class=\"\" width=\"640\" title=\"alt\">\n\n<ol start=\"7\">\n<li>上記画面で”SW-18.0.5_MR-5.SFW-586.sig”というアップデータが表示されますのでダウンロードします。</li>\n<li>MY Sophosはここで終了してXGの管理画面にログインし、左ペインメニューの<mark class=\"label primary\">バックアップ＆ファームウェア</mark>の<mark class=\"label primary\">ファームウェアのタブメニュー</mark>から以下の画面に赤丸で囲った矢印のアイコンをクリックし、ダウンロードしたモジュールをアップロードします。</li>\n</ol>\n<img src=\"/new-technology/2021/04/07/xg-v18-mr5/verup.png\" class=\"\" title=\"alt\">\n\n<p>アップロード＆再起動ボタンをクリックし、MR-5へのアップグレードを完了させます。</p>\n<div class=\"note info\"><p>仮想環境（ESXi）上にXGをインストールされている方はアップグレードの前に、「<a href=\"/new-technology/2020/10/11/esxi-backup/\" title=\"VMware ESXiの仮想マシンをバックアップする\">VMware ESXiの仮想マシンをバックアップする</a>」を参考に、XGのバックアップを確保される事をお勧めします。</p>\n</div>\n\n<h2 id=\"IPSec-VPNのiOSの構成ファイル\"><a href=\"#IPSec-VPNのiOSの構成ファイル\" class=\"headerlink\" title=\"IPSec VPNのiOSの構成ファイル\"></a>IPSec VPNのiOSの構成ファイル</h2><p>v18のMR4で気づいた、IPSec VPNのiOSの構成ファイルのダウンロード（ユーザーポータル画面からダウンロード）ができなくなっていた件は、今回のバージョンで修正された事を確認しました。サポートから連絡のあった、NC-64758という不具合番号も今回の解消リストに含まれています。<br>修正されたissueは以下を参照してください。</p>\n<blockquote>\n<p><a href=\"https://docs.sophos.com/releasenotes/index.html?productGroupID=nsg&amp;productID=xg&amp;versionID=18.0\">https://docs.sophos.com/releasenotes/index.html?productGroupID=nsg&amp;productID=xg&amp;versionID=18.0</a></p>\n</blockquote>\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"XG Firewall v18 MR4の更新","url":"/new-technology/2020/12/17/xg-v18-mr4/","content":"<img src=\"/new-technology/2020/12/17/xg-v18-mr4/XG.png\" class=\"\" title=\"alt\">\n\n<h2 id=\"XG-Firewall-v18-MR-4\"><a href=\"#XG-Firewall-v18-MR-4\" class=\"headerlink\" title=\"XG Firewall v18 MR-4\"></a>XG Firewall v18 MR-4</h2><p>XG Firewall v18のMR-4が2020年12月15日に発表されました。なお、XG Firewallの最新パッチについては、「<a href=\"/new-technology/2020/10/11/esxi-backup/\" title=\"VMware ESXiの仮想マシンをバックアップする\">VMware ESXiの仮想マシンをバックアップする</a>」の関連リンクを参照してください。</p>\n<span id=\"more\"></span>\n\n<h2 id=\"主なエンハンスの内容\"><a href=\"#主なエンハンスの内容\" class=\"headerlink\" title=\"主なエンハンスの内容\"></a>主なエンハンスの内容</h2><ul>\n<li>セキュリティ強化</li>\n<li>IPSecリモートアクセス用の新しい高度なオプション（scadminの代用）。Sophos Connect VPNクライアントのダウンロードがユーザーポータルから可能に</li>\n<li>より強力なパスワードハッシュ - この重要な機能をフルに活用するため、アップグレードするときにパスワードを変更するように促されます</li>\n<li>ウェブフィルタリング - インターネット・ウォッチ・ファウンデーション（IWF)によって児童の性的虐待コンテンツを含むと特定されたウェブサイトは、ウェブフィルタリングが有効になっている場合、自動的にブロックされます。</li>\n</ul>\n<blockquote class=\"blockquote-center\">\n<p><strong>Upgrade as soon as possible</strong></p>\n<p>While we always encourage you to keep your firewalls up to date with the latest firmware, over the next few months we are recommending you rapidly apply maintenance releases to ensure you have all the important security, performance, and feature enhancements applied as soon as possible.</p>\n<p>ファイアウォールを最新のファームウェアで最新の状態に保つことを常に推奨していますが、今後数ヶ月間は、重要なセキュリティ、パフォーマンス、機能強化のすべてを可能な限り早く適用できるように、メンテナンスリリースを迅速に適用することをお勧めします。</p>\n\n</blockquote>\n\n<h2 id=\"XGのアップデート\"><a href=\"#XGのアップデート\" class=\"headerlink\" title=\"XGのアップデート\"></a>XGのアップデート</h2><p>XGのv17からのアップデートは、 v17.5 MR6以降から可能です。XGのv18であればMR-4へのアップデートは可能です。<br>XGの管理画面にログイン後、左ペインメニューの<mark class=\"label primary\">バックアップ＆ファームウェア</mark>の<mark class=\"label primary\">ファームウェアの確認</mark>ではただちに全てのユーザーにアップデートの案内が来るわけでは無いようなので、アップデートにはMySophosにログインし、バージョンアップの差分モジュールをダウンロードします。</p>\n<ol>\n<li>Sophosのサイトの右上のプルダウンメニューから、<mark class=\"label primary\">ライセンスポータル</mark>をクリックします。</li>\n<li>Sophos IDをお持ちでなければIDを作成します。</li>\n<li>ログイン後、<mark class=\"label primary\">Network Protection</mark>をクリックします。</li>\n<li><mark class=\"label primary\">ファームウェアの更新</mark>をクリックします。</li>\n<li>「製品名&#x2F;OSを使った検索」で”ファイアーウォール”を選択し、その後現れるプルダウンは”ソフトウェア”を選択します。</li>\n<li><mark class=\"label primary\">選択可能なダウンロードを表示</mark>ボタンをクリックします。</li>\n</ol>\n<img src=\"/new-technology/2020/12/17/xg-v18-mr4/mysophos.png\" class=\"\" width=\"640\" title=\"alt\">\n\n<ol start=\"7\">\n<li>上記画面で”SW-18.0.4_MR-4.SFW-506.sig”というアップデータが表示されますのでダウンロードします。</li>\n<li>MY Sophosはここで終了してXGの管理画面にログインし、左ペインメニューの<mark class=\"label primary\">バックアップ＆ファームウェア</mark>の<mark class=\"label primary\">ファームウェアのタブメニュー</mark>から以下の画面に赤丸で囲った矢印のアイコンをクリックし、ダウンロードしたモジュールをアップロードします。</li>\n</ol>\n<img src=\"/new-technology/2020/12/17/xg-v18-mr4/verup.png\" class=\"\" title=\"alt\">\n\n<p>アップロード＆再起動ボタンをクリックし、MR-4へのアップグレードを完了させます。</p>\n<h3 id=\"MR-4で注意する点\"><a href=\"#MR-4で注意する点\" class=\"headerlink\" title=\"MR-4で注意する点\"></a>MR-4で注意する点</h3><p>XGv18のいつのバージョンからか気付きませんでしたが、IPSec VPNのiOSの構成ファイルのダウンロード（ユーザーポータル画面からダウンロード）ができなくなっていました。今回のバージョンではVPNについて、scadmin（IPSec構成ファイル作成ツール）を使わず構成ファイルが作成できるような感じでしたので早速検証したところ、「Install」ボタンをクリックすると再びユーザーポータルのログインページに飛ばされてしまいファイルをダウンロードする事すらできなくなっていました（MR-5では修正されています）。</p>\n<p>幸いにも、iOSからIPSec VPNでXG Firewallに接続する方法は、代替策があるのでVPN構成ファイルをダウンロードせずとも対応は可能です。<br>「<a href=\"/new-technology/2020/03/31/vpn-iphone/\" title=\"XG Firewall VPNにスマホから接続する\">XG Firewall VPNにスマホから接続する</a>」の記事については代替策について追記しておきました。</p>\n<p>（2021-1-2追記）v18 MR4にアップデートしてからXGのアラート通知が来ていない事に気がつきました。MR4では、左ペインメニューの<mark class=\"label primary\">管理</mark>の<mark class=\"label primary\">通知の設定</mark>画面で「証明書」という項目が追加されており、プルダウンから証明書を選択するようになっています。gmailのような外部メールを利用して通知するケースでは、証明書に”Application Certificate”を選択してください。「<a href=\"/new-technology/2020/04/03/Notifications/\" title=\"XG Firewallの通知設定を行う\">XG Firewallの通知設定を行う</a>」にも追記しています。</p>\n<div class=\"note info\"><p>仮想環境（ESXi）上にXGをインストールされている方はアップグレードの前に、「<a href=\"/new-technology/2020/10/11/esxi-backup/\" title=\"VMware ESXiの仮想マシンをバックアップする\">VMware ESXiの仮想マシンをバックアップする</a>」を参考に、XGのバックアップを確保される事をお勧めします。</p>\n</div>\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"XG Firewall v18.5 MR1の更新","url":"/new-technology/2021/08/15/xg-v185-mr1/","content":"<img src=\"/new-technology/2021/08/15/xg-v185-mr1/XG.png\" class=\"\" title=\"alt\">\n\n<h2 id=\"XG-Firewall-v18-5-MR-1\"><a href=\"#XG-Firewall-v18-5-MR-1\" class=\"headerlink\" title=\"XG Firewall v18.5 MR-1\"></a>XG Firewall v18.5 MR-1</h2><p>XG Firewall v18.5 MR1が2021年8月9日に発表されました。主としてTLSインスペクションの高速化が行われています。これまでv18を利用してきたユーザーは今後発表されるであろうv18 MR-6以降へのアップデート、或いは、今回のv18.5へのアップデートとを選択する事になるようです。なお、XG Firewallの最新パッチについては、「<a href=\"/new-technology/2020/10/11/esxi-backup/\" title=\"VMware ESXiの仮想マシンをバックアップする\">VMware ESXiの仮想マシンをバックアップする</a>」の関連リンクを参照してください。</p>\n<span id=\"more\"></span>\n\n<h2 id=\"主なエンハンスの内容\"><a href=\"#主なエンハンスの内容\" class=\"headerlink\" title=\"主なエンハンスの内容\"></a>主なエンハンスの内容</h2><ul>\n<li>DPI モードでの TLS トラフィックのネットワーク パフォーマンスの向上など、v18.5 GA に含まれるパフォーマンスの向上の恩恵を受けることができます。</li>\n<li>ソフォス DDNS (myfirewall.com) は廃止され、新しい登録はサポートされなくなります。2022年1月31日から予定されています。詳細については、<strong>KBA-41764</strong>を参照してください。<blockquote>\n<p><a href=\"https://support.sophos.com/support/s/article/KB-000041764?language=en_US&amp;c__displayLanguage=ja\">https://support.sophos.com/support/s/article/KB-000041764?language=en_US&amp;c__displayLanguage=ja</a></p>\n</blockquote>\n</li>\n</ul>\n<p>なお、XGのメニューには <mark class=\"label primary\">ゼロデイ対策</mark>という項目が加えられていますが、個別のサブスクリプションライセンスが必要です。</p>\n<p>v18.5 MR-1の詳細な説明はSophos Communityを参照してください。可能な限り迅速にアップグレードするように推奨されています。</p>\n<blockquote>\n<p><a href=\"https://community.sophos.com/sophos-xg-firewall/b/blog/posts/sophos-firewall-v18-5-mr1-is-now-available\">https://community.sophos.com/sophos-xg-firewall/b/blog/posts/sophos-firewall-v18-5-mr1-is-now-available</a></p>\n</blockquote>\n<blockquote>\n<p><strong>Upgrade as soon as possible</strong></p>\n</blockquote>\n<blockquote>\n<p>While we always encourage you to keep your firewalls up to date with the latest firmware, over the next few months we are recommending you rapidly apply maintenance releases to ensure you have all the important security, performance, and feature enhancements applied as soon as possible.</p>\n</blockquote>\n<blockquote>\n<p>ファイアウォールを最新のファームウェアで最新の状態に保つことを常に推奨していますが、今後数ヶ月間は、重要なセキュリティ、パフォーマンス、機能強化のすべてを可能な限り早く適用できるように、メンテナンスリリースを迅速に適用することをお勧めします。</p>\n</blockquote>\n<h2 id=\"XGのアップデート\"><a href=\"#XGのアップデート\" class=\"headerlink\" title=\"XGのアップデート\"></a>XGのアップデート</h2><p>XGのv17からのアップデートは、 v17.5 MR14以降から可能です。XGv18はMR-3以降から可能です。<br>XGの管理画面にログイン後、左ペインメニューの<mark class=\"label primary\">バックアップ＆ファームウェア</mark>の<mark class=\"label primary\">ファームウェアの確認</mark>ではただちに全てのユーザーにアップデートの案内が来るわけでは無いようなので、アップデートにはMySophosにログインし、バージョンアップの差分モジュールをダウンロードします。</p>\n<ol>\n<li>Sophosのサイトの右上のプルダウンメニューから、<mark class=\"label primary\">ライセンスとアカウント</mark>をクリックします。<blockquote>\n<p><a href=\"https://www.sophos.com/ja-jp.aspx\">https://www.sophos.com/ja-jp.aspx</a></p>\n</blockquote>\n</li>\n<li>Sophos IDをお持ちでなければIDを作成します。</li>\n<li>ログイン後、<mark class=\"label primary\">Network Protection</mark>をクリックします。</li>\n<li><mark class=\"label primary\">ファームウェアの更新</mark>をクリックします。</li>\n<li>「製品名&#x2F;OSを使った検索」で”ファイアーウォール”を選択し、その後現れるプルダウンは”ソフトウェア”を選択します。</li>\n<li><mark class=\"label primary\">選択可能なダウンロードを表示</mark>ボタンをクリックします。</li>\n</ol>\n<img src=\"/new-technology/2021/08/15/xg-v185-mr1/mysophos.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<ol start=\"7\">\n<li>上記画面で”SFOS 18.5.1 MR1-Build326”というアップデータが表示されますのでダウンロードします。</li>\n<li>MY Sophosはここで終了してXGの管理画面にログインし、左ペインメニューの<mark class=\"label primary\">バックアップ＆ファームウェア</mark>の<mark class=\"label primary\">ファームウェアのタブメニュー</mark>から以下の画面に赤丸で囲った矢印のアイコンをクリックし、ダウンロードしたモジュールをアップロードします。</li>\n</ol>\n<img src=\"/new-technology/2021/08/15/xg-v185-mr1/verup.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<p>アップロード＆再起動ボタンをクリックし、v18.5へのアップグレードを完了させます。</p>\n<img src=\"/new-technology/2021/08/15/xg-v185-mr1/upgrade.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<h2 id=\"SophosダイナミックDNSの提供終了\"><a href=\"#SophosダイナミックDNSの提供終了\" class=\"headerlink\" title=\"SophosダイナミックDNSの提供終了\"></a>SophosダイナミックDNSの提供終了</h2><p>残念ながらmyfirewall.coのDDNSは2022年1月末をもってサービス提供終了となります。また、このv18.5から新たに”myfirewall.co”でDDNSを新規登録できないようになっています。一旦myfirewall.coのDDNSを削除してしまうと追加できない事になります。代替のDDNSは以下の通りです。</p>\n<ul>\n<li>DynDNS</li>\n<li>ZoneEdit</li>\n<li>EasyDNS</li>\n<li>DynAccess</li>\n<li>No-IP</li>\n<li>DNS-O-Matic</li>\n<li>Google DNS</li>\n<li>Namecheap</li>\n<li>FreeDNS</li>\n</ul>\n<img src=\"/new-technology/2021/08/15/xg-v185-mr1/ddns.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<p>No-IPの無償ユーザーで確認してみましたが定期的にDNSの更新が行われています。No-IPの無償ユーザーは毎月ユーザーが実際にNo-IPのサイトにログインして利用継続を確認する必要があります。XGのVPN(IP-Sec,SSL-VPN)については設定ファイルのホスト名を修正できます。例えばNASをお持ちの方であればDDNSが提供されているケースもあり、NASのメーカーが提供するDDNS名に置き換え、XG上のDDNSは使わないという方法もあります。</p>\n<h2 id=\"TLS-x2F-SSLインスペクションのパフォーマンス\"><a href=\"#TLS-x2F-SSLインスペクションのパフォーマンス\" class=\"headerlink\" title=\"TLS&#x2F;SSLインスペクションのパフォーマンス\"></a>TLS&#x2F;SSLインスペクションのパフォーマンス</h2><p>体感的には通販サイトなど細かな画像ファイルが多く読み込まれるケースで高速化したかな？と感じてはいます。SSLインスペクション、IPS、アプリケーションフィルタ、Webフィルタを有効にした状態で下記のスループットとなっており、十分高速ではあります。</p>\n<p>ネット回線： auひかり5Gbps</p>\n<ul>\n<li>XGのマシンスペック： Core i7メモリ16Gbyte</li>\n<li>仮想環境： ESXi6.7</li>\n<li>ネットワークカード： intel X550-T2</li>\n<li>クライアントPC： CeleronG3900という5年前の一般的なクライアントに5GbpsのNIC(Aquantia AQtion 5G Network Adapter)を組み込んだもの</li>\n</ul>\n<img src=\"/new-technology/2021/08/15/xg-v185-mr1/pc-speedtest.png\" class=\"\" width=\"360\" title=\"alt\">\n\n<ul>\n<li>iPhone11(iOS14.7.1)、Wi-Fi6(11ax)</li>\n</ul>\n<img src=\"/new-technology/2021/08/15/xg-v185-mr1/ios-speedtest.png\" class=\"\" width=\"360\" title=\"alt\">\n\n\n<div class=\"note info\"><p>仮想環境（ESXi）上にXGをインストールされている方はアップグレードの前に、「<a href=\"/new-technology/2020/10/11/esxi-backup/\" title=\"VMware ESXiの仮想マシンをバックアップする\">VMware ESXiの仮想マシンをバックアップする</a>」を参考に、XGのバックアップを確保される事をお勧めします。</p>\n</div>","categories":["Security"],"tags":["XG Firewall"]},{"title":"Sophos Firewall v18.5 MR-2","url":"/new-technology/2021/12/11/xg-v185-mr2/","content":"<img src=\"/new-technology/2021/12/11/xg-v185-mr2/title.png\" class=\"\" title=\"alt\">\n\n<h2 id=\"Sophos-Firewall-v18-5-MR-2\"><a href=\"#Sophos-Firewall-v18-5-MR-2\" class=\"headerlink\" title=\"Sophos Firewall v18.5 MR-2\"></a>Sophos Firewall v18.5 MR-2</h2><p>Sophos Firewall v18.5 MR2が2021年11月29日に発表されました。主としては不具合の解消がメインです。adminユーザーは2要素認証の設定が可能になりました。なお、XG Firewallの最新パッチについては、「<a href=\"/new-technology/2020/10/11/esxi-backup/\" title=\"VMware ESXiの仮想マシンをバックアップする\">VMware ESXiの仮想マシンをバックアップする</a>」の関連リンクを参照してください。</p>\n<span id=\"more\"></span>\n\n<h2 id=\"主なエンハンスの内容\"><a href=\"#主なエンハンスの内容\" class=\"headerlink\" title=\"主なエンハンスの内容\"></a>主なエンハンスの内容</h2><ul>\n<li>IPSec VPNの高速化</li>\n<li>Sophos Assistant ファイアウォール設定支援ガイドの提供</li>\n<li>adminユーザーの2要素認証</li>\n<li>DDNSでCloudflareのサポート</li>\n<li>画面応答の高速化（JQueryのバージョンを3.5にアップデート）</li>\n<li>100以上の問題の解決</li>\n</ul>\n<p>v18.5 MR-2の詳細な説明はSophos Communityを参照してください。可能な限り迅速にアップグレードするように推奨されています。</p>\n<blockquote>\n<p><a href=\"https://community.sophos.com/sophos-xg-firewall/b/blog/posts/sophos-firewall-v18-5-mr2-is-now-available\">https://community.sophos.com/sophos-xg-firewall/b/blog/posts/sophos-firewall-v18-5-mr2-is-now-available</a></p>\n</blockquote>\n<blockquote>\n<p>We encourage all customers to update their firewall to the latest firmware release to take advantage of these new features, ensure their firewall is performing optimally, and is best protected with the latest security enhancements.</p>\n</blockquote>\n<blockquote>\n<p>これらの新機能を利用し、ファイアウォールが最適なパフォーマンスを発揮し、最新のセキュリティ強化で最善の保護を受けられるよう、すべてのお客様に最新のファームウェアリリースに更新することをお勧めします。</p>\n</blockquote>\n<h2 id=\"Sophos-Firewallのアップデート\"><a href=\"#Sophos-Firewallのアップデート\" class=\"headerlink\" title=\"Sophos Firewallのアップデート\"></a>Sophos Firewallのアップデート</h2><p>XGの管理画面にログイン後、左ペインメニューの<mark class=\"label primary\">バックアップ＆ファームウェア</mark>の<mark class=\"label primary\">ファームウェアの確認</mark>ではただちに全てのユーザーにアップデートの案内が来るわけでは無いようなので、アップデートにはMySophosにログインし、バージョンアップの差分モジュールをダウンロードします。</p>\n<ol>\n<li>Sophosのサイトの右上のプルダウンメニューから、<mark class=\"label primary\">ライセンスとアカウント</mark>をクリックします。<blockquote>\n<p><a href=\"https://www.sophos.com/ja-jp.aspx\">https://www.sophos.com/ja-jp.aspx</a></p>\n</blockquote>\n</li>\n<li>Sophos IDをお持ちでなければIDを作成します。</li>\n<li>ログイン後、<mark class=\"label primary\">Network Protection</mark>をクリックします。</li>\n<li><mark class=\"label primary\">ファームウェアの更新</mark>をクリックします。</li>\n<li>「製品名&#x2F;OSを使った検索」で”ファイアーウォール”を選択し、その後現れるプルダウンは”ソフトウェア”を選択します。</li>\n<li><mark class=\"label primary\">選択可能なダウンロードを表示</mark>ボタンをクリックします。</li>\n</ol>\n<img src=\"/new-technology/2021/12/11/xg-v185-mr2/mysophos.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<ol start=\"7\">\n<li>上記画面で”SFOS 18.5.2 MR2-Build380”というアップデータが表示されますのでダウンロードします。</li>\n<li>MY Sophosはここで終了してXGの管理画面にログインし、左ペインメニューの<mark class=\"label primary\">バックアップ＆ファームウェア</mark>の<mark class=\"label primary\">ファームウェアのタブメニュー</mark>から以下の画面に赤丸で囲った矢印のアイコンをクリックし、ダウンロードしたモジュールをアップロードします。</li>\n</ol>\n<img src=\"/new-technology/2021/12/11/xg-v185-mr2/verup.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<p>アップロード＆再起動ボタンをクリックし、MR2へのアップグレードを完了させます。</p>\n<img src=\"/new-technology/2021/12/11/xg-v185-mr2/upgrade.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<div class=\"note info\"><p>仮想環境（ESXi）上にFirewallをインストールされている方はアップグレードの前に、「<a href=\"/new-technology/2020/10/11/esxi-backup/\" title=\"VMware ESXiの仮想マシンをバックアップする\">VMware ESXiの仮想マシンをバックアップする</a>」を参考に、バックアップを確保される事をお勧めします。</p>\n</div>","categories":["Security"],"tags":["XG Firewall"]},{"title":"Sophos Firewall v18.5 MR-3","url":"/new-technology/2022/03/25/xg-v185-mr3/","content":"<img src=\"/new-technology/2022/03/25/xg-v185-mr3/title.png\" class=\"\" title=\"alt\">\n\n<h2 id=\"Sophos-Firewall-v18-5-MR-3\"><a href=\"#Sophos-Firewall-v18-5-MR-3\" class=\"headerlink\" title=\"Sophos Firewall v18.5 MR-3\"></a>Sophos Firewall v18.5 MR-3</h2><p>Sophos Firewall v18.5 MR3が2022年3月24日に発表されました。主としては不具合の解消がメインです。また、v18.5を含みSophos Firewallの脆弱性の情報が提供されています。なお、XG Firewallの最新パッチについては、「<a href=\"/new-technology/2020/10/11/esxi-backup/\" title=\"VMware ESXiの仮想マシンをバックアップする\">VMware ESXiの仮想マシンをバックアップする</a>」の関連リンクを参照してください。</p>\n<span id=\"more\"></span>\n\n<h2 id=\"主なエンハンスの内容\"><a href=\"#主なエンハンスの内容\" class=\"headerlink\" title=\"主なエンハンスの内容\"></a>主なエンハンスの内容</h2><ul>\n<li>OpenSSL(CVE-2022-0778)のサービス拒否の脆弱性を修正</li>\n<li>いくつかの重要なセキュリティ、パフォーマンス、信頼性の向上</li>\n<li>Sophosアンチスパムインターフェースに更新された電子メール保護アンチスパムエンジン</li>\n</ul>\n<p>v18.5 MR-3の詳細な説明はSophos Communityを参照してください。出来るだけ早く適用するように推奨されています。</p>\n<blockquote>\n<p><a href=\"https://community.sophos.com/sophos-xg-firewall/b/blog/posts/sophos-firewall-v18-5-mr3-is-now-available\">https://community.sophos.com/sophos-xg-firewall/b/blog/posts/sophos-firewall-v18-5-mr3-is-now-available</a></p>\n</blockquote>\n<h2 id=\"Sophos-Firewallのアップデート\"><a href=\"#Sophos-Firewallのアップデート\" class=\"headerlink\" title=\"Sophos Firewallのアップデート\"></a>Sophos Firewallのアップデート</h2><p>XGの管理画面にログイン後、左ペインメニューの<mark class=\"label primary\">バックアップ＆ファームウェア</mark>の<mark class=\"label primary\">ファームウェアの確認</mark>ではただちに全てのユーザーにアップデートの案内が来るわけでは無いようなので、アップデートにはMySophosにログインし、バージョンアップの差分モジュールをダウンロードします。</p>\n<ol>\n<li>Sophosのサイトの右上のプルダウンメニューから、<mark class=\"label primary\">ライセンスとアカウント</mark>をクリックします。<blockquote>\n<p><a href=\"https://www.sophos.com/ja-jp.aspx\">https://www.sophos.com/ja-jp.aspx</a></p>\n</blockquote>\n</li>\n<li>Sophos IDをお持ちでなければIDを作成します。</li>\n<li>ログイン後、<mark class=\"label primary\">Network Protection</mark>をクリックします。</li>\n<li><mark class=\"label primary\">ファームウェアの更新</mark>をクリックします。</li>\n<li>「製品名&#x2F;OSを使った検索」で”ファイアーウォール”を選択し、その後現れるプルダウンは”ソフトウェア”を選択します。</li>\n<li><mark class=\"label primary\">選択可能なダウンロードを表示</mark>ボタンをクリックします。</li>\n</ol>\n<img src=\"/new-technology/2022/03/25/xg-v185-mr3/mysophos.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<ol start=\"7\">\n<li>上記画面で”SW-18.5.3_MR3-SFW-408”というアップデータが表示されますのでダウンロードします。</li>\n<li>MY Sophosはここで終了してXGの管理画面にログインし、左ペインメニューの<mark class=\"label primary\">バックアップ＆ファームウェア</mark>の<mark class=\"label primary\">ファームウェアのタブメニュー</mark>から以下の画面に赤丸で囲った矢印のアイコンをクリックし、ダウンロードしたモジュールをアップロードします。</li>\n</ol>\n<img src=\"/new-technology/2022/03/25/xg-v185-mr3/verup.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<p>アップロード＆再起動ボタンをクリックし、MR3へのアップグレードを完了させます。</p>\n<img src=\"/new-technology/2022/03/25/xg-v185-mr3/upgrade.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<div class=\"note info\"><p>仮想環境（ESXi）上にFirewallをインストールされている方はアップグレードの前に、「<a href=\"/new-technology/2020/10/11/esxi-backup/\" title=\"VMware ESXiの仮想マシンをバックアップする\">VMware ESXiの仮想マシンをバックアップする</a>」を参考に、バックアップを確保される事をお勧めします。</p>\n</div>\n\n<h2 id=\"Sophos-FirewallのCVE-2022-1040\"><a href=\"#Sophos-FirewallのCVE-2022-1040\" class=\"headerlink\" title=\"Sophos FirewallのCVE-2022-1040\"></a>Sophos FirewallのCVE-2022-1040</h2><p>Sophosからは、Resolved RCE in Sophos Firewallという記事で2022-03-25に発表されています。これは、リモートコード実行を可能にする認証バイパスの脆弱性であり、SophosファイアウォールのユーザーポータルとWebadminで影響を受けます。</p>\n<blockquote>\n<p>Sophos Resolved RCE in Sophos Firewall (CVE-2022-1040)<br> <a href=\"https://www.sophos.com/en-us/security-advisories/sophos-sa-20220325-sfos-rce\">https://www.sophos.com/en-us/security-advisories/sophos-sa-20220325-sfos-rce</a></p>\n</blockquote>\n<p>ただし、このブログで掲載している過去記事、「<a href=\"/new-technology/2020/06/24/protect-xg/\" title=\"XG Firewall自身を防御する\">XG Firewall自身を防御する</a>」で記載の通り、ローカルサービスACLにてWANからのWebadminおよびユーザーポータルからのアクセスが行えない状況にしてあれば、まず安全と言えます。Sophosではこういった脆弱性対策のためにHotFix機能を持っていて、速やかにパッチが自動更新されます。</p>\n<img src=\"/new-technology/2022/03/25/xg-v185-mr3/acl.png\" class=\"\" width=\"800\" title=\"alt\">\n<p>※SSL-VPNを利用されている方はWANの項目にチェックが入る事は問題ありません。</p>\n<img src=\"/new-technology/2022/03/25/xg-v185-mr3/hotfix.png\" class=\"\" width=\"640\" title=\"alt\">\n\n<h3 id=\"HotFixの確認\"><a href=\"#HotFixの確認\" class=\"headerlink\" title=\"HotFixの確認\"></a>HotFixの確認</h3><p>Firewall本体のコマンドコンソールにアクセスします。XG本体のコンソールまたは、ESXi上にインストールされている方はESXiのコンソールからFirewallのAdminのパスワードを入力し、ログインします。コマンドコンソールからは、<mark class=\"label primary\">5.Device Management</mark>を選択、さらに、<mark class=\"label primary\">3.Advanced Shell</mark>を選択します。そして以下のコマンドを実行します。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">SFVH_SO01_SFOS 18.5.3 MR-3-Build408#SFVUNL_SO01_SFOS 18.5.2 MR-2-Build380# test -f /static/up_mode_json_stamp &amp;&amp; echo &quot;Hotfix is applied&quot; || echo &quot;Hotfix isn&#x27;t applied&quot;</span><br><span class=\"line\">Hotfix is applied</span><br></pre></td></tr></table></figure>\n\n<p>上記のように”Hotfix is applied”と表示されればHotFixは適用済みです。isn’t appliedとでた場合はしばらく待つかSophosへのインターネットの接続性の確認が必要です。</p>\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"Sophos Firewall v19 MR-1","url":"/new-technology/2022/07/30/xg-v19-mr1/","content":"<img src=\"/new-technology/2022/07/30/xg-v19-mr1/title.png\" class=\"\" title=\"alt\">\n\n<h2 id=\"Sophos-Firewall-v19-MR-1\"><a href=\"#Sophos-Firewall-v19-MR-1\" class=\"headerlink\" title=\"Sophos Firewall v19 MR-1\"></a>Sophos Firewall v19 MR-1</h2><p>Sophos Firewall v19 MR-1が2022年7月25日に発表されました。ほとんと微修正で大きなエンハンスではなさそうです。</p>\n<span id=\"more\"></span>\n\n<h2 id=\"主なエンハンスの内容\"><a href=\"#主なエンハンスの内容\" class=\"headerlink\" title=\"主なエンハンスの内容\"></a>主なエンハンスの内容</h2><p>（8&#x2F;16更新）<br>V19 MR-1の再リリースということで、2022年8月15日に「Sophos Firewall OS v19 MR1 re-release (Build 365) is Now Available」の案内がありました。不具合の緊急対応も含まれるようです。</p>\n<ul>\n<li>マルウェアエンジンの64ビット対応</li>\n<li>Sophos Assistantオプトアウト機能</li>\n</ul>\n<p>v19の詳細な説明はRelease Note（英語）を参照してください。</p>\n<blockquote>\n<p><a href=\"https://docs.sophos.com/releasenotes/index.html?productGroupID=nsg&amp;productID=xg&amp;versionID=19.0\">https://docs.sophos.com/releasenotes/index.html?productGroupID=nsg&amp;productID=xg&amp;versionID=19.0</a></p>\n</blockquote>\n<h2 id=\"Sophos-Firewallのアップデート\"><a href=\"#Sophos-Firewallのアップデート\" class=\"headerlink\" title=\"Sophos Firewallのアップデート\"></a>Sophos Firewallのアップデート</h2><p>XGの管理画面にログイン後、左ペインメニューの<mark class=\"label primary\">バックアップ＆ファームウェア</mark>の<mark class=\"label primary\">ファームウェアの確認</mark>ではただちに全てのユーザーにアップデートの案内が来るわけでは無いので、アップデートにはMySophosにログインし、バージョンアップの差分モジュールをダウンロードします。</p>\n<ol>\n<li>Sophosのサイトの右上のプルダウンメニューから、<mark class=\"label primary\">ライセンスとアカウント</mark>をクリックします。<blockquote>\n<p><a href=\"https://www.sophos.com/ja-jp.aspx\">https://www.sophos.com/ja-jp.aspx</a></p>\n</blockquote>\n</li>\n<li>Sophos IDをお持ちでなければIDを作成します。</li>\n<li>ログイン後、<mark class=\"label primary\">Network Protection</mark>をクリックします。</li>\n<li><mark class=\"label primary\">ファームウェアの更新</mark>をクリックします。</li>\n<li>「製品名&#x2F;OSを使った検索」で”ファイアーウォール”を選択し、その後現れるプルダウンは”ソフトウェア”を選択します。</li>\n<li><mark class=\"label primary\">選択可能なダウンロードを表示</mark>ボタンをクリックします。</li>\n</ol>\n<img src=\"/new-technology/2022/07/30/xg-v19-mr1/mysophos.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<ol>\n<li>上記画面で”SW-19.0.1_MR-1.SFW-365.sig”というアップデータが表示されますのでダウンロードします。</li>\n<li>MY Sophosはここで終了してXGの管理画面にログインし、左ペインメニューの<mark class=\"label primary\">バックアップ＆ファームウェア</mark>の<mark class=\"label primary\">ファームウェアのタブメニュー</mark>から以下の画面に赤丸で囲った矢印のアイコンをクリックし、ダウンロードしたモジュールをアップロードします。</li>\n</ol>\n<img src=\"/new-technology/2022/07/30/xg-v19-mr1/verup.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<p>アップロード＆再起動ボタンをクリックし、v19 MR-1へのアップグレードを完了させます。</p>\n<img src=\"/new-technology/2022/07/30/xg-v19-mr1/upgrade.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<div class=\"note info\"><p>仮想環境（ESXi）上にFirewallをインストールされている方はアップグレードの前に、「<a href=\"/new-technology/2020/10/11/esxi-backup/\" title=\"VMware ESXiの仮想マシンをバックアップする\">VMware ESXiの仮想マシンをバックアップする</a>」を参考に、バックアップを確保される事をお勧めします。</p>\n</div>\n"},{"title":"Sophos Firewall v19","url":"/new-technology/2022/04/29/xg-v19/","content":"<img src=\"/new-technology/2022/04/29/xg-v19/title.png\" class=\"\" title=\"alt\">\n\n<h2 id=\"Sophos-Firewall-v19\"><a href=\"#Sophos-Firewall-v19\" class=\"headerlink\" title=\"Sophos Firewall v19\"></a>Sophos Firewall v19</h2><p>Sophos Firewall v19が2022年4月21日に発表されました。</p>\n<span id=\"more\"></span>\n\n<h2 id=\"主なエンハンスの内容\"><a href=\"#主なエンハンスの内容\" class=\"headerlink\" title=\"主なエンハンスの内容\"></a>主なエンハンスの内容</h2><ul>\n<li>SD-WAN（Software Defined-Wide Area Network）の強化</li>\n<li>IPSecに関する高速化（Xstream FastPath acceleration）</li>\n<li>SSLーVPNを含むVPNのエンハンス</li>\n<li>Sophos Assistant機能の追加</li>\n</ul>\n<p>v19の詳細な説明はSophos Communityを参照してください。</p>\n<blockquote>\n<p><a href=\"https://community.sophos.com/sophos-xg-firewall/b/blog/posts/sophos-firewall-os-v19-is-now-available\">https://community.sophos.com/sophos-xg-firewall/b/blog/posts/sophos-firewall-os-v19-is-now-available</a></p>\n</blockquote>\n<h2 id=\"Sophos-Firewallのアップデート\"><a href=\"#Sophos-Firewallのアップデート\" class=\"headerlink\" title=\"Sophos Firewallのアップデート\"></a>Sophos Firewallのアップデート</h2><p>XGの管理画面にログイン後、左ペインメニューの<mark class=\"label primary\">バックアップ＆ファームウェア</mark>の<mark class=\"label primary\">ファームウェアの確認</mark>ではただちに全てのユーザーにアップデートの案内が来るわけでは無いので、アップデートにはMySophosにログインし、バージョンアップの差分モジュールをダウンロードします。</p>\n<ol>\n<li>Sophosのサイトの右上のプルダウンメニューから、<mark class=\"label primary\">ライセンスとアカウント</mark>をクリックします。<blockquote>\n<p><a href=\"https://www.sophos.com/ja-jp.aspx\">https://www.sophos.com/ja-jp.aspx</a></p>\n</blockquote>\n</li>\n<li>Sophos IDをお持ちでなければIDを作成します。</li>\n<li>ログイン後、<mark class=\"label primary\">Network Protection</mark>をクリックします。</li>\n<li><mark class=\"label primary\">ファームウェアの更新</mark>をクリックします。</li>\n<li>「製品名&#x2F;OSを使った検索」で”ファイアーウォール”を選択し、その後現れるプルダウンは”ソフトウェア”を選択します。</li>\n<li><mark class=\"label primary\">選択可能なダウンロードを表示</mark>ボタンをクリックします。</li>\n</ol>\n<img src=\"/new-technology/2022/04/29/xg-v19/mysophos.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<ol>\n<li>上記画面で”SW-19.0.0_GA.SFW-317.sig”というアップデータが表示されますのでダウンロードします。</li>\n<li>MY Sophosはここで終了してXGの管理画面にログインし、左ペインメニューの<mark class=\"label primary\">バックアップ＆ファームウェア</mark>の<mark class=\"label primary\">ファームウェアのタブメニュー</mark>から以下の画面に赤丸で囲った矢印のアイコンをクリックし、ダウンロードしたモジュールをアップロードします。</li>\n</ol>\n<img src=\"/new-technology/2022/04/29/xg-v19/verup.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<p>アップロード＆再起動ボタンをクリックし、v19へのアップグレードを完了させます。</p>\n<img src=\"/new-technology/2022/04/29/xg-v19/upgrade.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<div class=\"note info\"><p>仮想環境（ESXi）上にFirewallをインストールされている方はアップグレードの前に、「<a href=\"/new-technology/2020/10/11/esxi-backup/\" title=\"VMware ESXiの仮想マシンをバックアップする\">VMware ESXiの仮想マシンをバックアップする</a>」を参考に、バックアップを確保される事をお勧めします。</p>\n</div>\n\n<h2 id=\"VPNの設定\"><a href=\"#VPNの設定\" class=\"headerlink\" title=\"VPNの設定\"></a>VPNの設定</h2><p>VPNも内部的にはバージョンアップはされていますが、ホームユーザーが利用するIPSec VPNやSSLーVPNについて設定ファイルの変更はなく、過去からの物がそのまま利用できます。どちらかといえば、企業向けのサービスとして、サイト間VPNの機能強化を主眼に置いたものになります。管理画面のメニューにおいても、<mark class=\"label primary\">リモートアクセスVPN</mark>と<mark class=\"label primary\">サイト間VPN</mark>とメニューが分かれるようになりました。</p>\n<h2 id=\"Sophos-Assistant\"><a href=\"#Sophos-Assistant\" class=\"headerlink\" title=\"Sophos Assistant\"></a>Sophos Assistant</h2><p>Sophos Assistantという管理画面操作のアシスタント機能が追加になりました。例えば、サーバーとしてインターネット側からの接続を受け入れる場合は、DNATという機能を使うことになりますが、以下のように「Full configuration: Create DNAT and firewall rules for web servers」という項目を選択すると、まず最初にWebサーバーのIPを定義するところから始めるように促してくれます。</p>\n<img src=\"/new-technology/2022/04/29/xg-v19/sa1.png\" class=\"\" width=\"640\" title=\"alt\">\n<img src=\"/new-technology/2022/04/29/xg-v19/sa2.png\" class=\"\" width=\"1024\" title=\"alt\">\n\n<p>ある程度わかっている人が久々に操作する時には役に立つ機能と思われます。時間があるときに色々調べてみると知らなかった機能など気づきがあるかもしれません。</p>\n<h2 id=\"Amazon-Virtual-Private-Cloud-Amazon-VPC-の対応\"><a href=\"#Amazon-Virtual-Private-Cloud-Amazon-VPC-の対応\" class=\"headerlink\" title=\"Amazon Virtual Private Cloud (Amazon VPC) の対応\"></a>Amazon Virtual Private Cloud (Amazon VPC) の対応</h2><p>v19より、AWSのプライベートクラウドに接続する機能が加わっています。自宅オンプレとAWSクラウドとをシームレスにネットワークを接続するハイブリッドクラウドに興味のある方はウォッチしてみてください。</p>\n<blockquote>\n<p>Amazon Web Services VPC support in SFOS v19<br> <a href=\"https://news.sophos.com/en-us/2022/04/07/amazon-web-services-vpc-support-in-sfos-v19/\">https://news.sophos.com/en-us/2022/04/07/amazon-web-services-vpc-support-in-sfos-v19/</a></p>\n</blockquote>\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"Sophos Firewall v19.5","url":"/new-technology/2022/12/03/xg-v195/","content":"<img src=\"/new-technology/2022/12/03/xg-v195/title.png\" class=\"\" title=\"alt\">\n\n<h2 id=\"Sophos-Firewall-v19-5\"><a href=\"#Sophos-Firewall-v19-5\" class=\"headerlink\" title=\"Sophos Firewall v19.5\"></a>Sophos Firewall v19.5</h2><p>Sophos Firewall v19.5が2022年11月16日に発表されました。</p>\n<span id=\"more\"></span>\n\n<h2 id=\"主なエンハンスの内容\"><a href=\"#主なエンハンスの内容\" class=\"headerlink\" title=\"主なエンハンスの内容\"></a>主なエンハンスの内容</h2><ul>\n<li>SD-WAN Load Balancingの強化</li>\n<li>OSPFv3 (IPv6)の対応</li>\n</ul>\n<p>ホームユーザーにはあまり関係しない機能でしょうか。</p>\n<p>v19.5の詳細な説明はSophos Communityを参照してください。</p>\n<blockquote>\n<p><a href=\"https://community.sophos.com/sophos-xg-firewall/b/blog/posts/sophos-firewall-v195-is-now-available\">https://community.sophos.com/sophos-xg-firewall/b/blog/posts/sophos-firewall-v195-is-now-available</a></p>\n</blockquote>\n<h2 id=\"Sophos-Firewallのアップデート\"><a href=\"#Sophos-Firewallのアップデート\" class=\"headerlink\" title=\"Sophos Firewallのアップデート\"></a>Sophos Firewallのアップデート</h2><p>XGの管理画面にログイン後、左ペインメニューの<mark class=\"label primary\">バックアップ＆ファームウェア</mark>の<mark class=\"label primary\">ファームウェアの確認</mark>ではただちに全てのユーザーにアップデートの案内が来るわけでは無いので、アップデートにはMySophosにログインし、バージョンアップの差分モジュールをダウンロードします。</p>\n<ol>\n<li>Sophosのサイトの右上のプルダウンメニューから、<mark class=\"label primary\">ライセンスとアカウント</mark>をクリックします。<blockquote>\n<p><a href=\"https://www.sophos.com/ja-jp.aspx\">https://www.sophos.com/ja-jp.aspx</a></p>\n</blockquote>\n</li>\n<li>Sophos IDをお持ちでなければIDを作成します。</li>\n<li>ログイン後、<mark class=\"label primary\">Network Protection</mark>をクリックします。</li>\n<li><mark class=\"label primary\">ファームウェアの更新</mark>をクリックします。</li>\n<li>「製品名&#x2F;OSを使った検索」で”ファイアーウォール”を選択し、その後現れるプルダウンは”ソフトウェア”を選択します。</li>\n<li><mark class=\"label primary\">選択可能なダウンロードを表示</mark>ボタンをクリックします。</li>\n</ol>\n<img src=\"/new-technology/2022/12/03/xg-v195/mysophos.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<ol>\n<li>上記画面で”SW-19.5.0_GA.SFW-197.sig”というアップデータが表示されますのでダウンロードします。</li>\n<li>MY Sophosはここで終了してXGの管理画面にログインし、左ペインメニューの<mark class=\"label primary\">バックアップ＆ファームウェア</mark>の<mark class=\"label primary\">ファームウェアのタブメニュー</mark>から以下の画面に赤丸で囲った矢印のアイコンをクリックし、ダウンロードしたモジュールをアップロードします。</li>\n</ol>\n\n\n<p>アップロード＆再起動ボタンをクリックし、v19.5へのアップグレードを完了させます。</p>\n\n\n<div class=\"note info\"><p>仮想環境（ESXi）上にFirewallをインストールされている方はアップグレードの前に、「<a href=\"/new-technology/2020/10/11/esxi-backup/\" title=\"VMware ESXiの仮想マシンをバックアップする\">VMware ESXiの仮想マシンをバックアップする</a>」を参考に、バックアップを確保される事をお勧めします。</p>\n</div>\n\n<p>Relase Notesを見るとセキュリティ観点ではOpenSSL (CVE-2022-1292)の脆弱性対応が行われています。他にもかなりの数の不具合が修正されていますが、コメントがサラッとしており、どういう事象なのかまでは判明しないものが多いようです。</p>\n<p>IPSec-VPN、SSL&#x2F;TLSインスペクション、マルウェアチェック（EICAR Testファイル）などを検証し、2週間程度運用していますが、スループット含めて特段の問題は見つかっていません。</p>\n<p>（2022-12-11追記）<br>SophosからSophos Firewallのv19以前の脆弱性について12-06にレポートが公開されています。<br>以下の脆弱性に対応したものであり、v19以前のユーザーはv19.5にアップグレードが必要との事です。<br>CVE-2022-3236<br>CVE-2022-3226<br>CVE-2022-3713<br>CVE-2022-3696<br>CVE-2022-3709<br>CVE-2022-3711<br>CVE-2022-3710</p>\n<blockquote>\n<p>Sophos Firewall v19.5 GA Resolves Security Vulnerabilities<br> <a href=\"https://www.sophos.com/en-us/security-advisories/sophos-sa-20221201-sfos-19-5-0\">https://www.sophos.com/en-us/security-advisories/sophos-sa-20221201-sfos-19-5-0</a></p>\n</blockquote>\n<p>大幅に機能が更新されていないにも関わらず、v19からv19.5となり、リリースノートでの表現も控え目で何が変わったのか良くわかりませんでしたが結局のところ脆弱性の対応が中心ということですね。</p>\n<p>私は「<a href=\"/new-technology/2020/06/24/protect-xg/\" title=\"XG Firewall自身を防御する\">XG Firewall自身を防御する</a>」の記事で、そもそもFirewall自身を守るためのセキュアな設定が必要と記載しており、パッチやバージョンアップを速やかに実施することも必要ですが、セキュアな環境のために追加の設定をお勧めしています。</p>\n<p>過去からの経緯を見ていると、v18で大きくアーキテクチャが変更になったものの、管理画面を中心とした機能は大きな変更が行われていません。過去からの脆弱性、特にUI周りのクロスサイトスクリプティング、およびDBアクセス機能におけるSQLインジェクションのサニタイズが不十分であり、指摘されては都度修正しているという活動を繰り返しているように見えます。<br>ユーザー側の自主的な防御として、余計な機能はインターネット向けには提供しない事をお勧めします。つまりSophos Firewallの管理画面や入力項目を持つユーザーポータルはLANからのアクセスのみに限定すべきで、WAN、DMZはもちろん、可能であればVPNからもアクセス不可にしておく事をお勧めします。今回のエンハンスでSQLインジェクションなどが全て撲滅されたかどうかは不明です。</p>\n<img src=\"/new-technology/2022/12/03/xg-v195/manage.png\" class=\"\" width=\"1024\" title=\"alt\">\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"Sophos Firewall v19.5 MR-1","url":"/new-technology/2023/02/23/xg-v195mr1/","content":"<img src=\"/new-technology/2023/02/23/xg-v195mr1/title.png\" class=\"\" title=\"alt\">\n\n<h2 id=\"Sophos-Firewall-v19-5-MR1\"><a href=\"#Sophos-Firewall-v19-5-MR1\" class=\"headerlink\" title=\"Sophos Firewall v19.5 MR1\"></a>Sophos Firewall v19.5 MR1</h2><p>Sophos Firewall v19.5 MR1が2023年2月15日に発表されました。</p>\n<span id=\"more\"></span>\n\n<h2 id=\"主なエンハンスの内容\"><a href=\"#主なエンハンスの内容\" class=\"headerlink\" title=\"主なエンハンスの内容\"></a>主なエンハンスの内容</h2><p>Home Editionとしてはバグフィックスのみで機能向上はなさそうです。新機能が無いのは少し寂しいですが、安定性はv19以降でかなり向上したと感じます。</p>\n<p>v19.5 MR1の詳細な説明はRelease Notesを参照してください。</p>\n<blockquote>\n<p><a href=\"https://docs.sophos.com/releasenotes/index.html?productGroupID=nsg&amp;productID=xg&amp;versionID=19.5\">https://docs.sophos.com/releasenotes/index.html?productGroupID=nsg&amp;productID=xg&amp;versionID=19.5</a></p>\n</blockquote>\n<h2 id=\"Sophos-Firewallのアップデート\"><a href=\"#Sophos-Firewallのアップデート\" class=\"headerlink\" title=\"Sophos Firewallのアップデート\"></a>Sophos Firewallのアップデート</h2><p>XGの管理画面にログイン後、左ペインメニューの<mark class=\"label primary\">バックアップ＆ファームウェア</mark>の<mark class=\"label primary\">ファームウェアの確認</mark>ではただちに全てのユーザーにアップデートの案内が来るわけでは無いので、アップデートにはMySophosにログインし、バージョンアップの差分モジュールをダウンロードします。</p>\n<ol>\n<li>Sophosのサイトの右上のプルダウンメニューから、<mark class=\"label primary\">ライセンスとアカウント</mark>をクリックします。<blockquote>\n<p><a href=\"https://www.sophos.com/ja-jp.aspx\">https://www.sophos.com/ja-jp.aspx</a></p>\n</blockquote>\n</li>\n<li>Sophos IDをお持ちでなければIDを作成します。</li>\n<li>ログイン後、<mark class=\"label primary\">Network Protection</mark>をクリックします。</li>\n<li><mark class=\"label primary\">ファームウェアの更新</mark>をクリックします。</li>\n<li>「製品名&#x2F;OSを使った検索」で”ファイアーウォール”を選択し、その後現れるプルダウンは”ソフトウェア”を選択します。</li>\n<li><mark class=\"label primary\">選択可能なダウンロードを表示</mark>ボタンをクリックします。</li>\n</ol>\n<img src=\"/new-technology/2023/02/23/xg-v195mr1/mysophos.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<ol>\n<li>上記画面で”SW-19.5.1_MR-1.SFW-278.sig”というアップデータが表示されますのでダウンロードします。</li>\n<li>MY Sophosはここで終了してXGの管理画面にログインし、左ペインメニューの<mark class=\"label primary\">バックアップ＆ファームウェア</mark>の<mark class=\"label primary\">ファームウェアのタブメニュー</mark>から以下の画面に赤丸で囲った矢印のアイコンをクリックし、ダウンロードしたモジュールをアップロードします。</li>\n</ol>\n<img src=\"/new-technology/2023/02/23/xg-v195mr1/verup.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<p>アップロード＆再起動ボタンをクリックし、v19.5へのアップグレードを完了させます。</p>\n<img src=\"/new-technology/2023/02/23/xg-v195mr1/upgrade.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<div class=\"note info\"><p>仮想環境（ESXi）上にFirewallをインストールされている方はアップグレードの前に、「<a href=\"/new-technology/2020/10/11/esxi-backup/\" title=\"VMware ESXiの仮想マシンをバックアップする\">VMware ESXiの仮想マシンをバックアップする</a>」を参考に、バックアップを確保される事をお勧めします。</p>\n</div>\n","categories":["Security"],"tags":["XG Firewall"]},{"title":"YubiKeyとSSHとGitHub","url":"/new-technology/2021/02/06/yubikey_ssh_github/","content":"<img src=\"/new-technology/2021/02/06/yubikey_ssh_github/title.png\" class=\"\" width=\"800\" title=\"alt\">\n<p class=\"onepoint\">この記事で実現すること</p>\n\n<p>YubiKeyと関係するソフトウェアの概要説明、そして公開鍵認証でリモートホストにSSHを行えるようにします。またGitHubにコマンドラインからSSH接続できるようにします。</p>\n<span id=\"more\"></span>\n<h2 id=\"Yubico社のYubiKey\"><a href=\"#Yubico社のYubiKey\" class=\"headerlink\" title=\"Yubico社のYubiKey\"></a>Yubico社のYubiKey</h2><p>Yubico社のYubiKeyはなんとなくご存知の方も多いかもしれません。指紋認証ではなく、秘密鍵をこの小さなハードウェアに埋め込み、公開鍵認証、Yubico独自のワンタイムパスワード、FIDO2、そしてGitHubやGoogleなどはWebAuthn（ウェブオースン）でYubiKeyにタッチするだけで簡単に2要素認証が可能になります。6桁のワンタイムパスワードをいちいち入力しなくて済むのは魅力的です。ただ法人向けの要素が強く、実際の使い方については情報が少ないのが現状です。しかし、Amazonなどの商品の評価では非常にユーザー満足度が高いのが見て取れます。</p>\n<img src=\"/new-technology/2021/02/06/yubikey_ssh_github/5C.png\" class=\"\" width=\"320\" title=\"alt\">\n\n<p>私はUSB-Cの最も小さい”YubiKey 5C Nano”をmacOSで使っています。2要素認証が必要な時にこの小さいデバイスに”Touch to Sign”で認証できます。</p>\n<p>macOSでは、GitHubへの2要素認証はTouch IDによるWebAuthnが使えます。このブログを書いている時点でChrome、Edgeは対応しています。以下の通り、組み込みセンサーという表示がTouchIDに相当します。Safariのタッチ認証はYubikeyが必要です。</p>\n<img src=\"/new-technology/2021/02/06/yubikey_ssh_github/touch.png\" class=\"\" width=\"480\" title=\"alt\">\n\n<p>細かいことを言えば、WebAuthnはパスワードを必要としない認証のはずで、GitHubのような2要素認証は定義からすると少し違うような気がします。Microsoftアカウントは、YubiKeyを事前登録する事で、アカウントやパスワードを一切入力せず、YubiKeyのタッチだけでログインできます。公開鍵認証のお手本ですね。<br>他には、パスワード管理ソフトのbitwardenのプレミアムアカウント（年$10と格安です）では、2要素目の認証にWebAuthnを使えます。</p>\n<img src=\"/new-technology/2021/02/06/yubikey_ssh_github/bitwarden.png\" class=\"\" width=\"480\" title=\"alt\">\n\n<p>bitwardenに関する詳細は、「<a href=\"/new-technology/2020/08/30/bitwarden/\" title=\"パスワード管理ソフトのbitwardenを活用する\">パスワード管理ソフトのbitwardenを活用する</a>」の記事を参照してください。</p>\n<p>Yubikeyの小さいパッケージには”Get started yubico.com&#x2F;start”と清々しいシンプルな記載があります。そして、このURLにアクセスすると、使えるWebサイト、サービスの一覧が表示されます。そして、そのサイトでの使い方が説明されているだけです。</p>\n<p>Google、Facebookなどのサイトで”Touch to Sign”の2要素認証を楽しんでみてください。一度認証してしまえば、Cookieに認証情報を保存してしまうため、次からは認証不要で使うという方が大半でしょうから、楽しいのは最初だけかもしれません<span class=\"github-emoji\" alias=\"grin\" style=\"\" fallback-src=\"https://github.githubassets.com/images/icons/emoji/unicode/1f601.png?v8\">&#x1f601;</span></p>\n<p>また、YubiKeyが本物かどうかのテストができます。</p>\n<blockquote>\n<p><a href=\"https://www.yubico.com/genuine/\">https://www.yubico.com/genuine/</a></p>\n</blockquote>\n<h2 id=\"Yubikey-Authenticator\"><a href=\"#Yubikey-Authenticator\" class=\"headerlink\" title=\"Yubikey Authenticator\"></a>Yubikey Authenticator</h2><p>PCのアプリケーションを使っている時には、ワンタイムパスワード（OTP）の入力のためにスマホを取り出すのが少々面倒に感じます。PCにYubico Authenticatorをインストールすればいつもの6桁の数字をコピペで入力できるようになります。当然ですが、YubiKeyが接続されている事が前提（NFCモデルはタッチが前提）になります。スキャナ機能があってデスクトップ上に表示しているOTPのバーコードを読み取る機能もありこれも便利です。</p>\n<p>（左：YubiKey未接続、右：YubiKey接続済）</p>\n<img src=\"/new-technology/2021/02/06/yubikey_ssh_github/otp3.png\" class=\"\" width=\"480\" title=\"alt\">\n\n<h2 id=\"YubiKeyの少し高度な使い方\"><a href=\"#YubiKeyの少し高度な使い方\" class=\"headerlink\" title=\"YubiKeyの少し高度な使い方\"></a>YubiKeyの少し高度な使い方</h2><p>これまで説明してきただけでもYubiKeyは便利で満足度は高く感じるところですが、せっかくなのでもう少し高度な使い方について見ていきましょう。私が使っているmacOSを例にして説明しますが、あまり固有OSに偏らない形で説明していきます。YubiKeyの使い方について、私なりの解釈で難易度として3段階あります。</p>\n<table>\n<thead>\n<tr>\n<th>段階</th>\n<th>難易度</th>\n<th>実現可能になるもの</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>1</td>\n<td>易しい</td>\n<td>FIDO、2要素認証など</td>\n</tr>\n<tr>\n<td>2</td>\n<td>普通</td>\n<td>秘密鍵＋PINによるSSH公開鍵認証</td>\n</tr>\n<tr>\n<td>3</td>\n<td>高</td>\n<td>GnuPGによるGitHubリポジトリへのコミット時の署名およびSSH</td>\n</tr>\n</tbody></table>\n<p>3番目のGnuPGを使ったGitHubの署名、SSH接続は難易度が高く、別記事にします。</p>\n<p>GitHub開発者でなくとも、YubiKeyを使いこなすために、2段階目のSSH公開鍵認証まではやってみたいものです。SSHによる公開鍵認証、かつパスフレーズを簡素なものにするという目的で必要なソフトウェアの一覧を以下に記載します。</p>\n<table>\n<thead>\n<tr>\n<th>Yubicoソフトウェア</th>\n<th>説明</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>YubiKey ManagerGUI)</td>\n<td>最初に使う管理ツール（GUI）</td>\n</tr>\n<tr>\n<td>Yubico PIV Tool</td>\n<td>SSHを行う際にPIVカード認証（公開鍵認証）方式で接続する（CLI）</td>\n</tr>\n<tr>\n<td>Yubikey PIV Manager</td>\n<td>SSHを行う際にPIVカード認証（公開鍵認証）方式で接続する（GUI）</td>\n</tr>\n</tbody></table>\n<blockquote>\n<p><a href=\"https://www.yubico.com/products/services-software/download/smart-card-drivers-tools/\">https://www.yubico.com/products/services-software/download/smart-card-drivers-tools/</a><br><a href=\"https://developers.yubico.com/yubikey-piv-manager/Releases/\">https://developers.yubico.com/yubikey-piv-manager/Releases/</a></p>\n</blockquote>\n<p>上記以外には、PKCS#11と呼ばれるスマートカードやUSBトークンを対象とした認証ライブラリが存在しますのでそれをダウンロードする必要があります（後述します）。</p>\n<p>過去から様々な変遷があって、Yubicoでは正直ソフトウェアが乱立しています。もう使わなくなったソフトウェアや、新しいソフトウェアだけどまだ機能が移行されていないなど少しわかりづらいものがあります。</p>\n<h2 id=\"YubiKey-ManagerとYubiKeyの機能\"><a href=\"#YubiKey-ManagerとYubiKeyの機能\" class=\"headerlink\" title=\"YubiKey ManagerとYubiKeyの機能\"></a>YubiKey ManagerとYubiKeyの機能</h2><p>YubiKey Manager(GUI)はYubiKeyの全体管理に使うソフトウェアです。セットアップは全く難しくありません。</p>\n<img src=\"/new-technology/2021/02/06/yubikey_ssh_github/yubi1.png\" class=\"\" width=\"480\" title=\"alt\">\n\n<mark class=\"label primary\">Applications</mark>から、OTPを選択すると以下の画面になります。\n<img src=\"/new-technology/2021/02/06/yubikey_ssh_github/yubi2.png\" class=\"\" width=\"480\" title=\"alt\">\n<p>OTPにはSlot1,2の2つのスロットがあります。Slot1のショートタッチにはOTPが割り当てられています。さらに<mark class=\"label primary\">Configure</mark>に進みます。</p>\n<img src=\"/new-technology/2021/02/06/yubikey_ssh_github/yubi3.png\" class=\"\" width=\"480\" title=\"alt\">\n<p>ここでは、Slot1に対してYubico OTP（Yubico独自のワンタイムパスワード）、チャレンジレスポンス、スタティックパスワード、OATH-HOTPが選択できます。このスロットはショートタッチ、一瞬YubiKeyに触れると、キーが入力されます。つまりキーボードのように振舞います。なお、Slot2のロングタッチに重要なアプリケーションの長めのパスワードを割り当てておくと便利です。2秒程度YubiKeyに触れているとSlot2のスタティックパスワードが入力されます。パスワード管理ソフトなどのログインには便利に使えます。</p>\n<p>この他、FIDO2、PIVと並んでいますが、SSHで利用する場合はこのPIVが重要になります。<br>PIVは米国の連邦政府における政府職員の身分証明用のICカードの規格になります。</p>\n<h3 id=\"PIN-Managementについて\"><a href=\"#PIN-Managementについて\" class=\"headerlink\" title=\"PIN Managementについて\"></a>PIN Managementについて</h3><mark class=\"label primary\">Applications</mark>から<mark class=\"label primary\">PIV</mark>を選択すると、\"PIN Management\"、\"Certificates\"、\"Reset\"と並びます。\n<p>PIVは、ICカード向けの規格に基づくものです。4つのSlotがあります。</p>\n<table>\n<thead>\n<tr>\n<th>Slot</th>\n<th>説明</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>9a</td>\n<td>Authentication SSHでPIN入力と共に利用します</td>\n</tr>\n<tr>\n<td>9c</td>\n<td>Digital Signature</td>\n</tr>\n<tr>\n<td>9d</td>\n<td>Key Management</td>\n</tr>\n<tr>\n<td>9e</td>\n<td>Card Authentication</td>\n</tr>\n</tbody></table>\n<p>SSHでは、Slot9aのAuthenticationを使うことになります。</p>\n<img src=\"/new-technology/2021/02/06/yubikey_ssh_github/yubi4.png\" class=\"\" width=\"480\" title=\"alt\">\n\n<p>そして、このSlot9aを用いて接続する際は、PINの認証が必要です。まず最初にPINの設定を変更しましょう。PINは日本のマイナンバーカードとほぼ扱いは同じで多少緊張感が必要です。3回入力ミスするとPUK（PIN Unlock Key）によるリセットが必要になります。PINの初期設定は”123456”となります。</p>\n<h2 id=\"SSH（PIV-Authentication）の設定\"><a href=\"#SSH（PIV-Authentication）の設定\" class=\"headerlink\" title=\"SSH（PIV Authentication）の設定\"></a>SSH（PIV Authentication）の設定</h2><p>さて、実際のSSHの設定ですが、実は以前に自分が設定したものよりもわかりやすい方法が掲載されていたのでそちらをまず紹介させていただきます。</p>\n<blockquote>\n<p>ペンティオ Engineer’s Blog<br> <a href=\"https://techblog.pentio.com/entry/ssh-using-yubikey\">https://techblog.pentio.com/entry/ssh-using-yubikey</a></p>\n</blockquote>\n<p>このページで紹介している方法はWindowsもmacOSも考慮されているので多くの方の参考になるでしょう。</p>\n<p>ここではYubikey ManagerとYubikey PIV Managerを用いてGUIで構成されています。また、PKCS#11のために、OpenSCライブラリをダウンロードし構成する方法が紹介されています。実際のダウンロードリンクは以下を参照してください。</p>\n<blockquote>\n<p><a href=\"https://www.pentio.com/yubikey/support/smartcard/\">https://www.pentio.com/yubikey/support/smartcard/</a></p>\n</blockquote>\n<h3 id=\"macOS向け\"><a href=\"#macOS向け\" class=\"headerlink\" title=\"macOS向け\"></a>macOS向け</h3><p>私は色々なライブラリがさまざまな場所にインストールされ、またバージョン管理が煩雑になるのを好まないため、<strong>Homebrew</strong>を使っています。Macユーザーにとっては一般的なものですが、こちらを使ったインストールをお勧めします。私はYubiKey Managerは単独でインストールし、残りのYubikey関連は<code>brew install opensc yubico-piv-tool</code>としてインストールしました。openscは大型ライブラリのため、依存関係で様々なパッケージが自動インストールされます。私はopenscのインストールが終わった後に気づいたのですが、yubico-piv-toolのなかに、SSHに必要なライブラリがあるようです。私のセットアップ（macOS）は、Yubicoのサイトを参考にコマンドラインベースで行いました。</p>\n<blockquote>\n<p>Homebrew<br> <a href=\"https://brew.sh/index_ja\">https://brew.sh/index_ja</a><br>Yubico -Using PIV for SSH through PKCS #11-<br> <a href=\"https://developers.yubico.com/PIV/Guides/SSH_with_PIV_and_PKCS11.html\">https://developers.yubico.com/PIV/Guides/SSH_with_PIV_and_PKCS11.html</a></p>\n</blockquote>\n<p>上記の説明のなかに”Find out where ykcs11 has been installed. For a Debian-based system, the ykcs11 module ends up in &#x2F;usr&#x2F;local&#x2F;lib&#x2F;libykcs11. On MacOS, it is in &#x2F;usr&#x2F;local&#x2F;lib&#x2F;libykcs11.dylib.”と説明があります。実際に<code>/usr/local/lib</code>を確認しましたが、<code>libykcs11.dylib -&gt; ../Cellar/yubico-piv-tool/2.2.0/lib/libykcs11.dylib</code>とインストール済みのyubico-piv-toolのライブラリにシンボリックリンクが張られていました。</p>\n<h2 id=\"SSH接続テスト\"><a href=\"#SSH接続テスト\" class=\"headerlink\" title=\"SSH接続テスト\"></a>SSH接続テスト</h2><p>さて、YubiKeyで秘密鍵を生成し終わったところで、公開鍵を生成します。(Pathは環境によって異なります）</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">ssh-keygen -D /usr/local/opt/opensc/lib/opensc-pkcs11.so -e</span><br></pre></td></tr></table></figure>\n<p>また、Yubicoのライブラリを利用するのであれば、以下の通りです。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">ssh-keygen -D /usr/local/lib/libykcs11.dylib -e</span><br></pre></td></tr></table></figure>\n\n<p>出力された公開鍵を接続先のサーバーのauthorized_keysに配置します（一般的な方法であり手順は省略します）。</p>\n<p>相手先サーバに接続してみます。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ ssh -I /usr/local/lib/libykcs11.dylib usr1@192.168.x.x</span><br><span class=\"line\">Enter PIN <span class=\"keyword\">for</span> <span class=\"string\">&#x27;YubiKey PIV #XXXXXXXX&#x27;</span>:</span><br><span class=\"line\">Welcome to Ubuntu 20.04.2 LTS (GNU/Linux 5.8.0-41-generic x86_64)</span><br><span class=\"line\">Your Hardware Enablement Stack (HWE) is supported until April 2025.</span><br><span class=\"line\">Last login: Fri Feb  5 20:59:22 2021 from 192.168.x.x</span><br><span class=\"line\">usr1@ubuntu:~$</span><br></pre></td></tr></table></figure>\n<p>PINを入力して公開鍵認証で接続できました。秘密鍵はYubiKey内部で生成されているため、漏洩する事はありません。</p>\n<p>簡単にYubiKeyを利用してSSHに接続するためには、<code>~/.ssh/config</code>に設定を加えます。接続先ホストに対してライブラリを明示します。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">Host ubuntu</span><br><span class=\"line\"> HostName 192.168.x.x</span><br><span class=\"line\"> User usr1</span><br><span class=\"line\"> <span class=\"comment\">#PKCS11Provider /usr/local/opt/opensc/lib/opensc-pkcs11.so</span></span><br><span class=\"line\"> PKCS11Provider /usr/local/lib/libykcs11.dylib</span><br><span class=\"line\"> IdentitiesOnly <span class=\"built_in\">yes</span></span><br><span class=\"line\"></span><br><span class=\"line\">Host github.com</span><br><span class=\"line\"> <span class=\"comment\">#PKCS11Provider /usr/local/opt/opensc/lib/opensc-pkcs11.so</span></span><br><span class=\"line\"> PKCS11Provider /usr/local/lib/libykcs11.dylib</span><br><span class=\"line\"> IdentitiesOnly <span class=\"built_in\">yes</span></span><br></pre></td></tr></table></figure>\n<p>「<a href=\"/new-technology/2021/01/23/esxi-security/\" title=\"ESXi(無償版)のセキュリティを高める\">ESXi(無償版)のセキュリティを高める</a>」の記事で触れましたが、これらの設定を行う事で、ESXiへのSSHでYubiKeyを使った公開鍵認証が可能になります。</p>\n<h2 id=\"GitHubへのSSH接続\"><a href=\"#GitHubへのSSH接続\" class=\"headerlink\" title=\"GitHubへのSSH接続\"></a>GitHubへのSSH接続</h2><p>開発者の方であればGitHubへの接続もYubiKeyで行いたいかもしれません。私はGitHub上にブログを構築しており、普段はTerminalのコマンドラインでデプロイしています。これは2要素認証は行えませんからGitHub上でパーソナルアクセストークンを発行し、それを利用します。パーソナルアクセストークンはアプリケーション専用パスワードという事になります。それなりの文字長なので安全性は高いですが、2要素認証よりは劣ります。もしあなたが趣味としてのホームユーザーではなく開発者であり、さらに安全性を高める必要があれば、パーソナルアクセストークンをやめて、SSH接続を検討してみてください。なお、この設定には制限事項があるので後述します。</p>\n<p>GitHubのSSH接続に関するリソースを掲載します。以下でGitHubにログインし、公開鍵を登録します。</p>\n<blockquote>\n<p>GitHub アカウントへの新しい SSH キーの追加<br> <a href=\"https://docs.github.com/ja/github/authenticating-to-github/adding-a-new-ssh-key-to-your-github-account\">https://docs.github.com/ja/github/authenticating-to-github/adding-a-new-ssh-key-to-your-github-account</a></p>\n</blockquote>\n<p>これでPIN入力とともに、GitHubにはSSHで接続できるようになりました。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ ssh -T git@github.com</span><br><span class=\"line\">Enter PIN for &#x27;YubiKey PIV #XXXXXXXX&#x27;:</span><br><span class=\"line\">Hi yoshi0808! You&#x27;ve successfully authenticated, but GitHub does not provide shell access.</span><br></pre></td></tr></table></figure>\n\n<p>また、gitコマンドでSSH接続を有効にするには以下のコマンドを実行します。<br><code>$ git remote set-url origin git@github.com:[ユーザID]/[リポジトリ].git</code></p>\n<p>設定確認は以下の通りです<br><code>$ git remote -v</code></p>\n<p>HTTPS接続に戻す場合は、<strong>リモートの URL の変更</strong>を参照してください。</p>\n<blockquote>\n<p><a href=\"https://docs.github.com/ja/github/using-git/changing-a-remotes-url\">https://docs.github.com/ja/github/using-git/changing-a-remotes-url</a></p>\n</blockquote>\n<h3 id=\"SSH接続の制限事項\"><a href=\"#SSH接続の制限事項\" class=\"headerlink\" title=\"SSH接続の制限事項\"></a>SSH接続の制限事項</h3><p>コマンドライン中心にgitを使われている方は問題ありませんが、YubiKeyのPIVによるPIN入力はTerminalにおける標準入出力を使用しています。従って、GUIアプリケーションを利用した時に標準入出力を使えませんから、SSH認証が失敗します。例えば、GitHub Desktopなどは以下のエラーが発生します。</p>\n<img src=\"/new-technology/2021/02/06/yubikey_ssh_github/gh-desktop.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<p>これが困るという事であれば一旦GUIはHTTPS接続とし、パーソナルアクセストークンを必要としたアプリケーション専用にSSH接続とする使い分けが必要となります。</p>\n<h2 id=\"macOSにおけるyubico-piv-toolでの秘密鍵作成ログ\"><a href=\"#macOSにおけるyubico-piv-toolでの秘密鍵作成ログ\" class=\"headerlink\" title=\"macOSにおけるyubico-piv-toolでの秘密鍵作成ログ\"></a>macOSにおけるyubico-piv-toolでの秘密鍵作成ログ</h2><p>以下は私が過去に実行したSSHの秘密鍵作成からSSHの実行までの作業ログです。openscはYubico提供のライブラリを利用しています。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">[xxxx@MB-Air:~]</span><br><span class=\"line\">$ yubico-piv-tool -s 9a -a generate -o public.pem -k</span><br><span class=\"line\">Enter management key:</span><br><span class=\"line\">Successfully generated a new private key.</span><br><span class=\"line\"></span><br><span class=\"line\">[xxxx@MB-Air:~]</span><br><span class=\"line\">$ yubico-piv-tool -a verify-pin -a selfsign-certificate -s 9a -S <span class=\"string\">&quot;/CN=SSH key/&quot;</span> -i public.pem -o cert.pem</span><br><span class=\"line\">Enter PIN:</span><br><span class=\"line\">Successfully verified PIN.</span><br><span class=\"line\">Successfully generated a new self signed certificate.</span><br><span class=\"line\"></span><br><span class=\"line\">[xxxx@MB-Air:~]</span><br><span class=\"line\">$ yubico-piv-tool -a import-certificate -s 9a -i cert.pem -k</span><br><span class=\"line\">Enter management key:</span><br><span class=\"line\">Successfully imported a new certificate.</span><br><span class=\"line\"></span><br><span class=\"line\">$ ssh-keygen -D /usr/local/lib/libykcs11.dylib -e &gt; id_rsa.pub</span><br><span class=\"line\"></span><br><span class=\"line\">$ ssh -I /usr/local/lib/libykcs11.dylib usr1@192.168.x.x</span><br><span class=\"line\">Enter PIN <span class=\"keyword\">for</span> <span class=\"string\">&#x27;YubiKey PIV #XXXXXXXX&#x27;</span>:</span><br></pre></td></tr></table></figure>\n\n<p>上記では公開鍵id_rsa.pubをサーバー側に配置している手順は省略しています。</p>\n<h2 id=\"YubikeyでSSH設定してみた感想\"><a href=\"#YubikeyでSSH設定してみた感想\" class=\"headerlink\" title=\"YubikeyでSSH設定してみた感想\"></a>YubikeyでSSH設定してみた感想</h2><p>WebAuthnや2要素認証以上にYubiKeyを使いこなそうとすると、プロダクトが新旧あり混乱しやすく難易度も上がります。一番便利だなと感じているのはbitwardenへのローカルのログインで使うスタティックパスワードだったりします。さらにGnuPGを使ったGitHubへのコミット時の署名をYubiKeyで行う事もできますが、GnuPGの理解も必要となりもっと複雑です。今回制約となったGitHub DesktopなどのSSH認証時の課題はGnuPGを使う事で完全に解決します。続きは「<a href=\"/new-technology/2021/02/13/yubikey_gpg/\" title=\"GPG ToolsでYubiKeyを使う\">GPG ToolsでYubiKeyを使う</a>」にその方法を記載しています。</p>\n","categories":["Security"],"tags":["yubikey"]},{"title":"GPG ToolsでYubiKeyを使う","url":"/new-technology/2021/02/13/yubikey_gpg/","content":"<p class=\"onepoint\">この記事で実現すること</p>\nmacOS環境下でGPG Tools(GPG Suite)の鍵管理（署名、暗号化、SSH認証）にYubiKeyを使います。\n<span id=\"more\"></span>\n\n<h2 id=\"GPG-GnuPG-について\"><a href=\"#GPG-GnuPG-について\" class=\"headerlink\" title=\"GPG(GnuPG)について\"></a>GPG(GnuPG)について</h2><p>GPGは昔からあるオープンソースの暗号・署名の主要なコンポーネントのひとつです。日本ではパスワード付きZIPファイルのやり取り、いわゆるPPAPを無くしていく流れでもあるので、これを機会にGPGが見直されればいいなと思いこの記事を書く事にしました。特にmacOS版は複数プロダクトまたは複数バージョンに対する設定が混在していて（既に廃止された機能の説明を含む）、余計に分かりづらくなっています。</p>\n<p>昔のPGPでの主眼であった友達の輪を広げていくという考え方は現代ではもはや少なくなってしまいました。むしろそういった信用の輪がサイバー攻撃で狙われてしまう時代です。GPGでの署名やITベンダーへのサポートのためにダンプファイルを相手の公開鍵で暗号化して送付する、ダウンロードしたファイルの署名を確認するという使われ方がメインです。</p>\n<h2 id=\"ソフトウェア構成\"><a href=\"#ソフトウェア構成\" class=\"headerlink\" title=\"ソフトウェア構成\"></a>ソフトウェア構成</h2><p>GPGは基本的にはコマンドラインベースのプロダクトですが、macOSユーザーであれば、GPG Tools(GPG Suite)をお勧めします。GUIで暗号化・復号化できるのは便利です。但し、Appleメールの拡張機能でGPGを使う場合、3,000円程度の有償となります。Homebrewであれば、gpg-suite、gpg-suite-no-mail（有償のメール機能が無いもの）が該当します。<strong>GPG Suite</strong>を直接ダウンロードする方法もあります。<del>しかし、このブログを書いている2月10日時点ではYubikeyを使うようなカードインタフェースがうまく動作しません。これは不具合としてGPG Toolsサポートに報告<a href=\"https://gpgtools.tenderapp.com/discussions/feedback/16266-signing-with-a-yubikey-fails-until-i-run-gpg-card-status\">https://gpgtools.tenderapp.com/discussions/feedback/16266-signing-with-a-yubikey-fails-until-i-run-gpg-card-status</a>があります。という事で現時点ではナイトリービルドGPG Suite 2020.2 (2989n)<a href=\"https://releases.gpgtools.org/nightlies/\">https://releases.gpgtools.org/nightlies/</a>を使う事になります。</del></p>\n<p>（2021-5-23　追記）<br>2021-5-21発表のGPG Suite 2021.1で上記の不具合は解消しています。</p>\n<blockquote>\n<p>GPG Suite<br> <a href=\"https://gpgtools.org/\">https://gpgtools.org/</a></p>\n</blockquote>\n<p>これ以外には、YubicoのykmanというYubiKey Managerのコマンドインタフェースツールが必要です。これはHomebrewで<strong>ykman</strong>をインストールするか、Yubicoのサイトからダウンロードし、インストールしてください。</p>\n<blockquote>\n<p>Yubico ykman CLI<br> <a href=\"https://developers.yubico.com/yubikey-manager/\">https://developers.yubico.com/yubikey-manager/</a></p>\n</blockquote>\n<h2 id=\"GPG-Tools-GPG-Suite-の主な使い方\"><a href=\"#GPG-Tools-GPG-Suite-の主な使い方\" class=\"headerlink\" title=\"GPG Tools(GPG Suite)の主な使い方\"></a>GPG Tools(GPG Suite)の主な使い方</h2><h3 id=\"GUIでのファイルの暗号化・復号化・署名\"><a href=\"#GUIでのファイルの暗号化・復号化・署名\" class=\"headerlink\" title=\"GUIでのファイルの暗号化・復号化・署名\"></a>GUIでのファイルの暗号化・復号化・署名</h3><p>マウスの右クリック（タッチパッドは2本指のタップ）で以下のメニューが選択できます。</p>\n<img src=\"/new-technology/2021/02/13/yubikey_gpg/menu.png\" class=\"\" width=\"480\" title=\"alt\">\n\n<h3 id=\"GUIでの選択部分の暗号化・復号化・署名\"><a href=\"#GUIでの選択部分の暗号化・復号化・署名\" class=\"headerlink\" title=\"GUIでの選択部分の暗号化・復号化・署名\"></a>GUIでの選択部分の暗号化・復号化・署名</h3><p>文字列部分を選択し、マウスの右クリック（タッチパッドは2本指のタップ）で以下のメニューが選択できます。</p>\n<img src=\"/new-technology/2021/02/13/yubikey_gpg/menu2.png\" class=\"\" width=\"480\" title=\"alt\">\n\n<p>長い文字列でなければ、パスワード管理ソフトに入れておくほうが現実的でしょうか。</p>\n<h3 id=\"GitHubでのVerify\"><a href=\"#GitHubでのVerify\" class=\"headerlink\" title=\"GitHubでのVerify\"></a>GitHubでのVerify</h3><p>GitHubでコミット時に本人が署名すると、以下の”Verified”マークが付きます。</p>\n<img src=\"/new-technology/2021/02/13/yubikey_gpg/verify.png\" class=\"\" width=\"480\" title=\"alt\">\n\n<h3 id=\"Mailでの署名と暗号化\"><a href=\"#Mailでの署名と暗号化\" class=\"headerlink\" title=\"Mailでの署名と暗号化\"></a>Mailでの署名と暗号化</h3><p>メールの受取側がGPGを持っており、相手の公開鍵を自分のGPGに取り込んであれば、暗号化と署名を付けてメールを送れます。</p>\n<img src=\"/new-technology/2021/02/13/yubikey_gpg/mail.png\" class=\"\" width=\"640\" title=\"alt\">\n\n<h3 id=\"GPGを使ったSSH\"><a href=\"#GPGを使ったSSH\" class=\"headerlink\" title=\"GPGを使ったSSH\"></a>GPGを使ったSSH</h3><p>YubiKeyで設定したPINを入力して公開鍵認証でSSH接続します。</p>\n<img src=\"/new-technology/2021/02/13/yubikey_gpg/ssh.png\" class=\"\" width=\"640\" title=\"alt\">\n\n<h2 id=\"YubiKeyを使ったGPGの鍵管理\"><a href=\"#YubiKeyを使ったGPGの鍵管理\" class=\"headerlink\" title=\"YubiKeyを使ったGPGの鍵管理\"></a>YubiKeyを使ったGPGの鍵管理</h2><p>YubiKeyを使うGPGでは主鍵(MainKey)となる認定鍵(Certify)に加え、署名(Sign)、暗号(Encrypt)、認証(Authenticate)という副鍵(SubKey)を持たせます。YubiKeyの構成上、ひとつの機能にひとつの副鍵を割り当てる事が大前提です。そしてYubiKeyを紛失した場合を考慮し、主鍵はYubiKeyには置きません。主鍵は変えず、副鍵は任意に削除、追加する事を想定しています。Yubicoでは、この副鍵を端末側で生成し、それをYubiKeyに取り込む形を推奨しています。RSA暗号2048ビットのPIVとは異なり、GPGにおけるYubiKey 4&#x2F;5はRSA暗号4096ビットまで対応できます。RSA暗号は2048ビットあれば十分と考えていますが、<strong>GitHubの推奨</strong>としては「キーは少なくとも4096ビットである必要があります」との事。GitHubさん、そこまで必要ですか<span class=\"github-emoji\" alias=\"persevere\" style=\"\" fallback-src=\"https://github.githubassets.com/images/icons/emoji/unicode/1f623.png?v8\">&#x1f623;</span></p>\n<blockquote>\n<p>GitHub -新しいGPGキーを生成する-<br> <a href=\"https://docs.github.com/ja/github/authenticating-to-github/generating-a-new-gpg-key\">https://docs.github.com/ja/github/authenticating-to-github/generating-a-new-gpg-key</a></p>\n</blockquote>\n<pre class=\"mermaid\">\ngraph TD\nB[MainKey-Certify] --&gt; C{SubKey}\nC --&gt;D[Sign]\nC --&gt;E[Encrypt]\nC --&gt;F[Authenticate]\n</pre>\n\n<p>主鍵は万が一YubiKeyをなくした場合などの鍵の抹消や新しい副鍵を作る以外は使いません。USBなどに複写し安全な場所で保管する事になります。主鍵が無いと友達の輪を広げられない（相手の公開鍵に署名できない）のですが、YubiKeyを使ったGPGの使い方としては、そこに重きを置いていません。YubiKeyとGPGのセットアップはお手本となる説明があります。</p>\n<div class=\"link-grid\"><div class=\"link-grid-container\">\n<object class=\"link-grid-image\" data=\"12475110.png\"></object>\n<p>drduh/YubiKey-Guide</p><p>(https://github.com/drduh/YubiKey-Guide) This is a guide to using YubiKey as a SmartCard for storing GPG encryption, signing and authentication keys, which can also be used for SSH.</p>\n<a href=\"https://github.com/drduh/YubiKey-Guide\"></a>\n</div></div>\n<blockquote>\n<p><a href=\"https://github.com/drduh/YubiKey-Guide\">https://github.com/drduh/YubiKey-Guide</a></p>\n</blockquote>\n<p>ただし、このガイドは秘密鍵を漏洩させないためにクリーンなLinux上で作業し、暗号化USBを作りセットアップするという超優等生な手順になっています。この記事では可能な限りシンプルな手順の作成を目的とし一部の手順を割愛しています。</p>\n<h2 id=\"GPGをセットアップするための手順\"><a href=\"#GPGをセットアップするための手順\" class=\"headerlink\" title=\"GPGをセットアップするための手順\"></a>GPGをセットアップするための手順</h2><p>大まかな手順は以下の通りです。</p>\n<ol>\n<li>上述した必須ソフトウェアのセットアップ、秘密鍵のバックアップのためのUSBメディア<sup><a href=\"#note1\"><strong>[1]</strong></a></sup>を準備します</li>\n<li>GPGでの鍵の作成からYubiKeyへの鍵を取り込みます</li>\n<li>GPG環境を設定します</li>\n<li>SSHに必要なSSH公開鍵をエクスポートします</li>\n<li>GitHub署名のためのGPG公開鍵と上記SSHの鍵をGitHubにログインして登録します</li>\n<li>GitHubのSSH接続および署名のためgitを設定します</li>\n</ol>\n<h3 id=\"GPGの鍵作成からYubiKeyへの鍵の取り込み\"><a href=\"#GPGの鍵作成からYubiKeyへの鍵の取り込み\" class=\"headerlink\" title=\"GPGの鍵作成からYubiKeyへの鍵の取り込み\"></a>GPGの鍵作成からYubiKeyへの鍵の取り込み</h3><h4 id=\"前提\"><a href=\"#前提\" class=\"headerlink\" title=\"前提\"></a>前提</h4><p>必要なソフトウェア（GPG Suite・ykman）がインストールされている事、秘密鍵のバックアップのため、macOSで認識可能となるようフォーマット済みのUSBが用意できている前提としています。鍵の生成は出来るだけ安全な環境下で実施するために、ネットワークから切り離し、ウィルス対策ソフト以外のソフトウェアを可能な限り終了させてから作業します。また鍵の作成時にはYubiKeyの接続は必要ありません。</p>\n<p>私はmacOSのCatalina(10.15.7)、シェルはデフォルトのZshを利用しています。また、コマンドラインエディタはvim(vi)を利用していますが、他のエディタでも構いません。GPGのコマンドインタフェースがかなり特殊な事もあって、まずはアドリブ無しにこの手順をなぞっていただく事をお勧めします。変更可能な部分は主鍵および副鍵の有効期限および鍵の種類です。鍵の種類としては特に拘りがなければRSAをお勧めします。</p>\n<div class=\"note info\"><p>以下の手順では、＃から始まるコメント部分に要点を記載しています。</p>\n</div>\n\n<h4 id=\"初期設定\"><a href=\"#初期設定\" class=\"headerlink\" title=\"初期設定\"></a>初期設定</h4><p>ターミナルを起動します。認定（Certify）鍵を無期限で作成します。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 一時フォルダを作成し、そこに鍵をセットアップしていきます</span></span><br><span class=\"line\">$ <span class=\"built_in\">export</span> GNUPGHOME=$(<span class=\"built_in\">mktemp</span> -d)</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"主鍵の生成\"><a href=\"#主鍵の生成\" class=\"headerlink\" title=\"主鍵の生成\"></a>主鍵の生成</h4><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 主鍵は期限無し、RSA 4096Bitで生成します</span></span><br><span class=\"line\">$ gpg --expert --full-gen-key</span><br><span class=\"line\">gpg (GnuPG/MacGPG2) 2.2.27; Copyright (C) 2021 Free Software Foundation, Inc.</span><br><span class=\"line\">This is free software: you are free to change and redistribute it.</span><br><span class=\"line\">There is NO WARRANTY, to the extent permitted by law.</span><br><span class=\"line\"></span><br><span class=\"line\">ご希望の鍵の種類を選択してください:</span><br><span class=\"line\">   (1) RSA と RSA (デフォルト)</span><br><span class=\"line\">   (2) DSA と Elgamal</span><br><span class=\"line\">   (3) DSA (署名のみ)</span><br><span class=\"line\">   (4) RSA (署名のみ)</span><br><span class=\"line\">   (7) DSA (機能をあなた自身で設定)</span><br><span class=\"line\">   (8) RSA (機能をあなた自身で設定)</span><br><span class=\"line\">   (9) ECC と ECC</span><br><span class=\"line\">  (10) ECC (署名のみ)</span><br><span class=\"line\">  (11) ECC (機能をあなた自身で設定)</span><br><span class=\"line\">  (13) 既存の鍵</span><br><span class=\"line\">  (14) カードに存在する鍵</span><br><span class=\"line\">あなたの選択は? 8</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 機能毎にフラグという概念を持ちます。これの有効、無効の切り替えに反転という表現が使われています</span></span><br><span class=\"line\">鍵RSAに認められた操作: Sign Certify Encrypt Authenticate</span><br><span class=\"line\">現在の認められた操作: Sign Certify Encrypt</span><br><span class=\"line\"></span><br><span class=\"line\">   (S) 署名機能を反転する</span><br><span class=\"line\">   (E) 暗号機能を反転する</span><br><span class=\"line\">   (A) 認証機能を反転する</span><br><span class=\"line\">   (Q) 完了</span><br><span class=\"line\"></span><br><span class=\"line\">あなたの選択は? E</span><br><span class=\"line\"></span><br><span class=\"line\">鍵RSAに認められた操作: Sign Certify Encrypt Authenticate</span><br><span class=\"line\">現在の認められた操作: Sign Certify</span><br><span class=\"line\"></span><br><span class=\"line\">   (S) 署名機能を反転する</span><br><span class=\"line\">   (E) 暗号機能を反転する</span><br><span class=\"line\">   (A) 認証機能を反転する</span><br><span class=\"line\">   (Q) 完了</span><br><span class=\"line\"></span><br><span class=\"line\">あなたの選択は? S</span><br><span class=\"line\"></span><br><span class=\"line\">鍵RSAに認められた操作: Sign Certify Encrypt Authenticate</span><br><span class=\"line\">現在の認められた操作: Certify</span><br><span class=\"line\"></span><br><span class=\"line\">   (S) 署名機能を反転する</span><br><span class=\"line\">   (E) 暗号機能を反転する</span><br><span class=\"line\">   (A) 認証機能を反転する</span><br><span class=\"line\">   (Q) 完了</span><br><span class=\"line\"></span><br><span class=\"line\">あなたの選択は? Q</span><br><span class=\"line\">RSA 鍵は 1024 から 4096 ビットの長さで可能です。</span><br><span class=\"line\">鍵長は? (3072) 4096</span><br><span class=\"line\">要求された鍵長は4096ビット</span><br><span class=\"line\">鍵の有効期限を指定してください。</span><br><span class=\"line\">         0 = 鍵は無期限</span><br><span class=\"line\">      &lt;n&gt;  = 鍵は n 日間で期限切れ</span><br><span class=\"line\">      &lt;n&gt;w = 鍵は n 週間で期限切れ</span><br><span class=\"line\">      &lt;n&gt;m = 鍵は n か月間で期限切れ</span><br><span class=\"line\">      &lt;n&gt;y = 鍵は n 年間で期限切れ</span><br><span class=\"line\">鍵の有効期間は? (0)0</span><br><span class=\"line\">鍵は無期限です</span><br><span class=\"line\">これで正しいですか? (y/N) y</span><br><span class=\"line\"></span><br><span class=\"line\">GnuPGはあなたの鍵を識別するためにユーザIDを構成する必要があります。</span><br><span class=\"line\"></span><br><span class=\"line\">本名: Your Name</span><br><span class=\"line\">電子メール・アドレス: your@mail.com</span><br><span class=\"line\">コメント:</span><br><span class=\"line\">次のユーザIDを選択しました:</span><br><span class=\"line\">    <span class=\"string\">&quot;Your Name &lt;your@mail.com&gt;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">名前(N)、コメント(C)、電子メール(E)の変更、またはOK(O)か終了(Q)? O</span><br><span class=\"line\">たくさんのランダム・バイトの生成が必要です。キーボードを打つ、マウスを動か</span><br><span class=\"line\">す、ディスクにアクセスするなどの他の操作を素数生成の間に行うことで、乱数生</span><br><span class=\"line\">成器に十分なエントロピーを供給する機会を与えることができます。</span><br><span class=\"line\">たくさんのランダム・バイトの生成が必要です。キーボードを打つ、マウスを動か</span><br><span class=\"line\">す、ディスクにアクセスするなどの他の操作を素数生成の間に行うことで、乱数生</span><br><span class=\"line\">成器に十分なエントロピーを供給する機会を与えることができます。</span><br><span class=\"line\">gpg: 鍵1234567890123456を究極的に信用するよう記録しました</span><br><span class=\"line\">gpg: 失効証明書を <span class=\"string\">&#x27;/tmp/xxx/openpgp-revocs.d/XXXXED7DE0C6BC105798E304D4B75A4941146XXXX.rev&#x27;</span> に保管しました。</span><br><span class=\"line\">公開鍵と秘密鍵を作成し、署名しました。</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 上記の「鍵1234567890123456を究極的に信用するよう記録しました」のKEY番号をを環境変数KEYIDに登録します</span></span><br><span class=\"line\"><span class=\"comment\"># セットアップの間、KEYIDを何度も使うためです</span></span><br><span class=\"line\">$ <span class=\"built_in\">export</span> KEYID=1234567890123456</span><br><span class=\"line\"></span><br><span class=\"line\">$ gpg --expert --edit-key <span class=\"variable\">$KEYID</span></span><br><span class=\"line\">gpg (GnuPG/MacGPG2) 2.2.27; Copyright (C) 2020 Free Software Foundation, Inc.</span><br><span class=\"line\">This is free software: you are free to change and redistribute it.</span><br><span class=\"line\">There is NO WARRANTY, to the extent permitted by law.</span><br><span class=\"line\"></span><br><span class=\"line\">秘密鍵が利用できます。</span><br><span class=\"line\"></span><br><span class=\"line\">sec  rsa4096/1234567890123456</span><br><span class=\"line\">     作成: 2021-01-31  有効期限: 無期限  利用法: C</span><br><span class=\"line\">[  究極  ] (1). Your Name &lt;your@mail.com&gt;</span><br></pre></td></tr></table></figure>\n\n<p>以降は副鍵を作成していきます。一般的な考えでは、有効期限は定めるべきものとされています。</p>\n<h4 id=\"署名副鍵の作成\"><a href=\"#署名副鍵の作成\" class=\"headerlink\" title=\"署名副鍵の作成\"></a>署名副鍵の作成</h4><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 副鍵は期限5年、RSA4096bitで構成します</span></span><br><span class=\"line\">gpg&gt; addkey</span><br><span class=\"line\">ご希望の鍵の種類を選択してください:</span><br><span class=\"line\">   (3) DSA (署名のみ)</span><br><span class=\"line\">   (4) RSA (署名のみ)</span><br><span class=\"line\">   (5) Elgamal (暗号化のみ)</span><br><span class=\"line\">   (6) RSA (暗号化のみ)</span><br><span class=\"line\">   (7) DSA (機能をあなた自身で設定)</span><br><span class=\"line\">   (8) RSA (機能をあなた自身で設定)</span><br><span class=\"line\">  (10) ECC (署名のみ)</span><br><span class=\"line\">  (11) ECC (機能をあなた自身で設定)</span><br><span class=\"line\">  (12) ECC (暗号化のみ)</span><br><span class=\"line\">  (13) 既存の鍵</span><br><span class=\"line\">  (14) カードに存在する鍵</span><br><span class=\"line\">あなたの選択は? 4</span><br><span class=\"line\"></span><br><span class=\"line\">RSA 鍵は 1024 から 4096 ビットの長さで可能です。</span><br><span class=\"line\">鍵長は? (3072) 4096</span><br><span class=\"line\">要求された鍵長は4096ビット</span><br><span class=\"line\">鍵の有効期限を指定してください。</span><br><span class=\"line\">         0 = 鍵は無期限</span><br><span class=\"line\">      &lt;n&gt;  = 鍵は n 日間で期限切れ</span><br><span class=\"line\">      &lt;n&gt;w = 鍵は n 週間で期限切れ</span><br><span class=\"line\">      &lt;n&gt;m = 鍵は n か月間で期限切れ</span><br><span class=\"line\">      &lt;n&gt;y = 鍵は n 年間で期限切れ</span><br><span class=\"line\">鍵の有効期間は? (0)5y</span><br><span class=\"line\">鍵は金  1/30 11:25:03 2026 JSTで期限切れとなります</span><br><span class=\"line\">これで正しいですか? (y/N) y</span><br><span class=\"line\">本当に作成しますか? (y/N) y</span><br><span class=\"line\">たくさんのランダム・バイトの生成が必要です。キーボードを打つ、マウスを動か</span><br><span class=\"line\">す、ディスクにアクセスするなどの他の操作を素数生成の間に行うことで、乱数生</span><br><span class=\"line\">成器に十分なエントロピーを供給する機会を与えることができます。</span><br><span class=\"line\"></span><br><span class=\"line\">sec  rsa4096/1234567890123456</span><br><span class=\"line\">     作成: 2021-01-31  有効期限: 無期限  利用法: C</span><br><span class=\"line\">     信用: 究極        有効性: 究極</span><br><span class=\"line\">ssb  rsa4096/A234567890123456</span><br><span class=\"line\">     作成: 2021-01-31  有効期限: 2026-01-30  利用法: S</span><br><span class=\"line\">[  究極  ] (1). Your Name &lt;your@mail.com&gt;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"暗号化副鍵の作成\"><a href=\"#暗号化副鍵の作成\" class=\"headerlink\" title=\"暗号化副鍵の作成\"></a>暗号化副鍵の作成</h4><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 副鍵は期限5年、RSA4096bitで構成します</span></span><br><span class=\"line\">gpg&gt; addkey</span><br><span class=\"line\">ご希望の鍵の種類を選択してください:</span><br><span class=\"line\">   (3) DSA (署名のみ)</span><br><span class=\"line\">   (4) RSA (署名のみ)</span><br><span class=\"line\">   (5) Elgamal (暗号化のみ)</span><br><span class=\"line\">   (6) RSA (暗号化のみ)</span><br><span class=\"line\">   (7) DSA (機能をあなた自身で設定)</span><br><span class=\"line\">   (8) RSA (機能をあなた自身で設定)</span><br><span class=\"line\">  (10) ECC (署名のみ)</span><br><span class=\"line\">  (11) ECC (機能をあなた自身で設定)</span><br><span class=\"line\">  (12) ECC (暗号化のみ)</span><br><span class=\"line\">  (13) 既存の鍵</span><br><span class=\"line\">  (14) カードに存在する鍵</span><br><span class=\"line\">あなたの選択は? 6</span><br><span class=\"line\"></span><br><span class=\"line\">RSA 鍵は 1024 から 4096 ビットの長さで可能です。</span><br><span class=\"line\">鍵長は? (3072) 4096</span><br><span class=\"line\">要求された鍵長は4096ビット</span><br><span class=\"line\">鍵の有効期限を指定してください。</span><br><span class=\"line\">         0 = 鍵は無期限</span><br><span class=\"line\">      &lt;n&gt;  = 鍵は n 日間で期限切れ</span><br><span class=\"line\">      &lt;n&gt;w = 鍵は n 週間で期限切れ</span><br><span class=\"line\">      &lt;n&gt;m = 鍵は n か月間で期限切れ</span><br><span class=\"line\">      &lt;n&gt;y = 鍵は n 年間で期限切れ</span><br><span class=\"line\">鍵の有効期間は? (0)5y</span><br><span class=\"line\">鍵は金  1/30 11:25:03 2026 JSTで期限切れとなります</span><br><span class=\"line\">これで正しいですか? (y/N) y</span><br><span class=\"line\">本当に作成しますか? (y/N) y</span><br><span class=\"line\">たくさんのランダム・バイトの生成が必要です。キーボードを打つ、マウスを動か</span><br><span class=\"line\">す、ディスクにアクセスするなどの他の操作を素数生成の間に行うことで、乱数生</span><br><span class=\"line\">成器に十分なエントロピーを供給する機会を与えることができます。</span><br><span class=\"line\"></span><br><span class=\"line\">sec  rsa4096/1234567890123456</span><br><span class=\"line\">     作成: 2021-01-31  有効期限: 無期限  利用法: C</span><br><span class=\"line\">     信用: 究極        有効性: 究極</span><br><span class=\"line\">ssb  rsa4096/A234567890123456</span><br><span class=\"line\">     作成: 2021-01-31  有効期限: 2026-01-30  利用法: S</span><br><span class=\"line\">ssb  rsa4096/B234567890123456</span><br><span class=\"line\">     作成: 2021-01-31  有効期限: 2026-01-30  利用法: E</span><br><span class=\"line\">[  究極  ] (1). Your Name &lt;your@mail.com&gt;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"認証副鍵の作成\"><a href=\"#認証副鍵の作成\" class=\"headerlink\" title=\"認証副鍵の作成\"></a>認証副鍵の作成</h4><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 副鍵は期限5年、RSA4096bitで構成します</span></span><br><span class=\"line\">gpg&gt; addkey</span><br><span class=\"line\">ご希望の鍵の種類を選択してください:</span><br><span class=\"line\">   (3) DSA (署名のみ)</span><br><span class=\"line\">   (4) RSA (署名のみ)</span><br><span class=\"line\">   (5) Elgamal (暗号化のみ)</span><br><span class=\"line\">   (6) RSA (暗号化のみ)</span><br><span class=\"line\">   (7) DSA (機能をあなた自身で設定)</span><br><span class=\"line\">   (8) RSA (機能をあなた自身で設定)</span><br><span class=\"line\">  (10) ECC (署名のみ)</span><br><span class=\"line\">  (11) ECC (機能をあなた自身で設定)</span><br><span class=\"line\">  (12) ECC (暗号化のみ)</span><br><span class=\"line\">  (13) 既存の鍵</span><br><span class=\"line\">  (14) カードに存在する鍵</span><br><span class=\"line\">あなたの選択は? 8</span><br><span class=\"line\"></span><br><span class=\"line\">鍵RSAに認められた操作: Sign Encrypt Authenticate</span><br><span class=\"line\">現在の認められた操作: Sign Encrypt</span><br><span class=\"line\"></span><br><span class=\"line\">   (S) 署名機能を反転する</span><br><span class=\"line\">   (E) 暗号機能を反転する</span><br><span class=\"line\">   (A) 認証機能を反転する</span><br><span class=\"line\">   (Q) 完了</span><br><span class=\"line\"></span><br><span class=\"line\">あなたの選択は? S</span><br><span class=\"line\"></span><br><span class=\"line\">鍵RSAに認められた操作: Sign Encrypt Authenticate</span><br><span class=\"line\">現在の認められた操作: Encrypt</span><br><span class=\"line\"></span><br><span class=\"line\">   (S) 署名機能を反転する</span><br><span class=\"line\">   (E) 暗号機能を反転する</span><br><span class=\"line\">   (A) 認証機能を反転する</span><br><span class=\"line\">   (Q) 完了</span><br><span class=\"line\"></span><br><span class=\"line\">あなたの選択は? E</span><br><span class=\"line\"></span><br><span class=\"line\">鍵RSAに認められた操作: Sign Encrypt Authenticate</span><br><span class=\"line\">現在の認められた操作:</span><br><span class=\"line\"></span><br><span class=\"line\">   (S) 署名機能を反転する</span><br><span class=\"line\">   (E) 暗号機能を反転する</span><br><span class=\"line\">   (A) 認証機能を反転する</span><br><span class=\"line\">   (Q) 完了</span><br><span class=\"line\"></span><br><span class=\"line\">あなたの選択は? A</span><br><span class=\"line\"></span><br><span class=\"line\">鍵RSAに認められた操作: Sign Encrypt Authenticate</span><br><span class=\"line\">現在の認められた操作: Authenticate</span><br><span class=\"line\"></span><br><span class=\"line\">   (S) 署名機能を反転する</span><br><span class=\"line\">   (E) 暗号機能を反転する</span><br><span class=\"line\">   (A) 認証機能を反転する</span><br><span class=\"line\">   (Q) 完了</span><br><span class=\"line\"></span><br><span class=\"line\">あなたの選択は? Q</span><br><span class=\"line\">RSA 鍵は 1024 から 4096 ビットの長さで可能です。</span><br><span class=\"line\">鍵長は? (3072) 4096</span><br><span class=\"line\">要求された鍵長は4096ビット</span><br><span class=\"line\">鍵の有効期限を指定してください。</span><br><span class=\"line\">         0 = 鍵は無期限</span><br><span class=\"line\">      &lt;n&gt;  = 鍵は n 日間で期限切れ</span><br><span class=\"line\">      &lt;n&gt;w = 鍵は n 週間で期限切れ</span><br><span class=\"line\">      &lt;n&gt;m = 鍵は n か月間で期限切れ</span><br><span class=\"line\">      &lt;n&gt;y = 鍵は n 年間で期限切れ</span><br><span class=\"line\">鍵の有効期間は? (0)5y</span><br><span class=\"line\">鍵は金  1/30 11:25:03 2026 JSTで期限切れとなります</span><br><span class=\"line\">これで正しいですか? (y/N) y</span><br><span class=\"line\">本当に作成しますか? (y/N) y</span><br><span class=\"line\">たくさんのランダム・バイトの生成が必要です。キーボードを打つ、マウスを動か</span><br><span class=\"line\">す、ディスクにアクセスするなどの他の操作を素数生成の間に行うことで、乱数生</span><br><span class=\"line\">成器に十分なエントロピーを供給する機会を与えることができます。</span><br><span class=\"line\"></span><br><span class=\"line\">sec  rsa4096/1234567890123456</span><br><span class=\"line\">     作成: 2021-01-31  有効期限: 無期限  利用法: C</span><br><span class=\"line\">     信用: 究極        有効性: 究極</span><br><span class=\"line\">ssb  rsa4096/A234567890123456</span><br><span class=\"line\">     作成: 2021-01-31  有効期限: 2026-01-30  利用法: S</span><br><span class=\"line\">ssb  rsa4096/B234567890123456</span><br><span class=\"line\">     作成: 2021-01-31  有効期限: 2026-01-30  利用法: E</span><br><span class=\"line\">ssb  rsa4096/C234567890123456</span><br><span class=\"line\">     作成: 2021-01-31  有効期限: 2026-01-30  利用法: A</span><br><span class=\"line\">[  究極  ] (1). Your Name &lt;your@mail.com&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">gpg&gt; save</span><br><span class=\"line\">gpg&gt; quit</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"作成した鍵の確認\"><a href=\"#作成した鍵の確認\" class=\"headerlink\" title=\"作成した鍵の確認\"></a>作成した鍵の確認</h4><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ gpg -K</span><br><span class=\"line\">/tmp/.xxx/pubring.kbx</span><br><span class=\"line\">------------------------------</span><br><span class=\"line\">sec   rsa4096 2021-01-31 [C]</span><br><span class=\"line\">      7890123456789012345678901234567890123456</span><br><span class=\"line\">uid           [  究極  ] Your Name &lt;your@mail.com&gt;</span><br><span class=\"line\">ssb  rsa4096/A234567890123456 2021-01-31 [S] [有効期限: 2026-01-30]</span><br><span class=\"line\">ssb  rsa4096/B234567890123456 2021-01-31 [E] [有効期限: 2026-01-30]</span><br><span class=\"line\">ssb  rsa4096/C234567890123456 2021-01-31 [A] [有効期限: 2026-01-30]</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"秘密鍵のエクスポート\"><a href=\"#秘密鍵のエクスポート\" class=\"headerlink\" title=\"秘密鍵のエクスポート\"></a>秘密鍵のエクスポート</h4><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#バックアップ用途に秘密鍵をエクスポートします</span></span><br><span class=\"line\">$ gpg --armor --export-secret-keys <span class=\"variable\">$KEYID</span> &gt; <span class=\"variable\">$GNUPGHOME</span>/mastersub.key</span><br><span class=\"line\">$ gpg --armor --export-secret-subkeys <span class=\"variable\">$KEYID</span> &gt; <span class=\"variable\">$GNUPGHOME</span>/sub.key</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"失効証明書の作成\"><a href=\"#失効証明書の作成\" class=\"headerlink\" title=\"失効証明書の作成\"></a>失効証明書の作成</h4><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ gpg --output <span class=\"variable\">$GNUPGHOME</span>/revoke.asc --gen-revoke <span class=\"variable\">$KEYID</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"USBメディアを挿入し、-GNUHOMEフォルダをバックアップ\"><a href=\"#USBメディアを挿入し、-GNUHOMEフォルダをバックアップ\" class=\"headerlink\" title=\"USBメディアを挿入し、$GNUHOMEフォルダをバックアップ\"></a>USBメディアを挿入し、$GNUHOMEフォルダをバックアップ</h4><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ご自身の環境に応じてUSBへのパスは変更してください。Finderでコピーしても構いません</span></span><br><span class=\"line\">$ sudo <span class=\"built_in\">cp</span> -avi <span class=\"variable\">$GNUPGHOME</span> /volumes/your USB path/</span><br></pre></td></tr></table></figure>\n\n<p>USBはアンマウントします（しばらく使わないので保存）</p>\n<h4 id=\"公開鍵をホームディクレトリのpublic-key-pgpとしてエクスポート\"><a href=\"#公開鍵をホームディクレトリのpublic-key-pgpとしてエクスポート\" class=\"headerlink\" title=\"公開鍵をホームディクレトリのpublic_key.pgpとしてエクスポート\"></a>公開鍵をホームディクレトリのpublic_key.pgpとしてエクスポート</h4><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ gpg --armor --output ~/public_key.pgp --<span class=\"built_in\">export</span> <span class=\"variable\">$KEYID</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"YubiKeyの確認\"><a href=\"#YubiKeyの確認\" class=\"headerlink\" title=\"YubiKeyの確認\"></a>YubiKeyの確認</h4><p>YubiKeyを接続します。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ gpg --card-edit</span><br><span class=\"line\"></span><br><span class=\"line\">Reader ...........: Yubico YubiKey OTP FIDO CCID</span><br><span class=\"line\">Application ID ...: 12345678901234567890123456789012</span><br><span class=\"line\">Application <span class=\"built_in\">type</span> .: OpenPGP</span><br><span class=\"line\">Version ..........: 3.4</span><br><span class=\"line\">Manufacturer .....: Yubico</span><br><span class=\"line\">Serial number ....: 12345678</span><br><span class=\"line\">Name of cardholder: [未設定]</span><br><span class=\"line\">Language prefs ...: [未設定]</span><br><span class=\"line\">Salutation .......:</span><br><span class=\"line\">URL of public key : [未設定]</span><br><span class=\"line\">Login data .......: [未設定]</span><br><span class=\"line\">Signature PIN ....: 強制なし</span><br><span class=\"line\">Key attributes ...: rsa4096 rsa4096 rsa4096</span><br><span class=\"line\">Max. PIN lengths .: 127 127 127</span><br><span class=\"line\">PIN retry counter : 3 0 3</span><br><span class=\"line\">Signature counter : 0</span><br><span class=\"line\">KDF setting ......: off</span><br><span class=\"line\">Signature key ....: [未設定]</span><br><span class=\"line\">Encryption key....: [未設定]</span><br><span class=\"line\">Authentication key: [未設定]</span><br><span class=\"line\">General key info..: [未設定]</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"PINの変更\"><a href=\"#PINの変更\" class=\"headerlink\" title=\"PINの変更\"></a>PINの変更</h4><p>これは、前回の記事「<a href=\"/new-technology/2021/02/06/yubikey_ssh_github/\" title=\"YubiKeyとSSHとGitHub\">YubiKeyとSSHとGitHub</a>」のYubiKey ManagerでみたPIVのPIN、PUKとは異なります。YubikeyはGPG向けに別のPIN（デフォルト123456）、AdminPIN（デフォルト12345678）があるので、紛失時のためにも設定変更される事をお勧めします。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">gpg/card&gt; admin</span><br><span class=\"line\">管理者コマンドが許可されています</span><br><span class=\"line\"></span><br><span class=\"line\">gpg/card&gt; passwd</span><br><span class=\"line\">gpg: OpenPGPカードno. 12345678901234567890123456789012を検出</span><br><span class=\"line\"></span><br><span class=\"line\">1 - change PIN</span><br><span class=\"line\">2 - unblock PIN</span><br><span class=\"line\">3 - change Admin PIN</span><br><span class=\"line\">4 - <span class=\"built_in\">set</span> the Reset Code</span><br><span class=\"line\">Q - quit</span><br><span class=\"line\"></span><br><span class=\"line\">あなたの選択は? 1</span><br><span class=\"line\"></span><br><span class=\"line\">1 - change PIN</span><br><span class=\"line\">2 - unblock PIN</span><br><span class=\"line\">3 - change Admin PIN</span><br><span class=\"line\">4 - <span class=\"built_in\">set</span> the Reset Code</span><br><span class=\"line\">Q - quit</span><br><span class=\"line\"></span><br><span class=\"line\">あなたの選択は? 3</span><br><span class=\"line\"></span><br><span class=\"line\">1 - change PIN</span><br><span class=\"line\">2 - unblock PIN</span><br><span class=\"line\">3 - change Admin PIN</span><br><span class=\"line\">4 - <span class=\"built_in\">set</span> the Reset Code</span><br><span class=\"line\">Q - quit</span><br><span class=\"line\"></span><br><span class=\"line\">あなたの選択は? Q</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"3つの副鍵をYubiKeyに転送\"><a href=\"#3つの副鍵をYubiKeyに転送\" class=\"headerlink\" title=\"3つの副鍵をYubiKeyに転送\"></a>3つの副鍵をYubiKeyに転送</h4><p>YubiKeyに転送された秘密鍵は端末からは全て中身が抹消され、YubiKeyに情報がある事を示すポインタにしかなりません。もし、やりなおしが必要になった場合は、秘密鍵をバックアップから復活させてから行う必要があります。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ gpg --edit-key <span class=\"variable\">$KEYID</span></span><br><span class=\"line\"></span><br><span class=\"line\">秘密鍵が利用できます。</span><br><span class=\"line\"></span><br><span class=\"line\">sec  rsa4096/1234567890123456</span><br><span class=\"line\">     作成: 2021-01-31  有効期限: 無期限  利用法: C</span><br><span class=\"line\">     カード番号: 0006 12345678</span><br><span class=\"line\">     信用: 究極        有効性: 究極</span><br><span class=\"line\">ssb  rsa4096/A234567890123456 2021-01-31 [S] [有効期限: 2026-01-30]</span><br><span class=\"line\">ssb  rsa4096/B234567890123456 2021-01-31 [E] [有効期限: 2026-01-30]</span><br><span class=\"line\">ssb  rsa4096/C234567890123456 2021-01-31 [A] [有効期限: 2026-01-30]</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"署名鍵の転送\"><a href=\"#署名鍵の転送\" class=\"headerlink\" title=\"署名鍵の転送\"></a>署名鍵の転送</h4><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 3つのキー毎にYubikeyに転送します。</span></span><br><span class=\"line\"><span class=\"comment\"># key 1 と入力する事で最初の副鍵が選択され、＊マークが付きます</span></span><br><span class=\"line\">gpg&gt; key 1</span><br><span class=\"line\"></span><br><span class=\"line\">sec  rsa4096/1234567890123456</span><br><span class=\"line\">     作成: 2021-01-31  有効期限: 無期限  利用法: C</span><br><span class=\"line\">     カード番号: 0006 12345678</span><br><span class=\"line\">     信用: 究極        有効性: 究極</span><br><span class=\"line\">ssb*  rsa4096/A234567890123456 2021-01-31 [S] [有効期限: 2026-01-30]</span><br><span class=\"line\">ssb  rsa4096/B234567890123456 2021-01-31 [E] [有効期限: 2026-01-30]</span><br><span class=\"line\">ssb  rsa4096/C234567890123456 2021-01-31 [A] [有効期限: 2026-01-30]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ssb＊の&quot;＊&quot;マークは選択されている事を示します</span></span><br><span class=\"line\"></span><br><span class=\"line\">gpg&gt; keytocard</span><br><span class=\"line\">鍵を保管する場所を選択してください:</span><br><span class=\"line\">   (1) 署名鍵</span><br><span class=\"line\">   (3) 認証鍵</span><br><span class=\"line\">あなたの選択は? 1</span><br><span class=\"line\"><span class=\"comment\"># PinEntryにYubiKeyのAdminPINを入力し移動を完了させます</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"暗号化鍵の転送\"><a href=\"#暗号化鍵の転送\" class=\"headerlink\" title=\"暗号化鍵の転送\"></a>暗号化鍵の転送</h4><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 署名の選択を&quot;key 1&quot;を入力して外し、&quot;key 2&quot;を入力して暗号化を選択します</span></span><br><span class=\"line\">gpg&gt; key 1</span><br><span class=\"line\">gpg&gt; key 2</span><br><span class=\"line\"></span><br><span class=\"line\">sec  rsa4096/1234567890123456</span><br><span class=\"line\">     作成: 2021-01-31  有効期限: 無期限  利用法: C</span><br><span class=\"line\">     カード番号: 0006 12345678</span><br><span class=\"line\">     信用: 究極        有効性: 究極</span><br><span class=\"line\">ssb  rsa4096/A234567890123456 2021-01-31 [S] [有効期限: 2026-01-30]</span><br><span class=\"line\">ssb*  rsa4096/B234567890123456 2021-01-31 [E] [有効期限: 2026-01-30]</span><br><span class=\"line\">ssb  rsa4096/C234567890123456 2021-01-31 [A] [有効期限: 2026-01-30]</span><br><span class=\"line\"></span><br><span class=\"line\">gpg&gt; keytocard</span><br><span class=\"line\">鍵を保管する場所を選択してください:</span><br><span class=\"line\">   (2) 暗号鍵</span><br><span class=\"line\">あなたの選択は? 2</span><br><span class=\"line\"><span class=\"comment\"># PinEntryにYubiKeyのAdminPINを入力し移動を完了させます</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"認証鍵の転送\"><a href=\"#認証鍵の転送\" class=\"headerlink\" title=\"認証鍵の転送\"></a>認証鍵の転送</h4><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 暗号化の選択を&quot;key 2&quot;を入力して外し、&quot;key 3&quot;を入力して認証を選択します</span></span><br><span class=\"line\">gpg&gt; key 2</span><br><span class=\"line\">gpg&gt; key 3</span><br><span class=\"line\"></span><br><span class=\"line\">sec  rsa4096/1234567890123456</span><br><span class=\"line\">     作成: 2021-01-31  有効期限: 無期限  利用法: C</span><br><span class=\"line\">     カード番号: 0006 12345678</span><br><span class=\"line\">     信用: 究極        有効性: 究極</span><br><span class=\"line\">ssb  rsa4096/A234567890123456 2021-01-31 [S] [有効期限: 2026-01-30]</span><br><span class=\"line\">ssb  rsa4096/B234567890123456 2021-01-31 [E] [有効期限: 2026-01-30]</span><br><span class=\"line\">ssb*  rsa4096/C234567890123456 2021-01-31 [A] [有効期限: 2026-01-30]</span><br><span class=\"line\"></span><br><span class=\"line\">gpg&gt; keytocard</span><br><span class=\"line\">鍵を保管する場所を選択してください:</span><br><span class=\"line\">   (3) 認証鍵</span><br><span class=\"line\">あなたの選択は? 3</span><br><span class=\"line\"><span class=\"comment\"># PinEntryにYubiKeyのAdminPINを入力し移動を完了させます</span></span><br><span class=\"line\">gpg&gt; save</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"YubiKeyへの移動を確認\"><a href=\"#YubiKeyへの移動を確認\" class=\"headerlink\" title=\"YubiKeyへの移動を確認\"></a>YubiKeyへの移動を確認</h4><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ gpg -K</span><br><span class=\"line\">/tmp/.xxx/pubring.kbx</span><br><span class=\"line\">------------------------------</span><br><span class=\"line\">sec   rsa4096 2021-01-31 [C]</span><br><span class=\"line\">      7890123456789012345678901234567890123456</span><br><span class=\"line\">uid           [  究極  ] Your Name &lt;your@mail.com&gt;</span><br><span class=\"line\">ssb&gt;  rsa4096/A234567890123456 2021-01-31 [S] [有効期限: 2026-01-30]</span><br><span class=\"line\">ssb&gt;  rsa4096/B234567890123456 2021-01-31 [E] [有効期限: 2026-01-30]</span><br><span class=\"line\">ssb&gt;  rsa4096/C234567890123456 2021-01-31 [A] [有効期限: 2026-01-30]</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"最終確認のチェックリスト\"><a href=\"#最終確認のチェックリスト\" class=\"headerlink\" title=\"最終確認のチェックリスト\"></a>最終確認のチェックリスト</h4><ul>\n<li>デフォルトから変更したYubiKeyのPINおよび管理PINを記録しました</li>\n<li>GPGの主鍵のパスワードを記録しました</li>\n<li>USBに主鍵、副鍵、および失効証明書のコピーを保管し、オフラインで保管する準備をしました</li>\n<li>ホームディレクトリに公開鍵のコピーを保存しました</li>\n</ul>\n<h4 id=\"クリーンアップ\"><a href=\"#クリーンアップ\" class=\"headerlink\" title=\"クリーンアップ\"></a>クリーンアップ</h4><p>上記のバックアップが確保されている事を前提に、作業してきた一時フォルダを削除します。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ sudo <span class=\"built_in\">rm</span> -rf <span class=\"variable\">$GNUPGHOME</span></span><br><span class=\"line\">$ gpg --delete-secret-key <span class=\"variable\">$KEYID</span></span><br><span class=\"line\">$ <span class=\"built_in\">unset</span> GNUPGHOME</span><br></pre></td></tr></table></figure>\n\n<p>クリーンアップが終了したらネットワークに接続できます。秘密鍵はもうmacOSの中に残っていません。秘密鍵は取り外したUSBと接続されているYubiKeyの中にあります。</p>\n<h4 id=\"公開鍵のインポートと信頼\"><a href=\"#公開鍵のインポートと信頼\" class=\"headerlink\" title=\"公開鍵のインポートと信頼\"></a>公開鍵のインポートと信頼</h4><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ gpg --import ~/public_key.pgp</span><br><span class=\"line\">$ gpg --edit-key <span class=\"variable\">$KEYID</span></span><br><span class=\"line\"></span><br><span class=\"line\">gpg&gt; trust</span><br><span class=\"line\">pub  rsa4096/1234567890123456</span><br><span class=\"line\">     作成: 2021-01-31  有効期限: 無期限      利用法: C</span><br><span class=\"line\">     信用: 不明        有効性: 不明</span><br><span class=\"line\">ssb  rsa4096/A234567890123456</span><br><span class=\"line\">     作成: 2021-01-31  有効期限: 2026-01-30  利用法: S</span><br><span class=\"line\">     カード番号: 0006 12345678</span><br><span class=\"line\">ssb  rsa4096/B234567890123456</span><br><span class=\"line\">     作成: 2021-01-31  有効期限: 2026-01-30  利用法: E</span><br><span class=\"line\">     カード番号: 0006 12345678</span><br><span class=\"line\">ssb  rsa4096/C234567890123456</span><br><span class=\"line\">     作成: 2021-01-31  有効期限: 2026-01-30  利用法: A</span><br><span class=\"line\">     カード番号: 0006 12345678</span><br><span class=\"line\">[  究極  ] (1). Your Name &lt;your@mail.com&gt;</span><br><span class=\"line\">他のユーザの鍵を正しく検証するために、このユーザの信用度を決めてください</span><br><span class=\"line\">(パスポートを見せてもらったり、他から得たフィンガープリントを検査したり、などなど)</span><br><span class=\"line\"></span><br><span class=\"line\">  1 = 知らない、または何とも言えない</span><br><span class=\"line\">  2 = 信用しない</span><br><span class=\"line\">  3 = まぁまぁ信用する</span><br><span class=\"line\">  4 = 充分に信用する</span><br><span class=\"line\">  5 = 究極的に信用する</span><br><span class=\"line\">  m = メーン・メニューに戻る</span><br><span class=\"line\"></span><br><span class=\"line\">あなたの決定は? 5</span><br><span class=\"line\">本当にこの鍵を究極的に信用しますか? (y/N)</span><br><span class=\"line\"></span><br><span class=\"line\">pub  rsa4096/1234567890123456</span><br><span class=\"line\">     作成: 2021-01-31  有効期限: 無期限      利用法: C</span><br><span class=\"line\">     信用: 究極        有効性: 不明</span><br><span class=\"line\">ssb  rsa4096/A234567890123456</span><br><span class=\"line\">     作成: 2021-01-31  有効期限: 2026-01-30  利用法: S</span><br><span class=\"line\">     カード番号: 0006 12345678</span><br><span class=\"line\">ssb  rsa4096/B234567890123456</span><br><span class=\"line\">     作成: 2021-01-31  有効期限: 2026-01-30  利用法: E</span><br><span class=\"line\">     カード番号: 0006 12345678</span><br><span class=\"line\">ssb  rsa4096/C234567890123456</span><br><span class=\"line\">     作成: 2021-01-31  有効期限: 2026-01-30  利用法: A</span><br><span class=\"line\">     カード番号: 0006 12345678</span><br><span class=\"line\">[  究極  ] (1). Your Name &lt;your@mail.com&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">gpg&gt; quit</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"GPG環境の設定\"><a href=\"#GPG環境の設定\" class=\"headerlink\" title=\"GPG環境の設定\"></a>GPG環境の設定</h3><h4 id=\"gpg-agent-confの設定\"><a href=\"#gpg-agent-confの設定\" class=\"headerlink\" title=\"gpg-agent.confの設定\"></a>gpg-agent.confの設定</h4><p><code>gpg-agent.conf</code>に以下の内容から不足があれば追加します。3-4行目のキャッシュ時間は環境に応じて自由に変更してください。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ vi ~/.gnupg/gpg-agent.conf</span><br><span class=\"line\">enable-ssh-support</span><br><span class=\"line\">default-cache-ttl 600</span><br><span class=\"line\">max-cache-ttl 7200</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"GPG-Agentの自動起動について\"><a href=\"#GPG-Agentの自動起動について\" class=\"headerlink\" title=\"GPG Agentの自動起動について\"></a>GPG Agentの自動起動について</h4><p>GPGをインストールすると、OS起動時に起動するアプリケーションがLaunchAgentに登録されます。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ <span class=\"built_in\">ls</span> /Library/LaunchAgents | grep gpg</span><br><span class=\"line\">org.gpgtools.Libmacgpg.xpc.plist</span><br><span class=\"line\">org.gpgtools.macgpg2.fix.plist</span><br><span class=\"line\">org.gpgtools.macgpg2.shutdown-gpg-agent.plist</span><br><span class=\"line\">org.gpgtools.updater.plist</span><br></pre></td></tr></table></figure>\n\n<p>これらに加え、ユーザー毎のログイン時のスタートアップにGPG Agentの起動を登録します。<strong>ユーザーの</strong>LaunchAgentsに<strong>2つのファイル</strong>を作成します。作成先は<code>/Librarly</code>ではなく、<code>＄HOME/Library</code>です。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ vi ~/Library/LaunchAgents/gnupg.gpg-agent.plist</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"> <span class=\"meta\">&lt;?xml version=<span class=\"string\">&quot;1.0&quot;</span> encoding=<span class=\"string\">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE <span class=\"keyword\">plist</span> <span class=\"keyword\">PUBLIC</span> <span class=\"string\">&quot;-//Apple//DTD PLIST 1.0//EN&quot;</span> <span class=\"string\">&quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">plist</span> <span class=\"attr\">version</span>=<span class=\"string\">&quot;1.0&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">dict</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">key</span>&gt;</span>Label<span class=\"tag\">&lt;/<span class=\"name\">key</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">string</span>&gt;</span>gnupg.gpg-agent<span class=\"tag\">&lt;/<span class=\"name\">string</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">key</span>&gt;</span>RunAtLoad<span class=\"tag\">&lt;/<span class=\"name\">key</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">true</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">key</span>&gt;</span>KeepAlive<span class=\"tag\">&lt;/<span class=\"name\">key</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">false</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">key</span>&gt;</span>ProgramArguments<span class=\"tag\">&lt;/<span class=\"name\">key</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">array</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">string</span>&gt;</span>/usr/local/MacGPG2/bin/gpg-connect-agent<span class=\"tag\">&lt;/<span class=\"name\">string</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">string</span>&gt;</span>/bye<span class=\"tag\">&lt;/<span class=\"name\">string</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">array</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">dict</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">plist</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ vi ~/Library/LaunchAgents/gnupg.gpg-agent-symlink.plist</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight xml\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=<span class=\"string\">&quot;1.0&quot;</span> encoding=<span class=\"string\">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE <span class=\"keyword\">plist</span> <span class=\"keyword\">PUBLIC</span> <span class=\"string\">&quot;-//Apple//DTD PLIST 1.0//EN&quot;</span> <span class=\"string\">&quot;http://www.apple.com/DTDs/ProperyList-1.0/dtd&quot;</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">plist</span> <span class=\"attr\">version</span>=<span class=\"string\">&quot;1.0&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">dict</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">key</span>&gt;</span>Label<span class=\"tag\">&lt;/<span class=\"name\">key</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">string</span>&gt;</span>gnupg.gpg-agent-symlink<span class=\"tag\">&lt;/<span class=\"name\">string</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">key</span>&gt;</span>ProgramArguments<span class=\"tag\">&lt;/<span class=\"name\">key</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">array</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">string</span>&gt;</span>/bin/sh<span class=\"tag\">&lt;/<span class=\"name\">string</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">string</span>&gt;</span>-c<span class=\"tag\">&lt;/<span class=\"name\">string</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">string</span>&gt;</span>/bin/ln -sf $HOME/.gnupg/S.gpg-agent.ssh $SSH_AUTH_SOCK<span class=\"tag\">&lt;/<span class=\"name\">string</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">array</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">key</span>&gt;</span>RunAtLoad<span class=\"tag\">&lt;/<span class=\"name\">key</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">true</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">dict</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">plist</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>ここまで作成したら一度macOSをログアウト、ログインします。ターミナルから以下のコマンドでGPG Agentを含めて6つのプロセスが起動している事を確認します。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ launchctl list | grep gpg</span><br><span class=\"line\">646\t0\torg.gpgtools.macgpg2.shutdown-gpg-agent</span><br><span class=\"line\">-\t0\tgnupg.gpg-agent</span><br><span class=\"line\">-\t0\tgnupg.gpg-agent-symlink</span><br><span class=\"line\">-\t0\torg.gpgtools.updater</span><br><span class=\"line\">-\t0\torg.gpgtools.macgpg2.fix</span><br><span class=\"line\">511\t0\torg.gpgtools.Libmacgpg.xpc</span><br></pre></td></tr></table></figure>\n\n<p>ここまでの作業で一旦はGPGの基本機能が使える状態になりました。文字列を選択してファイルの右クリックメニューから暗号化したりメモの文字列を署名、暗号、復号機能を確認します。</p>\n<h3 id=\"SSH公開鍵のエクスポート\"><a href=\"#SSH公開鍵のエクスポート\" class=\"headerlink\" title=\"SSH公開鍵のエクスポート\"></a>SSH公開鍵のエクスポート</h3><p>ここからはYubikey+GPGのSSH接続設定です。</p>\n<p><code>ssh-add -L</code> で公開鍵を取得します。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ ssh-add -L</span><br><span class=\"line\">ssh-rsa AAAAB4NzaC1yc2EAAAADAQABAAACAz[...]zreOKM+HwpkHzcy9DQcVG2Nw== cardno:000612345678</span><br></pre></td></tr></table></figure>\n\n<p>Yubikeyの公開鍵の末尾にはカード番号の記載があります。SSH公開鍵を接続先のサーバーのauthorized_keysに登録します。また、macOS側の<code>~/.ssh/config</code>は設定不要です。</p>\n<p>ターミナルから接続テストしてみましょう。PinEntryダイアログが表示され、PIN入力後、公開鍵認証で接続されます。</p>\n<h3 id=\"GPGの公開鍵とSSH公開鍵とをGitHubに登録\"><a href=\"#GPGの公開鍵とSSH公開鍵とをGitHubに登録\" class=\"headerlink\" title=\"GPGの公開鍵とSSH公開鍵とをGitHubに登録\"></a>GPGの公開鍵とSSH公開鍵とをGitHubに登録</h3><p>ホームディレクトリに作成した<strong>PGP公開鍵</strong>と<strong>SSH公開鍵</strong>との2つをGitHubに登録します。<br>GitHubサイトにログイン後、<mark class=\"label primary\">Account</mark>の”Settings”を選び、左メニューの<mark class=\"label primary\">SSH and GPG keys</mark>をクリックします。<mark class=\"label primary\">New SSH key</mark>と<mark class=\"label primary\">New GPG key</mark>というボタンをクリックしそれぞれを登録します。</p>\n<p>まずは、SSHが行える事を確認しましょう。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ ssh -T git@github.com</span><br><span class=\"line\">Hi yoshi0808! You<span class=\"string\">&#x27;ve successfully authenticated, but GitHub does not provide shell access.</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"GitHubへの接続、署名のためのgitの設定\"><a href=\"#GitHubへの接続、署名のためのgitの設定\" class=\"headerlink\" title=\"GitHubへの接続、署名のためのgitの設定\"></a>GitHubへの接続、署名のためのgitの設定</h3><h4 id=\"gitのSSH接続設定\"><a href=\"#gitのSSH接続設定\" class=\"headerlink\" title=\"gitのSSH接続設定\"></a>gitのSSH接続設定</h4><p>gitコマンドでSSH接続を有効にするには以下を実行します<br><code>$ git remote set-url origin git@github.com:[ユーザID]/[リポジトリ].git</code></p>\n<p>設定確認は以下の通りです<br><code>$ git remote -v</code></p>\n<p>HTTPS接続に戻す場合は、<strong>リモートの URL の変更</strong>を参照してください。</p>\n<blockquote>\n<p>GitHub -リモートの URL の変更-<br> <a href=\"https://docs.github.com/ja/github/using-git/changing-a-remotes-url\">https://docs.github.com/ja/github/using-git/changing-a-remotes-url</a></p>\n</blockquote>\n<h4 id=\"git署名の設定\"><a href=\"#git署名の設定\" class=\"headerlink\" title=\"git署名の設定\"></a>git署名の設定</h4><figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ここでは主鍵を指定します</span></span><br><span class=\"line\">$ git config --global user.signingkey 1234567890123456</span><br></pre></td></tr></table></figure>\n\n<p>デフォルトですべてのコミットに署名するには、以下を実行します。</p>\n<p><code>$ git config --global commit.gpgsign true</code></p>\n<p>Visual Studio Codeをお使いの方であれば、<code>&quot;git.enableCommitSigning&quot;: true</code>を確認します。</p>\n<p>これまでの設定でGPG Toolsを使ったSSH接続と署名の対応は完了です<span class=\"github-emoji\" alias=\"thumbsup\" style=\"\" fallback-src=\"https://github.githubassets.com/images/icons/emoji/unicode/1f44d.png?v8\">&#x1f44d;</span>。<br>PIV方式とは異なりGUI方式によりPINの入力も行える事、また一定時間PINはキャッシュしますので、セキュアである事と利便性を両立させています。</p>\n<h2 id=\"（任意）YubiKeyタッチ認証\"><a href=\"#（任意）YubiKeyタッチ認証\" class=\"headerlink\" title=\"（任意）YubiKeyタッチ認証\"></a>（任意）YubiKeyタッチ認証</h2><p>GPGで認証、署名、暗号化を行おうとしている時に、YubiKeyへのタッチを必要とさせる設定ができます。GPGのPIN入力はキャッシュしている時間がありますが、これを設定すると、GPGのアクションの前には必ずYubiKeyにタッチする必要があります。より慎重さを求める方に向いています。デフォルトではOffになっていますが、これをOnにする場合は以下のコマンドを投入します。YubiKeyがタッチを待っている間はランプが点滅します（12秒程度応答しないとギブアップします）。これはNeoなどYubiKeyの種類によっては設定できません。<br>認証　<code>$ ykman openpgp set-touch aut on</code><br>署名　<code>$ ykman openpgp set-touch sig on</code><br>暗号化　<code>$ ykman openpgp set-touch enc on</code><br>Offにする場合は以下のコマンドになります。<br>認証　<code>$ ykman openpgp set-touch aut off</code><br>署名　<code>$ ykman openpgp set-touch sig off</code><br>暗号化　<code>$ ykman openpgp set-touch enc off</code></p>\n<p>Onの代わりに15秒キャッシュする”CACHED”という項目も設定できます。詳しくは<code>ykman openpgp set-touch -h</code>を参照します。</p>\n<div class=\"note info\"><p>継続的インテグレーション（CI)など、署名、デプロイと連続動作させる時にこのCACHED設定は便利です。</p>\n</div>\n\n<h2 id=\"GPGとPIVとの切り替え\"><a href=\"#GPGとPIVとの切り替え\" class=\"headerlink\" title=\"GPGとPIVとの切り替え\"></a>GPGとPIVとの切り替え</h2><p>前回の記事「<a href=\"/new-technology/2021/02/06/yubikey_ssh_github/\" title=\"YubiKeyとSSHとGitHub\">YubiKeyとSSHとGitHub</a>」ではPIVカードとしての扱いについて説明しました。GPGは排他でカードを占有してしまう仕様のため、GPGを使っている時はPIVを使うYubico-Authenticatorは動きません。コマンド<code>$ ykaman piv info</code>を実行する事でGPGから切り離されPIVのインタフェースが使えるようになります。<strong>GPG Toolsサポートでの議論</strong>もありましたが、明確な解決が難しいまま今に至っています。実運用としては、macOS純正アプリのAutomatorを使ってPIVに切り替えてからYubico Authenticatorを起動する方法が簡単でしょうか。以下に画面キャプチャを記載しておきます。</p>\n<img src=\"/new-technology/2021/02/13/yubikey_gpg/automator1.png\" class=\"\" width=\"800\" title=\"alt\">\n\n<blockquote>\n<p>[GPG Tools -GPGMail: Fails to sign after switch from S&#x2F;MIME-<br> <a href=\"https://gpgtools.tenderapp.com/discussions/nightly/110-gpgmail-fails-to-sign-after-switch-from-smime\">https://gpgtools.tenderapp.com/discussions/nightly/110-gpgmail-fails-to-sign-after-switch-from-smime</a></p>\n</blockquote>\n<h2 id=\"（補足）libgcryptの脆弱性\"><a href=\"#（補足）libgcryptの脆弱性\" class=\"headerlink\" title=\"（補足）libgcryptの脆弱性\"></a>（補足）libgcryptの脆弱性</h2><p>（2021-05-23　追記）<br>本件は、2021-5-21発表のGPG Suite 2021.1において、下記の脆弱性については影響ありません。</p>\n<p>先日（1月末）に、gpgのライブラリであるlibgcryptに脆弱性があるとの速報<strong>CVE-2021-3345</strong>が流れました。対象バージョンは1.9.0ですが、今回GPG Toolsから導入しているlibgcryptのバージョンは1.8.7となっており、この脆弱性の影響は受けません。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"code\"><pre><span class=\"line\">$ gpg --version</span><br><span class=\"line\">gpg (GnuPG/MacGPG2) 2.2.27</span><br><span class=\"line\">libgcrypt 1.8.7</span><br></pre></td></tr></table></figure>\n\n<p>長年gpgを開発されているヴェルナー・コッホさんからの不具合に関する説明は以下の通りです。内容を一部抜粋すると、”1.8LTSブランチを使用している場合は影響を受けません。1.8.5以上であることを確認してください。”との事です。</p>\n<blockquote>\n<p>CVE-2021-3345<br> <a href=\"https://nvd.nist.gov/vuln/detail/CVE-2021-3345\">https://nvd.nist.gov/vuln/detail/CVE-2021-3345</a><br> [Security fix] Libgcrypt 1.9.1 relased<br> <a href=\"https://lists.gnupg.org/pipermail/gnupg-announce/2021q1/000456.html\">https://lists.gnupg.org/pipermail/gnupg-announce/2021q1/000456.html</a></p>\n</blockquote>\n<p><small id=\"note1\"><strong>[1]</strong><br>もし暗号化USBを導入するのであれば、Finderで暗号化する方法、VeraCryptを使う方法があります<br></small></p>\n","categories":["Security"],"tags":["yubikey"]},{"title":"はじめに","url":"/new-technology/2020/02/22/%E3%81%AF%E3%81%97%E3%82%99%E3%82%81%E3%81%AB/","content":"<p>ホームユーザーのITを中心にポストしていきたいと考えてます。これまでの自身の仕事はプログラミング・ネットワーク・サーバ構築・セキュリティと、広く浅くITに関わってきました。ITの実務は最近遠ざかってますが、自分なりに新しい技術の習得も兼ねて、ブログ形式で掲載していきます。</p>\n<span id=\"more\"></span>\n\n<p>単純にインストールして「できました」ではなく、導入目的を考え、導入後のITの使い方こそが重要です。最近は個人利用に限り利用無償のソフトウェアが増えてきました。また、商用利用であっても無償となるオープンソースソフトウェアの活用も見逃せません。これは大変ありがたい話で、座学ではなかなか理解が進まない固有技術であっても、こういった無料のプロダクトを通じて知見を高める事が可能となっています。もちろん有償の価値あるソフトウェアについても、自己啓発と家庭向けのIT活用として紹介していきたいと考えてます。</p>\n"}]